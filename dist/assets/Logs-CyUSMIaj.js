import{_ as b,m as L,a as C,u as A,aH as I,I as x,aG as S,al as V,B as P,an as F,aC as E,bD as D,r as p,c as r,o as i,e as s,d as u,f as m,t as o,F as g,g as T,aj as M,k as y,a8 as j,q as z,T as G,v as N,z as q,bE as Z,n as B}from"./index-CcoI2avG.js";const K={name:"events",mixins:[F],components:{ButtonSimple:P,DateField:V,PeopleAvatar:S,PeopleField:x,PeopleName:I,Spinner:A},data(){return{PAGE_SIZE:1e3,currentDate:new Date,events:[],isLoading:!0,selectedEvents:{},selectedPerson:null,displayLimit:1e3}},mounted(){this.loadDayEvents()},computed:{...C(["people","personMap","user"]),today(){return E().toDate()},filteredEvents(){let e=this.events;return this.selectedPerson&&(e=e.filter(t=>t.user_id===this.selectedPerson.id)),e},displayedEvents(){return this.filteredEvents.slice(0,this.displayLimit)},hasMoreEvents(){return this.filteredEvents.length>this.displayLimit}},methods:{...L(["loadEvents"]),loadDayEvents(){const e=E(this.currentDate).add(1,"days"),t=E(this.currentDate);this.selectedEvents={},this.displayLimit=this.PAGE_SIZE,this.isLoading=!0,this.loadEvents({after:D(t,this.timezone),before:D(e,this.timezone)}).then(d=>{this.events=d.map(_=>{const[n,a]=_.name.split(":");return{id:_.id,date:this.formatDate(_.created_at),data:_.data,name:n,shortType:a.substring(0,3),type:a,user_id:_.user_id}})}).catch(d=>{console.error(d)}).finally(()=>{this.isLoading=!1})},selectLine(e){this.selectedEvents[e.id]=!this.selectedEvents[e.id]},isLink(e){return["project_id","task_id"].includes(e)},getLink(e,t){const d=e.data.project_id,_=t.substring(0,t.length-3);if(_==="project")return`/productions/${d}/news-feed`;{const n=e.data[t];return`/productions/${d}/${_}s/${n}`}}},watch:{currentDate(){this.loadDayEvents()}},head(){return{title:`${this.$t("logs.title")} - Kitsu`}}},R={class:"mt1"},W={class:"flexrow"},U={class:"flexrow-item nb-events"},H={key:0,class:"mt2 empty"},O={key:1,class:"has-text-centered"},J={key:2,class:"log-list"},Q=["onClick"],X={class:"date tag mr1"},Y=["title","data-status"],ee={class:"name tag mr1"},te={class:"flexrow"},se={class:"key"},ie=["href"],ae={key:0,class:"has-text-centered mt1"};function oe(e,t,d,_,n,a){const h=p("date-field"),f=p("people-field"),k=p("button-simple"),w=p("spinner"),c=p("people-avatar"),$=p("people-name");return i(),r("div",R,[s("div",W,[m(h,{class:"flexrow-item","can-delete":!1,"max-date":a.today,label:e.$t("logs.current_date_label"),modelValue:n.currentDate,"onUpdate:modelValue":t[0]||(t[0]=l=>n.currentDate=l)},null,8,["max-date","label","modelValue"]),m(f,{class:"flexrow-item field",label:e.$t("main.user"),people:e.people,modelValue:n.selectedPerson,"onUpdate:modelValue":t[1]||(t[1]=l=>n.selectedPerson=l)},null,8,["label","people","modelValue"]),m(k,{class:"flexrow-item small",icon:"refresh",onClick:a.loadDayEvents},null,8,["onClick"]),s("span",U,o(a.filteredEvents.length)+" "+o(e.$t("logs.events")),1)]),!n.isLoading&&!a.filteredEvents.length?(i(),r("div",H,o(e.$t("logs.empty_list")),1)):u("",!0),n.isLoading?(i(),r("div",O,[m(w)])):(i(),r("div",J,[(i(!0),r(g,null,T(a.displayedEvents,l=>(i(),r("div",{class:"event-line",key:l.id,onClick:v=>a.selectLine(l)},[s("span",X,o(l.date),1),s("span",{class:"type tag",title:l.type,"data-status":l.shortType},o(l.shortType),9,Y),s("span",ee,o(l.name),1),n.selectedEvents[l.id]?(i(),r("ul",{key:0,onClick:t[2]||(t[2]=M(()=>{},["stop"]))},[s("li",te,[t[4]||(t[4]=s("span",{class:"key"},"user",-1)),l.user_id?(i(),y(c,{key:0,class:"flexrow-item",size:20,"font-size":10,person:e.personMap.get(l.user_id)},null,8,["person"])):u("",!0),l.user_id?(i(),y($,{key:1,class:"flexrow-item",person:e.personMap.get(l.user_id),"with-link":""},null,8,["person"])):u("",!0)]),(i(!0),r(g,null,T(Object.keys(l.data).sort(),v=>(i(),r("li",{key:`${l.id}-${v}`},[s("span",se,o(v),1),a.isLink(v)?(i(),r("a",{key:0,href:a.getLink(l,v)},o(l.data[v]),9,ie)):(i(),r(g,{key:1},[j(o(l.data[v]),1)],64))]))),128))])):u("",!0)],8,Q))),128)),a.hasMoreEvents?(i(),r("div",ae,[m(k,{text:e.$t("main.load_more"),onClick:t[3]||(t[3]=l=>n.displayLimit+=n.PAGE_SIZE)},null,8,["text"])])):u("",!0)]))])}const ne=b(K,[["render",oe],["__scopeId","data-v-4da837be"]]),le={name:"preview-file-list",mixins:[q],components:{ButtonSimple:P,ProductionNameCell:N,TableInfo:G,TaskTypeCell:z},props:{previewFiles:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1}},emits:["mark-broken-clicked"],computed:{...C(["productionMap","taskTypeMap"])},methods:{...L(["loadTask"]),onBodyScroll(e){const t=e.target;this.$refs.headerWrapper.style.left=`-${t.scrollLeft}px`},async redirectToTask(e){const t=await this.loadTask({taskId:e.task_id});return this.$router.push(Z(t,t.project,t.project.production_type==="tvshow",t.episode,this.taskTypeMap))}}},re={class:"data-list"},de={style:{overflow:"hidden"}},ce={class:"datatable",ref:"headerWrapper"},pe={class:"datatable-head"},_e={class:"datatable-row-header"},ue={class:"date"},me={class:"production"},he={class:"entity-name"},fe={class:"task-type"},ve={class:"revision"},ke={class:"status"},ye={class:"datatable"},ge={class:"datatable-body"},be=["onClick"],we={class:"date"},$e={class:"production"},Ee={class:"entity-name"},Te={class:"revision"},Le=["data-status"],Ce={class:"end-cell has-text-right"};function Pe(e,t,d,_,n,a){const h=p("table-info"),f=p("production-name-cell"),k=p("task-type-cell"),w=p("button-simple");return i(),r("div",re,[s("div",de,[s("table",ce,[s("thead",pe,[s("tr",_e,[s("th",ue,o(e.$t("logs.preview_files.date")),1),s("th",me,o(e.$t("logs.preview_files.production")),1),s("th",he,o(e.$t("logs.preview_files.entity_name")),1),s("th",fe,o(e.$t("logs.preview_files.task_type_id")),1),s("th",ve,o(e.$t("logs.preview_files.revision")),1),s("th",ke,o(e.$t("logs.preview_files.status")),1),t[1]||(t[1]=s("th",{class:"end-cell"},null,-1))])])],512)]),m(h,{"is-loading":d.isLoading,"is-error":d.isError},null,8,["is-loading","is-error"]),d.previewFiles.length>0?(i(),r("div",{key:0,onScrollPassive:t[0]||(t[0]=(...c)=>a.onBodyScroll&&a.onBodyScroll(...c))},[s("table",ye,[s("tbody",ge,[(i(!0),r(g,null,T(d.previewFiles,c=>(i(),r("tr",{key:c.id,class:"datatable-row",onClick:$=>a.redirectToTask(c)},[s("td",we,o(e.formatDate(c.created_at)),1),s("td",$e,[m(f,{entry:e.productionMap.get(c.project_id)},null,8,["entry"])]),s("td",Ee,o(c.full_entity_name),1),m(k,{class:"task-type","task-type":e.taskTypeMap.get(c.task_type_id)},null,8,["task-type"]),s("td",Te,o(c.revision),1),s("td",{class:"status","data-status":c.status},o(c.status),9,Le),s("td",Ce,[c.status==="processing"?(i(),y(w,{key:0,class:"mark-broken-button",text:e.$t("logs.preview_files.mark_broken"),onClick:M($=>e.$emit("mark-broken-clicked",c.id),["stop"])},null,8,["text","onClick"])):u("",!0)])],8,be))),128))])])],32)):u("",!0)])}const De=b(le,[["render",Pe],["__scopeId","data-v-fa444a29"]]),Be={name:"preview-files",mixins:[F],components:{ButtonSimple:P,PreviewFileList:De},data(){return{previewFilesLoading:!0,previewFiles:[]}},computed:{...C(["personMap","taskTypeMap","user"]),displayedPreviewFiles(){return this.previewFiles.filter(e=>e.status!=="ready")}},methods:{...L(["getRunningPreviewFiles","markPreviewFileAsBroken"]),async reload(){this.previewFiles=[],this.previewFilesLoading=!0,this.previewFiles=await this.getRunningPreviewFiles(),this.previewFilesLoading=!1},async markBrokenClicked(e){const t=this.previewFiles.find(d=>d.id===e);t.status="broken",await this.markPreviewFileAsBroken(e)}},mounted(){this.reload()}},Fe={class:"mt1"},Me={class:"flexrow"},Ae={class:"flexrow-item"},Ie={key:0,class:"empty"};function xe(e,t,d,_,n,a){const h=p("button-simple"),f=p("preview-file-list");return i(),r("div",Fe,[s("p",Me,[s("em",Ae,o(e.$t("logs.preview_files.explanation")),1),t[0]||(t[0]=s("span",{class:"filler"},null,-1)),m(h,{class:"flexrow-item",icon:"refresh",onClick:a.reload},null,8,["onClick"])]),n.previewFiles.length===0&&!n.previewFilesLoading?(i(),r("p",Ie,o(e.$t("logs.preview_files.empty_list")),1)):(i(),y(f,{key:1,"preview-files":n.previewFiles,"is-loading":n.previewFilesLoading,onMarkBrokenClicked:a.markBrokenClicked},null,8,["preview-files","is-loading","onMarkBrokenClicked"]))])}const Se=b(Be,[["render",xe],["__scopeId","data-v-41e06691"]]),Ve={name:"logs",components:{Events:ne,PreviewFiles:Se},data(){return{activeTab:"events"}},mounted(){this.$route.query.tab&&(this.activeTab=this.$route.query.tab)},methods:{isActiveTab(e){return this.activeTab===e}},watch:{activeTab(){this.$route.query.tab!==this.activeTab&&this.$router.push({query:{tab:this.activeTab}})}}},je={class:"logs fixed-page"},ze={class:"tabs logs-tabs"};function Ge(e,t,d,_,n,a){const h=p("events"),f=p("preview-files");return i(),r("div",je,[s("div",ze,[s("ul",null,[s("li",{class:B({"is-active":a.isActiveTab("events")})},[s("a",{onClick:t[0]||(t[0]=k=>n.activeTab="events")},o(e.$t("logs.title")),1)],2),s("li",{class:B({"is-active":a.isActiveTab("preview_files")})},[s("a",{onClick:t[1]||(t[1]=k=>n.activeTab="preview_files")},o(e.$t("logs.preview_files.title")),1)],2)])]),a.isActiveTab("events")?(i(),y(h,{key:0})):u("",!0),a.isActiveTab("preview_files")?(i(),y(f,{key:1})):u("",!0)])}const qe=b(Ve,[["render",Ge],["__scopeId","data-v-1c1caddd"]]);export{qe as default};
//# sourceMappingURL=Logs-CyUSMIaj.js.map
