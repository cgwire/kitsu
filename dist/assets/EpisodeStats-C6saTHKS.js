import{a4 as _,aV as m,aW as C,T as S,o as l,m as p,aX as g,aY as k,aZ as M,a_ as d,af as v,n as h,aM as r,B as x,C as y,S as b,ae as n,b as E,ah as L,U as R,W as c}from"./index-D97y86BJ.js";import{S as w}from"./StatsCell-B0QoURae.js";const D={name:"episode-stats-list",mixins:[_],components:{ChevronDownIcon:m,ChevronRightIcon:C,StatsCell:w,TableInfo:S},props:{countMode:{type:String,default:"count"},dataMode:{type:String,default:"retakes"},displayMode:{type:String,default:"pie"},entries:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1},showAll:{type:Boolean,default:!1},validationColumns:{type:Array,default:()=>[]}},data(){return{expanded:{},lastSelection:null,takeLabelColors:["#FB8C00","#EF6C00","#d35400","#e74c3c","#c0392b"]}},mounted(){this.entries.forEach(a=>{l.set(this.expanded,a.id,!1)})},computed:{...p(["currentProduction","displayedEpisodesLength","episodeSearchText","episodeStats","episodeRetakeStats","isCurrentUserClient","isCurrentUserManager","isSingleEpisode","taskTypeMap"]),isEmptyList(){return this.entries&&this.entries.length===0&&!this.isLoading&&!this.isError&&(!this.episodeSearchText||this.episodeSearchText.length===0)},isRetakes(){return this.dataMode==="retakes"}},methods:{chartColors(a,t){return this.isRetakes?["#ff3860","#6f727a","#22d160"]:g(this.episodeStats,a,t)},chartData(a,t,e="count"){return this.isRetakes?k(this.episodeRetakeStats,a,t,e):M(this.episodeStats,a,t,e)},chartTakeData(a,t,e,s="count"){const i=this.episodeRetakeStats[a][t].evolution,o=i[e].retake[s],u=i[e].done[s],f=i[e].other[s];return[["retake",o,"#ff3860"],["other",f,"#6f727a"],["done",u,"#22d160"]]},chartLabel(a,t){if(this.isRetakes){const e=d(this.episodeRetakeStats,a,t);return e>=1?`Take ${e+1}`:""}else return""},chartLabelColor(a,t){if(this.isRetakes){let e=d(this.episodeRetakeStats,a,t);return e=Math.min(e,4),this.takeLabelColors[e]}else return""},chartRetakeMaxCount(a,t){return d(this.episodeRetakeStats,a,t)},takeRange(a){return v(1,this.chartRetakeMaxCount(a,"all")+1)},isStats(a,t){return this.episodeStats[a]&&this.episodeStats[a][t]},onBodyScroll(a,t){this.$emit("scroll",t.scrollTop)},setScrollPosition(a){this.$refs.body.scrollTop=a},taskTypePath(a){const t={name:"task-type",params:{production_id:this.currentProduction.id,task_type_id:a,type:"count"}};return this.isTVShow&&(t.name="episode-task-type",t.params.episode_id=this.currentEpisode.id),t},getPath(a,t){return{name:a,params:{production_id:this.currentProduction.id,episode_id:t}}},toggleExpanded(a){this.expanded[a]=!this.expanded[a]}},watch:{entries(){this.entries.forEach(a=>{const t=this.expanded[a.id]||!1;l.set(this.expanded,a.id,t)})},isRetakes(){this.isRetakes||this.entries.forEach(a=>{l.set(this.expanded,a.id,!1)})}}};var T=function(){var t=this,e=t._self._c;return e("div",{staticClass:"data-list"},[e("div",{directives:[{name:"scroll",rawName:"v-scroll",value:t.onBodyScroll,expression:"onBodyScroll"}],ref:"body",staticClass:"datatable-wrapper"},[e("table",{staticClass:"datatable"},[e("thead",{staticClass:"datatable-head"},[e("tr",[e("th",{staticClass:"expander"}),e("th",{ref:"th-episode",staticClass:"name datatable-row-header",attrs:{scope:"col"}},[t._v(" "+t._s(t.$t("shots.fields.episode"))+" ")]),e("th",{staticClass:"validation",attrs:{scope:"col"}},[t._v(t._s(t.$t("main.all")))]),t._l(t.validationColumns,function(s){return e("th",{key:t.taskTypeMap.get(s).id,staticClass:"validation validation-cell",attrs:{scope:"col"}},[e("div",{staticClass:"flexrow validation-content",style:t.getValidationStyle(s)},[t.isCurrentUserClient?e("span",{staticClass:"flexrow-item"},[t._v(" "+t._s(t.taskTypeMap.get(s).name)+" ")]):e("router-link",{staticClass:"flexrow-item",attrs:{to:t.taskTypePath(s)}},[t._v(" "+t._s(t.taskTypeMap.get(s).name)+" ")])],1)])}),e("th",{staticClass:"actions",attrs:{scope:"col"}})],2)]),t.isLoading?t._e():e("tbody",{staticClass:"datatable-body"},[t.showAll&&!t.isEmptyList?e("tr",{staticClass:"all-line datatable-row"},[e("td",{staticClass:"expander"}),e("td",{staticClass:"name datatable-row-header",attrs:{scope:"col"}},[t._v(" "+t._s(t.$t("episodes.all_episodes"))+" ")]),e("stats-cell",{attrs:{colors:t.chartColors("all","all"),data:t.chartData("all","all"),"frames-data":t.chartData("all","all","frames"),"count-mode":t.countMode,"display-mode":t.displayMode}}),t._l(t.validationColumns,function(s){return e("stats-cell",{key:"all-"+s,style:t.getValidationStyle(s),attrs:{colors:t.chartColors("all",s),data:t.chartData("all",s),"frames-data":t.chartData("all",s,"frames"),"count-mode":t.countMode,"display-mode":t.displayMode}})}),e("td",{staticClass:"actions"})],2):t._e(),t._l(t.entries,function(s){return[e("tr",{key:s.id,staticClass:"datatable-row"},[e("td",{staticClass:"expander",on:{click:function(i){return t.toggleExpanded(s.id)}}},[t.isRetakes&&t.expanded[s.id]!==!0?e("chevron-right-icon"):t._e(),t.isRetakes&&t.expanded[s.id]===!0?e("chevron-down-icon"):t._e()],1),e("td",{staticClass:"name datatable-row-header"},[t._v(" "+t._s(s.name)+" ")]),t.isStats(s.id,"all")?e("stats-cell",{attrs:{colors:t.chartColors(s.id,"all"),data:t.chartData(s.id,"all"),"frames-data":t.chartData(s.id,"all","frames"),"count-mode":t.countMode,"display-mode":t.displayMode}}):e("td"),t._l(t.validationColumns,function(i){return t.isStats(s.id,i)?e("stats-cell",{key:s.id+i,style:t.getValidationStyle(i),attrs:{colors:t.chartColors(s.id,i),data:t.chartData(s.id,i),"frames-data":t.chartData(s.id,i,"frames"),"count-mode":t.countMode,"display-mode":t.displayMode,label:t.chartLabel(s.id,i),"label-color":t.chartLabelColor(s.id,i)}}):e("td",{style:t.getValidationStyle(i)})}),e("td",{staticClass:"actions"})],2),t.expanded[s.id]?t._l(t.takeRange(s.id),function(i){return e("tr",{key:i+"-"+s.id,staticClass:"datatable-row"},[e("td",{staticClass:"expander"}),e("td",{staticClass:"name datatable-row-header"},[t._v(" - Take "+t._s(i)+" ")]),e("td"),t._l(t.validationColumns,function(o){return[t.chartRetakeMaxCount(s.id,o)+1>i?e("stats-cell",{key:i+s.id+o,style:t.getValidationStyle(o),attrs:{colors:t.chartColors(s.id,o),data:t.chartTakeData(s.id,o,i),"frames-data":t.chartTakeData(s.id,o,i,"frames"),"count-mode":t.countMode,"display-mode":t.displayMode}}):t.isStats(s.id,o)&&t.chartRetakeMaxCount(s.id,o)+1===i?e("stats-cell",{key:i+s.id+o,style:t.getValidationStyle(o),attrs:{colors:t.chartColors(s.id,o),data:t.chartData(s.id,o),"frames-data":t.chartData(s.id,o,"frames"),"count-mode":t.countMode,"display-mode":t.displayMode}}):e("td",{key:i+s.id+o,style:t.getValidationStyle(o)})]}),e("td",{staticClass:"actions"})],2)}):t._e()]})],2)])]),e("table-info",{attrs:{"is-loading":t.isLoading,"is-error":t.isError}}),!t.isLoading&&t.isEmptyList&&!t.isCurrentUserClient?e("div",{staticClass:"has-text-centered"},[t._m(0),e("p",{staticClass:"info"},[t._v(t._s(t.$t("episodes.empty_list")))])]):t._e(),!t.isLoading&&t.isEmptyList&&t.isCurrentUserClient?e("div",{staticClass:"has-text-centered"},[t._m(1),e("p",{staticClass:"info"},[t._v(t._s(t.$t("episodes.empty_list_client")))])]):t._e(),t.isEmptyList?t._e():e("p",{staticClass:"has-text-centered nb-episodes"},[t._v(" "+t._s(t.displayedEpisodesLength)+" "+t._s(t.$tc("episodes.number",t.displayedEpisodesLength))+" ")])],1)},P=[function(){var a=this,t=a._self._c;return t("p",{staticClass:"info"},[t("img",{attrs:{src:r}})])},function(){var a=this,t=a._self._c;return t("p",{staticClass:"info"},[t("img",{attrs:{src:r}})])}],$=h(D,T,P,!1,null,"3180aeb5");const V=$.exports,O={name:"episode-stats",components:{ButtonSimple:x,Combobox:y,EpisodeStatsList:V,SearchField:b},data(){return{countMode:"count",dataMode:"retakes",displayMode:"pie",episodeToDelete:null,episodeToEdit:null,isLoading:!0,isLoadingError:!1,statusMode:"running",countModeOptions:[{label:"shots",value:"count"},{label:"frames",value:"frames"}],dataModeOptions:[{label:"retakes",value:"retakes"},{label:"status",value:"status"}],displayModeOptions:[{label:"pie",value:"pie"},{label:"count",value:"count"}],statusModeOptions:[{label:"only_running",value:"running"},{label:"all",value:"all"}],errors:{edit:!1,del:!1},modals:{isNewDisplayed:!1,isDeleteDisplayed:!1},loading:{edit:!1,del:!1}}},mounted(){const a=n.getPreference("stats:episode-mode")||"retakes";this.dataMode=a,this.setDefaultSearchText(),this.setDefaultListScrollPosition(),this.isLoading=!0,this.isLoadingError=!1,this.initEpisodes().then(()=>{this.isLoading=!1}).catch(t=>{this.isLoading=!1,this.isLoadingError=!0,console.error(t)})},computed:{...p(["currentProduction","displayedEpisodes","episodesPath","isCurrentUserManager","episodes","episodeMap","episodePath","episodeStats","episodeRetakeStats","episodeSearchText","episodeListScrollPosition","episodeValidationColumns","taskStatusMap","taskTypeMap"]),isRetakeDataMode(){return this.dataMode==="retakes"}},methods:{...E(["computeEpisodeStats","deleteEpisode","editEpisode","hideAssignations","initEpisodes","loadEpisodeStats","loadEpisodeRetakeStats","loadShots","setLastProductionScreen","setEpisodeSearch","setEpisodeListScrollPosition","showAssignations"]),setDefaultSearchText(){this.episodeSearchText.length>0&&this.$refs["episode-search-field"].setValue(this.episodeSearchText)},setDefaultListScrollPosition(){this.$refs["episode-list"].setScrollPosition(this.episodeListScrollPosition)},navigateToList(){this.$router.push(this.episodesPath)},onSearchChange(a){const t=this.$refs["episode-search-field"].getValue();this.setEpisodeSearch(t)},saveScrollPosition(a){this.setEpisodeListScrollPosition(a)},exportStatisticsToCsv(){const a=[L().format("YYYYMMDD"),this.currentProduction.name,"episodes","statistics"];this.isRetakeDataMode&&a.splice(3,0,"retake");const t=R.slugify(a.join("_"));this.isRetakeDataMode?c.generateRetakeStatReports(t,this.episodeRetakeStats,this.taskTypeMap,this.taskStatusMap,this.episodeMap,this.countMode):c.generateStatReports(t,this.episodeStats,this.taskTypeMap,this.taskStatusMap,this.episodeMap,this.countMode)},onFieldChanged({entry:a,fieldName:t,value:e}){const s={id:a.id};s[t]=e,this.editEpisode(s)},reset(){this.isLoading=!0,this.isLoadingError=!1,this.loadEpisodeStats(this.currentProduction.id).then(()=>this.loadEpisodeRetakeStats(this.currentProduction.id)).then(()=>{this.isLoading=!1}).catch(a=>{this.isLoading=!1,this.isLoadingError=!0,console.error(a)})}},watch:{currentProduction(){this.$refs["episode-search-field"].setValue(""),this.$store.commit("SET_SEQUENCE_LIST_SCROLL_POSITION",0),this.reset()},dataMode(){n.setPreference("stats:episode-mode",this.dataMode)}},metaInfo(){return{title:`${this.currentProduction.name} ${this.$t("episodes.title")} - Kitsu`}}};var B=function(){var t=this,e=t._self._c;return e("div",{staticClass:"episodes page fixed-page"},[e("div",{staticClass:"episode-list-header page-header flexrow"},[e("search-field",{ref:"episode-search-field",staticClass:"flexrow-item mt1",attrs:{placeholder:"ex: e01 s01, anim=wip"},on:{change:t.onSearchChange}}),e("combobox",{staticClass:"mb0 flexrow-item",attrs:{"locale-key-prefix":"statistics.",label:t.$t("statistics.data_mode"),options:t.dataModeOptions},model:{value:t.dataMode,callback:function(s){t.dataMode=s},expression:"dataMode"}}),e("combobox",{staticClass:"mb0 flexrow-item",attrs:{"locale-key-prefix":"statistics.",label:t.$t("statistics.display_mode"),options:t.displayModeOptions},model:{value:t.displayMode,callback:function(s){t.displayMode=s},expression:"displayMode"}}),e("combobox",{staticClass:"mb0 flexrow-item",attrs:{label:t.$t("statistics.count_mode"),"locale-key-prefix":"statistics.",options:t.countModeOptions},model:{value:t.countMode,callback:function(s){t.countMode=s},expression:"countMode"}}),e("combobox",{staticClass:"mb0 flexrow-item",attrs:{label:t.$t("statistics.episode_status"),"locale-key-prefix":"statistics.",options:t.statusModeOptions},model:{value:t.statusMode,callback:function(s){t.statusMode=s},expression:"statusMode"}}),e("span",{staticClass:"filler"}),e("button-simple",{staticClass:"flexrow-item",attrs:{icon:"refresh",title:t.$t("main.reload")},on:{click:t.reset}}),e("button-simple",{staticClass:"flexrow-item",attrs:{icon:"download"},on:{click:t.exportStatisticsToCsv}})],1),e("episode-stats-list",{ref:"episode-list",attrs:{entries:t.statusMode==="running"?t.displayedEpisodes.filter(s=>s.status==="running"):t.displayedEpisodes,"is-loading":t.isLoading,"is-error":t.isLoadingError,"validation-columns":t.episodeValidationColumns,"episode-stats":t.episodeStats,"episode-retakes-stats":t.episodeRetakeStats,"data-mode":t.dataMode,"count-mode":t.countMode,"display-mode":t.displayMode,"show-all":t.episodeSearchText.length===0},on:{"field-changed":t.onFieldChanged,scroll:t.saveScrollPosition}})],1)},U=[],A=h(O,B,U,!1,null,null);const Q=A.exports;export{Q as default};
//# sourceMappingURL=EpisodeStats-C6saTHKS.js.map
