import{_ as C,S as U,E as j,m as V,a as P,b as E,r,o as d,c as p,d as a,t as o,F as v,e as L,n as D,f as u,g as k,h as _,i as B,w as I,s as N}from"./index-C2m_IhNF.js";import{f as A}from"./format-CUjWrpVJ.js";import{d as $}from"./dom-tO7tlkHV.js";import{P as G}from"./PeopleAvatarWithMenu-D34IaHhi.js";import{P as Y}from"./ProductionNameCell-Bu7vB3PB.js";import{T as O}from"./TableInfo-B2X54z7i.js";import{T as q}from"./TaskTypeCell-DM2gnWrD.js";import{V as F}from"./ValidationCell-D9FwmVzb.js";import{C as K}from"./ComboboxDepartment-whRm-Bo0.js";import{C as z}from"./ComboboxProduction-Dndrtu96.js";import{C as W}from"./ComboboxTaskType-CiBcPUsC.js";import{C as x}from"./ComboboxStatus-DYpCiml-.js";import{C as H}from"./ComboboxStudio-q2R7SCuH.js";import{P as Q}from"./PageLayout-B9XVVkU2.js";import{P as R}from"./PeopleField-CJ8IkJD1.js";import J from"./TaskInfo-C8qSIbPH.js";import"./user-minus-CqOv0SEt.js";import"./user-DnbVK0KB.js";import"./TaskTypeName-bEgQZfX7.js";import"./eye-CKzk1Q6q.js";import"./DepartmentName-C_7ZW05X.js";import"./csv-cx9HGs3n.js";import"./string-B0Tq569e.js";import"./PreviewPlayer-CsSraBfQ.js";import"./PlaylistPlayer-DoTL8QsR.js";import"./ComboboxSimple-DU0Ahozo.js";import"./ModalFooter-BJ98b-60.js";import"./TextField-p_HJuEKt.js";import"./video-Yn96Kb74.js";import"./clipboard-CQqgyZ_h.js";import"./Combobox-DQpIQydI.js";import"./ComboboxStyled-fscUNRmK.js";import"./DeleteModal-CaB_X4-T.js";import"./index-KDZ8UbBO.js";import"./BaseModal-BCd5z4wK.js";import"./play-B4GV49GM.js";import"./render-Bqw3AFAH.js";import"./EmojiButton-B9I5hDFH.js";import"./FileUpload-C4E3YXqL.js";import"./ConfirmModal-CYuRpfjg.js";import"./triangle-alert-DAfmXCpT.js";import"./ValidationTag-C6BUHddW.js";import"./thumbs-up-DoHhBcNt.js";import"./copy-BH2iDnK6.js";import"./vue.esm-bundler-Cb2j4MJL.js";import"./VideoViewer-Da8LCLxo.js";import"./BuildFilterModal-C3nrV5vY.js";import"./ComboboxBoolean-DJwCfClJ.js";import"./DeleteEntities-ZGV8gTRL.js";import"./HardDeleteModal-CyBgP8oG.js";import"./SearchField-DO27Jrsj.js";import"./corner-right-up-xElzR7oO.js";const X={name:"all-task-list",mixins:[$,A],components:{EntityThumbnail:j,PeopleAvatarWithMenu:G,ProductionNameCell:Y,Spinner:U,TableInfo:O,TaskTypeCell:q,ValidationCell:F},emits:["more-clicked","task-selected"],data(){return{lastSelection:null,page:1,selectionGrid:{}}},props:{isError:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},isMore:{type:Boolean,default:!1},isMoreLoading:{type:Boolean,default:!1},stats:{type:Object,default:()=>{}},tasks:{type:Array,default:()=>[]}},mounted(){window.addEventListener("keydown",this.onKeyDown,!1)},beforeUnmount(){window.removeEventListener("keydown",this.onKeyDown)},computed:{...E(["assetMap","editMap","episodeMap","nbSelectedTasks","personMap","user","selectedTasks","sequenceMap","shotMap","taskMap","isCurrentUserManager","isCurrentUserSupervisor","taskTypeMap"]),nbFrames(){let t=0;return this.tasks.forEach(e=>{t+=e.entity_nb_frames}),t}},methods:{...P(["addSelectedTask","addSelectedTasks","clearSelectedTasks","updateTask","unassignPersonFromTask","removeSelectedTask"]),getParentName(t){return t.sequence_name?t.episode_name?`${t.episode_name} - ${t.sequence_name}`:t.sequence_name:t.entity_type_name},getTaskName(t){return t.entity_name},getDate(t){return t?V(t,"YYYY-MM-DD").toDate():null},formatDate(t){return t?V(t).format("YYYY-MM-DD"):""},isEstimationBurned(t){return t.estimation&&t.estimation>0&&t.duration>t.estimation},onKeyDown(t){if(this.tasks.length>0&&t.altKey){let e=this.lastSelection?this.lastSelection:0;[37,38].includes(t.keyCode)?(e=e-1<0?this.tasks.length-1:e-1,this.selectTask({},e,this.tasks[e]),this.pauseEvent(t)):[39,40].includes(t.keyCode)&&(e=e+1>=this.tasks.length?0:e+1,this.selectTask({},e,this.tasks[e]),this.pauseEvent(t))}},selectTask(t,e,s){if(t&&t.target&&(["INPUT"].includes(t.target.nodeName)||t.target.parentNode&&["HEADER"].includes(t.target.parentNode.nodeName)||["cell day selected"].includes(t.target.className)))return;const f=this.selectionGrid[s.id],i=Object.keys(this.selectionGrid).length>1;this.clearSelectedTasks({task:s}),this.resetSelection(),this.selectionGrid[s.id]?(this.removeSelectedTask({task:s}),this.selectionGrid[s.id]=void 0):(!f||i)&&(this.addSelectedTask({task:s}),this.$emit("task-selected",s),this.selectionGrid[s.id]=!0,this.lastSelection=e)},setScrollPosition(t){this.$refs.body&&(this.$refs.body.scrollTop=t)},resetSelection(){this.selectionGrid={},this.lastSelection=null}},watch:{tasks(){this.page=1,this.resetSelection()},nbSelectedTasks(){this.nbSelectedTasks===0&&this.resetSelection()}}},Z={class:"data-list"},tt={ref:"body",class:"datatable-wrapper"},et={class:"datatable"},st={ref:"thead",class:"datatable-head"},at={class:"row-header"},ot={class:"thumbnail",ref:"th-thumbnail"},it=["title"],lt={class:"empty",ref:""},rt={class:"datatable-body"},nt=["onClick"],dt={class:"project"},mt={class:"thumbnail"},ut={class:"asset-type"},ct={class:"name"},pt={class:"assignees"},ht={class:"flexrow"},ft={class:"estimation number-cell"},_t={class:"start-date"},kt={class:"due-date"},bt={class:"done-date"},yt={key:0,class:"has-text-centered"},gt={key:0,class:"has-text-centered nb-tasks"};function Tt(t,e,s,f,i,n){const c=r("production-name-cell"),b=r("entity-thumbnail"),y=r("task-type-cell"),g=r("validation-cell"),T=r("people-avatar-with-menu"),S=r("spinner"),M=r("table-info");return d(),p("div",Z,[a("div",tt,[a("table",et,[a("thead",st,[a("tr",at,[a("th",{class:"project",ref:"th-name"},o(t.$t("tasks.fields.production")),513),a("th",ot,null,512),a("th",{class:"asset-type",ref:"th-type"},o(t.$t("tasks.fields.parent")),513),a("th",{class:"name",ref:"th-name"},o(t.$t("tasks.fields.entity")),513),a("th",{class:"name",ref:"th-name"},o(t.$t("tasks.fields.task_type")),513),a("th",{class:"status",ref:"th-status"},o(t.$t("tasks.fields.task_status")),513),a("th",{class:"assignees",ref:"th-assignees"},o(t.$t("tasks.fields.assignees")),513),a("th",{ref:"th-estimation",class:"estimation number-cell",title:t.$t("main.estimation")},o(t.$t("tasks.fields.estimation").substring(0,3))+". ",9,it),a("th",{class:"duration number-cell",ref:"th-duration"},o(t.$t("tasks.fields.duration").substring(0,3))+". ",513),a("th",{class:"start-date",ref:"th-date"},o(t.$t("tasks.fields.start_date")),513),a("th",{class:"due-date",ref:"th-date"},o(t.$t("tasks.fields.due_date")),513),a("th",{class:"done-date",ref:"th-date"},o(t.$t("tasks.fields.done_date")),513),a("th",lt,"Â ",512)])],512),a("tbody",rt,[(d(!0),p(v,null,L(s.tasks,(l,w)=>(d(),p("tr",{ref_for:!0,ref:"task-"+l.id,key:l.id,class:D({"task-line":!0,"datatable-row":!0,selected:i.selectionGrid[l.id]}),onClick:h=>n.selectTask(h,w,l)},[a("td",dt,[u(c,{class:"project",entry:{id:l.project_id,name:l.project_name},"only-avatar":!0,"is-link":!1},null,8,["entry"])]),a("td",mt,[u(b,{class:"flexrow-item","preview-file-id":l.last_preview_file_id,width:50,height:33,"empty-width":50,"empty-height":33},null,8,["preview-file-id"])]),a("td",ut,o(n.getParentName(l)),1),a("td",ct,o(l.entity_name),1),u(y,{class:"name","task-type":t.taskTypeMap.get(l.task_type_id)},null,8,["task-type"]),u(g,{class:"status unselectable","task-test":l,"is-border":!1,"is-assignees":!1,selectable:!1,"is-static":!0},null,8,["task-test"]),a("td",pt,[a("div",ht,[(d(!0),p(v,null,L(l.assignees,h=>(d(),k(T,{class:"flexrow-item",key:l.id+"-"+h,person:t.personMap.get(h),size:30,"font-size":16,onUnassign:m=>t.onUnassign(l,m)},null,8,["person","onUnassign"]))),128))])]),a("td",ft,o(t.formatDuration(l.estimation)),1),a("td",{class:D({duration:!0,"number-cell":!0,error:n.isEstimationBurned(l)})},o(t.formatDuration(l.duration)),3),a("td",_t,o(n.formatDate(l.start_date)),1),a("td",kt,o(n.formatDate(l.due_date)),1),a("td",bt,o(n.formatDate(l.done_date)),1),e[1]||(e[1]=a("td",{class:"empty"},null,-1))],10,nt))),128))])]),s.isMore&&!s.isLoading?(d(),p("div",yt,[s.isMoreLoading?(d(),k(S,{key:0,class:"mt2"})):s.isLoading?_("",!0):(d(),p("button",{key:1,class:"button mt2",onClick:e[0]||(e[0]=l=>t.$emit("more-clicked"))},o(t.$t("main.load_more")),1))])):_("",!0),u(M,{"is-loading":s.isLoading,"is-error":s.isError},null,8,["is-loading","is-error"])],512),s.isLoading?_("",!0):(d(),p("p",gt,o(s.stats.total)+" "+o(t.$tc("tasks.number",s.stats.total))+" ("+o(t.formatDuration(s.stats.total_duration))+" "+o(t.isDurationInHours?t.$tc("main.hours_spent",t.formatDuration(s.stats.total_duration,!1)):t.$tc("main.days_spent",t.formatDuration(s.stats.total_duration,!1)))+" / "+o(t.formatDuration(s.stats.total_estimation))+" "+o(t.isDurationInHours?t.$tc("main.hours_estimated",t.formatDuration(s.stats.total_estimation,!1)):t.$tc("main.days_estimated",t.formatDuration(s.stats.total_estimatio,!1)))+") ",1))])}const St=C(X,[["render",Tt],["__scopeId","data-v-3957d5b4"]]),Mt={name:"status-stats",props:{stats:Array},computed:{statMax(){return this.stats?this.stats.reduce((t,e)=>Math.max(e.value,t),0):0}}},wt={class:"status-stats"},It=["title"],vt={class:"stat-text"};function Lt(t,e,s,f,i,n){return d(),p("div",wt,[(d(!0),p(v,null,L(s.stats,c=>(d(),p("div",{key:"stat-"+c.name,class:"stat-wrapper"},[(d(),p("div",{key:"stat-value-"+c.name.toLowerCase(),class:"stat-line",title:c.name+": "+c.value,style:B({background:c.color,width:c.value/n.statMax*100+"%"})},[a("span",vt,o(c.name)+" : "+o(c.value),1)],12,It))]))),128))])}const Ct=C(Mt,[["render",Lt],["__scopeId","data-v-c23a229f"]]),Vt={name:"all-tasks",components:{AllTaskList:St,ComboboxDepartment:K,ComboboxProduction:z,ComboboxTaskType:W,ComboboxStatus:x,ComboboxStudio:H,PageLayout:Q,PeopleField:R,StatusStats:Ct,TaskInfo:J},data(){return{filters:{productionId:null,departmentId:null,studioId:null,taskStatusId:null,taskTypeId:null,person:null},isMore:!1,isMoreLoading:!1,isLoading:!1,isLoadingError:!1,tasks:[],stats:{status:[]}}},mounted(){const t=this.$route.query;t.project_id&&(this.filters.productionId=t.project_id),t.task_status_id&&(this.filters.taskStatusId=t.task_status_id),t.task_type_id&&(this.filters.taskTypeId=t.task_type_id),t.person_id&&(this.filters.person=this.activePeopleWithoutBot.find(e=>e.id===t.person_id)),this.reload()},computed:{...E(["activePeopleWithoutBot","getProductionTaskStatuses","getProductionTaskTypes","nbSelectedTasks","openProductions","personMap","productionMap","selectedTasks","taskStatus","taskStatusMap","taskTypes"]),taskStatusList(){const t=this.filters.productionId,e=this.getProductionTaskStatuses(t).filter(s=>!s.for_concept);return this.addAllValue(e)},taskTypeList(){const t=this.filters.productionId,e=this.getProductionTaskTypes(t).filter(s=>s.for_entity!=="Concept");return this.addAllValue(e)},personList(){const t=this.filters.productionId,e=this.productionMap.get(t);return e?N(e.team.map(s=>this.personMap.get(s)).filter(s=>s&&!s.is_bot)):this.activePeopleWithoutBot},productionList(){return this.addAllValue(this.openProductions)},params(){return{project_id:this.filters.productionId,task_status_id:this.filters.taskStatusId,task_type_id:this.filters.taskTypeId,person_id:this.filters.person?this.filters.person.map(t=>t.id).join(","):null,department_id:this.filters.departmentId,studio_id:this.filters.studioId}},statusStats(){return[...this.stats.status].sort((t,e)=>e.amount-t.amount).map(t=>{const e=this.taskStatusMap.get(t.task_status_id);return{name:e.short_name.toUpperCase(),color:e.color,value:t.amount}})}},methods:{...P(["clearSelectedTasks","loadOpenTasks","loadTask"]),addAllValue(t){return[{id:"",color:"#999",name:this.$t("main.all"),short_name:this.$t("main.all")}].concat([...t])},async reload(){this.isLoading=!0,this.page=1,this.clearSelectedTasks(),this.tasks=[];try{const t={};Object.keys(this.params).forEach(s=>{this.params[s]&&(t[s]=this.params[s])}),this.$router.push({query:t});const e=await this.loadOpenTasks(this.params);this.tasks=e.data,this.stats=e.stats,this.isMore=e.is_more}catch(t){this.isLoadingError=!0,console.error(t)}this.isLoading=!1},loadMore(){this.isMoreLoading=!0,this.page=(this.page||1)+1;const t={...this.params,page:this.page};this.loadOpenTasks(t).then(e=>{this.tasks=this.tasks.concat(e.data),this.isMore=e.is_more,this.isMoreLoading=!1}).catch(e=>{this.isMoreLoading=!1,this.isMoreLoadingError=!0,console.error(e)})},taskClicked(t){this.$router.push({name:"Task",params:{id:t.id}})}},watch:{filters:{handler(){this.reload()},deep:!0},"filters.person":{handler(){this.reload()},deep:!0}},socket:{events:{"task:update"(t){const e=this.tasks.find(s=>s.id===t.task_id);e&&this.loadTask({taskId:e.id}).then(s=>{Object.assign(e,s)})}}},head(){return{title:`${this.$t("tasks.all_tasks")} - Kitsu`}}},Dt={class:"all-tasks"},Pt={class:"filters flexrow mt1"},Et={class:"filters flexrow mt1 mb1"},Ut={class:"flexrow-item selector"},jt={class:"label person-label"};function Bt(t,e,s,f,i,n){const c=r("combobox-production"),b=r("combobox-status"),y=r("combobox-task-type"),g=r("combobox-studio"),T=r("combobox-department"),S=r("people-field"),M=r("all-task-list"),l=r("status-stats"),w=r("task-info"),h=r("page-layout");return d(),k(h,null,{main:I(()=>[a("div",Dt,[a("div",Pt,[u(c,{class:"flexrow-item mb0",label:t.$t("main.production"),"production-list":n.productionList,modelValue:i.filters.productionId,"onUpdate:modelValue":e[0]||(e[0]=m=>i.filters.productionId=m)},null,8,["label","production-list","modelValue"]),u(b,{class:"flexrow-item selector mb0",label:t.$t("news.task_status"),"task-status-list":n.taskStatusList,modelValue:i.filters.taskStatusId,"onUpdate:modelValue":e[1]||(e[1]=m=>i.filters.taskStatusId=m)},null,8,["label","task-status-list","modelValue"]),u(y,{class:"flexrow-item selector mb0",label:t.$t("news.task_type"),"task-type-list":n.taskTypeList,modelValue:i.filters.taskTypeId,"onUpdate:modelValue":e[2]||(e[2]=m=>i.filters.taskTypeId=m)},null,8,["label","task-type-list","modelValue"])]),a("div",Et,[u(g,{class:"mr1","all-studios-label":"",label:t.$t("people.fields.studio"),modelValue:i.filters.studioId,"onUpdate:modelValue":e[3]||(e[3]=m=>i.filters.studioId=m)},null,8,["label","modelValue"]),u(T,{class:"flexrow-item","all-departments-label":"",label:t.$t("main.department"),modelValue:i.filters.departmentId,"onUpdate:modelValue":e[4]||(e[4]=m=>i.filters.departmentId=m)},null,8,["label","modelValue"]),a("div",Ut,[a("label",jt,o(t.$t("main.person")),1),u(S,{class:"person-field",multiple:!0,people:n.personList,modelValue:i.filters.person,"onUpdate:modelValue":e[5]||(e[5]=m=>i.filters.person=m)},null,8,["people","modelValue"])])]),u(M,{tasks:i.tasks,stats:i.stats,"is-loading":i.isLoading,"is-error":i.isLoadingError,"is-more":i.isMore,"is-more-loading":i.isMoreLoading,onTaskClicked:n.taskClicked,onMoreClicked:n.loadMore},null,8,["tasks","stats","is-loading","is-error","is-more","is-more-loading","onTaskClicked","onMoreClicked"])])]),side:I(()=>[u(w,{task:t.selectedTasks.values().next().value},{default:I(()=>[i.isLoading?_("",!0):(d(),k(l,{key:0,stats:n.statusStats},null,8,["stats"]))]),_:1},8,["task"])]),_:1})}const je=C(Vt,[["render",Bt],["__scopeId","data-v-fb20529e"]]);export{je as default};
//# sourceMappingURL=AllTasks-CgMj5y9Y.js.map
