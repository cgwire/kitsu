import{_ as E,cz as T,cA as L,cB as N,a as I,bW as B,cC as Y,aG as D,y as z,aO as w,A as v,bN as P,r as d,c as i,o as n,f as h,F as g,g as _,e as l,t as y,d as C,m as H,u as V,cD as X,cq as G,B as O,cE as K,ab as F,N as q,j as U,k as x,l as W,b6 as J,bu as Q,aj as R,a8 as j}from"./index-D_tEScdB.js";const Z={name:"entity-chat-days",mixins:[z],components:{PeopleAvatar:D,PreviewModal:Y,XIcon:B},emits:["delete-message"],data(){return{currentAttachment:null}},props:{messages:{type:Array,default:()=>[]}},computed:{...I(["departmentMap","personMap","user"]),messageList(){const e=[...this.messages].sort((s,a)=>v(s.created_at).isAfter(v(a.created_at))),t=[];let o={data:null},p=null;return e.forEach(s=>{const a=v(s.created_at).tz(this.user.timezone);if(p&&a.format("YYYY-MM-DD")===p.date)if(o&&o.data&&s.person_id===o.data.person_id&&v(s.created_at).diff(o.data.created_at,"m")<5)o.texts.push(s);else{const c={data:s,texts:[s||""]};o=c,p.messages.push(c)}else{const c={data:s,texts:[s||""]};p={title:a.format("LL"),date:a.format("YYYY-MM-DD"),messages:[c]},o=c,t.push(p)}}),t.reverse()}},methods:{renderComment:N,renderDate(e){return e=v(P(e)).tz(this.user.timezone),e.tz(this.user.timezone).format("HH:mm")},getAttachmentThumbnailPath:L,getDownloadAttachmentPath:T,pictureAttachments(e){return e?e.filter(t=>w.IMG_EXTENSIONS.includes(t.extension)).sort((t,o)=>t.name.localeCompare(o.name,void 0,{numeric:!0})):[]},fileAttachments(e){return e?e.filter(t=>!w.IMG_EXTENSIONS.includes(t.extension)).sort((t,o)=>t.name.localeCompare(o.name,void 0,{numeric:!0})):[]},scrollToBottom(){this.$refs.messages.scrollTop=this.$refs.messages.offsetHeight}}},$={class:"messages",ref:"messages"},ee={class:"day-title"},te={class:"message-content"},se={class:"message-header-wrapper flexrow"},ae={class:"message-sender mr05"},ne={class:"message-date"},ie=["innerHTML"],oe={key:0,class:"attachments"},re=["src","onClick"],le=["href"],ce=["onClick"];function de(e,t,o,p,s,a){const c=d("people-avatar"),k=d("x-icon"),A=d("preview-modal");return n(),i("div",$,[(n(!0),i(g,null,_(a.messageList,M=>(n(),i("div",{class:"day-messages",key:M.title},[l("div",ee,[l("span",null,y(M.title),1)]),(n(!0),i(g,null,_(M.messages,u=>(n(),i("div",{class:"message",key:u.id},[h(c,{class:"message-avatar flexrow-item",person:e.personMap.get(u.data.person_id),size:30,"font-size":15},null,8,["person"]),l("div",te,[l("div",se,[l("div",ae,y(e.personMap.get(u.data.person_id).name),1),l("div",ne,y(a.renderDate(u.data.created_at)),1)]),(n(!0),i(g,null,_(u.texts,f=>(n(),i("div",{class:"message-text",key:"submessage-"+f.id},[l("div",{innerHTML:a.renderComment(f?f.text:"",[],[],e.personMap,e.departmentMap)},null,8,ie),f?(n(),i("div",oe,[(n(!0),i(g,null,_(a.pictureAttachments(f.attachment_files),m=>(n(),i("img",{class:"attachment-thumbnail",key:m.id,src:a.getAttachmentThumbnailPath(m),onClick:b=>s.currentAttachment=m},null,8,re))),128)),(n(!0),i(g,null,_(a.fileAttachments(f.attachment_files),m=>(n(),i("a",{class:"attachment",target:"_blank",key:m.id,href:a.getDownloadAttachmentPath(m)},y(m.name),9,le))),128))])):C("",!0),u.data.person_id===e.user.id?(n(),i("div",{key:1,class:"delete-message-button",onClick:m=>e.$emit("delete-message",u.data.id)},[h(k,{size:12})],8,ce)):C("",!0)]))),128))])]))),128))]))),128)),h(A,{active:s.currentAttachment!=null,attachment:s.currentAttachment,onCancel:t[0]||(t[0]=M=>s.currentAttachment=null)},null,8,["active","attachment"])],512)}const he=E(Z,[["render",de],["__scopeId","data-v-2d259092"]]),me={name:"entity-chat",mixins:[z],components:{AddAttachmentModal:K,ButtonSimple:O,ConfirmModal:G,EmojiButton:X,EntityChatDays:he,PeopleAvatar:D,Spinner:V,XIcon:B},data(){return{attachments:[],chat:{},errors:{addAttachment:!1,chat:!1,deleteMessage:!1,join:!1,leave:!1,send:!1},loading:{addAttachment:!1,chat:!1,deleteMessage:!1,join:!1,leave:!1,send:!1},modals:{addAttachment:!1,deleteMessage:!1},participants:[],currentMessage:"",messages:[],messageMap:new Map}},props:{entity:{type:Object,default:()=>{}},name:{type:String,default:""}},mounted(){this.entity&&this.reset()},computed:{...I(["mainConfig","personMap","user"]),isInChat(){return this.participants.includes(this.user.id)},participantList(){return q(this.participants.map(e=>this.personMap.get(e)))}},methods:{...H(["deleteChatMessage","getChatMessage","getEntityChat","getEntityChatMessages","joinEntityChat","leaveEntityChat","sendChatMessage"]),async reset(){this.loading.chat=!0,this.errors.chat=!1;try{this.chat=await this.getEntityChat(this.entity.id),this.messages=await this.getEntityChatMessages(this.entity.id),this.messages.forEach(e=>this.messageMap.set(e.id,e)),this.participants=this.chat.participants||[]}catch(e){this.errors.chat=!0,console.error(e)}finally{this.loading.chat=!1}},async joinChat(){this.loading.join=!0,this.errors.join=!1;try{await this.joinEntityChat(this.entity.id)}catch(e){this.errors.join=!0,console.error(e)}finally{this.loading.join=!1}},async leaveChat(){this.loading.leave=!0,this.errors.leave=!1;try{await this.leaveEntityChat(this.entity.id)}catch(e){this.errors.leave=!0,console.error(e)}finally{this.loading.leave=!1}},async sendMessage(e){if(e&&e.keyCode===13&&e.shiftKey){this.currentMessage+=`
`;return}this.errors.send=!1,this.loading.send=!0;try{const t=await this.sendChatMessage({entityId:this.entity.id,message:this.currentMessage,attachments:this.attachments});this.currentMessage="",this.attachments=[],this.messages.push(t),this.messageMap.set(t.id,t),this.$refs.messages.scrollToBottom(),this.$nextTick(()=>{this.$refs.messageBox.focus()})}catch(t){this.errors.send=!0,console.error(t)}finally{this.loading.send=!1}},showConfirmDeleteMessage(e){this.modals.deleteMessage=!0,this.errors.deleteMessage=!1,this.loading.deleteMessage=!1,this.messageToDeleteId=e},async deleteMessage(){const e=this.messageToDeleteId;this.errors.deleteMessage=!1;try{this.loading.deleteMessage=!0,this.messages=this.messages.filter(t=>t.id!==e),this.messageMap.delete(e),await this.deleteChatMessage({entityId:this.entity.id,messageId:e}),this.modals.deleteMessage=!1,this.messageToDeleteId=null}catch(t){this.errors.deleteMessage=!0,console.error(t)}finally{this.loading.deleteMessage=!1}},focusMessageBox(){const e=this.$refs.messageBox;e&&e.focus()},addAttachment(e){this.attachments=this.attachments.concat(e),this.closeAttachmentModal()},closeAttachmentModal(){this.modals.addAttachment=!1},removeAttachment(e){this.attachments=this.attachments.filter(t=>t!==e)},onSelectEmoji(e){this.currentMessage=F.insertInTextArea(this.$refs.messageBox,e.i)}},socket:{events:{"chat:joined"(e){e.chat_id===this.chat.id&&!this.participants.includes(e.person_id)&&this.participants.push(e.person_id)},"chat:left"(e){e.chat_id===this.chat.id&&this.participants.includes(e.person_id)&&(this.participants=this.participants.filter(t=>t!==e.person_id))},async"chat:new-message"(e){if(e.chat_id===this.chat.id){const t=await this.getChatMessage({entityId:this.entity.id,messageId:e.chat_message_id});this.messageMap.has(e.chat_message_id)||(this.messageMap.set(t.id,t),this.messages.push(t),this.focusMessageBox())}},"chat:deleted-message"(e){e.chat_id===this.chat.id&&(this.messages=this.messages.filter(t=>t.id!==e.message_id))}}},watch:{entity(){this.entity&&this.reset()}}},ue={class:"mt1 entity-chat"},ge={key:0,class:"has-text-centered"},fe={class:"participants flexrow"},pe={key:0,class:"has-text-centered filler"},_e={key:2,class:"join-chat"},ye=["is-loading"],Me={key:3,class:"message-box"},ve=["disabled"],Ce={class:"buttons"},ke={key:0,class:"attachments"},Ae=["onClick"];function xe(e,t,o,p,s,a){const c=d("button-simple"),k=d("people-avatar"),A=d("spinner"),M=d("entity-chat-days"),u=d("emoji-button"),f=d("x-icon"),m=d("add-attachment-modal"),b=d("confirm-modal"),S=U("focus");return n(),i("div",ue,[o.entity?(n(),i(g,{key:1},[l("div",fe,[(n(!0),i(g,null,_(a.participantList,r=>(n(),x(k,{class:"flexrow-item",key:r.id,person:r,size:20,"font-size":10},null,8,["person"]))),128)),t[6]||(t[6]=l("span",{class:"filler"},null,-1)),a.isInChat?(n(),x(c,{key:0,class:"flexrow-item",text:e.$t("chats.leave"),"is-loading":s.loading.leave,onClick:a.leaveChat},null,8,["text","is-loading","onClick"])):C("",!0)]),s.loading.chat?(n(),i("div",pe,[h(A,{class:"mt1"})])):(n(),x(M,{key:1,ref:"messages",messages:s.messages,onDeleteMessage:a.showConfirmDeleteMessage},null,8,["messages","onDeleteMessage"])),a.isInChat?(n(),i("div",Me,[l("div",null,[W((n(),i("textarea",{id:"message-box",ref:"messageBox",disabled:s.loading.send,onKeydown:t[2]||(t[2]=Q(R((...r)=>a.sendMessage&&a.sendMessage(...r),["prevent"]),["enter"])),"onUpdate:modelValue":t[3]||(t[3]=r=>s.currentMessage=r)},t[7]||(t[7]=[j("          ")]),40,ve)),[[S],[J,s.currentMessage]]),l("div",Ce,[h(u,{onSelect:a.onSelectEmoji},null,8,["onSelect"]),h(c,{class:"attach-button",icon:"attach",onClick:t[4]||(t[4]=r=>s.modals.addAttachment=!0)}),t[8]||(t[8]=l("div",{class:"filler"},null,-1)),h(c,{class:"send-button",icon:"send","is-loading":s.loading.send,onClick:a.sendMessage},null,8,["is-loading","onClick"])])]),s.attachments.length>0?(n(),i("div",ke,[(n(!0),i(g,null,_(s.attachments,r=>(n(),i("div",{class:"attachment-name",key:r.name},[j(y(r.get("file").name)+" ",1),l("span",{onClick:be=>a.removeAttachment(r)},[h(f,{size:8})],8,Ae)]))),128))])):C("",!0)])):(n(),i("div",_e,[l("button",{class:"button","is-loading":s.loading.join,onClick:t[1]||(t[1]=(...r)=>a.joinChat&&a.joinChat(...r))},y(e.$t("chats.join")),9,ye)]))],64)):(n(),i(g,{key:0},[l("p",null,y(e.$t("chats.no_chat")),1),e.mainConfig.indexer_configured?(n(),i("div",ge,[h(c,{text:e.$t("chats.search_entity"),onClick:t[0]||(t[0]=r=>e.$router.push("entity-search"))},null,8,["text"])])):C("",!0)],64)),h(m,{ref:"add-attachment-modal",active:s.modals.addAttachment,"is-loading":s.loading.addAttachment,"is-error":s.errors.addAttachment,title:o.name,onCancel:a.closeAttachmentModal,onConfirm:a.addAttachment},null,8,["active","is-loading","is-error","title","onCancel","onConfirm"]),h(b,{active:s.modals.deleteMessage,"confirm-button-text":e.$t("chats.delete_message_confirm"),text:e.$t("chats.delete_message"),"is-loading":s.loading.deleteMessage,"is-error":s.errors.deleteMessage,onCancel:t[5]||(t[5]=r=>s.modals.deleteMessage=!1),onConfirm:a.deleteMessage},null,8,["active","confirm-button-text","text","is-loading","is-error","onConfirm"])])}const je=E(me,[["render",xe],["__scopeId","data-v-fd3aafd0"]]);export{je as E};
//# sourceMappingURL=EntityChat-DqzH64Tc.js.map
