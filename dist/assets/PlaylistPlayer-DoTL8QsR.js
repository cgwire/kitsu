const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/TaskInfo-C8qSIbPH.js","assets/index-C2m_IhNF.js","assets/index-C-8uRq4g.css","assets/csv-cx9HGs3n.js","assets/string-B0Tq569e.js","assets/PreviewPlayer-CsSraBfQ.js","assets/render-Bqw3AFAH.js","assets/video-Yn96Kb74.js","assets/EmojiButton-B9I5hDFH.js","assets/FileUpload-C4E3YXqL.js","assets/FileUpload-BYTGcAam.css","assets/EmojiButton-B7KSe1yN.css","assets/ComboboxStatus-DYpCiml-.js","assets/ComboboxStatus-94FiNc0O.css","assets/ConfirmModal-CYuRpfjg.js","assets/ConfirmModal-DFnTZHgQ.css","assets/TaskTypeName-bEgQZfX7.js","assets/TaskTypeName-gT-JIvMt.css","assets/triangle-alert-DAfmXCpT.js","assets/dom-tO7tlkHV.js","assets/ValidationTag-C6BUHddW.js","assets/ValidationTag-CX1L5uTW.css","assets/thumbs-up-DoHhBcNt.js","assets/copy-BH2iDnK6.js","assets/vue.esm-bundler-Cb2j4MJL.js","assets/ModalFooter-BJ98b-60.js","assets/ModalFooter-Dz36SOxB.css","assets/TextField-p_HJuEKt.js","assets/TextField-NVCbKgc7.css","assets/Combobox-DQpIQydI.js","assets/Combobox-CmV6qQXF.css","assets/ComboboxStyled-fscUNRmK.js","assets/ComboboxStyled-REhbxSxE.css","assets/VideoViewer-Da8LCLxo.js","assets/index-KDZ8UbBO.js","assets/VideoViewer-zdMa9_OK.css","assets/PreviewPlayer-CySZg8b0.css","assets/BuildFilterModal-C3nrV5vY.js","assets/ComboboxTaskType-CiBcPUsC.js","assets/ComboboxTaskType-DR8U23Q0.css","assets/ComboboxBoolean-DJwCfClJ.js","assets/PeopleField-CJ8IkJD1.js","assets/PeopleField-DH48MJaw.css","assets/BuildFilterModal-De0kjV77.css","assets/DeleteEntities-ZGV8gTRL.js","assets/HardDeleteModal-CyBgP8oG.js","assets/HardDeleteModal-92WvEQHr.css","assets/DeleteEntities-7pcEixAx.css","assets/SearchField-DO27Jrsj.js","assets/SearchField-ekkIuyOx.css","assets/corner-right-up-xElzR7oO.js","assets/DeleteModal-CaB_X4-T.js","assets/DeleteModal-C20vICPS.css","assets/ComboboxSimple-DU0Ahozo.js","assets/ComboboxSimple-BNhrUcrQ.css","assets/clipboard-CQqgyZ_h.js","assets/BaseModal-BCd5z4wK.js","assets/BaseModal-2bLwXwZl.css","assets/ComboboxDepartment-whRm-Bo0.js","assets/DepartmentName-C_7ZW05X.js","assets/DepartmentName-X7EULdpW.css","assets/ComboboxDepartment-CvCdvAka.css","assets/ComboboxStudio-q2R7SCuH.js","assets/ComboboxStudio-DsgNaVrv.css","assets/play-B4GV49GM.js","assets/TaskInfo-BB-2pcB2.css"])))=>i.map(i=>d[i]);
import{_ as Tt,M as dr,p as ec,b as Ee,r as G,q as ic,o as M,c as R,d as L,t as U,I as Ei,k as st,f as H,g as et,h as V,n as St,b6 as ir,bp as sc,J as rc,aP as nc,b3 as oc,x as ye,b9 as os,a as wo,bq as lr,a0 as hr,B as ls,i as lt,v as rt,F as Ht,e as ee,S as De,U as ac,R as Co,w as ns,b5 as bo,aB as lc,u as hc,br as cc,Q as uc,bj as dc,V as fc,H as as,b2 as pc,a2 as gc,a3 as mc,m as ao,b4 as yc,T as lo}from"./index-C2m_IhNF.js";import{C as vc}from"./ComboboxSimple-DU0Ahozo.js";import{C as _o}from"./ComboboxTaskType-CiBcPUsC.js";import{M as xo}from"./ModalFooter-BJ98b-60.js";import{T as wc}from"./TextField-p_HJuEKt.js";import{a as Cc,r as qt,b as Oi,c as bc,f as Po}from"./video-Yn96Kb74.js";import{c as sr}from"./clipboard-CQqgyZ_h.js";import{d as Di}from"./dom-tO7tlkHV.js";import{C as So}from"./Combobox-DQpIQydI.js";import{C as _c}from"./ComboboxStyled-fscUNRmK.js";import{D as xc}from"./DeleteModal-CaB_X4-T.js";import{p as cr}from"./index-KDZ8UbBO.js";import{B as Pc}from"./BaseModal-BCd5z4wK.js";import{C as Sc}from"./ComboboxDepartment-whRm-Bo0.js";import{C as Tc}from"./ComboboxStudio-q2R7SCuH.js";import{P as kc}from"./play-B4GV49GM.js";const Oc={name:"edit-playlist-modal",mixins:[dr],components:{ComboboxSimple:vc,ComboboxTaskType:_o,ModalFooter:xo,TextField:wc},props:{active:{type:Boolean,value:!1},isError:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},playlistToEdit:{type:Object,default:()=>{}},typeDisabled:{type:Boolean,default:!1},taskTypeId:{type:String,default:""}},emits:["cancel","confirm"],data(){return{forClient:"false",forClientOptions:[{label:this.$t("playlists.for_client"),value:"true"},{label:this.$t("playlists.for_studio"),value:"false"}],form:{name:this.playlistToEdit.name,for_entity:this.playlistToEdit.for_entity,for_client:this.playlistToEdit.for_client,is_for_all:this.currentEpisode&&this.currentEpisode.id==="all",task_type_id:this.taskTypeId}}},computed:{...Ee(["currentEpisode","currentProduction","productionTaskTypes"]),isEditing(){return this.playlistToEdit&&this.playlistToEdit.id},forEntityOptions(){return this.currentEpisode&&["main","all"].includes(this.currentEpisode.id)||this.currentProduction?.production_type==="assets"?[{label:this.$t("assets.title"),value:"asset"}]:this.currentProduction?.production_type==="shots"?[{label:this.$t("shots.title"),value:"shot"},{label:this.$t("sequences.title"),value:"sequence"}]:[{label:this.$t("assets.title"),value:"asset"},{label:this.$t("shots.title"),value:"shot"},{label:this.$t("sequences.title"),value:"sequence"}]},defaultForEntity(){const r=this.currentProduction?.production_type==="assets",n=this.currentProduction?.production_type==="shots";return(this.currentEpisode&&["all","main"].includes(this.currentEpisode.id)||r)&&!n?"asset":"shot"},taskTypeList(){const r=[...this.productionTaskTypes].filter(n=>n.for_entity.toLowerCase()===this.form.for_entity);return[{id:"",color:"#999",name:this.$t("news.all")}].concat(ec([...r]))}},methods:{runConfirmation(){if(!this.form.name){this.$refs.nameField.focus();return}this.form.for_client=this.forClient==="true",this.$emit("confirm",this.form)},resetForm(){this.isEditing?(this.form.name=this.playlistToEdit.name,this.form.for_entity=this.playlistToEdit.for_entity,this.form.for_client=this.playlistToEdit.for_client,this.form.is_for_all=this.currentEpisode&&this.currentEpisode.id==="all",this.form.task_type_id=this.playlistToEdit.task_type_id):this.form={name:this.playlistToEdit.name,for_entity:this.playlistToEdit.for_entity||this.defaultForEntity,for_client:"false",is_for_all:this.currentEpisode&&this.currentEpisode.id==="all",task_type_id:this.taskTypeId}}},watch:{playlistToEdit(){this.resetForm()},active(){this.active&&(this.forClient=this.playlistToEdit.for_client?"true":"false",this.resetForm(),setTimeout(()=>{this.$refs.nameField?.focus()},100))}}},Ec={class:"modal-content"},Dc={class:"box"},Mc={key:0,class:"title"},Ac={key:1,class:"title"};function Fc(r,n,h,d,f,g){const w=G("text-field"),C=G("combobox-simple"),x=G("combobox-task-type"),P=G("modal-footer"),E=ic("focus");return M(),R("div",{class:St({modal:!0,"is-active":h.active})},[L("div",{class:"modal-background",onClick:n[0]||(n[0]=D=>r.$emit("cancel"))}),L("div",Ec,[L("div",Dc,[g.isEditing?(M(),R("h1",Mc,U(r.$t("playlists.edit_title")),1)):(M(),R("h1",Ac,U(r.$t("playlists.create_title")),1)),L("form",{onSubmit:n[5]||(n[5]=Ei(()=>{},["prevent"]))},[st(H(w,{ref:"nameField",label:r.$t("playlists.fields.name"),maxlength:80,onEnter:g.runConfirmation,modelValue:f.form.name,"onUpdate:modelValue":n[1]||(n[1]=D=>f.form.name=D),modelModifiers:{trim:!0}},null,8,["label","onEnter","modelValue"]),[[E]]),H(C,{label:r.$t("playlists.fields.for_client"),options:f.forClientOptions,modelValue:f.forClient,"onUpdate:modelValue":n[2]||(n[2]=D=>f.forClient=D)},null,8,["label","options","modelValue"]),g.isEditing?V("",!0):(M(),et(C,{key:0,label:r.$t("playlists.fields.for_entity"),options:g.forEntityOptions,disabled:h.typeDisabled,modelValue:f.form.for_entity,"onUpdate:modelValue":n[3]||(n[3]=D=>f.form.for_entity=D)},null,8,["label","options","disabled","modelValue"])),H(x,{class:"flexrow-item selector",label:r.$t("news.task_type"),"task-type-list":g.taskTypeList,up:!0,modelValue:f.form.task_type_id,"onUpdate:modelValue":n[4]||(n[4]=D=>f.form.task_type_id=D)},null,8,["label","task-type-list","modelValue"])],32),H(P,{"error-text":r.$t("playlists.edit_error"),"is-error":h.isError,"is-loading":h.isLoading,onConfirm:g.runConfirmation,onCancel:n[6]||(n[6]=D=>r.$emit("cancel"))},null,8,["error-text","is-error","is-loading","onConfirm"])])])],2)}const vp=Tt(Oc,[["render",Fc],["__scopeId","data-v-fbf6c860"]]);function It(r,n,h,d){return new(h||(h=Promise))((function(f,g){function w(P){try{x(d.next(P))}catch(E){g(E)}}function C(P){try{x(d.throw(P))}catch(E){g(E)}}function x(P){var E;P.done?f(P.value):(E=P.value,E instanceof h?E:new h((function(D){D(E)}))).then(w,C)}x((d=d.apply(r,n||[])).next())}))}class Mi{constructor(){this.listeners={}}on(n,h,d){if(this.listeners[n]||(this.listeners[n]=new Set),d?.once){const f=(...g)=>{this.un(n,f),h(...g)};return this.listeners[n].add(f),()=>this.un(n,f)}return this.listeners[n].add(h),()=>this.un(n,h)}un(n,h){var d;(d=this.listeners[n])===null||d===void 0||d.delete(h)}once(n,h){return this.on(n,h,{once:!0})}unAll(){this.listeners={}}emit(n,...h){this.listeners[n]&&this.listeners[n].forEach((d=>d(...h)))}}const rs={decode:function(r,n){return It(this,void 0,void 0,(function*(){const h=new AudioContext({sampleRate:n});try{return yield h.decodeAudioData(r)}finally{h.close()}}))},createBuffer:function(r,n){if(!r||r.length===0)throw new Error("channelData must be a non-empty array");if(n<=0)throw new Error("duration must be greater than 0");if(typeof r[0]=="number"&&(r=[r]),!r[0]||r[0].length===0)throw new Error("channelData must contain non-empty channel arrays");(function(d){const f=d[0];if(f.some((g=>g>1||g<-1))){const g=f.length;let w=0;for(let C=0;C<g;C++){const x=Math.abs(f[C]);x>w&&(w=x)}for(const C of d)for(let x=0;x<g;x++)C[x]/=w}})(r);const h=r.map((d=>d instanceof Float32Array?d:Float32Array.from(d)));return{duration:n,length:h[0].length,sampleRate:h[0].length/n,numberOfChannels:h.length,getChannelData:d=>{const f=h[d];if(!f)throw new Error(`Channel ${d} not found`);return f},copyFromChannel:AudioBuffer.prototype.copyFromChannel,copyToChannel:AudioBuffer.prototype.copyToChannel}}};function To(r,n){const h=n.xmlns?document.createElementNS(n.xmlns,r):document.createElement(r);for(const[d,f]of Object.entries(n))if(d==="children"&&f)for(const[g,w]of Object.entries(f))w instanceof Node?h.appendChild(w):typeof w=="string"?h.appendChild(document.createTextNode(w)):h.appendChild(To(g,w));else d==="style"?Object.assign(h.style,f):d==="textContent"?h.textContent=f:h.setAttribute(d,f.toString());return h}function ho(r,n,h){const d=To(r,n||{});return h?.appendChild(d),d}var Lc=Object.freeze({__proto__:null,createElement:ho,default:ho});const Rc={fetchBlob:function(r,n,h){return It(this,void 0,void 0,(function*(){const d=yield fetch(r,h);if(d.status>=400)throw new Error(`Failed to fetch ${r}: ${d.status} (${d.statusText})`);return(function(f,g){It(this,void 0,void 0,(function*(){if(!f.body||!f.headers)return;const w=f.body.getReader(),C=Number(f.headers.get("Content-Length"))||0;let x=0;const P=E=>{x+=E?.length||0;const D=Math.round(x/C*100);g(D)};try{for(;;){const E=yield w.read();if(E.done)break;P(E.value)}}catch(E){console.warn("Progress tracking error:",E)}}))})(d.clone(),n),d.blob()}))}};class jc extends Mi{constructor(n){super(),this.isExternalMedia=!1,n.media?(this.media=n.media,this.isExternalMedia=!0):this.media=document.createElement("audio"),n.mediaControls&&(this.media.controls=!0),n.autoplay&&(this.media.autoplay=!0),n.playbackRate!=null&&this.onMediaEvent("canplay",(()=>{n.playbackRate!=null&&(this.media.playbackRate=n.playbackRate)}),{once:!0})}onMediaEvent(n,h,d){return this.media.addEventListener(n,h,d),()=>this.media.removeEventListener(n,h,d)}getSrc(){return this.media.currentSrc||this.media.src||""}revokeSrc(){const n=this.getSrc();n.startsWith("blob:")&&URL.revokeObjectURL(n)}canPlayType(n){return this.media.canPlayType(n)!==""}setSrc(n,h){const d=this.getSrc();if(n&&d===n)return;this.revokeSrc();const f=h instanceof Blob&&(this.canPlayType(h.type)||!n)?URL.createObjectURL(h):n;if(d&&this.media.removeAttribute("src"),f||n)try{this.media.src=f}catch{this.media.src=n}}destroy(){this.isExternalMedia||(this.media.pause(),this.revokeSrc(),this.media.removeAttribute("src"),this.media.load(),this.media.remove())}setMediaElement(n){this.media=n}play(){return It(this,void 0,void 0,(function*(){try{return yield this.media.play()}catch(n){if(n instanceof DOMException&&n.name==="AbortError")return;throw n}}))}pause(){this.media.pause()}isPlaying(){return!this.media.paused&&!this.media.ended}setTime(n){this.media.currentTime=Math.max(0,Math.min(n,this.getDuration()))}getDuration(){return this.media.duration}getCurrentTime(){return this.media.currentTime}getVolume(){return this.media.volume}setVolume(n){this.media.volume=n}getMuted(){return this.media.muted}setMuted(n){this.media.muted=n}getPlaybackRate(){return this.media.playbackRate}isSeeking(){return this.media.seeking}setPlaybackRate(n,h){h!=null&&(this.media.preservesPitch=h),this.media.playbackRate=n}getMediaElement(){return this.media}setSinkId(n){return this.media.setSinkId(n)}}function rr(r){return r<0?0:r>1?1:r}function Ic({maxTop:r,maxBottom:n,halfHeight:h,vScale:d}){const f=Math.round(r*h*d);return{topHeight:f,totalHeight:f+Math.round(n*h*d)||1}}function Bc({barAlign:r,halfHeight:n,topHeight:h,totalHeight:d,canvasHeight:f}){return r==="top"?0:r==="bottom"?f-d:n-h}function co(r,n,h){const d=n-r.left,f=h-r.top;return[d/r.width,f/r.height]}function ko(r){return!!(r.barWidth||r.barGap||r.barAlign)}function uo(r,n){if(!ko(n))return r;const h=n.barWidth||.5,d=h+(n.barGap||h/2);return d===0?r:Math.floor(r/d)*d}function fo({scrollLeft:r,totalWidth:n,numCanvases:h}){if(n===0)return[0];const d=r/n,f=Math.floor(d*h);return[f-1,f,f+1]}function po({scrollLeft:r,clientWidth:n,scrollWidth:h}){return h===0?{startX:0,endX:0}:{startX:r/h,endX:(r+n)/h}}class Wc extends Mi{constructor(n,h){super(),this.timeouts=[],this.isScrollable=!1,this.audioData=null,this.resizeObserver=null,this.lastContainerWidth=0,this.isDragging=!1,this.subscriptions=[],this.unsubscribeOnScroll=[],this.dragUnsubscribe=null,this.subscriptions=[],this.options=n;const d=this.parentFromOptionsContainer(n.container);this.parent=d;const[f,g]=this.initHtml();d.appendChild(f),this.container=f,this.scrollContainer=g.querySelector(".scroll"),this.wrapper=g.querySelector(".wrapper"),this.canvasWrapper=g.querySelector(".canvases"),this.progressWrapper=g.querySelector(".progress"),this.cursor=g.querySelector(".cursor"),h&&g.appendChild(h),this.initEvents()}parentFromOptionsContainer(n){let h;if(typeof n=="string"?h=document.querySelector(n):n instanceof HTMLElement&&(h=n),!h)throw new Error("Container not found");return h}initEvents(){if(this.wrapper.addEventListener("click",(n=>{const h=this.wrapper.getBoundingClientRect(),[d,f]=co(h,n.clientX,n.clientY);this.emit("click",d,f)})),this.wrapper.addEventListener("dblclick",(n=>{const h=this.wrapper.getBoundingClientRect(),[d,f]=co(h,n.clientX,n.clientY);this.emit("dblclick",d,f)})),this.options.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.scrollContainer.addEventListener("scroll",(()=>{const{scrollLeft:n,scrollWidth:h,clientWidth:d}=this.scrollContainer,{startX:f,endX:g}=po({scrollLeft:n,scrollWidth:h,clientWidth:d});this.emit("scroll",f,g,n,n+d)})),typeof ResizeObserver=="function"){const n=this.createDelay(100);this.resizeObserver=new ResizeObserver((()=>{n().then((()=>this.onContainerResize())).catch((()=>{}))})),this.resizeObserver.observe(this.scrollContainer)}}onContainerResize(){const n=this.parent.clientWidth;n===this.lastContainerWidth&&this.options.height!=="auto"||(this.lastContainerWidth=n,this.reRender(),this.emit("resize"))}initDrag(){this.dragUnsubscribe||(this.dragUnsubscribe=(function(n,h,d,f,g=3,w=0,C=100){if(!n)return()=>{};const x=new Map,P=matchMedia("(pointer: coarse)").matches;let E=()=>{};const D=W=>{if(W.button!==w||(x.set(W.pointerId,W),x.size>1))return;let N=W.clientX,q=W.clientY,Y=!1;const nt=Date.now(),Et=Q=>{if(Q.defaultPrevented||x.size>1||P&&Date.now()-nt<C)return;const ut=Q.clientX,vt=Q.clientY,wt=ut-N,at=vt-q;if(Y||Math.abs(wt)>g||Math.abs(at)>g){Q.preventDefault(),Q.stopPropagation();const $t=n.getBoundingClientRect(),{left:Xt,top:ie}=$t;Y||(d?.(N-Xt,q-ie),Y=!0),h(wt,at,ut-Xt,vt-ie),N=ut,q=vt}},mt=Q=>{if(x.delete(Q.pointerId),Y){const ut=Q.clientX,vt=Q.clientY,wt=n.getBoundingClientRect(),{left:at,top:$t}=wt;f?.(ut-at,vt-$t)}E()},bt=Q=>{x.delete(Q.pointerId),Q.relatedTarget&&Q.relatedTarget!==document.documentElement||mt(Q)},yt=Q=>{Y&&(Q.stopPropagation(),Q.preventDefault())},ht=Q=>{Q.defaultPrevented||x.size>1||Y&&Q.preventDefault()};document.addEventListener("pointermove",Et),document.addEventListener("pointerup",mt),document.addEventListener("pointerout",bt),document.addEventListener("pointercancel",bt),document.addEventListener("touchmove",ht,{passive:!1}),document.addEventListener("click",yt,{capture:!0}),E=()=>{document.removeEventListener("pointermove",Et),document.removeEventListener("pointerup",mt),document.removeEventListener("pointerout",bt),document.removeEventListener("pointercancel",bt),document.removeEventListener("touchmove",ht),setTimeout((()=>{document.removeEventListener("click",yt,{capture:!0})}),10)}};return n.addEventListener("pointerdown",D),()=>{E(),n.removeEventListener("pointerdown",D),x.clear()}})(this.wrapper,((n,h,d)=>{const f=this.wrapper.getBoundingClientRect().width;this.emit("drag",rr(d/f))}),(n=>{this.isDragging=!0;const h=this.wrapper.getBoundingClientRect().width;this.emit("dragstart",rr(n/h))}),(n=>{this.isDragging=!1;const h=this.wrapper.getBoundingClientRect().width;this.emit("dragend",rr(n/h))})),this.subscriptions.push(this.dragUnsubscribe))}initHtml(){const n=document.createElement("div"),h=n.attachShadow({mode:"open"}),d=this.options.cspNonce&&typeof this.options.cspNonce=="string"?this.options.cspNonce.replace(/"/g,""):"";return h.innerHTML=`
      <style${d?` nonce="${d}"`:""}>
        :host {
          user-select: none;
          min-width: 1px;
        }
        :host audio {
          display: block;
          width: 100%;
        }
        :host .scroll {
          overflow-x: auto;
          overflow-y: hidden;
          width: 100%;
          position: relative;
        }
        :host .noScrollbar {
          scrollbar-color: transparent;
          scrollbar-width: none;
        }
        :host .noScrollbar::-webkit-scrollbar {
          display: none;
          -webkit-appearance: none;
        }
        :host .wrapper {
          position: relative;
          overflow: visible;
          z-index: 2;
        }
        :host .canvases {
          min-height: ${this.getHeight(this.options.height,this.options.splitChannels)}px;
          pointer-events: none;
        }
        :host .canvases > div {
          position: relative;
        }
        :host canvas {
          display: block;
          position: absolute;
          top: 0;
          image-rendering: pixelated;
        }
        :host .progress {
          pointer-events: none;
          position: absolute;
          z-index: 2;
          top: 0;
          left: 0;
          width: 0;
          height: 100%;
          overflow: hidden;
        }
        :host .progress > div {
          position: relative;
        }
        :host .cursor {
          pointer-events: none;
          position: absolute;
          z-index: 5;
          top: 0;
          left: 0;
          height: 100%;
          border-radius: 2px;
        }
      </style>

      <div class="scroll" part="scroll">
        <div class="wrapper" part="wrapper">
          <div class="canvases" part="canvases"></div>
          <div class="progress" part="progress"></div>
          <div class="cursor" part="cursor"></div>
        </div>
      </div>
    `,[n,h]}setOptions(n){if(this.options.container!==n.container){const h=this.parentFromOptionsContainer(n.container);h.appendChild(this.container),this.parent=h}n.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.options=n,this.reRender()}getWrapper(){return this.wrapper}getWidth(){return this.scrollContainer.clientWidth}getScroll(){return this.scrollContainer.scrollLeft}setScroll(n){this.scrollContainer.scrollLeft=n}setScrollPercentage(n){const{scrollWidth:h}=this.scrollContainer,d=h*n;this.setScroll(d)}destroy(){var n;this.subscriptions.forEach((h=>h())),this.container.remove(),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),(n=this.unsubscribeOnScroll)===null||n===void 0||n.forEach((h=>h())),this.unsubscribeOnScroll=[]}createDelay(n=10){let h,d;const f=()=>{h&&(clearTimeout(h),h=void 0),d&&(d(),d=void 0)};return this.timeouts.push(f),()=>new Promise(((g,w)=>{f(),d=w,h=setTimeout((()=>{h=void 0,d=void 0,g()}),n)}))}getHeight(n,h){var d;const f=((d=this.audioData)===null||d===void 0?void 0:d.numberOfChannels)||1;return(function({optionsHeight:g,optionsSplitChannels:w,parentHeight:C,numberOfChannels:x,defaultHeight:P=128}){if(g==null)return P;const E=Number(g);if(!isNaN(E))return E;if(g==="auto"){const D=C||P;return w?.every((W=>!W.overlay))?D/x:D}return P})({optionsHeight:n,optionsSplitChannels:h,parentHeight:this.parent.clientHeight,numberOfChannels:f,defaultHeight:128})}convertColorValues(n){return(function(h,d){if(!Array.isArray(h))return h||"";if(h.length===0)return"#999";if(h.length<2)return h[0]||"";const f=document.createElement("canvas"),g=f.getContext("2d"),w=f.height*d,C=g.createLinearGradient(0,0,0,w||d),x=1/(h.length-1);return h.forEach(((P,E)=>{C.addColorStop(E*x,P)})),C})(n,this.getPixelRatio())}getPixelRatio(){return n=window.devicePixelRatio,Math.max(1,n||1);var n}renderBarWaveform(n,h,d,f){const{width:g,height:w}=d.canvas,{halfHeight:C,barWidth:x,barRadius:P,barIndexScale:E,barSpacing:D}=(function({width:N,height:q,length:Y,options:nt,pixelRatio:Et}){const mt=q/2,bt=nt.barWidth?nt.barWidth*Et:1,yt=nt.barGap?nt.barGap*Et:nt.barWidth?bt/2:0,ht=bt+yt||1;return{halfHeight:mt,barWidth:bt,barGap:yt,barRadius:nt.barRadius||0,barIndexScale:Y>0?N/ht/Y:0,barSpacing:ht}})({width:g,height:w,length:(n[0]||[]).length,options:h,pixelRatio:this.getPixelRatio()}),W=(function({channelData:N,barIndexScale:q,barSpacing:Y,barWidth:nt,halfHeight:Et,vScale:mt,canvasHeight:bt,barAlign:yt}){const ht=N[0]||[],Q=N[1]||ht,ut=ht.length,vt=[];let wt=0,at=0,$t=0;for(let Xt=0;Xt<=ut;Xt++){const ie=Math.round(Xt*q);if(ie>wt){const{topHeight:z,totalHeight:J}=Ic({maxTop:at,maxBottom:$t,halfHeight:Et,vScale:mt}),se=Bc({barAlign:yt,halfHeight:Et,topHeight:z,totalHeight:J,canvasHeight:bt});vt.push({x:wt*Y,y:se,width:nt,height:J}),wt=ie,at=0,$t=0}const Me=Math.abs(ht[Xt]||0),ae=Math.abs(Q[Xt]||0);Me>at&&(at=Me),ae>$t&&($t=ae)}return vt})({channelData:n,barIndexScale:E,barSpacing:D,barWidth:x,halfHeight:C,vScale:f,canvasHeight:w,barAlign:h.barAlign});d.beginPath();for(const N of W)P&&"roundRect"in d?d.roundRect(N.x,N.y,N.width,N.height,P):d.rect(N.x,N.y,N.width,N.height);d.fill(),d.closePath()}renderLineWaveform(n,h,d,f){const{width:g,height:w}=d.canvas,C=(function({channelData:x,width:P,height:E,vScale:D}){const W=E/2,N=x[0]||[];return[N,x[1]||N].map(((q,Y)=>{const nt=q.length,Et=nt?P/nt:0,mt=W,bt=Y===0?-1:1,yt=[{x:0,y:mt}];let ht=0,Q=0;for(let ut=0;ut<=nt;ut++){const vt=Math.round(ut*Et);if(vt>ht){const at=mt+(Math.round(Q*W*D)||1)*bt;yt.push({x:ht,y:at}),ht=vt,Q=0}const wt=Math.abs(q[ut]||0);wt>Q&&(Q=wt)}return yt.push({x:ht,y:mt}),yt}))})({channelData:n,width:g,height:w,vScale:f});d.beginPath();for(const x of C)if(x.length){d.moveTo(x[0].x,x[0].y);for(let P=1;P<x.length;P++){const E=x[P];d.lineTo(E.x,E.y)}}d.fill(),d.closePath()}renderWaveform(n,h,d){if(d.fillStyle=this.convertColorValues(h.waveColor),h.renderFunction)return void h.renderFunction(n,d);const f=(function({channelData:g,barHeight:w,normalize:C}){var x;const P=w||1;if(!C)return P;const E=g[0];if(!E||E.length===0)return P;let D=0;for(let W=0;W<E.length;W++){const N=(x=E[W])!==null&&x!==void 0?x:0,q=Math.abs(N);q>D&&(D=q)}return D?P/D:P})({channelData:n,barHeight:h.barHeight,normalize:h.normalize});ko(h)?this.renderBarWaveform(n,h,d,f):this.renderLineWaveform(n,h,d,f)}renderSingleCanvas(n,h,d,f,g,w,C){const x=this.getPixelRatio(),P=document.createElement("canvas");P.width=Math.round(d*x),P.height=Math.round(f*x),P.style.width=`${d}px`,P.style.height=`${f}px`,P.style.left=`${Math.round(g)}px`,w.appendChild(P);const E=P.getContext("2d");if(h.renderFunction?(E.fillStyle=this.convertColorValues(h.waveColor),h.renderFunction(n,E)):this.renderWaveform(n,h,E),P.width>0&&P.height>0){const D=P.cloneNode(),W=D.getContext("2d");W.drawImage(P,0,0),W.globalCompositeOperation="source-in",W.fillStyle=this.convertColorValues(h.progressColor),W.fillRect(0,0,P.width,P.height),C.appendChild(D)}}renderMultiCanvas(n,h,d,f,g,w){const C=this.getPixelRatio(),{clientWidth:x}=this.scrollContainer,P=d/C,E=(function({clientWidth:q,totalWidth:Y,options:nt}){return uo(Math.min(8e3,q,Y),nt)})({clientWidth:x,totalWidth:P,options:h});let D={};if(E===0)return;const W=q=>{if(q<0||q>=N||D[q])return;D[q]=!0;const Y=q*E;let nt=Math.min(P-Y,E);if(nt=uo(nt,h),nt<=0)return;const Et=(function({channelData:mt,offset:bt,clampedWidth:yt,totalWidth:ht}){return mt.map((Q=>{const ut=Math.floor(bt/ht*Q.length),vt=Math.floor((bt+yt)/ht*Q.length);return Q.slice(ut,vt)}))})({channelData:n,offset:Y,clampedWidth:nt,totalWidth:P});this.renderSingleCanvas(Et,h,nt,f,Y,g,w)},N=Math.ceil(P/E);if(!this.isScrollable){for(let q=0;q<N;q++)W(q);return}if(fo({scrollLeft:this.scrollContainer.scrollLeft,totalWidth:P,numCanvases:N}).forEach((q=>W(q))),N>1){const q=this.on("scroll",(()=>{const{scrollLeft:Y}=this.scrollContainer;Object.keys(D).length>10&&(g.innerHTML="",w.innerHTML="",D={}),fo({scrollLeft:Y,totalWidth:P,numCanvases:N}).forEach((nt=>W(nt)))}));this.unsubscribeOnScroll.push(q)}}renderChannel(n,h,d,f){var{overlay:g}=h,w=(function(E,D){var W={};for(var N in E)Object.prototype.hasOwnProperty.call(E,N)&&D.indexOf(N)<0&&(W[N]=E[N]);if(E!=null&&typeof Object.getOwnPropertySymbols=="function"){var q=0;for(N=Object.getOwnPropertySymbols(E);q<N.length;q++)D.indexOf(N[q])<0&&Object.prototype.propertyIsEnumerable.call(E,N[q])&&(W[N[q]]=E[N[q]])}return W})(h,["overlay"]);const C=document.createElement("div"),x=this.getHeight(w.height,w.splitChannels);C.style.height=`${x}px`,g&&f>0&&(C.style.marginTop=`-${x}px`),this.canvasWrapper.style.minHeight=`${x}px`,this.canvasWrapper.appendChild(C);const P=C.cloneNode();this.progressWrapper.appendChild(P),this.renderMultiCanvas(n,w,d,x,C,P)}render(n){return It(this,void 0,void 0,(function*(){var h;this.timeouts.forEach((P=>P())),this.timeouts=[],this.canvasWrapper.innerHTML="",this.progressWrapper.innerHTML="",this.options.width!=null&&(this.scrollContainer.style.width=typeof this.options.width=="number"?`${this.options.width}px`:this.options.width);const d=this.getPixelRatio(),f=this.scrollContainer.clientWidth,{scrollWidth:g,isScrollable:w,useParentWidth:C,width:x}=(function({duration:P,minPxPerSec:E=0,parentWidth:D,fillParent:W,pixelRatio:N}){const q=Math.ceil(P*E),Y=q>D,nt=!!(W&&!Y);return{scrollWidth:q,isScrollable:Y,useParentWidth:nt,width:(nt?D:q)*N}})({duration:n.duration,minPxPerSec:this.options.minPxPerSec||0,parentWidth:f,fillParent:this.options.fillParent,pixelRatio:d});if(this.isScrollable=w,this.wrapper.style.width=C?"100%":`${g}px`,this.scrollContainer.style.overflowX=this.isScrollable?"auto":"hidden",this.scrollContainer.classList.toggle("noScrollbar",!!this.options.hideScrollbar),this.cursor.style.backgroundColor=`${this.options.cursorColor||this.options.progressColor}`,this.cursor.style.width=`${this.options.cursorWidth}px`,this.audioData=n,this.emit("render"),this.options.splitChannels)for(let P=0;P<n.numberOfChannels;P++){const E=Object.assign(Object.assign({},this.options),(h=this.options.splitChannels)===null||h===void 0?void 0:h[P]);this.renderChannel([n.getChannelData(P)],E,x,P)}else{const P=[n.getChannelData(0)];n.numberOfChannels>1&&P.push(n.getChannelData(1)),this.renderChannel(P,this.options,x,0)}Promise.resolve().then((()=>this.emit("rendered")))}))}reRender(){if(this.unsubscribeOnScroll.forEach((d=>d())),this.unsubscribeOnScroll=[],!this.audioData)return;const{scrollWidth:n}=this.scrollContainer,{right:h}=this.progressWrapper.getBoundingClientRect();if(this.render(this.audioData),this.isScrollable&&n!==this.scrollContainer.scrollWidth){const{right:d}=this.progressWrapper.getBoundingClientRect(),f=(function(g){const w=2*g;return(w<0?Math.floor(w):Math.ceil(w))/2})(d-h);this.scrollContainer.scrollLeft+=f}}zoom(n){this.options.minPxPerSec=n,this.reRender()}scrollIntoView(n,h=!1){const{scrollLeft:d,scrollWidth:f,clientWidth:g}=this.scrollContainer,w=n*f,C=d,x=d+g,P=g/2;if(this.isDragging)w+30>x?this.scrollContainer.scrollLeft+=30:w-30<C&&(this.scrollContainer.scrollLeft-=30);else{(w<C||w>x)&&(this.scrollContainer.scrollLeft=w-(this.options.autoCenter?P:0));const E=w-d-P;h&&this.options.autoCenter&&E>0&&(this.scrollContainer.scrollLeft+=E)}{const E=this.scrollContainer.scrollLeft,{startX:D,endX:W}=po({scrollLeft:E,scrollWidth:f,clientWidth:g});this.emit("scroll",D,W,E,E+g)}}renderProgress(n,h){if(isNaN(n))return;const d=100*n;this.canvasWrapper.style.clipPath=`polygon(${d}% 0%, 100% 0%, 100% 100%, ${d}% 100%)`,this.progressWrapper.style.width=`${d}%`,this.cursor.style.left=`${d}%`,this.cursor.style.transform=this.options.cursorWidth?`translateX(-${n*this.options.cursorWidth}px)`:"",this.isScrollable&&this.options.autoScroll&&this.scrollIntoView(n,h)}exportImage(n,h,d){return It(this,void 0,void 0,(function*(){const f=this.canvasWrapper.querySelectorAll("canvas");if(!f.length)throw new Error("No waveform data");if(d==="dataURL"){const g=Array.from(f).map((w=>w.toDataURL(n,h)));return Promise.resolve(g)}return Promise.all(Array.from(f).map((g=>new Promise(((w,C)=>{g.toBlob((x=>{x?w(x):C(new Error("Could not export image"))}),n,h)})))))}))}}class Hc extends Mi{constructor(){super(...arguments),this.animationFrameId=null,this.isRunning=!1}start(){if(this.isRunning)return;this.isRunning=!0;const n=()=>{this.isRunning&&(this.emit("tick"),this.animationFrameId=requestAnimationFrame(n))};n()}stop(){this.isRunning=!1,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}destroy(){this.stop()}}class nr extends Mi{constructor(n=new AudioContext){super(),this.bufferNode=null,this.playStartTime=0,this.playedDuration=0,this._muted=!1,this._playbackRate=1,this._duration=void 0,this.buffer=null,this.currentSrc="",this.paused=!0,this.crossOrigin=null,this.seeking=!1,this.autoplay=!1,this.addEventListener=this.on,this.removeEventListener=this.un,this.audioContext=n,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination)}load(){return It(this,void 0,void 0,(function*(){}))}get src(){return this.currentSrc}set src(n){if(this.currentSrc=n,this._duration=void 0,!n)return this.buffer=null,void this.emit("emptied");fetch(n).then((h=>{if(h.status>=400)throw new Error(`Failed to fetch ${n}: ${h.status} (${h.statusText})`);return h.arrayBuffer()})).then((h=>this.currentSrc!==n?null:this.audioContext.decodeAudioData(h))).then((h=>{this.currentSrc===n&&(this.buffer=h,this.emit("loadedmetadata"),this.emit("canplay"),this.autoplay&&this.play())})).catch((h=>{console.error("WebAudioPlayer load error:",h)}))}_play(){if(!this.paused)return;this.paused=!1,this.bufferNode&&(this.bufferNode.onended=null,this.bufferNode.disconnect()),this.bufferNode=this.audioContext.createBufferSource(),this.buffer&&(this.bufferNode.buffer=this.buffer),this.bufferNode.playbackRate.value=this._playbackRate,this.bufferNode.connect(this.gainNode);let n=this.playedDuration*this._playbackRate;(n>=this.duration||n<0)&&(n=0,this.playedDuration=0),this.bufferNode.start(this.audioContext.currentTime,n),this.playStartTime=this.audioContext.currentTime,this.bufferNode.onended=()=>{this.currentTime>=this.duration&&(this.pause(),this.emit("ended"))}}_pause(){var n;this.paused=!0,(n=this.bufferNode)===null||n===void 0||n.stop(),this.playedDuration+=this.audioContext.currentTime-this.playStartTime}play(){return It(this,void 0,void 0,(function*(){this.paused&&(this._play(),this.emit("play"))}))}pause(){this.paused||(this._pause(),this.emit("pause"))}stopAt(n){const h=n-this.currentTime,d=this.bufferNode;d?.stop(this.audioContext.currentTime+h),d?.addEventListener("ended",(()=>{d===this.bufferNode&&(this.bufferNode=null,this.pause())}),{once:!0})}setSinkId(n){return It(this,void 0,void 0,(function*(){return this.audioContext.setSinkId(n)}))}get playbackRate(){return this._playbackRate}set playbackRate(n){this._playbackRate=n,this.bufferNode&&(this.bufferNode.playbackRate.value=n)}get currentTime(){return(this.paused?this.playedDuration:this.playedDuration+(this.audioContext.currentTime-this.playStartTime))*this._playbackRate}set currentTime(n){const h=!this.paused;h&&this._pause(),this.playedDuration=n/this._playbackRate,h&&this._play(),this.emit("seeking"),this.emit("timeupdate")}get duration(){var n,h;return(n=this._duration)!==null&&n!==void 0?n:((h=this.buffer)===null||h===void 0?void 0:h.duration)||0}set duration(n){this._duration=n}get volume(){return this.gainNode.gain.value}set volume(n){this.gainNode.gain.value=n,this.emit("volumechange")}get muted(){return this._muted}set muted(n){this._muted!==n&&(this._muted=n,this._muted?this.gainNode.disconnect():this.gainNode.connect(this.audioContext.destination))}canPlayType(n){return/^(audio|video)\//.test(n)}getGainNode(){return this.gainNode}getChannelData(){const n=[];if(!this.buffer)return n;const h=this.buffer.numberOfChannels;for(let d=0;d<h;d++)n.push(this.buffer.getChannelData(d));return n}removeAttribute(n){switch(n){case"src":this.src="";break;case"playbackRate":this.playbackRate=0;break;case"currentTime":this.currentTime=0;break;case"duration":this.duration=0;break;case"volume":this.volume=0;break;case"muted":this.muted=!1}}}const $c={waveColor:"#999",progressColor:"#555",cursorWidth:1,minPxPerSec:0,fillParent:!0,interact:!0,dragToSeek:!1,autoScroll:!0,autoCenter:!0,sampleRate:8e3};class Ye extends jc{static create(n){return new Ye(n)}constructor(n){const h=n.media||(n.backend==="WebAudio"?new nr:void 0);super({media:h,mediaControls:n.mediaControls,autoplay:n.autoplay,playbackRate:n.audioRate}),this.plugins=[],this.decodedData=null,this.stopAtPosition=null,this.subscriptions=[],this.mediaSubscriptions=[],this.abortController=null,this.options=Object.assign({},$c,n),this.timer=new Hc;const d=h?void 0:this.getMediaElement();this.renderer=new Wc(this.options,d),this.initPlayerEvents(),this.initRendererEvents(),this.initTimerEvents(),this.initPlugins();const f=this.options.url||this.getSrc()||"";Promise.resolve().then((()=>{this.emit("init");const{peaks:g,duration:w}=this.options;(f||g&&w)&&this.load(f,g,w).catch((C=>{this.emit("error",C instanceof Error?C:new Error(String(C)))}))}))}updateProgress(n=this.getCurrentTime()){return this.renderer.renderProgress(n/this.getDuration(),this.isPlaying()),n}initTimerEvents(){this.subscriptions.push(this.timer.on("tick",(()=>{if(!this.isSeeking()){const n=this.updateProgress();this.emit("timeupdate",n),this.emit("audioprocess",n),this.stopAtPosition!=null&&this.isPlaying()&&n>=this.stopAtPosition&&this.pause()}})))}initPlayerEvents(){this.isPlaying()&&(this.emit("play"),this.timer.start()),this.mediaSubscriptions.push(this.onMediaEvent("timeupdate",(()=>{const n=this.updateProgress();this.emit("timeupdate",n)})),this.onMediaEvent("play",(()=>{this.emit("play"),this.timer.start()})),this.onMediaEvent("pause",(()=>{this.emit("pause"),this.timer.stop(),this.stopAtPosition=null})),this.onMediaEvent("emptied",(()=>{this.timer.stop(),this.stopAtPosition=null})),this.onMediaEvent("ended",(()=>{this.emit("timeupdate",this.getDuration()),this.emit("finish"),this.stopAtPosition=null})),this.onMediaEvent("seeking",(()=>{this.emit("seeking",this.getCurrentTime())})),this.onMediaEvent("error",(()=>{var n;this.emit("error",(n=this.getMediaElement().error)!==null&&n!==void 0?n:new Error("Media error")),this.stopAtPosition=null})))}initRendererEvents(){this.subscriptions.push(this.renderer.on("click",((n,h)=>{this.options.interact&&(this.seekTo(n),this.emit("interaction",n*this.getDuration()),this.emit("click",n,h))})),this.renderer.on("dblclick",((n,h)=>{this.emit("dblclick",n,h)})),this.renderer.on("scroll",((n,h,d,f)=>{const g=this.getDuration();this.emit("scroll",n*g,h*g,d,f)})),this.renderer.on("render",(()=>{this.emit("redraw")})),this.renderer.on("rendered",(()=>{this.emit("redrawcomplete")})),this.renderer.on("dragstart",(n=>{this.emit("dragstart",n)})),this.renderer.on("dragend",(n=>{this.emit("dragend",n)})),this.renderer.on("resize",(()=>{this.emit("resize")})));{let n;const h=this.renderer.on("drag",(d=>{var f;if(!this.options.interact)return;this.renderer.renderProgress(d),clearTimeout(n);let g=0;const w=this.options.dragToSeek;this.isPlaying()?g=0:w===!0?g=200:w&&typeof w=="object"&&(g=(f=w.debounceTime)!==null&&f!==void 0?f:200),n=setTimeout((()=>{this.seekTo(d)}),g),this.emit("interaction",d*this.getDuration()),this.emit("drag",d)}));this.subscriptions.push((()=>{clearTimeout(n),h()}))}}initPlugins(){var n;!((n=this.options.plugins)===null||n===void 0)&&n.length&&this.options.plugins.forEach((h=>{this.registerPlugin(h)}))}unsubscribePlayerEvents(){this.mediaSubscriptions.forEach((n=>n())),this.mediaSubscriptions=[]}setOptions(n){this.options=Object.assign({},this.options,n),n.duration&&!n.peaks&&(this.decodedData=rs.createBuffer(this.exportPeaks(),n.duration)),n.peaks&&n.duration&&(this.decodedData=rs.createBuffer(n.peaks,n.duration)),this.renderer.setOptions(this.options),n.audioRate&&this.setPlaybackRate(n.audioRate),n.mediaControls!=null&&(this.getMediaElement().controls=n.mediaControls)}registerPlugin(n){if(this.plugins.includes(n))return n;n._init(this),this.plugins.push(n);const h=n.once("destroy",(()=>{this.plugins=this.plugins.filter((d=>d!==n)),this.subscriptions=this.subscriptions.filter((d=>d!==h))}));return this.subscriptions.push(h),n}unregisterPlugin(n){this.plugins=this.plugins.filter((h=>h!==n)),n.destroy()}getWrapper(){return this.renderer.getWrapper()}getWidth(){return this.renderer.getWidth()}getScroll(){return this.renderer.getScroll()}setScroll(n){return this.renderer.setScroll(n)}setScrollTime(n){const h=n/this.getDuration();this.renderer.setScrollPercentage(h)}getActivePlugins(){return this.plugins}loadAudio(n,h,d,f){return It(this,void 0,void 0,(function*(){var g;if(this.emit("load",n),!this.options.media&&this.isPlaying()&&this.pause(),this.decodedData=null,this.stopAtPosition=null,(g=this.abortController)===null||g===void 0||g.abort(),this.abortController=null,!h&&!d){const C=this.options.fetchParams||{};window.AbortController&&!C.signal&&(this.abortController=new AbortController,C.signal=this.abortController.signal);const x=E=>this.emit("loading",E);h=yield Rc.fetchBlob(n,x,C);const P=this.options.blobMimeType;P&&(h=new Blob([h],{type:P}))}this.setSrc(n,h);const w=yield new Promise((C=>{const x=f||this.getDuration();x?C(x):this.mediaSubscriptions.push(this.onMediaEvent("loadedmetadata",(()=>C(this.getDuration())),{once:!0}))}));if(!n&&!h){const C=this.getMediaElement();C instanceof nr&&(C.duration=w)}if(d)this.decodedData=rs.createBuffer(d,w||0);else if(h){const C=yield h.arrayBuffer();this.decodedData=yield rs.decode(C,this.options.sampleRate)}this.decodedData&&(this.emit("decode",this.getDuration()),this.renderer.render(this.decodedData)),this.emit("ready",this.getDuration())}))}load(n,h,d){return It(this,void 0,void 0,(function*(){try{return yield this.loadAudio(n,void 0,h,d)}catch(f){throw this.emit("error",f),f}}))}loadBlob(n,h,d){return It(this,void 0,void 0,(function*(){try{return yield this.loadAudio("",n,h,d)}catch(f){throw this.emit("error",f),f}}))}zoom(n){if(!this.decodedData)throw new Error("No audio loaded");this.renderer.zoom(n),this.emit("zoom",n)}getDecodedData(){return this.decodedData}exportPeaks({channels:n=2,maxLength:h=8e3,precision:d=1e4}={}){if(!this.decodedData)throw new Error("The audio has not been decoded yet");const f=Math.min(n,this.decodedData.numberOfChannels),g=[];for(let w=0;w<f;w++){const C=this.decodedData.getChannelData(w),x=[],P=C.length/h;for(let E=0;E<h;E++){const D=C.slice(Math.floor(E*P),Math.ceil((E+1)*P));let W=0;for(let N=0;N<D.length;N++){const q=D[N];Math.abs(q)>Math.abs(W)&&(W=q)}x.push(Math.round(W*d)/d)}g.push(x)}return g}getDuration(){let n=super.getDuration()||0;return n!==0&&n!==1/0||!this.decodedData||(n=this.decodedData.duration),n}toggleInteraction(n){this.options.interact=n}setTime(n){this.stopAtPosition=null,super.setTime(n),this.updateProgress(n),this.emit("timeupdate",n)}seekTo(n){const h=this.getDuration()*n;this.setTime(h)}play(n,h){const d=Object.create(null,{play:{get:()=>super.play}});return It(this,void 0,void 0,(function*(){n!=null&&this.setTime(n);const f=yield d.play.call(this);return h!=null&&(this.media instanceof nr?this.media.stopAt(h):this.stopAtPosition=h),f}))}playPause(){return It(this,void 0,void 0,(function*(){return this.isPlaying()?this.pause():this.play()}))}stop(){this.pause(),this.setTime(0)}skip(n){this.setTime(this.getCurrentTime()+n)}empty(){this.load("",[[0]],.001)}setMediaElement(n){this.unsubscribePlayerEvents(),super.setMediaElement(n),this.initPlayerEvents()}exportImage(){return It(this,arguments,void 0,(function*(n="image/png",h=1,d="dataURL"){return this.renderer.exportImage(n,h,d)}))}destroy(){var n;this.emit("destroy"),(n=this.abortController)===null||n===void 0||n.abort(),this.plugins.forEach((h=>h.destroy())),this.subscriptions.forEach((h=>h())),this.unsubscribePlayerEvents(),this.timer.destroy(),this.renderer.destroy(),super.destroy()}}Ye.BasePlugin=class extends Mi{constructor(r){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=r}onInit(){}_init(r){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=r,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((r=>r())),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}},Ye.dom=Lc;var or={},go;function zc(){return go||(go=1,(function(r){class n{constructor(){this.browserShadowBlurConstant=1,this.DPI=96,this.devicePixelRatio=1,this.perfLimitSizeTotal=2097152,this.maxCacheSideLimit=4096,this.minCacheSideLimit=256,this.disableStyleCopyPaste=!1,this.enableGLFiltering=!0,this.textureSize=4096,this.forceGLPutImageData=!1,this.cachesBoundsOfCurve=!0,this.fontPaths={},this.NUM_FRACTION_DIGITS=4}}class h extends n{constructor(t){super(),this.configure(t)}configure(t={}){Object.assign(this,t)}addFonts(t={}){this.fontPaths=Object.assign(Object.assign({},this.fontPaths),t)}removeFonts(t=[]){t.forEach(e=>{delete this.fontPaths[e]})}clearFonts(){this.fontPaths={}}restoreDefaults(t){const e=new n,i=t?.reduce((s,o)=>(s[o]=e[o],s),{})||e;this.configure(i)}}const d=new h;let f,g,w,C,x,P;function E(){if(typeof document<"u"&&typeof window<"u")document instanceof(typeof HTMLDocument<"u"?HTMLDocument:Document)?f=document:f=document.implementation.createHTMLDocument(""),g=window,C=!1;else{const a=ir,t=new a.JSDOM(decodeURIComponent("%3C!DOCTYPE%20html%3E%3Chtml%3E%3Chead%3E%3C%2Fhead%3E%3Cbody%3E%3C%2Fbody%3E%3C%2Fhtml%3E"),{features:{FetchExternalResources:["img"]},resources:"usable"}).window;f=t.document,P=ir.implForWrapper,x=ir.Canvas,C=!0,g=t,sc.DOMParser=g.DOMParser}w="ontouchstart"in g||"ontouchstart"in f||g&&g.navigator&&g.navigator.maxTouchPoints>0,d.configure({devicePixelRatio:g.devicePixelRatio||1})}E();const D=()=>({document:f,window:g,isTouchSupported:w,isLikelyNode:C,nodeCanvas:x,jsdomImplForWrapper:P}),W=()=>f,N=()=>g,q=a=>{f=a.document,g=a},Y=()=>D().document.createElement("canvas"),nt=()=>D().document.createElement("img"),Et=a=>{var t;const e=Y();return e.width=a.width,e.height=a.height,(t=e.getContext("2d"))===null||t===void 0||t.drawImage(a,0,0),e},mt=(a,t,e)=>a.toDataURL(`image/${t}`,e),bt=a=>!!a&&a.getContext!==void 0,yt=a=>a.webgl!==void 0;var ht;(function(a){a.low="lowp",a.medium="mediump",a.high="highp"})(ht||(ht={}));class Q{testPrecision(t,e){const i=`precision ${e} float;
void main(){}`,s=t.createShader(t.FRAGMENT_SHADER);return s?(t.shaderSource(s,i),t.compileShader(s),!!t.getShaderParameter(s,t.COMPILE_STATUS)):!1}queryWebGL(){if(D().isLikelyNode)return;const e=Y().getContext("webgl");e&&(this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.webGLPrecision=Object.values(ht).find(i=>this.testPrecision(e,i)),console.log(`fabric: max texture size ${this.maxTextureSize}`))}isSupported(t){return this.maxTextureSize&&this.maxTextureSize>=t}}const ut=new Q,vt=`precision ${ht.high} float`;class wt{constructor(t={}){this.setOptions(t)}setOptions(t){Object.assign(this,t)}createProgram(t,e=this.getFragmentSource(),i=this.vertexSource){ut.webGLPrecision&&ut.webGLPrecision!==ht.high&&(e=e.replace(new RegExp(vt,"g"),vt.replace(ht.high,ut.webGLPrecision)));const s=t.createShader(t.VERTEX_SHADER),o=t.createShader(t.FRAGMENT_SHADER),l=t.createProgram();if(!s||!o||!l)throw new Error("Vertex, fragment shader or program creation error");if(t.shaderSource(s,i),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))throw new Error(`Vertex shader compile error for ${this.type}: ${t.getShaderInfoLog(s)}`);if(t.shaderSource(o,e),t.compileShader(o),!t.getShaderParameter(o,t.COMPILE_STATUS))throw new Error(`Fragment shader compile error for ${this.type}: ${t.getShaderInfoLog(o)}`);if(t.attachShader(l,s),t.attachShader(l,o),t.linkProgram(l),!t.getProgramParameter(l,t.LINK_STATUS))throw new Error('Shader link error for "${this.type}" '+t.getProgramInfoLog(l));const c=this.getUniformLocations(t,l)||{};return c.uStepW=t.getUniformLocation(l,"uStepW"),c.uStepH=t.getUniformLocation(l,"uStepH"),{program:l,attributeLocations:this.getAttributeLocations(t,l),uniformLocations:c}}getAttributeLocations(t,e){return{aPosition:t.getAttribLocation(e,"aPosition")}}sendAttributeData(t,e,i){const s=e.aPosition,o=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,o),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0),t.bufferData(t.ARRAY_BUFFER,i,t.STATIC_DRAW)}_setupFrameBuffer(t){const e=t.context;if(t.passes>1){const i=t.destinationWidth,s=t.destinationHeight;(t.sourceWidth!==i||t.sourceHeight!==s)&&(e.deleteTexture(t.targetTexture),t.targetTexture=t.filterBackend.createTexture(e,i,s)),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t.targetTexture,0)}else e.bindFramebuffer(e.FRAMEBUFFER,null),e.finish()}_swapTextures(t){t.passes--,t.pass++;const e=t.targetTexture;t.targetTexture=t.sourceTexture,t.sourceTexture=e}isNeutralState(t){const e=this.mainParameter,i=this.__proto__;return e?Array.isArray(i[e])&&Array.isArray(this[e])?i[e].every((s,o)=>s===this[e][o]):i[e]===this[e]:!1}applyTo(t){yt(t)?(this._setupFrameBuffer(t),this.applyToWebGL(t),this._swapTextures(t)):this.applyTo2d(t)}getCacheKey(){return this.type}retrieveShader(t){const e=this.getCacheKey();return t.programCache[e]||(t.programCache[e]=this.createProgram(t.context)),t.programCache[e]}applyToWebGL(t){const e=t.context,i=this.retrieveShader(t);t.pass===0&&t.originalTexture?e.bindTexture(e.TEXTURE_2D,t.originalTexture):e.bindTexture(e.TEXTURE_2D,t.sourceTexture),e.useProgram(i.program),this.sendAttributeData(e,i.attributeLocations,t.aPosition),e.uniform1f(i.uniformLocations.uStepW,1/t.sourceWidth),e.uniform1f(i.uniformLocations.uStepH,1/t.sourceHeight),this.sendUniformData(e,i.uniformLocations),e.viewport(0,0,t.destinationWidth,t.destinationHeight),e.drawArrays(e.TRIANGLE_STRIP,0,4)}bindAdditionalTexture(t,e,i){t.activeTexture(i),t.bindTexture(t.TEXTURE_2D,e),t.activeTexture(t.TEXTURE0)}unbindAdditionalTexture(t,e){t.activeTexture(e),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE0)}getMainParameter(){return this.mainParameter?this[this.mainParameter]:void 0}setMainParameter(t){this.mainParameter&&(this[this.mainParameter]=t)}createHelpLayer(t){if(!t.helpLayer){const e=Y();e.width=t.sourceWidth,e.height=t.sourceHeight,t.helpLayer=e}}toObject(){const t=this.mainParameter;return Object.assign({type:this.type},t?{[t]:this[t]}:{})}toJSON(){return this.toObject()}}class at extends wt{getFragmentSource(){return this.fragmentSource}}Object.assign(wt.prototype,{vertexSource:`
    attribute vec2 aPosition;
    varying vec2 vTexCoord;
    void main() {
      vTexCoord = aPosition;
      gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
    }`}),Object.assign(at.prototype,{fragmentSource:`
    ${vt};
    varying vec2 vTexCoord;
    uniform sampler2D uTexture;
    void main() {
      gl_FragColor = texture2D(uTexture, vTexCoord);
    }`});const $t={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"},Xt=/^rgba?\(\s*(\d{1,3}(?:\.\d+)?%?)\s*,\s*(\d{1,3}(?:\.\d+)?%?)\s*,\s*(\d{1,3}(?:\.\d+)?%?)\s*(?:\s*,\s*((?:\d*\.?\d+)?)\s*)?\)$/i,ie=/^hsla?\(\s*(\d{1,3})\s*,\s*(\d{1,3}%)\s*,\s*(\d{1,3}%)\s*(?:\s*,\s*(\d+(?:\.\d+)?)\s*)?\)$/i,Me=/^#?([0-9a-f]{8}|[0-9a-f]{6}|[0-9a-f]{4}|[0-9a-f]{3})$/i;function ae(a,t,e){return e<0&&(e+=1),e>1&&(e-=1),e<1/6?a+(t-a)*6*e:e<1/2?t:e<2/3?a+(t-a)*(2/3-e)*6:a}function z(a){const t=a.toString(16).toUpperCase();return t.length===1?`0${t}`:t}class J{constructor(t){if(!t)this.setSource([0,0,0,1]);else if(t instanceof J)this.setSource([...t._source]);else if(Array.isArray(t)){const[e,i,s,o=1]=t;this.setSource([e,i,s,o])}else this.setSource(this._tryParsingColor(t))}_tryParsingColor(t){return t in $t&&(t=$t[t]),t==="transparent"?[255,255,255,0]:J.sourceFromHex(t)||J.sourceFromRgb(t)||J.sourceFromHsl(t)||[0,0,0,1]}_rgbToHsl(t,e,i){t/=255,e/=255,i/=255;const s=Math.max(t,e,i),o=Math.min(t,e,i);let l,c;const u=(s+o)/2;if(s===o)l=c=0;else{const p=s-o;switch(c=u>.5?p/(2-s-o):p/(s+o),s){case t:l=(e-i)/p+(e<i?6:0);break;case e:l=(i-t)/p+2;break;case i:l=(t-e)/p+4;break}l/=6}return[Math.round(l*360),Math.round(c*100),Math.round(u*100)]}getSource(){return this._source}setSource(t){this._source=t}toRgb(){const t=this.getSource();return`rgb(${t[0]},${t[1]},${t[2]})`}toRgba(){const t=this.getSource();return`rgba(${t[0]},${t[1]},${t[2]},${t[3]})`}toHsl(){const t=this.getSource(),e=this._rgbToHsl(t[0],t[1],t[2]);return`hsl(${e[0]},${e[1]}%,${e[2]}%)`}toHsla(){const t=this.getSource(),e=this._rgbToHsl(t[0],t[1],t[2]);return`hsla(${e[0]},${e[1]}%,${e[2]}%,${t[3]})`}toHex(){const[t,e,i]=this.getSource();return`${z(t)}${z(e)}${z(i)}`}toHexa(){const t=this.getSource();return`${this.toHex()}${z(Math.round(t[3]*255))}`}getAlpha(){return this.getSource()[3]}setAlpha(t){const e=this.getSource();return e[3]=t,this.setSource(e),this}toGrayscale(){const t=this.getSource(),e=parseInt((t[0]*.3+t[1]*.59+t[2]*.11).toFixed(0),10),i=t[3];return this.setSource([e,e,e,i]),this}toBlackWhite(t){const e=this.getSource(),i=e[3];let s=Math.round(e[0]*.3+e[1]*.59+e[2]*.11);return s=s<(t||127)?0:255,this.setSource([s,s,s,i]),this}overlayWith(t){t instanceof J||(t=new J(t));const[e,i,s,o]=this.getSource(),l=.5,c=t.getSource(),[u,p,m]=[e,i,s].map((v,y)=>Math.round(v*(1-l)+c[y]*l));return this.setSource([u,p,m,o]),this}static fromRgb(t){return J.fromRgba(t)}static fromRgba(t){return new J(J.sourceFromRgb(t))}static sourceFromRgb(t){const e=t.match(Xt);if(e){const i=parseInt(e[1],10)/(/%$/.test(e[1])?100:1)*(/%$/.test(e[1])?255:1),s=parseInt(e[2],10)/(/%$/.test(e[2])?100:1)*(/%$/.test(e[2])?255:1),o=parseInt(e[3],10)/(/%$/.test(e[3])?100:1)*(/%$/.test(e[3])?255:1);return[i,s,o,e[4]?parseFloat(e[4]):1]}}static fromHsl(t){return J.fromHsla(t)}static fromHsla(t){return new J(J.sourceFromHsl(t))}static sourceFromHsl(t){const e=t.match(ie);if(!e)return;const i=(parseFloat(e[1])%360+360)%360/360,s=parseFloat(e[2])/(/%$/.test(e[2])?100:1),o=parseFloat(e[3])/(/%$/.test(e[3])?100:1);let l,c,u;if(s===0)l=c=u=o;else{const p=o<=.5?o*(s+1):o+s-o*s,m=o*2-p;l=ae(m,p,i+1/3),c=ae(m,p,i),u=ae(m,p,i-1/3)}return[Math.round(l*255),Math.round(c*255),Math.round(u*255),e[4]?parseFloat(e[4]):1]}static fromHex(t){return new J(J.sourceFromHex(t))}static sourceFromHex(t){if(t.match(Me)){const e=t.slice(t.indexOf("#")+1),i=e.length===3||e.length===4,s=e.length===8||e.length===4,o=i?e.charAt(0)+e.charAt(0):e.substring(0,2),l=i?e.charAt(1)+e.charAt(1):e.substring(2,4),c=i?e.charAt(2)+e.charAt(2):e.substring(4,6),u=s?i?e.charAt(3)+e.charAt(3):e.substring(6,8):"FF";return[parseInt(o,16),parseInt(l,16),parseInt(c,16),parseFloat((parseInt(u,16)/255).toFixed(2))]}}}const se="json",hs="svg";class Fo{constructor(){this[se]=new Map,this[hs]=new Map}getClass(t){const e=this[se].get(t);if(!e)throw new Error(`No class registered for ${t}`);return e}setClass(t,e){this[se].set(e??t.prototype.type,t)}getSVGClass(t){return this[hs].get(t)}setSVGClass(t,e){this[hs].set(e??t.prototype.type,t)}}const $=new Fo;class Ue extends wt{buildSource(t){return`
      precision highp float;
      uniform sampler2D uTexture;
      uniform vec4 uColor;
      varying vec2 vTexCoord;
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        gl_FragColor = color;
        if (color.a > 0.0) {
          ${this.fragmentSource[t]}
        }
      }
      `}getCacheKey(){return`${this.type}_${this.mode}`}getFragmentSource(){return this.buildSource(this.mode)}applyTo2d({imageData:{data:t}}){const e=new J(this.color).getSource(),i=e[0]*this.alpha,s=e[1]*this.alpha,o=e[2]*this.alpha,l=1-this.alpha;for(let c=0;c<t.length;c+=4){const u=t[c],p=t[c+1],m=t[c+2];switch(this.mode){case"multiply":t[c]=u*i/255,t[c+1]=p*s/255,t[c+2]=m*o/255;break;case"screen":t[c]=255-(255-u)*(255-i)/255,t[c+1]=255-(255-p)*(255-s)/255,t[c+2]=255-(255-m)*(255-o)/255;break;case"add":t[c]=u+i,t[c+1]=p+s,t[c+2]=m+o;break;case"diff":case"difference":t[c]=Math.abs(u-i),t[c+1]=Math.abs(p-s),t[c+2]=Math.abs(m-o);break;case"subtract":t[c]=u-i,t[c+1]=p-s,t[c+2]=m-o;break;case"darken":t[c]=Math.min(u,i),t[c+1]=Math.min(p,s),t[c+2]=Math.min(m,o);break;case"lighten":t[c]=Math.max(u,i),t[c+1]=Math.max(p,s),t[c+2]=Math.max(m,o);break;case"overlay":t[c]=i<128?2*u*i/255:255-2*(255-u)*(255-i)/255,t[c+1]=s<128?2*p*s/255:255-2*(255-p)*(255-s)/255,t[c+2]=o<128?2*m*o/255:255-2*(255-m)*(255-o)/255;break;case"exclusion":t[c]=i+u-2*i*u/255,t[c+1]=s+p-2*s*p/255,t[c+2]=o+m-2*o*m/255;break;case"tint":t[c]=i+u*l,t[c+1]=s+p*l,t[c+2]=o+m*l}}}getUniformLocations(t,e){return{uColor:t.getUniformLocation(e,"uColor")}}sendUniformData(t,e){const i=new J(this.color).getSource();i[0]=this.alpha*i[0]/255,i[1]=this.alpha*i[1]/255,i[2]=this.alpha*i[2]/255,i[3]=this.alpha,t.uniform4fv(e.uColor,i)}toObject(){return{type:this.type,color:this.color,mode:this.mode,alpha:this.alpha}}static async fromObject(t){return new Ue(t)}}const Lo={type:"BlendColor",color:"#F95C63",mode:"multiply",alpha:1,fragmentSource:{multiply:`gl_FragColor.rgb *= uColor.rgb;
`,screen:`gl_FragColor.rgb = 1.0 - (1.0 - gl_FragColor.rgb) * (1.0 - uColor.rgb);
`,add:`gl_FragColor.rgb += uColor.rgb;
`,diff:`gl_FragColor.rgb = abs(gl_FragColor.rgb - uColor.rgb);
`,subtract:`gl_FragColor.rgb -= uColor.rgb;
`,lighten:`gl_FragColor.rgb = max(gl_FragColor.rgb, uColor.rgb);
`,darken:`gl_FragColor.rgb = min(gl_FragColor.rgb, uColor.rgb);
`,exclusion:`gl_FragColor.rgb += uColor.rgb - 2.0 * (uColor.rgb * gl_FragColor.rgb);
`,overlay:`
      if (uColor.r < 0.5) {
        gl_FragColor.r *= 2.0 * uColor.r;
      } else {
        gl_FragColor.r = 1.0 - 2.0 * (1.0 - gl_FragColor.r) * (1.0 - uColor.r);
      }
      if (uColor.g < 0.5) {
        gl_FragColor.g *= 2.0 * uColor.g;
      } else {
        gl_FragColor.g = 1.0 - 2.0 * (1.0 - gl_FragColor.g) * (1.0 - uColor.g);
      }
      if (uColor.b < 0.5) {
        gl_FragColor.b *= 2.0 * uColor.b;
      } else {
        gl_FragColor.b = 1.0 - 2.0 * (1.0 - gl_FragColor.b) * (1.0 - uColor.b);
      }
      `,tint:`
      gl_FragColor.rgb *= (1.0 - uColor.a);
      gl_FragColor.rgb += uColor.rgb;
      `}};Object.assign(Ue.prototype,Lo),$.setClass(Ue);function pt(a,t){var e={};for(var i in a)Object.prototype.hasOwnProperty.call(a,i)&&t.indexOf(i)<0&&(e[i]=a[i]);if(a!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,i=Object.getOwnPropertySymbols(a);s<i.length;s++)t.indexOf(i[s])<0&&Object.prototype.propertyIsEnumerable.call(a,i[s])&&(e[i[s]]=a[i[s]]);return e}class fr{constructor(){this.resources={}}applyFilters(t,e,i,s,o){const l=o.getContext("2d");if(!l)return;l.drawImage(e,0,0,i,s);const c=l.getImageData(0,0,i,s),u=l.getImageData(0,0,i,s),p={sourceWidth:i,sourceHeight:s,imageData:c,originalEl:e,originalImageData:u,canvasEl:o,ctx:l,filterBackend:this};t.forEach(v=>{v.applyTo(p)});const{imageData:m}=p;return(m.width!==i||m.height!==s)&&(o.width=m.width,o.height=m.height),l.putImageData(m,0,0),p}}class pr{constructor({tileSize:t=d.textureSize}={}){this.aPosition=new Float32Array([0,0,0,1,1,0,1,1]),this.resources={},this.tileSize=t,this.setupGLContext(t,t),this.captureGPUInfo()}setupGLContext(t,e){this.dispose(),this.createWebGLCanvas(t,e),this.chooseFastestCopyGLTo2DMethod(t,e)}chooseFastestCopyGLTo2DMethod(t,e){const i=Y(),s=new ArrayBuffer(t*e*4);if(d.forceGLPutImageData){this.imageBuffer=s,this.copyGLTo2D=cs;return}const o={imageBuffer:s},l={destinationWidth:t,destinationHeight:e,targetCanvas:i};let c;i.width=t,i.height=e,c=D().window.performance.now(),this.copyGLTo2D.call(o,this.gl,l);const u=D().window.performance.now()-c;c=D().window.performance.now(),cs.call(o,this.gl,l);const p=D().window.performance.now()-c;u>p&&(this.imageBuffer=s,this.copyGLTo2D=cs)}createWebGLCanvas(t,e){const i=Y();i.width=t,i.height=e;const s={alpha:!0,premultipliedAlpha:!1,depth:!1,stencil:!1,antialias:!1},o=i.getContext("webgl",s);o&&(o.clearColor(0,0,0,0),this.canvas=i,this.gl=o)}applyFilters(t,e,i,s,o,l){const c=this.gl,u=o.getContext("2d");if(!c||!u)return;let p;l&&(p=this.getCachedTexture(l,e));const m={originalWidth:e.width||e.originalWidth||0,originalHeight:e.height||e.originalHeight||0,sourceWidth:i,sourceHeight:s,destinationWidth:i,destinationHeight:s,context:c,sourceTexture:this.createTexture(c,i,s,p?void 0:e),targetTexture:this.createTexture(c,i,s),originalTexture:p||this.createTexture(c,i,s,p?void 0:e),passes:t.length,webgl:!0,aPosition:this.aPosition,programCache:this.programCache,pass:0,filterBackend:this,targetCanvas:o},v=c.createFramebuffer();return c.bindFramebuffer(c.FRAMEBUFFER,v),t.forEach(y=>{y&&y.applyTo(m)}),Ro(m),this.copyGLTo2D(c,m),c.bindTexture(c.TEXTURE_2D,null),c.deleteTexture(m.sourceTexture),c.deleteTexture(m.targetTexture),c.deleteFramebuffer(v),u.setTransform(1,0,0,1,0,0),m}dispose(){this.canvas&&(this.canvas=null,this.gl=null),this.clearWebGLCaches()}clearWebGLCaches(){this.programCache={},this.textureCache={}}createTexture(t,e,i,s){const o=t.createTexture();return t.bindTexture(t.TEXTURE_2D,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),s?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,s):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,i,0,t.RGBA,t.UNSIGNED_BYTE,null),o}getCachedTexture(t,e){if(this.textureCache[t])return this.textureCache[t];{const i=this.createTexture(this.gl,e.width,e.height,e);return this.textureCache[t]=i,i}}evictCachesForKey(t){this.textureCache[t]&&(this.gl.deleteTexture(this.textureCache[t]),delete this.textureCache[t])}copyGLTo2D(t,e){const i=t.canvas,s=e.targetCanvas,o=s.getContext("2d");if(!o)return;o.translate(0,s.height),o.scale(1,-1);const l=i.height-s.height;o.drawImage(i,0,l,s.width,s.height,0,0,s.width,s.height)}captureGPUInfo(){if(this.gpuInfo)return this.gpuInfo;const t=this.gl,e={renderer:"",vendor:""};if(!t)return e;const i=t.getExtension("WEBGL_debug_renderer_info");if(i){const s=t.getParameter(i.UNMASKED_RENDERER_WEBGL),o=t.getParameter(i.UNMASKED_VENDOR_WEBGL);s&&(e.renderer=s.toLowerCase()),o&&(e.vendor=o.toLowerCase())}return this.gpuInfo=e,e}}function Ro(a){const t=a.targetCanvas,e=t.width,i=t.height,s=a.destinationWidth,o=a.destinationHeight;(e!==s||i!==o)&&(t.width=s,t.height=o)}function cs(a,t){const e=t.targetCanvas,i=e.getContext("2d"),s=t.destinationWidth,o=t.destinationHeight,l=s*o*4;if(!i)return;const c=new Uint8Array(this.imageBuffer,0,l),u=new Uint8ClampedArray(this.imageBuffer,0,l);a.readPixels(0,0,s,o,a.RGBA,a.UNSIGNED_BYTE,c);const p=new ImageData(u,s,o);i.putImageData(p,0,0)}let us;function gr(){return ut.queryWebGL(),d.enableGLFiltering&&ut.isSupported(d.textureSize)?new pr({tileSize:d.textureSize}):new fr}function Ai(a=!0){return!us&&a&&(us=gr()),us}const le=["display","transform","fill","fill-opacity","fill-rule","opacity","stroke","stroke-dasharray","stroke-linecap","stroke-dashoffset","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke-width","id","paint-order","vector-effect","instantiated_by_use","clip-path"];var Fi="5.1.0";function re(){}const he=Math.PI/2,ve=Math.PI*2,ds=Math.PI/180,Bt=Object.freeze([1,0,0,1,0,0]),fs=16,mr=2,ce=1-.5522847498,it=(a,t)=>parseFloat(Number(a).toFixed(t)),jo=a=>{const t=["instantiated_by_use","style","id","class"];switch(a){case"linearGradient":return t.concat(["x1","y1","x2","y2","gradientUnits","gradientTransform"]);case"radialGradient":return t.concat(["gradientUnits","gradientTransform","cx","cy","r","fx","fy","fr"]);case"stop":return t.concat(["offset","stop-color","stop-opacity"])}return t},Wt=(a,t)=>{const e=/\D{0,2}$/.exec(a),i=parseFloat(a);t||(t=fs);const s=d.DPI;switch(e?.[0]){case"mm":return i*s/25.4;case"cm":return i*s/2.54;case"in":return i*s;case"pt":return i*s/72;case"pc":return i*s/72*12;case"em":return i*t;default:return i}},Io=a=>a&&a!=="none"?[a.slice(1,4),a.slice(5,8)]:a==="none"?[a,a]:["Mid","Mid"],ps=a=>{const[t,e]=a.trim().split(" "),[i,s]=Io(t);return{meetOrSlice:e||"meet",alignX:i,alignY:s}},Ge=a=>"matrix("+a.map(t=>it(t,d.NUM_FRACTION_DIGITS)).join(" ")+")",qe=(a,t)=>{if(t){if(t.toLive)return`${a}: url(#SVGID_${t.id}); `;{const e=new J(t),i=e.getAlpha();let s=`${a}: ${e.toRgb()}; `;return i!==1&&(s+=`${a}-opacity: ${i.toString()}; `),s}}else return`${a}: none; `},Bo=(a,{left:t,top:e,width:i,height:s},o=d.NUM_FRACTION_DIGITS)=>{const l=qe("fill",a),[c,u,p,m]=[t,e,i,s].map(v=>it(v,o));return`<rect ${l} x="${c}" y="${u}" width="${p}" height="${m}"></rect>`};function Li(a){return new RegExp("^("+a.join("|")+")\\b","i")}const Ae={},gs={},ms={},Wo={cssRules:Ae,gradientDefs:gs,clipPaths:ms},we="(?:[-+]?(?:\\d+|\\d*\\.\\d+)(?:[eE][-+]?\\d+)?)",yr="http://www.w3.org/2000/svg",Yt="(?:\\s+,?\\s*|,\\s*)",Ho=/([-+]?((\d+\.\d+)|((\d+)|(\.\d+)))(?:[eE][-+]?\d+)?)/gi,$o=new RegExp("(normal|italic)?\\s*(normal|small-caps)?\\s*(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900)?\\s*("+we+"(?:px|cm|mm|em|pt|pc|in)*)(?:\\/(normal|"+we+"))?\\s+(.*)"),zo=["path","circle","polygon","polyline","ellipse","rect","line","image","text"],Vo=["symbol","image","marker","pattern","view","svg"],No=["pattern","defs","symbol","metadata","clipPath","mask","desc"],Xo=["symbol","g","a","svg","clipPath","defs"],vr={cx:"left",x:"left",r:"radius",cy:"top",y:"top",display:"visible",visibility:"visible",transform:"transformMatrix","fill-opacity":"fillOpacity","fill-rule":"fillRule","font-family":"fontFamily","font-size":"fontSize","font-style":"fontStyle","font-weight":"fontWeight","letter-spacing":"charSpacing","paint-order":"paintFirst","stroke-dasharray":"strokeDashArray","stroke-dashoffset":"strokeDashOffset","stroke-linecap":"strokeLineCap","stroke-linejoin":"strokeLineJoin","stroke-miterlimit":"strokeMiterLimit","stroke-opacity":"strokeOpacity","stroke-width":"strokeWidth","text-decoration":"textDecoration","text-anchor":"textAnchor",opacity:"opacity","clip-path":"clipPath","clip-rule":"clipRule","vector-effect":"strokeUniform","image-rendering":"imageSmoothing"},ys={stroke:"strokeOpacity",fill:"fillOpacity"},vs="font-size",ws="clip-path",wr=Li(zo),Yo=Li(Vo),Uo=Li(No),Cr=Li(Xo),Go=new RegExp("^\\s*("+we+"+)\\s*,?\\s*("+we+"+)\\s*,?\\s*("+we+"+)\\s*,?\\s*("+we+"+)\\s*$");function br(a,t){let e=a.nodeName,i=a.getAttribute("class"),s=a.getAttribute("id"),o,l;if(o=new RegExp("^"+e,"i"),t=t.replace(o,""),s&&t.length&&(o=new RegExp("#"+s+"(?![a-zA-Z\\-]+)","i"),t=t.replace(o,"")),i&&t.length)for(i=i.split(" "),l=i.length;l--;)o=new RegExp("\\."+i[l]+"(?![a-zA-Z\\-]+)","i"),t=t.replace(o,"");return t.length===0}function qo(a,t){let e,i=!0;for(;a.parentNode&&a.parentNode.nodeType===1&&t.length;)i&&(e=t.pop()),a=a.parentNode,i=br(a,e);return t.length===0}function Ko(a,t){let e,i=!0;return e=br(a,t.pop()),e&&t.length&&(i=qo(a,t)),e&&i&&t.length===0}function Zo(a,t){const e={};for(const i in Ae[t])if(Ko(a,i.split(" ")))for(const s in Ae[t][i])e[s]=Ae[t][i][s];return e}function Jo(a){return a in vr?vr[a]:a}const Dt=a=>{if(a===0)return 1;switch(Math.abs(a)/he){case 1:case 3:return 0;case 2:return-1}return Math.cos(a)},Mt=a=>{if(a===0)return 0;const t=a/he,e=Math.sign(a);switch(t){case 1:return e;case 2:return 0;case 3:return-e}return Math.sin(a)};class T{constructor(t=0,e=0){typeof t=="object"?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e)}add(t){return new T(this.x+t.x,this.y+t.y)}addEquals(t){return this.x+=t.x,this.y+=t.y,this}scalarAdd(t){return new T(this.x+t,this.y+t)}scalarAddEquals(t){return this.x+=t,this.y+=t,this}subtract(t){return new T(this.x-t.x,this.y-t.y)}subtractEquals(t){return this.x-=t.x,this.y-=t.y,this}scalarSubtract(t){return new T(this.x-t,this.y-t)}scalarSubtractEquals(t){return this.x-=t,this.y-=t,this}multiply(t){return new T(this.x*t.x,this.y*t.y)}scalarMultiply(t){return new T(this.x*t,this.y*t)}scalarMultiplyEquals(t){return this.x*=t,this.y*=t,this}divide(t){return new T(this.x/t.x,this.y/t.y)}scalarDivide(t){return new T(this.x/t,this.y/t)}scalarDivideEquals(t){return this.x/=t,this.y/=t,this}eq(t){return this.x===t.x&&this.y===t.y}lt(t){return this.x<t.x&&this.y<t.y}lte(t){return this.x<=t.x&&this.y<=t.y}gt(t){return this.x>t.x&&this.y>t.y}gte(t){return this.x>=t.x&&this.y>=t.y}lerp(t,e=.5){return e=Math.max(Math.min(1,e),0),new T(this.x+(t.x-this.x)*e,this.y+(t.y-this.y)*e)}distanceFrom(t){const e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)}midPointFrom(t){return this.lerp(t)}min(t){return new T(Math.min(this.x,t.x),Math.min(this.y,t.y))}max(t){return new T(Math.max(this.x,t.x),Math.max(this.y,t.y))}toString(){return`${this.x},${this.y}`}setXY(t,e){return this.x=t,this.y=e,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setFromPoint(t){return this.x=t.x,this.y=t.y,this}swap(t){const e=this.x,i=this.y;this.x=t.x,this.y=t.y,t.x=e,t.y=i}clone(){return new T(this.x,this.y)}rotate(t,e=Qo){const i=Mt(t),s=Dt(t),o=this.subtract(e);return new T(o.x*s-o.y*i,o.x*i+o.y*s).add(e)}transform(t,e=!1){return new T(t[0]*this.x+t[2]*this.y+(e?0:t[4]),t[1]*this.x+t[3]*this.y+(e?0:t[5]))}}const Qo=new T(0,0),ot=a=>a*ds,Fe=a=>a/ds,ct=(a,t,e)=>new T(a).transform(t,e),kt=a=>{const t=1/(a[0]*a[3]-a[1]*a[2]),e=[t*a[3],-t*a[1],-t*a[2],t*a[0],0,0],{x:i,y:s}=ct(new T(a[4],a[5]),e,!0);return e[4]=-i,e[5]=-s,e},gt=(a,t,e)=>[a[0]*t[0]+a[2]*t[1],a[1]*t[0]+a[3]*t[1],a[0]*t[2]+a[2]*t[3],a[1]*t[2]+a[3]*t[3],e?0:a[0]*t[4]+a[2]*t[5]+a[4],e?0:a[1]*t[4]+a[3]*t[5]+a[5]],ue=a=>{const t=Math.atan2(a[1],a[0]),e=Math.pow(a[0],2)+Math.pow(a[1],2),i=Math.sqrt(e),s=(a[0]*a[3]-a[2]*a[1])/i,o=Math.atan2(a[0]*a[2]+a[1]*a[3],e);return{angle:Fe(t),scaleX:i,scaleY:s,skewX:Fe(o),skewY:0,translateX:a[4]||0,translateY:a[5]||0}},Ri=({angle:a})=>{if(!a)return Bt;const t=ot(a),e=Dt(t),i=Mt(t);return[e,i,-i,e,0,0]},Cs=({scaleX:a=1,scaleY:t=1,flipX:e=!1,flipY:i=!1,skewX:s=0,skewY:o=0})=>{let l=Bt;return(a!==1||t!==1||e||i)&&(l=[e?-a:a,0,0,i?-t:t,0,0]),s&&(l=gt(l,[1,0,Math.tan(ot(s)),1],!0)),o&&(l=gt(l,[1,Math.tan(ot(o)),0,1],!0)),l},_r=a=>{var{translateX:t=0,translateY:e=0,angle:i=0}=a,s=pt(a,["translateX","translateY","angle"]);let o=[1,0,0,1,t,e];i&&(o=gt(o,Ri({angle:i})));const l=Cs(s);return l!==Bt&&(o=gt(o,l)),o};function ta(a,t){const e=Dt(t[0]),i=Mt(t[0]);let s=0,o=0;t.length===3&&(s=t[1],o=t[2]),a[0]=e,a[1]=i,a[2]=-i,a[3]=e,a[4]=s-(e*s-i*o),a[5]=o-(i*s+e*o)}function ea(a,t){const e=t[0],i=t.length===2?t[1]:t[0];a[0]=e,a[3]=i}function xr(a,t,e){a[e]=Math.tan(ot(t[0]))}function ia(a,t){a[4]=t[0],t.length===2&&(a[5]=t[1])}const Lt=we,sa="(?:(skewX)\\s*\\(\\s*("+Lt+")\\s*\\))",ra="(?:(skewY)\\s*\\(\\s*("+Lt+")\\s*\\))",na="(?:(rotate)\\s*\\(\\s*("+Lt+")(?:"+Yt+"("+Lt+")"+Yt+"("+Lt+"))?\\s*\\))",oa="(?:(scale)\\s*\\(\\s*("+Lt+")(?:"+Yt+"("+Lt+"))?\\s*\\))",aa="(?:(translate)\\s*\\(\\s*("+Lt+")(?:"+Yt+"("+Lt+"))?\\s*\\))",la="(?:(matrix)\\s*\\(\\s*("+Lt+")"+Yt+"("+Lt+")"+Yt+"("+Lt+")"+Yt+"("+Lt+")"+Yt+"("+Lt+")"+Yt+"("+Lt+")\\s*\\))",ji="(?:"+la+"|"+aa+"|"+oa+"|"+na+"|"+sa+"|"+ra+")",ha="(?:"+ji+"(?:"+Yt+"*"+ji+")*)",ca="^\\s*(?:"+ha+"?)\\s*$",ua=new RegExp(ca),da=new RegExp(ji,"g");function Ii(a){let t=Bt.concat(),e=[];if(!a||a&&!ua.test(a))return t;a.replace(da,function(s){const o=new RegExp(ji).exec(s).filter(function(u){return!!u}),l=o[1],c=o.slice(2).map(parseFloat);switch(l){case"translate":ia(t,c);break;case"rotate":c[0]=ot(c[0]),ta(t,c);break;case"scale":ea(t,c);break;case"skewX":xr(t,c,2);break;case"skewY":xr(t,c,1);break;case"matrix":t=c;break}e.push(t.concat()),t=Bt.concat()});let i=e[0];for(;e.length>1;)e.shift(),i=gt(i,e[0]);return i}function fa(a,t,e,i){let s=Array.isArray(t),o;if((a==="fill"||a==="stroke")&&t==="none")t="";else{if(a==="strokeUniform")return t==="non-scaling-stroke";if(a==="strokeDashArray")t==="none"?t=null:t=t.replace(/,/g," ").split(/\s+/).map(parseFloat);else if(a==="transformMatrix")e&&e.transformMatrix?t=gt(e.transformMatrix,Ii(t)):t=Ii(t);else if(a==="visible")t=t!=="none"&&t!=="hidden",e&&e.visible===!1&&(t=!1);else if(a==="opacity")t=parseFloat(t),e&&typeof e.opacity<"u"&&(t*=e.opacity);else if(a==="textAnchor")t=t==="start"?"left":t==="end"?"right":"center";else if(a==="charSpacing")o=Wt(t,i)/i*1e3;else if(a==="paintFirst"){const l=t.indexOf("fill"),c=t.indexOf("stroke");var t="fill";(l>-1&&c>-1&&c<l||l===-1&&c>-1)&&(t="stroke")}else{if(a==="href"||a==="xlink:href"||a==="font")return t;if(a==="imageSmoothing")return t==="optimizeQuality";o=s?t.map(Wt):Wt(t,i)}}return!s&&isNaN(o)?t:o}function Pr(a,t){const e=a.match($o);if(!e)return;const i=e[1],s=e[3],o=e[4],l=e[5],c=e[6];i&&(t.fontStyle=i),s&&(t.fontWeight=isNaN(parseFloat(s))?s:parseFloat(s)),o&&(t.fontSize=Wt(o)),c&&(t.fontFamily=c),l&&(t.lineHeight=l==="normal"?1:l)}function pa(a,t){let e,i;for(const s in a)typeof a[s]>"u"||(e=s.toLowerCase(),i=a[s],t[e]=i)}function ga(a,t){let e,i;a.replace(/;\s*$/,"").split(";").forEach(function(s){const o=s.split(":");e=o[0].trim().toLowerCase(),i=o[1].trim(),t[e]=i})}function Sr(a){const t={},e=a.getAttribute("style");return e&&(typeof e=="string"?ga(e,t):pa(e,t)),t}let ma=0;const ne=()=>ma++;class Tr{getSvgStyles(t){const e=this.fillRule?this.fillRule:"nonzero",i=this.strokeWidth?this.strokeWidth:"0",s=this.strokeDashArray?this.strokeDashArray.join(" "):"none",o=this.strokeDashOffset?this.strokeDashOffset:"0",l=this.strokeLineCap?this.strokeLineCap:"butt",c=this.strokeLineJoin?this.strokeLineJoin:"miter",u=this.strokeMiterLimit?this.strokeMiterLimit:"4",p=typeof this.opacity<"u"?this.opacity:"1",m=this.visible?"":" visibility: hidden;",v=t?"":this.getSvgFilter(),y=qe("fill",this.fill);return[qe("stroke",this.stroke),"stroke-width: ",i,"; ","stroke-dasharray: ",s,"; ","stroke-linecap: ",l,"; ","stroke-dashoffset: ",o,"; ","stroke-linejoin: ",c,"; ","stroke-miterlimit: ",u,"; ",y,"fill-rule: ",e,"; ","opacity: ",p,";",v,m].join("")}getSvgSpanStyles(t,e){const s=t.fontFamily?`font-family: ${t.fontFamily.indexOf("'")===-1&&t.fontFamily.indexOf('"')===-1?`'${t.fontFamily}'`:t.fontFamily}; `:"",o=t.strokeWidth?`stroke-width: ${t.strokeWidth}; `:"",l=t.fontSize?`font-size: ${t.fontSize}px; `:"",c=t.fontStyle?`font-style: ${t.fontStyle}; `:"",u=t.fontWeight?`font-weight: ${t.fontWeight}; `:"",p=t.fill?qe("fill",t.fill):"",m=t.stroke?qe("stroke",t.stroke):"",v=this.getSvgTextDecoration(t),y=t.deltaY?`baseline-shift: ${-t.deltaY}; `:"";return[m,o,s,l,c,u,v&&`text-decoration: ${v}; `,p,y,e?"white-space: pre; ":""].join("")}getSvgTextDecoration(t){return["overline","underline","line-through"].filter(e=>t[e.replace("-","")]).join(" ")}getSvgFilter(){return this.shadow?`filter: url(#SVGID_${this.shadow.id});`:""}getSvgCommons(){return[this.id?`id="${this.id}" `:"",this.clipPath?`clip-path="url(#${this.clipPath.clipPathId})" `:""].join("")}getSvgTransform(t,e=""){const i=t?this.calcTransformMatrix():this.calcOwnMatrix();return`${`transform="${Ge(i)}`}${e}" `}toSVG(t){return this._createBaseSVGMarkup(this._toSVG(t),{reviver:t})}toClipPathSVG(t){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(t),{reviver:t})}_createBaseClipPathSVGMarkup(t,{reviver:e,additionalTransform:i=""}={}){const s=[this.getSvgTransform(!0,i),this.getSvgCommons()].join(""),o=t.indexOf("COMMON_PARTS");return t[o]=s,e?e(t.join("")):t.join("")}_createBaseSVGMarkup(t,{noStyle:e,reviver:i,withShadow:s,additionalTransform:o}={}){const l=e?"":`style="${this.getSvgStyles()}" `,c=s?`style="${this.getSvgFilter()}" `:"",u=this.clipPath,p=this.strokeUniform?'vector-effect="non-scaling-stroke" ':"",m=u&&u.absolutePositioned,v=this.stroke,y=this.fill,b=this.shadow,_=[],S=t.indexOf("COMMON_PARTS");let k;u&&(u.clipPathId=`CLIPPATH_${ne()}`,k=`<clipPath id="${u.clipPathId}" >
${u.toClipPathSVG(i)}</clipPath>
`),m&&_.push("<g ",c,this.getSvgCommons(),` >
`),_.push("<g ",this.getSvgTransform(!1),m?"":c+this.getSvgCommons(),` >
`);const A=[l,p,e?"":this.addPaintOrder()," ",o?`transform="${o}" `:""].join("");return t[S]=A,y&&y.toLive&&_.push(y.toSVG(this)),v&&v.toLive&&_.push(v.toSVG(this)),b&&_.push(b.toSVG(this)),u&&_.push(k),_.push(t.join("")),_.push(`</g>
`),m&&_.push(`</g>
`),i?i(_.join("")):_.join("")}addPaintOrder(){return this.paintFirst!=="fill"?` paint-order="${this.paintFirst}" `:""}}class ya{constructor(){this.charWidthsCache={},this.boundsOfCurveCache={}}getFontCache({fontFamily:t,fontStyle:e,fontWeight:i}){t=t.toLowerCase(),this.charWidthsCache[t]||(this.charWidthsCache[t]={});const s=this.charWidthsCache[t],o=`${e.toLowerCase()}_${(i+"").toLowerCase()}`;return s[o]||(s[o]={}),s[o]}clearFontCache(t){t=(t||"").toLowerCase(),t?this.charWidthsCache[t]&&delete this.charWidthsCache[t]:this.charWidthsCache={}}limitDimsByArea(t){const{perfLimitSizeTotal:e}=d,i=Math.sqrt(e*t);return[Math.floor(i),Math.floor(e/i)]}}const Le=new ya,va=D().window.requestAnimationFrame||function(a){return D().window.setTimeout(a,1e3/60)},wa=D().window.cancelAnimationFrame||D().window.clearTimeout;function Ke(a){return va.call(D().window,a)}function kr(a){return wa.call(D().window,a)}class Ca extends Array{remove(t){const e=this.indexOf(t);e>-1&&this.splice(e,1)}cancelAll(){const t=this.splice(0);return t.forEach(e=>e.abort()),t}cancelByCanvas(t){if(!t)return[];const e=this.filter(i=>{var s;return typeof i.target=="object"&&((s=i.target)===null||s===void 0?void 0:s.canvas)===t});return e.forEach(i=>i.abort()),e}cancelByTarget(t){if(!t)return[];const e=this.filter(i=>i.target===t);return e.forEach(i=>i.abort()),e}}const Ze=new Ca,bs=(a,t,e,i)=>(a<Math.abs(t)?(a=t,i=e/4):t===0&&a===0?i=e/ve*Math.asin(1):i=e/ve*Math.asin(t/a),{a,c:t,p:e,s:i}),Or=(a,t,e,i,s)=>a*Math.pow(2,10*(i-=1))*Math.sin((i*s-t)*ve/e),Er=(a,t,e,i)=>-e*Math.cos(a/i*he)+e+t,ba=(a,t,e,i)=>e*(a/i)**3+t,_a=(a,t,e,i)=>e*((a/i-1)**3+1)+t,xa=(a,t,e,i)=>(a/=i/2,a<1?e/2*a**3+t:e/2*((a-2)**3+2)+t),Pa=(a,t,e,i)=>e*(a/=i)*a**3+t,Sa=(a,t,e,i)=>-e*((a=a/i-1)*a**3-1)+t,Ta=(a,t,e,i)=>(a/=i/2,a<1?e/2*a**4+t:-e/2*((a-=2)*a**3-2)+t),ka=(a,t,e,i)=>e*(a/i)**5+t,Oa=(a,t,e,i)=>e*((a/i-1)**5+1)+t,Ea=(a,t,e,i)=>(a/=i/2,a<1?e/2*a**5+t:e/2*((a-2)**5+2)+t),Da=(a,t,e,i)=>-e*Math.cos(a/i*he)+e+t,Ma=(a,t,e,i)=>e*Math.sin(a/i*he)+t,Aa=(a,t,e,i)=>-e/2*(Math.cos(Math.PI*a/i)-1)+t,Fa=(a,t,e,i)=>a===0?t:e*2**(10*(a/i-1))+t,La=(a,t,e,i)=>a===i?t+e:e*-(2**(-10*a/i)+1)+t,Ra=(a,t,e,i)=>a===0?t:a===i?t+e:(a/=i/2,a<1?e/2*2**(10*(a-1))+t:e/2*-(2**(-10*--a)+2)+t),ja=(a,t,e,i)=>-e*(Math.sqrt(1-(a/=i)*a)-1)+t,Ia=(a,t,e,i)=>e*Math.sqrt(1-(a=a/i-1)*a)+t,Ba=(a,t,e,i)=>(a/=i/2,a<1?-e/2*(Math.sqrt(1-a**2)-1)+t:e/2*(Math.sqrt(1-(a-=2)*a)+1)+t),Wa=(a,t,e,i)=>{const o=e;let l=0;if(a===0)return t;if(a/=i,a===1)return t+e;l||(l=i*.3);const{a:c,s:u,p}=bs(o,e,l,1.70158);return-Or(c,u,p,a,i)+t},Ha=(a,t,e,i)=>{const o=e;let l=0;if(a===0)return t;if(a/=i,a===1)return t+e;l||(l=i*.3);const{a:c,s:u,p,c:m}=bs(o,e,l,1.70158);return c*2**(-10*a)*Math.sin((a*i-u)*ve/p)+m+t},$a=(a,t,e,i)=>{const o=e;let l=0;if(a===0)return t;if(a/=i/2,a===2)return t+e;l||(l=i*(.3*1.5));const{a:c,s:u,p,c:m}=bs(o,e,l,1.70158);return a<1?-.5*Or(c,u,p,a,i)+t:c*Math.pow(2,-10*(a-=1))*Math.sin((a*i-u)*ve/p)*.5+m+t},za=(a,t,e,i,s=1.70158)=>e*(a/=i)*a*((s+1)*a-s)+t,Va=(a,t,e,i,s=1.70158)=>e*((a=a/i-1)*a*((s+1)*a+s)+1)+t,Na=(a,t,e,i,s=1.70158)=>(a/=i/2,a<1?e/2*(a*a*(((s*=1.525)+1)*a-s))+t:e/2*((a-=2)*a*(((s*=1.525)+1)*a+s)+2)+t),_s=(a,t,e,i)=>(a/=i)<1/2.75?e*(7.5625*a*a)+t:a<2/2.75?e*(7.5625*(a-=1.5/2.75)*a+.75)+t:a<2.5/2.75?e*(7.5625*(a-=2.25/2.75)*a+.9375)+t:e*(7.5625*(a-=2.625/2.75)*a+.984375)+t,Dr=(a,t,e,i)=>e-_s(i-a,0,e,i)+t;var Xa=Object.freeze({__proto__:null,defaultEasing:Er,easeInCubic:ba,easeOutCubic:_a,easeInOutCubic:xa,easeInQuart:Pa,easeOutQuart:Sa,easeInOutQuart:Ta,easeInQuint:ka,easeOutQuint:Oa,easeInOutQuint:Ea,easeInSine:Da,easeOutSine:Ma,easeInOutSine:Aa,easeInExpo:Fa,easeOutExpo:La,easeInOutExpo:Ra,easeInCirc:ja,easeOutCirc:Ia,easeInOutCirc:Ba,easeInElastic:Wa,easeOutElastic:Ha,easeInOutElastic:$a,easeInBack:za,easeOutBack:Va,easeInOutBack:Na,easeOutBounce:_s,easeInBounce:Dr,easeInOutBounce:(a,t,e,i)=>a<i/2?Dr(a*2,0,e,i)*.5+t:_s(a*2-i,0,e,i)*.5+e*.5+t,easeInQuad:(a,t,e,i)=>e*(a/=i)*a+t,easeOutQuad:(a,t,e,i)=>-e*(a/=i)*(a-2)+t,easeInOutQuad:(a,t,e,i)=>(a/=i/2,a<1?e/2*a**2+t:-e/2*(--a*(a-2)-1)+t)});const Ya=()=>!1;class xs{constructor({startValue:t,byValue:e,duration:i=500,delay:s=0,easing:o=Er,onStart:l=re,onChange:c=re,onComplete:u=re,abort:p=Ya,target:m}){this._state="pending",this.durationRatio=0,this.valueRatio=0,this.tick=this.tick.bind(this),this.duration=i,this.delay=s,this.easing=o,this._onStart=l,this._onChange=c,this._onComplete=u,this._abort=p,this.target=m,this.startValue=t,this.byValue=e,this.value=this.startValue,this.endValue=this.calculate(this.duration).value}get state(){return this._state}start(){const t=e=>{this._state==="pending"&&(this.startTime=e||+new Date,this._state="running",this._onStart(),this.tick(this.startTime))};this.register(),this.delay>0?setTimeout(()=>Ke(t),this.delay):Ke(t)}tick(t){const e=(t||+new Date)-this.startTime,i=Math.min(e,this.duration);this.durationRatio=i/this.duration;const{value:s,changeRatio:o}=this.calculate(i);if(this.value=Array.isArray(s)?s.slice():s,this.valueRatio=o,this._state!=="aborted")if(this._abort(s,this.valueRatio,this.durationRatio))this._state="aborted",this.unregister();else if(e>=this.duration){const l=this.endValue;this.durationRatio=this.valueRatio=1,this._onChange(Array.isArray(l)?l.slice():l,this.valueRatio,this.durationRatio),this._state="completed",this._onComplete(l,this.valueRatio,this.durationRatio),this.unregister()}else this._onChange(s,this.valueRatio,this.durationRatio),Ke(this.tick)}register(){Ze.push(this)}unregister(){Ze.remove(this)}abort(){this._state="aborted",this.unregister()}}class Ua extends xs{constructor(t){var{startValue:e=0,endValue:i=100,byValue:s=i-e}=t,o=pt(t,["startValue","endValue","byValue"]);super(Object.assign(Object.assign({},o),{startValue:e,byValue:s}))}calculate(t){const e=this.easing(t,this.startValue,this.byValue,this.duration);return{value:e,changeRatio:Math.abs((e-this.startValue)/this.byValue)}}}class Ga extends xs{constructor(t){var{startValue:e=[0],endValue:i=[100],byValue:s=i.map((l,c)=>l-e[c])}=t,o=pt(t,["startValue","endValue","byValue"]);super(Object.assign(Object.assign({},o),{startValue:e,byValue:s}))}calculate(t){const e=this.startValue.map((i,s)=>this.easing(t,i,this.byValue[s],this.duration,s));return{value:e,changeRatio:Math.abs((e[0]-this.startValue[0])/this.byValue[0])}}}const Ce=(a,t,e)=>Math.max(a,Math.min(t,e)),Ps=a=>a&&((t,e,i)=>a(new J(t).toRgba(),e,i));class qa extends xs{constructor(t){var{startValue:e,endValue:i,byValue:s,easing:o=(y,b,_,S)=>{const k=1-Math.cos(y/S*(Math.PI/2));return b+_*k},onChange:l,onComplete:c,abort:u}=t,p=pt(t,["startValue","endValue","byValue","easing","onChange","onComplete","abort"]);const m=new J(e).getSource(),v=new J(i).getSource();super(Object.assign(Object.assign({},p),{startValue:m,byValue:s?new J(s).setAlpha(Array.isArray(s)&&s[3]?s[3]:0).getSource():v.map((y,b)=>y-m[b]),easing:o,onChange:Ps(l),onComplete:Ps(c),abort:Ps(u)}))}calculate(t){const[e,i,s,o]=this.startValue.map((c,u)=>this.easing(t,c,this.byValue[u],this.duration,u)),l=[e,i,s].map(Math.round);return{value:[...l,Ce(0,o,1)],changeRatio:l.map((c,u)=>this.byValue[u]!==0?Math.abs((c-this.startValue[u])/this.byValue[u]):0).find(c=>c!==0)||0}}}const Ka=a=>Array.isArray(a.startValue)||Array.isArray(a.endValue)||Array.isArray(a.byValue),Ss=a=>{const t=Ka(a)?new Ga(a):new Ua(a);return t.start(),t},Mr=a=>{const t=new qa(a);return t.start(),t},be=(a,t)=>Math.floor(Math.random()*(t-a+1))+a,Re=(a,t)=>isNaN(a)&&typeof t=="number"?t:a,_e=(a,t)=>{const e=a.indexOf(t);return e!==-1&&a.splice(e,1),a};function Ts(a){class t extends a{constructor(){super(...arguments),this._objects=[]}_onObjectAdded(i){}_onObjectRemoved(i){}_onStackOrderChanged(i){}add(...i){const s=this._objects.push(...i);return i.forEach(o=>this._onObjectAdded(o)),s}insertAt(i,...s){return this._objects.splice(i,0,...s),s.forEach(o=>this._onObjectAdded(o)),this._objects.length}remove(...i){const s=this._objects,o=[];return i.forEach(l=>{const c=s.indexOf(l);c!==-1&&(s.splice(c,1),o.push(l),this._onObjectRemoved(l))}),o}forEachObject(i){this.getObjects().forEach((s,o,l)=>i(s,o,l))}getObjects(...i){return i.length===0?[...this._objects]:this._objects.filter(s=>i.includes(s.type))}item(i){return this._objects[i]}isEmpty(){return this._objects.length===0}size(){return this._objects.length}contains(i,s){return this._objects.includes(i)?!0:s?this._objects.some(o=>o instanceof t&&o.contains(i,!0)):!1}complexity(){return this._objects.reduce((i,s)=>(i+=s.complexity?s.complexity():0,i),0)}sendObjectToBack(i){return!i||i===this._objects[0]?!1:(_e(this._objects,i),this._objects.unshift(i),this._onStackOrderChanged(i),!0)}bringObjectToFront(i){return!i||i===this._objects[this._objects.length-1]?!1:(_e(this._objects,i),this._objects.push(i),this._onStackOrderChanged(i),!0)}sendObjectBackwards(i,s){if(!i)return!1;const o=this._objects.indexOf(i);if(o!==0){const l=this.findNewLowerIndex(i,o,s);return _e(this._objects,i),this._objects.splice(l,0,i),this._onStackOrderChanged(i),!0}return!1}bringObjectForward(i,s){if(!i)return!1;const o=this._objects.indexOf(i);if(o!==this._objects.length-1){const l=this.findNewUpperIndex(i,o,s);return _e(this._objects,i),this._objects.splice(l,0,i),this._onStackOrderChanged(i),!0}return!1}moveObjectTo(i,s){return i===this._objects[s]?!1:(_e(this._objects,i),this._objects.splice(s,0,i),this._onStackOrderChanged(i),!0)}findNewLowerIndex(i,s,o){let l;if(o){l=s;for(let c=s-1;c>=0;--c)if(i.isOverlapping(this._objects[c])){l=c;break}}else l=s-1;return l}findNewUpperIndex(i,s,o){let l;if(o){l=s;for(let c=s+1;c<this._objects.length;++c)if(i.isOverlapping(this._objects[c])){l=c;break}}else l=s+1;return l}}return t}class Ar{constructor(){this.__eventListeners={}}on(t,e){if(this.__eventListeners||(this.__eventListeners={}),typeof t=="object"){for(const i in t)this.on(i,t[i]);return()=>this.off(t)}else if(e){const i=t;return this.__eventListeners[i]||(this.__eventListeners[i]=[]),this.__eventListeners[i].push(e),()=>this.off(i,e)}else return()=>!1}once(t,e){if(typeof t=="object"){const i=[];for(const s in t)i.push(this.once(s,t[s]));return()=>i.forEach(s=>s())}else if(e){const i=this.on(t,(...s)=>{e(...s),i()});return i}else return()=>!1}_removeEventListener(t,e){if(this.__eventListeners[t])if(e){const i=this.__eventListeners[t],s=i.indexOf(e);s>-1&&i.splice(s,1)}else this.__eventListeners[t]=[]}off(t,e){if(this.__eventListeners)if(typeof t>"u")for(const i in this.__eventListeners)this._removeEventListener(i);else if(typeof t=="object")for(const i in t)this._removeEventListener(i,t[i]);else this._removeEventListener(t,e)}fire(t,e){var i;if(!this.__eventListeners)return;const s=(i=this.__eventListeners[t])===null||i===void 0?void 0:i.concat();if(s)for(let o=0;o<s.length;o++)s[o].call(this,e||{})}}class Fr extends Ar{_setOptions(t){for(const e in t)this.set(e,t[e])}_setObject(t){for(const e in t)this._set(e,t[e])}set(t,e){return typeof t=="object"?this._setObject(t):this._set(t,e),this}_set(t,e){this[t]=e}toggle(t){const e=this.get(t);return typeof e=="boolean"&&this.set(t,!e),this}get(t){return this[t]}}function Lr(a,t){return a.parentNode&&a.parentNode.replaceChild(t,a),t.appendChild(a),t}function Rr(a){let t=0,e=0;const i=D().document.documentElement,s=D().document.body||{scrollLeft:0,scrollTop:0};for(;a&&(a.parentNode||a.host)&&(a=a.parentNode||a.host,a===D().document?(t=s.scrollLeft||i.scrollLeft||0,e=s.scrollTop||i.scrollTop||0):(t+=a.scrollLeft||0,e+=a.scrollTop||0),!(a.nodeType===1&&a.style.position==="fixed")););return{left:t,top:e}}function jr(a){let t={left:0,top:0};const e=a&&a.ownerDocument,i={left:0,top:0},s={borderLeftWidth:"left",borderTopWidth:"top",paddingLeft:"left",paddingTop:"top"};if(!e)return i;const o=D().document.defaultView.getComputedStyle(a,null);for(const u in s)i[s[u]]+=parseInt(o[u],10)||0;const l=e.documentElement;typeof a.getBoundingClientRect<"u"&&(t=a.getBoundingClientRect());const c=Rr(a);return{left:t.left+c.left-(l.clientLeft||0)+i.left,top:t.top+c.top-(l.clientTop||0)+i.top}}function ks(a){return typeof a.onselectstart<"u"&&(a.onselectstart=()=>!1),a.style.userSelect="none",a}function Za(a){return typeof a.onselectstart<"u"&&(a.onselectstart=null),a.style.userSelect="",a}function Os(a){const t=D().jsdomImplForWrapper(a);return t._canvas||t._image}function Je(a){if(!D().isLikelyNode)return;const t=D().jsdomImplForWrapper(a);t&&(t._image=null,t._canvas=null,t._currentSrc=null,t._attributes=null,t._classList=null)}const Qe=(a,{signal:t,crossOrigin:e=null}={})=>new Promise(function(i,s){if(t&&t.aborted)return s(new Error("`options.signal` is in `aborted` state"));const o=nt();let l;t&&(l=function(u){o.src="",s(u)},t.addEventListener("abort",l,{once:!0}));const c=function(){o.onload=o.onerror=null,l&&t?.removeEventListener("abort",l),i(o)};if(!a){c();return}o.onload=c,o.onerror=function(){l&&t?.removeEventListener("abort",l),s(new Error("Error loading "+o.src))},e&&(o.crossOrigin=e),o.src=a}),je=(a,{signal:t,reviver:e=re}={})=>new Promise((i,s)=>{const o=[];t&&t.addEventListener("abort",s,{once:!0}),Promise.all(a.map(l=>$.getClass(l.type).fromObject(l,{signal:t,reviver:e}).then(c=>(e(l,c),o.push(c),c)))).then(i).catch(l=>{o.forEach(function(c){c.dispose&&c.dispose()}),s(l)}).finally(()=>{t&&t.removeEventListener("abort",s)})}),ti=(a,{signal:t}={})=>new Promise((e,i)=>{const s=[];t&&t.addEventListener("abort",i,{once:!0});const o=Object.values(a).map(c=>c&&(c.colorStops?new($.getClass("gradient"))(c):c.type?je([c],{signal:t}).then(([u])=>(s.push(u),u)):c.source?$.getClass("pattern").fromObject(c,{signal:t}).then(u=>(s.push(u),u)):c)),l=Object.keys(a);Promise.all(o).then(c=>c.reduce((u,p,m)=>(u[l[m]]=p,u),{})).then(e).catch(c=>{s.forEach(u=>{u.dispose&&u.dispose()}),i(c)}).finally(()=>{t&&t.removeEventListener("abort",i)})}),Ie=(a,t=[])=>t.reduce((e,i)=>(i in a&&(e[i]=a[i]),e),{}),ei=a=>!!a&&a.toLive!==void 0,Bi=a=>!!a&&Array.isArray(a._objects),Wi=a=>!!a&&a.type==="activeSelection",Ir=a=>!!a&&a.type.includes("text"),Br=a=>!!a&&["i-text","textbox"].includes(a.type),Ja=a=>a.shouldCache()&&!!a._cacheCanvas,Qa=a=>!!a&&typeof a.onDragStart=="function",Wr="Could not initialize `canvas` element";class de extends Ts(Fr){constructor(t,e={}){super(),this._init(t,e)}add(...t){const e=super.add(...t);return t.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),e}insertAt(t,...e){const i=super.insertAt(t,...e);return e.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),i}remove(...t){const e=super.remove(...t);return e.length>0&&this.renderOnAddRemove&&this.requestRenderAll(),e}_onObjectAdded(t){this.stateful&&t.saveState(),t.canvas&&t.canvas!==this&&(console.warn(`fabric.Canvas: trying to add an object that belongs to a different canvas.
Resulting to default behavior: removing object from previous canvas and adding to new canvas`),t.canvas.remove(t)),t._set("canvas",this),t.setCoords(),this.fire("object:added",{target:t}),t.fire("added",{target:this})}_onObjectRemoved(t){t._set("canvas",void 0),this.fire("object:removed",{target:t}),t.fire("removed",{target:this})}_onStackOrderChanged(){this.renderOnAddRemove&&this.requestRenderAll()}_init(t,e={}){this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(t,e),this._isRetinaScaling()&&this._initRetinaScaling(),this.calcViewportBoundaries()}_initStatic(t,e={}){this._objects=[],this._createLowerCanvas(t),this._originalCanvasStyle=this.lowerCanvasEl.style.cssText,this._initOptions(e),this.calcOffset()}_isRetinaScaling(){return d.devicePixelRatio>1&&this.enableRetinaScaling}getRetinaScaling(){return this._isRetinaScaling()?Math.max(1,d.devicePixelRatio):1}_initRetinaScaling(){this.__initRetinaScaling(this.lowerCanvasEl,this.contextContainer)}__initRetinaScaling(t,e){const i=d.devicePixelRatio;t.setAttribute("width",(this.width*i).toString()),t.setAttribute("height",(this.height*i).toString()),e.scale(i,i)}calcOffset(){return this._offset=jr(this.lowerCanvasEl)}_createCanvasElement(){const t=Y();if(!t)throw new Error(Wr);if(typeof t.getContext>"u")throw new Error(Wr);return t}_initOptions(t={}){const e=this.lowerCanvasEl;this.set(t),this.width=this.width||e.width||0,this.height=this.height||e.height||0,this.viewportTransform=[...this.viewportTransform],this.lowerCanvasEl.style&&(e.width=this.width,e.height=this.height,e.style.width=this.width+"px",e.style.height=this.height+"px")}_createLowerCanvas(t){if(bt(t)?this.lowerCanvasEl=t:this.lowerCanvasEl=D().document.getElementById(t)||t||this._createCanvasElement(),this.lowerCanvasEl.hasAttribute("data-fabric"))throw new Error("fabric.js: trying to initialize a canvas that has already been initialized");this.lowerCanvasEl.classList.add("lower-canvas"),this.lowerCanvasEl.setAttribute("data-fabric","main"),this.contextContainer=this.lowerCanvasEl.getContext("2d")}getWidth(){return this.width}getHeight(){return this.height}setWidth(t,e){return this.setDimensions({width:t},e)}setHeight(t,e){return this.setDimensions({height:t},e)}setDimensions(t,{cssOnly:e=!1,backstoreOnly:i=!1}={}){Object.entries(t).forEach(([s,o])=>{let l=`${o}`;e||(this._setBackstoreDimension(s,o),l+="px",this.hasLostContext=!0),i||this._setCssDimension(s,l)}),this._isRetinaScaling()&&this._initRetinaScaling(),this.calcOffset(),e||this.requestRenderAll()}_setBackstoreDimension(t,e){this.lowerCanvasEl[t]=e,this[t]=e}_setCssDimension(t,e){this.lowerCanvasEl.style[t]=e}getZoom(){return this.viewportTransform[0]}setViewportTransform(t){const e=this._activeObject,i=this.backgroundImage,s=this.overlayImage,o=this._objects.length;this.viewportTransform=t;for(let l=0;l<o;l++){const c=this._objects[l];c.group||c.setCoords()}e&&e.setCoords(),i&&i.setCoords(),s&&s.setCoords(),this.calcViewportBoundaries(),this.renderOnAddRemove&&this.requestRenderAll()}zoomToPoint(t,e){const i=t,s=[...this.viewportTransform],o=ct(t,kt(s));s[0]=e,s[3]=e;const l=ct(o,s);s[4]+=i.x-l.x,s[5]+=i.y-l.y,this.setViewportTransform(s)}setZoom(t){this.zoomToPoint(new T(0,0),t)}absolutePan(t){const e=[...this.viewportTransform];return e[4]=-t.x,e[5]=-t.y,this.setViewportTransform(e)}relativePan(t){return this.absolutePan(new T(-t.x-this.viewportTransform[4],-t.y-this.viewportTransform[5]))}getElement(){return this.lowerCanvasEl}clearContext(t){t.clearRect(0,0,this.width,this.height)}getContext(){return this.contextContainer}clear(){this.remove(...this.getObjects()),this.backgroundImage=null,this.overlayImage=null,this.backgroundColor="",this.overlayColor="",this.clearContext(this.contextContainer),this.fire("canvas:cleared"),this.renderOnAddRemove&&this.requestRenderAll()}renderAll(){this.cancelRequestedRender(),!this.destroyed&&this.renderCanvas(this.contextContainer,this._objects)}renderAndReset(){this.nextRenderHandle=0,this.renderAll()}requestRenderAll(){!this.nextRenderHandle&&!this.disposed&&!this.destroyed&&(this.nextRenderHandle=Ke(this.renderAndResetBound))}calcViewportBoundaries(){const t=this.width,e=this.height,i=kt(this.viewportTransform),s=ct({x:0,y:0},i),o=ct({x:t,y:e},i),l=s.min(o),c=s.max(o);return this.vptCoords={tl:l,tr:new T(c.x,l.y),bl:new T(l.x,c.y),br:c}}cancelRequestedRender(){this.nextRenderHandle&&(kr(this.nextRenderHandle),this.nextRenderHandle=0)}renderCanvas(t,e){if(this.destroyed)return;const i=this.viewportTransform,s=this.clipPath;this.calcViewportBoundaries(),this.clearContext(t),t.imageSmoothingEnabled=this.imageSmoothingEnabled,t.patternQuality="best",this.fire("before:render",{ctx:t}),this._renderBackground(t),t.save(),t.transform(i[0],i[1],i[2],i[3],i[4],i[5]),this._renderObjects(t,e),t.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(t),s&&(s._set("canvas",this),s.shouldCache(),s._transformDone=!0,s.renderCache({forClipping:!0}),this.drawClipPathOnCanvas(t,s)),this._renderOverlay(t),this.controlsAboveOverlay&&this.interactive&&this.drawControls(t),this.fire("after:render",{ctx:t}),this.__cleanupTask&&(this.__cleanupTask(),this.__cleanupTask=void 0)}drawClipPathOnCanvas(t,e){const i=this.viewportTransform;t.save(),t.transform(...i),t.globalCompositeOperation="destination-in",e.transform(t),t.scale(1/e.zoomX,1/e.zoomY),t.drawImage(e._cacheCanvas,-e.cacheTranslationX,-e.cacheTranslationY),t.restore()}_renderObjects(t,e){for(let i=0,s=e.length;i<s;++i)e[i]&&e[i].render(t)}_renderBackgroundOrOverlay(t,e){const i=this[`${e}Color`],s=this[`${e}Image`],o=this.viewportTransform,l=this[`${e}Vpt`];if(!i&&!s)return;const c=ei(i);if(i){if(t.save(),t.beginPath(),t.moveTo(0,0),t.lineTo(this.width,0),t.lineTo(this.width,this.height),t.lineTo(0,this.height),t.closePath(),t.fillStyle=c?i.toLive(t):i,l&&t.transform(...o),c){t.transform(1,0,0,1,i.offsetX||0,i.offsetY||0);const u=i.gradientTransform||i.patternTransform;u&&t.transform(...u)}t.fill(),t.restore()}s&&(t.save(),l&&t.transform(...o),s.render(t),t.restore())}_renderBackground(t){this._renderBackgroundOrOverlay(t,"background")}_renderOverlay(t){this._renderBackgroundOrOverlay(t,"overlay")}getCenter(){return{top:this.height/2,left:this.width/2}}getCenterPoint(){return new T(this.width/2,this.height/2)}centerObjectH(t){return this._centerObject(t,new T(this.getCenterPoint().x,t.getCenterPoint().y))}centerObjectV(t){return this._centerObject(t,new T(t.getCenterPoint().x,this.getCenterPoint().y))}centerObject(t){return this._centerObject(t,this.getCenterPoint())}viewportCenterObject(t){return this._centerObject(t,this.getVpCenter())}viewportCenterObjectH(t){return this._centerObject(t,new T(this.getVpCenter().x,t.getCenterPoint().y))}viewportCenterObjectV(t){return this._centerObject(t,new T(t.getCenterPoint().x,this.getVpCenter().y))}getVpCenter(){return ct(this.getCenterPoint(),kt(this.viewportTransform))}_centerObject(t,e){t.setXY(e,"center","center"),t.setCoords(),this.renderOnAddRemove&&this.requestRenderAll()}toDatalessJSON(t){return this.toDatalessObject(t)}toObject(t){return this._toObjectMethod("toObject",t)}toJSON(){return this.toObject()}toDatalessObject(t){return this._toObjectMethod("toDatalessObject",t)}_toObjectMethod(t,e){const i=this.clipPath,s=i&&!i.excludeFromExport?this._toObject(i,t,e):null;return Object.assign(Object.assign(Object.assign(Object.assign({version:Fi},Ie(this,e)),{objects:this._objects.filter(o=>!o.excludeFromExport).map(o=>this._toObject(o,t,e))}),this.__serializeBgOverlay(t,e)),s?{clipPath:s}:null)}_toObject(t,e,i){let s;this.includeDefaultValues||(s=t.includeDefaultValues,t.includeDefaultValues=!1);const o=t[e](i);return this.includeDefaultValues||(t.includeDefaultValues=!!s),o}__serializeBgOverlay(t,e){const i={},s=this.backgroundImage,o=this.overlayImage,l=this.backgroundColor,c=this.overlayColor;return ei(l)?l.excludeFromExport||(i.background=l.toObject(e)):l&&(i.background=l),ei(c)?c.excludeFromExport||(i.overlay=c.toObject(e)):c&&(i.overlay=c),s&&!s.excludeFromExport&&(i.backgroundImage=this._toObject(s,t,e)),o&&!o.excludeFromExport&&(i.overlayImage=this._toObject(o,t,e)),i}toSVG(t={},e){t.reviver=e;const i=[];return this._setSVGPreamble(i,t),this._setSVGHeader(i,t),this.clipPath&&i.push(`<g clip-path="url(#${this.clipPath.clipPathId})" >
`),this._setSVGBgOverlayColor(i,"background"),this._setSVGBgOverlayImage(i,"backgroundImage",e),this._setSVGObjects(i,e),this.clipPath&&i.push(`</g>
`),this._setSVGBgOverlayColor(i,"overlay"),this._setSVGBgOverlayImage(i,"overlayImage",e),i.push("</svg>"),i.join("")}_setSVGPreamble(t,e){e.suppressPreamble||t.push('<?xml version="1.0" encoding="',e.encoding||"UTF-8",`" standalone="no" ?>
`,'<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" ',`"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
`)}_setSVGHeader(t,e){const i=e.width||`${this.width}`,s=e.height||`${this.height}`,o=d.NUM_FRACTION_DIGITS,l=e.viewBox;let c;if(l)c=`viewBox="${l.x} ${l.y} ${l.width} ${l.height}" `;else if(this.svgViewportTransformation){const u=this.viewportTransform;c=`viewBox="${it(-u[4]/u[0],o)} ${it(-u[5]/u[3],o)} ${it(this.width/u[0],o)} ${it(this.height/u[3],o)}" `}else c=`viewBox="0 0 ${this.width} ${this.height}" `;t.push("<svg ",'xmlns="http://www.w3.org/2000/svg" ','xmlns:xlink="http://www.w3.org/1999/xlink" ','version="1.1" ','width="',i,'" ','height="',s,'" ',c,`xml:space="preserve">
`,"<desc>Created with Fabric.js ",Fi,`</desc>
`,`<defs>
`,this.createSVGFontFacesMarkup(),this.createSVGRefElementsMarkup(),this.createSVGClipPathMarkup(e),`</defs>
`)}createSVGClipPathMarkup(t){const e=this.clipPath;return e?(e.clipPathId=`CLIPPATH_${ne()}`,'<clipPath id="'+e.clipPathId+`" >
`+this.clipPath.toClipPathSVG(t.reviver)+`</clipPath>
`):""}createSVGRefElementsMarkup(){return["background","overlay"].map(t=>{const e=this[`${t}Color`];if(ei(e)){const i=this[`${t}Vpt`],s=this.viewportTransform,o={width:this.width/(i?s[0]:1),height:this.height/(i?s[3]:1)};return e.toSVG(o,{additionalTransform:i?Ge(s):""})}}).join("")}createSVGFontFacesMarkup(){const t=[],e={},i=d.fontPaths;this._objects.forEach(function o(l){t.push(l),Bi(l)&&l._objects.forEach(o)}),t.forEach(o=>{if(!Ir(o))return;let l=o.fontFamily;e[l]||!i[l]||(e[l]=!0,o.styles&&Object.values(o.styles).forEach(c=>{Object.values(c).forEach(u=>{l=u.fontFamily,!e[l]&&i[l]&&(e[l]=!0)})}))});const s=Object.keys(e).map(o=>`		@font-face {
			font-family: '${o}';
			src: url('${i[o]}');
		}
`).join("");return s?`	<style type="text/css"><![CDATA[
${s}]]></style>
`:""}_setSVGObjects(t,e){this.forEachObject(i=>{i.excludeFromExport||this._setSVGObject(t,i,e)})}_setSVGObject(t,e,i){t.push(e.toSVG(i))}_setSVGBgOverlayImage(t,e,i){const s=this[e];s&&!s.excludeFromExport&&s.toSVG&&t.push(s.toSVG(i))}_setSVGBgOverlayColor(t,e){const i=this[`${e}Color`];if(i)if(ei(i)){const s=i.repeat||"",o=this.width,l=this.height,c=this[`${e}Vpt`],u=c?Ge(kt(this.viewportTransform)):"";t.push(`<rect transform="${u} translate(${o/2},${l/2})" x="${i.offsetX-o/2}" y="${i.offsetY-l/2}" width="${s==="repeat-y"||s==="no-repeat"?i.source.width:o}" height="${s==="repeat-x"||s==="no-repeat"?i.source.height:l}" fill="url(#SVGID_${i.id})"></rect>
`)}else t.push('<rect x="0" y="0" width="100%" height="100%" ','fill="',i,'"',`></rect>
`)}loadFromJSON(t,e,{signal:i}={}){if(!t)return Promise.reject(new Error("fabric.js: `json` is undefined"));const s=typeof t=="string"?JSON.parse(t):t,{objects:o=[],backgroundImage:l,background:c,overlayImage:u,overlay:p,clipPath:m}=s,v=this.renderOnAddRemove;return this.renderOnAddRemove=!1,Promise.all([je(o,{reviver:e,signal:i}),ti({backgroundImage:l,backgroundColor:c,overlayImage:u,overlayColor:p,clipPath:m},{signal:i})]).then(([y,b])=>(this.clear(),this.add(...y),this.set(s),this.set(b),this.renderOnAddRemove=v,this))}clone(t){const e=this.toObject(t);return this.cloneWithoutData().loadFromJSON(e)}cloneWithoutData(){const t=Y();return t.width=this.width,t.height=this.height,new de(t)}toDataURL(t={}){const{format:e="png",quality:i=1,multiplier:s=1,enableRetinaScaling:o=!1}=t,l=s*(o?this.getRetinaScaling():1);return mt(this.toCanvasElement(l,t),e,i)}toCanvasElement(t=1,{width:e,height:i,left:s,top:o,filter:l}={}){const c=(e||this.width)*t,u=(i||this.height)*t,p=this.getZoom(),m=this.width,v=this.height,y=p*t,b=this.viewportTransform,_=(b[4]-(s||0))*t,S=(b[5]-(o||0))*t,k=this.interactive,A=[y,0,0,y,_,S],O=this.enableRetinaScaling,F=Y(),I=this.contextTop,B=l?this._objects.filter(l):this._objects;return F.width=c,F.height=u,this.contextTop=null,this.enableRetinaScaling=!1,this.interactive=!1,this.viewportTransform=A,this.width=c,this.height=u,this.calcViewportBoundaries(),this.renderCanvas(F.getContext("2d"),B),this.viewportTransform=b,this.width=m,this.height=v,this.calcViewportBoundaries(),this.interactive=k,this.enableRetinaScaling=O,this.contextTop=I,F}dispose(){return this.disposed=!0,new Promise((t,e)=>{const i=()=>{this.destroy(),t(!0)};i.kill=e,this.__cleanupTask&&this.__cleanupTask.kill("aborted"),this.destroyed?t(!1):this.nextRenderHandle?this.__cleanupTask=i:i()})}destroy(){this.destroyed=!0,this.cancelRequestedRender(),this.forEachObject(e=>e.dispose()),this._objects=[],this.backgroundImage&&this.backgroundImage.dispose&&this.backgroundImage.dispose(),this.backgroundImage=null,this.overlayImage&&this.overlayImage.dispose&&this.overlayImage.dispose(),this.overlayImage=null,this.contextContainer=null;const t=this.lowerCanvasEl;this.lowerCanvasEl=void 0,t.classList.remove("lower-canvas"),t.removeAttribute("data-fabric"),t.setAttribute("width",`${this.width}`),t.setAttribute("height",`${this.height}`),t.style.cssText=this._originalCanvasStyle||"",this._originalCanvasStyle=void 0,Je(t)}toString(){return`#<Canvas (${this.complexity()}): { objects: ${this._objects.length} }>`}}Object.assign(de.prototype,{backgroundColor:"",backgroundImage:null,overlayColor:"",overlayImage:null,includeDefaultValues:!0,stateful:!1,renderOnAddRemove:!0,controlsAboveOverlay:!1,allowTouchScrolling:!1,imageSmoothingEnabled:!0,viewportTransform:Bt.concat(),backgroundVpt:!0,overlayVpt:!0,enableRetinaScaling:!0,svgViewportTransformation:!0,skipOffscreen:!0,clipPath:void 0}),D().isLikelyNode&&Object.assign(de.prototype,{createPNGStream(){const a=Os(this.lowerCanvasEl);return a&&a.createPNGStream()},createJPEGStream(a){const t=Os(this.lowerCanvasEl);return t&&t.createJPEGStream(a)}});const Hi=(a,t,e)=>{const i=new T(a).subtract(t),s=new T(a).subtract(e);return Math.sign(i.x)!==Math.sign(s.x)||Math.sign(i.y)!==Math.sign(s.y)};class Ot{constructor(t){this.status=t,this.points=[]}contains(t){return this.points.some(e=>e.eq(t))}append(...t){return this.points=this.points.concat(t.filter(e=>!this.contains(e))),this}static intersectLineLine(t,e,i,s,o=!0,l=!0){let c;const u=(s.x-i.x)*(t.y-i.y)-(s.y-i.y)*(t.x-i.x),p=(e.x-t.x)*(t.y-i.y)-(e.y-t.y)*(t.x-i.x),m=(s.y-i.y)*(e.x-t.x)-(s.x-i.x)*(e.y-t.y);if(m!==0){const v=u/m,y=p/m;(o||0<=v&&v<=1)&&(l||0<=y&&y<=1)?(c=new Ot("Intersection"),c.append(new T(t.x+v*(e.x-t.x),t.y+v*(e.y-t.y)))):c=new Ot}else if(u===0||p===0){const v=o||l||Hi(t,i,s)||Hi(e,i,s)||Hi(i,t,e)||Hi(s,t,e);c=new Ot(v?"Coincident":void 0)}else c=new Ot("Parallel");return c}static intersectSegmentLine(t,e,i,s){return Ot.intersectLineLine(t,e,i,s,!1,!0)}static intersectSegmentSegment(t,e,i,s){return Ot.intersectLineLine(t,e,i,s,!1,!1)}static intersectLinePolygon(t,e,i,s=!0){const o=new Ot,l=i.length;for(let c=0,u,p,m;c<l;c++){if(u=i[c],p=i[(c+1)%l],m=Ot.intersectLineLine(t,e,u,p,s,!1),m.status==="Coincident")return m;o.append(...m.points)}return o.points.length>0&&(o.status="Intersection"),o}static intersectSegmentPolygon(t,e,i){return Ot.intersectLinePolygon(t,e,i,!1)}static intersectPolygonPolygon(t,e){const i=new Ot,s=t.length,o=[];for(let l=0;l<s;l++){const c=t[l],u=t[(l+1)%s],p=Ot.intersectSegmentPolygon(c,u,e);p.status==="Coincident"?(o.push(p),i.append(c,u)):i.append(...p.points)}return o.length>0&&o.length===t.length?new Ot("Coincident"):(i.points.length>0&&(i.status="Intersection"),i)}static intersectPolygonRectangle(t,e,i){const s=e.min(i),o=e.max(i),l=new T(o.x,s.y),c=new T(s.x,o.y);return Ot.intersectPolygonPolygon(t,[s,l,o,c])}}const Be=a=>{if(a.length===0)return{left:0,top:0,width:0,height:0};const{min:t,max:e}=a.reduce(({min:s,max:o},l)=>({min:s.min(l),max:o.max(l)}),{min:new T(a[0]),max:new T(a[0])}),i=e.subtract(t);return{left:t.x,top:t.y,width:i.x,height:i.y}},tl=(a,t)=>{const e=kt(t),i=gt(e,a.calcOwnMatrix());We(a,i)},Hr=(a,t)=>We(a,gt(t,a.calcOwnMatrix())),We=(a,t)=>{const e=ue(t),{translateX:i,translateY:s,scaleX:o,scaleY:l}=e,c=pt(e,["translateX","translateY","scaleX","scaleY"]),u=new T(i,s);a.flipX=!1,a.flipY=!1,Object.assign(a,c),a.set({scaleX:o,scaleY:l}),a.setPositionByOrigin(u,"center","center")},$r=a=>{a.scaleX=1,a.scaleY=1,a.skewX=0,a.skewY=0,a.flipX=!1,a.flipY=!1,a.rotate(0)},Es=a=>({scaleX:a.scaleX,scaleY:a.scaleY,skewX:a.skewX,skewY:a.skewY,angle:a.angle,left:a.left,flipX:a.flipX,flipY:a.flipY,top:a.top}),Ds=(a,t,e)=>{const i=a/2,s=t/2,o=Cs(e),l=[new T(-i,-s),new T(i,-s),new T(-i,s),new T(i,s)].map(u=>u.transform(o)),c=Be(l);return new T(c.width,c.height)},el={left:-.5,top:-.5,center:0,bottom:.5,right:.5},fe=a=>typeof a=="string"?el[a]:a-.5;class il extends Fr{_getTransformedDimensions(t={}){const e=Object.assign({scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,width:this.width,height:this.height,strokeWidth:this.strokeWidth},t),i=e.strokeWidth;let s=i,o=0;this.strokeUniform&&(s=0,o=i);const l=e.width+s,c=e.height+s,u=e.skewX===0&&e.skewY===0;let p;return u?p=new T(l*e.scaleX,c*e.scaleY):p=Ds(l,c,e),p.scalarAdd(o)}translateToGivenOrigin(t,e,i,s,o){let l=t.x,c=t.y;const u=fe(s)-fe(e),p=fe(o)-fe(i);if(u||p){const m=this._getTransformedDimensions();l+=u*m.x,c+=p*m.y}return new T(l,c)}translateToCenterPoint(t,e,i){const s=this.translateToGivenOrigin(t,e,i,"center","center");return this.angle?s.rotate(ot(this.angle),t):s}translateToOriginPoint(t,e,i){const s=this.translateToGivenOrigin(t,"center","center",e,i);return this.angle?s.rotate(ot(this.angle),t):s}getCenterPoint(){const t=this.getRelativeCenterPoint();return this.group?ct(t,this.group.calcTransformMatrix()):t}getRelativeCenterPoint(){return this.translateToCenterPoint(new T(this.left,this.top),this.originX,this.originY)}getPointByOrigin(t,e){return this.translateToOriginPoint(this.getRelativeCenterPoint(),t,e)}setPositionByOrigin(t,e,i){const s=this.translateToCenterPoint(t,e,i),o=this.translateToOriginPoint(s,this.originX,this.originY);this.set({left:o.x,top:o.y})}_setOriginToCenter(){this._originalOriginX=this.originX,this._originalOriginY=this.originY;const t=this.getRelativeCenterPoint();this.originX="center",this.originY="center",this.left=t.x,this.top=t.y}_resetOrigin(){if(this._originalOriginX!==void 0&&this._originalOriginY!==void 0){const t=this.translateToOriginPoint(this.getRelativeCenterPoint(),this._originalOriginX,this._originalOriginY);this.left=t.x,this.top=t.y,this.originX=this._originalOriginX,this.originY=this._originalOriginY,this._originalOriginX=void 0,this._originalOriginY=void 0}}_getLeftTopCoords(){return this.translateToOriginPoint(this.getRelativeCenterPoint(),"left","top")}}class zr extends il{getX(){return this.getXY().x}setX(t){this.setXY(this.getXY().setX(t))}getY(){return this.getXY().y}setY(t){this.setXY(this.getXY().setY(t))}getRelativeX(){return this.left}setRelativeX(t){this.left=t}getRelativeY(){return this.top}setRelativeY(t){this.top=t}getXY(){const t=this.getRelativeXY();return this.group?ct(t,this.group.calcTransformMatrix()):t}setXY(t,e,i){this.group&&(t=ct(t,kt(this.group.calcTransformMatrix()))),this.setRelativeXY(t,e,i)}getRelativeXY(){return new T(this.left,this.top)}setRelativeXY(t,e,i){this.setPositionByOrigin(t,e||this.originX,i||this.originY)}_getCoords(t=!1,e=!1){return e?t?this.calcACoords():this.calcLineCoords():(this.aCoords||(this.aCoords=this.calcACoords()),this.lineCoords||(this.lineCoords=this.calcLineCoords()),t?this.aCoords:this.lineCoords)}getCoords(t=!1,e=!1){const{tl:i,tr:s,br:o,bl:l}=this._getCoords(t,e),c=[i,s,o,l];if(this.group){const u=this.group.calcTransformMatrix();return c.map(p=>ct(p,u))}return c}intersectsWithRect(t,e,i,s){const o=this.getCoords(i,s);return Ot.intersectPolygonRectangle(o,t,e).status==="Intersection"}intersectsWithObject(t,e=!1,i=!1){const s=Ot.intersectPolygonPolygon(this.getCoords(e,i),t.getCoords(e,i));return s.status==="Intersection"||s.status==="Coincident"||t.isContainedWithinObject(this,e,i)||this.isContainedWithinObject(t,e,i)}isContainedWithinObject(t,e=!1,i=!1){const s=this.getCoords(e,i),o=e?t.aCoords:t.lineCoords,l=t._getImageLines(o);for(let c=0;c<4;c++)if(!t.containsPoint(s[c],l))return!1;return!0}isContainedWithinRect(t,e,i,s){const o=this.getBoundingRect(i,s);return o.left>=t.x&&o.left+o.width<=e.x&&o.top>=t.y&&o.top+o.height<=e.y}isOverlapping(t){return this.intersectsWithObject(t)||this.isContainedWithinObject(t)||t.isContainedWithinObject(this)}containsPoint(t,e,i=!1,s=!1){const o=this._getCoords(i,s),l=e||this._getImageLines(o),c=this._findCrossPoints(t,l);return c!==0&&c%2===1}isOnScreen(t=!1){if(!this.canvas)return!1;const{tl:e,br:i}=this.canvas.vptCoords;return this.getCoords(!0,t).some(o=>o.x<=i.x&&o.x>=e.x&&o.y<=i.y&&o.y>=e.y)||this.intersectsWithRect(e,i,!0,t)?!0:this._containsCenterOfCanvas(e,i,t)}_containsCenterOfCanvas(t,e,i){const s=t.midPointFrom(e);return this.containsPoint(s,void 0,!0,i)}isPartiallyOnScreen(t){if(!this.canvas)return!1;const{tl:e,br:i}=this.canvas.vptCoords;return this.intersectsWithRect(e,i,!0,t)?!0:this.getCoords(!0,t).every(o=>(o.x>=i.x||o.x<=e.x)&&(o.y>=i.y||o.y<=e.y))&&this._containsCenterOfCanvas(e,i,t)}_getImageLines({tl:t,tr:e,bl:i,br:s}){return{topline:{o:t,d:e},rightline:{o:e,d:s},bottomline:{o:s,d:i},leftline:{o:i,d:t}}}_findCrossPoints(t,e){let i=0;for(const s in e){let o;const l=e[s];if(!(l.o.y<t.y&&l.d.y<t.y)&&!(l.o.y>=t.y&&l.d.y>=t.y)){if(l.o.x===l.d.x&&l.o.x>=t.x)o=l.o.x;else{const u=(l.d.y-l.o.y)/(l.d.x-l.o.x),p=t.y-0*t.x,m=l.o.y-u*l.o.x;o=-(p-m)/(0-u)}if(o>=t.x&&(i+=1),i===2)break}}return i}getBoundingRect(t,e){return Be(this.getCoords(t,e))}getScaledWidth(){return this._getTransformedDimensions().x}getScaledHeight(){return this._getTransformedDimensions().y}scale(t){this._set("scaleX",t),this._set("scaleY",t),this.setCoords()}scaleToWidth(t,e){const i=this.getBoundingRect(e).width/this.getScaledWidth();return this.scale(t/this.width/i)}scaleToHeight(t,e=!1){const i=this.getBoundingRect(e).height/this.getScaledHeight();return this.scale(t/this.height/i)}getCanvasRetinaScaling(){var t;return((t=this.canvas)===null||t===void 0?void 0:t.getRetinaScaling())||1}getTotalAngle(){return this.group?ue(this.calcTransformMatrix()).angle:this.angle}calcLineCoords(){const t=this.getViewportTransform(),e=this.padding,i=ot(this.getTotalAngle()),s=Dt(i)*e,o=Mt(i)*e,l=s+o,c=s-o,{tl:u,tr:p,bl:m,br:v}=this.calcACoords(),y={tl:ct(u,t),tr:ct(p,t),bl:ct(m,t),br:ct(v,t)};return e&&(y.tl.x-=c,y.tl.y-=l,y.tr.x+=l,y.tr.y-=c,y.bl.x-=l,y.bl.y+=c,y.br.x+=c,y.br.y+=l),y}getViewportTransform(){var t;return((t=this.canvas)===null||t===void 0?void 0:t.viewportTransform)||Bt.concat()}calcACoords(){const t=Ri({angle:this.angle}),e=this.getRelativeCenterPoint(),i=[1,0,0,1,e.x,e.y],s=gt(i,t),o=this._getTransformedDimensions(),l=o.x/2,c=o.y/2;return{tl:ct({x:-l,y:-c},s),tr:ct({x:l,y:-c},s),bl:ct({x:-l,y:c},s),br:ct({x:l,y:c},s)}}setCoords(){this.aCoords=this.calcACoords(),this.lineCoords=this.group?this.aCoords:this.calcLineCoords()}transformMatrixKey(t=!1){let i="";return!t&&this.group&&(i=this.group.transformMatrixKey(t)+"_"),i+this.top+"_"+this.left+"_"+this.scaleX+"_"+this.scaleY+"_"+this.skewX+"_"+this.skewY+"_"+this.angle+"_"+this.originX+"_"+this.originY+"_"+this.width+"_"+this.height+"_"+this.strokeWidth+this.flipX+this.flipY}calcTransformMatrix(t=!1){let e=this.calcOwnMatrix();if(t||!this.group)return e;const i=this.transformMatrixKey(t),s=this.matrixCache;return s&&s.key===i?s.value:(this.group&&(e=gt(this.group.calcTransformMatrix(!1),e)),this.matrixCache={key:i,value:e},e)}calcOwnMatrix(){const t=this.transformMatrixKey(!0),e=this.ownMatrixCache;if(e&&e.key===t)return e.value;const i=this.getRelativeCenterPoint(),s={angle:this.angle,translateX:i.x,translateY:i.y,scaleX:this.scaleX,scaleY:this.scaleY,skewX:this.skewX,skewY:this.skewY,flipX:this.flipX,flipY:this.flipY},o=_r(s);return this.ownMatrixCache={key:t,value:o},o}_getNonTransformedDimensions(){return new T(this.width,this.height).scalarAdd(this.strokeWidth)}_calculateCurrentDimensions(t){return this._getTransformedDimensions(t).transform(this.getViewportTransform(),!0).scalarAdd(2*this.padding)}}class sl extends zr{isDescendantOf(t){let e=this.group||this.canvas;for(;e;){if(t===e)return!0;if(e instanceof de)return!1;e=e.group||e.canvas}return!1}getAncestors(t){const e=[];let i=this.group||(t?void 0:this.canvas);for(;i;)e.push(i),i=i.group||(t?void 0:i.canvas);return e}findCommonAncestors(t,e){if(this===t)return{fork:[],otherFork:[],common:[this,...this.getAncestors(e)]};const i=this.getAncestors(e),s=t.getAncestors(e);if(i.length===0&&s.length>0&&this===s[s.length-1])return{fork:[],otherFork:[t,...s.slice(0,s.length-1)],common:[this]};for(let o=0,l;o<i.length;o++){if(l=i[o],l===t)return{fork:[this,...i.slice(0,o)],otherFork:[],common:i.slice(o)};for(let c=0;c<s.length;c++){if(this===s[c])return{fork:[],otherFork:[t,...s.slice(0,c)],common:[this,...i]};if(l===s[c])return{fork:[this,...i.slice(0,o)],otherFork:[t,...s.slice(0,c)],common:i.slice(o)}}}return{fork:[this,...i],otherFork:[t,...s],common:[]}}hasCommonAncestors(t,e){const i=this.findCommonAncestors(t,e);return i&&!!i.common.length}isInFrontOf(t){if(this===t)return;const e=this.findCommonAncestors(t);if(!e)return;if(e.fork.includes(t))return!0;if(e.otherFork.includes(this))return!1;const i=e.common[0];if(!i)return;const s=e.fork.pop(),o=e.otherFork.pop(),l=i._objects.indexOf(s),c=i._objects.indexOf(o);return l>-1&&l>c}}class rl extends sl{animate(t,e,i){const s=typeof t=="string"?{[t]:e}:t,o=Object.keys(s),l=typeof t=="string"?i:e;return o.map((c,u)=>this._animate(c,s[c],u===o.length-1?l:Object.assign(Object.assign({},l),{onChange:void 0,onComplete:void 0})))}_animate(t,e,i={}){var s,o,l,c;const u=t.split("."),p=this.colorProperties.includes(u[u.length-1]),m=u.reduce((y,b)=>y[b],this);!p&&typeof e=="string"&&(e=e.includes("=")?m+parseFloat(e.replace("=","")):parseFloat(e));const v={target:this,startValue:(o=(s=i.startValue)!==null&&s!==void 0?s:i.from)!==null&&o!==void 0?o:m,endValue:e,byValue:(l=i.byValue)!==null&&l!==void 0?l:i.by,easing:i.easing,duration:i.duration,abort:(c=i.abort)===null||c===void 0?void 0:c.bind(this),onChange:(y,b,_)=>{u.reduce((S,k,A)=>(A===u.length-1&&(S[k]=y),S[k]),this),i.onChange&&i.onChange(y,b,_)},onComplete:(y,b,_)=>{this.setCoords(),i.onComplete&&i.onComplete(y,b,_)}};return p?Mr(v):Ss(v)}_getAngleValueForStraighten(){const t=this.angle%360;return t>0?Math.round((t-1)/90)*90:Math.round(t/90)*90}straighten(){this.rotate(this._getAngleValueForStraighten())}fxStraighten(t={}){const e=t.onComplete||re,i=t.onChange||re;return Ss({target:this,startValue:this.angle,endValue:this._getAngleValueForStraighten(),duration:this.FX_DURATION,onChange:s=>{this.rotate(s),i(s)},onComplete:()=>{this.setCoords(),e()}})}}const nl=new T(1,0),Ms=(a,t)=>a.rotate(t),ii=(a,t)=>new T(t).subtract(a),Vr=a=>a.distanceFrom(new T),$i=(a,t)=>{const e=a.x*t.x+a.y*t.y,i=a.x*t.y-a.y*t.x;return Math.atan2(i,e)},ol=a=>$i(nl,a),zi=a=>a.scalarDivide(Vr(a)),As=(a,t,e)=>{const i=ii(a,t),s=ii(a,e),o=$i(i,s);return{vector:zi(Ms(i,o/2)),angle:o}},Nr=(a,t=!0)=>zi(new T(-a.y,a.x).scalarMultiply(t?1:-1));class zt{constructor(t){const e=typeof t=="string"?zt.parseShadow(t):t;for(const i in e)this[i]=e[i];this.id=ne()}static parseShadow(t){const e=t.trim(),[i,s=0,o=0,l=0]=(zt.reOffsetsAndBlur.exec(e)||[]).map(u=>parseFloat(u)||0);return{color:(e.replace(zt.reOffsetsAndBlur,"")||"rgb(0,0,0)").trim(),offsetX:s,offsetY:o,blur:l}}toString(){return[this.offsetX,this.offsetY,this.blur,this.color].join("px ")}toSVG(t){const e=Ms(new T(this.offsetX,this.offsetY),ot(-t.angle)),i=20,s=new J(this.color);let o=40,l=40;return t.width&&t.height&&(o=it((Math.abs(e.x)+this.blur)/t.width,d.NUM_FRACTION_DIGITS)*100+i,l=it((Math.abs(e.y)+this.blur)/t.height,d.NUM_FRACTION_DIGITS)*100+i),t.flipX&&(e.x*=-1),t.flipY&&(e.y*=-1),`<filter id="SVGID_${this.id}" y="-${l}%" height="${100+2*l}%" x="-${o}%" width="${100+2*o}%" >
	<feGaussianBlur in="SourceAlpha" stdDeviation="${it(this.blur?this.blur/2:0,d.NUM_FRACTION_DIGITS)}"></feGaussianBlur>
	<feOffset dx="${it(e.x,d.NUM_FRACTION_DIGITS)}" dy="${it(e.y,d.NUM_FRACTION_DIGITS)}" result="oBlur" ></feOffset>
	<feFlood flood-color="${s.toRgb()}" flood-opacity="${s.getAlpha()}"/>
	<feComposite in2="oBlur" operator="in" />
	<feMerge>
		<feMergeNode></feMergeNode>
		<feMergeNode in="SourceGraphic"></feMergeNode>
	</feMerge>
</filter>
`}toObject(){const t={color:this.color,blur:this.blur,offsetX:this.offsetX,offsetY:this.offsetY,affectStroke:this.affectStroke,nonScaling:this.nonScaling};if(this.includeDefaultValues)return t;const e=zt.prototype,i={};for(const s in t)t[s]!==e[s]&&(i[s]=t[s]);return i}}zt.reOffsetsAndBlur=/(?:\s|^)(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(-?\d+(?:\.\d*)?(?:px)?(?:\s?|$))?(\d+(?:\.\d*)?(?:px)?)?(?:\s?|$)(?:$|\s)/;const al={color:"rgb(0,0,0)",blur:0,offsetX:0,offsetY:0,affectStroke:!1,includeDefaultValues:!0,nonScaling:!1};Object.assign(zt.prototype,al);const si=(a,t,e)=>{if(e)if(!D().isLikelyNode&&t instanceof Element)a=t;else if(Array.isArray(t)){a=[];for(let i=0,s=t.length;i<s;i++)a[i]=si({},t[i],e)}else if(t&&typeof t=="object")for(const i in t)i==="canvas"||i==="group"?a[i]=null:Object.prototype.hasOwnProperty.call(t,i)&&(a[i]=si({},t[i],e));else a=t;else for(const i in t)a[i]=t[i];return a},ri=(a,t)=>t?si({},a,t):Object.assign({},a),Xr=(a,t=!1)=>`${a.charAt(0).toUpperCase()}${t?a.slice(1):a.slice(1).toLowerCase()}`,Yr=a=>a.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),Ur=a=>{const t=[];for(let e=0,i;e<a.length;e++)(i=ll(a,e))!==!1&&t.push(i);return t},ll=(a,t)=>{const e=a.charCodeAt(t);if(isNaN(e))return"";if(e<55296||e>57343)return a.charAt(t);if(55296<=e&&e<=56319){if(a.length<=t+1)throw"High surrogate without following low surrogate";const s=a.charCodeAt(t+1);if(56320>s||s>57343)throw"High surrogate without following low surrogate";return a.charAt(t)+a.charAt(t+1)}if(t===0)throw"Low surrogate without preceding high surrogate";const i=a.charCodeAt(t-1);if(55296>i||i>56319)throw"Low surrogate without preceding high surrogate";return!1};class Fs extends rl{constructor(t){super(),this._cacheContext=null,t&&this.setOptions(t)}_createCacheCanvas(){this._cacheCanvas=Y(),this._cacheContext=this._cacheCanvas.getContext("2d"),this._updateCacheCanvas(),this.dirty=!0}_limitCacheSize(t){const e=t.width,i=t.height,s=d.maxCacheSideLimit,o=d.minCacheSideLimit;if(e<=s&&i<=s&&e*i<=d.perfLimitSizeTotal)return e<o&&(t.width=o),i<o&&(t.height=o),t;const l=e/i,[c,u]=Le.limitDimsByArea(l),p=Ce(o,c,s),m=Ce(o,u,s);return e>p&&(t.zoomX/=e/p,t.width=p,t.capped=!0),i>m&&(t.zoomY/=i/m,t.height=m,t.capped=!0),t}_getCacheCanvasDimensions(){const t=this.getTotalObjectScaling(),e=this._getTransformedDimensions({skewX:0,skewY:0}),i=e.x*t.x/this.scaleX,s=e.y*t.y/this.scaleY;return{width:i+mr,height:s+mr,zoomX:t.x,zoomY:t.y,x:i,y:s}}_updateCacheCanvas(){const t=this.canvas;if(this.noScaleCache&&t&&t._currentTransform){const O=t._currentTransform.target,F=t._currentTransform.action;if(this===O&&F.slice&&F.slice(0,5)==="scale")return!1}const e=this._cacheCanvas,i=this._cacheContext,s=this._limitCacheSize(this._getCacheCanvasDimensions()),o=d.minCacheSideLimit,l=s.width,c=s.height,u=s.zoomX,p=s.zoomY,m=l!==this.cacheWidth||c!==this.cacheHeight,v=this.zoomX!==u||this.zoomY!==p;if(!e||!i)return!1;let y,b,_=m||v,S=0,k=0,A=!1;if(m){const O=this._cacheCanvas.width,F=this._cacheCanvas.height,I=l>O||c>F,B=(l<O*.9||c<F*.9)&&O>o&&F>o;A=I||B,I&&!s.capped&&(l>o||c>o)&&(S=l*.1,k=c*.1)}return Ir(this)&&this.path&&(_=!0,A=!0,S+=this.getHeightOfLine(0)*this.zoomX,k+=this.getHeightOfLine(0)*this.zoomY),_?(A?(e.width=Math.ceil(l+S),e.height=Math.ceil(c+k)):(i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,e.width,e.height)),y=s.x/2,b=s.y/2,this.cacheTranslationX=Math.round(e.width/2-y)+y,this.cacheTranslationY=Math.round(e.height/2-b)+b,this.cacheWidth=l,this.cacheHeight=c,i.translate(this.cacheTranslationX,this.cacheTranslationY),i.scale(u,p),this.zoomX=u,this.zoomY=p,!0):!1}setOptions(t={}){this._setOptions(t)}transform(t){const e=this.group&&!this.group._transformDone||this.group&&this.canvas&&t===this.canvas.contextTop,i=this.calcTransformMatrix(!e);t.transform(i[0],i[1],i[2],i[3],i[4],i[5])}toObject(t){const e=d.NUM_FRACTION_DIGITS,i=this.clipPath&&!this.clipPath.excludeFromExport?Object.assign(Object.assign({},this.clipPath.toObject(t)),{inverted:this.clipPath.inverted,absolutePositioned:this.clipPath.absolutePositioned}):null,s=Object.assign(Object.assign(Object.assign({},Ie(this,t)),{type:this.type,version:Fi,originX:this.originX,originY:this.originY,left:it(this.left,e),top:it(this.top,e),width:it(this.width,e),height:it(this.height,e),fill:this.fill&&this.fill.toObject?this.fill.toObject():this.fill,stroke:this.stroke&&this.stroke.toObject?this.stroke.toObject():this.stroke,strokeWidth:it(this.strokeWidth,e),strokeDashArray:this.strokeDashArray?this.strokeDashArray.concat():this.strokeDashArray,strokeLineCap:this.strokeLineCap,strokeDashOffset:this.strokeDashOffset,strokeLineJoin:this.strokeLineJoin,strokeUniform:this.strokeUniform,strokeMiterLimit:it(this.strokeMiterLimit,e),scaleX:it(this.scaleX,e),scaleY:it(this.scaleY,e),angle:it(this.angle,e),flipX:this.flipX,flipY:this.flipY,opacity:it(this.opacity,e),shadow:this.shadow&&this.shadow.toObject?this.shadow.toObject():this.shadow,visible:this.visible,backgroundColor:this.backgroundColor,fillRule:this.fillRule,paintFirst:this.paintFirst,globalCompositeOperation:this.globalCompositeOperation,skewX:it(this.skewX,e),skewY:it(this.skewY,e)}),i?{clipPath:i}:null);return this.includeDefaultValues?s:this._removeDefaultValues(s)}toDatalessObject(t){return this.toObject(t)}_removeDefaultValues(t){const e=$.getClass(t.type).prototype;return Object.keys(t).forEach(function(i){i==="left"||i==="top"||i==="type"||(t[i]===e[i]&&delete t[i],Array.isArray(t[i])&&Array.isArray(e[i])&&t[i].length===0&&e[i].length===0&&delete t[i])}),t}toString(){return`#<${Xr(this.type)}>`}getObjectScaling(){if(!this.group)return new T(Math.abs(this.scaleX),Math.abs(this.scaleY));const t=ue(this.calcTransformMatrix());return new T(Math.abs(t.scaleX),Math.abs(t.scaleY))}getTotalObjectScaling(){const t=this.getObjectScaling();if(this.canvas){const e=this.canvas.getZoom(),i=this.getCanvasRetinaScaling();return t.scalarMultiply(e*i)}return t}getObjectOpacity(){let t=this.opacity;return this.group&&(t*=this.group.getObjectOpacity()),t}_constrainScale(t){return Math.abs(t)<this.minScaleLimit?t<0?-this.minScaleLimit:this.minScaleLimit:t===0?1e-4:t}_set(t,e){const i=this[t]!==e;if((t==="scaleX"||t==="scaleY")&&(e=this._constrainScale(e)),t==="scaleX"&&e<0?(this.flipX=!this.flipX,e*=-1):t==="scaleY"&&e<0?(this.flipY=!this.flipY,e*=-1):t==="shadow"&&e&&!(e instanceof zt)?e=new zt(e):t==="dirty"&&this.group&&this.group.set("dirty",e),this[t]=e,i){const s=this.group&&this.group.isOnACache();this.cacheProperties.indexOf(t)>-1?(this.dirty=!0,s&&this.group.set("dirty",!0)):s&&this.stateProperties.indexOf(t)>-1&&this.group.set("dirty",!0)}return this}isNotVisible(){return this.opacity===0||!this.width&&!this.height&&this.strokeWidth===0||!this.visible}render(t){this.isNotVisible()||this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(t.save(),this._setupCompositeOperation(t),this.drawSelectionBackground(t),this.transform(t),this._setOpacity(t),this._setShadow(t),this.shouldCache()?(this.renderCache(),this.drawCacheOnCanvas(t)):(this._removeCacheCanvas(),this.dirty=!1,this.drawObject(t),this.objectCaching&&this.statefullCache&&this.saveState({propertySet:"cacheProperties"})),t.restore())}renderCache(t){t=t||{},(!this._cacheCanvas||!this._cacheContext)&&this._createCacheCanvas(),this.isCacheDirty()&&this._cacheContext&&(this.statefullCache&&this.saveState({propertySet:"cacheProperties"}),this.drawObject(this._cacheContext,t.forClipping),this.dirty=!1)}_removeCacheCanvas(){this._cacheCanvas=void 0,this._cacheContext=null,this.cacheWidth=0,this.cacheHeight=0}hasStroke(){return this.stroke&&this.stroke!=="transparent"&&this.strokeWidth!==0}hasFill(){return this.fill&&this.fill!=="transparent"}needsItsOwnCache(){return!!(this.paintFirst==="stroke"&&this.hasFill()&&this.hasStroke()&&typeof this.shadow=="object"||this.clipPath)}shouldCache(){return this.ownCaching=this.needsItsOwnCache()||this.objectCaching&&(!this.group||!this.group.isOnACache()),this.ownCaching}willDrawShadow(){return!!this.shadow&&(this.shadow.offsetX!==0||this.shadow.offsetY!==0)}drawClipPathOnCache(t,e){if(t.save(),e.inverted?t.globalCompositeOperation="destination-out":t.globalCompositeOperation="destination-in",e.absolutePositioned){const i=kt(this.calcTransformMatrix());t.transform(i[0],i[1],i[2],i[3],i[4],i[5])}e.transform(t),t.scale(1/e.zoomX,1/e.zoomY),t.drawImage(e._cacheCanvas,-e.cacheTranslationX,-e.cacheTranslationY),t.restore()}drawObject(t,e){const i=this.fill,s=this.stroke;e?(this.fill="black",this.stroke="",this._setClippingProperties(t)):this._renderBackground(t),this._render(t),this._drawClipPath(t,this.clipPath),this.fill=i,this.stroke=s}_drawClipPath(t,e){e&&(e._set("canvas",this.canvas),e.shouldCache(),e._transformDone=!0,e.renderCache({forClipping:!0}),this.drawClipPathOnCache(t,e))}drawCacheOnCanvas(t){t.scale(1/this.zoomX,1/this.zoomY),t.drawImage(this._cacheCanvas,-this.cacheTranslationX,-this.cacheTranslationY)}isCacheDirty(t=!1){if(this.isNotVisible())return!1;if(this._cacheCanvas&&this._cacheContext&&!t&&this._updateCacheCanvas())return!0;if(this.dirty||this.clipPath&&this.clipPath.absolutePositioned||this.statefullCache&&this.hasStateChanged("cacheProperties")){if(this._cacheCanvas&&this._cacheContext&&!t){const e=this.cacheWidth/this.zoomX,i=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-e/2,-i/2,e,i)}return!0}return!1}_renderBackground(t){if(!this.backgroundColor)return;const e=this._getNonTransformedDimensions();t.fillStyle=this.backgroundColor,t.fillRect(-e.x/2,-e.y/2,e.x,e.y),this._removeShadow(t)}_setOpacity(t){this.group&&!this.group._transformDone?t.globalAlpha=this.getObjectOpacity():t.globalAlpha*=this.opacity}_setStrokeStyles(t,e){const i=e.stroke;i&&(t.lineWidth=e.strokeWidth,t.lineCap=e.strokeLineCap,t.lineDashOffset=e.strokeDashOffset,t.lineJoin=e.strokeLineJoin,t.miterLimit=e.strokeMiterLimit,i.toLive?i.gradientUnits==="percentage"||i.gradientTransform||i.patternTransform?this._applyPatternForTransformedGradient(t,i):(t.strokeStyle=i.toLive(t,this),this._applyPatternGradientTransform(t,i)):t.strokeStyle=e.stroke)}_setFillStyles(t,{fill:e}){e&&(e.toLive?(t.fillStyle=e.toLive(t,this),this._applyPatternGradientTransform(t,e)):t.fillStyle=e)}_setClippingProperties(t){t.globalAlpha=1,t.strokeStyle="transparent",t.fillStyle="#000000"}_setLineDash(t,e){!e||e.length===0||(1&e.length&&e.push(...e),t.setLineDash(e))}_setShadow(t){if(!this.shadow)return;const e=this.shadow,i=this.canvas,s=this.getCanvasRetinaScaling(),[o,,,l]=i?.viewportTransform||Bt,c=o*s,u=l*s,p=e.nonScaling?new T(1,1):this.getObjectScaling();t.shadowColor=e.color,t.shadowBlur=e.blur*d.browserShadowBlurConstant*(c+u)*(p.x+p.y)/4,t.shadowOffsetX=e.offsetX*c*p.x,t.shadowOffsetY=e.offsetY*u*p.y}_removeShadow(t){this.shadow&&(t.shadowColor="",t.shadowBlur=t.shadowOffsetX=t.shadowOffsetY=0)}_applyPatternGradientTransform(t,e){if(!e||!e.toLive)return{offsetX:0,offsetY:0};const i=e.gradientTransform||e.patternTransform,s=-this.width/2+e.offsetX||0,o=-this.height/2+e.offsetY||0;return e.gradientUnits==="percentage"?t.transform(this.width,0,0,this.height,s,o):t.transform(1,0,0,1,s,o),i&&t.transform(i[0],i[1],i[2],i[3],i[4],i[5]),{offsetX:s,offsetY:o}}_renderPaintInOrder(t){this.paintFirst==="stroke"?(this._renderStroke(t),this._renderFill(t)):(this._renderFill(t),this._renderStroke(t))}_render(t){}_renderFill(t){this.fill&&(t.save(),this._setFillStyles(t,this),this.fillRule==="evenodd"?t.fill("evenodd"):t.fill(),t.restore())}_renderStroke(t){if(!(!this.stroke||this.strokeWidth===0)){if(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(t),t.save(),this.strokeUniform){const e=this.getObjectScaling();t.scale(1/e.x,1/e.y)}this._setLineDash(t,this.strokeDashArray),this._setStrokeStyles(t,this),t.stroke(),t.restore()}}_applyPatternForTransformedGradient(t,e){const i=this._limitCacheSize(this._getCacheCanvasDimensions()),s=Y(),o=this.getCanvasRetinaScaling(),l=i.x/this.scaleX/o,c=i.y/this.scaleY/o;s.width=l,s.height=c;const u=s.getContext("2d");u.beginPath(),u.moveTo(0,0),u.lineTo(l,0),u.lineTo(l,c),u.lineTo(0,c),u.closePath(),u.translate(l/2,c/2),u.scale(i.zoomX/this.scaleX/o,i.zoomY/this.scaleY/o),this._applyPatternGradientTransform(u,e),u.fillStyle=e.toLive(t),u.fill(),t.translate(-this.width/2-this.strokeWidth/2,-this.height/2-this.strokeWidth/2),t.scale(o*this.scaleX/i.zoomX,o*this.scaleY/i.zoomY),t.strokeStyle=u.createPattern(s,"no-repeat")}_findCenterFromElement(){return{x:this.left+this.width/2,y:this.top+this.height/2}}_assignTransformMatrixProps(){if(this.transformMatrix){const t=ue(this.transformMatrix);this.flipX=!1,this.flipY=!1,this.set("scaleX",t.scaleX),this.set("scaleY",t.scaleY),this.angle=t.angle,this.skewX=t.skewX,this.skewY=0}}_removeTransformMatrix(t){let e=this._findCenterFromElement();this.transformMatrix&&(this._assignTransformMatrixProps(),e=ct(e,this.transformMatrix)),this.transformMatrix=null,t&&(this.scaleX*=t.scaleX,this.scaleY*=t.scaleY,this.cropX=t.cropX,this.cropY=t.cropY,e.x+=t.offsetLeft,e.y+=t.offsetTop,this.width=t.width,this.height=t.height),this.setPositionByOrigin(e,"center","center")}clone(t){const e=this.toObject(t);return this.constructor.fromObject(e)}cloneAsImage(t){const e=this.toCanvasElement(t);return new Kt(e)}toCanvasElement(t={}){const e=Es(this),i=this.group,s=this.shadow,o=Math.abs,l=t.enableRetinaScaling?Math.max(d.devicePixelRatio,1):1,c=(t.multiplier||1)*l;delete this.group,t.withoutTransform&&$r(this),t.withoutShadow&&(this.shadow=null);const u=Y(),p=this.getBoundingRect(!0,!0),m=this.shadow,v=new T;if(m){const A=m.blur,O=m.nonScaling?new T(1,1):this.getObjectScaling();v.x=2*Math.round(o(m.offsetX)+A)*o(O.x),v.y=2*Math.round(o(m.offsetY)+A)*o(O.y)}const y=p.width+v.x,b=p.height+v.y;u.width=Math.ceil(y),u.height=Math.ceil(b);let _=new de(u,{enableRetinaScaling:!1,renderOnAddRemove:!1,skipOffscreen:!1});t.format==="jpeg"&&(_.backgroundColor="#fff"),this.setPositionByOrigin(new T(_.width/2,_.height/2),"center","center");const S=this.canvas;_._objects=[this],this.set("canvas",_),this.setCoords();const k=_.toCanvasElement(c||1,t);return this.set("canvas",S),this.shadow=s,i&&(this.group=i),this.set(e),this.setCoords(),_._objects=[],_.destroy(),_=null,k}toDataURL(t={}){return mt(this.toCanvasElement(t),t.format||"png",t.quality||1)}isType(...t){return t.includes(this.type)}complexity(){return 1}toJSON(){return this.toObject()}rotate(t){const e=(this.originX!=="center"||this.originY!=="center")&&this.centeredRotation;e&&this._setOriginToCenter(),this.set("angle",t),e&&this._resetOrigin()}centerH(){return this.canvas&&this.canvas.centerObjectH(this),this}viewportCenterH(){return this.canvas&&this.canvas.viewportCenterObjectH(this),this}centerV(){return this.canvas&&this.canvas.centerObjectV(this),this}viewportCenterV(){return this.canvas&&this.canvas.viewportCenterObjectV(this),this}center(){return this.canvas&&this.canvas.centerObject(this),this}viewportCenter(){return this.canvas&&this.canvas.viewportCenterObject(this),this}setOnGroup(){}_setupCompositeOperation(t){this.globalCompositeOperation&&(t.globalCompositeOperation=this.globalCompositeOperation)}dispose(){Ze&&Ze.cancelByTarget(this)}static _fromObject(t,e={}){var{extraParam:i}=e,s=pt(e,["extraParam"]);return ti(ri(t,!0),s).then(o=>{const l=Object.assign(Object.assign({},s),o),c=i,u=l[c],p=pt(l,[typeof c=="symbol"?c:c+""]);return i?new this(u,p):new this(p)})}static fromObject(t,e){return this._fromObject(t,e)}}const Rt={type:"object",originX:"left",originY:"top",top:0,left:0,width:0,height:0,scaleX:1,scaleY:1,flipX:!1,flipY:!1,opacity:1,angle:0,skewX:0,skewY:0,cornerSize:13,touchCornerSize:24,transparentCorners:!0,hoverCursor:null,moveCursor:null,padding:0,borderColor:"rgb(178,204,255)",borderDashArray:null,cornerColor:"rgb(178,204,255)",cornerStrokeColor:"",cornerStyle:"rect",cornerDashArray:null,centeredScaling:!1,centeredRotation:!0,fill:"rgb(0,0,0)",fillRule:"nonzero",globalCompositeOperation:"source-over",backgroundColor:"",selectionBackgroundColor:"",stroke:null,strokeWidth:1,strokeDashArray:null,strokeDashOffset:0,strokeLineCap:"butt",strokeLineJoin:"miter",strokeMiterLimit:4,shadow:null,borderOpacityWhenMoving:.4,borderScaleFactor:1,minScaleLimit:0,selectable:!0,evented:!0,visible:!0,hasControls:!0,hasBorders:!0,perPixelTargetFind:!1,includeDefaultValues:!0,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,lockSkewingX:!1,lockSkewingY:!1,lockScalingFlip:!1,excludeFromExport:!1,objectCaching:!D().isLikelyNode,statefullCache:!1,noScaleCache:!0,strokeUniform:!1,dirty:!0,__corner:0,paintFirst:"fill",activeOn:"down",stateProperties:["top","left","width","height","scaleX","scaleY","flipX","flipY","originX","originY","transformMatrix","stroke","strokeWidth","strokeDashArray","strokeLineCap","strokeDashOffset","strokeLineJoin","strokeMiterLimit","angle","opacity","fill","globalCompositeOperation","shadow","visible","backgroundColor","skewX","skewY","fillRule","paintFirst","clipPath","strokeUniform"],cacheProperties:["fill","stroke","strokeWidth","strokeDashArray","width","height","paintFirst","strokeUniform","strokeLineCap","strokeDashOffset","strokeLineJoin","strokeMiterLimit","backgroundColor","clipPath"],colorProperties:["fill","stroke","backgroundColor"],clipPath:void 0,inverted:!1,absolutePositioned:!1,FX_DURATION:500};Object.assign(Fs.prototype,Rt),$.setClass(Fs);class hl extends Fs{constructor(t){super(t),this.oCoords={}}_findTargetCorner(t,e=!1){if(!this.hasControls||!this.canvas||this.canvas._activeObject!==this)return 0;this.__corner=0;const i=Object.entries(this.oCoords);for(let s=i.length-1;s>=0;s--){const[o,l]=i[s];if(!this.isControlVisible(o))continue;const c=this._getImageLines(e?l.touchCorner:l.corner),u=this._findCrossPoints(t,c);if(u!==0&&u%2===1)return this.__corner=o,o}return 0}calcOCoords(){const t=this.getViewportTransform(),e=this.getCenterPoint(),i=[1,0,0,1,e.x,e.y],s=Ri({angle:this.getTotalAngle()-(this.group&&this.flipX?180:0)}),o=gt(i,s),l=gt(t,o),c=gt(l,[1/t[0],0,0,1/t[3],0,0]),u=this.group?ue(this.calcTransformMatrix()):void 0,p=this._calculateCurrentDimensions(u),m={};return this.forEachControl((v,y,b)=>{m[y]=v.positionHandler(p,c,b)}),m}setCoords(){this.callSuper?zr.prototype.setCoords.call(this):super.setCoords(),this.oCoords=this.calcOCoords(),this._setCornerCoords()}forEachControl(t){for(const e in this.controls)t(this.controls[e],e,this)}_setCornerCoords(){Object.entries(this.oCoords).forEach(([t,e])=>{const i=this.controls[t];e.corner=i.calcCornerCoords(this.angle,this.cornerSize,e.x,e.y,!1),e.touchCorner=i.calcCornerCoords(this.angle,this.touchCornerSize,e.x,e.y,!0)})}drawSelectionBackground(t){if(!this.selectionBackgroundColor||this.canvas&&!this.canvas.interactive||this.canvas&&this.canvas._activeObject!==this)return;t.save();const e=this.getRelativeCenterPoint(),i=this._calculateCurrentDimensions(),s=this.getViewportTransform();t.translate(e.x,e.y),t.scale(1/s[0],1/s[3]),t.rotate(ot(this.angle)),t.fillStyle=this.selectionBackgroundColor,t.fillRect(-i.x/2,-i.y/2,i.x,i.y),t.restore()}strokeBorders(t,e){t.strokeRect(-e.x/2,-e.y/2,e.x,e.y)}_drawBorders(t,e,i={}){const s=Object.assign({hasControls:this.hasControls,borderColor:this.borderColor,borderDashArray:this.borderDashArray},i);t.save(),t.strokeStyle=s.borderColor,this._setLineDash(t,s.borderDashArray),this.strokeBorders(t,e),s.hasControls&&this.drawControlsConnectingLines(t,e),t.restore()}_renderControls(t,e={}){const{hasBorders:i,hasControls:s}=this,o=Object.assign({hasBorders:i,hasControls:s},e),l=this.getViewportTransform(),c=o.hasBorders,u=o.hasControls,p=gt(l,this.calcTransformMatrix()),m=ue(p);t.save(),t.translate(m.translateX,m.translateY),t.lineWidth=1*this.borderScaleFactor,this.group||(t.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1),this.flipX&&(m.angle-=180),t.rotate(ot(this.group?m.angle:this.angle)),c&&this.drawBorders(t,m,e),u&&this.drawControls(t,e),t.restore()}drawBorders(t,e,i){let s;if(i&&i.forActiveSelection||this.group){const o=Ds(this.width,this.height,e),l=(this.strokeUniform?new T().scalarAdd(this.canvas?this.canvas.getZoom():1):new T(e.scaleX,e.scaleY)).scalarMultiply(this.strokeWidth);s=o.add(l).scalarAdd(this.borderScaleFactor)}else s=this._calculateCurrentDimensions().scalarAdd(this.borderScaleFactor);this._drawBorders(t,s,i)}drawControlsConnectingLines(t,e){let i=!1;t.beginPath(),this.forEachControl(function(s,o,l){s.withConnection&&s.getVisibility(l,o)&&(i=!0,t.moveTo(s.x*e.x,s.y*e.y),t.lineTo(s.x*e.x+s.offsetX,s.y*e.y+s.offsetY))}),i&&t.stroke()}drawControls(t,e={}){t.save();const i=this.getCanvasRetinaScaling(),{cornerStrokeColor:s,cornerDashArray:o,cornerColor:l}=this,c=Object.assign({cornerStrokeColor:s,cornerDashArray:o,cornerColor:l},e);t.setTransform(i,0,0,i,0,0),t.strokeStyle=t.fillStyle=c.cornerColor,this.transparentCorners||(t.strokeStyle=c.cornerStrokeColor),this._setLineDash(t,c.cornerDashArray),this.setCoords(),this.forEachControl(function(u,p,m){if(u.getVisibility(m,p)){const v=m.oCoords[p];u.render(t,v.x,v.y,c,m)}}),t.restore()}isControlVisible(t){return this.controls[t]&&this.controls[t].getVisibility(this,t)}setControlVisible(t,e){this._controlsVisibility||(this._controlsVisibility={}),this._controlsVisibility[t]=e}setControlsVisibility(t={}){Object.entries(t).forEach(([e,i])=>this.setControlVisible(e,i))}clearContextTop(t){if(!this.canvas)return;const e=this.canvas.contextTop;if(!e)return;const i=this.canvas.viewportTransform;e.save(),e.transform(i[0],i[1],i[2],i[3],i[4],i[5]),this.transform(e);const s=this.width+4,o=this.height+4;return e.clearRect(-s/2,-o/2,s,o),t||e.restore(),e}onDeselect(t){return!1}onSelect(t){return!1}canDrop(t){return!1}renderDragSourceEffect(t){}renderDropTargetEffect(t){}}function Gr(a,t){return t.forEach(e=>{Object.getOwnPropertyNames(e.prototype).forEach(i=>{i!=="constructor"&&Object.defineProperty(a.prototype,i,Object.getOwnPropertyDescriptor(e.prototype,i)||Object.create(null))})}),a}const qr="stateProperties";function Ls(a,t,e=!1){if(a===t)return!0;if(Array.isArray(a)){if(!Array.isArray(t)||a.length!==t.length)return!1;for(let i=0,s=a.length;i<s;i++)if(!Ls(a[i],t[i]))return!1;return!0}else if(a&&typeof a=="object"){const i=Object.keys(a);if(!t||typeof t!="object"||!e&&i.length!==Object.keys(t).length)return!1;for(let s=0,o=i.length;s<o;s++){const l=i[s];if(!(l==="canvas"||l==="group")&&!Ls(a[l],t[l]))return!1}return!0}}class cl{hasStateChanged(t=qr){const e=`_${t}`;return Object.keys(this[e]||{}).length<this[t].length?!0:!Ls(this[e],this,!0)}saveProps(t,e){const i=e.reduce((s,o)=>(s[o]=this[o],s),{});si(this[t],i,!0)}saveState({propertySet:t=qr}={}){const e=`_${t}`;return this[e]||(this[e]={}),this.saveProps(e,this[t]),this}}class _t extends hl{}Gr(_t,[Tr,cl]);function ul(a){for(const t in ys){if(typeof a[ys[t]]>"u"||a[t]==="")continue;if(typeof a[t]>"u"){if(!_t.prototype[t])continue;a[t]=_t.prototype[t]}if(a[t].indexOf("url(")===0)continue;const e=new J(a[t]);a[t]=e.setAlpha(it(e.getAlpha()*a[ys[t]],2)).toRgba()}return a}function te(a,t,e){if(!a)return{};let i,s={},o,l;typeof e>"u"&&(e=a.getAttribute("svgUid")),a.parentNode&&Cr.test(a.parentNode.nodeName)&&(s=te(a.parentNode,t,e));let c=t.reduce(function(v,y){return i=a.getAttribute(y),i&&(v[y]=i),v},{});const u=Object.assign(Zo(a,e),Sr(a));c=Object.assign(c,u),u[ws]&&a.setAttribute(ws,u[ws]),o=l=s.fontSize||fs,c[vs]&&(c[vs]=o=Wt(c[vs],l));const p={};for(const v in c){const y=Jo(v),b=fa(y,c[v],s,o);p[y]=b}p&&p.font&&Pr(p.font,p);const m=Object.assign(Object.assign({},s),p);return Cr.test(a.nodeName)?m:ul(m)}const Kr=(a,t)=>Math.min(t.width/a.width,t.height/a.height),Zr=(a,t)=>Math.max(t.width/a.width,t.height/a.height);class Kt extends _t{constructor(t,e={}){super(),this._lastScaleX=1,this._lastScaleY=1,this._filterScalingX=1,this._filterScalingY=1,this.filters=[],this.cacheKey=`texture${ne()}`,this.set(e),this.setElement(typeof t=="string"&&D().document.getElementById(t)||t,e)}getElement(){return this._element}setElement(t,e={}){this.removeTexture(this.cacheKey),this.removeTexture(`${this.cacheKey}_filtered`),this._element=t,this._originalElement=t,this._setWidthHeight(e),t.classList.add(Kt.CSS_CANVAS),this.filters.length!==0&&this.applyFilters(),this.resizeFilter&&this.applyResizeFilters()}removeTexture(t){const e=Ai(!1);e&&e.evictCachesForKey&&e.evictCachesForKey(t)}dispose(){super.dispose(),this.removeTexture(this.cacheKey),this.removeTexture(`${this.cacheKey}_filtered`),this._cacheContext=null,["_originalElement","_element","_filteredEl","_cacheCanvas"].forEach(t=>{Je(this[t]),this[t]=void 0})}getCrossOrigin(){return this._originalElement&&(this._originalElement.crossOrigin||null)}getOriginalSize(){const t=this.getElement();return t?{width:t.naturalWidth||t.width,height:t.naturalHeight||t.height}:{width:0,height:0}}_stroke(t){if(!this.stroke||this.strokeWidth===0)return;const e=this.width/2,i=this.height/2;t.beginPath(),t.moveTo(-e,-i),t.lineTo(e,-i),t.lineTo(e,i),t.lineTo(-e,i),t.lineTo(-e,-i),t.closePath()}toObject(t=[]){const e=[];return this.filters.forEach(i=>{i&&e.push(i.toObject())}),Object.assign(Object.assign(Object.assign({},super.toObject(["cropX","cropY",...t])),{src:this.getSrc(),crossOrigin:this.getCrossOrigin(),filters:e}),this.resizeFilter?{resizeFilter:this.resizeFilter.toObject()}:{})}hasCrop(){return!!this.cropX||!!this.cropY||this.width<this._element.width||this.height<this._element.height}_toSVG(){const t=[],e=this._element,i=-this.width/2,s=-this.height/2;let o=[],l,c="",u="";if(!e)return[];if(this.hasCrop()){const p=ne();o.push('<clipPath id="imageCrop_'+p+`">
`,'	<rect x="'+i+'" y="'+s+'" width="'+this.width+'" height="'+this.height+`" />
`,`</clipPath>
`),c=' clip-path="url(#imageCrop_'+p+')" '}if(this.imageSmoothing||(u='" image-rendering="optimizeSpeed'),t.push("	<image ","COMMON_PARTS",'xlink:href="',this.getSvgSrc(!0),'" x="',i-this.cropX,'" y="',s-this.cropY,'" width="',e.width||e.naturalWidth,'" height="',e.height||e.height,u,'"',c,`></image>
`),this.stroke||this.strokeDashArray){const p=this.fill;this.fill=null,l=["	<rect ",'x="',i,'" y="',s,'" width="',this.width,'" height="',this.height,'" style="',this.getSvgStyles(),`"/>
`],this.fill=p}return this.paintFirst!=="fill"?o=o.concat(l,t):o=o.concat(t,l),o}getSrc(t){const e=t?this._element:this._originalElement;return e?e.toDataURL?e.toDataURL():this.srcFromAttribute?e.getAttribute("src"):e.src:this.src||""}getSvgSrc(t){return this.getSrc(t)}setSrc(t,{crossOrigin:e,signal:i}={}){return Qe(t,{crossOrigin:e,signal:i}).then(s=>{typeof e<"u"&&this.set({crossOrigin:e}),this.setElement(s)})}toString(){return`#<Image: { src: "${this.getSrc()}" }>`}applyResizeFilters(){const t=this.resizeFilter,e=this.minimumScaleTrigger,i=this.getTotalObjectScaling(),s=i.x,o=i.y,l=this._filteredEl||this._originalElement;if(this.group&&this.set("dirty",!0),!t||s>e&&o>e){this._element=l,this._filterScalingX=1,this._filterScalingY=1,this._lastScaleX=s,this._lastScaleY=o;return}const c=Y(),u=l.width,p=l.height;c.width=u,c.height=p,this._element=c,this._lastScaleX=t.scaleX=s,this._lastScaleY=t.scaleY=o,Ai().applyFilters([t],l,u,p,this._element),this._filterScalingX=c.width/this._originalElement.width,this._filterScalingY=c.height/this._originalElement.height}applyFilters(t=this.filters||[]){if(t=t.filter(o=>o&&!o.isNeutralState()),this.set("dirty",!0),this.removeTexture(`${this.cacheKey}_filtered`),t.length===0){this._element=this._originalElement,this._filteredEl=null,this._filterScalingX=1,this._filterScalingY=1;return}const e=this._originalElement,i=e.naturalWidth||e.width,s=e.naturalHeight||e.height;if(this._element===this._originalElement){const o=Y();o.width=i,o.height=s,this._element=o,this._filteredEl=o}else this._element=this._filteredEl,this._filteredEl.getContext("2d").clearRect(0,0,i,s),this._lastScaleX=1,this._lastScaleY=1;Ai().applyFilters(t,this._originalElement,i,s,this._element),(this._originalElement.width!==this._element.width||this._originalElement.height!==this._element.height)&&(this._filterScalingX=this._element.width/this._originalElement.width,this._filterScalingY=this._element.height/this._originalElement.height)}_render(t){t.imageSmoothingEnabled=this.imageSmoothing,this.isMoving!==!0&&this.resizeFilter&&this._needsResize()&&this.applyResizeFilters(),this._stroke(t),this._renderPaintInOrder(t)}drawCacheOnCanvas(t){t.imageSmoothingEnabled=this.imageSmoothing,super.drawCacheOnCanvas(t)}shouldCache(){return this.needsItsOwnCache()}_renderFill(t){const e=this._element;if(!e)return;const i=this._filterScalingX,s=this._filterScalingY,o=this.width,l=this.height,c=Math.max(this.cropX,0),u=Math.max(this.cropY,0),p=e.naturalWidth||e.width,m=e.naturalHeight||e.height,v=c*i,y=u*s,b=Math.min(o*i,p-v),_=Math.min(l*s,m-y),S=-o/2,k=-l/2,A=Math.min(o,p/i-c),O=Math.min(l,m/s-u);e&&t.drawImage(e,v,y,b,_,S,k,A,O)}_needsResize(){const t=this.getTotalObjectScaling();return t.x!==this._lastScaleX||t.y!==this._lastScaleY}_resetWidthHeight(){this.set(this.getOriginalSize())}_setWidthHeight({width:t,height:e}={}){const i=this.getOriginalSize();this.width=t||i.width,this.height=e||i.height}parsePreserveAspectRatioAttribute(){const t=ps(this.preserveAspectRatio||""),e=this.width,i=this.height,s={width:e,height:i};let o=this._element.width,l=this._element.height,c=1,u=1,p=0,m=0,v=0,y=0,b;return t&&(t.alignX!=="none"||t.alignY!=="none")?(t.meetOrSlice==="meet"&&(c=u=Kr(this._element,s),b=(e-o*c)/2,t.alignX==="Min"&&(p=-b),t.alignX==="Max"&&(p=b),b=(i-l*u)/2,t.alignY==="Min"&&(m=-b),t.alignY==="Max"&&(m=b)),t.meetOrSlice==="slice"&&(c=u=Zr(this._element,s),b=o-e/c,t.alignX==="Mid"&&(v=b/2),t.alignX==="Max"&&(v=b),b=l-i/u,t.alignY==="Mid"&&(y=b/2),t.alignY==="Max"&&(y=b),o=e/c,l=i/u)):(c=e/o,u=i/l),{width:o,height:l,scaleX:c,scaleY:u,offsetLeft:p,offsetTop:m,cropX:v,cropY:y}}static fromObject(t,e){var{filters:i,resizeFilter:s,src:o,crossOrigin:l}=t,c=pt(t,["filters","resizeFilter","src","crossOrigin"]);return Promise.all([Qe(o,Object.assign(Object.assign({},e),{crossOrigin:l})),i&&je(i,e),s&&je([s],e),ti(c,e)]).then(([u,p=[],[m]=[],v={}])=>new this(u,Object.assign(Object.assign(Object.assign({},c),{src:o,crossOrigin:l,filters:p,resizeFilter:m}),v)))}static fromURL(t,e={}){return Qe(t,e).then(i=>new this(i,e))}static fromElement(t,e,i={}){const s=te(t,this.ATTRIBUTE_NAMES);this.fromURL(s["xlink:href"],Object.assign(Object.assign({},i),s)).then(e)}}Kt.CSS_CANVAS="canvas-img",Kt.ATTRIBUTE_NAMES=[...le,"x","y","width","height","preserveAspectRatio","xlink:href","crossOrigin","image-rendering"];const dl={type:"image",strokeWidth:0,srcFromAttribute:!1,minimumScaleTrigger:.5,stateProperties:Rt.stateProperties.concat("cropX","cropY"),cacheProperties:Rt.cacheProperties.concat("cropX","cropY"),cropX:0,cropY:0,imageSmoothing:!0};Object.assign(Kt.prototype,dl),$.setClass(Kt),$.setSVGClass(Kt);class ni extends wt{getCacheKey(){return`${this.type}_${this.mode}`}getFragmentSource(){return this.fragmentSource[this.mode]}applyToWebGL(t){const e=t.context,i=this.createTexture(t.filterBackend,this.image);this.bindAdditionalTexture(e,i,e.TEXTURE1),super.applyToWebGL(t),this.unbindAdditionalTexture(e,e.TEXTURE1)}createTexture(t,e){return t.getCachedTexture(e.cacheKey,e.getElement())}calculateMatrix(){const t=this.image,{width:e,height:i}=t.getElement();return[1/t.scaleX,0,0,0,1/t.scaleY,0,-t.left/e,-t.top/i,1]}applyTo2d({imageData:{data:t,width:e,height:i},filterBackend:{resources:s}}){const o=this.image;s.blendImage||(s.blendImage=Y());const l=s.blendImage,c=l.getContext("2d");l.width!==e||l.height!==i?(l.width=e,l.height=i):c.clearRect(0,0,e,i),c.setTransform(o.scaleX,0,0,o.scaleY,o.left,o.top),c.drawImage(o.getElement(),0,0,e,i);const u=c.getImageData(0,0,e,i).data;for(let p=0;p<t.length;p+=4){const m=t[p],v=t[p+1],y=t[p+2],b=t[p+3],_=u[p],S=u[p+1],k=u[p+2],A=u[p+3];switch(this.mode){case"multiply":t[p]=m*_/255,t[p+1]=v*S/255,t[p+2]=y*k/255,t[p+3]=b*A/255;break;case"mask":t[p+3]=A;break}}}getUniformLocations(t,e){return{uTransformMatrix:t.getUniformLocation(e,"uTransformMatrix"),uImage:t.getUniformLocation(e,"uImage")}}sendUniformData(t,e){const i=this.calculateMatrix();t.uniform1i(e.uImage,1),t.uniformMatrix3fv(e.uTransformMatrix,!1,i)}toObject(){return{type:this.type,image:this.image&&this.image.toObject(),mode:this.mode,alpha:this.alpha}}static fromObject(t,e){return Kt.fromObject(t.image,e).then(i=>new ni(Object.assign(Object.assign({},t),{image:i})))}}const fl={type:"BlendImage",mode:"multiply",alpha:1,vertexSource:`
    attribute vec2 aPosition;
    varying vec2 vTexCoord;
    varying vec2 vTexCoord2;
    uniform mat3 uTransformMatrix;
    void main() {
      vTexCoord = aPosition;
      vTexCoord2 = (uTransformMatrix * vec3(aPosition, 1.0)).xy;
      gl_Position = vec4(aPosition * 2.0 - 1.0, 0.0, 1.0);
    }
    `,fragmentSource:{multiply:`
      precision highp float;
      uniform sampler2D uTexture;
      uniform sampler2D uImage;
      uniform vec4 uColor;
      varying vec2 vTexCoord;
      varying vec2 vTexCoord2;
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        vec4 color2 = texture2D(uImage, vTexCoord2);
        color.rgba *= color2.rgba;
        gl_FragColor = color;
      }
      `,mask:`
      precision highp float;
      uniform sampler2D uTexture;
      uniform sampler2D uImage;
      uniform vec4 uColor;
      varying vec2 vTexCoord;
      varying vec2 vTexCoord2;
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        vec4 color2 = texture2D(uImage, vTexCoord2);
        color.a = color2.a;
        gl_FragColor = color;
      }
      `}};Object.assign(ni.prototype,fl),$.setClass(ni);class oi extends at{applyTo(t){yt(t)?(this.aspectRatio=t.sourceWidth/t.sourceHeight,t.passes++,this._setupFrameBuffer(t),this.horizontal=!0,this.applyToWebGL(t),this._swapTextures(t),this._setupFrameBuffer(t),this.horizontal=!1,this.applyToWebGL(t),this._swapTextures(t)):this.applyTo2d(t)}applyTo2d(t){t.imageData=this.simpleBlur(t)}simpleBlur({ctx:t,imageData:e,filterBackend:{resources:i}}){const{width:s,height:o}=e;i.blurLayer1||(i.blurLayer1=Y(),i.blurLayer2=Y());const l=i.blurLayer1,c=i.blurLayer2;(l.width!==s||l.height!==o)&&(c.width=l.width=s,c.height=l.height=o);const u=l.getContext("2d"),p=c.getContext("2d"),m=15,v=this.blur*.06*.5;let y,b,_,S;for(u.putImageData(e,0,0),p.clearRect(0,0,s,o),S=-m;S<=m;S++)y=(Math.random()-.5)/4,b=S/m,_=v*b*s+y,p.globalAlpha=1-Math.abs(b),p.drawImage(l,_,y),u.drawImage(c,0,0),p.globalAlpha=1,p.clearRect(0,0,c.width,c.height);for(S=-m;S<=m;S++)y=(Math.random()-.5)/4,b=S/m,_=v*b*o+y,p.globalAlpha=1-Math.abs(b),p.drawImage(l,y,_),u.drawImage(c,0,0),p.globalAlpha=1,p.clearRect(0,0,c.width,c.height);t.drawImage(l,0,0);const k=t.getImageData(0,0,l.width,l.height);return u.globalAlpha=1,u.clearRect(0,0,l.width,l.height),k}getUniformLocations(t,e){return{delta:t.getUniformLocation(e,"uDelta")}}sendUniformData(t,e){const i=this.chooseRightDelta();t.uniform2fv(e.delta,i)}chooseRightDelta(){let t=1;const e=[0,0];this.horizontal?this.aspectRatio>1&&(t=1/this.aspectRatio):this.aspectRatio<1&&(t=this.aspectRatio);const i=t*this.blur*.12;return this.horizontal?e[0]=i:e[1]=i,e}static async fromObject(t){return new oi(t)}}const pl={type:"Blur",fragmentSource:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform vec2 uDelta;
    varying vec2 vTexCoord;
    const float nSamples = 15.0;
    vec3 v3offset = vec3(12.9898, 78.233, 151.7182);
    float random(vec3 scale) {
      /* use the fragment position for a different seed per-pixel */
      return fract(sin(dot(gl_FragCoord.xyz, scale)) * 43758.5453);
    }
    void main() {
      vec4 color = vec4(0.0);
      float total = 0.0;
      float offset = random(v3offset);
      for (float t = -nSamples; t <= nSamples; t++) {
        float percent = (t + offset - 0.5) / nSamples;
        float weight = 1.0 - abs(percent);
        color += texture2D(uTexture, vTexCoord + uDelta * percent) * weight;
        total += weight;
      }
      gl_FragColor = color / total;
    }
  `,blur:0,mainParameter:"blur"};Object.assign(oi.prototype,pl),$.setClass(oi);class ai extends at{applyTo2d({imageData:{data:t}}){if(this.brightness===0)return;const e=Math.round(this.brightness*255);for(let i=0;i<t.length;i+=4)t[i]=t[i]+e,t[i+1]=t[i+1]+e,t[i+2]=t[i+2]+e}getUniformLocations(t,e){return{uBrightness:t.getUniformLocation(e,"uBrightness")}}sendUniformData(t,e){t.uniform1f(e.uBrightness,this.brightness)}static async fromObject(t){return new ai(t)}}const gl={type:"Brightness",fragmentSource:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uBrightness;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      color.rgb += uBrightness;
      gl_FragColor = color;
    }
  `,brightness:0,mainParameter:"brightness"};Object.assign(ai.prototype,gl),$.setClass(ai);class xe extends at{setOptions(t){var{matrix:e}=t,i=pt(t,["matrix"]);e&&(this.matrix=[...e]),super.setOptions(i)}applyTo2d(t){const e=t.imageData,i=e.data,s=this.matrix,o=this.colorsOnly;for(let l=0;l<i.length;l+=4){const c=i[l],u=i[l+1],p=i[l+2];if(o)i[l]=c*s[0]+u*s[1]+p*s[2]+s[4]*255,i[l+1]=c*s[5]+u*s[6]+p*s[7]+s[9]*255,i[l+2]=c*s[10]+u*s[11]+p*s[12]+s[14]*255;else{const m=i[l+3];i[l]=c*s[0]+u*s[1]+p*s[2]+m*s[3]+s[4]*255,i[l+1]=c*s[5]+u*s[6]+p*s[7]+m*s[8]+s[9]*255,i[l+2]=c*s[10]+u*s[11]+p*s[12]+m*s[13]+s[14]*255,i[l+3]=c*s[15]+u*s[16]+p*s[17]+m*s[18]+s[19]*255}}}getUniformLocations(t,e){return{uColorMatrix:t.getUniformLocation(e,"uColorMatrix"),uConstants:t.getUniformLocation(e,"uConstants")}}sendUniformData(t,e){const i=this.matrix,s=[i[0],i[1],i[2],i[3],i[5],i[6],i[7],i[8],i[10],i[11],i[12],i[13],i[15],i[16],i[17],i[18]],o=[i[4],i[9],i[14],i[19]];t.uniformMatrix4fv(e.uColorMatrix,!1,s),t.uniform4fv(e.uConstants,o)}static async fromObject(t){return new xe(t)}}const ml={type:"ColorMatrix",fragmentSource:`
      precision highp float;
      uniform sampler2D uTexture;
      varying vec2 vTexCoord;
      uniform mat4 uColorMatrix;
      uniform vec4 uConstants;
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        color *= uColorMatrix;
        color += uConstants;
        gl_FragColor = color;
      }`,matrix:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mainParameter:"matrix",colorsOnly:!0};Object.assign(xe.prototype,ml),$.setClass(xe);class li extends at{constructor(t={}){var{subFilters:e=[]}=t,i=pt(t,["subFilters"]);super(i),this.subFilters=e}applyTo(t){yt(t)&&(t.passes+=this.subFilters.length-1),this.subFilters.forEach(e=>{e.applyTo(t)})}toObject(){return Object.assign(Object.assign({},super.toObject()),{subFilters:this.subFilters.map(t=>t.toObject())})}isNeutralState(){return!this.subFilters.some(t=>!t.isNeutralState())}static fromObject(t,e){return Promise.all((t.subFilters||[]).map(i=>$.getClass(i.type).fromObject(i,e))).then(i=>new li({subFilters:i}))}}const yl={type:"Composed"};Object.assign(li.prototype,yl),$.setClass(li);class hi extends at{applyTo2d({imageData:{data:t}}){if(this.contrast===0)return;const e=Math.floor(this.contrast*255),i=259*(e+255)/(255*(259-e));for(let s=0;s<t.length;s+=4)t[s]=i*(t[s]-128)+128,t[s+1]=i*(t[s+1]-128)+128,t[s+2]=i*(t[s+2]-128)+128}getUniformLocations(t,e){return{uContrast:t.getUniformLocation(e,"uContrast")}}sendUniformData(t,e){t.uniform1f(e.uContrast,this.contrast)}static async fromObject(t){return new hi(t)}}const vl={type:"Contrast",fragmentSource:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uContrast;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      float contrastF = 1.015 * (uContrast + 1.0) / (1.0 * (1.015 - uContrast));
      color.rgb = contrastF * (color.rgb - 0.5) + 0.5;
      gl_FragColor = color;
    }`,contrast:0,mainParameter:"contrast"};Object.assign(hi.prototype,vl),$.setClass(hi);class ci extends wt{getCacheKey(){return`${this.type}_${Math.sqrt(this.matrix.length)}_${this.opaque?1:0}`}getFragmentSource(){return this.fragmentSource[this.getCacheKey()]}applyTo2d(t){const e=t.imageData,i=e.data,s=this.matrix,o=Math.round(Math.sqrt(s.length)),l=Math.floor(o/2),c=e.width,u=e.height,p=t.ctx.createImageData(c,u),m=p.data,v=this.opaque?1:0;let y,b,_,S,k,A,O,F,I,B,K,tt,Z;for(K=0;K<u;K++)for(B=0;B<c;B++){for(k=(K*c+B)*4,y=0,b=0,_=0,S=0,Z=0;Z<o;Z++)for(tt=0;tt<o;tt++)O=K+Z-l,A=B+tt-l,!(O<0||O>=u||A<0||A>=c)&&(F=(O*c+A)*4,I=s[Z*o+tt],y+=i[F]*I,b+=i[F+1]*I,_+=i[F+2]*I,v||(S+=i[F+3]*I));m[k]=y,m[k+1]=b,m[k+2]=_,v?m[k+3]=i[k+3]:m[k+3]=S}t.imageData=p}getUniformLocations(t,e){return{uMatrix:t.getUniformLocation(e,"uMatrix"),uOpaque:t.getUniformLocation(e,"uOpaque"),uHalfSize:t.getUniformLocation(e,"uHalfSize"),uSize:t.getUniformLocation(e,"uSize")}}sendUniformData(t,e){t.uniform1fv(e.uMatrix,this.matrix)}toObject(){return Object.assign(Object.assign({},super.toObject()),{opaque:this.opaque,matrix:[...this.matrix]})}static async fromObject(t){return new ci(t)}}const wl={type:"Convolute",opaque:!1,matrix:[0,0,0,0,1,0,0,0,0],fragmentSource:{Convolute_3_1:`
      precision highp float;
      uniform sampler2D uTexture;
      uniform float uMatrix[9];
      uniform float uStepW;
      uniform float uStepH;
      varying vec2 vTexCoord;
      void main() {
        vec4 color = vec4(0, 0, 0, 0);
        for (float h = 0.0; h < 3.0; h+=1.0) {
          for (float w = 0.0; w < 3.0; w+=1.0) {
            vec2 matrixPos = vec2(uStepW * (w - 1), uStepH * (h - 1));
            color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 3.0 + w)];
          }
        }
        gl_FragColor = color;
      }
      `,Convolute_3_0:`
      precision highp float;
      uniform sampler2D uTexture;
      uniform float uMatrix[9];
      uniform float uStepW;
      uniform float uStepH;
      varying vec2 vTexCoord;
      void main() {
        vec4 color = vec4(0, 0, 0, 1);
        for (float h = 0.0; h < 3.0; h+=1.0) {
          for (float w = 0.0; w < 3.0; w+=1.0) {
            vec2 matrixPos = vec2(uStepW * (w - 1.0), uStepH * (h - 1.0));
            color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 3.0 + w)];
          }
        }
        float alpha = texture2D(uTexture, vTexCoord).a;
        gl_FragColor = color;
        gl_FragColor.a = alpha;
      }
      `,Convolute_5_1:`
      precision highp float;
      uniform sampler2D uTexture;
      uniform float uMatrix[25];
      uniform float uStepW;
      uniform float uStepH;
      varying vec2 vTexCoord;
      void main() {
        vec4 color = vec4(0, 0, 0, 0);
        for (float h = 0.0; h < 5.0; h+=1.0) {
          for (float w = 0.0; w < 5.0; w+=1.0) {
            vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
            color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 5.0 + w)];
          }
        }
        gl_FragColor = color;
      }
      `,Convolute_5_0:`
      precision highp float;
      uniform sampler2D uTexture;
      uniform float uMatrix[25];
      uniform float uStepW;
      uniform float uStepH;
      varying vec2 vTexCoord;
      void main() {
        vec4 color = vec4(0, 0, 0, 1);
        for (float h = 0.0; h < 5.0; h+=1.0) {
          for (float w = 0.0; w < 5.0; w+=1.0) {
            vec2 matrixPos = vec2(uStepW * (w - 2.0), uStepH * (h - 2.0));
            color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 5.0 + w)];
          }
        }
        float alpha = texture2D(uTexture, vTexCoord).a;
        gl_FragColor = color;
        gl_FragColor.a = alpha;
      }
      `,Convolute_7_1:`
      precision highp float;
      uniform sampler2D uTexture;
      uniform float uMatrix[49];
      uniform float uStepW;
      uniform float uStepH;
      varying vec2 vTexCoord;
      void main() {
        vec4 color = vec4(0, 0, 0, 0);
        for (float h = 0.0; h < 7.0; h+=1.0) {
          for (float w = 0.0; w < 7.0; w+=1.0) {
            vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
            color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 7.0 + w)];
          }
        }
        gl_FragColor = color;
      }
      `,Convolute_7_0:`
      precision highp float;
      uniform sampler2D uTexture;
      uniform float uMatrix[49];
      uniform float uStepW;
      uniform float uStepH;
      varying vec2 vTexCoord;
      void main() {
        vec4 color = vec4(0, 0, 0, 1);
        for (float h = 0.0; h < 7.0; h+=1.0) {
          for (float w = 0.0; w < 7.0; w+=1.0) {
            vec2 matrixPos = vec2(uStepW * (w - 3.0), uStepH * (h - 3.0));
            color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 7.0 + w)];
          }
        }
        float alpha = texture2D(uTexture, vTexCoord).a;
        gl_FragColor = color;
        gl_FragColor.a = alpha;
      }
      `,Convolute_9_1:`
      precision highp float;
      uniform sampler2D uTexture;
      uniform float uMatrix[81];
      uniform float uStepW;
      uniform float uStepH;
      varying vec2 vTexCoord;
      void main() {
        vec4 color = vec4(0, 0, 0, 0);
        for (float h = 0.0; h < 9.0; h+=1.0) {
          for (float w = 0.0; w < 9.0; w+=1.0) {
            vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
            color += texture2D(uTexture, vTexCoord + matrixPos) * uMatrix[int(h * 9.0 + w)];
          }
        }
        gl_FragColor = color;
      }
      `,Convolute_9_0:`
      precision highp float;
      uniform sampler2D uTexture;
      uniform float uMatrix[81];
      uniform float uStepW;
      uniform float uStepH;
      varying vec2 vTexCoord;
      void main() {
        vec4 color = vec4(0, 0, 0, 1);
        for (float h = 0.0; h < 9.0; h+=1.0) {
          for (float w = 0.0; w < 9.0; w+=1.0) {
            vec2 matrixPos = vec2(uStepW * (w - 4.0), uStepH * (h - 4.0));
            color.rgb += texture2D(uTexture, vTexCoord + matrixPos).rgb * uMatrix[int(h * 9.0 + w)];
          }
        }
        float alpha = texture2D(uTexture, vTexCoord).a;
        gl_FragColor = color;
        gl_FragColor.a = alpha;
      }
      `}};Object.assign(ci.prototype,wl),$.setClass(ci);function Pe(a,t){return class Oo extends xe{constructor(){super(...arguments),this.type=a,this.matrix=t,this.mainParameter=void 0,this.colorsOnly=!0}static async fromObject(i){return new Oo(i)}}}const Jr=Pe("Brownie",[.5997,.34553,-.27082,0,.186,-.0377,.86095,.15059,0,-.1449,.24113,-.07441,.44972,0,-.02965,0,0,0,1,0]);$.setClass(Jr);const Qr=Pe("Vintage",[.62793,.32021,-.03965,0,.03784,.02578,.64411,.03259,0,.02926,.0466,-.08512,.52416,0,.02023,0,0,0,1,0]);$.setClass(Qr);const tn=Pe("Kodachrome",[1.12855,-.39673,-.03992,0,.24991,-.16404,1.08352,-.05498,0,.09698,-.16786,-.56034,1.60148,0,.13972,0,0,0,1,0]);$.setClass(tn);const en=Pe("Technicolor",[1.91252,-.85453,-.09155,0,.04624,-.30878,1.76589,-.10601,0,-.27589,-.2311,-.75018,1.84759,0,.12137,0,0,0,1,0]);$.setClass(en);const sn=Pe("Polaroid",[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0]);$.setClass(sn);const rn=Pe("Sepia",[.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0]);$.setClass(rn);const nn=Pe("BlackWhite",[1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,1.5,1.5,1.5,0,-1,0,0,0,1,0]);$.setClass(nn);class ui extends at{constructor(t={}){var{gamma:e}=t,i=pt(t,["gamma"]);super(i),this.gamma=e||[1,1,1]}applyTo2d({imageData:{data:t}}){const e=this.gamma,i=1/e[0],s=1/e[1],o=1/e[2];this.rgbValues||(this.rgbValues={r:new Uint8Array(256),g:new Uint8Array(256),b:new Uint8Array(256)});for(let l=0;l<256;l++)this.rgbValues.r[l]=Math.pow(l/255,i)*255,this.rgbValues.g[l]=Math.pow(l/255,s)*255,this.rgbValues.b[l]=Math.pow(l/255,o)*255;for(let l=0;l<t.length;l+=4)t[l]=this.rgbValues.r[t[l]],t[l+1]=this.rgbValues.g[t[l+1]],t[l+2]=this.rgbValues.b[t[l+2]]}getUniformLocations(t,e){return{uGamma:t.getUniformLocation(e,"uGamma")}}sendUniformData(t,e){t.uniform3fv(e.uGamma,this.gamma)}static async fromObject(t){return new ui(t)}}const Cl={type:"Gamma",fragmentSource:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform vec3 uGamma;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      vec3 correction = (1.0 / uGamma);
      color.r = pow(color.r, correction.r);
      color.g = pow(color.g, correction.g);
      color.b = pow(color.b, correction.b);
      gl_FragColor = color;
      gl_FragColor.rgb *= color.a;
    }
  `,mainParameter:"gamma",gamma:[1,1,1]};Object.assign(ui.prototype,Cl),$.setClass(ui);class di extends wt{applyTo2d({imageData:{data:t}}){for(let e=0,i;e<t.length;e+=4){switch(this.mode){case"average":i=(t[e]+t[e+1]+t[e+2])/3;break;case"lightness":i=(Math.min(t[e],t[e+1],t[e+2])+Math.max(t[e],t[e+1],t[e+2]))/2;break;case"luminosity":i=.21*t[e]+.72*t[e+1]+.07*t[e+2];break}t[e]=i,t[e+1]=i,t[e+2]=i}}getCacheKey(){return`${this.type}_${this.mode}`}getFragmentSource(){return this.fragmentSource[this.mode]}getUniformLocations(t,e){return{uMode:t.getUniformLocation(e,"uMode")}}sendUniformData(t,e){t.uniform1i(e.uMode,1)}isNeutralState(){return!1}static async fromObject(t){return new di(t)}}const bl={type:"Grayscale",fragmentSource:{average:`
      precision highp float;
      uniform sampler2D uTexture;
      varying vec2 vTexCoord;
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        float average = (color.r + color.b + color.g) / 3.0;
        gl_FragColor = vec4(average, average, average, color.a);
      }
      `,lightness:`
      precision highp float;
      uniform sampler2D uTexture;
      uniform int uMode;
      varying vec2 vTexCoord;
      void main() {
        vec4 col = texture2D(uTexture, vTexCoord);
        float average = (max(max(col.r, col.g),col.b) + min(min(col.r, col.g),col.b)) / 2.0;
        gl_FragColor = vec4(average, average, average, col.a);
      }
      `,luminosity:`
      precision highp float;
      uniform sampler2D uTexture;
      uniform int uMode;
      varying vec2 vTexCoord;
      void main() {
        vec4 col = texture2D(uTexture, vTexCoord);
        float average = 0.21 * col.r + 0.72 * col.g + 0.07 * col.b;
        gl_FragColor = vec4(average, average, average, col.a);
      }
      `},mode:"average",mainParameter:"mode"};Object.assign(di.prototype,bl),$.setClass(di);class fi extends xe{calculateMatrix(){const t=this.rotation*Math.PI,e=Dt(t),i=Mt(t),s=1/3,o=Math.sqrt(s)*i,l=1-e;this.matrix=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],this.matrix[0]=e+l/3,this.matrix[1]=s*l-o,this.matrix[2]=s*l+o,this.matrix[5]=s*l+o,this.matrix[6]=e+s*l,this.matrix[7]=s*l-o,this.matrix[10]=s*l-o,this.matrix[11]=s*l+o,this.matrix[12]=e+s*l}isNeutralState(){return this.calculateMatrix(),super.isNeutralState()}applyTo(t){this.calculateMatrix(),super.applyTo(t)}static async fromObject(t){return new fi(t)}}const _l={type:"HueRotation",rotation:0,mainParameter:"rotation"};Object.assign(fi.prototype,_l),$.setClass(fi);class pi extends at{applyTo2d({imageData:{data:t}}){for(let e=0;e<t.length;e+=4)t[e]=255-t[e],t[e+1]=255-t[e+1],t[e+2]=255-t[e+2],this.alpha&&(t[e+3]=255-t[e+3])}isNeutralState(){return!this.invert}getUniformLocations(t,e){return{uInvert:t.getUniformLocation(e,"uInvert"),uAlpha:t.getUniformLocation(e,"uAlpha")}}sendUniformData(t,e){t.uniform1i(e.uInvert,Number(this.invert)),t.uniform1i(e.uAlpha,Number(this.alpha))}static async fromObject(t){return new pi(t)}}const xl={type:"Invert",alpha:!1,fragmentSource:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform int uInvert;
    uniform int uAlpha;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      if (uInvert == 1) {
        if (uAlpha == 1) {
          gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,1.0 -color.a);
        } else {
          gl_FragColor = vec4(1.0 - color.r,1.0 -color.g,1.0 -color.b,color.a);
        }
      } else {
        gl_FragColor = color;
      }
    }
    `,invert:!0,mainParameter:"invert"};Object.assign(pi.prototype,xl),$.setClass(pi);class gi extends at{applyTo2d({imageData:{data:t}}){if(this.noise===0)return;const e=this.noise;for(let i=0;i<t.length;i+=4){const s=(.5-Math.random())*e;t[i]+=s,t[i+1]+=s,t[i+2]+=s}}getUniformLocations(t,e){return{uNoise:t.getUniformLocation(e,"uNoise"),uSeed:t.getUniformLocation(e,"uSeed")}}sendUniformData(t,e){t.uniform1f(e.uNoise,this.noise/255),t.uniform1f(e.uSeed,Math.random())}toObject(){return Object.assign(Object.assign({},super.toObject()),{noise:this.noise})}static async fromObject(t){return new gi(t)}}const Pl={type:"Noise",fragmentSource:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uStepH;
    uniform float uNoise;
    uniform float uSeed;
    varying vec2 vTexCoord;
    float rand(vec2 co, float seed, float vScale) {
      return fract(sin(dot(co.xy * vScale ,vec2(12.9898 , 78.233))) * 43758.5453 * (seed + 0.01) / 2.0);
    }
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      color.rgb += (0.5 - rand(vTexCoord, uSeed, 0.1 / uStepH)) * uNoise;
      gl_FragColor = color;
    }
    `,mainParameter:"noise",noise:0};Object.assign(gi.prototype,Pl),$.setClass(gi);class mi extends at{applyTo2d({imageData:{data:t,width:e,height:i}}){for(let s=0;s<i;s+=this.blocksize)for(let o=0;o<e;o+=this.blocksize){const l=s*4*e+o*4,c=t[l],u=t[l+1],p=t[l+2],m=t[l+3];for(let v=s;v<Math.min(s+this.blocksize,i);v++)for(let y=o;y<Math.min(o+this.blocksize,e);y++){const b=v*4*e+y*4;t[b]=c,t[b+1]=u,t[b+2]=p,t[b+3]=m}}}isNeutralState(){return this.blocksize===1}getUniformLocations(t,e){return{uBlocksize:t.getUniformLocation(e,"uBlocksize"),uStepW:t.getUniformLocation(e,"uStepW"),uStepH:t.getUniformLocation(e,"uStepH")}}sendUniformData(t,e){t.uniform1f(e.uBlocksize,this.blocksize)}static async fromObject(t){return new mi(t)}}const Sl={type:"Pixelate",blocksize:4,mainParameter:"blocksize",fragmentSource:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uBlocksize;
    uniform float uStepW;
    uniform float uStepH;
    varying vec2 vTexCoord;
    void main() {
      float blockW = uBlocksize * uStepW;
      float blockH = uBlocksize * uStepW;
      int posX = int(vTexCoord.x / blockW);
      int posY = int(vTexCoord.y / blockH);
      float fposX = float(posX);
      float fposY = float(posY);
      vec2 squareCoords = vec2(fposX * blockW, fposY * blockH);
      vec4 color = texture2D(uTexture, squareCoords);
      gl_FragColor = color;
    }
    `};Object.assign(mi.prototype,Sl),$.setClass(mi);class yi extends at{applyTo2d({imageData:{data:t}}){const e=this.distance*255,i=new J(this.color).getSource(),s=[i[0]-e,i[1]-e,i[2]-e],o=[i[0]+e,i[1]+e,i[2]+e];for(let l=0;l<t.length;l+=4){const c=t[l],u=t[l+1],p=t[l+2];c>s[0]&&u>s[1]&&p>s[2]&&c<o[0]&&u<o[1]&&p<o[2]&&(t[l+3]=0)}}getUniformLocations(t,e){return{uLow:t.getUniformLocation(e,"uLow"),uHigh:t.getUniformLocation(e,"uHigh")}}sendUniformData(t,e){const i=new J(this.color).getSource(),s=this.distance,o=[0+i[0]/255-s,0+i[1]/255-s,0+i[2]/255-s,1],l=[i[0]/255+s,i[1]/255+s,i[2]/255+s,1];t.uniform4fv(e.uLow,o),t.uniform4fv(e.uHigh,l)}toObject(){return Object.assign(Object.assign({},super.toObject()),{color:this.color,distance:this.distance})}static async fromObject(t){return new yi(t)}}const Tl={type:"RemoveColor",color:"#FFFFFF",fragmentSource:`
      precision highp float;
      uniform sampler2D uTexture;
      uniform vec4 uLow;
      uniform vec4 uHigh;
      varying vec2 vTexCoord;
      void main() {
        gl_FragColor = texture2D(uTexture, vTexCoord);
        if(all(greaterThan(gl_FragColor.rgb,uLow.rgb)) && all(greaterThan(uHigh.rgb,gl_FragColor.rgb))) {
          gl_FragColor.a = 0.0;
        }
      }
      `,distance:.02,useAlpha:!1};Object.assign(yi.prototype,Tl),$.setClass(yi);class vi extends at{getUniformLocations(t,e){return{uDelta:t.getUniformLocation(e,"uDelta"),uTaps:t.getUniformLocation(e,"uTaps")}}sendUniformData(t,e){t.uniform2fv(e.uDelta,this.horizontal?[1/this.width,0]:[0,1/this.height]),t.uniform1fv(e.uTaps,this.taps)}getFilterWindow(){const t=this.tempScale;return Math.ceil(this.lanczosLobes/t)}getCacheKey(){const t=this.getFilterWindow();return`${this.type}_${t}`}getFragmentSource(){const t=this.getFilterWindow();return this.generateShader(t)}getTaps(){const t=this.lanczosCreate(this.lanczosLobes),e=this.tempScale,i=this.getFilterWindow(),s=new Array(i);for(let o=1;o<=i;o++)s[o-1]=t(o*e);return s}generateShader(t){const e=new Array(t);for(let i=1;i<=t;i++)e[i-1]=`${i}.0 * uDelta`;return`
      ${this.fragmentSourceTOP}
      uniform float uTaps[${t}];
      void main() {
        vec4 color = texture2D(uTexture, vTexCoord);
        float sum = 1.0;
        ${e.map((i,s)=>`
              color += texture2D(uTexture, vTexCoord + ${i}) * uTaps[${s}] + texture2D(uTexture, vTexCoord - ${i}) * uTaps[${s}];
              sum += 2.0 * uTaps[${s}];
            `).join(`
`)}
        gl_FragColor = color / sum;
      }
    `}applyTo(t){yt(t)?(t.passes++,this.width=t.sourceWidth,this.horizontal=!0,this.dW=Math.round(this.width*this.scaleX),this.dH=t.sourceHeight,this.tempScale=this.dW/this.width,this.taps=this.getTaps(),t.destinationWidth=this.dW,this._setupFrameBuffer(t),this.applyToWebGL(t),this._swapTextures(t),t.sourceWidth=t.destinationWidth,this.height=t.sourceHeight,this.horizontal=!1,this.dH=Math.round(this.height*this.scaleY),this.tempScale=this.dH/this.height,this.taps=this.getTaps(),t.destinationHeight=this.dH,this._setupFrameBuffer(t),this.applyToWebGL(t),this._swapTextures(t),t.sourceHeight=t.destinationHeight):this.applyTo2d(t)}isNeutralState(){return this.scaleX===1&&this.scaleY===1}lanczosCreate(t){return e=>{if(e>=t||e<=-t)return 0;if(e<11920929e-14&&e>-11920929e-14)return 1;e*=Math.PI;const i=e/t;return Math.sin(e)/e*Math.sin(i)/i}}applyTo2d(t){const e=t.imageData,i=this.scaleX,s=this.scaleY;this.rcpScaleX=1/i,this.rcpScaleY=1/s;let o=e.width,l=e.height,c=Math.round(o*i),u=Math.round(l*s),p;this.resizeType==="sliceHack"?p=this.sliceByTwo(t,o,l,c,u):this.resizeType==="hermite"?p=this.hermiteFastResize(t,o,l,c,u):this.resizeType==="bilinear"?p=this.bilinearFiltering(t,o,l,c,u):this.resizeType==="lanczos"&&(p=this.lanczosResize(t,o,l,c,u)),t.imageData=p}sliceByTwo(t,e,i,s,o){let l=t.imageData,c=.5,u=!1,p=!1,m=e*c,v=i*c,y=t.filterBackend.resources,b=0,_=0,S=e,k=0;y.sliceByTwo||(y.sliceByTwo=D().document.createElement("canvas"));const A=y.sliceByTwo;(A.width<e*1.5||A.height<i)&&(A.width=e*1.5,A.height=i);const O=A.getContext("2d");for(O.clearRect(0,0,e*1.5,i),O.putImageData(l,0,0),s=Math.floor(s),o=Math.floor(o);!u||!p;)e=m,i=v,s<Math.floor(m*c)?m=Math.floor(m*c):(m=s,u=!0),o<Math.floor(v*c)?v=Math.floor(v*c):(v=o,p=!0),O.drawImage(A,b,_,e,i,S,k,m,v),b=S,_=k,k+=v;return O.getImageData(b,_,s,o)}lanczosResize(t,e,i,s,o){function l(I){let B,K,tt,Z,dt,xt,Nt,At,Ft,ft,Pt;for(O.x=(I+.5)*v,F.x=Math.floor(O.x),B=0;B<o;B++){for(O.y=(B+.5)*y,F.y=Math.floor(O.y),dt=0,xt=0,Nt=0,At=0,Ft=0,K=F.x-S;K<=F.x+S;K++)if(!(K<0||K>=e)){ft=Math.floor(1e3*Math.abs(K-O.x)),A[ft]||(A[ft]={});for(let ge=F.y-k;ge<=F.y+k;ge++)ge<0||ge>=i||(Pt=Math.floor(1e3*Math.abs(ge-O.y)),A[ft][Pt]||(A[ft][Pt]=m(Math.sqrt(Math.pow(ft*b,2)+Math.pow(Pt*_,2))/1e3)),tt=A[ft][Pt],tt>0&&(Z=(ge*e+K)*4,dt+=tt,xt+=tt*c[Z],Nt+=tt*c[Z+1],At+=tt*c[Z+2],Ft+=tt*c[Z+3]))}Z=(B*s+I)*4,p[Z]=xt/dt,p[Z+1]=Nt/dt,p[Z+2]=At/dt,p[Z+3]=Ft/dt}return++I<s?l(I):u}const c=t.imageData.data,u=t.ctx.createImageData(s,o),p=u.data,m=this.lanczosCreate(this.lanczosLobes),v=this.rcpScaleX,y=this.rcpScaleY,b=2/this.rcpScaleX,_=2/this.rcpScaleY,S=Math.ceil(v*this.lanczosLobes/2),k=Math.ceil(y*this.lanczosLobes/2),A={},O={},F={};return l(0)}bilinearFiltering(t,e,i,s,o){let l,c,u,p,m,v,y,b,_,S,k,A,O=0,F,I=this.rcpScaleX,B=this.rcpScaleY,K=4*(e-1),tt=t.imageData,Z=tt.data,dt=t.ctx.createImageData(s,o),xt=dt.data;for(y=0;y<o;y++)for(b=0;b<s;b++)for(m=Math.floor(I*b),v=Math.floor(B*y),_=I*b-m,S=B*y-v,F=4*(v*e+m),k=0;k<4;k++)l=Z[F+k],c=Z[F+4+k],u=Z[F+K+k],p=Z[F+K+4+k],A=l*(1-_)*(1-S)+c*_*(1-S)+u*S*(1-_)+p*_*S,xt[O++]=A;return dt}hermiteFastResize(t,e,i,s,o){const l=this.rcpScaleX,c=this.rcpScaleY,u=Math.ceil(l/2),p=Math.ceil(c/2),m=t.imageData,v=m.data,y=t.ctx.createImageData(s,o),b=y.data;for(let _=0;_<o;_++)for(let S=0;S<s;S++){let k=(S+_*s)*4,A=0,O=0,F=0,I=0,B=0,K=0,tt=0,Z=(_+.5)*c;for(let dt=Math.floor(_*c);dt<(_+1)*c;dt++){const xt=Math.abs(Z-(dt+.5))/p,Nt=(S+.5)*l,At=xt*xt;for(let Ft=Math.floor(S*l);Ft<(S+1)*l;Ft++){let ft=Math.abs(Nt-(Ft+.5))/u,Pt=Math.sqrt(At+ft*ft);Pt>1&&Pt<-1||(A=2*Pt*Pt*Pt-3*Pt*Pt+1,A>0&&(ft=4*(Ft+dt*e),tt+=A*v[ft+3],F+=A,v[ft+3]<255&&(A=A*v[ft+3]/250),I+=A*v[ft],B+=A*v[ft+1],K+=A*v[ft+2],O+=A))}}b[k]=I/O,b[k+1]=B/O,b[k+2]=K/O,b[k+3]=tt/F}return y}toObject(){return{type:this.type,scaleX:this.scaleX,scaleY:this.scaleY,resizeType:this.resizeType,lanczosLobes:this.lanczosLobes}}static async fromObject(t){return new vi(t)}}const kl={type:"Resize",resizeType:"hermite",scaleX:1,scaleY:1,lanczosLobes:3,fragmentSourceTOP:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform vec2 uDelta;
    varying vec2 vTexCoord;
  `};Object.assign(vi.prototype,kl),$.setClass(vi);class wi extends at{applyTo2d({imageData:{data:t}}){if(this.saturation===0)return;const e=-this.saturation;for(let i=0;i<t.length;i+=4){const s=Math.max(t[i],t[i+1],t[i+2]);t[i]+=s!==t[i]?(s-t[i])*e:0,t[i+1]+=s!==t[i+1]?(s-t[i+1])*e:0,t[i+2]+=s!==t[i+2]?(s-t[i+2])*e:0}}getUniformLocations(t,e){return{uSaturation:t.getUniformLocation(e,"uSaturation")}}sendUniformData(t,e){t.uniform1f(e.uSaturation,-this.saturation)}static async fromObject(t){return new wi(t)}}const Ol={type:"Saturation",fragmentSource:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uSaturation;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      float rgMax = max(color.r, color.g);
      float rgbMax = max(rgMax, color.b);
      color.r += rgbMax != color.r ? (rgbMax - color.r) * uSaturation : 0.00;
      color.g += rgbMax != color.g ? (rgbMax - color.g) * uSaturation : 0.00;
      color.b += rgbMax != color.b ? (rgbMax - color.b) * uSaturation : 0.00;
      gl_FragColor = color;
    }
  `,saturation:0,mainParameter:"saturation"};Object.assign(wi.prototype,Ol),$.setClass(wi);class Ci extends at{applyTo2d({imageData:{data:t}}){if(this.vibrance===0)return;const e=-this.vibrance;for(let i=0;i<t.length;i+=4){const s=Math.max(t[i],t[i+1],t[i+2]),o=(t[i]+t[i+1]+t[i+2])/3,l=Math.abs(s-o)*2/255*e;t[i]+=s!==t[i]?(s-t[i])*l:0,t[i+1]+=s!==t[i+1]?(s-t[i+1])*l:0,t[i+2]+=s!==t[i+2]?(s-t[i+2])*l:0}}getUniformLocations(t,e){return{uVibrance:t.getUniformLocation(e,"uVibrance")}}sendUniformData(t,e){t.uniform1f(e.uVibrance,-this.vibrance)}static async fromObject(t){return new Ci(t)}}const El={type:"Vibrance",fragmentSource:`
    precision highp float;
    uniform sampler2D uTexture;
    uniform float uVibrance;
    varying vec2 vTexCoord;
    void main() {
      vec4 color = texture2D(uTexture, vTexCoord);
      float max = max(color.r, max(color.g, color.b));
      float avg = (color.r + color.g + color.b) / 3.0;
      float amt = (abs(max - avg) * 2.0) * uVibrance;
      color.r += max != color.r ? (max - color.r) * amt : 0.00;
      color.g += max != color.g ? (max - color.g) * amt : 0.00;
      color.b += max != color.b ? (max - color.b) * amt : 0.00;
      gl_FragColor = color;
    }
  `,vibrance:0,mainParameter:"vibrance"};Object.assign(Ci.prototype,El),$.setClass(Ci);const Dl=(a,t,e)=>a.rotate(e,t);class bi{constructor(t){this.options=t,this.strokeProjectionMagnitude=this.options.strokeWidth/2,this.scale=new T(this.options.scaleX,this.options.scaleY),this.strokeUniformScalar=this.options.strokeUniform?new T(1/this.options.scaleX,1/this.options.scaleY):new T(1,1)}static getAcuteAngleFactor(t,e){const i=e?$i(t,e):ol(t);return Math.abs(i)<he?-1:1}createSideVector(t,e){const i=ii(t,e);return this.options.strokeUniform?i.multiply(this.scale):i}projectOrthogonally(t,e,i){return this.applySkew(t.add(this.calcOrthogonalProjection(t,e,i)))}isSkewed(){return this.options.skewX!==0||this.options.skewY!==0}applySkew(t){const e=new T(t);return e.y+=e.x*Math.tan(ot(this.options.skewY)),e.x+=e.y*Math.tan(ot(this.options.skewX)),e}scaleUnitVector(t,e){return t.multiply(this.strokeUniformScalar).scalarMultiply(e)}}class on extends bi{constructor(t,e,i,s){super(s),this.A=new T(t),this.B=new T(e),this.C=new T(i),this.bisector=this.options.strokeUniform?As(this.A.multiply(this.scale),this.B.multiply(this.scale),this.C.multiply(this.scale)):As(this.A,this.B,this.C)}get bisectorVector(){return this.bisector.vector}get bisectorAngle(){return this.bisector.angle}calcOrthogonalProjection(t,e,i=this.strokeProjectionMagnitude){const s=this.createSideVector(t,e),o=Nr(s),l=bi.getAcuteAngleFactor(o,this.bisectorVector);return this.scaleUnitVector(o,i*l)}projectBevel(){return[this.B,this.C].map(t=>this.projectOrthogonally(this.A,t))}projectMiter(){const t=Math.abs(this.bisectorAngle),e=1/Math.sin(t/2),i=this.scaleUnitVector(this.bisectorVector,-this.strokeProjectionMagnitude*e),s=this.options.strokeUniform?e:this.options.strokeMiterLimit;return Vr(i)/this.strokeProjectionMagnitude<=s?[this.applySkew(this.A.add(i))]:this.projectBevel()}projectRoundNoSkew(){const t=new T(bi.getAcuteAngleFactor(this.bisectorVector),bi.getAcuteAngleFactor(new T(this.bisectorVector.y,this.bisectorVector.x))),e=new T(1,0).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar).multiply(t),i=new T(0,1).scalarMultiply(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar).multiply(t);return[this.A.add(e),this.A.add(i)]}projectRoundWithSkew(){const t=[];[this.B,this.C].forEach(p=>t.push(this.projectOrthogonally(this.A,p)));const{skewX:e,skewY:i}=this.options,s=new T().scalarAdd(this.strokeProjectionMagnitude).multiply(this.strokeUniformScalar),o=s.y/Math.sqrt(1+Math.tan(ot(i))**2),l=new T(Math.sqrt(s.x**2-(o*s.x/s.y)**2),o),c=s.x/Math.sqrt(1+Math.tan(ot(e))**2);return[new T(c,Math.sqrt(o**2-(c*o/s.x)**2)),l].forEach(p=>{t.push(this.applySkew(this.A.add(p)),this.applySkew(this.A.subtract(p)))}),t}projectRound(){return this.isSkewed()?this.projectRoundWithSkew():this.projectRoundNoSkew()}projectPoints(){switch(this.options.strokeLineJoin){case"miter":return this.projectMiter();case"round":return this.projectRound();default:return this.projectBevel()}}project(){return this.projectPoints().map(t=>({originPoint:this.A,projectedPoint:t,bisector:this.bisector}))}}class Ml extends bi{constructor(t,e,i){super(i),this.A=new T(t),this.T=new T(e)}calcOrthogonalProjection(t,e,i=this.strokeProjectionMagnitude){const s=this.createSideVector(t,e);return this.scaleUnitVector(Nr(s),i)}projectButt(){return[this.projectOrthogonally(this.A,this.T,this.strokeProjectionMagnitude),this.projectOrthogonally(this.A,this.T,-this.strokeProjectionMagnitude)]}projectRound(){return new on(this.A,this.T,this.T,this.options).projectRound()}projectSquare(){const t=this.calcOrthogonalProjection(this.A,this.T,this.strokeProjectionMagnitude),e=this.scaleUnitVector(zi(ii(this.A,this.T)),-this.strokeProjectionMagnitude),i=this.A.add(e);return[i.add(t),i.subtract(t)].map(s=>this.applySkew(s))}projectPoints(){switch(this.options.strokeLineCap){case"round":return this.projectRound();case"square":return this.projectSquare();default:return this.projectButt()}}project(){return this.projectPoints().map(t=>({originPoint:this.A,projectedPoint:t}))}}const an=(a,t,e=!1)=>{const i=[];return a.length<=1||a.forEach((s,o)=>{let l,c;o===0?(c=a[1],l=e?s:a[a.length-1]):o===a.length-1?(l=a[o-1],c=e?s:a[0]):(l=a[o-1],c=a[o+1]),e&&(o===0||o===a.length-1)?i.push(...new Ml(s,o===0?c:l,t).project()):i.push(...new on(s,l,c,t).project())}),i},Vi=(a,t,e=!1)=>a.fill!==t.fill||a.stroke!==t.stroke||a.strokeWidth!==t.strokeWidth||a.fontSize!==t.fontSize||a.fontFamily!==t.fontFamily||a.fontWeight!==t.fontWeight||a.fontStyle!==t.fontStyle||a.textBackgroundColor!==t.textBackgroundColor||a.deltaY!==t.deltaY||e&&(a.overline!==t.overline||a.underline!==t.underline||a.linethrough!==t.linethrough),ln=(a,t)=>{const e=t.split(`
`),i=[];let s=-1,o={};a=ri(a,!0);for(let l=0;l<e.length;l++){if(!a[l]){s+=e[l].length;continue}for(let c=0;c<e[l].length;c++){s++;const u=a[l][c];u&&Object.keys(u).length>0&&(Vi(o,u,!0)?i.push({start:s,end:s+1,style:u}):i[i.length-1].end++),o=u||{}}}return i},hn=(a,t)=>{if(!Array.isArray(a))return ri(a,!0);const e=t.split(`
`),i={};let s=-1,o=0;for(let l=0;l<e.length;l++)for(let c=0;c<e[l].length;c++)s++,a[o]&&a[o].start<=s&&s<a[o].end&&(i[l]=i[l]||{},i[l][c]=Object.assign({},a[o].style),s===a[o].end-1&&o++);return i};class Se extends _t{constructor(t){super(t),this._initRxRy()}_initRxRy(){const{rx:t,ry:e}=this;t&&!e?this.ry=t:e&&!t&&(this.rx=e)}_render(t){const{width:e,height:i}=this,s=-e/2,o=-i/2,l=this.rx?Math.min(this.rx,e/2):0,c=this.ry?Math.min(this.ry,i/2):0,u=l!==0||c!==0;t.beginPath(),t.moveTo(s+l,o),t.lineTo(s+e-l,o),u&&t.bezierCurveTo(s+e-ce*l,o,s+e,o+ce*c,s+e,o+c),t.lineTo(s+e,o+i-c),u&&t.bezierCurveTo(s+e,o+i-ce*c,s+e-ce*l,o+i,s+e-l,o+i),t.lineTo(s+l,o+i),u&&t.bezierCurveTo(s+ce*l,o+i,s,o+i-ce*c,s,o+i-c),t.lineTo(s,o+c),u&&t.bezierCurveTo(s,o+ce*c,s+ce*l,o,s+l,o),t.closePath(),this._renderPaintInOrder(t)}toObject(t=[]){return super.toObject(["rx","ry",...t])}_toSVG(){const{width:t,height:e,rx:i,ry:s}=this;return["<rect ","COMMON_PARTS",`x="${-t/2}" y="${-e/2}" rx="${i}" ry="${s}" width="${t}" height="${e}" />
`]}static fromElement(t,e,i={}){if(!t)return e(null);const s=te(t,this.ATTRIBUTE_NAMES),{left:o=0,top:l=0,width:c=0,height:u=0,visible:p=!0}=s,m=pt(s,["left","top","width","height","visible"]),v=new this(Object.assign(Object.assign(Object.assign({},i),m),{left:o,top:l,width:c,height:u,visible:!!(p&&c&&u)}));e(v)}}Se.ATTRIBUTE_NAMES=[...le,"x","y","rx","ry","width","height"];const Al={stateProperties:Rt.stateProperties.concat("rx","ry"),type:"rect",rx:0,ry:0,cacheProperties:Rt.cacheProperties.concat("rx","ry")};Object.assign(Se.prototype,Al),$.setClass(Se),$.setSVGClass(Se);class oe extends Ts(_t){constructor(t=[],e={},i){super(),this._activeObjects=[],this._objects=t||[],this.__objectMonitor=this.__objectMonitor.bind(this),this.__objectSelectionTracker=this.__objectSelectionMonitor.bind(this,!0),this.__objectSelectionDisposer=this.__objectSelectionMonitor.bind(this,!1),this._firstLayoutDone=!1,this.set(Object.assign(Object.assign({},e),{angle:0,skewX:0,skewY:0})),this.forEachObject(s=>{this.enterGroup(s,!1)}),this._applyLayoutStrategy({type:"initialization",options:e,objectsRelativeToGroup:i})}canEnterGroup(t){return t===this||this.isDescendantOf(t)?(console.error("fabric.Group: circular object trees are not supported, this call has no effect"),!1):this._objects.indexOf(t)!==-1?(console.error("fabric.Group: duplicate objects are not supported inside group, this call has no effect"),!1):!0}_filterObjectsBeforeEnteringGroup(t){return t.filter((e,i,s)=>this.canEnterGroup(e)&&s.indexOf(e)===i)}add(...t){const e=this._filterObjectsBeforeEnteringGroup(t),i=super.add(...e);return this._onAfterObjectsChange("added",e),i}insertAt(t,...e){const i=this._filterObjectsBeforeEnteringGroup(e),s=super.insertAt(t,...i);return this._onAfterObjectsChange("added",i),s}remove(...t){const e=super.remove(...t);return this._onAfterObjectsChange("removed",e),e}_onObjectAdded(t){this.enterGroup(t,!0),this.fire("object:added",{target:t}),t.fire("added",{target:this})}_onRelativeObjectAdded(t){this.enterGroup(t,!1),this.fire("object:added",{target:t}),t.fire("added",{target:this})}_onObjectRemoved(t,e){this.exitGroup(t,e),this.fire("object:removed",{target:t}),t.fire("removed",{target:this})}_onAfterObjectsChange(t,e){this._applyLayoutStrategy({type:t,targets:e}),this._set("dirty",!0)}_onStackOrderChanged(){this._set("dirty",!0)}_set(t,e){const i=this[t];return super._set(t,e),t==="canvas"&&i!==e&&this.forEachObject(s=>{s._set(t,e)}),t==="layout"&&i!==e&&this._applyLayoutStrategy({type:"layout_change",layout:e,prevLayout:i}),t==="interactive"&&this.forEachObject(s=>this._watchObject(e,s)),this}_shouldSetNestedCoords(){return this.subTargetCheck}removeAll(){return this._activeObjects=[],this.remove(...this._objects)}__objectMonitor(t){this._applyLayoutStrategy(Object.assign(Object.assign({},t),{type:"object_modified"})),this._set("dirty",!0)}__objectSelectionMonitor(t,e){const i=e.target;if(t)this._activeObjects.push(i),this._set("dirty",!0);else if(this._activeObjects.length>0){const s=this._activeObjects.indexOf(i);s>-1&&(this._activeObjects.splice(s,1),this._set("dirty",!0))}}_watchObject(t,e){const i=t?"on":"off";t&&this._watchObject(!1,e),e[i]("changed",this.__objectMonitor),e[i]("modified",this.__objectMonitor),e[i]("selected",this.__objectSelectionTracker),e[i]("deselected",this.__objectSelectionDisposer)}enterGroup(t,e){return t.group&&t.group.remove(t),this._enterGroup(t,e),!0}_enterGroup(t,e){e&&We(t,gt(kt(this.calcTransformMatrix()),t.calcTransformMatrix())),this._shouldSetNestedCoords()&&t.setCoords(),t._set("group",this),t._set("canvas",this.canvas),this.interactive&&this._watchObject(!0,t);const i=this.canvas&&this.canvas.getActiveObject&&this.canvas.getActiveObject();i&&(i===t||t.isDescendantOf(i))&&this._activeObjects.push(t)}exitGroup(t,e){this._exitGroup(t,e),t._set("canvas",void 0)}_exitGroup(t,e){t._set("group",void 0),e||(We(t,gt(this.calcTransformMatrix(),t.calcTransformMatrix())),t.setCoords()),this._watchObject(!1,t);const i=this._activeObjects.length>0?this._activeObjects.indexOf(t):-1;i>-1&&this._activeObjects.splice(i,1)}shouldCache(){const t=_t.prototype.shouldCache.call(this);if(t){for(let e=0;e<this._objects.length;e++)if(this._objects[e].willDrawShadow())return this.ownCaching=!1,!1}return t}willDrawShadow(){if(_t.prototype.willDrawShadow.call(this))return!0;for(let t=0;t<this._objects.length;t++)if(this._objects[t].willDrawShadow())return!0;return!1}isOnACache(){return this.ownCaching||!!this.group&&this.group.isOnACache()}drawObject(t){this._renderBackground(t);for(let e=0;e<this._objects.length;e++)this._objects[e].render(t);this._drawClipPath(t,this.clipPath)}isCacheDirty(t){if(super.isCacheDirty(t))return!0;if(!this.statefullCache)return!1;for(let e=0;e<this._objects.length;e++)if(this._objects[e].isCacheDirty(!0)){if(this._cacheCanvas){const i=this.cacheWidth/this.zoomX,s=this.cacheHeight/this.zoomY;this._cacheContext.clearRect(-i/2,-s/2,i,s)}return!0}return!1}setCoords(){super.setCoords(),this._shouldSetNestedCoords()&&this.forEachObject(t=>t.setCoords())}render(t){this._transformDone=!0,super.render(t),this._transformDone=!1}triggerLayout(t){t&&t.layout&&(t.prevLayout=this.layout,this.layout=t.layout),this._applyLayoutStrategy({type:"imperative",context:t})}_adjustObjectPosition(t,e){t.set({left:t.left+e.x,top:t.top+e.y})}_applyLayoutStrategy(t){const e=t.type==="initialization";if(!e&&!this._firstLayoutDone)return;const i=e&&t.options,s=i&&{angle:i.angle||0,skewX:i.skewX||0,skewY:i.skewY||0},o=this.getRelativeCenterPoint();let l=this.getLayoutStrategyResult(this.layout,this._objects.concat(),t),c;if(l){const u=new T(l.centerX,l.centerY);c=o.subtract(u).add(new T(l.correctionX||0,l.correctionY||0)).transform(kt(this.calcOwnMatrix()),!0),this.set({width:l.width,height:l.height}),!t.objectsRelativeToGroup&&this.forEachObject(m=>{this._adjustObjectPosition(m,c)}),!e&&this.layout!=="clip-path"&&this.clipPath&&!this.clipPath.absolutePositioned&&this._adjustObjectPosition(this.clipPath,c),(!u.eq(o)||s)&&(this.setPositionByOrigin(u,"center","center"),s&&this.set(s),this.setCoords())}else if(e)l={centerX:o.x,centerY:o.y,width:this.width,height:this.height},s&&this.set(s);else return;this._firstLayoutDone=!0,this.onLayout(t,l),this.fire("layout",{context:t,result:l,diff:c}),this.group&&this.group._applyLayoutStrategy&&(t.path||(t.path=[]),t.path.push(this),this.group._applyLayoutStrategy(t))}getLayoutStrategyResult(t,e,i){if(t==="fit-content-lazy"&&i.type==="added"&&e.length>i.targets.length){const s=i.targets.concat(this);return this.prepareBoundingBox(t,s,i)}else{if(t==="fit-content"||t==="fit-content-lazy"||t==="fixed"&&(i.type==="initialization"||i.type==="imperative"))return this.prepareBoundingBox(t,e,i);if(t==="clip-path"&&this.clipPath){const s=this.clipPath,o=s._getTransformedDimensions();if(s.absolutePositioned&&(i.type==="initialization"||i.type==="layout_change")){let l=s.getCenterPoint();if(this.group){const c=kt(this.group.calcTransformMatrix());l=ct(l,c)}return{centerX:l.x,centerY:l.y,width:o.x,height:o.y}}else if(!s.absolutePositioned){let l;const c=s.getRelativeCenterPoint(),u=ct(c,this.calcOwnMatrix(),!0);if(i.type==="initialization"||i.type==="layout_change"){const p=this.prepareBoundingBox(t,e,i)||{};return l=new T(p.centerX||0,p.centerY||0),{centerX:l.x+u.x,centerY:l.y+u.y,correctionX:p.correctionX-u.x,correctionY:p.correctionY-u.y,width:s.width,height:s.height}}else return l=this.getRelativeCenterPoint(),{centerX:l.x+u.x,centerY:l.y+u.y,width:o.x,height:o.y}}}else if(t==="svg"&&i.type==="initialization"){const s=this.getObjectsBoundingBox(e,!0)||{};return Object.assign(s,{correctionX:-s.offsetX||0,correctionY:-s.offsetY||0})}}}prepareBoundingBox(t,e,i){return i.type==="initialization"?this.prepareInitialBoundingBox(t,e,i):i.type==="imperative"&&i.context?Object.assign(this.getObjectsBoundingBox(e)||{},i.context):this.getObjectsBoundingBox(e)}prepareInitialBoundingBox(t,e,i){const s=i.options||{},o=typeof s.left=="number",l=typeof s.top=="number",c=typeof s.width=="number",u=typeof s.height=="number";if(o&&l&&c&&u&&i.objectsRelativeToGroup||e.length===0)return;const p=this.getObjectsBoundingBox(e)||{},m=c?this.width:p.width||0,v=u?this.height:p.height||0,y=new T(p.centerX||0,p.centerY||0),b=new T(fe(this.originX),fe(this.originY)),_=new T(m,v),S=this._getTransformedDimensions({width:0,height:0}),k=this._getTransformedDimensions({width:m,height:v,strokeWidth:0}),A=this._getTransformedDimensions({width:p.width,height:p.height,strokeWidth:0}),O=new T(0,0),F=b.scalarAdd(.5),I=k.multiply(F),B=new T(c?A.x/2:I.x,u?A.y/2:I.y),K=new T(o?this.left-(k.x+S.x)*b.x:y.x-B.x,l?this.top-(k.y+S.y)*b.y:y.y-B.y),tt=new T(o?K.x-y.x+A.x*(c?.5:0):-(c?(k.x-S.x)*.5:k.x*F.x),l?K.y-y.y+A.y*(u?.5:0):-(u?(k.y-S.y)*.5:k.y*F.y)).add(O),Z=new T(c?-k.x/2:0,u?-k.y/2:0).add(tt);return{centerX:K.x,centerY:K.y,correctionX:Z.x,correctionY:Z.y,width:_.x,height:_.y}}getObjectsBoundingBox(t,e){if(t.length===0)return null;let i,s;t.forEach((p,m)=>{const v=p.getRelativeCenterPoint();let y=p._getTransformedDimensions().scalarDivide(2);if(p.angle){const S=ot(p.angle),k=Math.abs(Mt(S)),A=Math.abs(Dt(S)),O=y.x*A+y.y*k,F=y.x*k+y.y*A;y=new T(O,F)}const b=v.subtract(y),_=v.add(y);m===0?(i=new T(Math.min(b.x,_.x),Math.min(b.y,_.y)),s=new T(Math.max(b.x,_.x),Math.max(b.y,_.y))):(i.setXY(Math.min(i.x,b.x,_.x),Math.min(i.y,b.y,_.y)),s.setXY(Math.max(s.x,b.x,_.x),Math.max(s.y,b.y,_.y)))});const o=s.subtract(i),l=e?o.scalarDivide(2):i.midPointFrom(s),c=i.transform(this.calcOwnMatrix()),u=l.transform(this.calcOwnMatrix());return{offsetX:c.x,offsetY:c.y,centerX:u.x,centerY:u.y,width:o.x,height:o.y}}onLayout(t,e){}__serializeObjects(t,e){const i=this.includeDefaultValues;return this._objects.filter(function(s){return!s.excludeFromExport}).map(function(s){const o=s.includeDefaultValues;s.includeDefaultValues=i;const l=s[t||"toObject"](e);return s.includeDefaultValues=o,l})}toObject(t=[]){const e=super.toObject(["layout","subTargetCheck","interactive",...t]);return e.objects=this.__serializeObjects("toObject",t),e}toString(){return`#<Group: (${this.complexity()})>`}dispose(){this._activeObjects=[],this.forEachObject(t=>{this._watchObject(!1,t),t.dispose()}),super.dispose()}_createSVGBgRect(t){if(!this.backgroundColor)return"";const e=Se.prototype._toSVG.call(this,t),i=e.indexOf("COMMON_PARTS");return e[i]='for="group" ',e.join("")}_toSVG(t){const e=["<g ","COMMON_PARTS",` >
`],i=this._createSVGBgRect(t);i&&e.push("		",i);for(let s=0;s<this._objects.length;s++)e.push("		",this._objects[s].toSVG(t));return e.push(`</g>
`),e}getSvgStyles(){const t=typeof this.opacity<"u"&&this.opacity!==1?`opacity: ${this.opacity};`:"",e=this.visible?"":" visibility: hidden;";return[t,this.getSvgFilter(),e].join("")}toClipPathSVG(t){const e=[],i=this._createSVGBgRect(t);i&&e.push("	",i);for(let s=0;s<this._objects.length;s++)e.push("	",this._objects[s].toClipPathSVG(t));return this._createBaseClipPathSVGMarkup(e,{reviver:t})}static fromObject(t){var{objects:e=[]}=t,i=pt(t,["objects"]);return Promise.all([je(e),ti(i)]).then(([s,o])=>new this(s,Object.assign(Object.assign({},i),o),!0))}}const cn={type:"group",layout:"fit-content",strokeWidth:0,stateProperties:Rt.stateProperties.concat("layout"),subTargetCheck:!1,interactive:!1};Object.assign(oe.prototype,cn),$.setClass(oe);const Fl=a=>a&&a.length===1?a[0]:new oe(a),Rs=(a=Bt,t=Bt)=>gt(kt(t),a),js=(a,t=Bt,e=Bt)=>a.transform(Rs(t,e)),Ll=(a,t,e,i)=>{if(e!=="child"&&e!=="sibling")throw new Error(`fabric.js: received bad argument ${e}`);if(i!=="child"&&i!=="sibling")throw new Error(`fabric.js: received bad argument ${i}`);if(e===i)return a;const s=t.viewportTransform;return a.transform(i==="child"?kt(s):s)},un=(a,t,e)=>{const i=Rs(t,e);return We(a,gt(i,a.calcOwnMatrix())),i},Rl={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},jl={m:"l",M:"L"},Il=(a,t,e,i,s,o,l,c,u,p,m)=>{const v=Dt(a),y=Mt(a),b=Dt(t),_=Mt(t),S=e*s*b-i*o*_+l,k=i*s*b+e*o*_+c,A=p+u*(-e*s*y-i*o*v),O=m+u*(-i*s*y+e*o*v),F=S+u*(e*s*_+i*o*b),I=k+u*(i*s*_-e*o*b);return["C",A,O,F,I,S,k]},Bl=(a,t,e,i,s,o,l)=>{let c=0,u=0,p=0;const m=Math.PI,v=l*ds,y=Mt(v),b=Dt(v),_=.5*(-b*a-y*t),S=.5*(-b*t+y*a),k=e**2,A=i**2,O=S**2,F=_**2,I=k*A-k*O-A*F;let B=Math.abs(e),K=Math.abs(i);if(I<0){const me=Math.sqrt(1-I/(k*A));B*=me,K*=me}else p=(s===o?-1:1)*Math.sqrt(I/(k*O+A*F));const tt=p*B*S/K,Z=-p*K*_/B,dt=b*tt-y*Z+a*.5,xt=y*tt+b*Z+t*.5;let Nt=dn(1,0,(_-tt)/B,(S-Z)/K),At=dn((_-tt)/B,(S-Z)/K,(-_-tt)/B,(-S-Z)/K);o===0&&At>0?At-=2*m:o===1&&At<0&&(At+=2*m);const Ft=Math.ceil(Math.abs(At/m*2)),ft=new Array(Ft),Pt=At/Ft,ge=8/3*Math.sin(Pt/4)*Math.sin(Pt/4)/Math.sin(Pt/2);let er=Nt+Pt;for(let me=0;me<Ft;me++)ft[me]=Il(Nt,er,b,y,B,K,dt,xt,ge,c,u),c=ft[me][5],u=ft[me][6],Nt=er,er+=Pt;return ft},dn=(a,t,e,i)=>{const s=Math.atan2(t,a),o=Math.atan2(i,e);return o>=s?o-s:2*Math.PI-(s-o)},Wl=a=>a**3,Hl=a=>3*a**2*(1-a),$l=a=>3*a*(1-a)**2,zl=a=>(1-a)**3;function Is(a,t,e,i,s,o,l,c){let u;if(d.cachesBoundsOfCurve&&(u=[...arguments].join(),Le.boundsOfCurveCache[u]))return Le.boundsOfCurveCache[u];const p=Math.sqrt,m=Math.abs,v=[],y=[[],[]];let b=6*a-12*e+6*s,_=-3*a+9*e-9*s+3*l,S=3*e-3*a;for(let I=0;I<2;++I){if(I>0&&(b=6*t-12*i+6*o,_=-3*t+9*i-9*o+3*c,S=3*i-3*t),m(_)<1e-12){if(m(b)<1e-12)continue;const dt=-S/b;0<dt&&dt<1&&v.push(dt);continue}const B=b*b-4*S*_;if(B<0)continue;const K=p(B),tt=(-b+K)/(2*_);0<tt&&tt<1&&v.push(tt);const Z=(-b-K)/(2*_);0<Z&&Z<1&&v.push(Z)}let k=v.length;const A=k,O=pn(a,t,e,i,s,o,l,c);for(;k--;){const{x:I,y:B}=O(v[k]);y[0][k]=I,y[1][k]=B}y[0][A]=a,y[1][A]=t,y[0][A+1]=l,y[1][A+1]=c;const F=[new T(Math.min(...y[0]),Math.min(...y[1])),new T(Math.max(...y[0]),Math.max(...y[1]))];return d.cachesBoundsOfCurve&&(Le.boundsOfCurveCache[u]=F),F}const Vl=(a,t,[e,i,s,o,l,c,u,p]=[])=>{const m=Bl(u-a,p-t,i,s,l,c,o);for(let v=0,y=m.length;v<y;v++)m[v][1]+=a,m[v][2]+=t,m[v][3]+=a,m[v][4]+=t,m[v][5]+=a,m[v][6]+=t;return m},fn=a=>{let t=0,e=0;const i=a.length;let s=0,o=0,l=[],c,u,p;for(let m=0;m<i;++m){let v=!1;const y=a[m].slice(0);switch(y[0]){case"l":y[0]="L",y[1]+=t,y[2]+=e;case"L":t=y[1],e=y[2];break;case"h":y[1]+=t;case"H":y[0]="L",y[2]=e,t=y[1];break;case"v":y[1]+=e;case"V":y[0]="L",e=y[1],y[1]=t,y[2]=e;break;case"m":y[0]="M",y[1]+=t,y[2]+=e;case"M":t=y[1],e=y[2],s=y[1],o=y[2];break;case"c":y[0]="C",y[1]+=t,y[2]+=e,y[3]+=t,y[4]+=e,y[5]+=t,y[6]+=e;case"C":u=y[3],p=y[4],t=y[5],e=y[6];break;case"s":y[0]="S",y[1]+=t,y[2]+=e,y[3]+=t,y[4]+=e;case"S":c==="C"?(u=2*t-u,p=2*e-p):(u=t,p=e),t=y[3],e=y[4],y[0]="C",y[5]=y[3],y[6]=y[4],y[3]=y[1],y[4]=y[2],y[1]=u,y[2]=p,u=y[3],p=y[4];break;case"q":y[0]="Q",y[1]+=t,y[2]+=e,y[3]+=t,y[4]+=e;case"Q":u=y[1],p=y[2],t=y[3],e=y[4];break;case"t":y[0]="T",y[1]+=t,y[2]+=e;case"T":c==="Q"?(u=2*t-u,p=2*e-p):(u=t,p=e),y[0]="Q",t=y[1],e=y[2],y[1]=u,y[2]=p,y[3]=t,y[4]=e;break;case"a":y[0]="A",y[6]+=t,y[7]+=e;case"A":v=!0,l=l.concat(Vl(t,e,y)),t=y[6],e=y[7];break;case"z":case"Z":t=s,e=o;break}v||l.push(y),c=y[0]}return l},Ni=(a,t,e,i)=>Math.sqrt((e-a)**2+(i-t)**2),pn=(a,t,e,i,s,o,l,c)=>u=>{const p=Wl(u),m=Hl(u),v=$l(u),y=zl(u);return new T(l*p+s*m+e*v+a*y,c*p+o*m+i*v+t*y)},gn=a=>a**2,mn=a=>2*a*(1-a),yn=a=>(1-a)**2,Nl=(a,t,e,i,s,o,l,c)=>u=>{const p=gn(u),m=mn(u),v=yn(u),y=3*(v*(e-a)+m*(s-e)+p*(l-s)),b=3*(v*(i-t)+m*(o-i)+p*(c-o));return Math.atan2(b,y)},Xl=(a,t,e,i,s,o)=>l=>{const c=gn(l),u=mn(l),p=yn(l);return new T(s*c+e*u+a*p,o*c+i*u+t*p)},Yl=(a,t,e,i,s,o)=>l=>{const c=1-l,u=2*(c*(e-a)+l*(s-e)),p=2*(c*(i-t)+l*(o-i));return Math.atan2(p,u)},vn=(a,t,e)=>{let i=new T(t,e),s=0;for(let o=1;o<=100;o+=1){const l=a(o/100);s+=Ni(i.x,i.y,l.x,l.y),i=l}return s},wn=(a,t)=>{let e=0,i=0,s={x:a.x,y:a.y},o,l,c=.01,u;const p=a.iterator,m=a.angleFinder;for(;i<t&&c>1e-4;)o=p(e),u=e,l=Ni(s.x,s.y,o.x,o.y),l+i>t?(e-=c,c/=2):(s=o,e+=c,i+=l);return o.angle=m(u),o},Bs=a=>{let t=0,e,i=0,s=0,o=0,l=0,c,u,p;const m=a.length,v=[];for(let y=0;y<m;y++){switch(e=a[y],u={x:i,y:s,command:e[0]},e[0]){case"M":u.length=0,o=i=e[1],l=s=e[2];break;case"L":u.length=Ni(i,s,e[1],e[2]),i=e[1],s=e[2];break;case"C":c=pn(i,s,e[1],e[2],e[3],e[4],e[5],e[6]),p=Nl(i,s,e[1],e[2],e[3],e[4],e[5],e[6]),u.iterator=c,u.angleFinder=p,u.length=vn(c,i,s),i=e[5],s=e[6];break;case"Q":c=Xl(i,s,e[1],e[2],e[3],e[4]),p=Yl(i,s,e[1],e[2],e[3],e[4]),u.iterator=c,u.angleFinder=p,u.length=vn(c,i,s),i=e[3],s=e[4];break;case"Z":case"z":u.destX=o,u.destY=l,u.length=Ni(i,s,o,l),i=o,s=l;break}t+=u.length,v.push(u)}return v.push({length:t,x:i,y:s}),v},Ws=(a,t,e=Bs(a))=>{let i=0;for(;t-e[i].length>0&&i<e.length-2;)t-=e[i].length,i++;const s=e[i],o=t/s.length,l=s.command,c=a[i];let u;switch(l){case"M":return{x:s.x,y:s.y,angle:0};case"Z":case"z":return u=new T(s.x,s.y).lerp(new T(s.destX,s.destY),o),u.angle=Math.atan2(s.destY-s.y,s.destX-s.x),u;case"L":return u=new T(s.x,s.y).lerp(new T(c[1],c[2]),o),u.angle=Math.atan2(c[2]-s.y,c[1]-s.x),u;case"C":return wn(s,t);case"Q":return wn(s,t)}},Cn=a=>{const t=Ho,e="[-+]?(?:\\d*\\.\\d+|\\d+\\.?)(?:[eE][-+]?\\d+)?\\s*",i=`(${e})${Yt}`,s=`([01])${Yt}?`,o=`${i}?${i}?${i}${s}${s}${i}?(${e})`,l=new RegExp(o,"g"),c=[];if(!a||!a.match)return c;const u=a.match(/[mzlhvcsqta][^mzlhvcsqta]*/gi);for(let p=0,m=u.length;p<m;p++){const v=u[p],y=v.slice(1).trim(),b=[];let _=v.charAt(0);const S=[_];if(_.toLowerCase()==="a")for(let O;O=l.exec(y);)for(let F=1;F<O.length;F++)b.push(O[F]);else{let O;for(;O=t.exec(y);)b.push(O[0])}for(let O=0,F=b.length;O<F;O++){const I=parseFloat(b[O]);isNaN(I)||S.push(I)}const k=Rl[_.toLowerCase()],A=jl[_]||_;if(S.length-1>k)for(let O=1,F=S.length;O<F;O+=k)c.push([_].concat(S.slice(O,O+k))),_=A;else c.push(S)}return c},bn=(a,t=0)=>{let e=new T(a[0]),i=new T(a[1]),s=1,o=0;const l=[],c=a.length,u=c>2;u&&(s=a[2].x<i.x?-1:a[2].x===i.x?0:1,o=a[2].y<i.y?-1:a[2].y===i.y?0:1),l.push(["M",e.x-s*t,e.y-o*t]);let p;for(p=1;p<c;p++){if(!e.eq(i)){const m=e.midPointFrom(i);l.push(["Q",e.x,e.y,m.x,m.y])}e=a[p],p+1<a.length&&(i=a[p+1])}return u&&(s=e.x>a[p-2].x?1:e.x===a[p-2].x?0:-1,o=e.y>a[p-2].y?1:e.y===a[p-2].y?0:-1),l.push(["L",e.x+s*t,e.y+o*t]),l},Ul=(a,t,e)=>(e&&(t=gt(t,[1,0,0,1,-e.x,-e.y])),a.map(i=>{const s=i.slice(0);for(let o=1;o<i.length-1;o+=2){const{x:l,y:c}=ct({x:i[o],y:i[o+1]},t);s[o]=l,s[o+1]=c}return s})),Gl=(a,t)=>{const e=Math.PI*2/a;let i=-he;a%2===0&&(i+=e/2);const s=new Array(a+1);for(let o=0;o<a;o++){const l=o*e+i,{x:c,y:u}=new T(Dt(l),Mt(l)).scalarMultiply(t);s[o]=[o===0?"M":"L",c,u]}return s[a]=["Z"],s},Hs=a=>a.map(t=>t.join(" ")).join(" ");function Xi(a,t){const e=a.style;if(e)typeof t=="string"?a.style.cssText+=";"+t:Object.entries(t).forEach(([i,s])=>e.setProperty(i,s));else return}const ql=["touchstart","touchmove","touchend"];function Kl(a){const t=a.changedTouches;return t&&t[0]?t[0]:a}const _n=a=>{const t=a.target,e=Rr(t),i=Kl(a);return new T(i.clientX+e.left,i.clientY+e.top)},Yi=a=>ql.indexOf(a.type)>-1||a.pointerType==="touch",$s=a=>{a.preventDefault(),a.stopPropagation()},zs=(a,t,e,i)=>{i>0&&(t>i?t-=i:t=0,e>i?e-=i:e=0);let s=!0;const{data:o}=a.getImageData(t,e,i*2||1,i*2||1),l=o.length;for(let c=3;c<l;c+=4)if(o[c]>0){s=!1;break}return s},Zl=(a,t)=>{var e;let i=a,s=t;i.inverted&&!s.inverted&&(i=t,s=a),un(s,(e=s.group)===null||e===void 0?void 0:e.calcTransformMatrix(),i.calcTransformMatrix());const o=i.inverted&&s.inverted;return o&&(i.inverted=s.inverted=!1),new oe([i],{clipPath:s,inverted:o})};function xn(a,t={}){const e=t.method?t.method.toUpperCase():"GET",i=t.onComplete||re,s=new(D()).window.XMLHttpRequest,o=t.body||t.parameters,l=t.signal,c=function(){s.abort()},u=function(){l&&l.removeEventListener("abort",c),s.onerror=s.ontimeout=re};if(l&&l.aborted)throw new Error("`options.signal` is in `aborted` state");if(l&&l.addEventListener("abort",c,{once:!0}),s.onreadystatechange=function(){s.readyState===4&&(u(),i(s),s.onreadystatechange=re)},s.onerror=s.ontimeout=u,e==="GET"&&t.parameters){const{origin:p,pathname:m,searchParams:v}=new URL(a);a=`${p}${m}?${new URLSearchParams([...Array.from(v.entries()),...Object.entries(t.parameters)])}`}return s.open(e,a,!0),(e==="POST"||e==="PUT")&&s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),s.send(e==="GET"?null:o),s}const Ui="not-allowed",Jl=(a,t,e,i)=>{if(!t||!a)return"drag";const s=i.controls[t];return s.getActionName(e,s,i)};function Pn(a){return a.originX==="center"&&a.originY==="center"}function Sn(a){return-fe(a)+.5}const Zt=(a,t)=>a[t],Tn=(a,t,e,i)=>({e:a,transform:t,pointer:new T(e,i)});function kn(a,t){const e=a.getTotalAngle(),i=e+Fe(Math.atan2(t.y,t.x))+360;return Math.round(i%360/45)}function Ql(a,t,e,i){const s=a.getRelativeCenterPoint(),o=typeof e<"u"&&typeof i<"u"?a.translateToGivenOrigin(s,"center","center",e,i):new T(a.left,a.top);return(a.angle?t.rotate(-ot(a.angle),s):t).subtract(o)}function Gi({target:a,corner:t},e,i,s,o){var l;const c=a.controls[t],u=((l=a.canvas)===null||l===void 0?void 0:l.getZoom())||1,p=a.padding/u,m=Ql(a,new T(s,o),e,i);return m.x>=p&&(m.x-=p),m.x<=-p&&(m.x+=p),m.y>=p&&(m.y-=p),m.y<=p&&(m.y+=p),m.x-=c.offsetX,m.y-=c.offsetY,m}const On=(a,t)=>{var e;const{transform:{target:i}}=t;(e=i.canvas)===null||e===void 0||e.fire(`object:${a}`,Object.assign(Object.assign({},t),{target:i})),i.fire(a,t)},Te=(a,t)=>((e,i,s,o)=>{const l=t(e,i,s,o);return l&&On(a,Tn(e,i,s,o)),l});function ke(a){return((t,e,i,s)=>{const{target:o,originX:l,originY:c}=e,u=o.getRelativeCenterPoint(),p=o.translateToOriginPoint(u,l,c),m=a(t,e,i,s);return o.setPositionByOrigin(p,l,c),m})}const Vs=Te("resizing",ke((a,t,e,i)=>{const s=Gi(t,t.originX,t.originY,e,i);if(t.originX==="center"||t.originX==="right"&&s.x<0||t.originX==="left"&&s.x>0){const{target:o}=t,l=o.strokeWidth/(o.strokeUniform?o.scaleX:1),c=Pn(t)?2:1,u=o.width,p=Math.ceil(Math.abs(s.x*c/o.scaleX)-l);return o.set("width",Math.max(p,0)),u!==o.width}return!1}));function En(a,t,e,i,s){i=i||{};const o=this.sizeX||i.cornerSize||s.cornerSize,l=this.sizeY||i.cornerSize||s.cornerSize,c=typeof i.transparentCorners<"u"?i.transparentCorners:s.transparentCorners,u=c?"stroke":"fill",p=!c&&(i.cornerStrokeColor||s.cornerStrokeColor);let m=t,v=e,y;a.save(),a.fillStyle=i.cornerColor||s.cornerColor||"",a.strokeStyle=i.cornerStrokeColor||s.cornerStrokeColor||"",o>l?(y=o,a.scale(1,l/o),v=e*o/l):l>o?(y=l,a.scale(o/l,1),m=t*l/o):y=o,a.lineWidth=1,a.beginPath(),a.arc(m,v,y/2,0,ve,!1),a[u](),p&&a.stroke(),a.restore()}function Dn(a,t,e,i,s){i=i||{};const o=this.sizeX||i.cornerSize||s.cornerSize,l=this.sizeY||i.cornerSize||s.cornerSize,c=typeof i.transparentCorners<"u"?i.transparentCorners:s.transparentCorners,u=c?"stroke":"fill",p=!c&&(i.cornerStrokeColor||s.cornerStrokeColor),m=o/2,v=l/2;a.save(),a.fillStyle=i.cornerColor||s.cornerColor||"",a.strokeStyle=i.cornerStrokeColor||s.cornerStrokeColor||"",a.lineWidth=1,a.translate(t,e);const y=s.getTotalAngle();a.rotate(ot(y)),a[`${u}Rect`](-m,-v,o,l),p&&a.strokeRect(-m,-v,o,l),a.restore()}const Mn=(a,t,e,i)=>{const{target:s,offsetX:o,offsetY:l}=t,c=e-o,u=i-l,p=!Zt(s,"lockMovementX")&&s.left!==c,m=!Zt(s,"lockMovementY")&&s.top!==u;return p&&s.set("left",c),m&&s.set("top",u),(p||m)&&On("moving",Tn(a,t,e,i)),p||m},An=(a,t,e)=>e.lockRotation?Ui:t.cursorStyle,Fn=Te("rotating",ke((a,{target:t,ex:e,ey:i,theta:s,originX:o,originY:l},c,u)=>{const p=t.translateToOriginPoint(t.getRelativeCenterPoint(),o,l);if(Zt(t,"lockRotation"))return!1;const m=Math.atan2(i-p.y,e-p.x),v=Math.atan2(u-p.y,c-p.x);let y=Fe(v-m+s);if(t.snapAngle&&t.snapAngle>0){const _=t.snapAngle,S=t.snapThreshold||_,k=Math.ceil(y/_)*_,A=Math.floor(y/_)*_;Math.abs(y-A)<S?y=A:Math.abs(y-k)<S&&(y=k)}y<0&&(y=360+y),y%=360;const b=t.angle!==y;return t.angle=y,b}));function Ln(a,t){const e=t.canvas,i=a[e.uniScaleKey];return e.uniformScaling&&!i||!e.uniformScaling&&i}function Rn(a,t,e){const i=Zt(a,"lockScalingX"),s=Zt(a,"lockScalingY");return!!(i&&s||!t&&(i||s)&&e||i&&t==="x"||s&&t==="y")}const th=["e","se","s","sw","w","nw","n","ne","e"],He=(a,t,e)=>{const i=Ln(a,e),s=t.x!==0&&t.y===0?"x":t.x===0&&t.y!==0?"y":"";if(Rn(e,s,i))return Ui;const o=kn(e,t);return`${th[o]}-resize`};function Ns(a,t,e,i,s={}){const o=t.target,l=s.by,c=Ln(a,o),u=Rn(o,l,c);let p,m,v,y,b,_;if(u)return!1;if(t.gestureScale)m=t.scaleX*t.gestureScale,v=t.scaleY*t.gestureScale;else{if(p=Gi(t,t.originX,t.originY,e,i),b=l!=="y"?Math.sign(p.x||t.signX||1):1,_=l!=="x"?Math.sign(p.y||t.signY||1):1,t.signX||(t.signX=b),t.signY||(t.signY=_),Zt(o,"lockScalingFlip")&&(t.signX!==b||t.signY!==_))return!1;if(y=o._getTransformedDimensions(),c&&!l){const A=Math.abs(p.x)+Math.abs(p.y),{original:O}=t,F=Math.abs(y.x*O.scaleX/o.scaleX)+Math.abs(y.y*O.scaleY/o.scaleY),I=A/F;m=O.scaleX*I,v=O.scaleY*I}else m=Math.abs(p.x*o.scaleX/y.x),v=Math.abs(p.y*o.scaleY/y.y);Pn(t)&&(m*=2,v*=2),t.signX!==b&&l!=="y"&&(t.originX=Sn(t.originX),m*=-1,t.signX=b),t.signY!==_&&l!=="x"&&(t.originY=Sn(t.originY),v*=-1,t.signY=_)}const S=o.scaleX,k=o.scaleY;return l?(l==="x"&&o.set("scaleX",m),l==="y"&&o.set("scaleY",v)):(!Zt(o,"lockScalingX")&&o.set("scaleX",m),!Zt(o,"lockScalingY")&&o.set("scaleY",v)),S!==o.scaleX||k!==o.scaleY}const eh=(a,t,e,i)=>Ns(a,t,e,i),ih=(a,t,e,i)=>Ns(a,t,e,i,{by:"x"}),sh=(a,t,e,i)=>Ns(a,t,e,i,{by:"y"}),_i=Te("scaling",ke(eh)),jn=Te("scaling",ke(ih)),In=Te("scaling",ke(sh)),Xs={x:{counterAxis:"y",scale:"scaleX",skew:"skewX",lockSkewing:"lockSkewingX",origin:"originX",flip:"flipX"},y:{counterAxis:"x",scale:"scaleY",skew:"skewY",lockSkewing:"lockSkewingY",origin:"originY",flip:"flipY"}},rh=["ns","nesw","ew","nwse"],Bn=(a,t,e)=>{if(t.x!==0&&Zt(e,"lockSkewingY")||t.y!==0&&Zt(e,"lockSkewingX"))return Ui;const i=kn(e,t)%4;return`${rh[i]}-resize`};function nh(a,t,e){var{target:i,ex:s,ey:o,skewingSide:l}=t,c=pt(t,["target","ex","ey","skewingSide"]);const{skew:u}=Xs[a],p=e.subtract(new T(s,o)).divide(new T(i.scaleX,i.scaleY))[a],m=i[u],v=c[u],y=Math.tan(ot(v)),b=a==="y"?i._getTransformedDimensions({scaleX:1,scaleY:1,skewX:0}).x:i._getTransformedDimensions({scaleX:1,scaleY:1}).y,_=2*p*l/Math.max(b,1)+y,S=Fe(Math.atan(_));i.set(u,S);const k=m!==i[u];if(k&&a==="y"){const{skewX:A,scaleX:O}=i,F=i._getTransformedDimensions({skewY:m}),I=i._getTransformedDimensions(),B=A!==0?F.x/I.x:1;B!==1&&i.set("scaleX",B*O)}return k}function Wn(a,t,e,i,s){const{target:o}=e,{counterAxis:l,origin:c,lockSkewing:u,skew:p,flip:m}=Xs[a];if(Zt(o,u))return!1;const{origin:v,flip:y}=Xs[l],b=fe(e[v])*(o[y]?-1:1),_=-Math.sign(b)*(o[m]?-1:1),S=(o[p]===0&&Gi(e,"center","center",i,s)[a]>0||o[p]>0?1:-1)*_,k=-S*.5+.5;return Te("skewing",ke((O,F,I,B)=>nh(a,F,new T(I,B))))(t,Object.assign(Object.assign({},e),{[c]:k,skewingSide:_}),i,s)}const Hn=(a,t,e,i)=>Wn("x",a,t,e,i),$n=(a,t,e,i)=>Wn("y",a,t,e,i);function qi(a,t){return a[t.canvas.altActionKey]}const xi=(a,t,e)=>{const i=qi(a,e);return t.x===0?i?"skewX":"scaleY":t.y===0?i?"skewY":"scaleX":""},Oe=(a,t,e)=>qi(a,e)?Bn(a,t,e):He(a,t,e),Ys=(a,t,e,i)=>qi(a,t.target)?$n(a,t,e,i):jn(a,t,e,i),Us=(a,t,e,i)=>qi(a,t.target)?Hn(a,t,e,i):In(a,t,e,i);class Pi extends oe{constructor(t,e,i){super(t,e,i),this.setCoords()}_shouldSetNestedCoords(){return!0}enterGroup(t,e){if(t.group){const i=t.group;i._exitGroup(t),t.__owningGroup=i}return this._enterGroup(t,e),!0}exitGroup(t,e){this._exitGroup(t,e);const i=t.__owningGroup;i&&(i.enterGroup(t),delete t.__owningGroup)}_onAfterObjectsChange(t,e){super._onAfterObjectsChange(t,e);const i=[];e.forEach(s=>{s.group&&!i.includes(s.group)&&i.push(s.group)}),t==="removed"?i.forEach(s=>{s._onAfterObjectsChange("added",e)}):i.forEach(s=>{s._set("dirty",!0)})}onDeselect(){return this.removeAll(),!1}toString(){return`#<ActiveSelection: (${this.complexity()})>`}shouldCache(){return!1}isOnACache(){return!1}_renderControls(t,e,i){t.save(),t.globalAlpha=this.isMoving?this.borderOpacityWhenMoving:1,super._renderControls(t,e);const s=Object.assign(Object.assign({hasControls:!1},i),{forActiveSelection:!0});for(let o=0;o<this._objects.length;o++)this._objects[o]._renderControls(t,s);t.restore()}}const oh=Object.assign(Object.assign({},cn),{type:"activeSelection",layout:"fit-content",subTargetCheck:!1,interactive:!1});Object.assign(Pi.prototype,oh),$.setClass(Pi);class zn extends de{constructor(t,e={}){super(t,e),this.interactive=!0,this.targets=[],this._hoveredTargets=[],this._objectsToRender=[],this._currentTransform=null,this._groupSelector=null,this.contextTopDirty=!1}_init(t,e={}){this.renderAndResetBound=this.renderAndReset.bind(this),this.requestRenderAllBound=this.requestRenderAll.bind(this),this._initStatic(t,e),this._applyCanvasStyle(this.lowerCanvasEl),this._initWrapperElement(),this._createUpperCanvas(),this._initEventListeners(),this._isRetinaScaling()&&this._initRetinaScaling(),this.calcOffset(),this._createCacheCanvas()}_initRetinaScaling(){super._initRetinaScaling(),this.__initRetinaScaling(this.upperCanvasEl,this.contextTop)}_onObjectAdded(t){this._objectsToRender=void 0,super._onObjectAdded(t)}_onObjectRemoved(t){this._objectsToRender=void 0,t===this._activeObject&&(this.fire("before:selection:cleared",{deselected:[t]}),this._discardActiveObject(),this.fire("selection:cleared",{deselected:[t]}),t.fire("deselected",{target:t})),t===this._hoveredTarget&&(this._hoveredTarget=void 0,this._hoveredTargets=[]),super._onObjectRemoved(t)}_chooseObjectsToRender(){const t=this.getActiveObjects();let e,i;if(!this.preserveObjectStacking&&t.length>1){e=[],i=[];for(let s=0,o=this._objects.length;s<o;s++){const l=this._objects[s];t.indexOf(l)===-1?e.push(l):i.push(l)}t.length>1&&Bi(this._activeObject)&&(this._activeObject._objects=i),e.push(...i)}else if(!this.preserveObjectStacking&&t.length===1){const s=t[0],o=s.getAncestors(!0),l=o.length===0?s:o.pop();e=this._objects.slice(),e.indexOf(l)>-1&&e.splice(e.indexOf(l),1),e.push(l)}else e=this._objects;return e}renderAll(){this.cancelRequestedRender(),!this.destroyed&&(this.contextTopDirty&&!this._groupSelector&&!this.isDrawingMode&&(this.clearContext(this.contextTop),this.contextTopDirty=!1),this.hasLostContext&&(this.renderTopLayer(this.contextTop),this.hasLostContext=!1),!this._objectsToRender&&(this._objectsToRender=this._chooseObjectsToRender()),this.renderCanvas(this.contextContainer,this._objectsToRender))}renderTopLayer(t){t.save(),this.isDrawingMode&&this._isCurrentlyDrawing&&(this.freeDrawingBrush&&this.freeDrawingBrush._render(),this.contextTopDirty=!0),this.selection&&this._groupSelector&&(this._drawSelection(t),this.contextTopDirty=!0),t.restore()}renderTop(){const t=this.contextTop;this.clearContext(t),this.renderTopLayer(t),this.fire("after:render",{ctx:t})}_normalizePointer(t,e){return ct(this.restorePointerVpt(e),kt(t.calcTransformMatrix()))}isTargetTransparent(t,e,i){if(Ja(t)&&t!==this._activeObject){const c=this._normalizePointer(t,new T(e,i)),u=Math.max(t.cacheTranslationX+c.x*t.zoomX,0),p=Math.max(t.cacheTranslationY+c.y*t.zoomY,0);return zs(t._cacheContext,Math.round(u),Math.round(p),this.targetFindTolerance)}const s=this.contextCache,o=t.selectionBackgroundColor,l=this.viewportTransform;return t.selectionBackgroundColor="",this.clearContext(s),s.save(),s.transform(l[0],l[1],l[2],l[3],l[4],l[5]),t.render(s),s.restore(),t.selectionBackgroundColor=o,zs(s,e,i,this.targetFindTolerance)}_isSelectionKeyPressed(t){const e=this.selectionKey;return e?Array.isArray(e)?!!e.find(i=>!!i&&t[i]===!0):t[e]:!1}_shouldClearSelection(t,e){const i=this.getActiveObjects(),s=this._activeObject;return!!(!e||e&&s&&i.length>1&&i.indexOf(e)===-1&&s!==e&&!this._isSelectionKeyPressed(t)||e&&!e.evented||e&&!e.selectable&&s&&s!==e)}_shouldCenterTransform(t,e,i){if(!t)return;let s;return e==="scale"||e==="scaleX"||e==="scaleY"||e==="resizing"?s=this.centeredScaling||t.centeredScaling:e==="rotate"&&(s=this.centeredRotation||t.centeredRotation),s?!i:i}_getOriginFromCorner(t,e){const i={x:t.originX,y:t.originY};return["ml","tl","bl"].includes(e)?i.x="right":["mr","tr","br"].includes(e)&&(i.x="left"),["tl","mt","tr"].includes(e)?i.y="bottom":["bl","mb","br"].includes(e)&&(i.y="top"),i}_setupCurrentTransform(t,e,i){if(!e)return;const s=e.group?js(this.getPointer(t),void 0,e.group.calcTransformMatrix()):this.getPointer(t),o=e.__corner||"",l=e.controls[o],c=i&&o?l.getActionHandler(t,e,l):Mn,u=Jl(i,o,t,e),p=this._getOriginFromCorner(e,o),m=t[this.centeredKey],v={target:e,action:u,actionHandler:c,actionPerformed:!1,corner:o,scaleX:e.scaleX,scaleY:e.scaleY,skewX:e.skewX,skewY:e.skewY,offsetX:s.x-e.left,offsetY:s.y-e.top,originX:p.x,originY:p.y,ex:s.x,ey:s.y,lastX:s.x,lastY:s.y,theta:ot(e.angle),width:e.width,height:e.height,shiftKey:t.shiftKey,altKey:m,original:Object.assign(Object.assign({},Es(e)),{originX:p.x,originY:p.y})};this._shouldCenterTransform(e,u,m)&&(v.originX="center",v.originY="center"),this._currentTransform=v,this._beforeTransform(t)}setCursor(t){this.upperCanvasEl.style.cursor=t}_drawSelection(t){const{ex:e,ey:i,left:s,top:o}=this._groupSelector,l=new T(e,i).transform(this.viewportTransform),c=new T(e+s,i+o).transform(this.viewportTransform),u=this.selectionLineWidth/2;let p=Math.min(l.x,c.x),m=Math.min(l.y,c.y),v=Math.max(l.x,c.x),y=Math.max(l.y,c.y);this.selectionColor&&(t.fillStyle=this.selectionColor,t.fillRect(p,m,v-p,y-m)),!(!this.selectionLineWidth||!this.selectionBorderColor)&&(t.lineWidth=this.selectionLineWidth,t.strokeStyle=this.selectionBorderColor,p+=u,m+=u,v-=u,y-=u,_t.prototype._setLineDash.call(this,t,this.selectionDashArray),t.strokeRect(p,m,v-p,y-m))}findTarget(t,e=!1){if(this.skipTargetFind)return;const i=this.getPointer(t,!0),s=this._activeObject,o=this.getActiveObjects(),l=Yi(t),c=o.length>1&&!e||o.length===1;if(this.targets=[],s&&c&&s._findTargetCorner(i,l)||o.length>1&&Wi(s)&&!e&&this.searchPossibleTargets([s],i))return s;let u,p=[];if(s&&o.length===1&&s===this.searchPossibleTargets([s],i))if(this.preserveObjectStacking)u=s,p=this.targets,this.targets=[];else return s;const m=this.searchPossibleTargets(this._objects,i);return t[this.altSelectionKey]&&m&&u&&m!==u?(this.targets=p,u):m}_checkTarget(t,e,i){if(e&&e.visible&&e.evented&&e.containsPoint(t))if((this.perPixelTargetFind||e.perPixelTargetFind)&&!e.isEditing){if(!this.isTargetTransparent(e,i.x,i.y))return!0}else return!0;return!1}_searchPossibleTargets(t,e){let i,s=t.length;for(;s--;){const o=t[s],l=o.group?this._normalizePointer(o.group,e):e;if(this._checkTarget(l,o,e)){if(i=t[s],Bi(i)&&i.subTargetCheck){const c=this._searchPossibleTargets(i._objects,e);c&&this.targets.push(c)}break}}return i}searchPossibleTargets(t,e){const i=this._searchPossibleTargets(t,e);return i&&Bi(i)&&i.interactive&&this.targets[0]?this.targets[0]:i}restorePointerVpt(t){return t.transform(kt(this.viewportTransform))}getPointer(t,e=!1){if(this._absolutePointer&&!e)return this._absolutePointer;if(this._pointer&&e)return this._pointer;const i=this.upperCanvasEl,s=i.getBoundingClientRect();let o=_n(t),l=s.width||0,c=s.height||0;(!l||!c)&&("top"in s&&"bottom"in s&&(c=Math.abs(s.top-s.bottom)),"right"in s&&"left"in s&&(l=Math.abs(s.right-s.left))),this.calcOffset(),o.x=o.x-this._offset.left,o.y=o.y-this._offset.top,e||(o=this.restorePointerVpt(o));const u=this.getRetinaScaling();u!==1&&(o.x/=u,o.y/=u);const p=l===0||c===0?new T(1,1):new T(i.width/l,i.height/c);return o.multiply(p)}setDimensions(t,e){this._resetTransformEventData(),super.setDimensions(t,e),this._isCurrentlyDrawing&&this.freeDrawingBrush&&this.freeDrawingBrush._setBrushStyles(this.contextTop)}_setBackstoreDimension(t,e){super._setBackstoreDimension(t,e),this.upperCanvasEl[t]=e,this.cacheCanvasEl[t]=e}_setCssDimension(t,e){super._setCssDimension(t,e),this.upperCanvasEl.style[t]=e,this.wrapperEl.style[t]=e}_createUpperCanvas(){const t=this.lowerCanvasEl;this.upperCanvasEl||(this.upperCanvasEl=this._createCanvasElement());const e=this.upperCanvasEl;e.className=t.className,e.classList.remove("lower-canvas"),e.classList.add("upper-canvas"),e.setAttribute("data-fabric","top"),this.wrapperEl.appendChild(e),e.style.cssText=t.style.cssText,this._applyCanvasStyle(e),e.setAttribute("draggable","true"),this.contextTop=e.getContext("2d")}_createCacheCanvas(){this.cacheCanvasEl=this._createCanvasElement(),this.cacheCanvasEl.setAttribute("width",`${this.width}`),this.cacheCanvasEl.setAttribute("height",`${this.height}`),this.contextCache=this.cacheCanvasEl.getContext("2d")}_initWrapperElement(){if(this.wrapperEl)return;const t=D().document.createElement("div");t.classList.add(this.containerClass),this.wrapperEl=Lr(this.lowerCanvasEl,t),this.wrapperEl.setAttribute("data-fabric","wrapper"),Xi(this.wrapperEl,{width:`${this.width}px`,height:`${this.height}px`,position:"relative"}),ks(this.wrapperEl)}_applyCanvasStyle(t){const e=this.width||t.width,i=this.height||t.height;Xi(t,{position:"absolute",width:e+"px",height:i+"px",left:0,top:0,"touch-action":this.allowTouchScrolling?"manipulation":"none","-ms-touch-action":this.allowTouchScrolling?"manipulation":"none"}),t.width=e,t.height=i,ks(t)}getTopContext(){return this.contextTop}getSelectionContext(){return this.contextTop}getSelectionElement(){return this.upperCanvasEl}getActiveObject(){return this._activeObject}getActiveObjects(){const t=this._activeObject;return t?Wi(t)?[...t._objects]:[t]:[]}_fireSelectionEvents(t,e){let i=!1,s=!1;const o=this.getActiveObjects(),l=[],c=[];t.forEach(u=>{o.includes(u)||(i=!0,u.fire("deselected",{e,target:u}),c.push(u))}),o.forEach(u=>{t.includes(u)||(i=!0,u.fire("selected",{e,target:u}),l.push(u))}),t.length>0&&o.length>0?(s=!0,i&&this.fire("selection:updated",{e,selected:l,deselected:c})):o.length>0?(s=!0,this.fire("selection:created",{e,selected:l})):t.length>0&&(s=!0,this.fire("selection:cleared",{e,deselected:c})),s&&(this._objectsToRender=void 0)}setActiveObject(t,e){const i=this.getActiveObjects();this._setActiveObject(t,e),this._fireSelectionEvents(i,e)}_setActiveObject(t,e){return this._activeObject===t||!this._discardActiveObject(e,t)||t.onSelect({e})?!1:(this._activeObject=t,!0)}_discardActiveObject(t,e){const i=this._activeObject;if(i){if(i.onDeselect({e:t,object:e}))return!1;this._currentTransform&&this._currentTransform.target===i&&this.endCurrentTransform(t),this._activeObject=void 0}return!0}discardActiveObject(t){const e=this.getActiveObjects(),i=this.getActiveObject();e.length&&this.fire("before:selection:cleared",{e:t,deselected:[i]}),this._discardActiveObject(t),this._fireSelectionEvents(e,t)}destroy(){const t=this.wrapperEl,e=this.lowerCanvasEl,i=this.upperCanvasEl,s=this.cacheCanvasEl;this.removeListeners(),super.destroy(),t.removeChild(i),t.removeChild(e),this._iTextInstances=[],this.contextCache=null,this.contextTop=null,Je(i),this.upperCanvasEl=void 0,Je(s),this.cacheCanvasEl=void 0,t.parentNode&&t.parentNode.replaceChild(e,t),this.wrapperEl=void 0}clear(){this.discardActiveObject(),this.clearContext(this.contextTop),this._hasITextHandlers&&(this.off("mouse:up",this._mouseUpITextHandler),this._iTextInstances=[],this._hasITextHandlers=!1),super.clear()}drawControls(t){const e=this._activeObject;e&&e._renderControls(t)}_toObject(t,e,i){const s=this._realizeGroupTransformOnObject(t),o=super._toObject(t,e,i);return t.set(s),o}_realizeGroupTransformOnObject(t){if(t.group&&Wi(t.group)&&this._activeObject===t.group){const i=Ie(t,["angle","flipX","flipY","left","scaleX","scaleY","skewX","skewY","top"]);return Hr(t,this._activeObject.calcOwnMatrix()),i}else return{}}_setSVGObject(t,e,i){const s=this._realizeGroupTransformOnObject(e);super._setSVGObject(t,e,i),e.set(s)}setViewportTransform(t){this.renderOnAddRemove&&Br(this._activeObject)&&this._activeObject.isEditing&&this._activeObject.clearContextTop(),super.setViewportTransform(t)}}Object.assign(zn.prototype,{uniformScaling:!0,uniScaleKey:"shiftKey",centeredScaling:!1,centeredRotation:!1,centeredKey:"altKey",altActionKey:"shiftKey",selection:!0,selectionKey:"shiftKey",altSelectionKey:null,selectionColor:"rgba(100, 100, 255, 0.3)",selectionDashArray:[],selectionBorderColor:"rgba(255, 255, 255, 0.3)",selectionLineWidth:1,selectionFullyContained:!1,hoverCursor:"move",moveCursor:"move",defaultCursor:"default",freeDrawingCursor:"crosshair",notAllowedCursor:"not-allowed",containerClass:"canvas-container",perPixelTargetFind:!1,targetFindTolerance:0,skipTargetFind:!1,preserveObjectStacking:!1,stopContextMenu:!1,fireRightClick:!1,fireMiddleClick:!1,enablePointerEvents:!1});const Ki=3,Zi=2,Vn=1,Vt={passive:!1};function Ji(a,t){return!!a.button&&a.button===t-1}const pe=(a,...t)=>a.addEventListener(...t),Ut=(a,...t)=>a.removeEventListener(...t),ah={mouse:{in:"over",out:"out",targetIn:"mouseover",targetOut:"mouseout",canvasIn:"mouse:over",canvasOut:"mouse:out"},drag:{in:"enter",out:"leave",targetIn:"dragenter",targetOut:"dragleave",canvasIn:"drag:enter",canvasOut:"drag:leave"}};class Qi extends zn{_initEventListeners(){this.removeListeners(),this._bindEvents(),this.addOrRemove(pe,"add")}_getEventPrefix(){return this.enablePointerEvents?"pointer":"mouse"}addOrRemove(t,e){const i=this.upperCanvasEl,s=this._getEventPrefix();t(D().window,"resize",this._onResize),t(i,s+"down",this._onMouseDown),t(i,`${s}move`,this._onMouseMove,Vt),t(i,`${s}out`,this._onMouseOut),t(i,`${s}enter`,this._onMouseEnter),t(i,"wheel",this._onMouseWheel),t(i,"contextmenu",this._onContextMenu),t(i,"dblclick",this._onDoubleClick),t(i,"dragstart",this._onDragStart),t(i,"dragend",this._onDragEnd),t(i,"dragover",this._onDragOver),t(i,"dragenter",this._onDragEnter),t(i,"dragleave",this._onDragLeave),t(i,"drop",this._onDrop),this.enablePointerEvents||t(i,"touchstart",this._onTouchStart,Vt)}removeListeners(){this.addOrRemove(Ut,"remove");const t=this._getEventPrefix();Ut(D().document,`${t}up`,this._onMouseUp),Ut(D().document,"touchend",this._onTouchEnd,Vt),Ut(D().document,`${t}move`,this._onMouseMove,Vt),Ut(D().document,"touchmove",this._onMouseMove,Vt)}_bindEvents(){this.eventsBound||(["_onMouseDown","_onTouchStart","_onMouseMove","_onMouseUp","_onTouchEnd","_onResize","_onMouseWheel","_onMouseOut","_onMouseEnter","_onContextMenu","_onDoubleClick","_onDragStart","_onDragEnd","_onDragProgress","_onDragOver","_onDragEnter","_onDragLeave","_onDrop"].forEach(t=>{this[t]=this[t].bind(this)}),this.eventsBound=!0)}_onMouseWheel(t){this.__onMouseWheel(t)}_onMouseOut(t){const e=this._hoveredTarget,i={e:t,isClick:!1,pointer:this.getPointer(t),absolutePointer:this.getPointer(t,!0)};this.fire("mouse:out",Object.assign(Object.assign({},i),{target:e})),this._hoveredTarget=void 0,e&&e.fire("mouseout",Object.assign({},i)),this._hoveredTargets.forEach(s=>{this.fire("mouse:out",Object.assign(Object.assign({},i),{target:s})),s&&s.fire("mouseout",Object.assign({},i))}),this._hoveredTargets=[]}_onMouseEnter(t){!this._currentTransform&&!this.findTarget(t)&&(this.fire("mouse:over",{e:t,isClick:!1,pointer:this.getPointer(t),absolutePointer:this.getPointer(t,!0)}),this._hoveredTarget=void 0,this._hoveredTargets=[])}_onDragStart(t){const e=this.getActiveObject();if(Qa(e)&&e.onDragStart(t)){this._dragSource=e;const i={e:t,target:e};this.fire("dragstart",i),e.fire("dragstart",i),pe(this.upperCanvasEl,"drag",this._onDragProgress);return}$s(t)}_renderDragEffects(t,e,i){const s=this.contextTop;e&&(e.clearContextTop(!0),e.renderDragSourceEffect(t)),i&&(i!==e&&(s.restore(),s.save(),i.clearContextTop(!0)),i.renderDropTargetEffect(t)),s.restore()}_onDragEnd(t){const e=!!t.dataTransfer&&t.dataTransfer.dropEffect!=="none",i=e?this._activeObject:void 0,s={e:t,target:this._dragSource,subTargets:this.targets,dragSource:this._dragSource,didDrop:e,dropTarget:i};Ut(this.upperCanvasEl,"drag",this._onDragProgress),this.fire("dragend",s),this._dragSource&&this._dragSource.fire("dragend",s),delete this._dragSource,this._onMouseUp(t)}_onDragProgress(t){const e={e:t,target:this._dragSource,dragSource:this._dragSource,dropTarget:this._draggedoverTarget};this.fire("drag",e),this._dragSource&&this._dragSource.fire("drag",e)}_onDragOver(t){const e="dragover",i=this.findTarget(t),s=this.targets,o={e:t,target:i,subTargets:s,dragSource:this._dragSource,canDrop:!1,dropTarget:void 0};let l;this.fire(e,o),this._fireEnterLeaveEvents(i,o),i&&(i.canDrop(t)&&(l=i),i.fire(e,o));for(let c=0;c<s.length;c++){const u=s[c];!t.defaultPrevented&&u.canDrop(t)&&(l=u),u.fire(e,o)}this._renderDragEffects(t,this._dragSource,l)}_onDragEnter(t){const e=this.findTarget(t),i={e:t,target:e,subTargets:this.targets,dragSource:this._dragSource};this.fire("dragenter",i),this._fireEnterLeaveEvents(e,i)}_onDragLeave(t){const e={e:t,target:this._draggedoverTarget,subTargets:this.targets,dragSource:this._dragSource};this.fire("dragleave",e),this._fireEnterLeaveEvents(void 0,e),this.targets=[],this._hoveredTargets=[]}_onDrop(t){const e=this._simpleEventHandler("drop:before",{e:t,dragSource:this._dragSource,pointer:this.getPointer(t)});e.didDrop=!1,e.dropTarget=void 0,this._basicEventHandler("drop",e),this.fire("drop:after",e)}_onContextMenu(t){const e=this._simpleEventHandler("contextmenu:before",{e:t});return this.stopContextMenu&&$s(t),this._basicEventHandler("contextmenu",e),!1}_onDoubleClick(t){this._cacheTransformEventData(t),this._handleEvent(t,"dblclick"),this._resetTransformEventData()}getPointerId(t){const e=t.changedTouches;return e?e[0]&&e[0].identifier:this.enablePointerEvents?t.pointerId:-1}_isMainEvent(t){return t.isPrimary===!0?!0:t.isPrimary===!1?!1:t.type==="touchend"&&t.touches.length===0?!0:t.changedTouches?t.changedTouches[0].identifier===this.mainTouchId:!0}_onTouchStart(t){t.preventDefault(),this.mainTouchId===null&&(this.mainTouchId=this.getPointerId(t)),this.__onMouseDown(t),this._resetTransformEventData();const e=this.upperCanvasEl,i=this._getEventPrefix();pe(D().document,"touchend",this._onTouchEnd,Vt),pe(D().document,"touchmove",this._onMouseMove,Vt),Ut(e,i+"down",this._onMouseDown)}_onMouseDown(t){this.__onMouseDown(t),this._resetTransformEventData();const e=this.upperCanvasEl,i=this._getEventPrefix();Ut(e,`${i}move`,this._onMouseMove,Vt),pe(D().document,`${i}up`,this._onMouseUp),pe(D().document,`${i}move`,this._onMouseMove,Vt)}_onTouchEnd(t){if(t.touches.length>0)return;this.__onMouseUp(t),this._resetTransformEventData(),this.mainTouchId=null;const e=this._getEventPrefix();Ut(D().document,"touchend",this._onTouchEnd,Vt),Ut(D().document,"touchmove",this._onMouseMove,Vt),this._willAddMouseDown&&clearTimeout(this._willAddMouseDown),this._willAddMouseDown=setTimeout(()=>{pe(this.upperCanvasEl,e+"down",this._onMouseDown),this._willAddMouseDown=0},400)}_onMouseUp(t){this.__onMouseUp(t),this._resetTransformEventData();const e=this.upperCanvasEl,i=this._getEventPrefix();this._isMainEvent(t)&&(Ut(D().document,`${i}up`,this._onMouseUp),Ut(D().document,`${i}move`,this._onMouseMove,Vt),pe(e,`${i}move`,this._onMouseMove,Vt))}_onMouseMove(t){const e=this.getActiveObject();!this.allowTouchScrolling&&(!e||!e.__isDragging)&&t.preventDefault&&t.preventDefault(),this.__onMouseMove(t)}_onResize(){this.calcOffset(),this._resetTransformEventData()}_shouldRender(t){const e=this.getActiveObject();return!!e!=!!t||e&&t&&e!==t?!0:(Br(e),!1)}__onMouseUp(t){const e=this._currentTransform,i=this._groupSelector,s=!i||i.left===0&&i.top===0;this._cacheTransformEventData(t);const o=this._target;if(this._handleEvent(t,"up:before"),Ji(t,Ki)){this.fireRightClick&&this._handleEvent(t,"up",Ki,s);return}if(Ji(t,Zi)){this.fireMiddleClick&&this._handleEvent(t,"up",Zi,s),this._resetTransformEventData();return}if(this.isDrawingMode&&this._isCurrentlyDrawing){this._onMouseUpInDrawingMode(t);return}if(!this._isMainEvent(t))return;let l=!1;if(e&&(this._finalizeCurrentTransform(t),l=e.actionPerformed),!s){const p=o===this._activeObject;this._maybeGroupObjects(t),l||(l=this._shouldRender(o)||!p&&o===this._activeObject)}let c,u;if(o){if(u=o._findTargetCorner(this.getPointer(t,!0),Yi(t)),o.selectable&&o!==this._activeObject&&o.activeOn==="up")this.setActiveObject(o,t),l=!0;else{const p=o.controls[u],m=p&&p.getMouseUpHandler(t,o,p);m&&(c=this.getPointer(t),m(t,e,c.x,c.y))}o.isMoving=!1}if(e&&(e.target!==o||e.corner!==u)){const p=e.target&&e.target.controls[e.corner],m=p&&p.getMouseUpHandler(t,e.target,p);c=c||this.getPointer(t),m&&m(t,e,c.x,c.y)}this._setCursorFromEvent(t,o),this._handleEvent(t,"up",Vn,s),this._groupSelector=null,this._currentTransform=null,o&&(o.__corner=0),l?this.requestRenderAll():s||this.renderTop()}_simpleEventHandler(t,e){var{e:i}=e,s=pt(e,["e"]);const o=this.findTarget(i),l=this.targets||[];return this._basicEventHandler(t,Object.assign({e:i,target:o,subTargets:l},s))}_basicEventHandler(t,e){const{target:i,subTargets:s=[]}=e;this.fire(t,e),i&&i.fire(t,e);for(let o=0;o<s.length;o++)s[o].fire(t,e);return e}_handleEvent(t,e,i=Vn,s=!1){const o=this._target,l=this.targets||[],c={e:t,target:o,subTargets:l,button:i,isClick:s,pointer:this.getPointer(t),absolutePointer:this.getPointer(t,!0),transform:this._currentTransform};e==="up"&&(c.currentTarget=this.findTarget(t),c.currentSubTargets=this.targets),this.fire(`mouse:${e}`,c),o&&o.fire(`mouse${e}`,c);for(let u=0;u<l.length;u++)l[u].fire(`mouse${e}`,c)}endCurrentTransform(t){const e=this._currentTransform;this._finalizeCurrentTransform(t),e&&e.target&&(e.target.isMoving=!1),this._currentTransform=null}_finalizeCurrentTransform(t){const e=this._currentTransform,i=e.target,s={e:t,target:i,transform:e,action:e.action};i._scaling&&(i._scaling=!1),i.setCoords(),(e.actionPerformed||this.stateful&&i.hasStateChanged())&&(this.fire("object:modified",s),i.fire("modified",s))}_onMouseDownInDrawingMode(t){this._isCurrentlyDrawing=!0,this.getActiveObject()&&(this.discardActiveObject(t),this.requestRenderAll());const e=this.getPointer(t);this.freeDrawingBrush&&this.freeDrawingBrush.onMouseDown(e,{e:t,pointer:e}),this._handleEvent(t,"down")}_onMouseMoveInDrawingMode(t){if(this._isCurrentlyDrawing){const e=this.getPointer(t);this.freeDrawingBrush&&this.freeDrawingBrush.onMouseMove(e,{e:t,pointer:e})}this.setCursor(this.freeDrawingCursor),this._handleEvent(t,"move")}_onMouseUpInDrawingMode(t){const e=this.getPointer(t);this.freeDrawingBrush?this._isCurrentlyDrawing=!!this.freeDrawingBrush.onMouseUp({e:t,pointer:e}):this._isCurrentlyDrawing=!1,this._handleEvent(t,"up")}__onMouseDown(t){this._cacheTransformEventData(t),this._handleEvent(t,"down:before");let e=this._target;if(Ji(t,Ki)){this.fireRightClick&&this._handleEvent(t,"down",Ki);return}if(Ji(t,Zi)){this.fireMiddleClick&&this._handleEvent(t,"down",Zi);return}if(this.isDrawingMode){this._onMouseDownInDrawingMode(t);return}if(!this._isMainEvent(t)||this._currentTransform)return;const i=this.getPointer(t,!0);this._previousPointer=i;const s=this._shouldRender(e),o=this._shouldGroup(t,e);if(this._shouldClearSelection(t,e)?this.discardActiveObject(t):o&&(this._handleGrouping(t,e),e=this._activeObject),this.selection&&(!e||!e.selectable&&!e.isEditing&&e!==this._activeObject)){const c=this.getPointer(t);this._groupSelector={ex:c.x,ey:c.y,top:0,left:0}}if(e){const c=e===this._activeObject;e.selectable&&e.activeOn==="down"&&this.setActiveObject(e,t);const u=e._findTargetCorner(this.getPointer(t,!0),Yi(t));if(e===this._activeObject&&(u||!o)){this._setupCurrentTransform(t,e,c);const p=e.controls[u],m=this.getPointer(t),v=p&&p.getMouseDownHandler(t,e,p);v&&v(t,this._currentTransform,m.x,m.y)}}const l=s||o;l&&(this._objectsToRender=void 0),this._handleEvent(t,"down"),l&&this.requestRenderAll()}_resetTransformEventData(){this._target=void 0,this._pointer=void 0,this._absolutePointer=void 0}_cacheTransformEventData(t){this._resetTransformEventData(),this._pointer=this.getPointer(t,!0),this._absolutePointer=this.restorePointerVpt(this._pointer),this._target=this._currentTransform?this._currentTransform.target:this.findTarget(t)}_beforeTransform(t){const e=this._currentTransform;this.stateful&&e.target.saveState(),this.fire("before:transform",{e:t,transform:e})}__onMouseMove(t){if(this._handleEvent(t,"move:before"),this._cacheTransformEventData(t),this.isDrawingMode){this._onMouseMoveInDrawingMode(t);return}if(!this._isMainEvent(t))return;const e=this._groupSelector;if(e){const i=this.getPointer(t);e.left=i.x-e.ex,e.top=i.y-e.ey,this.renderTop()}else if(this._currentTransform)this._transformObject(t);else{const i=this.findTarget(t);this._setCursorFromEvent(t,i),this._fireOverOutEvents(t,i)}this._handleEvent(t,"move"),this._resetTransformEventData()}_fireOverOutEvents(t,e){const i=this._hoveredTarget,s=this._hoveredTargets,o=this.targets,l=Math.max(s.length,o.length);this.fireSyntheticInOutEvents("mouse",{e:t,target:e,oldTarget:i,fireCanvas:!0});for(let c=0;c<l;c++)this.fireSyntheticInOutEvents("mouse",{e:t,target:o[c],oldTarget:s[c]});this._hoveredTarget=e,this._hoveredTargets=this.targets.concat()}_fireEnterLeaveEvents(t,e){const i=this._draggedoverTarget,s=this._hoveredTargets,o=this.targets,l=Math.max(s.length,o.length);this.fireSyntheticInOutEvents("drag",Object.assign(Object.assign({},e),{target:t,oldTarget:i,fireCanvas:!0}));for(let c=0;c<l;c++)this.fireSyntheticInOutEvents("drag",Object.assign(Object.assign({},e),{target:o[c],oldTarget:s[c]}));this._draggedoverTarget=t}fireSyntheticInOutEvents(t,e){var{target:i,oldTarget:s,fireCanvas:o,e:l}=e,c=pt(e,["target","oldTarget","fireCanvas","e"]);const{targetIn:u,targetOut:p,canvasIn:m,canvasOut:v}=ah[t],y=s!==i;if(s&&y){const b=Object.assign(Object.assign({},c),{e:l,target:s,nextTarget:i,isClick:!1,pointer:this.getPointer(l),absolutePointer:this.getPointer(l,!0)});o&&this.fire(m,b),s.fire(p,b)}if(i&&y){const b=Object.assign(Object.assign({},c),{e:l,target:i,previousTarget:s,isClick:!1,pointer:this.getPointer(l),absolutePointer:this.getPointer(l,!0)});o&&this.fire(v,b),i.fire(u,b)}}__onMouseWheel(t){this._cacheTransformEventData(t),this._handleEvent(t,"wheel"),this._resetTransformEventData()}_transformObject(t){const e=this.getPointer(t),i=this._currentTransform,s=i.target,o=s.group?js(e,void 0,s.group.calcTransformMatrix()):e;i.reset=!1,i.shiftKey=t.shiftKey,i.altKey=!!this.centeredKey&&t[this.centeredKey],this._performTransformAction(t,i,o),i.actionPerformed&&this.requestRenderAll()}_performTransformAction(t,e,i){const s=i.x,o=i.y,l=e.action,c=e.actionHandler;let u=!1;c&&(u=c(t,e,s,o)),l==="drag"&&u&&(e.target.isMoving=!0,this.setCursor(e.target.moveCursor||this.moveCursor)),e.actionPerformed=e.actionPerformed||u}_setCursorFromEvent(t,e){if(!e){this.setCursor(this.defaultCursor);return}let i=e.hoverCursor||this.hoverCursor;const s=Wi(this._activeObject)?this._activeObject:null,o=(!s||!s.contains(e))&&e._findTargetCorner(this.getPointer(t,!0));if(!o)e.subTargetCheck&&this.targets.concat().reverse().map(l=>{i=l.hoverCursor||i}),this.setCursor(i);else{const l=e.controls[o];this.setCursor(l.cursorStyleHandler(t,l,e))}}_shouldGroup(t,e){const i=this._activeObject;return!!i&&this._isSelectionKeyPressed(t)&&this.selection&&!!e&&e.selectable&&(i!==e||i.type==="activeSelection")&&!e.isDescendantOf(i)&&!i.isDescendantOf(e)&&!e.onSelect({e:t})}_handleGrouping(t,e){let i=e;const s=this._activeObject;s.__corner||i===s&&(i=this.findTarget(t,!0),!i||!i.selectable)||(s&&s.type==="activeSelection"?this._updateActiveSelection(t,i):this._createActiveSelection(t,i))}_updateActiveSelection(t,e){const i=this._activeObject,s=i.getObjects();e.group===i?(i.remove(e),this._hoveredTarget=e,this._hoveredTargets=this.targets.concat(),i.size()===1&&this._setActiveObject(i.item(0),t)):(i.add(e),this._hoveredTarget=i,this._hoveredTargets=this.targets.concat()),this._fireSelectionEvents(s,t)}_createActiveSelection(t,e){const i=this.getActiveObject(),s=e.isInFrontOf(i)?[i,e]:[e,i];i.isEditing&&i.exitEditing();const o=new Pi(s,{canvas:this});this._hoveredTarget=o,this._setActiveObject(o,t),this._fireSelectionEvents([i],t)}_groupSelectedObjects(t){const e=this._collectObjects(t);if(e.length===1)this.setActiveObject(e[0],t);else if(e.length>1){const i=new Pi(e.reverse(),{canvas:this});this.setActiveObject(i,t)}}_collectObjects(t){const e=[],i=this._groupSelector,s=new T(i.ex,i.ey),o=s.add(new T(i.left,i.top)),l=s.min(o),c=s.max(o),u=!this.selectionFullyContained,p=s.eq(o);for(let m=this._objects.length;m--;){const v=this._objects[m];if(!(!v||!v.selectable||!v.visible)&&(u&&v.intersectsWithRect(l,c,!0)||v.isContainedWithinRect(l,c,!0)||u&&v.containsPoint(l,void 0,!0)||u&&v.containsPoint(c,void 0,!0))&&(e.push(v),p))break}return e.length>1?e.filter(m=>!m.onSelect({e:t})):e}_maybeGroupObjects(t){this.selection&&this._groupSelector&&this._groupSelectedObjects(t),this.setCursor(this.defaultCursor),this._groupSelector=null}cloneWithoutData(){const t=Y();return t.width=this.width,t.height=this.height,new Qi(t)}}Object.assign(Qi.prototype,{eventsBound:!1});function Gs(a){if(!Yo.test(a.nodeName))return{};let t=a.getAttribute("viewBox"),e=1,i=1,s=0,o=0,l,c,u,p,m=a.getAttribute("width"),v=a.getAttribute("height"),y=a.getAttribute("x")||0,b=a.getAttribute("y")||0,_=a.getAttribute("preserveAspectRatio")||"",S=!t||!(t=t.match(Go)),k=!m||!v||m==="100%"||v==="100%",A=S&&k,O={},F="",I=0,B=0;if(O.width=0,O.height=0,O.toBeParsed=A,S&&(y||b)&&a.parentNode&&a.parentNode.nodeName!=="#document"&&(F=" translate("+Wt(y)+" "+Wt(b)+") ",u=(a.getAttribute("transform")||"")+F,a.setAttribute("transform",u),a.removeAttribute("x"),a.removeAttribute("y")),A)return O;if(S)return O.width=Wt(m),O.height=Wt(v),O;if(s=-parseFloat(t[1]),o=-parseFloat(t[2]),l=parseFloat(t[3]),c=parseFloat(t[4]),O.minX=s,O.minY=o,O.viewBoxWidth=l,O.viewBoxHeight=c,k?(O.width=l,O.height=c):(O.width=Wt(m),O.height=Wt(v),e=O.width/l,i=O.height/c),_=ps(_),_.alignX!=="none"&&(_.meetOrSlice==="meet"&&(i=e=e>i?i:e),_.meetOrSlice==="slice"&&(i=e=e>i?e:i),I=O.width-l*e,B=O.height-c*e,_.alignX==="Mid"&&(I/=2),_.alignY==="Mid"&&(B/=2),_.alignX==="Min"&&(I=0),_.alignY==="Min"&&(B=0)),e===1&&i===1&&s===0&&o===0&&y===0&&b===0)return O;if((y||b)&&a.parentNode.nodeName!=="#document"&&(F=" translate("+Wt(y)+" "+Wt(b)+") "),u=F+" matrix("+e+" 0 0 "+i+" "+(s*e+I)+" "+(o*i+B)+") ",a.nodeName==="svg"){for(p=a.ownerDocument.createElementNS(yr,"g");a.firstChild;)p.appendChild(a.firstChild);a.appendChild(p)}else p=a,p.removeAttribute("x"),p.removeAttribute("y"),u=p.getAttribute("transform")+u;return p.setAttribute("transform",u),O}function Nn(a){let t=a.getElementsByTagName("style"),e,i,s={},o;for(e=0,i=t.length;e<i;e++){let l=t[e].textContent;l=l.replace(/\/\*[\s\S]*?\*\//g,""),l.trim()!==""&&(o=l.split("}"),o=o.filter(function(c){return c.trim()}),o.forEach(function(c){const u=c.split("{"),p={},m=u[1].trim(),v=m.split(";").filter(function(y){return y.trim()});for(e=0,i=v.length;e<i;e++){const y=v[e].split(":"),b=y[0].trim(),_=y[1].trim();p[b]=_}c=u[0].trim(),c.split(",").forEach(function(y){y=y.replace(/^svg/i,"").trim(),y!==""&&(s[y]?Object.assign(s[y],p):s[y]=Object.assign({},p))})}))}return s}function Xn(a,t){let e,i=[],s,o,l;for(o=0,l=t.length;o<l;o++)e=t[o],s=a.getElementsByTagName(e),i=i.concat(Array.prototype.slice.call(s));return i}function Yn(a,t){let e;if(a.getElementById&&(e=a.getElementById(t)),e)return e;let i,s,o,l=a.getElementsByTagName("*");for(s=0,o=l.length;s<o;s++)if(i=l[s],t===i.getAttribute("id"))return i}const lh=["gradientTransform","x1","x2","y1","y2","gradientUnits","cx","cy","r","fx","fy"],qs="xlink:href";function Un(a,t){const e=t.getAttribute(qs).slice(1),i=Yn(a,e);if(i&&i.getAttribute(qs)&&Un(a,i),lh.forEach(function(s){i&&!t.hasAttribute(s)&&i.hasAttribute(s)&&t.setAttribute(s,i.getAttribute(s))}),!t.children.length){const s=i.cloneNode(!0);for(;s.firstChild;)t.appendChild(s.firstChild)}t.removeAttribute(qs)}const hh=["linearGradient","radialGradient","svg:linearGradient","svg:radialGradient"];function ch(a){let t=Xn(a,hh),e,i=0,s={};for(i=t.length;i--;)e=t[i],e.getAttribute("xlink:href")&&Un(a,e),s[e.getAttribute("id")]=e;return s}function uh(a,t){for(;a&&(a=a.parentNode);)if(a.nodeName&&t.test(a.nodeName.replace("svg:",""))&&!a.getAttribute("instantiated_by_use"))return!0;return!1}const Gn={x1:0,y1:0,x2:0,y2:0},dh=Object.assign(Object.assign({},Gn),{r1:0,r2:0});function qn(a){return a.nodeName==="linearGradient"||a.nodeName==="LINEARGRADIENT"?"linear":"radial"}function Kn(a){return a.getAttribute("gradientUnits")==="userSpaceOnUse"?"pixels":"percentage"}const fh=/^(\d+\.\d+)%|(\d+)%$/;function Zn(a){return a&&fh.test(a)}function Jn(a,t){const e=typeof a=="number"?a:typeof a=="string"?parseFloat(a)/(Zn(a)?100:1):NaN;return Ce(0,Re(e,t),1)}const ph=/\s*;\s*/,gh=/\s*:\s*/;function mh(a,t){let e,i;const s=a.getAttribute("style");if(s){const l=s.split(ph);l[l.length-1]===""&&l.pop();for(let c=l.length;c--;){const[u,p]=l[c].split(gh).map(m=>m.trim());u==="stop-color"?e=p:u==="stop-opacity"&&(i=p)}}const o=new J(e||a.getAttribute("stop-color")||"rgb(0,0,0)");return{offset:Jn(a.getAttribute("offset"),0),color:o.toRgb(),opacity:Re(parseFloat(i||a.getAttribute("stop-opacity")||""),1)*o.getAlpha()*t}}function yh(a,t){const e=[],i=a.getElementsByTagName("stop"),s=Jn(t,1);for(let o=i.length;o--;)e.push(mh(i[o],s));return e}function vh(a,{width:t,height:e,gradientUnits:i}){let s;return Object.keys(a).reduce((o,l)=>{const c=a[l];return c==="Infinity"?s=1:c==="-Infinity"?s=0:(s=typeof c=="string"?parseFloat(c):c,typeof c=="string"&&Zn(c)&&(s*=.01,i==="pixels"&&((l==="x1"||l==="x2"||l==="r2")&&(s*=t),(l==="y1"||l==="y2")&&(s*=e)))),o[l]=s,o},{})}function Jt(a,t){return a.getAttribute(t)}function wh(a){return{x1:Jt(a,"x1")||0,y1:Jt(a,"y1")||0,x2:Jt(a,"x2")||"100%",y2:Jt(a,"y2")||0}}function Ch(a){return{x1:Jt(a,"fx")||Jt(a,"cx")||"50%",y1:Jt(a,"fy")||Jt(a,"cy")||"50%",r1:0,x2:Jt(a,"cx")||"50%",y2:Jt(a,"cy")||"50%",r2:Jt(a,"r")||"50%"}}function bh(a,t){return vh(qn(a)==="linear"?wh(a):Ch(a),Object.assign(Object.assign({},t),{gradientUnits:Kn(a)}))}class Ks{constructor({type:t="linear",gradientUnits:e="pixels",coords:i,colorStops:s=[],offsetX:o=0,offsetY:l=0,gradientTransform:c,id:u}){this.offsetX=0,this.offsetY=0,this.gradientTransform=null,this.id=u?`${u}_${ne()}`:ne(),this.type=t,this.gradientUnits=e,this.gradientTransform=c||null,this.offsetX=o,this.offsetY=l,this.coords=Object.assign(Object.assign({},this.type==="radial"?dh:Gn),i),this.colorStops=s.slice()}addColorStop(t){for(const e in t){const i=new J(t[e]);this.colorStops.push({offset:parseFloat(e),color:i.toRgb(),opacity:i.getAlpha()})}return this}toObject(t){return Object.assign(Object.assign({},Ie(this,t)),{type:this.type,coords:this.coords,colorStops:this.colorStops,offsetX:this.offsetX,offsetY:this.offsetY,gradientUnits:this.gradientUnits,gradientTransform:this.gradientTransform?this.gradientTransform.concat():this.gradientTransform})}toSVG(t,{additionalTransform:e}={}){const i=[],s=this.gradientTransform?this.gradientTransform.concat():Bt.concat(),o=this.gradientUnits==="pixels"?"userSpaceOnUse":"objectBoundingBox",l=this.colorStops.map(m=>Object.assign({},m)).sort((m,v)=>m.offset-v.offset);let c=-this.offsetX,u=-this.offsetY;o==="objectBoundingBox"?(c/=t.width,u/=t.height):(c+=t.width/2,u+=t.height/2),t.type==="path"&&this.gradientUnits!=="percentage"&&(c-=t.pathOffset.x,u-=t.pathOffset.y),s[4]-=c,s[5]-=u;const p=[`id="SVGID_${this.id}"`,`gradientUnits="${o}"`,`gradientTransform="${e?e+" ":""}${Ge(s)}"`,""].join(" ");if(this.type==="linear"){const{x1:m,y1:v,x2:y,y2:b}=this.coords;i.push("<linearGradient ",p,' x1="',m,'" y1="',v,'" x2="',y,'" y2="',b,`">
`)}else if(this.type==="radial"){const{x1:m,y1:v,x2:y,y2:b,r1:_,r2:S}=this.coords,k=_>S;i.push("<radialGradient ",p,' cx="',k?m:y,'" cy="',k?v:b,'" r="',k?_:S,'" fx="',k?y:m,'" fy="',k?b:v,`">
`),k&&(l.reverse(),l.forEach(O=>{O.offset=1-O.offset}));const A=Math.min(_,S);if(A>0){const O=Math.max(_,S),F=A/O;l.forEach(I=>{I.offset+=F*(1-I.offset)})}}return l.forEach(({color:m,offset:v,opacity:y})=>{i.push("<stop ",'offset="',v*100+"%",'" style="stop-color:',m,typeof y<"u"?";stop-opacity: "+y:";",`"/>
`)}),i.push(this.type==="linear"?"</linearGradient>":"</radialGradient>",`
`),i.join("")}toLive(t){const e=this.coords,i=this.type==="linear"?t.createLinearGradient(e.x1,e.y1,e.x2,e.y2):t.createRadialGradient(e.x1,e.y1,e.r1,e.x2,e.y2,e.r2);return this.colorStops.forEach(({color:s,opacity:o,offset:l})=>{i.addColorStop(l,typeof o<"u"?new J(s).setAlpha(o).toRgba():s)}),i}static fromElement(t,e,i){const s=Kn(t);return new this(Object.assign({id:t.getAttribute("id")||void 0,type:qn(t),coords:bh(t,{width:i.viewBoxWidth||i.width,height:i.viewBoxHeight||i.height}),colorStops:yh(t,i.opacity),gradientUnits:s,gradientTransform:Ii(t.getAttribute("gradientTransform")||"")},s==="pixels"?{offsetX:-e.left,offsetY:-e.top}:{offsetX:0,offsetY:0}))}}$.setClass(Ks,"gradient");const Qn=function(a,t,e,i,s,o){this.elements=a,this.callback=t,this.options=e,this.reviver=i,this.svgUid=e&&e.svgUid||0,this.parsingOptions=s,this.regexUrl=/^url\(['"]?#([^'"]+)['"]?\)/g,this.doc=o};(function(a){a.parse=function(){this.instances=new Array(this.elements.length),this.numElements=this.elements.length,this.createObjects()},a.createObjects=function(){this.elements.forEach((t,e)=>{t.setAttribute("svgUid",this.svgUid),this.createObject(t,e)})},a.findTag=function(t){return $.getSVGClass(t.tagName.toLowerCase().replace("svg:",""))},a.createObject=function(t,e){const i=this.findTag(t);if(i&&i.fromElement)try{i.fromElement(t,this.createCallback(e,t),this.options)}catch(s){console.log(s)}else this.checkIfDone()},a.createCallback=function(t,e){return i=>{let s;this.resolveGradient(i,e,"fill"),this.resolveGradient(i,e,"stroke"),i instanceof Kt&&i._originalElement&&(s=i.parsePreserveAspectRatioAttribute(e)),i._removeTransformMatrix(s),this.resolveClipPath(i,e),this.reviver&&this.reviver(e,i),this.instances[t]=i,this.checkIfDone()}},a.extractPropertyDefinition=function(t,e,i){const s=t[e],o=this.regexUrl;if(!o.test(s))return;o.lastIndex=0;const l=o.exec(s)[1];return o.lastIndex=0,Wo[i][this.svgUid][l]},a.resolveGradient=function(t,e,i){const s=this.extractPropertyDefinition(t,i,"gradientDefs");if(s){const o=e.getAttribute(i+"-opacity"),l=Ks.fromElement(s,t,Object.assign(Object.assign({},this.options),{opacity:o}));t.set(i,l)}},a.createClipPathCallback=function(t,e){return function(i){i._removeTransformMatrix(),i.fillRule=i.clipRule,e.push(i)}},a.resolveClipPath=function(t,e){var i=this.extractPropertyDefinition(t,"clipPath","clipPaths"),s,o,l,c,u;if(i){c=[],l=kt(t.calcTransformMatrix());const p=i[0].parentNode;let m=e;for(;m.parentNode&&m.getAttribute("clip-path")!==t.clipPath;)m=m.parentNode;m.parentNode.appendChild(p);for(let y=0;y<i.length;y++)s=i[y],o=this.findTag(s),o.fromElement(s,this.createClipPathCallback(t,c),this.options);c.length===1?i=c[0]:i=new oe(c),u=gt(l,i.calcTransformMatrix()),i.clipPath&&this.resolveClipPath(i,m);const v=ue(u);i.flipX=!1,i.flipY=!1,i.set("scaleX",v.scaleX),i.set("scaleY",v.scaleY),i.angle=v.angle,i.skewX=v.skewX,i.skewY=0,i.setPositionByOrigin({x:v.translateX,y:v.translateY},"center","center"),t.clipPath=i}else delete t.clipPath},a.checkIfDone=function(){--this.numElements===0&&(this.instances=this.instances.filter(function(t){return t!=null}),this.callback(this.instances,this.elements))}})(Qn.prototype);function to(a,t,e,i,s){new Qn(a,t,e,i,s).parse()}function _h(a){let t=Xn(a,["use","svg:use"]),e=0;for(;t.length&&e<t.length;){const S=t[e],k=S.getAttribute("xlink:href")||S.getAttribute("href");if(k===null)return;var i=k.slice(1),s=S.getAttribute("x")||0,o=S.getAttribute("y")||0,l=Yn(a,i).cloneNode(!0),c=(l.getAttribute("transform")||"")+" translate("+s+", "+o+")",u,p=t.length,m,v,y,b,_=yr;if(Gs(l),/^svg$/i.test(l.nodeName)){const A=l.ownerDocument.createElementNS(_,"g");for(v=0,y=l.attributes,b=y.length;v<b;v++)m=y.item(v),A.setAttributeNS(_,m.nodeName,m.nodeValue);for(;l.firstChild;)A.appendChild(l.firstChild);l=A}for(v=0,y=S.attributes,b=y.length;v<b;v++)m=y.item(v),!(m.nodeName==="x"||m.nodeName==="y"||m.nodeName==="xlink:href"||m.nodeName==="href")&&(m.nodeName==="transform"?c=m.nodeValue+" "+c:l.setAttribute(m.nodeName,m.nodeValue));l.setAttribute("transform",c),l.setAttribute("instantiated_by_use","1"),l.removeAttribute("id"),u=S.parentNode,u.replaceChild(l,S),t.length===p&&e++}}function eo(a,t,e,i){if(!a)return;if(i&&i.signal&&i.signal.aborted)throw new Error("`options.signal` is in `aborted` state");_h(a);let s=ne(),o,l,c=Gs(a),u=Array.from(a.getElementsByTagName("*"));if(c.crossOrigin=i&&i.crossOrigin,c.svgUid=s,c.signal=i&&i.signal,u.length===0&&isLikelyNode){u=a.selectNodes('//*[name(.)!="svg"]');const v=[];for(o=0,l=u.length;o<l;o++)v[o]=u[o];u=v}const p=u.filter(function(v){return Gs(v),wr.test(v.nodeName.replace("svg:",""))&&!uh(v,Uo)});if(!p||p&&!p.length){t&&t([],{});return}const m={};u.filter(function(v){return v.nodeName.replace("svg:","")==="clipPath"}).forEach(function(v){const y=v.getAttribute("id");m[y]=Array.from(v.getElementsByTagName("*")).filter(function(b){return wr.test(b.nodeName.replace("svg:",""))})}),gs[s]=ch(a),Ae[s]=Nn(a),ms[s]=m,to(p,function(v,y){t&&(t(v,c,y,u),delete gs[s],delete Ae[s],delete ms[s])},Object.assign({},c),e,i)}function xh(a,t,e,i){new xn(a.replace(/^\n\s*/,"").trim(),{method:"get",onComplete:s,signal:i&&i.signal});function s(o){const l=o.responseXML;if(!l||!l.documentElement)return t&&t(null),!1;eo(l.documentElement,function(c,u,p,m){t&&t(c,u,p,m)},e,i)}}function Ph(a,t,e,i){const s=new(D()).window.DOMParser,o=s.parseFromString(a.trim(),"text/xml");eo(o.documentElement,function(l,c,u,p){t(l,c,u,p)},e,i)}class Gt{constructor(t){this.visible=!0,this.actionName="scale",this.angle=0,this.x=0,this.y=0,this.offsetX=0,this.offsetY=0,this.sizeX=null,this.sizeY=null,this.touchSizeX=null,this.touchSizeY=null,this.cursorStyle="crosshair",this.withConnection=!1,Object.assign(this,t)}getActionHandler(t,e,i){return this.actionHandler}getMouseDownHandler(t,e,i){return this.mouseDownHandler}getMouseUpHandler(t,e,i){return this.mouseUpHandler}cursorStyleHandler(t,e,i){return e.cursorStyle}getActionName(t,e,i){return e.actionName}getVisibility(t,e){var i,s;return(s=(i=t._controlsVisibility)===null||i===void 0?void 0:i[e])!==null&&s!==void 0?s:this.visible}setVisibility(t,e,i){this.visible=t}positionHandler(t,e,i,s){return new T(this.x*t.x+this.offsetX,this.y*t.y+this.offsetY).transform(e)}calcCornerCoords(t,e,i,s,o){let l,c,u,p;const m=o?this.touchSizeX:this.sizeX,v=o?this.touchSizeY:this.sizeY;if(m&&v&&m!==v){const y=Math.atan2(v,m),b=Math.sqrt(m*m+v*v)/2,_=y-ot(t),S=he-y-ot(t);l=b*Dt(_),c=b*Mt(_),u=b*Dt(S),p=b*Mt(S)}else{const b=(m&&v?m:e)*Math.SQRT1_2,_=ot(45-t);l=u=b*Dt(_),c=p=b*Mt(_)}return{tl:new T(i-p,s-u),tr:new T(i+l,s-c),bl:new T(i-l,s+c),br:new T(i+p,s+u)}}render(t,e,i,s,o){s=s||{},(s.cornerStyle||o.cornerStyle)==="circle"?En.call(this,t,e,i,s,o):Dn.call(this,t,e,i,s,o)}}class Zs{constructor(t={}){this.type="pattern",this.repeat="repeat",this.offsetX=0,this.offsetY=0,this.crossOrigin="",this.patternTransform=null,this.id=ne(),this.setOptions(t)}setOptions(t){for(const e in t)this[e]=t[e]}isImageSource(){return typeof this.source.src=="string"}isCanvasSource(){return typeof this.source=="object"&&this.source.toDataURL}sourceToString(){return this.isImageSource()?this.source.src:this.isCanvasSource()?this.source.toDataURL():""}toLive(t){return!this.source||this.isImageSource()&&(!this.source.complete||this.source.naturalWidth===0||this.source.naturalHeight===0)?"":t.createPattern(this.source,this.repeat)}toObject(t){return Object.assign(Object.assign({},Ie(this,t)),{type:"pattern",source:this.sourceToString(),repeat:this.repeat,crossOrigin:this.crossOrigin,offsetX:it(this.offsetX,d.NUM_FRACTION_DIGITS),offsetY:it(this.offsetY,d.NUM_FRACTION_DIGITS),patternTransform:this.patternTransform?this.patternTransform.concat():null})}toSVG({width:t,height:e}){const i=this.source,s=Re(this.offsetX/t,0),o=Re(this.offsetY/e,0),l=this.repeat==="repeat-y"||this.repeat==="no-repeat"?1+Math.abs(s||0):Re(i.width/t,0),c=this.repeat==="repeat-x"||this.repeat==="no-repeat"?1+Math.abs(o||0):Re(i.height/e,0);return[`<pattern id="SVGID_${this.id}" x="${s}" y="${o}" width="${l}" height="${c}">`,`<image x="0" y="0" width="${i.width}" height="${i.height}" xlink:href="${this.sourceToString()}"></image>`,"</pattern>",""].join(`
`)}static async fromObject(t,e){var{source:i}=t,s=pt(t,["source"]);const o=await Qe(i,Object.assign(Object.assign({},e),{crossOrigin:s.crossOrigin}));return new this(Object.assign(Object.assign({},s),{source:o}))}}$.setClass(Zs,"pattern");class ts{constructor(t){this.color="rgb(0, 0, 0)",this.width=1,this.shadow=null,this.strokeLineCap="round",this.strokeLineJoin="round",this.strokeMiterLimit=10,this.strokeDashArray=null,this.limitedToCanvasSize=!1,this.canvas=t}_setBrushStyles(t){t.strokeStyle=this.color,t.lineWidth=this.width,t.lineCap=this.strokeLineCap,t.miterLimit=this.strokeMiterLimit,t.lineJoin=this.strokeLineJoin,t.setLineDash(this.strokeDashArray||[])}_saveAndTransform(t){const e=this.canvas.viewportTransform;t.save(),t.transform(e[0],e[1],e[2],e[3],e[4],e[5])}needsFullRender(){return new J(this.color).getAlpha()<1||!!this.shadow}_setShadow(){if(!this.shadow||!this.canvas)return;const t=this.canvas,e=this.shadow,i=t.contextTop,s=t.getZoom()*t.getRetinaScaling();i.shadowColor=e.color,i.shadowBlur=e.blur*s,i.shadowOffsetX=e.offsetX*s,i.shadowOffsetY=e.offsetY*s}_resetShadow(){const t=this.canvas.contextTop;t.shadowColor="",t.shadowBlur=t.shadowOffsetX=t.shadowOffsetY=0}_isOutSideCanvas(t){return t.x<0||t.x>this.canvas.getWidth()||t.y<0||t.y>this.canvas.getHeight()}}class $e extends _t{constructor(t,e={}){var{path:i,left:s,top:o}=e,l=pt(e,["path","left","top"]);super(l);const c=this._setPath(t||[]),u=this.translateToGivenOrigin(new T(s??c.x,o??c.y),typeof s=="number"?this.originX:"left",typeof o=="number"?this.originY:"top",this.originX,this.originY);this.setPositionByOrigin(u,this.originX,this.originY)}_setPath(t,e){return this.path=fn(Array.isArray(t)?t:Cn(t)),this.setDimensions()}_renderPathCommands(t){let e,i=0,s=0,o=0,l=0,c=0,u=0;const p=-this.pathOffset.x,m=-this.pathOffset.y;t.beginPath();for(let v=0,y=this.path.length;v<y;++v)switch(e=this.path[v],e[0]){case"L":o=e[1],l=e[2],t.lineTo(o+p,l+m);break;case"M":o=e[1],l=e[2],i=o,s=l,t.moveTo(o+p,l+m);break;case"C":o=e[5],l=e[6],c=e[3],u=e[4],t.bezierCurveTo(e[1]+p,e[2]+m,c+p,u+m,o+p,l+m);break;case"Q":t.quadraticCurveTo(e[1]+p,e[2]+m,e[3]+p,e[4]+m),o=e[3],l=e[4],c=e[1],u=e[2];break;case"z":case"Z":o=i,l=s,t.closePath();break}}_render(t){this._renderPathCommands(t),this._renderPaintInOrder(t)}toString(){return`#<Path (${this.complexity()}): { "top": ${this.top}, "left": ${this.left} }>`}toObject(t=[]){return Object.assign(Object.assign({},super.toObject(t)),{path:this.path.map(e=>e.slice())})}toDatalessObject(t=[]){const e=this.toObject(["sourcePath",...t]);return e.sourcePath&&delete e.path,e}_toSVG(){return["<path ","COMMON_PARTS",`d="${Hs(this.path)}" stroke-linecap="round" />
`]}_getOffsetTransform(){const t=d.NUM_FRACTION_DIGITS;return` translate(${it(-this.pathOffset.x,t)}, ${it(-this.pathOffset.y,t)})`}toClipPathSVG(t){const e=this._getOffsetTransform();return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:t,additionalTransform:e})}toSVG(t){const e=this._getOffsetTransform();return this._createBaseSVGMarkup(this._toSVG(),{reviver:t,additionalTransform:e})}complexity(){return this.path.length}setDimensions(){const{left:t,top:e,width:i,height:s,pathOffset:o}=this._calcDimensions();return this.set({width:i,height:s,pathOffset:o}),new T(t,e)}_calcDimensions(){const t=[];let e=0,i=0,s=0,o=0;for(let u=0;u<this.path.length;++u){const p=this.path[u];switch(p[0]){case"L":s=p[1],o=p[2],t.push(new T(e,i),new T(s,o));break;case"M":s=p[1],o=p[2],e=s,i=o;break;case"C":t.push(...Is(s,o,p[1],p[2],p[3],p[4],p[5],p[6])),s=p[5],o=p[6];break;case"Q":t.push(...Is(s,o,p[1],p[2],p[1],p[2],p[3],p[4])),s=p[3],o=p[4];break;case"z":case"Z":s=e,o=i;break}}const l=Be(t),c=this.fromSVG?0:this.strokeWidth/2;return Object.assign(Object.assign({},l),{left:l.left-c,top:l.top-c,pathOffset:new T(l.left+l.width/2,l.top+l.height/2)})}static fromObject(t){return this._fromObject(t,{extraParam:"path"})}static fromElement(t,e,i){const s=te(t,this.ATTRIBUTE_NAMES);e(new this(s.d,Object.assign(Object.assign(Object.assign({},s),i),{left:void 0,top:void 0,fromSVG:!0})))}}$e.ATTRIBUTE_NAMES=[...le,"d"];const Sh={type:"path",path:null,cacheProperties:Rt.cacheProperties.concat("path","fillRule"),stateProperties:Rt.stateProperties.concat("path")};Object.assign($e.prototype,Sh),$.setClass($e),$.setSVGClass($e);function Th(a){return Hs(a)==="M 0 0 Q 0 0 0 0 L 0 0"}class Si extends ts{constructor(t){super(t),this.decimate=.4,this.drawStraightLine=!1,this.straightLineKey="shiftKey",this._points=[],this._hasStraightLine=!1}needsFullRender(){return super.needsFullRender()||this._hasStraightLine}static drawSegment(t,e,i){const s=e.midPointFrom(i);return t.quadraticCurveTo(e.x,e.y,s.x,s.y),s}onMouseDown(t,{e}){this.canvas._isMainEvent(e)&&(this.drawStraightLine=!!this.straightLineKey&&e[this.straightLineKey],this._prepareForDrawing(t),this._addPoint(t),this._render())}onMouseMove(t,{e}){if(this.canvas._isMainEvent(e)&&(this.drawStraightLine=!!this.straightLineKey&&e[this.straightLineKey],!(this.limitedToCanvasSize===!0&&this._isOutSideCanvas(t))&&this._addPoint(t)&&this._points.length>1))if(this.needsFullRender())this.canvas.clearContext(this.canvas.contextTop),this._render();else{const i=this._points,s=i.length,o=this.canvas.contextTop;this._saveAndTransform(o),this.oldEnd&&(o.beginPath(),o.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=Si.drawSegment(o,i[s-2],i[s-1]),o.stroke(),o.restore()}}onMouseUp({e:t}){return this.canvas._isMainEvent(t)?(this.drawStraightLine=!1,this.oldEnd=void 0,this._finalizeAndAddPath(),!1):!0}_prepareForDrawing(t){this._reset(),this._addPoint(t),this.canvas.contextTop.moveTo(t.x,t.y)}_addPoint(t){return this._points.length>1&&t.eq(this._points[this._points.length-1])?!1:(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(t),!0)}_reset(){this._points=[],this._setBrushStyles(this.canvas.contextTop),this._setShadow(),this._hasStraightLine=!1}_render(t=this.canvas.contextTop){let e=this._points[0],i=this._points[1];if(this._saveAndTransform(t),t.beginPath(),this._points.length===2&&e.x===i.x&&e.y===i.y){const s=this.width/1e3;e.x-=s,i.x+=s}t.moveTo(e.x,e.y);for(let s=1;s<this._points.length;s++)Si.drawSegment(t,e,i),e=this._points[s],i=this._points[s+1];t.lineTo(e.x,e.y),t.stroke(),t.restore()}convertPointsToSVGPath(t){const e=this.width/1e3;return bn(t,e)}createPath(t){const e=new $e(t,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray});return this.shadow&&(this.shadow.affectStroke=!0,e.shadow=new zt(this.shadow)),e}decimatePoints(t,e){if(t.length<=2)return t;let i=t[0],s;const o=this.canvas.getZoom(),l=Math.pow(e/o,2),c=t.length-1,u=[i];for(let p=1;p<c-1;p++)s=Math.pow(i.x-t[p].x,2)+Math.pow(i.y-t[p].y,2),s>=l&&(i=t[p],u.push(i));return u.push(t[c]),u}_finalizeAndAddPath(){this.canvas.contextTop.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate));const e=this.convertPointsToSVGPath(this._points);if(Th(e)){this.canvas.requestRenderAll();return}const i=this.createPath(e);this.canvas.clearContext(this.canvas.contextTop),this.canvas.fire("before:path:created",{path:i}),this.canvas.add(i),this.canvas.requestRenderAll(),i.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:i})}}class ze extends _t{_set(t,e){return super._set(t,e),t==="radius"&&this.setRadius(e),this}_render(t){t.beginPath(),t.arc(0,0,this.radius,ot(this.startAngle),ot(this.endAngle),!1),this._renderPaintInOrder(t)}getRadiusX(){return this.get("radius")*this.get("scaleX")}getRadiusY(){return this.get("radius")*this.get("scaleY")}setRadius(t){this.radius=t,this.set({width:t*2,height:t*2})}toObject(t=[]){return super.toObject(["radius","startAngle","endAngle",...t])}_toSVG(){const t=(this.endAngle-this.startAngle)%360;if(t===0)return["<circle ","COMMON_PARTS",'cx="0" cy="0" ','r="',this.radius,`" />
`];{const{radius:e}=this,i=ot(this.startAngle),s=ot(this.endAngle),o=Dt(i)*e,l=Mt(i)*e,c=Dt(s)*e,u=Mt(s)*e,p=t>180?"1":"0";return[`<path d="M ${o} ${l}`,` A ${e} ${e}`," 0 ",`${p} 1`,` ${c} ${u}`,'" ',"COMMON_PARTS",` />
`]}}static fromElement(t,e){const i=te(t,this.ATTRIBUTE_NAMES),{left:s=0,top:o=0,radius:l}=i,c=pt(i,["left","top","radius"]);if(!l||l<0)throw new Error("value of `r` attribute is required and can not be negative");e(new this(Object.assign(Object.assign({},c),{radius:l,left:s-l,top:o-l})))}}ze.ATTRIBUTE_NAMES=["cx","cy","r",...le];const kh={type:"circle",radius:0,startAngle:0,endAngle:360,stateProperties:Rt.stateProperties.concat("radius","startAngle","endAngle"),cacheProperties:Rt.cacheProperties.concat("radius","startAngle","endAngle")};Object.assign(ze.prototype,kh),$.setClass(ze),$.setSVGClass(ze);class Oh extends ts{constructor(t){super(t),this.width=10,this.points=[]}drawDot(t){const e=this.addPoint(t),i=this.canvas.contextTop;this._saveAndTransform(i),this.dot(i,e),i.restore()}dot(t,e){t.fillStyle=e.fill,t.beginPath(),t.arc(e.x,e.y,e.radius,0,Math.PI*2,!1),t.closePath(),t.fill()}onMouseDown(t){this.points=[],this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.drawDot(t)}_render(){const t=this.canvas.contextTop,e=this.points;this._saveAndTransform(t);for(let i=0;i<e.length;i++)this.dot(t,e[i]);t.restore()}onMouseMove(t){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(t)||(this.needsFullRender()?(this.canvas.clearContext(this.canvas.contextTop),this.addPoint(t),this._render()):this.drawDot(t))}onMouseUp(){const t=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;const e=[];for(let s=0;s<this.points.length;s++){const o=this.points[s],l=new ze({radius:o.radius,left:o.x,top:o.y,originX:"center",originY:"center",fill:o.fill});this.shadow&&(l.shadow=new zt(this.shadow)),e.push(l)}const i=new oe(e,{canvas:this.canvas});this.canvas.fire("before:path:created",{path:i}),this.canvas.add(i),this.canvas.fire("path:created",{path:i}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=t,this.canvas.requestRenderAll()}addPoint({x:t,y:e}){const i={x:t,y:e,radius:be(Math.max(0,this.width-20),this.width+20)/2,fill:new J(this.color).setAlpha(be(0,100)/100).toRgba()};return this.points.push(i),i}}function Eh(a){const t={},e=[];for(let i=0,s;i<a.length;i++)s=`${a[i].left}${a[i].top}`,t[s]||(t[s]=!0,e.push(a[i]));return e}class Dh extends ts{constructor(t){super(t),this.width=10,this.density=20,this.dotWidth=1,this.dotWidthVariance=1,this.randomOpacity=!1,this.optimizeOverlapping=!0,this.sprayChunks=[],this.sprayChunk=[]}onMouseDown(t){this.sprayChunks=[],this.canvas.clearContext(this.canvas.contextTop),this._setShadow(),this.addSprayChunk(t),this.renderChunck(this.sprayChunk)}onMouseMove(t){this.limitedToCanvasSize===!0&&this._isOutSideCanvas(t)||(this.addSprayChunk(t),this.renderChunck(this.sprayChunk))}onMouseUp(){const t=this.canvas.renderOnAddRemove;this.canvas.renderOnAddRemove=!1;const e=[];for(let s=0;s<this.sprayChunks.length;s++){const o=this.sprayChunks[s];for(let l=0;l<o.length;l++){const c=o[l],u=new Se({width:c.width,height:c.width,left:c.x+1,top:c.y+1,originX:"center",originY:"center",fill:this.color});e.push(u)}}const i=new oe(this.optimizeOverlapping?Eh(e):e,{objectCaching:!0,layout:"fixed",subTargetCheck:!1,interactive:!1});this.shadow&&i.set("shadow",new zt(this.shadow)),this.canvas.fire("before:path:created",{path:i}),this.canvas.add(i),this.canvas.fire("path:created",{path:i}),this.canvas.clearContext(this.canvas.contextTop),this._resetShadow(),this.canvas.renderOnAddRemove=t,this.canvas.requestRenderAll()}renderChunck(t){const e=this.canvas.contextTop;e.fillStyle=this.color,this._saveAndTransform(e);for(let i=0;i<t.length;i++){const s=t[i];e.globalAlpha=s.opacity,e.fillRect(s.x,s.y,s.width,s.width)}e.restore()}_render(){const t=this.canvas.contextTop;t.fillStyle=this.color,this._saveAndTransform(t);for(let e=0;e<this.sprayChunks.length;e++)this.renderChunck(this.sprayChunks[e]);t.restore()}addSprayChunk(t){this.sprayChunk=[];const e=this.width/2;for(let i=0;i<this.density;i++)this.sprayChunk.push({x:be(t.x-e,t.x+e),y:be(t.y-e,t.y+e),width:this.dotWidthVariance?be(Math.max(1,this.dotWidth-this.dotWidthVariance),this.dotWidth+this.dotWidthVariance):this.dotWidth,opacity:this.randomOpacity?be(0,100)/100:1});this.sprayChunks.push(this.sprayChunk)}}class Mh extends Si{constructor(t){super(t)}getPatternSrc(){const i=Y(),s=i.getContext("2d");return i.width=i.height=25,s&&(s.fillStyle=this.color,s.beginPath(),s.arc(20/2,20/2,20/2,0,Math.PI*2,!1),s.closePath(),s.fill()),i}getPattern(t){return t.createPattern(this.source||this.getPatternSrc(),"repeat")}_setBrushStyles(t){super._setBrushStyles(t);const e=this.getPattern(t);e&&(t.strokeStyle=e)}createPath(t){const e=super.createPath(t),i=e._getLeftTopCoords().scalarAdd(e.strokeWidth/2);return e.stroke=new Zs({source:this.source||this.getPatternSrc(),offsetX:-i.x,offsetY:-i.y}),e}}const Ah={x1:1,x2:1,y1:1,y2:1};class Ti extends _t{constructor(t,e){t||(t=[0,0,0,0]),super(e),this.set("x1",t[0]),this.set("y1",t[1]),this.set("x2",t[2]),this.set("y2",t[3]),this._setWidthHeight(e)}_setWidthHeight(t){t||(t={}),this.width=Math.abs(this.x2-this.x1),this.height=Math.abs(this.y2-this.y1),this.left="left"in t?t.left:this._getLeftToOriginX(),this.top="top"in t?t.top:this._getTopToOriginY()}_set(t,e){return super._set(t,e),typeof Ah[t]<"u"&&this._setWidthHeight(),this}_render(t){t.beginPath();const e=this.calcLinePoints();t.moveTo(e.x1,e.y1),t.lineTo(e.x2,e.y2),t.lineWidth=this.strokeWidth;const i=t.strokeStyle;t.strokeStyle=this.stroke||t.fillStyle,this.stroke&&this._renderStroke(t),t.strokeStyle=i}_findCenterFromElement(){return{x:(this.x1+this.x2)/2,y:(this.y1+this.y2)/2}}toObject(t){return Object.assign(Object.assign({},super.toObject(t)),this.calcLinePoints())}_getNonTransformedDimensions(){const t=super._getNonTransformedDimensions();return this.strokeLineCap==="butt"&&(this.width===0&&(t.y-=this.strokeWidth),this.height===0&&(t.x-=this.strokeWidth)),t}calcLinePoints(){const t=this.x1<=this.x2?-1:1,e=this.y1<=this.y2?-1:1,i=t*this.width*.5,s=e*this.height*.5,o=t*this.width*-.5,l=e*this.height*-.5;return{x1:i,x2:o,y1:s,y2:l}}makeEdgeToOriginGetter(t,e){const i=t.origin,s=t.axis1,o=t.axis2,l=t.dimension,c=e.nearest,u=e.center,p=e.farthest;switch(this.get(i)){case c:return Math.min(this.get(s),this.get(o));case u:return Math.min(this.get(s),this.get(o))+.5*this.get(l);case p:return Math.max(this.get(s),this.get(o))}}_getLeftToOriginX(){return this.makeEdgeToOriginGetter({origin:"originX",axis1:"x1",axis2:"x2",dimension:"width"},{nearest:"left",center:"center",farthest:"right"})}_getTopToOriginY(){return this.makeEdgeToOriginGetter({origin:"originY",axis1:"y1",axis2:"y2",dimension:"height"},{nearest:"top",center:"center",farthest:"bottom"})}_toSVG(){const t=this.calcLinePoints();return["<line ","COMMON_PARTS",'x1="',t.x1,'" y1="',t.y1,'" x2="',t.x2,'" y2="',t.y2,`" />
`]}static fromElement(t,e,i){i=i||{};const s=te(t,this.ATTRIBUTE_NAMES),o=[s.x1||0,s.y1||0,s.x2||0,s.y2||0];e(new this(o,Object.assign(Object.assign({},s),i)))}static fromObject(t){const e=ri(t,!0);return e.points=[t.x1,t.y1,t.x2,t.y2],this._fromObject(e,{extraParam:"points"}).then(i=>(delete i.points,i))}}Ti.ATTRIBUTE_NAMES=le.concat("x1 y1 x2 y2".split(" "));const Fh={type:"line",x1:0,y1:0,x2:0,y2:0,cacheProperties:Rt.cacheProperties.concat("x1","x2","y1","y2")};Object.assign(Ti.prototype,Fh),$.setClass(Ti),$.setSVGClass(Ti);class es extends _t{_render(t){const e=this.width/2,i=this.height/2;t.beginPath(),t.moveTo(-e,i),t.lineTo(0,-i),t.lineTo(e,i),t.closePath(),this._renderPaintInOrder(t)}_toSVG(){const t=this.width/2,e=this.height/2;return["<polygon ","COMMON_PARTS",'points="',`${-t} ${e},0 ${-e},${t} ${e}`,'" />']}}const Lh={type:"triangle",width:100,height:100};Object.assign(es.prototype,Lh),$.setClass(es),$.setSVGClass(es);class ki extends _t{constructor(t){super(t),this.set("rx",t&&t.rx||0),this.set("ry",t&&t.ry||0)}_set(t,e){switch(super._set(t,e),t){case"rx":this.rx=e,this.set("width",e*2);break;case"ry":this.ry=e,this.set("height",e*2);break}return this}getRx(){return this.get("rx")*this.get("scaleX")}getRy(){return this.get("ry")*this.get("scaleY")}toObject(t=[]){return super.toObject(["rx","ry",...t])}_toSVG(){return["<ellipse ","COMMON_PARTS",'cx="0" cy="0" ','rx="',this.rx,'" ry="',this.ry,`" />
`]}_render(t){t.beginPath(),t.save(),t.transform(1,0,0,this.ry/this.rx,0,0),t.arc(0,0,this.rx,0,ve,!1),t.restore(),this._renderPaintInOrder(t)}static fromElement(t,e){const i=te(t,this.ATTRIBUTE_NAMES);i.left=(i.left||0)-i.rx,i.top=(i.top||0)-i.ry,e(new this(i))}}ki.ATTRIBUTE_NAMES=[...le,"cx","cy","rx","ry"];const Rh={type:"ellipse",rx:0,ry:0,cacheProperties:[...Rt.cacheProperties,"rx","ry"]};Object.assign(ki.prototype,Rh),$.setClass(ki),$.setSVGClass(ki);function io(a){if(!a)return null;a=a.replace(/,/g," ").trim(),a=a.split(/\s+/);let t=[],e,i;for(e=0,i=a.length;e<i;e+=2)t.push({x:parseFloat(a[e]),y:parseFloat(a[e+1])});return t}class Ve extends _t{constructor(t=[],e={}){var{left:i,top:s}=e,o=pt(e,["left","top"]);super(Object.assign({points:t},o)),this.initialized=!0,this.setBoundingBox(!0),typeof i=="number"&&this.set("left",i),typeof s=="number"&&this.set("top",s)}isOpen(){return!0}_projectStrokeOnPoints(){return an(this.points,this,this.isOpen())}_calcDimensions(){const t=this.exactBoundingBox?this._projectStrokeOnPoints().map(p=>p.projectedPoint):this.points;if(t.length===0)return{left:0,top:0,width:0,height:0,pathOffset:new T,strokeOffset:new T};const e=Be(t),i=Be(this.points),s=e.left+e.width/2,o=e.top+e.height/2,l=s-o*Math.tan(ot(this.skewX)),c=o-l*Math.tan(ot(this.skewY)),u=!this.fromSVG&&!this.exactBoundingBox?this.strokeWidth/2:0;return Object.assign(Object.assign({},e),{left:e.left-u,top:e.top-u,pathOffset:new T(l,c),strokeOffset:new T(i.left,i.top).subtract(new T(e.left,e.top))})}setDimensions(){this.setBoundingBox()}setBoundingBox(t){const{left:e,top:i,width:s,height:o,pathOffset:l,strokeOffset:c}=this._calcDimensions();this.set({width:s,height:o,pathOffset:l,strokeOffset:c}),t&&this.setPositionByOrigin(new T(e,i),"left","top")}_getNonTransformedDimensions(){return this.exactBoundingBox?new T(this.width,this.height):super._getNonTransformedDimensions()}_getTransformedDimensions(t){return this.exactBoundingBox?super._getTransformedDimensions(Object.assign(Object.assign({},t||{}),{strokeWidth:0,skewX:0,skewY:0})):super._getTransformedDimensions(t)}_set(t,e){const i=this.initialized&&this[t]!==e,s=super._set(t,e);return i&&((t==="scaleX"||t==="scaleY")&&this.strokeUniform&&this.strokeBBoxAffectingProperties.includes("strokeUniform")&&this.strokeLineJoin!=="round"||this.strokeBBoxAffectingProperties.includes(t))&&this.setDimensions(),s}toObject(t){return Object.assign(Object.assign({},super.toObject(t)),{points:this.points.concat()})}_toSVG(){const t=[],e=this.pathOffset.x,i=this.pathOffset.y,s=d.NUM_FRACTION_DIGITS;for(let o=0,l=this.points.length;o<l;o++)t.push(it(this.points[o].x-e,s),",",it(this.points[o].y-i,s)," ");return[`<${this.type} `,"COMMON_PARTS",`points="${t.join("")}" />
`]}_render(t){const e=this.points.length,i=this.pathOffset.x,s=this.pathOffset.y;if(!(!e||isNaN(this.points[e-1].y))){t.beginPath(),t.moveTo(this.points[0].x-i,this.points[0].y-s);for(let o=0;o<e;o++){const l=this.points[o];t.lineTo(l.x-i,l.y-s)}!this.isOpen()&&t.closePath(),this._renderPaintInOrder(t)}}complexity(){return this.points.length}static fromElement(t,e,i){if(!t)return e(null);const s=io(t.getAttribute("points")),o=te(t,this.ATTRIBUTE_NAMES),l=pt(o,["left","top"]);e(new this(s||[],Object.assign(Object.assign(Object.assign({},l),i),{fromSVG:!0})))}static fromObject(t){return this._fromObject(t,{extraParam:"points"})}}Ve.ATTRIBUTE_NAMES=[...le];const so={type:"polyline",exactBoundingBox:!1,cacheProperties:Rt.cacheProperties.concat("points"),strokeBBoxAffectingProperties:["skewX","skewY","strokeLineCap","strokeLineJoin","strokeMiterLimit","strokeWidth","strokeUniform","points"]};Object.assign(Ve.prototype,so),$.setClass(Ve),$.setSVGClass(Ve);class is extends Ve{isOpen(){return!1}}const jh=Object.assign(Object.assign({},so),{type:"polygon"});Object.assign(is.prototype,jh),$.setClass(is),$.setSVGClass(is);class Ih extends _t{isEmptyStyles(t){if(!this.styles||typeof t<"u"&&!this.styles[t])return!0;const e=typeof t>"u"?this.styles:{line:this.styles[t]};for(const i in e)for(const s in e[i])for(const o in e[i][s])return!1;return!0}styleHas(t,e){if(!this.styles||!t||t===""||typeof e<"u"&&!this.styles[e])return!1;const i=typeof e>"u"?this.styles:{0:this.styles[e]};for(const s in i)for(const o in i[s])if(typeof i[s][o][t]<"u")return!0;return!1}cleanStyle(t){if(!this.styles||!t||t==="")return!1;const e=this.styles;let i=0,s,o,l=!0,c=0;for(const u in e){s=0;for(const p in e[u]){const m=e[u][p],v=Object.prototype.hasOwnProperty.call(m,t);i++,v?(o?m[t]!==o&&(l=!1):o=m[t],m[t]===this[t]&&delete m[t]):l=!1,Object.keys(m).length!==0?s++:delete e[u][p]}s===0&&delete e[u]}for(let u=0;u<this._textLines.length;u++)c+=this._textLines[u].length;l&&i===c&&(this[t]=o,this.removeStyle(t))}removeStyle(t){if(!this.styles||!t||t==="")return;const e=this.styles;let i,s,o;for(s in e){i=e[s];for(o in i)delete i[o][t],Object.keys(i[o]).length===0&&delete i[o];Object.keys(i).length===0&&delete e[s]}}_extendStyles(t,e){const{lineIndex:i,charIndex:s}=this.get2DCursorLocation(t);return this._getLineStyle(i)||this._setLineStyle(i),this._getStyleDeclaration(i,s)||this._setStyleDeclaration(i,s,{}),Object.assign(this._getStyleDeclaration(i,s)||{},e)}getSelectionStyles(t,e,i){const s=[];for(let o=t;o<(e||t);o++)s.push(this.getStyleAtPosition(o,i));return s}getStyleAtPosition(t,e){const{lineIndex:i,charIndex:s}=this.get2DCursorLocation(t);return(e?this.getCompleteStyleDeclaration(i,s):this._getStyleDeclaration(i,s))||{}}setSelectionStyles(t,e,i){for(let s=e;s<(i||e);s++)this._extendStyles(s,t);this._forceClearCache=!0}_getStyleDeclaration(t,e){const i=this.styles&&this.styles[t];return i?i[e]:null}getCompleteStyleDeclaration(t,e){const i=this._getStyleDeclaration(t,e)||{},s={};for(let o=0;o<this._styleProperties.length;o++){const l=this._styleProperties[o];s[l]=typeof i[l]>"u"?this[l]:i[l]}return s}_setStyleDeclaration(t,e,i){this.styles[t][e]=i}_deleteStyleDeclaration(t,e){delete this.styles[t][e]}_getLineStyle(t){return!!this.styles[t]}_setLineStyle(t){this.styles[t]={}}_deleteLineStyle(t){delete this.styles[t]}}const Bh=/  +/g,Wh=/"/g;function Js(a,t,e,i,s){return`		${Bo(a,{left:t,top:e,width:i,height:s})}
`}class Hh extends Tr{_toSVG(){const t=this._getSVGLeftTopOffsets(),e=this._getSVGTextAndBg(t.textTop,t.textLeft);return this._wrapSVGTextAndBg(e)}toSVG(t){return this._createBaseSVGMarkup(this._toSVG(),{reviver:t,noStyle:!0,withShadow:!0})}_getSVGLeftTopOffsets(){return{textLeft:-this.width/2,textTop:-this.height/2,lineTop:this.getHeightOfLine(0)}}_wrapSVGTextAndBg({textBgRects:t,textSpans:e}){const s=this.getSvgTextDecoration(this);return[t.join(""),'		<text xml:space="preserve" ',this.fontFamily?`font-family="${this.fontFamily.replace(Wh,"'")}" `:"",this.fontSize?`font-size="${this.fontSize}" `:"",this.fontStyle?`font-style="${this.fontStyle}" `:"",this.fontWeight?`font-weight="${this.fontWeight}" `:"",s?`text-decoration="${s}" `:"",this.direction==="rtl"?`direction="${this.direction}" `:"",'style="',this.getSvgStyles(!0),'"',this.addPaintOrder()," >",e.join(""),`</text>
`]}_getSVGTextAndBg(t,e){const i=[],s=[];let o=t,l;this.backgroundColor&&s.push(...Js(this.backgroundColor,-this.width/2,-this.height/2,this.width,this.height));for(let c=0,u=this._textLines.length;c<u;c++)l=this._getLineLeftOffset(c),this.direction==="rtl"&&(l+=this.width),(this.textBackgroundColor||this.styleHas("textBackgroundColor",c))&&this._setSVGTextLineBg(s,c,e+l,o),this._setSVGTextLineText(i,c,e+l,o),o+=this.getHeightOfLine(c);return{textSpans:i,textBgRects:s}}_createTextCharSpan(t,e,i,s){const o=this.getSvgSpanStyles(e,t!==t.trim()||!!t.match(Bh)),l=o?`style="${o}"`:"",c=e.deltaY,u=c?` dy="${it(c,d.NUM_FRACTION_DIGITS)}" `:"";return`<tspan x="${it(i,d.NUM_FRACTION_DIGITS)}" y="${it(s,d.NUM_FRACTION_DIGITS)}" ${u}${l}>${Yr(t)}</tspan>`}_setSVGTextLineText(t,e,i,s){const o=this.getHeightOfLine(e),l=this.textAlign.indexOf("justify")!==-1,c=this._textLines[e];let u,p,m="",v,y,b=0,_;s+=o*(1-this._fontSizeFraction)/this.lineHeight;for(let S=0,k=c.length-1;S<=k;S++)_=S===k||this.charSpacing,m+=c[S],v=this.__charBounds[e][S],b===0?(i+=v.kernedWidth-v.width,b+=v.width):b+=v.kernedWidth,l&&!_&&this._reSpaceAndTab.test(c[S])&&(_=!0),_||(u=u||this.getCompleteStyleDeclaration(e,S),p=this.getCompleteStyleDeclaration(e,S+1),_=Vi(u,p,!0)),_&&(y=this._getStyleDeclaration(e,S)||{},t.push(this._createTextCharSpan(m,y,i,s)),m="",u=p,this.direction==="rtl"?i-=b:i+=b,b=0)}_setSVGTextLineBg(t,e,i,s){const o=this._textLines[e],l=this.getHeightOfLine(e)/this.lineHeight;let c=0,u=0,p,m,v=this.getValueOfPropertyAt(e,0,"textBackgroundColor");for(let y=0;y<o.length;y++)p=this.__charBounds[e][y],m=this.getValueOfPropertyAt(e,y,"textBackgroundColor"),m!==v?(v&&t.push(...Js(v,i+u,s,c,l)),u=p.left,c=p.width,v=m):c+=p.kernedWidth;m&&t.push(...Js(v,i+u,s,c,l))}_getSVGLineTopOffset(t){let e=0,i=0;for(let s=0;s<t;s++)e+=this.getHeightOfLine(s);return i=this.getHeightOfLine(j),{lineTop:e,offset:(this._fontSizeMult-this._fontSizeFraction)*i/(this.lineHeight*this._fontSizeMult)}}getSvgStyles(t){return`${super.getSvgStyles(t)} white-space: pre;`}}let Qs;function $h(){return Qs||(Qs=Y().getContext("2d")),Qs}const tr=["fontFamily","fontWeight","fontSize","text","underline","overline","linethrough","textAlign","fontStyle","lineHeight","textBackgroundColor","charSpacing","styles","direction","path","pathStartOffset","pathSide","pathAlign"];class Qt extends Ih{constructor(t,e){super(Object.assign(Object.assign({},e),{text:t,styles:e?.styles||{}})),this.__charBounds=[],this.initialized=!0,this.path&&this.setPathInfo(),this.initDimensions(),this.setCoords(),this.saveState({propertySet:"_dimensionAffectingProps"})}setPathInfo(){const t=this.path;t&&(t.segmentsInfo=Bs(t.path))}_splitText(){const t=this._splitTextIntoLines(this.text);return this.textLines=t.lines,this._textLines=t.graphemeLines,this._unwrappedTextLines=t._unwrappedLines,this._text=t.graphemeText,t}initDimensions(){this._splitText(),this._clearCache(),this.path?(this.width=this.path.width,this.height=this.path.height):(this.width=this.calcTextWidth()||this.cursorWidth||this.MIN_TEXT_WIDTH,this.height=this.calcTextHeight()),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.saveState({propertySet:"_dimensionAffectingProps"})}enlargeSpaces(){let t,e,i,s,o,l,c;for(let u=0,p=this._textLines.length;u<p;u++)if(!(this.textAlign!=="justify"&&(u===p-1||this.isEndOfWrapping(u)))&&(s=0,o=this._textLines[u],e=this.getLineWidth(u),e<this.width&&(c=this.textLines[u].match(this._reSpacesAndTabs)))){i=c.length,t=(this.width-e)/i;for(let m=0;m<=o.length;m++)l=this.__charBounds[u][m],this._reSpaceAndTab.test(o[m])?(l.width+=t,l.kernedWidth+=t,l.left+=s,s+=t):l.left+=s}}isEndOfWrapping(t){return t===this._textLines.length-1}missingNewlineOffset(t){return 1}get2DCursorLocation(t,e){const i=e?this._unwrappedTextLines:this._textLines;let s;for(s=0;s<i.length;s++){if(t<=i[s].length)return{lineIndex:s,charIndex:t};t-=i[s].length+this.missingNewlineOffset(s)}return{lineIndex:s-1,charIndex:i[s-1].length<t?i[s-1].length:t}}toString(){return`#<Text (${this.complexity()}): { "text": "${this.text}", "fontFamily": "${this.fontFamily}" }>`}_getCacheCanvasDimensions(){const t=super._getCacheCanvasDimensions(),e=this.fontSize;return t.width+=e*t.zoomX,t.height+=e*t.zoomY,t}_render(t){const e=this.path;e&&!e.isNotVisible()&&e._render(t),this._setTextStyles(t),this._renderTextLinesBackground(t),this._renderTextDecoration(t,"underline"),this._renderText(t),this._renderTextDecoration(t,"overline"),this._renderTextDecoration(t,"linethrough")}_renderText(t){this.paintFirst==="stroke"?(this._renderTextStroke(t),this._renderTextFill(t)):(this._renderTextFill(t),this._renderTextStroke(t))}_setTextStyles(t,e,i){if(t.textBaseline="alphabetic",this.path)switch(this.pathAlign){case"center":t.textBaseline="middle";break;case"ascender":t.textBaseline="top";break;case"descender":t.textBaseline="bottom";break}t.font=this._getFontDeclaration(e,i)}calcTextWidth(){let t=this.getLineWidth(0);for(let e=1,i=this._textLines.length;e<i;e++){const s=this.getLineWidth(e);s>t&&(t=s)}return t}_renderTextLine(t,e,i,s,o,l){this._renderChars(t,e,i,s,o,l)}_renderTextLinesBackground(t){if(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor"))return;const e=t.fillStyle,i=this._getLeftOffset();let s=this._getTopOffset();for(let o=0,l=this._textLines.length;o<l;o++){const c=this.getHeightOfLine(o);if(!this.textBackgroundColor&&!this.styleHas("textBackgroundColor",o)){s+=c;continue}const u=this._textLines[o].length,p=this._getLineLeftOffset(o);let m=0,v=0,y,b,_=this.getValueOfPropertyAt(o,0,"textBackgroundColor");for(let S=0;S<u;S++){const k=this.__charBounds[o][S];b=this.getValueOfPropertyAt(o,S,"textBackgroundColor"),this.path?(t.save(),t.translate(k.renderLeft,k.renderTop),t.rotate(k.angle),t.fillStyle=b,b&&t.fillRect(-k.width/2,-c/this.lineHeight*(1-this._fontSizeFraction),k.width,c/this.lineHeight),t.restore()):b!==_?(y=i+p+v,this.direction==="rtl"&&(y=this.width-y-m),t.fillStyle=_,_&&t.fillRect(y,s,m,c/this.lineHeight),v=k.left,m=k.width,_=b):m+=k.kernedWidth}b&&!this.path&&(y=i+p+v,this.direction==="rtl"&&(y=this.width-y-m),t.fillStyle=b,t.fillRect(y,s,m,c/this.lineHeight)),s+=c}t.fillStyle=e,this._removeShadow(t)}_measureChar(t,e,i,s){const o=Le.getFontCache(e),l=this._getFontDeclaration(e),c=this._getFontDeclaration(s),u=i+t,p=l===c,m=e.fontSize/this.CACHE_FONT_SIZE;let v,y,b,_;if(i&&o[i]!==void 0&&(b=o[i]),o[t]!==void 0&&(_=v=o[t]),p&&o[u]!==void 0&&(y=o[u],_=y-b),v===void 0||b===void 0||y===void 0){const S=$h();this._setTextStyles(S,e,!0),v===void 0&&(_=v=S.measureText(t).width,o[t]=v),b===void 0&&p&&i&&(b=S.measureText(i).width,o[i]=b),p&&y===void 0&&(y=S.measureText(u).width,o[u]=y,_=y-b)}return{width:v*m,kernedWidth:_*m}}getHeightOfChar(t,e){return this.getValueOfPropertyAt(t,e,"fontSize")}measureLine(t){const e=this._measureLine(t);return this.charSpacing!==0&&(e.width-=this._getWidthOfCharSpacing()),e.width<0&&(e.width=0),e}_measureLine(t){let e=0,i,s;const o=this.pathSide==="right",l=this.path,c=this._textLines[t],u=c.length,p=new Array(u);this.__charBounds[t]=p;for(let m=0;m<u;m++){const v=c[m];s=this._getGraphemeBox(v,t,m,i),p[m]=s,e+=s.kernedWidth,i=v}if(p[u]={left:s?s.left+s.width:0,width:0,kernedWidth:0,height:this.fontSize},l&&l.segmentsInfo){let m=0;const v=l.segmentsInfo[l.segmentsInfo.length-1].length,y=Ws(l.path,0,l.segmentsInfo);switch(y.x+=l.pathOffset.x,y.y+=l.pathOffset.y,this.textAlign){case"left":m=o?v-e:0;break;case"center":m=(v-e)/2;break;case"right":m=o?0:v-e;break}m+=this.pathStartOffset*(o?-1:1);for(let b=o?u-1:0;o?b>=0:b<u;o?b--:b++)s=p[b],m>v?m%=v:m<0&&(m+=v),this._setGraphemeOnPath(m,s,y),m+=s.kernedWidth}return{width:e,numOfSpaces:0}}_setGraphemeOnPath(t,e,i){const s=t+e.kernedWidth/2,o=this.path,l=Ws(o.path,s,o.segmentsInfo);e.renderLeft=l.x-i.x,e.renderTop=l.y-i.y,e.angle=l.angle+(this.pathSide==="right"?Math.PI:0)}_getGraphemeBox(t,e,i,s,o){const l=this.getCompleteStyleDeclaration(e,i),c=s?this.getCompleteStyleDeclaration(e,i-1):{},u=this._measureChar(t,l,s,c);let p=u.kernedWidth,m=u.width,v;this.charSpacing!==0&&(v=this._getWidthOfCharSpacing(),m+=v,p+=v);const y={width:m,left:0,height:l.fontSize,kernedWidth:p,deltaY:l.deltaY};if(i>0&&!o){const b=this.__charBounds[e][i-1];y.left=b.left+b.width+u.kernedWidth-u.width}return y}getHeightOfLine(t){if(this.__lineHeights[t])return this.__lineHeights[t];let e=this.getHeightOfChar(t,0);for(let i=1,s=this._textLines[t].length;i<s;i++)e=Math.max(this.getHeightOfChar(t,i),e);return this.__lineHeights[t]=e*this.lineHeight*this._fontSizeMult}calcTextHeight(){let t,e=0;for(let i=0,s=this._textLines.length;i<s;i++)t=this.getHeightOfLine(i),e+=i===s-1?t/this.lineHeight:t;return e}_getLeftOffset(){return this.direction==="ltr"?-this.width/2:this.width/2}_getTopOffset(){return-this.height/2}_renderTextCommon(t,e){t.save();let i=0;const s=this._getLeftOffset(),o=this._getTopOffset();for(let l=0,c=this._textLines.length;l<c;l++){const u=this.getHeightOfLine(l),p=u/this.lineHeight,m=this._getLineLeftOffset(l);this._renderTextLine(e,t,this._textLines[l],s+m,o+i+p,l),i+=u}t.restore()}_renderTextFill(t){!this.fill&&!this.styleHas("fill")||this._renderTextCommon(t,"fillText")}_renderTextStroke(t){(!this.stroke||this.strokeWidth===0)&&this.isEmptyStyles()||(this.shadow&&!this.shadow.affectStroke&&this._removeShadow(t),t.save(),this._setLineDash(t,this.strokeDashArray),t.beginPath(),this._renderTextCommon(t,"strokeText"),t.closePath(),t.restore())}_renderChars(t,e,i,s,o,l){const c=this.getHeightOfLine(l),u=this.textAlign.indexOf("justify")!==-1,p=this.path,m=!u&&this.charSpacing===0&&this.isEmptyStyles(l)&&!p,v=this.direction==="ltr",y=this.direction==="ltr"?1:-1,b=e.direction;let _,S,k="",A,O=0,F,I;if(e.save(),b!==this.direction&&(e.canvas.setAttribute("dir",v?"ltr":"rtl"),e.direction=v?"ltr":"rtl",e.textAlign=v?"left":"right"),o-=c*this._fontSizeFraction/this.lineHeight,m){this._renderChar(t,e,l,0,i.join(""),s,o),e.restore();return}for(let B=0,K=i.length-1;B<=K;B++)F=B===K||this.charSpacing||p,k+=i[B],A=this.__charBounds[l][B],O===0?(s+=y*(A.kernedWidth-A.width),O+=A.width):O+=A.kernedWidth,u&&!F&&this._reSpaceAndTab.test(i[B])&&(F=!0),F||(_=_||this.getCompleteStyleDeclaration(l,B),S=this.getCompleteStyleDeclaration(l,B+1),F=Vi(_,S,!1)),F&&(p?(e.save(),e.translate(A.renderLeft,A.renderTop),e.rotate(A.angle),this._renderChar(t,e,l,B,k,-O/2,0),e.restore()):(I=s,this._renderChar(t,e,l,B,k,I,o)),k="",_=S,s+=y*O,O=0);e.restore()}_applyPatternGradientTransformText(t){const e=Y(),i=this.width+this.strokeWidth,s=this.height+this.strokeWidth,o=e.getContext("2d");return e.width=i,e.height=s,o.beginPath(),o.moveTo(0,0),o.lineTo(i,0),o.lineTo(i,s),o.lineTo(0,s),o.closePath(),o.translate(i/2,s/2),o.fillStyle=t.toLive(o)||"",this._applyPatternGradientTransform(o,t),o.fill(),o.createPattern(e,"no-repeat")}handleFiller(t,e,i){let s,o;return i.toLive?i.gradientUnits==="percentage"||i.gradientTransform||i.patternTransform?(s=-this.width/2,o=-this.height/2,t.translate(s,o),t[e]=this._applyPatternGradientTransformText(i),{offsetX:s,offsetY:o}):(t[e]=i.toLive(t,this)||"",this._applyPatternGradientTransform(t,i)):(t[e]=i,{offsetX:0,offsetY:0})}_setStrokeStyles(t,{stroke:e,strokeWidth:i}){return t.lineWidth=i,t.lineCap=this.strokeLineCap,t.lineDashOffset=this.strokeDashOffset,t.lineJoin=this.strokeLineJoin,t.miterLimit=this.strokeMiterLimit,this.handleFiller(t,"strokeStyle",e)}_setFillStyles(t,{fill:e}){return this.handleFiller(t,"fillStyle",e)}_renderChar(t,e,i,s,o,l,c){const u=this._getStyleDeclaration(i,s),p=this.getCompleteStyleDeclaration(i,s),m=t==="fillText"&&p.fill,v=t==="strokeText"&&p.stroke&&p.strokeWidth;let y,b;!v&&!m||(e.save(),m&&(y=this._setFillStyles(e,p)),v&&(b=this._setStrokeStyles(e,p)),e.font=this._getFontDeclaration(p),u&&u.textBackgroundColor&&this._removeShadow(e),u&&u.deltaY&&(c+=u.deltaY),m&&e.fillText(o,l-y.offsetX,c-y.offsetY),v&&e.strokeText(o,l-b.offsetX,c-b.offsetY),e.restore())}setSuperscript(t,e){this._setScript(t,e,this.superscript)}setSubscript(t,e){this._setScript(t,e,this.subscript)}_setScript(t,e,i){const s=this.get2DCursorLocation(t,!0),o=this.getValueOfPropertyAt(s.lineIndex,s.charIndex,"fontSize"),l=this.getValueOfPropertyAt(s.lineIndex,s.charIndex,"deltaY"),c={fontSize:o*i.size,deltaY:l+o*i.baseline};this.setSelectionStyles(c,t,e)}_getLineLeftOffset(t){const e=this.getLineWidth(t),i=this.width-e,s=this.textAlign,o=this.direction,l=this.isEndOfWrapping(t);let c=0;return s==="justify"||s==="justify-center"&&!l||s==="justify-right"&&!l||s==="justify-left"&&!l?0:(s==="center"&&(c=i/2),s==="right"&&(c=i),s==="justify-center"&&(c=i/2),s==="justify-right"&&(c=i),o==="rtl"&&(s==="right"||s==="justify"||s==="justify-right"?c=0:s==="left"||s==="justify-left"?c=-i:(s==="center"||s==="justify-center")&&(c=-i/2)),c)}_clearCache(){this.__lineWidths=[],this.__lineHeights=[],this.__charBounds=[]}_shouldClearDimensionCache(){let t=this._forceClearCache;return t||(t=this.hasStateChanged("_dimensionAffectingProps")),t&&(this.dirty=!0,this._forceClearCache=!1),t}getLineWidth(t){if(this.__lineWidths[t]!==void 0)return this.__lineWidths[t];const{width:e}=this.measureLine(t);return this.__lineWidths[t]=e,e}_getWidthOfCharSpacing(){return this.charSpacing!==0?this.fontSize*this.charSpacing/1e3:0}getValueOfPropertyAt(t,e,i){const s=this._getStyleDeclaration(t,e);return s&&typeof s[i]<"u"?s[i]:this[i]}_renderTextDecoration(t,e){if(!this[e]&&!this.styleHas(e))return;let i=this._getTopOffset();const s=this._getLeftOffset(),o=this.path,l=this._getWidthOfCharSpacing(),c=this.offsets[e];for(let u=0,p=this._textLines.length;u<p;u++){const m=this.getHeightOfLine(u);if(!this[e]&&!this.styleHas(e,u)){i+=m;continue}const v=this._textLines[u],y=m/this.lineHeight,b=this._getLineLeftOffset(u);let _=0,S=0,k=this.getValueOfPropertyAt(u,0,e),A=this.getValueOfPropertyAt(u,0,"fill"),O,F;const I=i+y*(1-this._fontSizeFraction);let B=this.getHeightOfChar(u,0),K=this.getValueOfPropertyAt(u,0,"deltaY");for(let Z=0,dt=v.length;Z<dt;Z++){const xt=this.__charBounds[u][Z];O=this.getValueOfPropertyAt(u,Z,e),F=this.getValueOfPropertyAt(u,Z,"fill");const Nt=this.getHeightOfChar(u,Z),At=this.getValueOfPropertyAt(u,Z,"deltaY");if(o&&O&&F)t.save(),t.fillStyle=A,t.translate(xt.renderLeft,xt.renderTop),t.rotate(xt.angle),t.fillRect(-xt.kernedWidth/2,c*Nt+At,xt.kernedWidth,this.fontSize/15),t.restore();else if((O!==k||F!==A||Nt!==B||At!==K)&&S>0){let Ft=s+b+_;this.direction==="rtl"&&(Ft=this.width-Ft-S),k&&A&&(t.fillStyle=A,t.fillRect(Ft,I+c*B+K,S,this.fontSize/15)),_=xt.left,S=xt.width,k=O,A=F,B=Nt,K=At}else S+=xt.kernedWidth}let tt=s+b+_;this.direction==="rtl"&&(tt=this.width-tt-S),t.fillStyle=F,O&&F&&t.fillRect(tt,I+c*B+K,S-l,this.fontSize/15),i+=m}this._removeShadow(t)}_getFontDeclaration(t,e){const i=t||this,s=this.fontFamily,o=Qt.genericFonts.indexOf(s.toLowerCase())>-1,l=s===void 0||s.indexOf("'")>-1||s.indexOf(",")>-1||s.indexOf('"')>-1||o?i.fontFamily:`"${i.fontFamily}"`;return[i.fontStyle,i.fontWeight,e?this.CACHE_FONT_SIZE+"px":i.fontSize+"px",l].join(" ")}render(t){this.visible&&(this.canvas&&this.canvas.skipOffscreen&&!this.group&&!this.isOnScreen()||(this._shouldClearDimensionCache()&&this.initDimensions(),super.render(t)))}graphemeSplit(t){return Ur(t)}_splitTextIntoLines(t){const e=t.split(this._reNewline),i=new Array(e.length),s=[`
`];let o=[];for(let l=0;l<e.length;l++)i[l]=this.graphemeSplit(e[l]),o=o.concat(i[l],s);return o.pop(),{_unwrappedLines:i,lines:e,graphemeText:o,graphemeLines:i}}toObject(t=[]){return Object.assign(Object.assign(Object.assign({},super.toObject([...tr,...t])),{styles:ln(this.styles,this.text)}),this.path?{path:this.path.toObject()}:{})}set(t,e){super.set(t,e);let i=!1,s=!1;if(typeof t=="object")for(const o in t)o==="path"&&this.setPathInfo(),i=i||this._dimensionAffectingProps.indexOf(o)!==-1,s=s||o==="path";else i=this._dimensionAffectingProps.indexOf(t)!==-1,s=t==="path";return s&&this.setPathInfo(),i&&this.initialized&&(this.initDimensions(),this.setCoords()),this}complexity(){return 1}static fromElement(t,e,i){if(!t)return e(null);const s=te(t,Qt.ATTRIBUTE_NAMES),o=s.textAnchor||"left";if(i=Object.assign({},i,s),i.top=i.top||0,i.left=i.left||0,s.textDecoration){const _=s.textDecoration;_.indexOf("underline")!==-1&&(i.underline=!0),_.indexOf("overline")!==-1&&(i.overline=!0),_.indexOf("line-through")!==-1&&(i.linethrough=!0),delete i.textDecoration}"dx"in s&&(i.left+=s.dx),"dy"in s&&(i.top+=s.dy),"fontSize"in i||(i.fontSize=fs);let l="";"textContent"in t?l=t.textContent:"firstChild"in t&&t.firstChild!==null&&"data"in t.firstChild&&t.firstChild.data!==null&&(l=t.firstChild.data),l=l.replace(/^\s+|\s+$|\n+/g,"").replace(/\s+/g," ");const c=i.strokeWidth;i.strokeWidth=0;const u=new this(l,i),p=u.getScaledHeight()/u.height,m=(u.height+u.strokeWidth)*u.lineHeight-u.height,v=m*p,y=u.getScaledHeight()+v;let b=0;o==="center"&&(b=u.getScaledWidth()/2),o==="right"&&(b=u.getScaledWidth()),u.set({left:u.left-b,top:u.top-(y-u.fontSize*(.07+u._fontSizeFraction))/u.lineHeight,strokeWidth:typeof c<"u"?c:1}),e(u)}static fromObject(t){return this._fromObject(Object.assign(Object.assign({},t),{styles:hn(t.styles,t.text)}),{extraParam:"text"})}}Qt.genericFonts=["sans-serif","serif","cursive","fantasy","monospace"],Qt.ATTRIBUTE_NAMES=le.concat("x","y","dx","dy","font-family","font-style","font-weight","font-size","letter-spacing","text-decoration","text-anchor");const ro={_dimensionAffectingProps:["fontSize","fontWeight","fontFamily","fontStyle","lineHeight","text","charSpacing","textAlign","styles","path","pathStartOffset","pathSide","pathAlign"],_styleProperties:["stroke","strokeWidth","fill","fontFamily","fontSize","fontWeight","fontStyle","underline","overline","linethrough","deltaY","textBackgroundColor"],_reNewline:/\r?\n/,_reSpacesAndTabs:/[ \t\r]/g,_reSpaceAndTab:/[ \t\r]/,_reWords:/\S+/g,type:"text",fontSize:40,fontWeight:"normal",fontFamily:"Times New Roman",underline:!1,overline:!1,linethrough:!1,textAlign:"left",fontStyle:"normal",lineHeight:1.16,superscript:{size:.6,baseline:-.35},subscript:{size:.6,baseline:.11},textBackgroundColor:"",stateProperties:Rt.stateProperties.concat(tr),cacheProperties:Rt.cacheProperties.concat(tr),stroke:null,shadow:null,path:null,pathStartOffset:0,pathSide:"left",pathAlign:"baseline",_fontSizeFraction:.222,offsets:{underline:.1,linethrough:-.315,overline:-.88},_fontSizeMult:1.13,charSpacing:0,styles:null,deltaY:0,direction:"ltr",CACHE_FONT_SIZE:400,MIN_TEXT_WIDTH:2};Object.assign(Qt.prototype,ro),Gr(Qt,[Hh]),$.setClass(Qt),$.setSVGClass(Qt);const no=/[ \n\.,;!\?\-]/;class zh extends Qt{constructor(){super(...arguments),this.cursorOffsetCache={}}initBehavior(){this.initAddedHandler(),this.initRemovedHandler(),this.initCursorSelectionHandlers(),this.initDoubleClickSimulation(),this.mouseMoveHandler=this.mouseMoveHandler.bind(this),this.dragEnterHandler=this.dragEnterHandler.bind(this),this.dragOverHandler=this.dragOverHandler.bind(this),this.dragLeaveHandler=this.dragLeaveHandler.bind(this),this.dragEndHandler=this.dragEndHandler.bind(this),this.dropHandler=this.dropHandler.bind(this),this.on("dragenter",this.dragEnterHandler),this.on("dragover",this.dragOverHandler),this.on("dragleave",this.dragLeaveHandler),this.on("dragend",this.dragEndHandler),this.on("drop",this.dropHandler)}onDeselect(){this.isEditing&&this.exitEditing(),this.selected=!1}initAddedHandler(){this.on("added",t=>{const e=t.target;e&&(e._hasITextHandlers||(e._hasITextHandlers=!0,this._initCanvasHandlers(e)),e._iTextInstances=e._iTextInstances||[],e._iTextInstances.push(this))})}initRemovedHandler(){this.on("removed",t=>{const e=t.target;e&&(e._iTextInstances=e._iTextInstances||[],_e(e._iTextInstances,this),e._iTextInstances.length===0&&(e._hasITextHandlers=!1,this._removeCanvasHandlers(e)))})}_initCanvasHandlers(t){t._mouseUpITextHandler=function(){t._iTextInstances&&t._iTextInstances.forEach(e=>{e.__isMousedown=!1})},t.on("mouse:up",t._mouseUpITextHandler)}_removeCanvasHandlers(t){t.off("mouse:up",t._mouseUpITextHandler)}_tick(){this._currentTickState=this._animateCursor(this,1,this.cursorDuration,"_onTickComplete")}_animateCursor(t,e,i,s){const o={isAborted:!1,abort:function(){this.isAborted=!0}};return t.animate("_currentCursorOpacity",e,{duration:i,onComplete:function(){o.isAborted||t[s]()},onChange:function(){t.canvas&&t.selectionStart===t.selectionEnd&&t.renderCursorOrSelection()},abort:function(){return o.isAborted}}),o}_onTickComplete(){this._cursorTimeout1&&clearTimeout(this._cursorTimeout1),this._cursorTimeout1=setTimeout(()=>{this._currentTickCompleteState=this._animateCursor(this,0,this.cursorDuration/2,"_tick")},100)}initDelayedCursor(t){const e=t?0:this.cursorDelay;this.abortCursorAnimation(),e?this._cursorTimeout2=setTimeout(()=>{this._tick()},e):this._tick()}abortCursorAnimation(){const t=this._currentTickState||this._currentTickCompleteState;this._currentTickState&&this._currentTickState.abort(),this._currentTickCompleteState&&this._currentTickCompleteState.abort(),clearTimeout(this._cursorTimeout1),clearTimeout(this._cursorTimeout2),this._currentCursorOpacity=1,t&&this.clearContextTop()}restartCursorIfNeeded(){(!this._currentTickState||this._currentTickState.isAborted||!this._currentTickCompleteState||this._currentTickCompleteState.isAborted)&&this.initDelayedCursor()}selectAll(){return this.selectionStart=0,this.selectionEnd=this._text.length,this._fireSelectionChanged(),this._updateTextarea(),this}getSelectedText(){return this._text.slice(this.selectionStart,this.selectionEnd).join("")}findWordBoundaryLeft(t){let e=0,i=t-1;if(this._reSpace.test(this._text[i]))for(;this._reSpace.test(this._text[i]);)e++,i--;for(;/\S/.test(this._text[i])&&i>-1;)e++,i--;return t-e}findWordBoundaryRight(t){let e=0,i=t;if(this._reSpace.test(this._text[i]))for(;this._reSpace.test(this._text[i]);)e++,i++;for(;/\S/.test(this._text[i])&&i<this._text.length;)e++,i++;return t+e}findLineBoundaryLeft(t){let e=0,i=t-1;for(;!/\n/.test(this._text[i])&&i>-1;)e++,i--;return t-e}findLineBoundaryRight(t){let e=0,i=t;for(;!/\n/.test(this._text[i])&&i<this._text.length;)e++,i++;return t+e}searchWordBoundary(t,e){const i=this._text;let s=this._reSpace.test(i[t])?t-1:t,o=i[s];for(;!no.test(o)&&s>0&&s<i.length;)s+=e,o=i[s];return no.test(o)&&(s+=e===1?0:1),s}selectWord(t){t=t||this.selectionStart;const e=this.searchWordBoundary(t,-1),i=this.searchWordBoundary(t,1);this.selectionStart=e,this.selectionEnd=i,this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()}selectLine(t){t=t||this.selectionStart;const e=this.findLineBoundaryLeft(t),i=this.findLineBoundaryRight(t);return this.selectionStart=e,this.selectionEnd=i,this._fireSelectionChanged(),this._updateTextarea(),this}enterEditing(t){if(!(this.isEditing||!this.editable))return this.canvas&&(this.canvas.calcOffset(),this.exitEditingOnOthers(this.canvas)),this.isEditing=!0,this.initHiddenTextarea(t),this.hiddenTextarea.focus(),this.hiddenTextarea.value=this.text,this._updateTextarea(),this._saveEditingProps(),this._setEditingProps(),this._textBeforeEdit=this.text,this._tick(),this.fire("editing:entered"),this._fireSelectionChanged(),this.canvas?(this.canvas.fire("text:editing:entered",{target:this}),this.initMouseMoveHandler(),this.canvas.requestRenderAll(),this):this}exitEditingOnOthers(t){t._iTextInstances&&t._iTextInstances.forEach(e=>{e.selected=!1,e.isEditing&&e.exitEditing()})}initMouseMoveHandler(){this.canvas.on("mouse:move",this.mouseMoveHandler)}mouseMoveHandler(t){if(!this.__isMousedown||!this.isEditing)return;D().document.activeElement!==this.hiddenTextarea&&this.hiddenTextarea.focus();const e=this.getSelectionStartFromPointer(t.e),i=this.selectionStart,s=this.selectionEnd;(e!==this.__selectionStartOnMouseDown||i===s)&&(i===e||s===e)||(e>this.__selectionStartOnMouseDown?(this.selectionStart=this.__selectionStartOnMouseDown,this.selectionEnd=e):(this.selectionStart=e,this.selectionEnd=this.__selectionStartOnMouseDown),(this.selectionStart!==i||this.selectionEnd!==s)&&(this.restartCursorIfNeeded(),this._fireSelectionChanged(),this._updateTextarea(),this.renderCursorOrSelection()))}setDragImage(t,e){const i=this.calcTransformMatrix(),s=new T(this.flipX?-1:1,this.flipY?-1:1),o=this._getCursorBoundaries(e.selectionStart),l=new T(o.left+o.leftOffset,o.top+o.topOffset).multiply(s),c=ct(l,i),p=this.canvas.getPointer(t).subtract(c),m=this.canvas._isRetinaScaling(),v=this.getCanvasRetinaScaling(),y=this.getBoundingRect(!0),_=c.subtract(new T(y.left,y.top)).add(p).scalarMultiply(v),S=this.backgroundColor,k=object.clone(this.styles,!0);delete this.backgroundColor;const A={fill:"transparent",textBackgroundColor:"transparent"};this.setSelectionStyles(A,0,e.selectionStart),this.setSelectionStyles(A,e.selectionEnd,e.text.length);let O=this.toCanvasElement({enableRetinaScaling:m});if(this.backgroundColor=S,this.styles=k,m&&v>1){const F=Y();F.width=O.width/v,F.height=O.height/v;const I=F.getContext("2d");I.scale(1/v,1/v),I.drawImage(O,0,0),O=F}this.__dragImageDisposer&&this.__dragImageDisposer(),this.__dragImageDisposer=()=>{O.remove()},Xi(O,{position:"absolute",left:-O.width+"px",border:"none"}),D().document.body.appendChild(O),t.dataTransfer.setDragImage(O,_.x,_.y)}onDragStart(t){if(this.__dragStartFired=!0,this.__isDragging){const e=this.__dragStartSelection={selectionStart:this.selectionStart,selectionEnd:this.selectionEnd},i=this._text.slice(e.selectionStart,e.selectionEnd).join(""),s=Object.assign({text:this.text,value:i},e);t.dataTransfer.setData("text/plain",i),t.dataTransfer.setData("application/fabric",JSON.stringify({value:i,styles:this.getSelectionStyles(e.selectionStart,e.selectionEnd,!0)})),t.dataTransfer.effectAllowed="copyMove",this.setDragImage(t,s)}return this.abortCursorAnimation(),this.__isDragging}canDrop(t){if(this.editable&&!this.__corner){if(this.__isDragging&&this.__dragStartSelection){const e=this.getSelectionStartFromPointer(t),i=this.__dragStartSelection;return e<i.selectionStart||e>i.selectionEnd}return!0}return!1}dragEnterHandler({e:t}){const e=!t.defaultPrevented&&this.canDrop(t);!this.__isDraggingOver&&e&&(this.__isDraggingOver=!0)}dragOverHandler({e:t}){const e=!t.defaultPrevented&&this.canDrop(t);!this.__isDraggingOver&&e?this.__isDraggingOver=!0:this.__isDraggingOver&&!e&&(this.__isDraggingOver=!1),this.__isDraggingOver&&(t.preventDefault(),options.canDrop=!0,options.dropTarget=this)}dragLeaveHandler(){(this.__isDraggingOver||this.__isDragging)&&(this.__isDraggingOver=!1)}dragEndHandler({e:t}){if(this.__isDragging&&this.__dragStartFired&&this.__dragStartSelection){const e=this.__dragStartSelection.selectionStart,i=this.__dragStartSelection.selectionEnd,s=t.dataTransfer.dropEffect;s==="none"?(this.selectionStart=e,this.selectionEnd=i,this._updateTextarea()):(this.clearContextTop(),s==="move"&&(this.insertChars("",null,e,i),this.selectionStart=this.selectionEnd=e,this.hiddenTextarea&&(this.hiddenTextarea.value=this.text),this._updateTextarea(),this.fire("changed",{index:e,action:"dragend"}),this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll()),this.exitEditing(),this.__lastSelected=!1)}this.__dragImageDisposer&&this.__dragImageDisposer(),delete this.__dragImageDisposer,delete this.__dragStartSelection,this.__isDraggingOver=!1}dropHandler({e:t}){const e=t.defaultPrevented;this.__isDraggingOver=!1,t.preventDefault();let i=t.dataTransfer.getData("text/plain");if(i&&!e){let s=this.getSelectionStartFromPointer(t);const l=(t.dataTransfer.types.includes("application/fabric")?JSON.parse(t.dataTransfer.getData("application/fabric")):{}).styles,c=i[Math.max(0,i.length-1)],u=0;if(this.__dragStartSelection){const p=this.__dragStartSelection.selectionStart,m=this.__dragStartSelection.selectionEnd;s>p&&s<=m?s=p:s>m&&(s-=m-p),this.insertChars("",null,p,m),delete this.__dragStartSelection}this._reNewline.test(c)&&(this._reNewline.test(this._text[s])||s===this._text.length)&&(i=i.trimEnd()),options.didDrop=!0,options.dropTarget=this,this.insertChars(i,l,s),this.canvas.setActiveObject(this),this.enterEditing(),this.selectionStart=Math.min(s+u,this._text.length),this.selectionEnd=Math.min(this.selectionStart+i.length,this._text.length),this.hiddenTextarea&&(this.hiddenTextarea.value=this.text),this._updateTextarea(),this.fire("changed",{index:s+u,action:"drop"}),this.canvas.fire("text:changed",{target:this}),this.canvas.contextTopDirty=!0,this.canvas.requestRenderAll()}}_setEditingProps(){this.hoverCursor="text",this.canvas&&(this.canvas.defaultCursor=this.canvas.moveCursor="text"),this.borderColor=this.editingBorderColor,this.hasControls=this.selectable=!1,this.lockMovementX=this.lockMovementY=!0}fromStringToGraphemeSelection(t,e,i){const s=i.slice(0,t),o=this.graphemeSplit(s).length;if(t===e)return{selectionStart:o,selectionEnd:o};const l=i.slice(t,e),c=this.graphemeSplit(l).length;return{selectionStart:o,selectionEnd:o+c}}fromGraphemeToStringSelection(t,e,i){const s=i.slice(0,t),o=s.join("").length;if(t===e)return{selectionStart:o,selectionEnd:o};const l=i.slice(t,e),c=l.join("").length;return{selectionStart:o,selectionEnd:o+c}}_updateTextarea(){if(this.cursorOffsetCache={},!!this.hiddenTextarea){if(!this.inCompositionMode){const t=this.fromGraphemeToStringSelection(this.selectionStart,this.selectionEnd,this._text);this.hiddenTextarea.selectionStart=t.selectionStart,this.hiddenTextarea.selectionEnd=t.selectionEnd}this.updateTextareaPosition()}}updateFromTextArea(){if(!this.hiddenTextarea)return;this.cursorOffsetCache={},this.text=this.hiddenTextarea.value,this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords());const t=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value);this.selectionEnd=this.selectionStart=t.selectionEnd,this.inCompositionMode||(this.selectionStart=t.selectionStart),this.updateTextareaPosition()}updateTextareaPosition(){if(this.selectionStart===this.selectionEnd){const t=this._calcTextareaPosition();this.hiddenTextarea.style.left=t.left,this.hiddenTextarea.style.top=t.top}}_calcTextareaPosition(){if(!this.canvas)return{left:1,top:1};const t=this.inCompositionMode?this.compositionStart:this.selectionStart,e=this._getCursorBoundaries(t),i=this.get2DCursorLocation(t),s=i.lineIndex,o=i.charIndex,l=this.getValueOfPropertyAt(s,o,"fontSize")*this.lineHeight,c=e.leftOffset,u=this.getCanvasRetinaScaling(),p=this.canvas.upperCanvasEl,m=p.width/u,v=p.height/u,y=m-l,b=v-l,_=new T(e.left+c,e.top+e.topOffset+l).transform(this.calcTransformMatrix()).transform(this.canvas.viewportTransform).multiply(new T(p.clientWidth/m,p.clientHeight/v));return _.x<0&&(_.x=0),_.x>y&&(_.x=y),_.y<0&&(_.y=0),_.y>b&&(_.y=b),_.x+=this.canvas._offset.left,_.y+=this.canvas._offset.top,{left:_.x+"px",top:_.y+"px",fontSize:l+"px",charHeight:l}}_saveEditingProps(){this._savedProps={hasControls:this.hasControls,borderColor:this.borderColor,lockMovementX:this.lockMovementX,lockMovementY:this.lockMovementY,hoverCursor:this.hoverCursor,selectable:this.selectable,defaultCursor:this.canvas&&this.canvas.defaultCursor,moveCursor:this.canvas&&this.canvas.moveCursor}}_restoreEditingProps(){this._savedProps&&(this.hoverCursor=this._savedProps.hoverCursor,this.hasControls=this._savedProps.hasControls,this.borderColor=this._savedProps.borderColor,this.selectable=this._savedProps.selectable,this.lockMovementX=this._savedProps.lockMovementX,this.lockMovementY=this._savedProps.lockMovementY,this.canvas&&(this.canvas.defaultCursor=this._savedProps.defaultCursor,this.canvas.moveCursor=this._savedProps.moveCursor),delete this._savedProps)}exitEditing(){const t=this._textBeforeEdit!==this.text,e=this.hiddenTextarea;return this.selected=!1,this.isEditing=!1,this.selectionEnd=this.selectionStart,e&&(e.blur&&e.blur(),e.parentNode&&e.parentNode.removeChild(e)),this.hiddenTextarea=null,this.abortCursorAnimation(),this._restoreEditingProps(),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this.fire("editing:exited"),t&&this.fire("modified"),this.canvas&&(this.canvas.off("mouse:move",this.mouseMoveHandler),this.canvas.fire("text:editing:exited",{target:this}),t&&this.canvas.fire("object:modified",{target:this})),this}_removeExtraneousStyles(){for(const t in this.styles)this._textLines[t]||delete this.styles[t]}removeStyleFromTo(t,e){let i=this.get2DCursorLocation(t,!0),s=this.get2DCursorLocation(e,!0),o=i.lineIndex,l=i.charIndex,c=s.lineIndex,u=s.charIndex,p,m;if(o!==c){if(this.styles[o])for(p=l;p<this._unwrappedTextLines[o].length;p++)delete this.styles[o][p];if(this.styles[c])for(p=u;p<this._unwrappedTextLines[c].length;p++)m=this.styles[c][p],m&&(this.styles[o]||(this.styles[o]={}),this.styles[o][l+p-u]=m);for(p=o+1;p<=c;p++)delete this.styles[p];this.shiftLineStyles(c,o-c)}else if(this.styles[o]){m=this.styles[o];let v=u-l,y,b;for(p=l;p<u;p++)delete m[p];for(b in this.styles[o])y=parseInt(b,10),y>=u&&(m[y-v]=m[b],delete m[b])}}shiftLineStyles(t,e){const i=Object.assign({},this.styles);for(const s in this.styles){const o=parseInt(s,10);o>t&&(this.styles[o+e]=i[o],i[o-e]||delete this.styles[o])}}insertNewlineStyleObject(t,e,i,s){let o,l={},c=!1,u=this._unwrappedTextLines[t].length===e;i||(i=1),this.shiftLineStyles(t,i),this.styles[t]&&(o=this.styles[t][e===0?e:e-1]);for(const m in this.styles[t]){const v=parseInt(m,10);v>=e&&(c=!0,l[v-e]=this.styles[t][m],u&&e===0||delete this.styles[t][m])}let p=!1;for(c&&!u&&(this.styles[t+i]=l,p=!0),p&&i--;i>0;)s&&s[i-1]?this.styles[t+i]={0:Object.assign({},s[i-1])}:o?this.styles[t+i]={0:Object.assign({},o)}:delete this.styles[t+i],i--;this._forceClearCache=!0}insertCharStyleObject(t,e,i,s){this.styles||(this.styles={});const o=this.styles[t],l=o?Object.assign({},o):{};i||(i=1);for(const u in l){const p=parseInt(u,10);p>=e&&(o[p+i]=l[p],l[p-i]||delete o[p])}if(this._forceClearCache=!0,s){for(;i--;)Object.keys(s[i]).length&&(this.styles[t]||(this.styles[t]={}),this.styles[t][e+i]=Object.assign({},s[i]));return}if(!o)return;const c=o[e?e-1:1];for(;c&&i--;)this.styles[t][e+i]=Object.assign({},c)}insertNewStyleBlock(t,e,i){let s=this.get2DCursorLocation(e,!0),o=[0],l=0;for(var c=0;c<t.length;c++)t[c]===`
`?(l++,o[l]=0):o[l]++;o[0]>0&&(this.insertCharStyleObject(s.lineIndex,s.charIndex,o[0],i),i=i&&i.slice(o[0]+1)),l&&this.insertNewlineStyleObject(s.lineIndex,s.charIndex+o[0],l);for(var c=1;c<l;c++)o[c]>0?this.insertCharStyleObject(s.lineIndex+c,0,o[c],i):i&&this.styles[s.lineIndex+c]&&i[0]&&(this.styles[s.lineIndex+c][0]=i[0]),i=i&&i.slice(o[c]+1);o[c]>0&&this.insertCharStyleObject(s.lineIndex+c,0,o[c],i)}removeChars(t,e){typeof e>"u"&&(e=t+1),this.removeStyleFromTo(t,e),this._text.splice(t,e-t),this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}insertChars(t,e,i,s){typeof s>"u"&&(s=i),s>i&&this.removeStyleFromTo(i,s);const o=this.graphemeSplit(t);this.insertNewStyleBlock(o,i,e),this._text=[...this._text.slice(0,i),...o,...this._text.slice(s)],this.text=this._text.join(""),this.set("dirty",!0),this._shouldClearDimensionCache()&&(this.initDimensions(),this.setCoords()),this._removeExtraneousStyles()}setSelectionStartEndWithShift(t,e,i){i<=t?(e===t?this._selectionDirection="left":this._selectionDirection==="right"&&(this._selectionDirection="left",this.selectionEnd=t),this.selectionStart=i):i>t&&i<e?this._selectionDirection==="right"?this.selectionEnd=i:this.selectionStart=i:(e===t?this._selectionDirection="right":this._selectionDirection==="left"&&(this._selectionDirection="right",this.selectionStart=e),this.selectionEnd=i)}}class Vh extends zh{initHiddenTextarea(){this.hiddenTextarea=D().document.createElement("textarea"),this.hiddenTextarea.setAttribute("autocapitalize","off"),this.hiddenTextarea.setAttribute("autocorrect","off"),this.hiddenTextarea.setAttribute("autocomplete","off"),this.hiddenTextarea.setAttribute("spellcheck","false"),this.hiddenTextarea.setAttribute("data-fabric","textarea"),this.hiddenTextarea.setAttribute("wrap","off");const t=this._calcTextareaPosition();this.hiddenTextarea.style.cssText=`position: absolute; top: ${t.top}; left: ${t.left}; z-index: -999; opacity: 0; width: 1px; height: 1px; font-size: 1px; padding-top: ${t.fontSize};`,this.hiddenTextareaContainer?this.hiddenTextareaContainer.appendChild(this.hiddenTextarea):D().document.body.appendChild(this.hiddenTextarea),this.hiddenTextarea.addEventListener("blur",this.blur.bind(this)),this.hiddenTextarea.addEventListener("keydown",this.onKeyDown.bind(this)),this.hiddenTextarea.addEventListener("keyup",this.onKeyUp.bind(this)),this.hiddenTextarea.addEventListener("input",this.onInput.bind(this)),this.hiddenTextarea.addEventListener("copy",this.copy.bind(this)),this.hiddenTextarea.addEventListener("cut",this.copy.bind(this)),this.hiddenTextarea.addEventListener("paste",this.paste.bind(this)),this.hiddenTextarea.addEventListener("compositionstart",this.onCompositionStart.bind(this)),this.hiddenTextarea.addEventListener("compositionupdate",this.onCompositionUpdate.bind(this)),this.hiddenTextarea.addEventListener("compositionend",this.onCompositionEnd.bind(this)),!this._clickHandlerInitialized&&this.canvas&&(this.canvas.upperCanvasEl.addEventListener("click",this.onClick.bind(this)),this._clickHandlerInitialized=!0)}onClick(){this.hiddenTextarea&&this.hiddenTextarea.focus()}blur(){this.abortCursorAnimation()}onKeyDown(t){if(!this.isEditing)return;const e=this.direction==="rtl"?this.keysMapRtl:this.keysMap;if(t.keyCode in e)this[e[t.keyCode]](t);else if(t.keyCode in this.ctrlKeysMapDown&&(t.ctrlKey||t.metaKey))this[this.ctrlKeysMapDown[t.keyCode]](t);else return;t.stopImmediatePropagation(),t.preventDefault(),t.keyCode>=33&&t.keyCode<=40?(this.inCompositionMode=!1,this.clearContextTop(),this.renderCursorOrSelection()):this.canvas&&this.canvas.requestRenderAll()}onKeyUp(t){if(!this.isEditing||this._copyDone||this.inCompositionMode){this._copyDone=!1;return}if(t.keyCode in this.ctrlKeysMapUp&&(t.ctrlKey||t.metaKey))this[this.ctrlKeysMapUp[t.keyCode]](t);else return;t.stopImmediatePropagation(),t.preventDefault(),this.canvas&&this.canvas.requestRenderAll()}onInput(t){const e=this.fromPaste;if(this.fromPaste=!1,t&&t.stopPropagation(),!this.isEditing)return;const i=this._splitTextIntoLines(this.hiddenTextarea.value).graphemeText,s=this._text.length,o=i.length,l=this.selectionStart,c=this.selectionEnd,u=l!==c;let p,m,v=o-s,y,b;if(this.hiddenTextarea.value===""){this.styles={},this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll());return}const _=this.fromStringToGraphemeSelection(this.hiddenTextarea.selectionStart,this.hiddenTextarea.selectionEnd,this.hiddenTextarea.value),S=l>_.selectionStart;u?(m=this._text.slice(l,c),v+=c-l):o<s&&(S?m=this._text.slice(c+v,c):m=this._text.slice(l,l-v));const k=i.slice(_.selectionEnd-v,_.selectionEnd);m&&m.length&&(k.length&&(p=this.getSelectionStyles(l,l+1,!1),p=k.map(()=>p[0])),u?(y=l,b=c):S?(y=c-m.length,b=c):(y=c,b=c+m.length),this.removeStyleFromTo(y,b)),k.length&&(e&&k.join("")===fabric.copiedText&&!d.disableStyleCopyPaste&&(p=fabric.copiedTextStyle),this.insertNewStyleBlock(k,l,p)),this.updateFromTextArea(),this.fire("changed"),this.canvas&&(this.canvas.fire("text:changed",{target:this}),this.canvas.requestRenderAll())}onCompositionStart(){this.inCompositionMode=!0}onCompositionEnd(){this.inCompositionMode=!1}onCompositionUpdate(t){this.compositionStart=t.target.selectionStart,this.compositionEnd=t.target.selectionEnd,this.updateTextareaPosition()}copy(){this.selectionStart!==this.selectionEnd&&(fabric.copiedText=this.getSelectedText(),d.disableStyleCopyPaste?fabric.copiedTextStyle=null:fabric.copiedTextStyle=this.getSelectionStyles(this.selectionStart,this.selectionEnd,!0),this._copyDone=!0)}paste(){this.fromPaste=!0}_getWidthBeforeCursor(t,e){let i=this._getLineLeftOffset(t),s;return e>0&&(s=this.__charBounds[t][e-1],i+=s.left+s.width),i}getDownCursorOffset(t,e){const i=this._getSelectionForOffset(t,e),s=this.get2DCursorLocation(i),o=s.lineIndex;if(o===this._textLines.length-1||t.metaKey||t.keyCode===34)return this._text.length-i;const l=s.charIndex,c=this._getWidthBeforeCursor(o,l),u=this._getIndexOnLine(o+1,c);return this._textLines[o].slice(l).length+u+1+this.missingNewlineOffset(o)}_getSelectionForOffset(t,e){return t.shiftKey&&this.selectionStart!==this.selectionEnd&&e?this.selectionEnd:this.selectionStart}getUpCursorOffset(t,e){const i=this._getSelectionForOffset(t,e),s=this.get2DCursorLocation(i),o=s.lineIndex;if(o===0||t.metaKey||t.keyCode===33)return-i;const l=s.charIndex,c=this._getWidthBeforeCursor(o,l),u=this._getIndexOnLine(o-1,c),p=this._textLines[o].slice(0,l),m=this.missingNewlineOffset(o-1);return-this._textLines[o-1].length+u-p.length+(1-m)}_getIndexOnLine(t,e){const i=this._textLines[t];let o=this._getLineLeftOffset(t),l=0,c,u;for(let p=0,m=i.length;p<m;p++)if(c=this.__charBounds[t][p].width,o+=c,o>e){u=!0;const v=o-c,y=o,b=Math.abs(v-e);l=Math.abs(y-e)<b?p:p-1;break}return u||(l=i.length-1),l}moveCursorDown(t){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorUpOrDown("Down",t)}moveCursorUp(t){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorUpOrDown("Up",t)}_moveCursorUpOrDown(t,e){const i=`get${t}CursorOffset`,s=this[i](e,this._selectionDirection==="right");if(e.shiftKey?this.moveCursorWithShift(s):this.moveCursorWithoutShift(s),s!==0){const o=this.text.length;this.selectionStart=Ce(0,this.selectionStart,o),this.selectionEnd=Ce(0,this.selectionEnd,o),this.abortCursorAnimation(),this._currentCursorOpacity=1,this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea()}}moveCursorWithShift(t){const e=this._selectionDirection==="left"?this.selectionStart+t:this.selectionEnd+t;return this.setSelectionStartEndWithShift(this.selectionStart,this.selectionEnd,e),t!==0}moveCursorWithoutShift(t){return t<0?(this.selectionStart+=t,this.selectionEnd=this.selectionStart):(this.selectionEnd+=t,this.selectionStart=this.selectionEnd),t!==0}moveCursorLeft(t){this.selectionStart===0&&this.selectionEnd===0||this._moveCursorLeftOrRight("Left",t)}_move(t,e,i){let s;if(t.altKey)s=this["findWordBoundary"+i](this[e]);else if(t.metaKey||t.keyCode===35||t.keyCode===36)s=this["findLineBoundary"+i](this[e]);else return this[e]+=i==="Left"?-1:1,!0;if(typeof s<"u"&&this[e]!==s)return this[e]=s,!0}_moveLeft(t,e){return this._move(t,e,"Left")}_moveRight(t,e){return this._move(t,e,"Right")}moveCursorLeftWithoutShift(t){let e=!0;return this._selectionDirection="left",this.selectionEnd===this.selectionStart&&this.selectionStart!==0&&(e=this._moveLeft(t,"selectionStart")),this.selectionEnd=this.selectionStart,e}moveCursorLeftWithShift(t){if(this._selectionDirection==="right"&&this.selectionStart!==this.selectionEnd)return this._moveLeft(t,"selectionEnd");if(this.selectionStart!==0)return this._selectionDirection="left",this._moveLeft(t,"selectionStart")}moveCursorRight(t){this.selectionStart>=this._text.length&&this.selectionEnd>=this._text.length||this._moveCursorLeftOrRight("Right",t)}_moveCursorLeftOrRight(t,e){let i="moveCursor"+t+"With";this._currentCursorOpacity=1,e.shiftKey?i+="Shift":i+="outShift",this[i](e)&&(this.abortCursorAnimation(),this.initDelayedCursor(),this._fireSelectionChanged(),this._updateTextarea())}moveCursorRightWithShift(t){if(this._selectionDirection==="left"&&this.selectionStart!==this.selectionEnd)return this._moveRight(t,"selectionStart");if(this.selectionEnd!==this._text.length)return this._selectionDirection="right",this._moveRight(t,"selectionEnd")}moveCursorRightWithoutShift(t){let e=!0;return this._selectionDirection="right",this.selectionStart===this.selectionEnd?(e=this._moveRight(t,"selectionStart"),this.selectionEnd=this.selectionStart):this.selectionStart=this.selectionEnd,e}}class Nh extends Vh{initDoubleClickSimulation(){this.__lastClickTime=+new Date,this.__lastLastClickTime=+new Date,this.__lastPointer={},this.on("mousedown",this.onMouseDown)}onMouseDown(t){if(!this.canvas)return;this.__newClickTime=+new Date;const e=t.pointer;this.isTripleClick(e)&&(this.fire("tripleclick",t),$s(t.e)),this.__lastLastClickTime=this.__lastClickTime,this.__lastClickTime=this.__newClickTime,this.__lastPointer=e,this.__lastSelected=this.selected}isTripleClick(t){return this.__newClickTime-this.__lastClickTime<500&&this.__lastClickTime-this.__lastLastClickTime<500&&this.__lastPointer.x===t.x&&this.__lastPointer.y===t.y}initCursorSelectionHandlers(){this.initMousedownHandler(),this.initMouseupHandler(),this.initClicks()}doubleClickHandler(t){this.isEditing&&this.selectWord(this.getSelectionStartFromPointer(t.e))}tripleClickHandler(t){this.isEditing&&this.selectLine(this.getSelectionStartFromPointer(t.e))}initClicks(){this.on("mousedblclick",this.doubleClickHandler),this.on("tripleclick",this.tripleClickHandler)}_mouseDownHandler(t){!this.canvas||!this.editable||t.e.button&&t.e.button!==1||(this.__isMousedown=!0,this.selected&&(this.inCompositionMode=!1,this.setCursorByClick(t.e)),this.isEditing&&(this.__selectionStartOnMouseDown=this.selectionStart,this.selectionStart===this.selectionEnd&&this.abortCursorAnimation(),this.renderCursorOrSelection()))}_mouseDownHandlerBefore(t){if(!this.canvas||!this.editable||t.e.button&&t.e.button!==1)return;this.selected=this===this.canvas._activeObject;const e=this.getSelectionStartFromPointer(t.e);this.__isDragging=this.isEditing&&e>=this.selectionStart&&e<=this.selectionEnd&&this.selectionStart<this.selectionEnd}initMousedownHandler(){this.on("mousedown",this._mouseDownHandler),this.on("mousedown:before",this._mouseDownHandlerBefore)}initMouseupHandler(){this.on("mouseup",this.mouseUpHandler)}mouseUpHandler(t){if(this.__isMousedown=!1,!(!this.editable||this.group&&!this.group.interactive||t.transform&&t.transform.actionPerformed||t.e.button&&t.e.button!==1)){if(this.canvas){const e=this.canvas._activeObject;if(e&&e!==this)return}this.__lastSelected&&!this.__corner?(this.selected=!1,this.__lastSelected=!1,this.enterEditing(t.e),this.selectionStart===this.selectionEnd?this.initDelayedCursor(!0):this.renderCursorOrSelection()):this.selected=!0}}setCursorByClick(t){const e=this.getSelectionStartFromPointer(t),i=this.selectionStart,s=this.selectionEnd;t.shiftKey?this.setSelectionStartEndWithShift(i,s,e):(this.selectionStart=e,this.selectionEnd=e),this.isEditing&&(this._fireSelectionChanged(),this._updateTextarea())}getLocalPointer(t,e){return ct(e||this.canvas.getPointer(t),kt(this.calcTransformMatrix())).add(new T(this.width/2,this.height/2))}getSelectionStartFromPointer(t){const e=this.getLocalPointer(t);let i=0,s=0,o=0;for(let m=0,v=this._textLines.length;m<v&&i<=e.y;m++)i+=this.getHeightOfLine(m),o=m,m>0&&(s+=this._textLines[m-1].length+this.missingNewlineOffset(m-1));let c=Math.abs(this._getLineLeftOffset(o));const u=this._textLines[o].length;this.direction==="rtl"&&(e.x=this.width-e.x);let p=0;for(let m=0;m<u&&(p=c,c+=this.__charBounds[o][m].kernedWidth,c<=e.x);m++)s++;return this._getNewSelectionStartFromOffset(e,p,c,s,u)}_getNewSelectionStartFromOffset(t,e,i,s,o){const l=t.x-e,c=i-t.x,u=c>l||c<0?0:1;let p=s+u;return this.flipX&&(p=o-p),p>this._text.length&&(p=this._text.length),p}}const Xh={9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorRight",36:"moveCursorLeft",37:"moveCursorLeft",38:"moveCursorUp",39:"moveCursorRight",40:"moveCursorDown"},Yh={9:"exitEditing",27:"exitEditing",33:"moveCursorUp",34:"moveCursorDown",35:"moveCursorLeft",36:"moveCursorRight",37:"moveCursorRight",38:"moveCursorUp",39:"moveCursorLeft",40:"moveCursorDown"},Uh={67:"copy",88:"cut"},Gh={65:"selectAll"};class ss extends Nh{constructor(t,e){super(t,e),this.initBehavior()}_set(t,e){return this.isEditing&&this._savedProps&&t in this._savedProps?this._savedProps[t]=e:super._set(t,e),this}setSelectionStart(t){t=Math.max(t,0),this._updateAndFire("selectionStart",t)}setSelectionEnd(t){t=Math.min(t,this.text.length),this._updateAndFire("selectionEnd",t)}_updateAndFire(t,e){this[t]!==e&&(this._fireSelectionChanged(),this[t]=e),this._updateTextarea()}_fireSelectionChanged(){this.fire("selection:changed"),this.canvas&&this.canvas.fire("text:selection:changed",{target:this})}initDimensions(){this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),super.initDimensions()}getSelectionStyles(t=this.selectionStart||0,e=this.selectionEnd,i){return super.getSelectionStyles(t,e,i)}setSelectionStyles(t,e=this.selectionStart||0,i=this.selectionEnd){return super.setSelectionStyles(t,e,i)}get2DCursorLocation(t=this.selectionStart,e){return super.get2DCursorLocation(t,e)}render(t){this.clearContextTop(),super.render(t),this.cursorOffsetCache={},this.renderCursorOrSelection()}_render(t){super._render(t)}renderCursorOrSelection(){if(!this.isEditing)return;const t=this.clearContextTop(!0);if(!t)return;const e=this._getCursorBoundaries();this.selectionStart===this.selectionEnd?this.renderCursor(t,e):this.renderSelection(t,e),t.restore()}renderCursorAt(t){const e=this._getCursorBoundaries(t,!0);this._renderCursor(this.canvas.contextTop,e,t)}_getCursorBoundaries(t,e){typeof t>"u"&&(t=this.selectionStart);const i=this._getLeftOffset(),s=this._getTopOffset(),o=this._getCursorBoundariesOffsets(t,e);return{left:i,top:s,leftOffset:o.left,topOffset:o.top}}_getCursorBoundariesOffsets(t,e){return e?this.__getCursorBoundariesOffsets(t):this.cursorOffsetCache&&"top"in this.cursorOffsetCache?this.cursorOffsetCache:this.cursorOffsetCache=this.__getCursorBoundariesOffsets(t)}__getCursorBoundariesOffsets(t){let e=0,i=0;const{charIndex:s,lineIndex:o}=this.get2DCursorLocation(t);for(let p=0;p<o;p++)e+=this.getHeightOfLine(p);const l=this._getLineLeftOffset(o),c=this.__charBounds[o][s];c&&(i=c.left),this.charSpacing!==0&&s===this._textLines[o].length&&(i-=this._getWidthOfCharSpacing());const u={top:e,left:l+(i>0?i:0)};return this.direction==="rtl"&&(this.textAlign==="right"||this.textAlign==="justify"||this.textAlign==="justify-right"?u.left*=-1:(this.textAlign==="left"||this.textAlign==="justify-left"||this.textAlign==="center"||this.textAlign==="justify-center")&&(u.left=l-(i>0?i:0))),u}renderCursor(t,e){this._renderCursor(t,e,this.selectionStart)}_renderCursor(t,e,i){const s=this.get2DCursorLocation(i),o=s.lineIndex,l=s.charIndex>0?s.charIndex-1:0,c=this.getValueOfPropertyAt(o,l,"fontSize"),u=this.scaleX*this.canvas.getZoom(),p=this.cursorWidth/u,m=this.getValueOfPropertyAt(o,l,"deltaY"),v=e.topOffset+(1-this._fontSizeFraction)*this.getHeightOfLine(o)/this.lineHeight-c*(1-this._fontSizeFraction);this.inCompositionMode&&this.renderSelection(t,e),t.fillStyle=this.cursorColor||this.getValueOfPropertyAt(o,l,"fill"),t.globalAlpha=this.__isMousedown?1:this._currentCursorOpacity,t.fillRect(e.left+e.leftOffset-p/2,v+e.top+m,p,c)}renderSelection(t,e){const i={selectionStart:this.inCompositionMode?this.hiddenTextarea.selectionStart:this.selectionStart,selectionEnd:this.inCompositionMode?this.hiddenTextarea.selectionEnd:this.selectionEnd};this._renderSelection(t,i,e)}renderDragSourceEffect(){this.__isDragging&&this.__dragStartSelection&&this.__dragStartSelection&&this._renderSelection(this.canvas.contextTop,this.__dragStartSelection,this._getCursorBoundaries(this.__dragStartSelection.selectionStart,!0))}renderDropTargetEffect(t){const e=this.getSelectionStartFromPointer(t);this.renderCursorAt(e)}_renderSelection(t,e,i){const s=e.selectionStart,o=e.selectionEnd,l=this.textAlign.indexOf("justify")!==-1,c=this.get2DCursorLocation(s),u=this.get2DCursorLocation(o),p=c.lineIndex,m=u.lineIndex,v=c.charIndex<0?0:c.charIndex,y=u.charIndex<0?0:u.charIndex;for(let b=p;b<=m;b++){const _=this._getLineLeftOffset(b)||0;let S=this.getHeightOfLine(b),k=0,A=0,O=0;if(b===p&&(A=this.__charBounds[p][v].left),b>=p&&b<m)O=l&&!this.isEndOfWrapping(b)?this.width:this.getLineWidth(b)||5;else if(b===m)if(y===0)O=this.__charBounds[m][y].left;else{const tt=this._getWidthOfCharSpacing();O=this.__charBounds[m][y-1].left+this.__charBounds[m][y-1].width-tt}k=S,(this.lineHeight<1||b===m&&this.lineHeight>1)&&(S/=this.lineHeight);let F=i.left+_+A,I=S,B=0;const K=O-A;this.inCompositionMode?(t.fillStyle=this.compositionColor||"black",I=1,B=S):t.fillStyle=this.selectionColor,this.direction==="rtl"&&(this.textAlign==="right"||this.textAlign==="justify"||this.textAlign==="justify-right"?F=this.width-F-K:(this.textAlign==="left"||this.textAlign==="justify-left"||this.textAlign==="center"||this.textAlign==="justify-center")&&(F=i.left+_-O)),t.fillRect(F,i.top+i.topOffset+B,K,I),i.topOffset+=k}}getCurrentCharFontSize(){const t=this._getCurrentCharIndex();return this.getValueOfPropertyAt(t.l,t.c,"fontSize")}getCurrentCharColor(){const t=this._getCurrentCharIndex();return this.getValueOfPropertyAt(t.l,t.c,"fill")}_getCurrentCharIndex(){const t=this.get2DCursorLocation(this.selectionStart,!0),e=t.charIndex>0?t.charIndex-1:0;return{l:t.lineIndex,c:e}}}const qh={type:"i-text",selectionStart:0,selectionEnd:0,selectionColor:"rgba(17,119,255,0.3)",isEditing:!1,editable:!0,editingBorderColor:"rgba(102,153,255,0.25)",cursorWidth:2,cursorColor:"",cursorDelay:1e3,cursorDuration:600,caching:!0,hiddenTextareaContainer:null,_reSpace:/\s|\n/,_currentCursorOpacity:1,_selectionDirection:null,inCompositionMode:!1,keysMap:Xh,keysMapRtl:Yh,ctrlKeysMapDown:Gh,ctrlKeysMapUp:Uh};Object.assign(ss.prototype,qh),$.setClass(ss);class Ne extends ss{constructor(){super(...arguments),this.__cachedLines=null}initDimensions(){this.initialized&&(this.isEditing&&this.initDelayedCursor(),this.clearContextTop(),this._clearCache(),this.dynamicMinWidth=0,this._styleMap=this._generateStyleMap(this._splitText()),this.dynamicMinWidth>this.width&&this._set("width",this.dynamicMinWidth),this.textAlign.indexOf("justify")!==-1&&this.enlargeSpaces(),this.height=this.calcTextHeight(),this.saveState({propertySet:"_dimensionAffectingProps"}))}_generateStyleMap(t){let e=0,i=0,s=0;const o={};for(let l=0;l<t.graphemeLines.length;l++)t.graphemeText[s]===`
`&&l>0?(i=0,s++,e++):!this.splitByGrapheme&&this._reSpaceAndTab.test(t.graphemeText[s])&&l>0&&(i++,s++),o[l]={line:e,offset:i},s+=t.graphemeLines[l].length,i+=t.graphemeLines[l].length;return o}styleHas(t,e){if(this._styleMap&&!this.isWrapping){const i=this._styleMap[e];i&&(e=i.line)}return super.styleHas(t,e)}isEmptyStyles(t){if(!this.styles)return!0;let e=0,i=t+1,s,o=!1;const l=this._styleMap[t],c=this._styleMap[t+1];l&&(t=l.line,e=l.offset),c&&(i=c.line,o=i===t,s=c.offset);const u=typeof t>"u"?this.styles:{line:this.styles[t]};for(const p in u)for(const m in u[p])if(m>=e&&(!o||m<s))for(const v in u[p][m])return!1;return!0}_getStyleDeclaration(t,e){if(this._styleMap&&!this.isWrapping){const i=this._styleMap[t];if(!i)return null;t=i.line,e=i.offset+e}return super._getStyleDeclaration(t,e)}_setStyleDeclaration(t,e,i){const s=this._styleMap[t];t=s.line,e=s.offset+e,this.styles[t][e]=i}_deleteStyleDeclaration(t,e){const i=this._styleMap[t];t=i.line,e=i.offset+e,delete this.styles[t][e]}_getLineStyle(t){const e=this._styleMap[t];return!!this.styles[e.line]}_setLineStyle(t){const e=this._styleMap[t];this.styles[e.line]={}}_wrapText(t,e){const i=[];this.isWrapping=!0;for(let s=0;s<t.length;s++)i.push(...this._wrapLine(t[s],s,e));return this.isWrapping=!1,i}_measureWord(t,e,i=0){let s=0,o;const l=!0;for(let c=0,u=t.length;c<u;c++){const p=this._getGraphemeBox(t[c],e,c+i,o,l);s+=p.kernedWidth,o=t[c]}return s}wordSplit(t){return t.split(this._wordJoiners)}_wrapLine(t,e,i,s=0){const o=this._getWidthOfCharSpacing(),l=this.splitByGrapheme,c=[],u=l?this.graphemeSplit(t):this.wordSplit(t),p=l?"":" ";let m=0,v=[],y=0,b=0,_=0,S=!0;u.length===0&&u.push([]),i-=s;const k=u.map(F=>{F=l?F:this.graphemeSplit(F);const I=this._measureWord(F,e,y);return _=Math.max(I,_),y+=F.length+1,{word:F,width:I}}),A=Math.max(i,_,this.dynamicMinWidth);y=0;let O;for(O=0;O<u.length;O++){const F=k[O].word,I=k[O].width;y+=F.length,m+=b+I-o,m>A&&!S?(c.push(v),v=[],m=I,S=!0):m+=o,!S&&!l&&v.push(p),v=v.concat(F),b=l?0:this._measureWord([p],e,y),y++,S=!1}return O&&c.push(v),_+s>this.dynamicMinWidth&&(this.dynamicMinWidth=_-o+s),c}isEndOfWrapping(t){return!this._styleMap[t+1]||this._styleMap[t+1].line!==this._styleMap[t].line}missingNewlineOffset(t){return this.splitByGrapheme?this.isEndOfWrapping(t)?1:0:1}_splitTextIntoLines(t){const e=super._splitTextIntoLines(t),i=this._wrapText(e.lines,this.width),s=new Array(i.length);for(let o=0;o<i.length;o++)s[o]=i[o].join("");return e.lines=s,e.graphemeLines=i,e}getMinWidth(){return Math.max(this.minWidth,this.dynamicMinWidth)}_removeExtraneousStyles(){const t={};for(const e in this._styleMap)this._textLines[e]&&(t[this._styleMap[e].line]=1);for(const e in this.styles)t[e]||delete this.styles[e]}toObject(t){return super.toObject(["minWidth","splitByGrapheme"].concat(t))}}const Kh={type:"textbox",minWidth:20,dynamicMinWidth:2,lockScalingFlip:!0,noScaleCache:!1,_dimensionAffectingProps:ro._dimensionAffectingProps.concat("width"),_wordJoiners:/[ \t\r]/,splitByGrapheme:!1};Object.assign(Ne.prototype,Kh),$.setClass(Ne);const Zh=()=>({ml:new Gt({x:-.5,y:0,cursorStyleHandler:Oe,actionHandler:Ys,getActionName:xi}),mr:new Gt({x:.5,y:0,cursorStyleHandler:Oe,actionHandler:Ys,getActionName:xi}),mb:new Gt({x:0,y:.5,cursorStyleHandler:Oe,actionHandler:Us,getActionName:xi}),mt:new Gt({x:0,y:-.5,cursorStyleHandler:Oe,actionHandler:Us,getActionName:xi}),tl:new Gt({x:-.5,y:-.5,cursorStyleHandler:He,actionHandler:_i}),tr:new Gt({x:.5,y:-.5,cursorStyleHandler:He,actionHandler:_i}),bl:new Gt({x:-.5,y:.5,cursorStyleHandler:He,actionHandler:_i}),br:new Gt({x:.5,y:.5,cursorStyleHandler:He,actionHandler:_i}),mtr:new Gt({x:0,y:-.5,actionHandler:Fn,cursorStyleHandler:An,offsetY:-40,withConnection:!0,actionName:"rotate"})}),Jh=()=>({mr:new Gt({x:.5,y:0,actionHandler:Vs,cursorStyleHandler:Oe,actionName:"resizing"}),ml:new Gt({x:-.5,y:0,actionHandler:Vs,cursorStyleHandler:Oe,actionName:"resizing"})}),oo=Zh(),Qh=Object.assign(Object.assign({},oo),Jh());_t.prototype.controls=Object.assign(Object.assign({},_t.prototype.controls||{}),oo),Ne&&(Ne.prototype.controls=Object.assign(Object.assign({},Ne.prototype.controls||{}),Qh));const tc={parseElements:to,parseAttributes:te,cache:Le,version:Fi,iMatrix:Bt,createCollectionMixin:Ts,StaticCanvas:de,Canvas:Qi,config:d,loadSVGFromURL:xh,loadSVGFromString:Ph,initFilterBackend:gr,Canvas2dFilterBackend:fr,WebGLFilterBackend:pr,runningAnimations:Ze,Point:T,Intersection:Ot,Color:J,Control:Gt,Observable:Ar,Gradient:Ks,Pattern:Zs,Shadow:zt,BaseBrush:ts,PencilBrush:Si,CircleBrush:Oh,SprayBrush:Dh,PatternBrush:Mh,Object:_t,Line:Ti,Circle:ze,Triangle:es,Ellipse:ki,Rect:Se,Path:$e,Polyline:Ve,Polygon:is,Text:Qt,IText:ss,Textbox:Ne,Group:oe,ActiveSelection:Pi,Image:Kt,controlsUtils:{scaleCursorStyleHandler:He,skewCursorStyleHandler:Bn,scaleSkewCursorStyleHandler:Oe,rotationWithSnapping:Fn,scalingEqually:_i,scalingX:jn,scalingY:In,scalingYOrSkewingX:Us,scalingXOrSkewingY:Ys,changeWidth:Vs,skewHandlerX:Hn,skewHandlerY:$n,dragHandler:Mn,scaleOrSkewActionName:xi,rotationStyleHandler:An,wrapWithFixedAnchor:ke,wrapWithFireEvent:Te,getLocalPoint:Gi,renderCircleControl:En,renderSquareControl:Dn},util:{rotatePoint:Dl,removeFromArray:_e,getRandomInt:be,wrapElement:Lr,parsePreserveAspectRatioAttribute:ps,pick:Ie,setStyle:Xi,getSvgAttributes:jo,cos:Dt,sin:Mt,rotateVector:Ms,createVector:ii,calcAngleBetweenVectors:$i,getUnitVector:zi,getBisector:As,degreesToRadians:ot,radiansToDegrees:Fe,projectStrokeOnPoints:an,transformPoint:ct,invertTransform:kt,composeMatrix:_r,qrDecompose:ue,calcDimensionsMatrix:Cs,calcRotateMatrix:Ri,multiplyTransformMatrices:gt,stylesFromArray:hn,stylesToArray:ln,hasStyleChanged:Vi,getElementOffset:jr,object:{clone:ri,extend:si},createCanvasElement:Y,createImage:nt,copyCanvasElement:Et,toDataURL:mt,toFixed:it,matrixToSVG:Ge,groupSVGElements:Fl,parseUnit:Wt,findScaleToFit:Kr,findScaleToCover:Zr,capValue:Ce,saveObjectTransform:Es,resetObjectTransform:$r,addTransformToObject:Hr,applyTransformToObject:We,removeTransformFromObject:tl,makeBoundingBoxFromPoints:Be,calcPlaneChangeMatrix:Rs,sendPointToPlane:js,transformPointRelativeToCanvas:Ll,sendObjectToPlane:un,string:{graphemeSplit:Ur,capitalize:Xr,escapeXml:Yr},loadImage:Qe,enlivenObjects:je,enlivenObjectEnlivables:ti,joinPath:Hs,parsePath:Cn,makePathSimpler:fn,getSmoothPathFromPoints:bn,getPathSegmentsInfo:Bs,getBoundsOfCurve:Is,getPointOnPath:Ws,transformPath:Ul,getRegularPolygonPath:Gl,isTouchEvent:Yi,getPointer:_n,getNodeCanvas:Os,cleanUpJsdomNode:Je,makeElementUnselectable:ks,makeElementSelectable:Za,isTransparent:zs,sizeAfterTransform:Ds,mergeClipPaths:Zl,request:xn,ease:Xa,animateColor:Mr,animate:Ss,requestAnimFrame:Ke,cancelAnimFrame:kr,classRegistry:$},filters:{BaseFilter:at,BlendColor:Ue,BlendImage:ni,Blur:oi,Brightness:ai,ColorMatrix:xe,Composed:li,Contrast:hi,Convolute:ci,Sepia:rn,Brownie:Jr,Vintage:Qr,Kodachrome:tn,Technicolor:en,Polaroid:sn,BlackWhite:nn,Gamma:ui,Grayscale:di,HueRotation:fi,Invert:pi,Noise:gi,Pixelate:mi,RemoveColor:yi,Resize:vi,Saturation:wi,Vibrance:Ci},getFilterBackend:Ai,getEnv:D,getDocument:W,getWindow:N,setEnvForTests:q,parseStyleAttribute:Sr,parsePointsAttribute:io,parseFontDeclaration:Pr,parseTransformAttribute:Ii,getCSSRules:Nn};r.fabric=tc})(or)),or}var X=zc();class Ct extends X.fabric.Point{constructor(n,h,d){super(n,h),this.type="PSPoint",this.pressure=d}midPointFrom(n){const h=super.midPointFrom(n);return new Ct(h.x,h.y,(this.pressure+n.pressure)/2)}clone(){return new Ct(this.x,this.y,this.pressure)}}Ct.fromObject=function(r,n){n&&n(new Ct(r.x,r.y,r.pressure))};X.fabric.PSPoint=Ct;X.fabric.util&&X.fabric.util.registerClass?X.fabric.util.registerClass(Ct,"PSPoint"):X.fabric.ClassRegistry&&X.fabric.ClassRegistry.register(Ct,"PSPoint");function mo(r,n=.5){return r.touches&&r.touches.length>0?r.touches[0].force:r.pointerType==="mouse"||typeof r.pressure!="number"||r.pointerType==="touch"&&r.pressure===0?n:r.pressure}function Eo(r,n){function h(){const d=Object.create(r.prototype);return Object.assign(d,n),d.callSuper=function(f,...g){const w=r.prototype[f];if(typeof w=="function")return w.apply(this,g)},d.initialize&&d.initialize.apply(d,arguments),d}return h.prototype=Object.create(r.prototype),Object.assign(h.prototype,n),h.prototype.constructor=h,h.prototype.callSuper=function(d,...f){const g=r.prototype[d];if(typeof g=="function")return g.apply(this,f)},h}class Do{constructor(n){this.min=1e-4,this.magic=.07999999821186066,this.fallback=.1,this.brush=n}onMouseDown(n){const h=mo(n,this.fallback);return h===this.magic?this.min:h}onMouseMove(n,h){const d=mo(n,this.fallback),f=this.brush.pressureIgnoranceOnStart>Date.now()-this.brush.currentStartTime,g=Array.isArray(h)&&h.length>0,w=g?h[h.length-1].pressure:this.min,C=f?this.min:d===this.magic?w:Math.max(this.min,d);return!f&&g&&w===this.min&&C!==this.min&&(h.forEach(x=>x.pressure=Math.max(x.pressure,C)),this.brush._redrawSegments(h)),C}onMouseUp(){}}X.fabric.PressureManager=Do;class Vc{set tolerance(n){typeof n!="number"&&(n=1),this._tolerance=n,this.sqTolerance=n*n}get tolerance(){return this._tolerance}constructor(){this._tolerance=1,this.sqTolerance=1}getSquareDistance(n,h){let d=n.x-h.x,f=n.y-h.y;return d*d+f*f}getSquareSegmentDistance(n,h,d){let f=h.x,g=h.y,w=d.x-f,C=d.y-g;if(w!==0||C!==0){let x=((n.x-f)*w+(n.y-g)*C)/(w*w+C*C);x>1?(f=d.x,g=d.y):x>0&&(f+=w*x,g+=C*x)}return w=n.x-f,C=n.y-g,w*w+C*C}simplifyRadialDistance(n){let h=n[0],d=[h],f;for(let g=1,w=n.length;g<w;g++)f=n[g],this.getSquareDistance(f,h)>this.sqTolerance&&(d.push(f),h=f);return h!==f&&d.push(f),d}simplifyDouglasPeucker(n){let h=n.length,d=typeof Uint8Array<"u"?Uint8Array:Array,f=new d(h),g=0,w=h-1,C=[],x=[],P,E,D,W;for(f[g]=f[w]=1;w;){for(E=0,P=g+1;P<w;P++)D=this.getSquareSegmentDistance(n[P],n[g],n[w]),D>E&&(W=P,E=D);E>this.sqTolerance&&(f[W]=1,C.push(g,W,W,w)),w=C.pop(),g=C.pop()}for(P=0;P<h;P++)f[P]&&x.push(n[P]);return x}do(n,h){return n=h?n:this.simplifyRadialDistance(n),n=this.simplifyDouglasPeucker(n),n}}class Nc extends Vc{constructor(){super(),this.pressureCoeff=100}getSquareDistance(n,h){var d=n.x-h.x,f=n.y-h.y,g=n.pressure-h.pressure;return d*d+f*f+g*g*this.pressureCoeff}getSquareSegmentDistance(n,h,d){var f=h.x,g=h.y,w=h.pressure,C=d.x-f,x=d.y-g,P=d.pressure-w;if(C!==0||x!==0||P!==0){var E=((n.x-f)*C+(n.y-g)*x+(n.pressure-w)*P*this.pressureCoeff)/(C*C+x*x+P*P*this.pressureCoeff);E>1?(f=d.x,g=d.y,w=d.pressure):E>0&&(f+=C*E,g+=x*E,w+=P*E)}return C=n.x-f,x=n.y-g,P=n.pressure-w,C*C+x*x+P*P*this.pressureCoeff}}const Xe=X.fabric.util,Xc=Xe.object.extend,Yc=X.fabric.util.createClass||X.fabric.util.lang_class&&X.fabric.util.lang_class.createClass||Eo,Uc=Yc(X.fabric.Object,{type:"PSStroke",strokePoints:null,startTime:null,endTime:null,cacheProperties:X.fabric.Object.prototype.cacheProperties.concat("strokePoints","startTime","endTime","fillRule"),stateProperties:X.fabric.Object.prototype.stateProperties.concat("strokePoints","startTime","endTime"),initialize:function(r,n){n=n||{},this.callSuper("initialize",n),this.startTime=n.startTime,this.endTime=n.endTime,this.strokePoints=(r||[]).concat(),n.stroke!==void 0&&(this.stroke=n.stroke),n.strokeWidth!==void 0&&(this.strokeWidth=n.strokeWidth),this._setPositionDimensions(n)},_setPositionDimensions:function(r){var n=this._parseDimensions();this.width=n.width,this.height=n.height,typeof r.left>"u"&&typeof r.top>"u"&&(this.left=n.left,this.top=n.top),this.strokeOffset=this.strokeOffset||{x:n.left+this.width/2,y:n.top+this.height/2}},_renderStroke:function(r){let n,h=this.strokeWidth/1e3,d=this.strokePoints[0],f=this.strokePoints[1],g=this.strokePoints.length,w=-this.strokeOffset.x,C=-this.strokeOffset.y;if(g===2&&!(d.x===f.x&&d.y===f.y)){r.strokeStyle=this.stroke,r.lineCap=this.strokeLineCap,r.lineJoin=this.strokeLineJoin,r.lineWidth=this.strokeWidth,r.beginPath(),r.moveTo(d.x+w,d.y+C),r.lineTo(f.x+w,f.y+C),r.stroke();return}let x=d,P=1,E=1;for(g>2&&(P=this.strokePoints[2].x<f.x?-1:this.strokePoints[2].x===f.x?0:1,E=this.strokePoints[2].y<f.y?-1:this.strokePoints[2].y===f.y?0:1),this.strokePoints.length===2&&d.x===f.x&&d.y===f.y&&(d=new Ct(d.x,d.y,d.pressure),f=new Ct(f.x,f.y,f.pressure),d.x-=h,f.x+=h,x.x=d.x),r.strokeStyle=this.stroke,r.lineCap=this.strokeLineCap,r.lineJoin=this.strokeLineJoin,n=1,g=this.strokePoints.length;n<g;n++)r.beginPath(),r.moveTo(x.x-P*h+w,x.y-E*h+C),r.lineWidth=d.pressure*this.strokeWidth,x=d.midPointFrom(f),r.quadraticCurveTo(d.x-P*h+w,d.y-E*h+C,x.x-P*h+w,x.y-E*h+C),d=this.strokePoints[n],f=this.strokePoints[n+1],r.stroke()},_render:function(r){this._renderStroke(r),this._renderPaintInOrder(r)},toString:function(){return"#<Stroke ("+this.complexity()+'): { "top": '+this.top+', "left": '+this.left+" }>"},toObject:function(r){var n=Xc(this.callSuper("toObject",r),{strokePoints:this.strokePoints.map(h=>h.clone()),startTime:this.startTime,endTime:this.endTime,top:this.top,left:this.left});return n},_toSVG:function(){const r=['<g transform="translate(',String(-this.strokeOffset.x),",",String(-this.strokeOffset.y),')" ',"COMMON_PARTS",`>
`];let n=null;for(let h=0;h<this.strokePoints.length;h++){let d=this.strokePoints[h];if(n){const f=n.x,g=n.y,w=d.x,C=d.y;r.push("<line ",'x1="',String(f),'" y1="',String(g),'" x2="',String(w),'" y2="',String(C),'" ','stroke-width="',String(n.pressure*this.strokeWidth),'" ',`stroke-linecap="round" />
`)}n=d}return r.push(`</g>
`),r},toClipPathSVG:function(r){return"	"+this._createBaseClipPathSVGMarkup(this._toSVG(),{reviver:r})},toSVG:function(r){return this._createBaseSVGMarkup(this._toSVG(),{reviver:r})},complexity:function(){return this.strokePoints.length},_parseDimensions:function(){function r(){this.bounds=[],this.aX=[],this.aY=[],this.x=0,this.y=0}r.prototype._done=function(){this.bounds.forEach(C=>{this.aX.push(C.x),this.aY.push(C.y)}),this.aX.push(this.x),this.aY.push(this.y)},r.prototype.moveTo=function(C,x){this.x=C,this.y=x,this.bounds=[],this._done()},r.prototype.quadraticCurveTo=function(C,x,P,E){this.bounds=Xe.getBoundsOfCurve(this.x,this.y,C,x,C,x,P,E),this.x=P,this.y=E,this._done()},r.prototype.calcBounds=function(){var C=Math.min(...this.aX)||0,x=Math.min(...this.aY)||0,P=Math.max(...this.aX)||0,E=Math.max(...this.aY)||0,D=P-C,W=E-x;return{left:C,top:x,width:D,height:W}};var n=new r,h,d,f=this.strokePoints[0],g=this.strokePoints[1];if(this.strokePoints.length===2&&!(f.x===g.x&&f.y===g.y))return n.aX.push(f.x,f.x,g.x,g.x),n.aY.push(f.y,f.y,g.y,g.y),n.lineWidth=this.strokeWidth/3,n.calcBounds();var w=f;for(h=1,d=this.strokePoints.length;h<d;h++)n.moveTo(w.x,w.y),n.lineWidth=f.pressure*this.strokeWidth,w=f.midPointFrom(g),n.quadraticCurveTo(f.x,f.y,w.x,w.y),f=this.strokePoints[h],g=this.strokePoints[h+1];return n.calcBounds()}}),jt=Uc;jt.fromObject=function(r,n){if(!n){console.warn("PSStroke.fromObject: callback is required");return}function h(g,w){if(!g||g.length===0){w([]);return}const C=g.filter(D=>D!=null);if(C.length===0){w([]);return}const x=[];let P=0;const E=C.length;C.forEach((D,W)=>{if(D){if(D.type==="PSPoint"&&Ct.fromObject)Ct.fromObject(D,N=>{if(x[W]=N,P++,P===E)return w(x)});else if(x[W]=D,P++,P===E)return w(x)}else if(x[W]=D,P++,P===E)return w(x)})}function d(g){const w=r.stroke,C=r.fill;Xe.enlivenPatterns?Xe.enlivenPatterns([r.fill,r.stroke],function(x){x?(r.fill=x[0]!==void 0?x[0]:C,r.stroke=x[1]!==void 0?x[1]:w):(r.fill=C,r.stroke=w),g()}):g()}function f(g){if(!r.clipPath){g(null);return}Xe.enlivenObjects?Xe.enlivenObjects([r.clipPath],function(w){g(w&&w.length>0?w[0]:null)},null,null):g(r.clipPath)}d(function(){f(function(g){r.clipPath=g,h(r.strokePoints||[],function(w){const C=new jt(w,r);!C.stroke&&r.stroke&&(C.stroke=r.stroke),n(C)})})})};X.fabric.PSStroke=jt;const Gc=X.fabric.util.createClass||X.fabric.util.lang_class&&X.fabric.util.lang_class.createClass||Eo,qc=Gc(X.fabric.BaseBrush,{simplify:null,pressureManager:null,pressureCoeff:100,simplifyTolerance:0,simplifyHighestQuality:!1,pressureIgnoranceOnStart:-1,opacity:1,disableTouch:!1,currentStartTime:null,disablePressure:!1,initialize:function(r){this.simplify=new Nc,this.pressureManager=new Do(this),this.canvas=r,this._points=[]},_drawSegment:function(r,n,h){var d=n.midPointFrom(h);return r.lineWidth=n.pressure*this.width,r.quadraticCurveTo(n.x,n.y,d.x,d.y),d},onMouseDown:function(r,n){const h=n?n.pointer:r,d=n?n.e:r.e||null;this.disableTouch&&d&&(d.touches||d.pointerType==="touch")||(this.drawStraightLine=d&&d.shiftKey===!0,this.disablePressure=d&&(d.ctrlKey===!0||d.metaKey===!0),this._prepareForDrawing(h,d),this._captureDrawingPath(h,d),this._render())},onMouseMove:function(r,n){const h=n?n.pointer:r,d=n?n.e:r.e||null;if(!(this.disableTouch&&d&&(d.touches||d.pointerType==="touch"))&&(this.drawStraightLine=d&&d.shiftKey===!0,this.disablePressure=d&&(d.ctrlKey===!0||d.metaKey===!0),this._captureDrawingPath(h,d)&&this._points.length>1))if(this.needsFullRender||this.drawStraightLine)this.canvas.clearContext(this.canvas.contextTop),this._render();else{const f=this._points,g=f.length,w=this.canvas.contextTop;this._saveAndTransform(w),this.oldEnd&&(w.beginPath(),w.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(w,f[g-2],f[g-1],!0),w.stroke(),w.restore()}},onMouseUp:function(r){const n=r&&r.e?r.e:null;this.disableTouch&&n&&(n.touches||n.pointerType==="touch")||(this.oldEnd=void 0,this._finalizeAndAddPath(),this.pressureManager.onMouseUp())},_prepareForDrawing:function(r,n){let h=this.pressureManager.onMouseDown(n);this.disablePressure&&(h=1);const d=new Ct(r.x,r.y,h);this._reset(),this._addPoint(d),this.canvas.contextTop.moveTo(d.x,d.y),this.currentStartTime=Date.now()},_addPoint:function(r){return this._points.length>1&&r.eq(this._points[this._points.length-1])?!1:(this.drawStraightLine&&this._points.length>1&&(this._hasStraightLine=!0,this._points.pop()),this._points.push(r),!0)},_reset:function(){const r=this.canvas.contextTop;this._points.length=0,this._setBrushStyles(r);var n=new X.fabric.Color(this.color);this.needsFullRender=n.getAlpha()<1,this._setShadow()},_captureDrawingPath:function(r,n){let h=this.pressureManager.onMouseMove(n,this._points);this.disablePressure&&(h=1);const d=new Ct(r.x,r.y,h);return this._addPoint(d)},_redrawSegments:function(r){const n=this.canvas.contextTop;this._saveAndTransform(n),this.oldEnd&&n.closePath();let h=this._points[0];n.moveTo(h.x,h.y),n.beginPath(),this._points.forEach(d=>{this.oldEnd=this._drawSegment(n,h,d,!0),h=d}),n.stroke(),n.restore()},_render:function(){var r=this.canvas.contextTop,n,h,d=this._points[0],f=this._points[this._points.length-1],g=d;if(this._saveAndTransform(r),this.drawStraightLine&&this._points.length>=2){const P=r.globalCompositeOperation,E=r.globalAlpha;r.globalCompositeOperation="destination-atop",r.globalAlpha=this.opacity,r.beginPath(),r.moveTo(d.x,d.y),r.lineWidth=this.width,r.lineTo(f.x,f.y),r.stroke(),r.restore(),r.globalCompositeOperation=P,r.globalAlpha=E;return}if(this._points.length===2&&d.x===f.x&&d.y===f.y){var w=d.pressure*this.width/1e3;d=new Ct(d.x,d.y,d.pressure),f=new Ct(f.x,f.y,f.pressure),d.x-=w,f.x+=w,g.x=d.x}d=this._points[0],f=this._points[1],g=d;const C=r.globalCompositeOperation,x=r.globalAlpha;for(r.globalCompositeOperation="destination-atop",r.globalAlpha=this.opacity,n=1,h=this._points.length;n<h;n++)r.beginPath(),r.moveTo(g.x,g.y),g=this._drawSegment(r,d,f),r.closePath(),r.stroke(),d=this._points[n],f=this._points[n+1];r.restore(),r.globalCompositeOperation=C,r.globalAlpha=x},convertPointsToSVGPath:function(r){var n=[],h,d=this.width/1e3,f=r.length,g=new Ct(r[0].x,r[0].y,r[0].pressure),w=new Ct(r[1].x,r[1].y,r[1].pressure),C=g,x=1,P=1,E=f>2;for(E&&(x=r[2].x<w.x?-1:r[2].x===w.x?0:1,P=r[2].y<w.y?-1:r[2].y===w.y?0:1),h=1;h<f;h++)n.push("M ",C.x-x*d," ",C.y-P*d," "),g.eq(w)||(C=g.midPointFrom(w),n.push("Q ",g.x," ",g.y," ",C.x," ",C.y," ")),g=r[h],h+1<r.length&&(w=r[h+1]);return E&&(x=g.x>r[h-2].x?1:g.x===r[h-2].x?0:-1,P=g.y>r[h-2].y?1:g.y===r[h-2].y?0:-1),n.push("L ",g.x+x*d," ",g.y+P*d),n},createPSStroke:function(r){var n=new jt(r,{fill:null,stroke:this.color,strokeWidth:this.width,strokeLineCap:this.strokeLineCap,strokeMiterLimit:this.strokeMiterLimit,strokeLineJoin:this.strokeLineJoin,strokeDashArray:this.strokeDashArray}),h=new X.fabric.Point(n.left+n.width/2,n.top+n.height/2);return h=n.translateToGivenOrigin(h,"center","center",n.originX,n.originY),n.top=h.y,n.left=h.x,this.shadow&&(this.shadow.affectStroke=!0,n.shadow=new X.fabric.Shadow(this.shadow)),n},_finalizeAndAddPath:function(){var r=this.canvas.contextTop;if(r.closePath(),this.drawStraightLine&&this._points.length>=2){const d=this._points[0],f=this._points[this._points.length-1],g=(d.pressure+f.pressure)/2;this._points=[new Ct(d.x,d.y,g),new Ct(f.x,f.y,g)]}this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate)),this.simplifyTolerance>0&&!this.drawStraightLine&&(this.simplify.pressureCoeff=this.pressureCoeff,this.simplify.tolerance=this.simplifyTolerance,this._points=this.simplify.do(this._points,this.simplifyHighestQuality));var n=this.convertPointsToSVGPath(this._points).join("");if(n==="M 0 0 Q 0 0 0 0 L 0 0"){this.canvas.requestRenderAll();return}const h=this.createPSStroke(this._points);h.opacity=this.opacity,h.stroke=this.color,h.strokeWidth=this.width,h.startTime=this.currentStartTime,h.endTime=Date.now(),this.canvas.clearContext(this.canvas.contextTop),this.canvas.add(h),h.setCoords(),this._resetShadow(),this.canvas.fire("path:created",{path:h})}}),ur=qc;X.fabric.PSBrush=ur;console.log("psbush");X.fabric&&X.fabric.Text.prototype.set({_getNonTransformedDimensions(){return new X.fabric.Point(this.width,this.height).scalarAdd(this.padding)},_calculateCurrentDimensions(){return X.fabric.util.transformPoint(this._getTransformedDimensions(),this.getViewportTransform(),!0)}});jt&&(jt.prototype._getTransformedDimensions=function(){const r=this.width*this.scaleX,n=this.height*this.scaleY;return new X.fabric.Point(r,n)},jt.prototype.getAncestors||(jt.prototype.getAncestors=function(){return[]}),jt.prototype.contextTop||(jt.prototype.contextTop=function(){return{}}),jt.prototype.dispose||(jt.prototype.dispose=function(){return{}}),jt.prototype.getRelativeCenterPoint||(jt.prototype.getRelativeCenterPoint=function(){return new X.fabric.Point(this.getCenterPoint?this.getCenterPoint():{x:this.left,y:this.top})}));const Kc={emits:["annotation-changed"],data(){return{fabricCanvas:null,fabricCanvasComparison:null,lastAnnotationTime:"",additions:[],deletions:[],updates:[],isShowingPalette:!1,isShowingPencilPalette:!1,notSave:!1,pencilColor:"#ff3860",pencilWidth:"big",textColor:"#ff3860",mouseIsDrawing:!1,mouseDrawingPressureMode:"distance",mouseDrawingStartTime:null,mouseDrawingMinPressure:.4,mouseDrawingMaxPressure:.8,mouseDrawingFadeTime:100,mouseDrawingDistanceFalloff:2,mouseDrawingMaxChangeRate:.03,mouseDrawingPrevPoint:null,mouseDrawingPrevPressure:null,mouseDrawingDynamicDistanceMult:null}},created(){this.resetUndoStacks()},computed:{annotationCanvas(){return this.$refs["annotation-canvas"]}},methods:{findAnnotation(r,n){return r.find(h=>h.time<n+1e-4&&h.time>n-1e-4)},getObjectById(r){return this.fabricCanvas.getObjects().find(n=>n.id===r)},addSerialization(r){return r.serialize=function(){const n=r.toJSON();return n.id=this.id,n.canvasWidth=this.canvasWidth,n.canvasHeight=this.canvasHeight,n.angle=this.angle,n.scale=this.scale,n.createdBy=this.createdBy,n},r},setObjectData(r){return r.set?(r.id||r.set("id",os()),r.set("canvasWidth",this.fabricCanvas.width),r.set("canvasHeight",this.fabricCanvas.height)):(r.id||(r.id=os()),r.canvasWidth=this.fabricCanvas.width,r.canvasHeight=this.fabricCanvas.height),r.createdBy||r.set("createdBy",this.userId),this.addSerialization(r),r},addObject(r,n=!0){r._objects?r._objects.forEach(h=>{this.fabricCanvas.add(h),this.$options.doneActionStack.pop()}):this.fabricCanvas.add(r),n&&(this.$options.doneActionStack.push({type:"add",obj:r}),this.saveAnnotations())},addText(r){if(this.fabricCanvas.getActiveObject())return;const h=(this.canvas||this.canvasWrapper).getBoundingClientRect(),d=this.getClientX(r)-h.x,f=this.getClientY(r)-h.y,g=320;let w=12;this.fabricCanvas.getHeight()>g&&(w=w*(this.fabricCanvas.getHeight()/g));const C=new X.fabric.IText("Type...",{left:d,top:f,fontFamily:"arial",fill:this.textColor,fontSize:w,backgroundColor:"rgba(255,255,255, 0.8)",padding:10});this.fabricCanvas.add(C),this.fabricCanvas.setActiveObject(C),C.enterEditing(),C.selectAll(),C.hiddenTextarea.onblur=()=>{this.saveAnnotations()}},addTypeArea(){const r=X.fabric.IText.prototype.initHiddenTextarea;X.fabric.util.object.extend(X.fabric.IText.prototype,{initHiddenTextarea:function(){r.call(this),this.canvas.wrapperEl.appendChild(this.hiddenTextarea)}})},removeTypeArea(){const r=X.fabric.IText.prototype.initHiddenTextarea;X.fabric.util.object.extend(X.fabric.IText.prototype,{initHiddenTextarea:function(){r.call(this),X.fabric.document&&X.fabric.document.body.appendChild(this.hiddenTextarea)}})},deleteSelection(){const r=this.fabricCanvas.getActiveObject();this.deleteObject(r)},deleteObject(r){r&&r._objects?r._objects.forEach(n=>{this.fabricCanvas.remove(n),this.addToDeletions(n),this.$options.doneActionStack.push({type:"remove",obj:n})}):r&&(this.fabricCanvas.remove(r),this.addToDeletions(r),this.$options.doneActionStack.push({type:"remove",obj:r})),this.saveAnnotations()},removeObjectFromCanvas(r){const n=this.getObjectById(r.id);n&&(n._objects?(n._objects.forEach(this.fabricCanvas.remove),this.fabricCanvas.remove(n)):this.fabricCanvas.remove(n))},updateObjectInCanvas(r,n){const h=this.getObjectById(n.id);h&&(this.removeObjectFromCanvas(h),this.addObjectToCanvas(r,n))},addToAdditions(r){this.markLastAnnotationTime();const n=this.getCurrentTime(),h=this.getCurrentFrame(),d=this.findAnnotation(this.additions,n);d?d.drawing.objects.push(r.serialize()):this.additions.push({time:n,frame:h,drawing:{objects:[r.serialize()]}}),this.postAnnotationAddition(n,r.serialize())},postAnnotationAddition(r,n){},removeFromAdditions(r){const n=this.getCurrentTime(),h=this.findAnnotation(this.additions,n);h&&(h.drawing.objects=h.drawing.objects.filter(d=>d.id!==r.id))},addToDeletions(r){this.markLastAnnotationTime();const n=this.getCurrentTime(),h=this.getCurrentFrame(),d=this.findAnnotation(this.deletions,n);d?d.objects.push(r.id):this.deletions.push({time:n,frame:h,objects:[r.id]}),r.serialize||this.addSerialization(r),this.postAnnotationDeletion(n,r.serialize())},postAnnotationDeletion(r,n){},removeFromDeletions(r){const n=this.getCurrentTime(),h=this.findAnnotation(this.deletions,n);h&&(h.objects=h.objects.filter(d=>d!==r.id))},addToUpdates(r){this.setObjectData(r),this.addToUpdatesSerializedObject(r.serialize())},addToUpdatesSerializedObject(r){this.markLastAnnotationTime();const n=this.getCurrentTime(),h=this.getCurrentFrame(),d=this.findAnnotation(this.updates,n);d?(d.drawing.objects=d.drawing.objects.filter(f=>f.id!==r.id),d.drawing.objects.push(r)):this.updates.push({time:n,frame:h,drawing:{objects:[r]}}),this.postAnnotationUpdate(n,r)},postAnnotationUpdate(r,n){},clearModifications(){this.additions=[],this.updates=[],this.deletions=[]},printModificationStats(r){console.log(r,this.additions.length>0?this.additions[0].drawing.objects.length:0,this.updates.length>0?this.updates[0].drawing.objects.length:0,this.deletions.length>0?this.deletions[0].objects.length:0)},isWriting(r){return this.lastAnnotationTime>=r},getNewAnnotations(r,n,h){if(this.fabricCanvas.getObjects().forEach(f=>{this.setObjectData(f),(f.type==="path"||f.type==="PSStroke")&&(f.canvasWidth||(f.canvasWidth=this.fabricCanvas.width),f.canvasHeight||(f.canvasHeight=this.fabricCanvas.height),f.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1,bl:!1,br:!this.isCurrentUserArtist,tl:!1,tr:!1,mtr:!this.isCurrentUserArtist}))}),h){if(h.drawing={objects:this.fabricCanvas._objects.map(f=>{const g=f.serialize();if(f.group){const w=f.group;g.left=w.left+Math.round(w.width/2)+f.left,g.top=w.top+Math.round(w.height/2)+f.top,g.group=null}return g})},h.time=r,h.drawing&&h.drawing.objects.length<1){const f=this.annotations.findIndex(g=>g.time===r);this.annotations.splice(f,1)}}else(!this.annotations||!this.annotations.push)&&(this.annotations=[]),this.$store.commit("ADD_ANNOTATION",{annotations:this.annotations,annotation:{time:Math.max(r,0),frame:Math.max(n,0),drawing:{objects:this.fabricCanvas._objects.map(f=>f.serialize())}}});this.updateAnnotationsInStore();const d=[];return this.annotations.forEach(f=>d.push({...f})),d},updateAnnotationsInStore(){const r=this.currentPreview;r&&this.$store.commit("UPDATE_PREVIEW_ANNOTATION",{taskId:r.task_id,preview:r,annotations:this.annotations})},loadSingleAnnotation(r,n=null){r.drawing.objects.forEach(h=>{this.addObjectToCanvas(r,h,n)})},loadSingleAnnotationComparison(r){r.drawing.objects.forEach(n=>{this.addObjectToCanvas(r,n,this.fabricCanvasComparison)})},async addObjectToCanvas(r,n,h=null){if(!n||this.getObjectById(n.id)&&!h)return;h||(h=this.fabricCanvas);let d,f,g,w=1,C=1;r?.width&&(w=h.width/r.width,C=h.width/r.width),r?.height&&(C=h.height/r.height);const x=n.canvasWidth||r.width,P=n.canvasHeight;x&&(w=h.width/x,C=h.width/x),P&&(C=h.height/P);const E={id:n.id,fill:"transparent",left:n.left*w,top:n.top*C,stroke:n.stroke,strokeWidth:n.strokeWidth,radius:n.radius,width:n.width,height:n.height,scaleX:n.scaleX*w,scaleY:n.scaleY*C,angle:n.angle,scale:n.scale,editable:!this.isCurrentUserArtist,selectable:!this.isCurrentUserArtist};if(n.type==="path"){let D=1;n.canvasWidth&&(D=x/h.width),h.width<420&&(D/=2),d=new X.fabric.Path(n.path,{...E}),d.set("id",n.id),d.set("strokeWidth",n.strokeWidth*D),d.set("canvasWidth",x),d.set("canvasHeight",P),this.addSerialization(d),d.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1,bl:!1,br:!this.isCurrentUserArtist,tl:!1,tr:!1,mtr:!this.isCurrentUserArtist}),this.$options.silentAnnnotation=!0,h.add(d),this.$options.silentAnnnotation=!1}else if(n.type==="i-text"||n.type==="text")f=new X.fabric.IText(n.text,{...E,fill:n.fill,left:n.left*w,top:n.top*C,fontFamily:n.fontFamily,fontSize:n.fontSize,backgroundColor:"rgba(255,255,255, 0.8)",padding:10}),f.set("id",n.id),f.set("canvasWidth",x),f.set("canvasHeight",P),this.addSerialization(f),f.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1,bl:!1,br:!1,tl:!1,tr:!1,mtr:!1}),this.$options.silentAnnnotation=!0,h.add(f),this.$options.silentAnnnotation=!1;else if(n.type==="PSStroke"&&n.canvasWidth){let D=x/h.width;h.width<420&&(D/=2),g=await this.deserializePSBrush(n),g.set("id",n.id),g.set("strokeWidth",n.strokeWidth*D),g.set("canvasWidth",x),g.set("canvasHeight",P),g.set("scaleX",n.scaleX*w),g.set("scaleY",n.scaleY*C),g.set("left",n.left*w),g.set("top",n.top*C),g.set("radius",n.radius),g.set("width",n.width),g.set("height",n.height),g.set("scaleX",n.scaleX*w),g.set("scaleY",n.scaleY*C),g.set("angle",n.angle),g.set("scale",n.scale),g.set("editable",!this.isCurrentUserArtist),g.set("selectable",!this.isCurrentUserArtist),this.addSerialization(g),g.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1,bl:!1,br:!this.isCurrentUserArtist,tl:!1,tr:!1,mtr:!this.isCurrentUserArtist}),this.$options.silentAnnnotation=!0,h.add(g),this.$options.silentAnnnotation=!1}return d||f||g},deserializePSBrush(r){return new Promise((n,h)=>{jt.fromObject(r,function(d){d?n(d):h(new Error("Failed to deserialize PSStroke"))})})},onPickPencilWidth(){this.isShowingPencilPalette=!this.isShowingPencilPalette},onPickPencilColor(){this.isShowingPalette=!this.isShowingPalette},onPickTextColor(){this.isShowingPalette=!this.isShowingPalette},onChangePencilColor(r){this.pencilColor=r,this._resetColor(),this.isShowingPalette=!1,ye.setPreference("player:pencil-color",this.pencilColor)},onChangePencilWidth(r){this.pencilWidth=r,this._resetPencil(),this.isShowingPalette=!1,ye.setPreference("player:pencil-width",this.pencilWidth)},onChangeTextColor(r){this.textColor=r,this.isShowingPalette=!1,ye.setPreference("player:text-color",this.textColor)},_resetColor(){this.fabricCanvas&&(this.fabricCanvas.freeDrawingBrush.color=this.pencilColor)},_resetPencil(){if(!this.fabricCanvas)return;const n={big:10,medium:5,small:2}[this.pencilWidth];this.fabricCanvas.freeDrawingBrush.width=n},resetPencilConfiguration(){this.pencilColor=ye.getPreference("player:pencil-color")||"#ff3860",this.textColor=ye.getPreference("player:text-color")||"#ff3860",this.pencilWidth=ye.getPreference("player:pencil-width")||"big",this._resetColor(),this._resetPencil()},onAnnotateClicked(){if(this.showCanvas(),this.isDrawing)this.fabricCanvas.isDrawingMode=!1,this.isDrawing=!1;else{this.isTyping=!1,this.fabricCanvas&&(this.fabricCanvas.isDrawingMode=!0),this.fabricCanvas.freeDrawingBrush=new X.fabric.PencilBrush(this.fabricCanvas);const r=new ur(this.fabricCanvas);this.fabricCanvas.freeDrawingBrush=r,r.pressureManager.fallback=.5,this._resetColor(),this._resetPencil(),this.isDrawing=!0}},onEraseClicked(){this.showCanvas(),this.isDrawing?(this.fabricCanvas.isDrawingMode=!1,this.isDrawing=!1):(this.isTyping=!1,this.fabricCanvas&&(this.fabricCanvas.isDrawingMode=!0),this.isDrawing=!0,this.previousStrokeWidth=this.fabricCanvas.freeDrawingBrush.width,this.fabricCanvas.freeDrawingBrush=new X.fabric.EraserBrush(this.fabricCanvas),this.fabricCanvas.freeDrawingBrush.width=10)},onTypeClicked(){const r=this.canvas.getElementsByClassName("upper-canvas")[0];this.showCanvas(),this.isTyping?(this.isTyping=!1,r.removeEventListener("dblclick",this.addText)):(this.fabricCanvas.isDrawingMode=!1,this.isDrawing=!1,this.isTyping=!0,r.addEventListener("dblclick",this.addText))},onWindowsClosed(r){if(this.notSaved){const n="Your annotations are not saved yet.";return r.returnValue=n,n}},onObjectAdded(r){if(this.$options.silentAnnnotation)return;let n=r.target?r.target:r.targets[0];if(n=this.setObjectData(n),this.isLaserModeOn){const h=this.getCurrentTime();this.fadeObject(n),this.postAnnotationAddition(h,n.serialize())}else this.addToAdditions(n),this.stackAddAction(r)},onObjectModified(r){const n=r.target;if(!n._objects)this.addToUpdates(n),this.saveAnnotations(),this.addSerialization(n);else{const h=n;h._objects.forEach(d=>{const f=this.getObjectById(d.id);this.setObjectData(f);const g=f.serialize(),w=new X.fabric.Point(d.left,d.top),C=X.fabric.util.transformPoint(w,h.calcTransformMatrix());g.left=C.x,g.top=C.y,g.angle+=h.angle,g.scaleX*=h.scaleX,g.scaleY*=h.scaleY,this.addToUpdatesSerializedObject(g)}),this.saveAnnotations()}},resetUndoStacks(){this.$options.doneActionStack=[],this.$options.undoneActionStack=[]},stackAddAction({target:r}){this.$options.doneActionStack.push({type:"add",obj:r}),r.lockScalingX=!0,r.lockScalingY=!0,r.rotation=!0},undoLastAction(){const r=this.$options.doneActionStack.pop();r&&r.obj&&(r.type==="add"?(this.deleteObject(r.obj),this.addToDeletions(r.obj),this.removeFromAdditions(r.obj)):r.type==="remove"&&(this.addObject(r.obj),this.addToAdditions(r.obj),this.removeFromDeletions(r.obj)),this.$options.doneActionStack.pop(),this.$options.undoneActionStack.push(r))},redoLastAction(){const r=this.$options.undoneActionStack.pop();r&&(r.type==="add"?this.addObject(r.obj):r.type==="remove"&&this.deleteObject(r.obj))},clearUndoneStack(){this.$options.undoneActionStack=[]},deleteAllAnnotations(){this.fabricCanvas._objects.forEach(this.deleteObject)},clearAnnotationSelection(){const r=this.fabricCanvas;r.activeObject&&(r.discardActiveObject(),r.renderAll())},resizeAnnotations(){this.resetCanvas().then(()=>{this.reloadAnnotations(),this.loadAnnotation()})},resetCanvas(){return this.clearCanvas(),this.resetCanvasSize().then(()=>(this.fabricCanvas&&this.fabricCanvas.renderAll(),this.resetCanvasVisibility(),this.fabricCanvas))},resetCanvasVisibility(){this.isAnnotationsDisplayed&&this.$refs["canvas-wrapper"]?this.$refs["canvas-wrapper"].style.display="block":this.$refs["canvas-wrapper"]&&(this.$refs["canvas-wrapper"].style.display="none")},isAnnotationCanvas(){return!!this.fabricCanvas},setAnnotationCanvasDimensions(r,n){this.fabricCanvas.setDimensions({width:r,height:n})},setAnnotationDrawingMode(r){this.fabricCanvas.isDrawingMode=r},reloadAnnotations(){if(this.annotations=[],this.preview.annotations){const r=[];this.preview.annotations.forEach(n=>r.push({...n})),this.annotations=r.sort((n,h)=>n.time<h.time)||[]}else this.annotations=[];return this.annotations},setupFabricCanvas(){if(!this.annotationCanvas)return;const r=this.annotationCanvas.id;if(this.fabricCanvas=oc(new X.fabric.Canvas(r,{fireRightClick:!0})),this.fabricCanvas.setDimensions({width:100,height:100}),!this.fabricCanvas.freeDrawingBrush){const n=new ur(this.fabricCanvas);this.fabricCanvas.freeDrawingBrush=n}return this.configureCanvas(),this.fabricCanvas},configureCanvas(){return this.fabricCanvas.off("object:moved",this.onObjectModified),this.fabricCanvas.off("text:changed",this.onObjectModified),this.fabricCanvas.off("object:modified",this.onObjectModified),this.fabricCanvas.off("object:added",this.onObjectAdded),this.fabricCanvas.off("mouse:down",this.onCanvasClicked),this.fabricCanvas.off("mouse:down",this.initalizeMouseDrawing),this.fabricCanvas.off("mouse:move",this.onCanvaMouseMoved),this.fabricCanvas.off("mouse:move",this.updateMousePressure),this.fabricCanvas.off("mouse:up",this.endDrawing),this.fabricCanvas.off("mouse:up",this.onCanvasReleased),this.fabricCanvas.off("mouse:move",this.onCanvasMouseMoved),this.fabricCanvas.off("mouse:down",this.onCanvasClicked),this.fabricCanvas.on("object:moved",this.onObjectModified),this.fabricCanvas.on("object:modified",this.onObjectModified),this.fabricCanvas.on("text:changed",this.onObjectModified),this.fabricCanvas.on("object:added",this.onObjectAdded),this.fabricCanvas.on("erasing:end",this.onObjectAdded),this.fabricCanvas.on("mouse:down",this.onCanvasClicked),this.fabricCanvas.on("mouse:down",this.initalizeMouseDrawing),this.fabricCanvas.on("mouse:move",this.onCanvasMouseMoved),this.fabricCanvas.on("mouse:move",this.updateMousePressure),this.fabricCanvas.on("mouse:up",this.endDrawing),this.fabricCanvas.on("mouse:up",this.onCanvasReleased),this.fabricCanvas.freeDrawingBrush.color=this.pencilColor,this.fabricCanvas.freeDrawingBrush.width=4,X.fabric.Group.prototype._controlsVisibility={tl:!1,tr:!1,br:!this.isCurrentUserArtist,bl:!1,ml:!1,mr:!1,mb:!1,mt:!1},X.fabric.Group.prototype.hasControls=!0,this.fabricCanvas},initalizeMouseDrawing(){this.isDrawing&&this.fabricCanvas.freeDrawingBrush&&(this.mouseIsDrawing=!0,this.mouseDrawingStartTime=Date.now(),this.mouseDrawingPrevPoint=this.fabricCanvas.getPointer(),this.mouseDrawingPrevPressure=this.fabricCanvas.freeDrawingBrush?this.fabricCanvas.freeDrawingBrush.pressureManager.fallback:this.mouseDrawingMaxPressure)},getCanvasRelativePointDrawingDifference(r,n,h){const d=new X.fabric.Point(h.getWidth(),h.getHeight()),f=r.divide(d),g=n.divide(d);return Math.sqrt(Math.pow(Math.abs(f.x-g.x),1)+Math.pow(Math.abs(f.y-g.y),1))},updateMousePressure(){if(this.isDrawing&&this.fabricCanvas.freeDrawingBrush&&this.mouseIsDrawing){let r;if(this.mouseDrawingPressureMode==="fade"){const d=(Date.now()-this.mouseDrawingStartTime)/this.mouseDrawingFadeTime;r=Math.max((1-d)*this.mouseDrawingMaxPressure+d*this.mouseDrawingMinPressure,this.mouseDrawingMinPressure)}else if(this.mouseDrawingPressureMode==="distance"&&this.mouseDrawingPrevPoint){let h=this.getCanvasRelativePointDrawingDifference(this.mouseDrawingPrevPoint,this.fabricCanvas.getPointer(),this.fabricCanvas);h*=50,this.mouseDrawingDynamicDistanceMult||(h<1.8?this.mouseDrawingDynamicDistanceMult=Math.min(h*h,1.5):this.mouseDrawingDynamicDistanceMult=1),h*=this.mouseDrawingDynamicDistanceMult,r=Math.min(this.mouseDrawingDistanceFalloff/h,this.mouseDrawingMaxPressure)}else r=.5;const n=Math.max(this.mouseDrawingPrevPressure-this.mouseDrawingMaxChangeRate,Math.min(r,this.mouseDrawingPrevPressure+this.mouseDrawingMaxChangeRate));this.mouseDrawingPrevPoint=this.fabricCanvas.getPointer(),this.mouseDrawingPrevPressure=n,this.fabricCanvas.freeDrawingBrush.pressureManager.fallback=n}},endDrawing(){this.isDrawing&&(this.mouseIsDrawing&&(this.mouseIsDrawing=!1,this.mouseDrawingStartTime=null,this.mouseDrawingPrevPoint=null,this.mouseDrawingDynamicDistanceMult=null,this.fabricCanvas.freeDrawingBrush.pressureManager.fallback=this.mouseDrawingMaxPressure),this.clearUndoneStack(),this.isLaserModeOn||this.saveAnnotations())},isEmptyCanvas(){return this.fabricCanvas?this.fabricCanvas.getObjects().length>0:!0},clearCanvas(){this.endAnnotationSaving(),this.fabricCanvas&&this.fabricCanvas.clear(),this.fabricCanvasComparison&&this.fabricCanvasComparison.clear()},copyAnnotations(){if(!this.fabricCanvas)return;const r=this.fabricCanvas.getActiveObject();if(r)return r._objects?sr.copyAnnotations({mainObject:r,subObjects:[...r._objects]}):sr.copyAnnotations({mainObject:Object.create(r),subObjects:[]}),r},pasteAnnotations(){if(!this.fabricCanvas)return;this.fabricCanvas.discardActiveObject();const{mainObject:r,subObjects:n}=sr.pasteAnnotations();n?.length>0?(n.forEach(h=>{h=this.applyGroupChanges(r,h),h.group=null,this.addObject(h)}),this.fabricCanvas.requestRenderAll()):r&&(this.addObject(r),this.fabricCanvas.setActiveObject(r),this.fabricCanvas.requestRenderAll())},applyGroupChanges(r,n){if(n.group){const h=new X.fabric.Point(n.left,n.top),d=X.fabric.util.transformPoint(h,r.calcTransformMatrix());n.left=d.x,n.top=d.y,n.angle+=r.angle,n.scaleX*=r.scaleX,n.scaleY*=r.scaleY}return n},fadeObject(r){r&&r.animate("opacity","0",{duration:1500,onChange:this.fabricCanvas.renderAll.bind(this.fabricCanvas),onComplete:()=>{this.fabricCanvas.remove(r)}})},markLastAnnotationTime(){const r=rc().add(2,"hour").add(6,"seconds");this.lastAnnotationTime=nc(r).replace(" ","T")},startAnnotationSaving(r,n){this.notSaved=!0,this.$options.annotatedPreview=r,this.$options.annotationToSave=setTimeout(()=>{this.endAnnotationSaving()},3e3)},endAnnotationSaving(){if(this.notSaved){const r=this.$options.annotatedPreview;this.$options.changesToSave={preview:r,additions:[...this.additions],updates:[...this.updates],deletions:[...this.deletions]},this.clearModifications(),clearTimeout(this.$options.annotationToSave),this.notSaved=!1,this.$emit("annotation-changed",this.$options.changesToSave),this.onAnnotationChanged&&this.onAnnotationChanged(this.$options.changesToSave)}},copyAnnotationCanvas(r,n){return new Promise(h=>{this.clearCanvas(),this.loadSingleAnnotation(n),setTimeout(()=>{const d=r.getContext("2d"),f=r.width/this.fabricCanvas.width,g=document.getElementById("resize-annotation-canvas"),w=new X.fabric.Canvas("resize-annotation-canvas",{width:r.width,height:r.height});this.fabricCanvas.getObjects().find(C=>{C._objects?C._objects.forEach(x=>{w.add(x),x.strokeWidth=x.strokeWidth/f}):(w.add(C),C.strokeWidth=C.strokeWidth/f)}),w.setZoom(f),setTimeout(()=>(d.drawImage(g,0,0,r.width,r.height),setTimeout(()=>{w.dispose()},100),h()),100)},100)})}}},yo={emits:[],computed:{joinedRoom(){return this.room.people.find(r=>r===this.user.id)}},methods:{isValidRoomId(r){return r?.id&&r.id!=="temp"},openRoom(r){this.$socket.emit("preview-room:open-playlist",{playlist_id:r||this.room.id,user_id:this.user.id})},closeRoom(r){this.$socket.emit("preview-room:close-playlist",{playlist_id:r,user_id:this.user.id})},joinRoom(){this.isValidRoomId(this.room)&&(this.isFullMode&&(this.isFullMode=!1),this.$socket.emit("preview-room:join",{user_id:this.user.id,playlist_id:this.room.id,is_playing:this.isPlaying,current_entity_id:this.currentEntity?.id,current_entity_index:this.playingEntityIndex,current_preview_file_id:this.currentPreview?this.currentPreview.id:null,current_preview_file_index:this.currentPreviewIndex,current_frame:this.currentFrameMovieOrPicture,is_repeating:this.isRepeating,is_laser_mode:this.isLaserModeOn,is_annotations_displayed:this.isAnnotationsDisplayed,is_waveform_displayed:this.isWaveformDisplayed,is_zoom_enabled:this.isZoomEnabled,handle_in:this.handleIn,handle_out:this.handleOut,speed:this.speed,comparing:{enable:this.isComparing,task_type:this.taskTypeToCompare,revision:this.revisionToCompare,mode:this.comparisonMode,comparison_preview_index:this.currentComparisonPreviewIndex}}))},leaveRoom(r){this.user&&this.$socket.emit("preview-room:leave",{user_id:this.user.id,playlist_id:r||this.room.id})},sendUpdatePlayingStatus(){this.isCurrentPreviewMovie?this.onNextTimeUpdateActions.push(this.updateRoomStatus):this.updateRoomStatus()},updateRoomStatus(r=null){if(!this.isValidRoomId(this.room)||!this.joinedRoom)return;const n={user_id:this.user.id,local_id:this.room.localId,playlist_id:this.room.id,is_playing:this.isPlaying,current_entity_id:this.currentEntity?.id,current_entity_index:this.playingEntityIndex,current_preview_file_index:this.currentPreviewIndex,current_preview_file_id:this.currentPreview?this.currentPreview.id:null,previous_preview_file_id:r,current_frame:this.currentFrameMovieOrPicture,is_repeating:this.isRepeating,is_laser_mode:this.isLaserModeOn,is_annotations_displayed:this.isAnnotationsDisplayed,is_waveform_displayed:this.isWaveformDisplayed,is_zoom_enabled:this.isZoomEnabled,handle_in:this.handleIn,handle_out:this.handleOut,speed:this.speed,comparing:{enable:this.isComparing,task_type:this.taskTypeToCompare,revision:this.revisionToCompare,mode:this.comparisonMode,comparison_preview_index:this.currentComparisonPreviewIndex}};this.$socket.emit("preview-room:room-updated",n)},postPanZoomChanged(r,n,h){!this.isValidRoomId(this.room)||!this.joinedRoom||this.$socket.emit("preview-room:panzoom-changed",{playlist_id:this.room.id,data:{local_id:this.room.localId,user_id:this.user.id,x:r,y:n,zoom:h}})},postComparisonPanZoomChanged(r,n,h){!this.isValidRoomId(this.room)||!this.joinedRoom||this.$socket.emit("preview-room:comparison-panzoom-changed",{playlist_id:this.room.id,data:{local_id:this.room.localId,user_id:this.user.id,x:r,y:n,zoom:h}})},postAnnotationAddition(r,n){this.isValidRoomId(this.room)&&this.$socket.emit("preview-room:add-annotation",{playlist_id:this.room.id,data:{local_id:this.localId,user_id:this.user.id,time:r,obj:n}})},postAnnotationDeletion(r,n){this.isValidRoomId(this.room)&&this.$socket.emit("preview-room:remove-annotation",{playlist_id:this.room.id,data:{local_id:this.localId,user_id:this.user.id,time:r,obj:n}})},postAnnotationUpdate(r,n){this.isValidRoomId(this.room)&&this.$socket.emit("preview-update-annotation",{playlist_id:this.room.id,data:{local_id:this.localId,user_id:this.user.id,time:r,obj:n}})},getPreviewFileFromEntity(r,n){if(!r)return null;let h=null;const d=Object.keys(r.preview_files);let f=0;for(;f<d.length&&!h;){const g=d[f];h=r.preview_files[g].find(C=>C.id===n),f++}return h},loadRoomCurrentState(r){r.is_playing!==this.isPlaying&&!r.is_playing&&this.pause();const n=this.currentPreview?this.currentPreview.id:null;let h=!1;if(this.exists(r.current_entity_index)&&r.current_entity_index!==this.playingEntityIndex)this.playEntity(r.current_entity_index),h=!0;else if(this.exists(r.current_preview_file_id)&&r.current_preview_file_id!==n&&r.current_preview_file_index===0){const d=r.current_preview_file_id,f=this.findEntity({entity_id:r.current_entity_id,preview_file_id:r.previous_preview_file_id}),g=this.getPreviewFileFromEntity(f,d),C=this.taskMap.get(g.task_id).task_type_id;this.changePreviewFile(f,g);const x=this.$refs["entity-"+this.playingEntityIndex][0];x.setPreviewFileId(d),x.setTaskTypeId(C)}if(this.exists(r.current_preview_file_index)&&r.current_preview_index!==this.currentPreviewIndex&&(this.currentPreviewIndex=r.current_preview_file_index,h=!0),this.exists(r.current_frame)&&this.$nextTick(()=>{this.loadRoomCurrentFrame(r),h&&this.$nextTick(()=>{this.updateProgressBar(),this.onWindowResize()})}),this.exists(r.is_repeating)&&r.is_repeating!==this.isRepeating&&(this.isRepeating=r.is_repeating),this.exists(r.speed)&&r.speed!==this.speed){this.speed=r.speed;let d=1;this.speed===2&&(d=.5),this.speed===1&&(d=.25),this.setPlayerSpeed(d)}this.exists(r.comparing)&&(this.isComparing=r.comparing.enable,this.taskTypeToCompare=r.comparing.task_type,this.revisionToCompare=r.comparing.revision,this.comparisonMode=r.comparing.mode,this.currentComparisonPreviewIndex=r.comparing.comparison_preview_index),r.is_playing!==this.isPlaying&&(r.is_playing?this.play():this.pause()),this.exists(r.is_waveform_displayed)&&r.is_waveform_displayed!==this.isWaveformDisplayed&&(this.isWaveformDisplayed=r.is_waveform_displayed),this.exists(r.is_laser_mode)&&r.is_laser_mode!==this.isLaserModeOn&&(this.isLaserModeOn=r.is_laser_mode),this.exists(r.is_annotations_displayed)&&r.is_annotations_displayed!==this.isAnnotationsDisplayed&&(this.isAnnotationsDisplayed=r.is_annotations_displayed),this.exists(r.is_zoom_enabled)&&r.is_zoom_enabled!==this.isZoomEnabled&&(this.isZoomEnabled=r.is_zoom_enabled),this.exists(r.handle_in)&&r.handle_in!==this.handleIn&&(this.handleIn=r.handle_in),this.exists(r.handle_out)&&r.handle_out!==this.handleOut&&(this.handleOut=r.handle_out)},loadRoomCurrentFrame(r){if(r.current_frame!==this.currentFrameMovieOrPicture){const n=r.current_frame-1;this.rawPlayer.setCurrentFrame(n),this.currentTimeRaw=n*this.frameDuration+.01,this.syncComparisonPlayer&&this.syncComparisonPlayer(),this.updateProgressBar(),this.clearCanvas();const h=this.getAnnotation(n*this.frameDuration);h&&this.loadAnnotation(h)}else this.isCurrentPreviewPicture&&r.current_frame!==this.framesSeenOfPicture&&(this.framesSeenOfPicture=r.current_frame)},onPreviousFrameClicked(){this.clearFocus(),this.goPreviousFrame(),this.sendUpdatePlayingStatus()},onNextFrameClicked(){this.clearFocus(),this.goNextFrame(),this.sendUpdatePlayingStatus()}},socket:{events:{"preview-room:room-people-updated"(r){this.isValidRoomId(this.room)&&(this.room.people=r.people,this.joinedRoom&&(this.room.newComer=!1))},"preview-room:room-updated"(r){this.isValidRoomId(this.room)&&this.room.localId!==r.local_id&&(this.people=r.people,this.joinedRoom&&this.room.localId!==r.local_id&&(r.only_newcomer&&!this.newComer||this.loadRoomCurrentState(r)))},"preview-room:panzoom-changed"(r){if(!this.isValidRoomId(this.room)||!this.joinedRoom||this.room.localId===r.local_id)return;const n=r.data.x,h=r.data.y,d=r.data.zoom;this.setPanZoom(n,h,d)},"preview-room:comparison-panzoom-changed"(r){if(!this.isValidRoomId(this.room)||!this.joinedRoom||this.room.localId===r.local_id)return;const n=r.data.x,h=r.data.y,d=r.data.zoom;this.setComparisonPanZoom(n,h,d)},"preview-room:add-annotation"(r){if(!this.isValidRoomId(this.room)||!this.joinedRoom)return;const n=this.getAnnotation(r.time),h=r.data.obj;this.getObjectById(h)||(this.isLaserModeOn?this.addObjectToCanvas(n,h).then(d=>this.fadeObject(d)):this.addObjectToCanvas(n,h))},"preview-room:remove-annotation"(r){if(!this.isValidRoomId(this.room)||!this.joinedRoom)return;const n=r.data.obj;this.getObjectById(n)&&this.removeObjectFromCanvas(n)},"preview-room:update-annotation"(r){if(!this.isValidRoomId(this.room)||!this.joinedRoom)return;const n=this.getAnnotation(r.time),h=r.data.obj;this.updateObjectInCanvas(n,h)}}}},vo={emits:["annotations-refreshed"],data(){return{annotations:[],color:"#ff3860",currentPreviewIndex:0,currentTime:"00:00.000",currentTimeRaw:0,entityList:[],entityListToCompare:[],framesPerImage:[],framesSeenOfPicture:1,fullScreen:!1,isCommentsHidden:!0,isComparing:!1,isDrawing:!1,isEntitiesHidden:!1,isHd:!1,isMuted:!1,isPlaying:!1,isRepeating:!1,isTyping:!1,maxDuration:"00:00.000",maxDurationRaw:0,onNextTimeUpdateActions:[],pencil:"big",pencilPalette:["big","medium","small"],playingEntityIndex:0,playingPreviewFileId:null,speed:3,task:null,textColor:"#ff3860",volume:50}},beforeUnmount(){this.endAnnotationSaving(),this.removeEvents(),this.leaveRoom()},computed:{...Ee(["isCurrentUserArtist","isCurrentUserClient","taskMap","taskTypeMap","user"]),container(){return this.$refs.container},rawPlayer(){return this.$refs["raw-player"]},rawPlayerComparison(){return this.$refs["raw-player-comparison"]},picturePlayer(){return this.$refs["picture-player"]},picturePlayerComparison(){return this.$refs["picture-player-comparison"]},soundPlayer(){return this.$refs["sound-player"]},modelPlayer(){return this.$refs["object-player"]},canvas(){return this.$refs["canvas-wrapper"]},progress(){return this.$refs["video-progress"]},video(){return this.$refs.movie},extension(){return!this.currentPreview||!this.currentPreview.extension?"":this.currentPreview.extension},isCurrentPreviewMovie(){return this.extension==="mp4"},isCurrentPreviewPicture(){return this.isPicture(this.extension)},isCurrentPreviewModel(){return this.isModel(this.extension)},isCurrentPreviewSound(){return this.isSound(this.extension)},isCurrentPreviewPdf(){return this.isPdf(this.extension)},isCurrentPreviewFile(){return!this.isCurrentPreviewMovie&&!this.isCurrentPreviewPicture&&!this.isCurrentPreviewSound&&!this.isCurrentPreviewModel&&!this.isCurrentPreviewPdf},isComparisonOverlay(){return this.comparisonMode!=="sidebyside"},overlayOpacity(){if(this.isComparing&&this.isComparisonOverlay)switch(this.comparisonMode){case"overlay0":return 1;case"overlay25":return .25;case"overlay50":return .5;case"overlay75":return .75;case"overlay100":return 0;default:return 1}else return 1},currentPreviewPath(){if(this.currentPreview){let r=this.currentPreview.id,n=this.currentPreview.extension;if(this.currentPreviewIndex>0){const h=this.currentPreviewIndex-1,d=this.currentEntity.preview_file_previews[h];r=d.id,n=d.extension}return`/api/pictures/originals/preview-files/${r}.${n}`}else return""},currentComparisonPreviewPath(){if(this.currentPreviewToCompare&&(this.isPictureComparison||this.isMovieComparison)){const r=this.currentPreviewToCompare.extension,n=this.currentPreviewToCompare.id;return this.isPictureComparison?`/api/pictures/originals/preview-files/${n}.${r}`:`/api/movies/originals/preview-files/${n}.${r}`}else return""},currentPreviewDlPath(){return this.currentPreview?`/api/pictures/originals/preview-files/${this.currentPreview.id}/download`:""},currentEntity(){return this.entityList[this.playingEntityIndex]},currentPreview(){return this.currentEntity?this.currentPreviewIndex===0?{id:this.currentEntity.preview_file_id,extension:this.currentEntity.preview_file_extension,task_id:this.currentEntity.preview_file_task_id,revision:this.currentEntity.preview_file_revision,width:this.currentEntity.preview_file_width,height:this.currentEntity.preview_file_height,annotations:this.currentEntity.preview_file_annotations||[],duration:this.currentEntity.preview_file_duration||0}:this.currentEntity.preview_file_previews[this.currentPreviewIndex-1]:null},currentEntityPreviewLength(){return!this.currentEntity||!this.currentEntity.preview_file_previews?0:this.currentEntity.preview_file_previews.length+1},isFullScreenEnabled(){return!!(document.fullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled||document.webkitSupportsFullscreen||document.webkitFullscreenEnabled||document.createElement("video").webkitRequestFullScreen)},frameDuration(){return Math.round(1/this.fps*1e4)/1e4},fps(){return parseFloat(this.currentProduction?.fps)||25},frameNumber(){if(this.isCurrentPreviewPicture)return this.framesSeenOfPicture-1;let r=this.currentTimeRaw/this.frameDuration;return r>=this.nbFrames&&(r=this.nbFrames),Math.round(r)-1},currentFrame(){return Po(this.frameNumber+2)},currentFrameMovieOrPicture(){return this.isCurrentPreviewMovie?parseInt(this.currentFrame):this.isCurrentPreviewPicture?this.framesSeenOfPicture:0},nbFrames(){const n=!!window.chrome?this.frameDuration:0,h=this.currentPreview&&this.currentPreview.duration?this.currentPreview.duration:this.maxDurationRaw+n;return Math.round(h*this.fps)}},methods:{...wo(["refreshPreview"]),isMovie(r){return r==="mp4"},isPicture(r){return["gif","png","jpg","jpeg"].includes(r)},isModel(r){return["glb","gltf"].includes(r)},isSound(r){return["mp3","wav"].includes(r)},isPdf(r){return r==="pdf"},exists(r){return r!=null},configureEvents(){window.addEventListener("keydown",this.onKeyDown,!1),window.addEventListener("resize",this.onWindowResize),this.$el.nomousemove||(this.$el.onmousemove=this.onMouseMove),this.container&&(this.container.addEventListener("fullscreenchange",this.onFullScreenChange,!1),this.container.addEventListener("mozfullscreenchange",this.onFullScreenChange,!1),this.container.addEventListener("MSFullscreenChange",this.onFullScreenChange,!1),this.container.addEventListener("webkitfullscreenchange",this.onFullScreenChange,!1)),window.addEventListener("beforeunload",this.onWindowsClosed)},removeEvents(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("resize",this.onWindowResize),window.removeEventListener("beforeunload",this.onWindowsClosed),this.$el.onmousemove=null,this.container&&(this.container.removeEventListener("fullscreenchange",this.onFullScreenChange,!1),this.container.removeEventListener("mozfullscreenchange",this.onFullScreenChange,!1),this.container.removeEventListener("MSFullscreenChange",this.onFullScreenChange,!1),this.container.removeEventListener("webkitfullscreenchange",this.onFullScreenChange,!1))},formatTime:Cc,displayBars(){this.$refs["button-bar"]&&(this.$refs.header&&(this.$refs.header.style.opacity=1),this.$refs["button-bar"]&&(this.$refs["button-bar"].style.opacity=1),this.$refs["video-progress"]&&(this.$refs["video-progress"].$el.style.opacity=1),this.container.style.cursor="default")},hideBars(){this.$refs.header&&(this.$refs.header.style.opacity=0),this.$refs["button-bar"]&&(this.$refs["button-bar"].style.opacity=0),this.$refs["video-progress"]&&(this.$refs["video-progress"].$el.style.opacity=0)},updateTaskPanel(){if(this.entityList.length>0){const r=this.entityList[this.playingEntityIndex];r?this.task=this.taskMap.get(r.preview_file_task_id):this.task=null}else this.task=null},updateProgressBar(){this.progress&&this.progress.updateProgressBar(this.frameNumber)},playClicked(){this.play(),this.updateRoomStatus()},pauseClicked(){this.pause(),this.updateRoomStatus()},play(){if(this.playingPictureTimeout&&clearTimeout(this.playingPictureTimeout),this.isFullMode)this.fullPlayer.currentTime>=this.fullPlayer.duration-this.frameDuration?(this.setPlaylistProgress(0),this.progress.updateProgressBar(0),this.$nextTick(this.playFullBuild)):this.playFullBuild();else if(this.isCurrentPreviewPicture)this.playPicture();else if(this.isCurrentPreviewSound)this.playSound();else if(this.isCurrentPreviewModel)this.playModel();else{if(!this.rawPlayer)return;this._setCurrentTimeOnHandleIn(),this.rawPlayer.play(),this.isComparing&&this.rawPlayerComparison.play(),this.isPlaying=this.rawPlayer.isPlaying}this.clearCanvas()},playFullBuild(){this.fullPlayer.play(),this.isPlaying=!0,this._runPlaylistProgressUpdateLoop()},_setCurrentTimeOnHandleIn(){this.handleIn>1&&this.frameNumber<this.handleIn&&(this.rawPlayer.setCurrentTimeRaw(this.handleIn*this.frameDuration),this.syncComparisonPlayer())},_runPlaylistProgressUpdateLoop(){clearInterval(this.$options.playLoop),this.$options.playLoop=setInterval(()=>{if(this.setPlaylistProgress(this.fullPlayer.currentTime),this.currentEntity){const n=(this.fullPlayer.currentTime-this.currentEntity.start_duration)*this.fps;this.progress.updateProgressBar(n)}},1e3/this.fps)},_stopPlaylistProgressUpdateLoop(){clearInterval(this.$options.playLoop)},pause(){if(this.resetCanvasVisibility(),this.isFullMode)this.fullPlayer.pause(),this.isPlaying=!1,this._stopPlaylistProgressUpdateLoop();else if(this.isCurrentPreviewMovie){const r=this.$refs["raw-player-comparison"];let n=0;this.rawPlayer&&(n=bc(this.rawPlayer.getCurrentTimeRaw(),this.fps)),this.rawPlayer&&this.rawPlayer.pause(),r&&r.pause(),r&&(this.rawPlayer.setCurrentTimeRaw(n),r.setCurrentTimeRaw(n))}else this.isCurrentPreviewSound?this.soundPlayer?.pause():this.isCurrentPreviewModel&&this.modelPlayer?.pause();this.isPlaying=!1},playEntity(r,n=!0,h=-1){const d=this.entityList[r],f=this.isDrawing===!0;if(this.clearCanvas(),this.framesSeenOfPicture=1,this.playingEntityIndex=r,d&&this.isMovie(d.preview_file_extension))this.$nextTick(()=>{this.scrollToEntity(this.playingEntityIndex),this.rawPlayer.loadEntity(r),this.annotations=d.preview_file_annotations||[],this.onProgressChanged(h+1,!1),this.isComparing&&this.$refs["raw-player-comparison"].loadEntity(r),this.isPlaying?this.isFullMode||(this.rawPlayer.play(),this.isComparing&&this.$refs["raw-player-comparison"].play()):(n&&(this.isFullMode&&!this.isPlaying?(this.fullPlayer.currentTime=d.start_duration,this.playlistProgress=d.start_duration):this.isFullMode||(this.playlistProgress=d.start_duration)),this.resetCanvasVisibility())});else{const g=this.getAnnotation(0);this.isPlaying||this.loadAnnotation(g),f&&setTimeout(()=>{this.isDrawing=!0,this.setAnnotationDrawingMode(!0)},100),this.isPlaying&&d&&this.isPicture(d.preview_file_extension)&&this.playPicture()}this.scrollToEntity(this.playingEntityIndex)},syncComparisonPlayer(){if(this.rawPlayer&&this.rawPlayerComparison&&this.isComparing&&this.rawPlayerComparison.currentPlayer){const r=Number(this.rawPlayer.getCurrentTimeRaw().toPrecision(4));this.rawPlayerComparison.setCurrentTimeRaw(r)}},goPreviousFrame(){if(this.clearCanvas(),this.isFullMode){let r=this.fullPlayer.currentTime-this.frameDuration;const n=Math.round(r*this.fps),h=this.playlistShotPosition[n];if(!h)return;const d=h.index,f=this.entityList[d];if(d!==this.playingEntityIndex){const g=f.preview_file_duration,w=Math.round(g*this.fps);this.playEntity(d,!1,w),this.onProgressChanged(w,!1)}r=n/this.fps,this.setFullPlayerTime(r)}else{if(!this.rawPlayer)return;this.rawPlayer.goPreviousFrame(),this.isComparing&&this.syncComparisonPlayer();const r=this.getAnnotation(this.rawPlayer.getCurrentTime());r&&this.loadSingleAnnotation(r)}},goNextFrame(){if(this.clearCanvas(),this.isFullMode){let r=this.fullPlayer.currentTime+this.frameDuration;const n=Math.round(r*this.fps),h=this.playlistShotPosition[n].index;h!==this.playingEntityIndex&&this.playEntity(h,!1),r=n/this.fps,this.setFullPlayerTime(r)}else{if(!this.rawPlayer)return;const r=this.rawPlayer.getCurrentTimeRaw()+this.frameDuration+1e-4;if(Math.round(r*this.fps)>=this.nbFrames)return;this.rawPlayer.goNextFrame(),this.isComparing&&this.syncComparisonPlayer();const h=this.getAnnotation(this.rawPlayer.getCurrentTime());h&&this.loadSingleAnnotation(h)}},goPreviousDrawing(){try{this.clearCanvas();const r=Number(this.getPreviousAnnotationTime(this.currentTimeRaw).frame)-1;if(this.isFullMode){const n=r/this.fps;this.setFullPlayerTime(n)}else this.rawPlayer.setCurrentTimeRaw(r/this.fps),this.onProgressChanged(r,!0);this.isComparing&&this.syncComparisonViewer()}catch(r){console.error("wrong call from unexpected player",r);return}},goNextDrawing(){try{this.clearCanvas();const r=Number(this.getNextAnnotationTime(this.currentTimeRaw).frame)-1;if(this.isFullMode){const n=r/this.fps;this.setFullPlayerTime(n)}else this.rawPlayer.setCurrentTimeRaw(r/this.fps),this.onProgressChanged(r,!0);this.isComparing&&this.syncComparisonViewer()}catch(r){console.error("wrong call from unexpected player",r);return}},setFullPlayerTime(r){if(!this.currentEntity)return;this.fullPlayer.currentTime=r,this.setPlaylistProgress(r);const h=(r-this.currentEntity.start_duration)*this.fps;this.progress.updateProgressBar(h+1)},setFullScreen(){this.container.requestFullscreen?this.container.requestFullscreen():this.container.mozRequestFullScreen?this.container.mozRequestFullScreen():this.container.webkitRequestFullScreen?this.container.webkitRequestFullScreen():this.container.msRequestFullscreen&&this.container.msRequestFullscreen(),this.container.setAttribute("data-fullscreen",!0),document.activeElement.blur(),this.fullScreen=!0},exitFullScreen(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),this.container.setAttribute("data-fullscreen",!1),document.activeElement.blur(),this.fullScreen=!1,setTimeout(()=>{this.triggerResize()},200),setTimeout(()=>{this.triggerResize()},500)},isFullScreen(){return!!(document.fullscreen||document.webkitIsFullScreen||document.mozFullScreen||document.msFullscreenElement||document.fullscreenElement)},onScrubStart(){this.$refs["button-bar"]&&this.$refs["button-bar"].classList.add("unselectable")},onScrubEnd(){this.$refs["button-bar"]&&this.$refs["button-bar"].classList.remove("unselectable")},onProgressChanged(r,n=!0){this.clearCanvas(),this.reloadAnnotations(!1),this.isCurrentPreviewPicture?this.framesSeenOfPicture=r+1:(this.rawPlayer.setCurrentFrame(r),this.syncComparisonPlayer());const h=this.getAnnotation(r*this.frameDuration);if(h&&this.loadAnnotation(h),this.sendUpdatePlayingStatus(),this.onFrameUpdate(r),this.isFullMode&&n){const d=this.currentEntity.start_duration,f=(r-1)/this.fps+d;this.fullPlayer.currentTime=f,this.playlistProgress=f}},onHandleInChanged({frameNumber:r,save:n}){this.handleIn=r,n&&this._saveHandles(),this.updateRoomStatus()},onHandleOutChanged({frameNumber:r,save:n}){this.handleOut=r,n&&this._saveHandles(),this.updateRoomStatus()},_saveHandles(){const r=this.shotMap.get(this.currentEntity.id),n={id:r.id,data:{...r.data}};n.data.handle_in=this.handleIn,n.data.handle_out=this.handleOut,this.editShot(n)},onPreviousFrameClicked(){this.clearFocus(),this.goPreviousFrame(),this.sendUpdatePlayingStatus()},onNextFrameClicked(){this.clearFocus(),this.goNextFrame(),this.sendUpdatePlayingStatus()},onPreviousDrawingClicked(){this.clearFocus(),this.goPreviousDrawing(),this.sendUpdatePlayingStatus()},onNextDrawingClicked(){this.clearFocus(),this.goNextDrawing(),this.sendUpdatePlayingStatus()},onPlayPauseClicked(){if(this.clearFocus(),!this.isPlaying)this.playClicked();else{this.pauseClicked();const r=this.getAnnotation(this.rawPlayer.getCurrentTime());r&&this.loadAnnotation(r),this.updateRoomStatus()}},onVideoRepeated(){this.isCommentsHidden||this.clearFocus(),this.isComparing&&(this.syncComparisonPlayer(),this.rawPlayerComparison.play())},onRepeatClicked(){this.clearFocus(),this.isRepeating=!this.isRepeating,this.updateRoomStatus()},onToggleSoundClicked(){this.clearFocus(),this.isMuted=!this.isMuted},onFullScreenChange(){this.fullScreen&&!this.isFullScreen()&&(this.fullScreen=!1,setTimeout(()=>{this.triggerResize()},200),setTimeout(()=>{this.triggerResize()},500))},onFullscreenClicked(){this.isFullScreen()?(this.removeTypeArea(),this.exitFullScreen()):(this.addTypeArea(),this.setFullScreen())},onKeyDown(r){this.displayBars(),["INPUT","TEXTAREA"].includes(r.target.tagName)||((r.keyCode===46||r.keyCode===8)&&this.fabricCanvas?this.deleteSelection():r.keyCode===37?(r.preventDefault(),r.stopPropagation(),(r.ctrlKey||r.metaKey)&&r.shiftKey&&this.moveSelectedEntityToLeft?this.moveSelectedEntityToLeft():r.altKey?(this.onPlayPreviousEntityClicked(),this.$nextTick(()=>{if(this.rawPlayer.setCurrentFrame(this.nbFrames-1),this.isFullMode){const x=this.currentEntity.start_duration+this.currentEntity.preview_file_duration-this.frameDuration;this.fullPlayer.currentTime=x,this.playlistProgress=x,this.setCurrentTimeRaw(this.currentEntity.preview_file_duration-this.frameDuration),this.updateProgressBar()}})):this.onPreviousFrameClicked()):r.keyCode===39?(r.preventDefault(),r.stopPropagation(),(r.ctrlKey||r.metaKey)&&r.shiftKey&&this.moveSelectedEntityToLeft?this.moveSelectedEntityToRight():r.altKey?(this.onPlayNextEntityClicked(),this.$nextTick(()=>{this.rawPlayer.setCurrentFrame(0)})):this.onNextFrameClicked()):r.keyCode===32?(r.preventDefault(),r.stopPropagation(),this.onPlayPauseClicked()):r.altKey&&r.keyCode===74?(r.preventDefault(),r.stopPropagation(),this.onPlayPreviousEntityClicked()):r.altKey&&r.keyCode===75?(r.preventDefault(),r.stopPropagation(),this.onPlayNextEntityClicked()):(r.ctrlKey||r.metaKey)&&r.keyCode===67?this.copyAnnotations():(r.ctrlKey||r.metaKey)&&r.keyCode===86?this.pasteAnnotations():r.key==="."?(r.preventDefault(),r.stopPropagation(),this.onNextDrawingClicked()):r.key===","?(r.preventDefault(),r.stopPropagation(),this.onPreviousDrawingClicked()):r.altKey&&r.key==="o"?(r.preventDefault(),r.stopPropagation(),this.toggleFullOverlayComparison()):(r.ctrlKey||r.metaKey)&&r.altKey&&r.keyCode===68?this.onAnnotateClicked():(r.ctrlKey||r.metaKey)&&r.keyCode===90?(r.preventDefault(),this.undoLastAction()):r.altKey&&r.keyCode===82?this.redoLastAction():r.keyCode===36?this.rawPlayer&&this.rawPlayer.setCurrentFrame(0):r.keyCode===35&&this.rawPlayer&&this.rawPlayer.setCurrentFrame(this.nbFrames-1))},onWindowResize(){const r=new Date().getTime();this.lastCall=this.lastCall||0,r-this.lastCall>100&&(this.lastCall=r,setTimeout(()=>{this.resetHeight(),this.resizeAnnotations()},200))},async toggleFullOverlayComparison(){this.isComparing||(this.isComparing=!0,await this.$nextTick(),await this.$nextTick()),this.$nextTick(()=>{this.comparisonMode==="overlay100"?this.comparisonMode="overlay0":this.comparisonMode="overlay100"})},reloadAnnotations(r=!0){this.annotations&&(this.annotations=this.annotations.map(n=>({...n})),r&&this.reloadCurrentAnnotation())},onFilmClicked(){this.isEntitiesHidden=!this.isEntitiesHidden,this.triggerResize(),this.$nextTick(()=>{this.resetHeight(),this.scrollToEntity(this.playingEntityIndex)})},getCurrentTime(){const r=qt(this.currentTimeRaw,this.fps)||0;return Number(r.toPrecision(4))},getCurrentFrame(){if(this.currentFrame)return this.currentFrame;{const r=qt(this.currentTimeRaw,this.fps)||0;return Math.round(r/this.frameDuration)}},setCurrentTimeRaw(r){const n=qt(r,this.fps)||0,h=n/this.frameDuration;if(this.rawPlayer){this.rawPlayer.setCurrentFrame(h),this.syncComparisonPlayer();const f=!!window.chrome?1e-4:0;this.currentTimeRaw=Number((n+f).toPrecision(4)),this.updateProgressBar()}return n},reloadCurrentAnnotation(){let r=qt(this.currentTimeRaw,this.fps)||0;this.isCurrentPreviewPicture&&(r=0);const n=this.getAnnotation(r);n&&this.loadAnnotation(n)},getSortedAnnotations(){const r=this.annotations;return r.sort((n,h)=>n.time-h.time),r},getNextAnnotationTime(r){const n=this.getSortedAnnotations();if(this.isMovie)return r=qt(r,this.fps),n.find(h=>qt(h.time,this.fps)>r+1e-4);if(this.isPicture)return n.find(h=>h.time===0)},getPreviousAnnotationTime(r){const n=this.getSortedAnnotations();if(this.isMovie)return r=qt(r,this.fps),n.findLast(h=>qt(h.time,this.fps)<r-1/this.fps+1e-4);if(this.isPicture)return n.find(h=>h.time===0)},onCommentClicked(){const r=this.$refs["video-container"].offsetHeight;this.isCommentsHidden=!this.isCommentsHidden,this.isCommentsHidden||(this.$refs["task-info"].$el.style.height=`${r}px`),this.triggerResize(),this.$nextTick(()=>{this.$refs["task-info"].focusCommentTextarea(),this.resetHeight()})},onCompareClicked(){this.isComparing=!this.isComparing,this.$nextTick(()=>{this.saveUserComparisonChoice(),this.comparisonEntityMissing=!1}),this.updateRoomStatus()},setPlayerSpeed(r){this.rawPlayer&&this.rawPlayer.setSpeed(r),this.rawPlayerComparison&&this.rawPlayerComparison.setSpeed(r)},onFrameUpdate(r){const h=!!window.chrome?1e-4:0;if(this.currentTimeRaw=Number((r*this.frameDuration+h).toPrecision(4)),this.currentTime=this.formatTime(this.currentTimeRaw,this.fps),this.updateProgressBar(),this.isShowAnnotationsWhilePlaying){const d=this.getAnnotation(this.currentTimeRaw);d?(this.clearCanvas(),this.loadSingleAnnotation(d)):this.clearCanvas()}if(this.playlist&&this.playlist.for_entity==="shot"&&this.handleOut<this.nbFrames&&this.frameNumber>=this.handleOut&&this.isPlaying&&(this.isRepeating?(this.rawPlayer.setCurrentFrame(this.handleIn),this.rawPlayerComparison.setCurrentFrame(this.handleIn)):this.onPlayNext()),this.isCurrentPreviewMovie&&this.wavesurfer&&this.isWaveformDisplayed){const d=this.currentTimeRaw/this.maxDurationRaw;this.wavesurfer.seekTo(d)}this.$nextTick(()=>{this.onNextTimeUpdateActions.forEach(f=>f()),this.onNextTimeUpdateActions=[]})},onMaxDurationUpdate(r){r?(r=Oi(r,this.fps),this.maxDurationRaw=r,this.maxDuration=this.formatTime(r,this.fps),this.resetHandles&&this.resetHandles()):(this.maxDurationRaw=0,this.maxDuration="00.00.000")},onMouseMove(){const r=this.$refs["button-bar"];r&&r.style.opacity!==1&&this.displayBars(),this.isFullScreen()&&this.isEntitiesHidden&&this.isCommentsHidden&&(this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.isFullScreen()&&this.isEntitiesHidden&&this.isCommentsHidden&&this.hideBars()},2e3))},playPicture(){this.playingPictureTimeout&&clearTimeout(this.playingPictureTimeout),this.framesSeenOfPicture=1,this.isPlaying=!0,this.playingPictureTimeout=setTimeout(()=>{this.continuePlayingPlaylist(this.playingEntityIndex,Date.now()-1e3*this.framesSeenOfPicture/this.fps)},100)},playSound(){this.playingPictureTimeout&&clearTimeout(this.playingPictureTimeout),this.isPlaying=!0,this.isCurrentPreviewSound&&this.soundPlayer?.play()},playModel(){this.playingPictureTimeout&&clearTimeout(this.playingPictureTimeout),this.isPlaying=!0,this.modelPlayer?.play(this.objectModel.currentAnimation)},resetCanvasSize(){return this.$nextTick().then(()=>{if(this.zoomEnabled||this.resetPanZoom(),this.isCurrentPreviewMovie&&this.isAnnotationCanvas()){if(this.canvas){const r=this.rawPlayer.getVideoRatio(),n=this.rawPlayer.$el.offsetWidth,h=this.rawPlayer.$el.offsetHeight,d=r?h*r:n;if(n>d){const f=Math.round((n-d)/2);this.canvas.style.left=f+"px",this.canvas.style.top="0px",this.setAnnotationCanvasDimensions(d,h)}else{const f=r?Math.round(n/r):h,g=Math.round((h-f)/2);this.canvas.style.left="0px",this.canvas.style.top=g+"px",this.setAnnotationCanvasDimensions(n,f)}}}else if(this.isCurrentPreviewPicture&&this.isAnnotationCanvas()&&this.canvas){const r=this.currentPreview.width?{width:this.currentPreview.width,height:this.currentPreview.height}:this.picturePlayer.getNaturalDimensions(),n=r.width,h=r.height,d=n/h;if(!this.$refs["video-container"])return;let f=this.$refs["video-container"].offsetWidth;const g=this.$refs["video-container"].offsetHeight;this.isComparing&&!this.isComparisonOverlay&&(f=Math.round(f/2));let w=d?g*d:f,C=d?Math.round(f/d):g,x,P;if(this.canvas.style.top="0px",this.canvas.style.left="0px",f>n)P=Math.round((f-n)/2),this.canvas.style.left=P+"px",w=n;else if(f>w){const E=Math.round((f-w)/2);this.canvas.style.left=E+"px"}else w=f;if(g>h)x=Math.round((g-h)/2),this.canvas.style.top=x+"px",C=h;else if(g>C)x=Math.round((g-C)/2),this.canvas.style.top=x+"px";else{C=g,w=Math.round(C*d);const E=Math.round((f-w)/2);this.canvas.style.left=E+"px"}this.setAnnotationCanvasDimensions(w,C)}})},showCanvas(){this.canvas&&(this.canvas.style.display="block")},hideCanvas(){this.canvas&&(this.canvas.style.display="none")},loadAnnotation(r){if(!r)return;this.pause();const n=r&&r.time||0;if(this.rawPlayer||this.picturePlayer){if(this.rawPlayer){const h=n/this.frameDuration;this.rawPlayer.setCurrentFrame(h),this.syncComparisonPlayer(),this.currentTimeRaw=n,this.updateProgressBar()}this.clearCanvas(),this.loadSingleAnnotation(r)}},saveAnnotations(){let r=qt(this.currentTimeRaw,this.fps)||0;if(r<0&&(r=0),this.isCurrentPreviewPicture&&(r=0),!this.annotations)return;const n=r/this.frameDuration,h=this.getAnnotation(r),d=this.getNewAnnotations(r,n,h),f=this.entityList[this.playingEntityIndex];if(!f)return;let g={id:f.preview_file_id,task_id:f.preview_file_task_id,annotations:f.preview_file_annotations||[]};if(this.currentPreviewIndex>0){const w=this.currentPreviewIndex-1,C=this.currentEntity.preview_file_previews[w];g={id:C.id,task_id:f.preview_file_task_id,annotations:C.annotations||[]}}this.isCurrentUserArtist||(this.notSaved?this.$options.changesToSave={preview:g,annotations:d}:this.startAnnotationSaving(g,d),f.preview_file_annotations=d,Object.keys(f.preview_files).forEach(w=>{let C=null;f.preview_files[w].forEach(x=>{x.id===g.id&&(C=x),!C&&x.previews&&x.previews.forEach(P=>{P.id===g.id&&(C=x)})}),C&&this.$store.commit("UPDATE_PREVIEW_ANNOTATION",{taskId:g.task_id,preview:C,annotations:d})}))},onDeleteClicked(){this.deleteSelection()},getAnnotation(r){if(this.annotations||(this.annotations=this.currentEntity.preview_file_annotations),r=qt(r,this.fps),this.annotations&&this.annotations.find){let n=this.annotations.find(h=>h.time===r);return n||(n=this.annotations.find(h=>h.time>r-.02&&h.time<r+.02)),!n&&this.isCurrentPreviewPicture&&this.annotations.length>0&&(n=this.annotations[0],this.$store.commit("UPDATE_ANNOTATION",{annotation:n,data:{time:0}})),n}else return this.annotations=[],null},onMetadataLoaded(){this.$nextTick(()=>{this.resetCanvasSize(),this.resetHeight&&this.resetHeight()})},clearPlayer(){this.rawPlayer&&this.rawPlayer.clear(),this.isComparing&&this.$refs["raw-player-comparison"].clear(),this.maxDurationRaw=0,this.maxDuration="00:00.000"},async resetPictureCanvas(){this.currentPreview&&(this.annotations=this.currentPreview.annotations||[],await this.resetCanvas(),this.resetCanvasVisibility(),this.isCurrentPreviewPicture&&(this.isPlaying||this.loadAnnotation(this.getAnnotation(0))))},onCanvasMouseMoved(r){if(this.isCurrentPreviewMovie&&this.$options.scrubbing){const n=this.getClientX(r.e);n-this.$options.scrubStartX<0?this.goPreviousFrame():this.goNextFrame(),this.$options.scrubStartX=n}},onCanvasClicked(r){return r.button>1&&this.isCurrentPreviewMovie&&(this.$options.scrubbing=!0,this.$options.scrubStartX=this.getClientX(r),this.$options.scrubStartTime=Number(this.currentTimeRaw)),!1},onCanvasReleased(){return this.isCurrentPreviewMovie&&this.$options.scrubbing&&(this.$options.scrubbing=!1),!1},onTimeCodeClicked({versionRevision:r,frame:n}){const d=this.currentEntity.preview_files[this.task.task_type_id].find(f=>f.revision===parseInt(r));this.onPreviewChanged(this.currentEntity,d),setTimeout(()=>{this.rawPlayer.setCurrentFrame(n),this.onFrameUpdate(n),this.syncComparisonPlayer(),this.$nextTick(()=>{this.reloadCurrentAnnotation()})},100)},extractFrame(r,n){this.rawPlayer.setCurrentFrame(n);const h=this.rawPlayer.currentPlayer,d=r.getContext("2d"),f=this.rawPlayer.getNaturalDimensions();r.width=f.width,r.height=f.height,d.clearRect(0,0,r.width,r.height),d.drawImage(h,0,0,r.width,r.height)},extractVideoFrame(r,n){return new Promise(h=>{this.rawPlayer.setCurrentFrame(n),this.$nextTick(()=>{setTimeout(()=>{this.extractFrame(r,n),h()},500)})})},async extractAnnotationSnapshots(){const r=this.currentFrame,n=this.annotations.sort((f,g)=>f.time-g.time),h=[];let d=1;for(const f of n){const g=document.getElementById("annotation-snapshot"),w=`annotation ${d}.png`,C=qt(f.time,this.fps)/this.frameDuration;await this.extractVideoFrame(g,C),await this.copyAnnotationCanvas(g,f);const x=await this.getFileFromCanvas(g,w);h.push(x),d++}return this.rawPlayer.setCurrentFrame(r-1),this.$nextTick(()=>{this.clearCanvas()}),h},getFileFromCanvas(r,n){return new Promise((h,d)=>{r.toBlob(f=>{const g=new File([f],n,{type:"image/png",lastModified:new Date().getTime()});return h(g)})})},triggerResize(){window.dispatchEvent(new Event("resize"))}},watch:{isCommentsHidden(){this.isCurrentPreviewSound&&this.soundPlayer?.redraw()},speed(){const n=[.25,.5,1,1.5,2][this.speed-1];this.setPlayerSpeed(n),this.updateRoomStatus()}},socket:{events:{"preview-file:annotation-update"(r){!this.tempMode&&this.previewFileMap.get(r.preview_file_id)&&this.refreshPreview({previewId:r.preview_file_id,taskId:this.currentPreview.task_id}).then(n=>{if(!this.notSaved&&this.currentPreview.id===r.preview_file_id&&!this.isWriting(r.updated_at)){const h=this.annotations.length!==n.annotations.length;this.annotations=n.annotations;const d=!this.room.people||this.room.people.length===0;h&&this.reloadAnnotations(d)}this.$emit("annotations-refreshed",n)})}}}},Zc={class:"sound-control-container"},Jc={class:"volume-bar"},Qc=["title","value"],ar=50,tu=Object.assign({name:"button-sound"},{__name:"ButtonSound",props:{muted:{default:!1},mutedModifiers:{},volume:{default:ar},volumeModifiers:{}},emits:["update:muted","update:volume"],setup(r){const n=lr(r,"muted"),h=lr(r,"volume"),d=hr(ar),f=()=>{n.value?(n.value=!1,h.value=d.value||ar):(d.value=h.value,n.value=!0,h.value=0)},g=w=>{const C=w.target.valueAsNumber;h.value=C,n.value=C===0,C>0&&(d.value=C)};return(w,C)=>(M(),R("div",Zc,[H(ls,{title:n.value?w.$t("playlists.actions.unmute"):w.$t("playlists.actions.mute"),icon:n.value?"soundoff":"soundon",onClick:f},null,8,["title","icon"]),L("div",Jc,[L("input",{class:"volume-slider",min:"0",max:"100",type:"range",title:w.$t("playlists.volume_level",{level:h.value}),value:h.value,onInputPassive:g},null,40,Qc)])]))}}),eu=Tt(tu,[["__scopeId","data-v-89d253b8"]]),iu={name:"color-picker",props:{color:{type:String},palette:{default:()=>["#000000","#FFFFFF","#039BE5","#ff3860","#008732","#5E60BA","#f57f17"],type:Array}},emits:["change"],data(){return{isOpen:!1}},methods:{togglePalette(){this.isOpen=!this.isOpen},onColorPicked(r){this.$emit("change",r),this.isOpen=!1}}},su={class:"color-wrapper"},ru=["title"],nu={class:St({"color-palette":!0})},ou=["title"],au=["value","onClick"];function lu(r,n,h,d,f,g){return M(),R("div",su,[L("button",{type:"button",class:St({"color-picker":!0}),title:h.color,style:lt({color:h.color}),onClick:n[0]||(n[0]=(...w)=>g.togglePalette&&g.togglePalette(...w))},null,12,ru),st(L("div",nu,[(M(!0),R(Ht,null,ee(h.palette,w=>(M(),R("label",{key:w,title:w,style:lt({color:w})},[L("input",{type:"radio",value:w,onClick:C=>g.onColorPicked(w)},null,8,au)],12,ou))),128))],512),[[rt,f.isOpen]])])}const hu=Tt(iu,[["render",lu],["__scopeId","data-v-993c6dde"]]),Mo={computed:{isFullScreenEnabled(){return!!(document.fullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled||document.webkitSupportsFullscreen||document.webkitFullscreenEnabled||document.createElement("picture").webkitRequestFullScreen)}},methods:{isFullScreen(){return!!(document.fullscreen||document.webkitIsFullScreen||document.mozFullScreen||document.msFullscreenElement||document.fullscreenElement)},documentExitFullScreen(){if(document.exitFullscreen)return document.exitFullscreen();document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()},documentSetFullScreen(r){if(r.requestFullscreen)return r.requestFullscreen();r.mozRequestFullScreen?r.mozRequestFullScreen():r.webkitRequestFullScreen?r.webkitRequestFullScreen():r.msRequestFullscreen&&r.msRequestFullscreen()}}},cu={name:"picture-viewer",mixins:[Di,Mo],components:{Spinner:De},props:{big:{type:Boolean,default:!1},defaultHeight:{type:Number,default:0},marginBottom:{type:Number,default:0},fullScreen:{type:Boolean,default:!1},highQuality:{type:Boolean,default:!1},isComparing:{type:Boolean,default:!1},light:{type:Boolean,default:!1},preview:{type:Object,default:()=>{}},panzoom:{type:Boolean,default:!1}},emits:["loaded","panzoom-changed","size-changed"],data(){return{isLoading:!0,picturePath:"",pictureDlPath:"",pictureGifPath:"",panzoomInstances:[]}},mounted(){this.container=this.$refs.container,this.picture=this.$refs.picture,this.pictureBig=this.$refs["picture-big"],this.pictureGif=this.$refs["picture-gif"],this.pictureWrapper=this.$refs["picture-wrapper"],this.pictureSubWrapper=this.$refs["picture-subwrapper"],this.container.style.height=this.defaultHeight+"px",this.isLoading=!0,this.setPictureEmptyPath(),this.picture.complete&&this.onWindowResize(),this.picture.addEventListener("load",this.endLoading),this.pictureBig.addEventListener("load",this.endLoading),this.pictureGif.addEventListener("load",this.endLoading),window.addEventListener("resize",this.onWindowResize),this.setPicturePath(),this.setupPanZoom()},beforeUnmount(){window.removeEventListener("resize",this.onWindowResize),this.panzoomInstances.forEach(r=>r.dispose())},computed:{status(){return this.preview&&this.preview.status?this.preview.status:"ready"},isAvailable(){return!["broken","processing"].includes(this.status)},extension(){return this.preview?this.preview.extension:""},isGif(){return this.extension==="gif"},isMovie(){return this.extension==="mp4"},isPicture(){return["gif","png","jpg","jpeg"].includes(this.extension)},pictureOriginalPath(){return this.preview&&this.isAvailable&&this.isPicture?`/api/pictures/originals/preview-files/${this.preview.id}.png`:null}},methods:{getNaturalDimensions(){let r={naturalWidth:0,naturalHeight:0};return!this.fullScreen&&this.picture.naturalWidth&&!this.isGif?r=this.picture:this.fullScreen&&this.pictureBig.naturalWidth&&!this.isGif?r=this.pictureBig:this.pictureGif.naturalWidth&&this.isGif&&(r=this.pictureGif),{height:r.naturalHeight,width:r.naturalWidth}},getDimensions(){let r=1;const n=this.getNaturalDimensions();n.width>0&&(r=n.height/n.width);let h=n.width;h>this.container.offsetWidth&&this.container.offsetWidth>0&&(h=this.container.offsetWidth);let d=Math.floor(h*r);return d>this.defaultHeight&&(d=this.defaultHeight),h=Math.floor(d/r),{width:h,height:d}},onWindowResize(){this.resetPicture()},endLoading(){this.picture||(this.picture=this.$refs.picture),this.fullScreen&&(this.pictureBig.complete||this.pictureGif.complete)?this.isLoading=!1:!this.fullScreen&&this.picture.complete&&(this.isLoading=!1),this.$emit("loaded"),this.$nextTick(this.resetPicture)},resetPicture(){const r=this.defaultHeight+"px";this.container.style.height=r,this.pictureWrapper&&(this.pictureWrapper.style.height=r),this.pictureSubWrapper&&(this.pictureWrapper.style["max-height"]=r,this.pictureSubWrapper.style["max-height"]=r,this.pictureSubWrapper.style.height=r);let{width:n,height:h}=this.getDimensions();if(this.picture.style.width=n+"px",this.picture.style.height=h+"px",this.pictureBig.style.width=n+"px",this.pictureBig.style.height=h+"px",this.pictureGif.style.width=n+"px",this.pictureGif.style.height=h+"px",this.picture.width=n,this.picture.height=h,this.pictureBig.width=n,this.pictureBig.height=h,this.pictureGif.width=n,this.pictureGif.height=h,this.fullScreen&&(this.pictureBig.style.maxHeight=`calc(100vh - ${this.marginBottom}px)`),this.isPicture){const f=(this.isGif?this.pictureGif:this.fullScreen?this.pictureBig:this.picture).getBoundingClientRect(),g=this.container.getBoundingClientRect(),w=f.top-g.top,C=f.left-g.left;n=f.width,h=f.height,this.resetPanZoom(),(!this.previousDimensions||this.previousDimensions.width!==n||this.previousDimensions.height!==h||this.previousDimensions.left!==C||this.previousDimensions.top!==w)&&this.$emit("size-changed",{width:n,height:h,top:w,left:C}),this.previousDimensions={width:n,height:h,top:w,left:C}}},setPictureEmptyPath(){this.isGif&&this.isPicture?this.pictureGifPath=null:this.preview&&this.isPicture&&(this.picturePath=null,this.pictureDlPath=null)},setPicturePath(){if(this.isGif&&this.isAvailable&&this.isPicture){const r=this.preview.id;this.pictureGifPath=`/api/pictures/originals/preview-files/${r}.gif`}else if(this.preview&&this.isAvailable&&this.isPicture){const r=this.preview.id;this.highQuality?this.picturePath=`/api/pictures/originals/preview-files/${r}.png`:this.picturePath=`/api/pictures/previews/preview-files/${r}.png`}this.setPictureDlPath()},setPictureDlPath(){if(this.preview&&this.isAvailable&&this.isPicture){const r=this.preview.id;this.pictureDlPath=`/api/pictures/originals/preview-files/${r}/download`}else this.pictureDlPath=null},showLoupe(){this.$refs.loupe.style.display="block"},hideLoupe(){this.$refs.loupe.style.display="none"},updateLoupePosition(r,n){const h=n.width,d=n.height,f=parseInt(h.substring(0,h.length-2)),g=parseInt(d.substring(0,d.length-2));let w=Math.max(r.pointer.x-150,0),C=Math.max(r.pointer.y-150,0);w=Math.min(w,f-300),C=Math.min(C,g-300),this.$refs.loupe.style.left=w+"px",this.$refs.loupe.style.top=C+"px";let x=Math.max(r.pointer.x,0),P=Math.max(r.pointer.y,0);x=Math.min(x,f),P=Math.min(P,g);const E=this.getNaturalDimensions(),D=E.width/f,W=Math.min(D*x-150,E.width-300),N=Math.min(D*P-150,E.height-300);this.$refs.loupe.style["background-position"]=`-${W}px -${N}px`},setupPanZoom(){const r=[this.picture,this.pictureBig,this.pictureGif];this.panzoomInstances=r.map(n=>cr(n,{bounds:!0,boundsPadding:.2,maxZoom:5,minZoom:1})),this.panzoomBig=this.panzoomInstances[1],this.panzoomGif=this.panzoomInstances[2],this.panzoomBig.on("zoom",()=>{this.big&&this.emitPanZoom(this.panzoomBig)}),this.panzoomBig.on("panend",()=>{this.big&&this.emitPanZoom(this.panzoomBig)}),this.panzoomGif.on("zoom",()=>{this.isGif&&this.emitPanZoom(this.panzoomBig)}),this.panzoomGif.on("panend",()=>{this.isGif&&this.emitPanZoom(this.panzoomBig)})},emitPanZoom(r){if(this.$options.silent)return;const{x:n,y:h,scale:d}=r.getTransform();this.$emit("panzoom-changed",{x:n,y:h,scale:d})},resetPanZoom(){this.setPanZoom(0,0,1)},pausePanZoom(){this.panzoomInstances.forEach(r=>r.pause())},resumePanZoom(){this.panzoomInstances.forEach(r=>r.resume())},setPanZoom(r,n,h){if(this.$options.silent=!0,this.panzoomInstances.length===0)return;let d=this.panzoomInstances[1];this.isGif?d=this.panzoomInstances[2]:!this.big&&!this.fullScreen&&(d=this.panzoomInstances[0]);const f=d.getTransform().scale,g=h/f;d.moveTo(r,n),d.setTransformOrigin({x:r,y:n}),d.zoomTo(r,n,g),d.setTransformOrigin({x:0,y:0}),this.$nextTick(()=>{this.$options.silent=!1})}},watch:{fullScreen(){this.resetPanZoom(),this.fullScreen?(this.isLoading=!0,this.setPictureDlPath(),this.pictureBig.complete&&(this.isLoading=!1)):this.setPicturePath()},isLoading(){this.isLoading||setTimeout(this.resetPicture,100)},light(){this.resetPanZoom(),this.onWindowResize()},isComparing(){this.resetPanZoom(),setTimeout(()=>{this.resetPicture()},20)},preview(){this.preview&&this.preview.id!==this.lastPreviewId&&(this.lastPreviewId=this.preview.id,this.resetPanZoom(),this.isLoading=!0,this.setPictureEmptyPath(),this.$nextTick(()=>{this.resetPicture(),this.setPicturePath(),this.setPictureDlPath(),this.currentIndex>1&&(this.currentIndex=1),this.fullScreen?this.pictureBig.complete&&this.resetPicture():this.$nextTick(this.resetPicture)}))}}},uu={ref:"container",class:"picture-player"},du={ref:"picture-wrapper",class:"picture-wrapper",oncontextmenu:"return false"},fu={class:"picture-subwrapper",ref:"picture-subwrapper"},pu=["src"],gu=["src"],mu=["src"];function yu(r,n,h,d,f,g){const w=G("spinner");return M(),R("div",uu,[L("div",du,[st(L("div",fu,[L("div",{ref:"loupe",class:"loupe",id:"loupe",style:lt({background:"url("+f.pictureDlPath+")"})},null,4),st(L("div",null,[L("img",{ref:"picture-gif",src:f.pictureGifPath},null,8,pu)],512),[[rt,g.isGif]]),st(L("div",null,[st(L("img",{ref:"picture-big",src:f.pictureDlPath},null,8,gu),[[rt,h.fullScreen||h.big]]),st(L("img",{ref:"picture",src:f.picturePath},null,8,mu),[[rt,!h.fullScreen&&!h.big]])],512),[[rt,!g.isGif]])],512),[[rt,!f.isLoading]]),f.isLoading?(M(),et(w,{key:0})):V("",!0)],512)],512)}const Ao=Tt(cu,[["render",yu],["__scopeId","data-v-e798d21f"]]),vu={name:"multi-picture-viewer",mixins:[Di,Mo],components:{PictureViewer:Ao},props:{big:{type:Boolean,default:!1},defaultHeight:{type:Number,default:0},marginBottom:{type:Number,default:0},fullScreen:{type:Boolean,default:!1},highQuality:{type:Boolean,default:!1},isComparing:{type:Boolean,default:!1},light:{type:Boolean,default:!1},panzoom:{type:Boolean,default:!1},currentPreview:{type:Object,default:()=>null},previews:{type:Array,default:()=>[]}},emits:["loaded","panzoom-changed","size-changed"],data(){return{}},mounted(){this.container.style.height=this.defaultHeight+"px"},beforeUnmount(){},computed:{container(){return this.$refs.container}},methods:{getNaturalDimensions(){if(!this.currentPreview)return{height:0,width:0};const r=this.$refs["picture-"+this.currentPreview.id+"-"+this.currentPreview.position];if(r&&r[0])return r[0].getNaturalDimensions()},getDimensions(){if(!this.currentPreview)return{height:0,width:0};const r=this.$refs["picture-"+this.currentPreview.id+"-"+this.currentPreview.position];if(r&&r[0])return r[0].getDimensions()},onWindowResize(){this.resetPicture()},resetPicture(){if(this.container.style.height=this.defaultHeight+"px",this.currentPreview){const r="picture-"+this.currentPreview.id+"-"+this.currentPreview.position,n=this.$refs[r];n&&n[0]&&n[0].resetPicture()}},resetPanZoom(){this.previews.forEach(r=>{const n="picture-"+r.id+"-"+r.position;if(r.id===this.currentPreview.id&&r.position===this.currentPreview.position){const h=this.$refs[n];h&&h[0]&&h[0].resetPanZoom()}})},pausePanZoom(){this.previews.forEach(r=>{const n="picture-"+r.id+"-"+r.position,h=this.$refs[n];h&&h[0]&&h[0].pausePanZoom()})},resumePanZoom(){this.previews.forEach(r=>{const n="picture-"+r.id+"-"+r.position,h=this.$refs[n];h&&h[0]&&h[0].resumePanZoom()})},setPanZoom(r,n,h){this.previews.forEach(d=>{const f="picture-"+d.id+"-"+d.position,g=this.$refs[f];d.id===this.currentPreview.id&&d.position===this.currentPreview.position&&g&&g[0]&&g[0].setPanZoom(r,n,h)})}},watch:{fullScreen(){this.resetPicture()},isComparing(){setTimeout(()=>{this.resetPicture()},20)},currentPreview(){this.resetPicture()},previews(){this.resetPicture()}}},wu={ref:"container",class:"multi-picture-player"};function Cu(r,n,h,d,f,g){const w=G("picture-viewer");return M(),R("div",wu,[(M(!0),R(Ht,null,ee(h.previews,C=>st((M(),et(w,{ref_for:!0,ref:"picture-"+C.id+"-"+C.position,key:C.id,big:h.big,preview:C,"full-screen":h.fullScreen,"high-quality":h.highQuality,"is-comparing":h.isComparing,light:h.light,panzoom:h.panzoom,"default-height":h.defaultHeight,"margin-bottom":h.marginBottom,onLoaded:n[0]||(n[0]=()=>r.$emit("loaded")),onPanzoomChanged:n[1]||(n[1]=x=>r.$emit("panzoom-changed",x)),onSizeChanged:n[2]||(n[2]=()=>r.$emit("size-changed"))},null,8,["big","preview","full-screen","high-quality","is-comparing","light","panzoom","default-height","margin-bottom"])),[[rt,C.id===h.currentPreview.id&&C.position===h.currentPreview.position]])),128))],512)}const bu=Tt(vu,[["render",Cu],["__scopeId","data-v-7716a66f"]]),_u={name:"notify-client-modal",mixins:[dr],components:{BaseModal:Pc,ComboboxDepartment:Sc,ComboboxStudio:Tc,ModalFooter:xo,PeopleAvatar:Co,PeopleName:ac},props:{active:{type:Boolean,default:!1},isError:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},isSuccess:{type:Boolean,default:!1}},emits:["cancel","confirm"],data(){return{form:{studio_id:"",department_id:""}}},computed:{...Ee(["currentProduction","personMap"]),clients(){return this.currentProduction.team.map(r=>this.personMap.get(r)).filter(r=>r?.role==="client").filter(r=>!this.form.studio_id||r.studio_id===this.form.studio_id).filter(r=>!this.form.department_id||r.departments&&r.departments.includes(this.form.department_id))}},methods:{runConfirmation(){this.$emit("confirm",{studio_id:this.form.studio_id,department_id:this.form.department_id})}}},xu={class:"mb2"},Pu={class:"mt2"},Su={key:0},Tu={class:"label mb1"};function ku(r,n,h,d,f,g){const w=G("combobox-studio"),C=G("combobox-department"),x=G("people-avatar"),P=G("people-name"),E=G("modal-footer"),D=G("base-modal");return M(),et(D,{active:h.active,title:r.$t("playlists.notify_clients"),onCancel:n[3]||(n[3]=W=>r.$emit("cancel"))},{default:ns(()=>[L("p",xu,U(r.$t("playlists.notify_clients_description")),1),H(w,{class:"mt1 mb1",ref:"studioField","all-studios-label":"",label:r.$t("main.studio"),modelValue:f.form.studio_id,"onUpdate:modelValue":n[0]||(n[0]=W=>f.form.studio_id=W)},null,8,["label","modelValue"]),H(C,{class:"mt1 mb1",ref:"departmentField","all-departments-label":"",label:r.$t("people.fields.departments"),modelValue:f.form.department_id,"onUpdate:modelValue":n[1]||(n[1]=W=>f.form.department_id=W)},null,8,["label","modelValue"]),L("div",Pu,[g.clients.length?(M(),R(Ht,{key:1},[L("label",Tu,U(r.$t("playlists.clients_to_notify")),1),(M(!0),R(Ht,null,ee(g.clients,W=>(M(),R("div",{key:W.id,class:"flexrow mb05"},[H(x,{class:"flexrow-item",person:W,size:30,"is-link":!1},null,8,["person"]),H(P,{class:"flexrow-item",person:W,"is-link":!1},null,8,["person"])]))),128))],64)):(M(),R("em",Su,U(r.$t("playlists.no_clients_to_notify")),1))]),H(E,{"error-text":r.$t("playlists.notify_clients_error"),"is-error":h.isError,"is-loading":h.isLoading,"is-success":h.isSuccess,"success-text":r.$t("playlists.notify_clients_success"),onConfirm:g.runConfirmation,onCancel:n[2]||(n[2]=W=>r.$emit("cancel"))},null,8,["error-text","is-error","is-loading","is-success","success-text","onConfirm"])]),_:1},8,["active","title"])}const Ou=Tt(_u,[["render",ku]]),Eu={name:"object-viewer",props:{previewUrl:{default:null,type:String},light:{default:!1,type:Boolean},readOnly:{default:!1,type:Boolean},defaultHeight:{default:0,type:Number},backgroundUrl:{type:String},isEnvironmentSkybox:{default:!1,type:Boolean},isWireframe:{default:!1,type:Boolean}},emits:["model-loaded"],data(){return{panningHDR:!1,changingFocale:!1,fieldOfView:50,lastX:0,lastY:0,lockOrbit:null,lockCameraTarget:null,skyboxAngle:0,radiansPerPixel:0,overlayText:null}},async mounted(){customElements.get("model-viewer")||await bo(()=>import("./model-viewer-DTwyUtTM.js"),[]),this.addEventListeners()},beforeUnmount(){this.removeEventListeners()},methods:{createWireframeVariant(r){const n=r.materials.length;for(let h=0;h<n;h++){const d=r.createMaterialInstanceForVariant(h,`material-wireframe-${h}`,"variant-wireframe",this.isWireframe);if(!d)continue;const f=d.normalTexture,g=Object.getOwnPropertySymbols(f).find(C=>C.description==="materials");f[g].forEach(C=>{C.wireframe=!0,C.color.setHex(12632256),C.emissive?.setHex(12632256),C.emissiveMap=null,C.envMapIntensity=0})}},getAnimations(){return this.$refs["model-viewer"].availableAnimations},play(r){this.$refs["model-viewer"].animationName=r,this.$refs["model-viewer"].play()},pause(){this.$refs["model-viewer"].pause()},startPanHDR(r){const n=this.$refs["model-viewer"];if(!n)return;const h=n.getCameraOrbit(),{radius:d}=h;this.panningHDR=!0,this.lastX=r,this.lockCameraTarget=n.getCameraTarget(),this.radiansPerPixel=-1*d/n.getBoundingClientRect().width},updatePanHDR(r){const n=this.$refs["model-viewer"];if(!n)return;const h=(r-this.lastX)*this.radiansPerPixel*2;if(h===0)return;this.lastX=r,this.skyboxAngle+=h;const d=n.getCameraOrbit();d.theta+=h,n.cameraOrbit=d.toString(),n.cameraTarget=this.lockCameraTarget,n.resetTurntableRotation(this.skyboxAngle),n.jumpCameraToGoal(),this.overlayText=`Rotate Skybox: ${this.skyboxAngle.toFixed(2)} rad`},endPanHDR(){this.panningHDR=!1,this.lastX=0,this.radiansPerPixel=0,this.overlayText=null},startChangingFocale(r){const n=this.$refs["model-viewer"];if(!n)return;const h=n.getCameraOrbit();this.changingFocale=!0,this.lastY=r,this.lockOrbit=h;const{radius:d}=h;this.radiansPerPixel=-1*d/n.getBoundingClientRect().height},updateFocale(r){const n=this.$refs["model-viewer"];if(!n)return;const h=(r-this.lastY)*this.radiansPerPixel*15;this.lastY=r,this.overlayText=`Fov: ${Math.floor(this.fieldOfView)} deg`,this.fieldOfView+=h,this.fieldOfView<10?this.fieldOfView=10:this.fieldOfView>100&&(this.fieldOfView=100),n.fieldOfView=`${Math.floor(this.fieldOfView)}deg`,n.cameraOrbit=this.lockOrbit},endChangingFocale(){this.changingFocale=!1,this.lastY=0,this.radiansPerPixel=0,this.overlayText=null,this.lockOrbit=null},handleMouseDown(r){r.button===0&&r.altKey&&this.startChangingFocale(r.clientY),(r.button===1||r.button===0&&r.ctrlKey)&&this.startPanHDR(r.clientX),r.preventDefault(),r.stopPropagation()},handleTouchStart(r){const{targetTouches:n,touches:h}=r;if(n.length===2&&n.length===h.length){this.lastX=.5*(n[0].clientX+n[1].clientX),this.startPanHDR(this.lastX),r.preventDefault();return}if(n.length===3&&n.length===h.length){this.lastY=(n[0].clientY+n[1].clientY+n[2].clientY)/3,this.startChangingFocale(this.lastY),r.preventDefault();return}},handleMouseMove(r){this.panningHDR&&(this.updatePanHDR(r.clientX),r.stopPropagation()),this.changingFocale&&(this.updateFocale(r.clientY),r.stopPropagation(),r.preventDefault())},handleTouchMove(r){const{targetTouches:n}=r;if(this.panningHDR&&n.length===2){const h=.5*(n[0].clientX+n[1].clientX);this.updatePanHDR(h),r.preventDefault();return}if(this.changingFocale&&n.length===3){const h=(n[0].clientY+n[1].clientY+n[2].clientY)/3;this.updateFocale(h),r.preventDefault();return}},handleMouseUp(){this.panningHDR&&this.endPanHDR(),this.changingFocale&&this.endChangingFocale()},handleTouchEnd(r){this.panningHDR&&this.endPanHDR(),this.changingFocale&&this.endChangingFocale()},addEventListeners(){const r=this.$refs["model-viewer"];r&&(r.addEventListener("mousedown",this.handleMouseDown,!0),r.addEventListener("touchstart",this.handleTouchStart,!0),r.addEventListener("touchmove",this.handleTouchMove,!0),r.addEventListener("touchend",this.handleTouchEnd,!0)),window.addEventListener("mousemove",this.handleMouseMove,!0),window.addEventListener("mouseup",this.handleMouseUp,!0)},removeEventListeners(){const r=this.$refs["model-viewer"];r&&(r.removeEventListener("mousedown",this.handleMouseDown,!0),r.removeEventListener("touchstart",this.handleTouchStart,!0),r.removeEventListener("touchmove",this.handleTouchMove,!0),r.removeEventListener("touchend",this.handleTouchEnd,!0)),window.removeEventListener("mousemove",this.handleMouseMove,!0),window.removeEventListener("mouseup",this.handleMouseUp,!0)}}},Du=["environment-image","skybox-image","src","variant-name"],Mu={key:0,style:{top:"0",left:"0",width:"100%",height:"100%",position:"absolute",pointerEvents:"none",padding:"15px"}},Au={style:{color:"white",backgroundColor:"rgba(0, 0, 0, 0.5)",padding:"5px",fontSize:"14px",textAlign:"center",borderRadius:"5px"}};function Fu(r,n,h,d,f,g){return M(),R("div",{class:St(["model-container",{light:h.light&&!h.readOnly}]),style:lt({height:h.defaultHeight?h.defaultHeight+"px":"100%",width:"100%",position:"relative"})},[L("model-viewer",{ref:"model-viewer",class:"model-viewer",style:{position:"absolute",top:"0",left:"0"},"camera-controls":"",loading:"eager","environment-image":h.backgroundUrl,"skybox-image":h.isEnvironmentSkybox?h.backgroundUrl:"",src:h.previewUrl,"field-of-view":"50deg","min-field-of-view":"10deg","max-field-of-view":"100deg","variant-name":h.isWireframe?"variant-wireframe":null,onBeforeRender:n[0]||(n[0]=w=>g.createWireframeVariant(w.target.model)),onLoad:n[1]||(n[1]=w=>r.$emit("model-loaded"))},null,40,Du),f.overlayText?(M(),R("div",Mu,[L("span",Au,U(f.overlayText),1)])):V("",!0)],6)}const Lu=Tt(Eu,[["render",Fu],["__scopeId","data-v-3eba7e14"]]),Ru={name:"pencil-picker",props:{pencil:{type:String},sizes:{type:Array}},emits:["change"],data(){return{isOpen:!1}},methods:{togglePalette(){this.isOpen=!this.isOpen},onPencilPicked(r){this.$emit("change",r),this.isOpen=!1}}},ju={class:"pencil-wrapper"},Iu=["title"],Bu={class:"pencil-palette"},Wu=["title"],Hu=["value","onClick"];function $u(r,n,h,d,f,g){return M(),R("div",ju,[L("button",{type:"button",class:St(["pencil-picker",{medium:h.pencil==="medium",small:h.pencil==="small"}]),title:r.$t(`playlists.actions.annotation_${h.pencil}`),onClick:n[0]||(n[0]=(...w)=>g.togglePalette&&g.togglePalette(...w))},null,10,Iu),st(L("div",Bu,[(M(!0),R(Ht,null,ee(h.sizes,w=>(M(),R("label",{key:w,title:r.$t(`playlists.actions.annotation_${w}`),class:St({medium:w==="medium",small:w==="small"})},[L("input",{type:"radio",value:w,onClick:C=>g.onPencilPicked(w)},null,8,Hu)],10,Wu))),128))],512),[[rt,f.isOpen]])])}const zu=Tt(Ru,[["render",$u],["__scopeId","data-v-1c387545"]]),Vu={name:"light-entity-thumbnail",props:{previewFileId:{type:String},extension:{type:String},width:{default:"150px",type:String},height:{default:"50px",type:String},maxHeight:{default:"auto",type:String},maxWidth:{default:"auto",type:String},emptyHeight:{type:String},emptyWidth:{type:String},type:{default:"thumbnails",type:String}},computed:{isPreviewWithThumbnail(){return this.previewFileId&&(!this.extension||["mp4","png"].includes(this.extension))}}},Nu=["src"];function Xu(r,n,h,d,f,g){return g.isPreviewWithThumbnail?(M(),R("img",{class:"thumbnail-picture",draggable:"false",loading:"lazy",alt:"",key:h.previewFileId,src:`/api/pictures/${h.type}/preview-files/${h.previewFileId}.png`,style:lt({width:h.width,height:h.height,"max-width":h.maxWidth,"max-height":h.maxHeight})},null,12,Nu)):(M(),R("span",{key:1,class:"thumbnail-picture thumbnail-empty",style:lt({width:h.emptyWidth?h.emptyWidth:h.width,height:h.emptyHeight?h.emptyHeight:h.height})},null,4))}const Yu=Tt(Vu,[["render",Xu],["__scopeId","data-v-15caabc6"]]),Uu={name:"playlisted-entity",components:{Combobox:So,LightEntityThumbnail:Yu,XIcon:lc},emits:["entity-dropped","play-click","preview-changed","remove-entity"],data(){return{taskTypeId:null,previewFileId:this.entity.preview_file_id}},props:{index:{default:0,type:Number},isPlaying:{default:!1,type:Boolean},entity:{default:()=>{},type:Object}},mounted(){this.setCurrentParameters(),this.setListeners()},computed:{...Ee(["taskMap","taskTypeMap","taskStatusMap","isCurrentUserManager","isCurrentUserSupervisor","playlistEntryMap"]),dropArea(){return this.$refs["drop-area"]},previewFiles(){const r={...this.entity.preview_files};return Object.keys(r).forEach(n=>{r[n]=r[n].filter(h=>!this.playlistEntryMap.has(`${this.entity.id}-${h.id}`)||h.id===this.entity.preview_file_id)}),r},taskTypeOptions(){return this.previewFiles?Object.keys(this.previewFiles).filter(r=>this.previewFiles[r].length>0).map(r=>this.taskTypeMap.get(r)).sort(hc.firstBy("priority",1).thenBy("name")).map(r=>({label:r.name,value:r.id})):[]},previewFileOptions(){return(this.previewFiles[this.taskTypeId]||[]).map(n=>({label:`v${n.revision}`,value:n.id}))},taskStatus(){const r=this.entity.preview_file_task_id;if(r){const n=this.taskMap.get(r);return n?this.taskStatusMap.get(n.task_status_id):""}else return""}},methods:{getTaskTypeIdForPreviewFile(r,n){return r.find(h=>this.entity.preview_files[h].some(f=>f.id===n))},setCurrentParameters(){const r=Object.keys(this.entity.preview_files);r.length>0&&(this.entity.preview_file_id&&(this.taskTypeId=this.getTaskTypeIdForPreviewFile(r,this.entity.preview_file_id)),this.taskTypeId||(this.taskTypeId=r[0]))},onPlayClick(){this.$emit("play-click",this.index)},onRemoveClick(r){r.preventDefault(),r.stopPropagation(),this.$emit("remove-entity",{entity:this.entity,previewFileId:this.previewFileId})},setListeners(){},onDragged(){},onDragleave(){this.dropArea.style.width="15px"},onDragover(r){r.preventDefault(),this.dropArea.style.width="60px"},onDropped(r){this.dropArea.style.width="15px",this.$emit("entity-dropped",{before:{entity_id:this.entity.id,preview_file_id:this.previewFileId},after:{entity_id:r.dataTransfer.getData("entityId"),preview_file_id:r.dataTransfer.getData("previewFileId")}})},setTaskTypeId(r){this.$options.silent=!0,this.taskTypeId=r,this.$nextTick(()=>{this.$options.silent=!1})},setPreviewFileId(r){this.$options.silent=!0,this.previewFileId=r,this.$nextTick(()=>{this.$options.silent=!1})}},watch:{taskTypeId(){const r=this.entity.preview_files[this.taskTypeId];r&&r.length>0&&(r.some(h=>h.id===this.entity.preview_file_id)?this.previewFileId=this.entity.preview_file_id:this.previewFileId=r[0].id)},previewFileId(r,n){let h=null;const d=this.entity.preview_files[this.taskTypeId];d&&d.length>0&&(h=d.find(f=>f.id===this.previewFileId)),this.$options.silent||this.$emit("preview-changed",{entity:this.entity,previewFile:h,previousPreviewFileId:n})},"entity.preview_file_id"(){this.previewFileId!==this.entity.preview_file_id&&(this.previewFileId=this.entity.preview_file_id)}}},Gu={class:"flexrow wrapper"},qu=["title"],Ku=["title"],Zu={key:0,class:"preview-choice"},Ju={key:1},Qu=["id"];function td(r,n,h,d,f,g){const w=G("x-icon"),C=G("light-entity-thumbnail"),x=G("combobox");return M(),R("div",Gu,[L("div",{class:St({"playlisted-entity":!0,playing:h.isPlaying})},[L("div",{class:"thumbnail-wrapper",onClick:n[1]||(n[1]=Ei((...P)=>g.onPlayClick&&g.onPlayClick(...P),["prevent"]))},[r.isCurrentUserManager||r.isCurrentUserSupervisor?(M(),R("span",{key:0,class:"remove-button flexrow-item",title:r.$t("playlists.remove"),onClick:n[0]||(n[0]=Ei((...P)=>g.onRemoveClick&&g.onRemoveClick(...P),["prevent"]))},[H(w)],8,qu)):V("",!0),H(C,{width:"150px",height:"103px",extension:h.entity.preview_file_extension,"preview-file-id":f.previewFileId},null,8,["extension","preview-file-id"])]),L("div",{class:"entity-title",title:g.taskStatus.name,style:lt({"border-bottom":"2px solid "+g.taskStatus.color,"padding-bottom":"5px"}),onClick:n[2]||(n[2]=Ei((...P)=>g.onPlayClick&&g.onPlayClick(...P),["prevent"]))},U(h.entity.parent_name)+" / "+U(h.entity.name),13,Ku),g.taskTypeOptions.length>0?(M(),R("div",Zu,[H(x,{ref:"task-type-combobox",thin:!0,width:150,options:g.taskTypeOptions,modelValue:f.taskTypeId,"onUpdate:modelValue":n[3]||(n[3]=P=>f.taskTypeId=P)},null,8,["options","modelValue"]),H(x,{class:"version-combo",thin:!0,width:150,options:g.previewFileOptions,modelValue:f.previewFileId,"onUpdate:modelValue":n[4]||(n[4]=P=>f.previewFileId=P)},null,8,["options","modelValue"])])):(M(),R("div",Ju,U(r.$t("playlists.no_preview")),1))],2),L("div",{id:"drop-area-"+h.entity.id,class:"drop-area",onDragover:n[5]||(n[5]=(...P)=>g.onDragover&&g.onDragover(...P)),onDragleave:n[6]||(n[6]=(...P)=>g.onDragleave&&g.onDragleave(...P)),onDrop:n[7]||(n[7]=(...P)=>g.onDropped&&g.onDropped(...P)),ref:"drop-area"},null,40,Qu)])}const ed=Tt(Uu,[["render",td],["__scopeId","data-v-2e9712d3"]]),id={name:"raw-video-player",components:{Spinner:De},props:{currentPreviewIndex:{type:Number,default:0},entities:{type:Array,default:()=>[]},fullScreen:{type:Boolean,default:!1},handleIn:{type:Number,default:0},handleOut:{type:Number,default:0},name:{type:String,default:"main"},muted:{type:Boolean,default:!1},isHd:{type:Boolean,default:!1},isRepeating:{type:Boolean,default:!1},panzoom:{type:Boolean,default:!1}},emits:["entity-change","frame-update","max-duration-update","metadata-loaded","panzoom-changed","play-next","repeat","video-loaded"],data(){return{currentPlayer:void 0,isLoading:!0,isPlaying:!1,nextPlayer:void 0,panzoomInstances:[],playingIndex:0}},mounted(){this.resetHeight(),this.player1.addEventListener("loadedmetadata",this.emitLoadedEvent),window.addEventListener("resize",this.resetHeight),this.$options.currentTimeCalls=[],this.player1.addEventListener("canplay",this.hideLoading),this.player1.addEventListener("stalled",this.showLoading),this.player1.addEventListener("waiting",this.showLoading),this.player1.addEventListener("loadstart",this.showLoading),this.player1.addEventListener("error",this.hideLoading),this.player2.addEventListener("canplay",this.hideLoading),this.player2.addEventListener("stalled",this.showLoading),this.player2.addEventListener("waiting",this.showLoading),this.player2.addEventListener("loadstart",this.showLoading),this.player2.addEventListener("error",this.hideLoading),this.setupPanZoom()},beforeUnmount(){window.removeEventListener("resize",this.resetHeight),this.player1.removeEventListener("loadedmetadata",this.emitLoadedEvent),this.player1.removeEventListener("canplay",this.hideLoading),this.player1.removeEventListener("stalled",this.showLoading),this.player1.removeEventListener("waiting",this.showLoading),this.player1.removeEventListener("loadstart",this.showLoading),this.player1.removeEventListener("error",this.hideLoading),this.player2.removeEventListener("canplay",this.hideLoading),this.player2.removeEventListener("stalled",this.showLoading),this.player2.removeEventListener("waiting",this.showLoading),this.player2.removeEventListener("loadstart",this.showLoading),this.player2.removeEventListener("error",this.hideLoading),this.panzoomInstance?.dispose()},computed:{...Ee(["currentProduction"]),container(){return this.$refs.container},fps(){return parseFloat(this.currentProduction?.fps)||25},frameDuration(){return Math.round(1/this.fps*1e4)/1e4},player1(){return this.$refs.player1},player2(){return this.$refs.player2}},methods:{setupPanZoom(){this.panzoom&&(this.firstPanZoom=cr(this.$refs.player1,{bounds:!0,boundsPadding:.2,maxZoom:5,minZoom:.5}),this.secondPanZoom=cr(this.$refs.player2,{bounds:!0,boundsPadding:.2,maxZoom:3,minZoom:.5}),this.panzoomInstances=[this.firstPanZoom,this.secondPanZoom],this.firstPanZoom.on("zoom",()=>{this.currentPlayer===this.player1&&this.emitPanZoomChanged(this.firstPanZoom)}),this.firstPanZoom.on("panend",()=>{this.currentPlayer===this.player1&&this.emitPanZoomChanged(this.firstPanZoom)}),this.secondPanZoom.on("zoom",()=>{this.currentPlayer===this.player2&&this.emitPanZoomChanged(this.secondPanZoom)}),this.secondPanZoom.on("panend",()=>{this.currentPlayer===this.player2&&this.emitPanZoomChanged(this.secondPanZoom)}),this.pausePanZoom())},emitPanZoomChanged(r){if(this.$options.silent)return;const{x:n,y:h,scale:d}=r.getTransform();this.$emit("panzoom-changed",{x:n,y:h,scale:d})},hideLoading(){this.isLoading=!1},showLoading(){setTimeout(()=>{this.currentPlayer.readyState!==4&&(this.isLoading=!0)},150)},emitLoadedEvent(r){this.$emit("metadata-loaded",r)},getMoviePath(r){if(r.preview_file_extension==="mp4"){let n;return this.currentPreviewIndex===0||this.currentPreviewIndex>r.preview_file_previews.length?n=r.preview_file_id:n=r.preview_file_previews[this.currentPreviewIndex-1].id,this.isHd?`/api/movies/originals/preview-files/${n}.mp4`:`/api/movies/low/preview-files/${n}.mp4`}else return""},getWidth(){return this.currentPlayer?this.currentPlayer.offsetWidth:0},getHeight(){return this.currentPlayer?this.currentPlayer.offsetHeight:0},getVideoRatio(){const r=this.getVideoHeight();return r?this.getVideoWidth()/r:0},getVideoWidth(){return this.currentPlayer?this.currentPlayer.videoWidth:0},getVideoHeight(){return this.currentPlayer?this.currentPlayer.videoHeight:0},clear(){this.currentPlayer&&(this.currentPlayer.src="",this.currentPlayer.removeAttribute("src"),this.currentPlayer.load())},resetHeight(){this.$nextTick(()=>{if(this.currentPlayer&&(this.currentPlayer.style.height="0px"),this.nextPlayer&&(this.nextPlayer.style.height="0px"),this.container){const r=this.container.offsetHeight;this.currentPlayer&&(this.currentPlayer.style.height=`${r}px`),this.nextPlayer&&(this.nextPlayer.style.height=`${r}px`)}})},getNextIndex(r){let n=r+1>=this.entities.length?0:r+1;for(;n!==r&&this.entities[n]&&this.entities[n].preview_file_extension!=="mp4";)n++,n>=this.entities.length&&(n=0);return n},getPreviousIndex(r){let n=r-1>=0?r-1:this.entities.length-1;for(;n!==r&&this.entities[n]&&this.entities[n].preview_file_extension!=="mp4";)n--,n<0&&(n=this.entities.length);return n},goPreviousFrame(){if(this.currentPlayer){const n=!!window.chrome?this.frameDuration:0,h=this.currentTimeRaw;let d=Oi(h-this.frameDuration,this.fps);d=d+n,d=this._setCurrentTime(d);const f=d/this.frameDuration;this.$emit("frame-update",f)}},goNextFrame(){if(this.currentPlayer){const r=this.currentTimeRaw;let n=Oi(r+this.frameDuration,this.fps);const d=!!window.chrome?this.frameDuration:0;n=n+d,n=this._setCurrentTime(n);const f=n/this.frameDuration;this.$emit("frame-update",f)}},loadPreviousEntity(){this.loadEntity(this.getPreviousIndex(this.currentIndex)),this.$emit("entity-change",this.currentIndex)},loadNextEntity(){const r=this.getNextIndex(this.currentIndex);this.loadEntity(r),this.$emit("entity-change",this.currentIndex)},reloadCurrentEntity(r=!1){this.loadEntity(this.currentIndex,this.currentPlayer.currentTime,r)},loadEntity(r=0,n=0,h=!1){if(r<this.entities.length){const d=this.getNextIndex(r),f=this.entities[r],g=this.entities[d];this.currentIndex=r,this.currentPlayer=this.player1,this.nextPlayer=this.player2,this.currentPlayer.removeEventListener("loadedmetadata",this.updateMaxDuration),this.currentPlayer.addEventListener("loadedmetadata",this.updateMaxDuration);const w=this.$options.rate||1;f.preview_file_extension==="mp4"&&this.currentPlayer?this.currentPlayer.src=this.getMoviePath(f):this.currentPlayer&&(this.currentPlayer.src=""),g?.preview_file_extension==="mp4"&&this.nextPlayer?this.nextPlayer.src=this.getMoviePath(g):this.nextPlayer&&(this.nextPlayer.src=""),this.currentPlayer.style.display="block",this.nextPlayer.style.display="none",this.resetHeight(),this.setSpeed(w),this._setCurrentTime(n),h||this.$emit("entity-change",this.currentIndex)}},pause(){if(this.currentPlayer){this.currentPlayer.pause(),this.currentPlayer.curentTime=qt(this.currentPlayer.currentTime,this.fps),this.currentTimeRaw=this.currentPlayer.currentTime;const r=Math.round(this.currentPlayer.currentTime/this.frameDuration);this.$emit("frame-update",r),clearInterval(this.$options.playLoop)}this.isPlaying=!1},play(){let r=this.entities[this.currentIndex];r&&(r.preview_file_id||this.loadNextEntity(),r=this.entities[this.currentIndex],r.preview_file_id&&(this.currentPlayer&&(this.name==="main"&&this.runEmitTimeUpdateLoop(),this.currentPlayer.play()),this.isPlaying=!0))},runEmitTimeUpdateLoop(){clearInterval(this.$options.playLoop),this.$options.playLoop=setInterval(()=>{this.updateTime(this.currentPlayer.currentTime)},1e3/this.fps)},playNext(r){if(this.isPlaying)if(r=r||this.handleIn,this.isRepeating)this.currentPlayer.currentTime=this.handleIn?this.handleIn*this.frameDuration:this.frameDuration,this.currentPlayer.play(),this.$emit("repeat");else{const n=this.getNextIndex(this.currentIndex);this.currentIndex=n,this.$emit("entity-change",this.currentIndex),this.currentPlayer&&(this.currentPlayer.style.display="none"),this.nextPlayer&&(this.nextPlayer.currentTime=r?r*this.frameDuration:0,this.nextPlayer.style.display="block",this.nextPlayer.play()),this.switchPlayers(),this.updateMaxDuration()}},getCurrentTime(){return this.currentPlayer?this.currentPlayer.currentTime:0},getCurrentFrame(){let r=this.getCurrentTime();return r=Oi(r,this.fps),r/this.frameDuration},getLastPushedCurrentTime(){const r=this.$options.currentTimeCalls.length;return r>0?this.$options.currentTimeCalls[r-1]:this.getCurrentTime()},getCurrentTimeRaw(){return this.currentPlayer?this.currentPlayer.currentTime:0},setCurrentTimeRaw(r){this.currentPlayer&&(this.currentPlayer.currentTime=r)},setCurrentFrame(r){this._setCurrentTime(r*this.frameDuration)},_setCurrentTime(r){if(this.$options.currentTimeCalls||(this.$options.currentTimeCalls=[]),!this.currentPlayer)r=0;else if(r<0)r=0;else{const n=Oi(this.currentPlayer.duration,this.fps);r>n&&(r=n)}return this.runSetCurrentTime(r),r},runSetCurrentTime(r){this.currentPlayer&&this.currentPlayer.currentTime!==r&&(this.currentPlayer.currentTime=r+.001,this.onTimeUpdate())},onTimeUpdate(){const n=!!window.chrome?this.frameDuration:0;this.currentPlayer?this.currentTimeRaw=this.currentPlayer.currentTime-n:this.currentTimeRaw=0+n,this.$emit("frame-update",Math.round(this.currentTimeRaw/this.frameDuration))},switchPlayers(){const r=this.getNextIndex(this.currentIndex),n=this.entities[r];this.tmpPlayer=this.currentPlayer,this.currentPlayer=this.nextPlayer,this.nextPlayer=this.tmpPlayer,n&&(this.nextPlayer.src=this.getMoviePath(n)),this.resetHeight();const h=this.$options.rate||1;this.setSpeed(h)},updateTime(r){const n=Math.round(r/this.frameDuration);this.name==="main"&&this.$emit("frame-update",n)},updateMaxDuration(){this.currentPlayer&&(this.$emit("max-duration-update",this.currentPlayer.duration),this.$emit("video-loaded"))},getSpeed(r){return this.currentPlayer?this.currentPlayer.playbackRate:0},setSpeed(r){this.$options.rate=r,this.currentPlayer&&(this.currentPlayer.playbackRate=r),this.nextPlayer&&(this.nextPlayer.playbackRate=r)},getNaturalDimensions(){return{height:this.currentPlayer.videoHeight,width:this.currentPlayer.videoWidth}},pausePanZoom(){this.panzoomInstances.forEach(r=>{r.pause()})},resumePanZoom(){this.panzoomInstances.forEach(r=>{r.resume()})},resetPanZoom(){this.panzoomInstances.forEach(r=>{r.moveTo(0,0),r.zoomAbs(0,0,1)})},setPanZoom(r,n,h){this.$options.silent=!0,this.panzoomInstances.forEach(d=>{const f=d.getTransform().scale,g=h/f;d.moveTo(r,n),d.setTransformOrigin({x:r,y:n}),d.zoomTo(r,n,g),d.setTransformOrigin({x:0,y:0})}),this.$nextTick(()=>{this.$options.silent=!1})},setVolume(r){this.currentPlayer&&(this.currentPlayer.volume=r/100,this.nextPlayer.volume=r/100)}},watch:{currentPreviewIndex(){this.isPlaying||(this.setCurrentTimeRaw(0),this.reloadCurrentEntity(!0))},entities:{handler(){if(this.entities.length>0){this.loadEntity(0),this.pause(),this._setCurrentTime(0);const r=this.entities[this.currentIndex];r&&!r.preview_file_id&&this.loadNextEntity()}setTimeout(()=>{this.resetHeight()},300)}},isHd(){this.currentPlayer&&(this.reloadCurrentEntity(),this.isPlaying&&this.play())},zoomEnabled(){this.panzoom?this.setPanZoom():this.panzoomInstances.forEach(r=>{r.dispose()})}}},sd={ref:"container",class:"video-wrapper filler flexrow-item"},rd={class:"video-loader"},nd=["muted"],od=["muted"];function ad(r,n,h,d,f,g){const w=G("spinner");return M(),R("div",sd,[st(L("div",rd,[H(w,{class:"mt2",style:{color:"white"}})],512),[[rt,f.isLoading]]),L("video",{ref:"player1",preload:"auto",muted:h.muted,onEnded:n[0]||(n[0]=C=>r.$emit("play-next"))},null,40,nd),L("video",{ref:"player2",preload:"auto",muted:h.muted,onEnded:n[1]||(n[1]=C=>r.$emit("play-next"))},null,40,od)],512)}const ld=Tt(id,[["render",ad],["__scopeId","data-v-237655bd"]]),hd={class:"pdf-wrapper"},cd=["src"],ud={key:0,class:"overlay"},dd={key:1,class:"overlay"},fd={__name:"PdfViewer",props:{preview:{type:Object,required:!0},defaultHeight:{type:Number,default:600}},emits:["pdf-loaded","pdf-error"],setup(r,{emit:n}){const h=r,d=n,{t:f}=cc(),g=hr(!0),w=hr(!1),C=uc(()=>h.preview?.id?`/api/pictures/originals/preview-files/${h.preview.id}.pdf#view=Fit`:""),x=()=>{g.value=!1,w.value=!1,d("pdf-loaded")},P=()=>{g.value=!1,w.value=!0,d("pdf-error")};return dc(()=>h.preview?.id,()=>{g.value=!0,w.value=!1}),(E,D)=>(M(),R("div",{class:"pdf-viewer",style:lt({height:r.defaultHeight?`${r.defaultHeight}px`:"100%"})},[st(L("div",hd,[L("iframe",{class:"pdf-frame",src:C.value,frameborder:"0",onLoad:x,onError:P},null,40,cd)],512),[[rt,!g.value]]),g.value?(M(),R("div",ud,[H(De,{"is-white":"",class:"spinner"})])):w.value?(M(),R("div",dd,U(fc(f)("preview.broken")),1)):V("",!0)],4))}},pd=Tt(fd,[["__scopeId","data-v-ad2bff71"]]),gd={name:"preview-room",components:{ButtonSimple:ls,PeopleAvatar:Co},props:{room:{type:Object,default:()=>{}}},emits:["join-room","leave-room","open-room"],data(){return{}},computed:{...Ee(["personMap","user"]),peopleInRoom(){return this.room.people.map(r=>this.personMap.get(r))},joinedRoom(){if(this.room.id)return this.room.people.find(r=>r===this.user.id)}},methods:{openRoom(){this.room.id&&this.$emit("open-room",this.room.id)},onJoinClicked(){this.$emit("join-room",this.room.id)},onLeaveClicked(){this.$emit("leave-room",this.room.id)}}},md={class:"preview-room mr05"};function yd(r,n,h,d,f,g){const w=G("button-simple"),C=G("people-avatar");return M(),R("div",md,[g.joinedRoom?(M(),et(w,{key:0,text:r.$t("preview_room.leave_room"),class:"preview-room-button",onClick:g.onLeaveClicked},null,8,["text","onClick"])):(M(),et(w,{key:1,text:r.$t("preview_room.join_room"),class:"preview-room-button",onClick:g.onJoinClicked},null,8,["text","onClick"])),(M(!0),R(Ht,null,ee(g.peopleInRoom,x=>(M(),et(C,{class:"person-avatar",key:x.id,person:x,size:30,"font-size":15,"is-link":!1},null,8,["person"]))),128))])}const vd=Tt(gd,[["render",yd],["__scopeId","data-v-786b6308"]]),wd={name:"select-task-type-modal",mixins:[dr],components:{ComboboxTaskType:_o},props:{active:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1},taskTypeList:{type:Array,default:()=>{}}},emits:["cancel","confirm"],data(){return{taskTypeId:""}},methods:{runConfirmation(){this.$emit("confirm",this.taskTypeId)}},watch:{active(){this.taskTypeId=this.taskTypeList[0].id}}},Cd={class:"modal-content"},bd={class:"box"},_d={class:"title"},xd={class:"has-text-right mt2"},Pd={key:0,class:"error has-text-right info-message"};function Sd(r,n,h,d,f,g){const w=G("combobox-task-type");return M(),R("div",{class:St({modal:!0,"is-active":h.active})},[L("div",{class:"modal-background",onClick:n[0]||(n[0]=C=>r.$emit("cancel"))}),L("div",Cd,[L("div",bd,[L("h1",_d,U(r.$t("playlists.select_task_type")),1),L("form",{onSubmit:n[2]||(n[2]=Ei(()=>{},["prevent"]))},[H(w,{"task-type-list":h.taskTypeList,modelValue:f.taskTypeId,"onUpdate:modelValue":n[1]||(n[1]=C=>f.taskTypeId=C)},null,8,["task-type-list","modelValue"])],32),L("p",null,U(r.$t("playlists.apply_task_type_change")),1),L("p",xd,[L("a",{class:St({button:!0,"is-primary":!0,"is-loading":h.isLoading}),onClick:n[3]||(n[3]=(...C)=>g.runConfirmation&&g.runConfirmation(...C))},U(r.$t("main.confirmation")),3),L("button",{onClick:n[4]||(n[4]=C=>r.$emit("cancel")),class:"button is-link"},U(r.$t("main.cancel")),1)]),h.isError?(M(),R("p",Pd,U(r.$t("playlist.change_task_type_fails")),1)):V("",!0)])])],2)}const Td=Tt(wd,[["render",Sd],["__scopeId","data-v-096b0780"]]),kd={name:"sound-viewer",components:{Spinner:De},emits:["play-ended"],data(){return{isLoading:!1,wavesurfer:null}},props:{previewUrl:{default:"",type:String},fileName:{default:"",type:String},defaultHeight:{type:Number,default:200},fullScreen:{default:!1,type:Boolean}},mounted(){this.isLoading=!0,this.wavesurfer=Ye.create({container:"#waveform",waveColor:"#00B242",progressColor:"#008732",height:this.defaultHeight}),this.wavesurfer.on("ready",()=>{this.isLoading=!1}),this.wavesurfer.on("finish",()=>{this.$emit("play-ended")}),this.previewUrl&&(this.isLoading=!0,this.wavesurfer.load(this.previewUrl))},computed:{container(){return this.$refs.container}},methods:{play(){this.wavesurfer.play()},pause(){this.wavesurfer.pause()},redraw(){}},watch:{previewUrl(){this.previewUrl&&this.previewUrl.length>0&&(this.isLoading=!0,this.wavesurfer.load(this.previewUrl))}}},Od={class:"loading"};function Ed(r,n,h,d,f,g){const w=G("spinner");return M(),R("div",{id:"sound-container",style:lt({height:h.defaultHeight+"px",width:"100%"})},[st(L("div",Od,[H(w)],512),[[rt,f.isLoading]]),st(L("div",{class:"file-name"},U(h.fileName),513),[[rt,!f.isLoading]]),n[0]||(n[0]=L("div",{id:"waveform"},null,-1))],4)}const Dd=Tt(kd,[["render",Ed],["__scopeId","data-v-965fba47"]]),Md={__name:"SpeedButton",props:{modelValue:{},modelModifiers:{}},emits:["update:modelValue"],setup(r){const n=lr(r,"modelValue"),h={0:"x0.25",1:"x0.50",2:"x1.00",3:"x1.50",4:"x2.00"},d=()=>{const f=[.25,.5,1,1.5,2];n.value=n.value%f.length+1};return(f,g)=>(M(),et(ls,{title:f.$t("playlists.actions.speed"),text:h[n.value-1],onClick:d},null,8,["title","text"]))}},Ad={name:"playlist-progress",mixins:[Di],components:{Spinner:De},props:{entityList:{default:()=>[],type:Array},fps:{default:0,type:Number},frameDuration:{default:0,type:Number},isFullMode:{default:!1,type:Boolean},isFullScreen:{default:!1,type:Boolean},nbFrames:{default:0,type:Number},movieDimensions:{default:()=>({}),type:Object},previewId:{default:"",type:String},playlistDuration:{default:0,type:Number},playlistProgress:{default:0,type:Number},playlistShotPosition:{default:()=>{},type:Object}},emits:["end-scrub","progress-playlist-changed","start-scrub"],data(){return{currentMouseFrame:{},frameNumberHeight:0,frameNumberLeftPosition:0,isFrameNumberVisible:!1,isTileLoading:!1,hoverFrame:0,progressDragging:!1,playlistProgressDragging:!1,width:0,domEvents:[["mousemove",this.doProgressDrag],["touchmove",this.doProgressDrag],["mouseup",this.stopProgressDrag],["mouseleave",this.stopProgressDrag],["touchend",this.stopProgressDrag],["touchcancel",this.stopProgressDrag],["mouseup",this.stopPlaylistProgressDrag],["mouseleave",this.stopPlaylistProgressDrag],["touchend",this.stopPlaylistProgressDrag],["touchcancel",this.stopPlaylistProgressDrag]]}},mounted(){this.addEvents(this.domEvents),new ResizeObserver(this.onWindowResize).observe(this.playlistProgressWidget),this.resetWidth()},beforeUnmount(){this.removeEvents(this.domEvents)},computed:{backgroundSize(){return this.videoDuration?200/this.nbFrames+"% 100%":"300%"},frameSize(){return this.width/this.nbFrames},frameNumberStyle(){let h=150;const d=this.playlistShotPosition[this.hoverFrame];if(!d)return{};if(d.extension==="mp4"){const C=d.width/d.height;h=Math.ceil(100*C)}else d.extension==="png"&&(h=150);const f=h+10,g=Math.min(Math.max(this.frameNumberLeftPosition-h/2,0),this.width-h-10),w=this.isFullScreen?"-132px":"16px";return{height:"130px",width:`${f}px`,top:w,left:`${g}px`}},tilePath(){return`/api/movies/tiles/preview-files/${this.previewId}.png`},videoDuration(){return this.nbFrames*this.frameDuration},handleInWidth(){return Math.max(this.frameSize*this.handleIn,0)+"px"},playlistProgressWidget(){return this.$refs["playlist-progress"]}},methods:{resetWidth(){if(this.playlistProgressWidget){const r=this.playlistProgressWidget.getBoundingClientRect();this.width=r.width,setTimeout(()=>{this.width=r.width})}},onWindowResize(){this.resetWidth()},updatePlaylistProgressBar(r){},startPlaylistProgressDrag(r){this.playlistProgressDragging=!0,this.$emit("start-scrub")},stopPlaylistProgressDrag(r){this.playlistProgressDragging=!1,this.$emit("end-scrub")},doProgressDrag(r){if(this.playlistProgressDragging||this.isFrameNumberVisible||!this.progressDragging&&r.target.classList&&(r.target.classList.contains("playlilst-progress")||r.target.classList.contains("entity-status")||r.target.classList.contains("playlist-progress-position"))){this.currentMouseFrame=this._getPlaylistMouseFrame(r);const{frameNumber:n}=this.currentMouseFrame;this.hoverFrame=n+1;const h=Math.round(this.playlistDuration*this.fps);this.frameNumberLeftPosition=this.width/h*n,this.playlistProgressDragging&&this.$emit("progress-playlist-changed",n)}},onPlaylistProgressClicked(r){const{frameNumber:n}=this._getPlaylistMouseFrame(r);this.$emit("progress-playlist-changed",n)},_getPlaylistMouseFrame(r){this.width===0&&this.resetWidth();const n=this.playlistProgressWidget.getBoundingClientRect().left;let h=this.getClientX(r)-n;h>this.width&&(h=this.width-1);const d=h/this.width;let f=this.playlistDuration*d;return f<0&&(f=0),{frameNumber:Math.floor(f/this.frameDuration),position:h}},getFrameBackgroundStyle(r){if(!r||!this.playlistShotPosition[r])return{};const{id:n,extension:h,width:d,height:f}=this.playlistShotPosition[r];r=r-this.playlistShotPosition[r].start*this.fps,this.nbFrames>=3840&&(r=Math.ceil(r/Math.ceil(this.nbFrames/3840)));const g=r%8,w=Math.floor(r/8),C=100;if(h==="png")return{background:`url(${`/api/pictures/thumbnails/preview-files/${n}.png`})`,"background-position":"0 0",width:"150px"};if(h==="mp4"){const x=d/f,P=Math.ceil(C*x);return{background:`url(${`/api/movies/tiles/preview-files/${n}.png`})`,"background-position":`-${g*P}px -${w*C}px`,width:`${P}px`}}else return{background:"transparent"}},getFrameNumberStyle(r){const d=this.movieDimensions.width?this.movieDimensions.width/this.movieDimensions.height:1,f=Math.ceil(100*d),g=f+10,w=Math.min(Math.max(this.frameNumberLeftPosition-f/2,0),this.width-f-10),C=this.isFullScreen?"-162px":"42px";return{height:"130px",width:`${g}px`,top:C,left:`${w}px`}},getEntityPosition(r){return(r.start_duration-this.frameDuration)/this.playlistDuration*100},getEntityWidth(r){let n;return r.preview_file_extension==="mp4"?n=r.preview_file_duration/this.playlistDuration:r.preview_nb_frames?n=r.preview_nb_frames*this.frameDuration/this.playlistDuration:n=2*this.fps*this.frameDuration/this.playlistDuration,n*100},getEntityColor(r){return r.task_status_color},getFullEntityName(r){return`${r.parent_name} / ${r.name}`.replaceAll(" ","")}},watch:{previewId:{immediate:!0,handler(){if(this.previewId&&this.playlistShotPosition[this.hoverFrame].extension==="mp4"){this.isTileLoading=!0;const n=new Image;n.src=this.tilePath,n.onload=()=>{this.isTileLoading=!1}}}},entityList(){this.resetWidth()},playlistProgress(){this.updatePlaylistProgressBar(this.playlistProgress)}}},Fd={class:"unselectable"},Ld={class:"frame-number-rail"};function Rd(r,n,h,d,f,g){const w=G("spinner");return M(),R("div",Fd,[L("div",Ld,[st(L("span",{class:"frame-number",style:lt(g.frameNumberStyle)},[as(U(f.hoverFrame)+" ",1),f.isTileLoading?(M(),et(w,{key:1,class:"mt2"})):(M(),R("span",{key:0,class:"frame-tile",style:lt(g.getFrameBackgroundStyle(f.hoverFrame))},null,4))],4),[[rt,f.isFrameNumberVisible&&f.hoverFrame>0&&!f.progressDragging&&!f.playlistProgressDragging]])]),st(L("div",{ref:"playlist-progress",class:"playlist-progress",onClick:n[11]||(n[11]=(...C)=>g.onPlaylistProgressClicked&&g.onPlaylistProgressClicked(...C)),onMouseenter:n[12]||(n[12]=C=>f.isFrameNumberVisible=!0),onMouseleave:n[13]||(n[13]=C=>f.isFrameNumberVisible=!1),onTouchend:n[14]||(n[14]=C=>f.isFrameNumberVisible=!1),onTouchcancel:n[15]||(n[15]=C=>f.isFrameNumberVisible=!1),onMousedown:n[16]||(n[16]=(...C)=>g.startPlaylistProgressDrag&&g.startPlaylistProgressDrag(...C)),onTouchstart:n[17]||(n[17]=()=>{g.startPlaylistProgressDrag(),f.isFrameNumberVisible=!0})},[(M(!0),R(Ht,null,ee(h.entityList,C=>(M(),R("div",{class:"entity-status",key:`progress-entity-${C.id}`,style:lt({left:g.getEntityPosition(C)+"%",width:g.getEntityWidth(C)+"%","background-color":g.getEntityColor(C)}),onMouseenter:n[0]||(n[0]=x=>f.isFrameNumberVisible=!0),onMouseleave:n[1]||(n[1]=x=>f.isFrameNumberVisible=!1),onTouchend:n[2]||(n[2]=x=>f.isFrameNumberVisible=!1),onTouchcancel:n[3]||(n[3]=x=>f.isFrameNumberVisible=!1),onMousedown:n[4]||(n[4]=(...x)=>g.startPlaylistProgressDrag&&g.startPlaylistProgressDrag(...x)),onTouchstart:n[5]||(n[5]=()=>{g.startPlaylistProgressDrag(),f.isFrameNumberVisible=!0})},[L("span",null,U(g.getFullEntityName(C)),1)],36))),128)),L("span",{class:"playlist-progress-position",style:lt({left:"calc("+100*h.playlistProgress/h.playlistDuration+"% - 3px)"}),onMouseenter:n[6]||(n[6]=C=>f.isFrameNumberVisible=!0),onMouseleave:n[7]||(n[7]=C=>f.isFrameNumberVisible=!1),onTouchstart:n[8]||(n[8]=C=>f.isFrameNumberVisible=!0),onTouchend:n[9]||(n[9]=C=>f.isFrameNumberVisible=!1),onTouchcancel:n[10]||(n[10]=C=>f.isFrameNumberVisible=!1)},null,36)],544),[[rt,h.entityList.length>1&&h.playlistDuration>0]])])}const jd=Tt(Ad,[["render",Rd],["__scopeId","data-v-98ababf2"]]),Id={name:"video-progress",mixins:[Di],components:{Spinner:De},props:{annotations:{default:()=>[],type:Array},comparisonAnnotations:{default:()=>[],type:Array},empty:{default:!1,type:Boolean},frameDuration:{default:0,type:Number},isFullMode:{default:!1,type:Boolean},isFullScreen:{default:!1,type:Boolean},movieDimensions:{default:()=>({}),type:Object},nbFrames:{default:0,type:Number},handleIn:{default:3,type:Number},handleOut:{default:3,type:Number},previewId:{default:"",type:String}},emits:["end-scrub","handle-in-changed","handle-out-changed","progress-changed","start-scrub"],data(){return{currentMouseFrame:{},frameNumberLeftPosition:0,isFrameNumberVisible:!1,isTileLoading:!1,handleInDragging:!1,handleOutDragging:!1,hoverFrame:0,progressDragging:!1,width:0,domEvents:[["mousemove",this.doProgressDrag],["touchmove",this.doProgressDrag],["mouseup",this.stopProgressDrag],["mouseleave",this.stopProgressDrag],["touchend",this.stopProgressDrag],["touchcancel",this.stopProgressDrag],["mouseup",this.stopHandleInDrag],["mouseleave",this.stopHandleInDrag],["touchend",this.stopHandleInDrag],["touchcancel",this.stopHandleInDrag],["mouseup",this.stopHandleOutDrag],["mouseleave",this.stopHandleOutDrag],["touchend",this.stopHandleOutDrag],["touchcancel",this.stopHandleOutDrag],["resize",this.resetScheduleSize]]}},mounted(){this.addEvents(this.domEvents),new ResizeObserver(this.onWindowResize).observe(this.progress);const r=this.progress.getBoundingClientRect();this.width=r.width,setTimeout(()=>{this.width=r.width}),this.progress.setAttribute("max",this.videoDuration)},beforeUnmount(){this.removeEvents(this.domEvents)},computed:{backgroundSize(){return this.videoDuration?200/this.nbFrames+"% 100%":"300%"},frameSize(){return this.width/this.nbFrames},frameNumberStyle(){const h=Math.ceil(100*this.videoRatio),d=h+10,f=Math.min(Math.max(this.frameNumberLeftPosition-h/2,0),this.width-h-10);return{height:"130px",width:`${d}px`,top:"-160px",left:`${f}px`}},progress(){return this.$refs.progress},videoDuration(){return this.nbFrames*this.frameDuration},videoRatio(){return this.movieDimensions.width?this.movieDimensions.width/this.movieDimensions.height:1},handleInWidth(){return Math.max(this.frameSize*this.handleIn,0)+"px"}},methods:{onWindowResize(){if(this.progress){const r=this.progress.getBoundingClientRect();this.width=r.width}},getAnnotationPosition(r){return this.nbFrames===0?0:Math.round(r.time/this.frameDuration)*this.frameSize},updateProgressBar(r){this.progress.value=this.empty?r*this.frameDuration:(r+1)*this.frameDuration},startProgressDrag(r){this.progressDragging=!0,this.$emit("start-scrub")},stopProgressDrag(r){this.progressDragging=!1,this.$emit("end-scrub")},startHandleInDrag(r){this.handleInDragging=!0},stopHandleInDrag(r){if(this.handleInDragging){this.handleInDragging=!1;const{frameNumber:n}=this.currentMouseFrame;this.$emit("handle-in-changed",{frameNumber:n,save:!0})}},startHandleOutDrag(r){this.handleOutDragging=!0},stopHandleOutDrag(r){if(this.handleOutDragging){this.handleOutDragging=!1;let{frameNumber:n,position:h}=this.currentMouseFrame;this.width-h<4&&(n+=1),this.$emit("handle-out-changed",{frameNumber:n,save:!0})}},doProgressDrag(r){if(this.progressDragging||this.handleInDragging||this.handleOutDragging||this.isFrameNumberVisible){this.currentMouseFrame=this._getMouseFrame(r);const{frameNumber:n}=this.currentMouseFrame;if(this.hoverFrame=n+1,this.frameNumberLeftPosition=this.width/this.nbFrames*n,this.progressDragging)this.$emit("progress-changed",n);else if(this.handleInDragging)this.$emit("handle-in-changed",{frameNumber:n,save:!1});else if(this.handleOutDragging){let{frameNumber:h,position:d}=this.currentMouseFrame;this.width-d<4&&(h+=1),this.$emit("handle-out-changed",{frameNumber:h,save:!1})}}},onProgressClicked(r){this._emitProgressEvent(r)},_getMouseFrame(r,n){let h=this.progress.getBoundingClientRect().left;h===0&&!this.isFullScreen&&this.progress.parentElement.offsetParent&&(h=this.progress.parentElement.offsetParent.offsetLeft);let d=this.getClientX(r)-h;d>this.width&&(d=this.width-1);const f=d/this.width;let g=n&&this.frameSize<3?n.time:this.videoDuration*f;g<0&&(g=0);const C=!!window.chrome?this.frameDuration:0,x=this.nbFrames*this.frameDuration;return g>x&&(g=x-C),{frameNumber:Math.floor(g/this.frameDuration),position:d}},_emitProgressEvent(r,n){const{frameNumber:h}=this._getMouseFrame(r,n);h<0||this.$emit("progress-changed",h)},getFrameBackgroundStyle(r){if(!r)return{};const n=this.previewId;r=r-1,this.nbFrames>=3840&&(r=Math.ceil(r/Math.ceil(this.nbFrames/3840)));const h=r%8,d=Math.floor(r/8),f=100,g=Math.ceil(f*this.videoRatio);return{background:`url(${`/api/movies/tiles/preview-files/${n}.png`})`,"background-position":`-${h*g}px -${d*f}px`,width:`${g}px`}},getFrameNumberStyle(r){const d=this.movieDimensions.width?this.movieDimensions.width/this.movieDimensions.height:1,f=Math.ceil(100*d),g=f+10,w=Math.min(Math.max(this.frameNumberLeftPosition-f/2,0),this.width-f-10);return{height:"130px",width:`${g}px`,top:"-130px",left:`${w}px`}}},watch:{videoDuration(){const r=this.progress.getBoundingClientRect();this.width=r.width,this.progress.setAttribute("max",this.videoDuration),this.updateProgressBar(0)}}},Bd={class:"unselectable"},Wd=["onClick"],Hd=["onClick"],$d={class:"frame-number-rail"};function zd(r,n,h,d,f,g){const w=G("spinner");return M(),R("div",Bd,[L("div",{class:"progress-wrapper",style:lt({"background-size":g.backgroundSize}),onMouseenter:n[17]||(n[17]=C=>f.isFrameNumberVisible=!0),onMouseleave:n[18]||(n[18]=C=>f.isFrameNumberVisible=!1),onTouchstart:n[19]||(n[19]=C=>f.isFrameNumberVisible=!0),onTouchend:n[20]||(n[20]=C=>f.isFrameNumberVisible=!1),onTouchcancel:n[21]||(n[21]=C=>f.isFrameNumberVisible=!1)},[h.handleIn>=0&&!h.isFullMode&&!h.empty?(M(),R("span",{key:0,class:"handle-in",style:lt({width:g.handleInWidth,"padding-right":h.handleIn>1?"5px":0}),onMousedown:n[0]||(n[0]=(...C)=>g.startHandleInDrag&&g.startHandleInDrag(...C)),onTouchstart:n[1]||(n[1]=(...C)=>g.startHandleInDrag&&g.startHandleInDrag(...C))},U(h.handleIn!==0?h.handleIn+1:""),37)):V("",!0),h.handleOut>=0&&!h.isFullMode&&!h.empty?(M(),R("span",{key:1,class:"handle-out",style:lt({width:g.frameSize*(h.nbFrames-h.handleOut)+"px"}),onMousedown:n[2]||(n[2]=(...C)=>g.startHandleOutDrag&&g.startHandleOutDrag(...C)),onTouchstart:n[3]||(n[3]=(...C)=>g.startHandleOutDrag&&g.startHandleOutDrag(...C))},U(h.handleOut+1),37)):V("",!0),L("progress",{ref:"progress",value:"0",min:"0",onClick:n[4]||(n[4]=(...C)=>g.onProgressClicked&&g.onProgressClicked(...C)),onMousedown:n[5]||(n[5]=(...C)=>g.startProgressDrag&&g.startProgressDrag(...C)),onTouchstart:n[6]||(n[6]=(...C)=>g.startProgressDrag&&g.startProgressDrag(...C))},null,544),(M(!0),R(Ht,null,ee(h.annotations,(C,x)=>(M(),R("span",{key:`annotation-${x}`,class:"annotation-mark",style:lt({left:g.getAnnotationPosition(C)+"px",width:Math.max(g.frameSize-1,5)+"px"}),onMouseenter:n[7]||(n[7]=P=>f.isFrameNumberVisible=!0),onMouseleave:n[8]||(n[8]=P=>f.isFrameNumberVisible=!0),onTouchstart:n[9]||(n[9]=P=>f.isFrameNumberVisible=!0),onTouchend:n[10]||(n[10]=P=>f.isFrameNumberVisible=!1),onTouchcancel:n[11]||(n[11]=P=>f.isFrameNumberVisible=!1),onClick:P=>g._emitProgressEvent(P,C)},null,44,Wd))),128)),(M(!0),R(Ht,null,ee(h.comparisonAnnotations,(C,x)=>(M(),R("span",{key:`annotation-comparison-${x}`,class:"annotation-mark comparison-mark",style:lt({left:g.getAnnotationPosition(C)+"px",width:Math.max(g.frameSize-1,5)+"px"}),onMouseenter:n[12]||(n[12]=P=>f.isFrameNumberVisible=!0),onMouseleave:n[13]||(n[13]=P=>f.isFrameNumberVisible=!0),onTouchstart:n[14]||(n[14]=P=>f.isFrameNumberVisible=!0),onTouchend:n[15]||(n[15]=P=>f.isFrameNumberVisible=!1),onTouchcancel:n[16]||(n[16]=P=>f.isFrameNumberVisible=!1),onClick:P=>g._emitProgressEvent(P,C)},null,44,Hd))),128))],36),L("div",$d,[st(L("span",{class:"frame-number",style:lt(g.frameNumberStyle)},[as(U(f.hoverFrame)+" ",1),f.isTileLoading?(M(),et(w,{key:1,class:"mt2"})):(M(),R("span",{key:0,class:"frame-tile",style:lt(g.getFrameBackgroundStyle(f.hoverFrame))},null,4))],4),[[rt,f.isFrameNumberVisible&&f.hoverFrame>0&&!h.empty&&!f.progressDragging]])])])}const Vd=Tt(Id,[["render",zd],["__scopeId","data-v-2eed2da9"]]),Nd=()=>bo(()=>import("./TaskInfo-C8qSIbPH.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65])),Xd={name:"playlist-player",mixins:[Kc,Di,yo,vo],components:{ArrowUpRightIcon:mc,ButtonSimple:ls,ButtonSound:eu,ColorPicker:hu,Combobox:So,ComboboxStyled:_c,DeleteModal:xc,DownloadIcon:gc,GlobeIcon:pc,ObjectViewer:Lu,PdfViewer:pd,PencilPicker:zu,PictureViewer:Ao,MultiPictureViewer:bu,NotifyClientModal:Ou,PlayIcon:kc,PlaylistProgress:jd,PlaylistedEntity:ed,PreviewRoom:vd,RawVideoPlayer:ld,SelectTaskTypeModal:Td,SoundViewer:Dd,Spinner:De,SpeedButton:Md,TaskInfo:yc(Nd),VideoProgress:Vd},props:{playlist:{type:Object,default:()=>{}},entities:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},isAddingEntity:{type:Boolean,default:!1},currentEntityType:{type:String,default:"shot"},tempMode:{type:Boolean,default:!1}},emits:["edit-clicked","entity-to-add","new-entity-dropped","order-change","playlist-deleted","preview-changed","save-clicked","show-add-entities","remove-entity","task-type-changed"],data(){return{comparisonEntityMissing:!1,comparisonMode:"sidebyside",currentBackground:null,currentComparisonPreviewIndex:0,handleIn:0,handleOut:0,isAnnotationsDisplayed:!0,isBuildLaunched:!1,isDlButtonsHidden:!0,isEnvironmentSkybox:!1,isFullMode:!1,isLaserModeOn:!1,isMounted:!1,isObjectBackground:!1,isShowingPalette:!1,isShowingPencilPalette:!1,isShowAnnotationsWhilePlaying:!1,isWaveformDisplayed:!1,isWireframe:!1,isZoomEnabled:!1,movieDimensions:{width:0,height:0},objectBackgroundUrl:null,pictureDefaultHeight:0,playlistShotPosition:{},playlistDuration:0,playlistProgress:0,playlistToEdit:{},revisionOptions:[],savedTaskTypeToCompare:null,taskTypeOptions:[],taskTypeToCompare:null,revisionToCompare:null,objectModel:{availableAnimations:[],currentAnimation:null,isAnimation:null},room:{people:[],newComer:!0},modals:{delete:!1,notifyClients:!1,taskType:!1},loading:{deletePlaylist:!1,notifyClients:!1},errors:{deletePlaylist:!1,notifyClients:!1,playlists:!1},success:{notifyClients:!1},forClientOptions:[{label:this.$t("playlists.for_client"),value:"true"},{label:this.$t("playlists.for_studio"),value:"false"}]}},mounted(){this.isMounted||(this.$options.scrubbing=!1,this.isCurrentUserClient&&(this.isCommentsHidden=!1),this.isHd=!!this.organisation.hd_by_default,this.entities?this.entityList=this.entities:this.entityList=[],this.resetPlaylistFrameData(),this.room.id=this.playlist.id,this.room.localId=os(),this.$nextTick(()=>{this.configureEvents(),this.setupFabricCanvas(),this.resetCanvas(),this.setPlayerSpeed(1),this.rebuildComparisonOptions(),this.onFrameUpdate(0),this.configureWaveForm(),this.configureFullPlayer()}),this.currentBackground=this.productionBackgrounds.find(this.isDefaultBackground)||null,this.onObjectBackgroundSelected(),this.isMounted=!0,this.resetPencilConfiguration(),this.volume=ye.getPreference("player:volume")||this.volume,this.$nextTick(()=>{this.rawPlayer?.setVolume(this.volume)}))},beforeUnmount(){this.wavesurfer&&this.wavesurfer.destroy()},computed:{...Ee(["currentEpisode","currentProduction","isCurrentUserArtist","isCurrentUserClient","isCurrentUserManager","isCurrentUserSupervisor","isTVShow","organisation","personMap","previewFileMap","productionBackgrounds","shotMap","productionAssetTaskTypes","productionSequenceTaskTypes","productionShotTaskTypes","taskMap","taskStatusMap","taskTypeMap","user"]),fullPlayer(){return this.$refs["full-playlist-player"]},picturePreviews(){const r=[];return this.entityList.forEach(n=>{r.push({id:n.preview_file_id,height:n.preview_file_height,width:n.preview_file_width,extension:n.preview_file_extension,revision:n.preview_file_revision,position:1}),n.preview_file_previews&&n.preview_file_previews.forEach((h,d)=>{r.push({id:h.id,height:h.height,width:h.width,extension:h.extension,revision:h.revision,position:d+2})})}),r},isAllowToEdit(){if(this.isCurrentUserManager)return!0;if(this.isCurrentUserSupervisor){const r=this.personMap.get(this.playlist.created_by);return!r||r.id===this.user.id}return!1},isMovieComparison(){return this.currentPreviewToCompare?this.currentPreviewToCompare.extension==="mp4":!1},isPictureComparison(){return this.currentPreviewToCompare?this.isPicture(this.currentPreviewToCompare.extension):!1},comparisonModeOptions(){return[{label:this.$t("playlists.actions.side_by_side"),value:"sidebyside"},{label:`${this.$t("playlists.actions.overlay")} 0%`,value:"overlay0"},{label:`${this.$t("playlists.actions.overlay")} 25%`,value:"overlay25"},{label:`${this.$t("playlists.actions.overlay")} 50%`,value:"overlay50"},{label:`${this.$t("playlists.actions.overlay")} 75%`,value:"overlay75"},{label:`${this.$t("playlists.actions.overlay")} 100%`,value:"overlay100"}]},currentRevisionToCompare(){if(!this.currentEntity)return null;const r=this.currentEntity.preview_files[this.taskTypeToCompare];if(r&&r.length>0){const n=r.find(h=>`${h.revision}`===this.revisionToCompare);return n||r[0]}else return null},currentPreviewToCompare(){if(!this.currentEntity)return null;if(this.currentComparisonPreviewIndex>0){const r=this.currentComparisonPreviewIndex-1;return this.currentRevisionToCompare.previews[r]}else return this.currentRevisionToCompare},currentPreviewOriginalPath(){if(!this.currentPreview)return"";const r=this.currentPreview.id,n=this.currentPreview.extension;return`/api/pictures/originals/preview-files/${r}.${n}`},previousEntityIndex(){let r=this.playingEntityIndex-1;return r<0&&(r=this.entityList.length-1),r},nextEntityIndex(){let r=this.playingEntityIndex+1;return r>this.entityList.length-1&&(r=0),r},currentComparisonPreviewLength(){if(this.currentRevisionToCompare){const r=this.currentRevisionToCompare.previews;return r?r.length+1:0}else return 0},csvDlPath(){return`/api/export/csv/playlists/${this.playlist.id}`},zipDlPath(){return`/api/data/playlists/${this.playlist.id}/download/zip`},deleteText(){return this.playlist?this.$t("playlists.delete_text",{name:this.playlist.name}):""},timezone(){return this.user.timezone||ao.tz.guess()},entityTaskTypes(){return this.playlist.for_entity==="asset"?this.productionAssetTaskTypes:this.playlist.for_entity==="shot"?this.productionShotTaskTypes:this.productionSequenceTaskTypes},addEntitiesText(){return this.isAssetPlaylist?this.$t("playlists.add_assets"):this.isSequencePlaylist?this.$t("playlists.add_sequences"):this.$t("playlists.add_shots")},isAssetPlaylist(){return this.currentEntityType==="asset"},isSequencePlaylist(){return this.currentEntityType==="sequence"},isJobRunning(){return this.playlist.build_jobs.filter(r=>r.status==="running").length!==0},backgroundOptions(){const r=this.$t("playlists.actions.default");return[{label:this.$t("playlists.actions.select_background"),value:null,placeholder:!0},...this.productionBackgrounds.map(n=>({value:n,label:n.name,optionLabel:n.name+(this.isDefaultBackground(n)?` (${r})`:"")}))]},backgroundUrl(){return this.isObjectBackground?this.objectBackgroundUrl:void 0}},methods:{...wo(["changePlaylistType","deletePlaylist","notifyClients","removeBuildJob","runPlaylistBuild","editShot"]),onNotifyClientsClicked(){this.modals.notifyClients=!0,this.success.notifyClients=!1,this.errors.notifyClients=!1},async confirmNotifyClients({studioId:r,departmentId:n}){this.loading.notifyClients=!0,this.errors.notifyClients=!1,this.success.notifyClients=!1;try{await this.notifyClients({playlist:this.playlist,studioId:r,departmentId:n}),this.success.notifyClients=!0}catch(h){console.error(h),this.errors.notifyClients=!0}finally{this.loading.notifyClients=!1}},getBuildPath(r){return`/api/data/playlists/${this.playlist.id}/jobs/${r.id}/build/mp4`},formatDate(r){return ao.tz(r,"UTC").tz(this.timezone).format("YYYY-MM-DD HH:mm")},formatFrame:Po,showDeleteModal(){this.modals.delete=!0},hideDeleteModal(){this.modals.delete=!1},async confirmRemovePlaylist(){this.loading.deletePlaylist=!0,this.errors.deletePlaylist=!1;try{await this.deletePlaylist({playlist:this.playlist}),this.$emit("playlist-deleted"),this.modals.delete=!1}catch(r){console.error(r),this.errors.deletePlaylist=!0}finally{this.loading.deletePlaylist=!1}},scrollToEntity(r){const n=this.$refs["entity-"+r];if(n&&n[0]){const h=n[0].$el,d=this.$refs["playlisted-entities"],f=this.entityList[r];if(this.annotations=f.preview_file_annotations||[],h){const w=h.getBoundingClientRect(),C=d.getBoundingClientRect(),x=w.right>C.right-30;if(w.left<C.left-30){const E=w.left-C.left-30;d.scrollLeft=d.scrollLeft+E}else if(x){const E=w.right-C.right+30;d.scrollLeft=d.scrollLeft+E}}}},scrollToRight(){this.entityList.length>0&&this.scrollToEntity(this.entityList.length-1)},entityListClicked(r){this.playEntity(r),this.currentPreviewIndex=0,this.updateRoomStatus()},removeEntity({entity:r,previewFileId:n}){this.$emit("remove-entity",{entity:r,previewFileId:n})},onPlayPreviousEntityClicked(){this.currentPreviewIndex>0?this.onPreviousPreviewClicked():this.onPlayPreviousEntity()},onPlayPreviousEntity(){this.clearFocus(),this.playEntity(this.previousEntityIndex),this.sendUpdatePlayingStatus()},onPlayNextEntity(){this.clearFocus(),this.playEntity(this.nextEntityIndex),this.sendUpdatePlayingStatus()},onPlayNextEntityClicked(){this.currentPreviewIndex<this.currentEntityPreviewLength-1?this.onNextPreviewClicked():this.onPlayNextEntity()},onPlayNext(){const r=this.entityList[this.nextEntityIndex];this.isRepeating&&this.isCurrentPreviewMovie?this.rawPlayer.playNext():r.preview_file_extension==="mp4"?(this.resetHandles(r),this.rawPlayer.playNext(this.handleIn),this.syncComparisonPlayer(),this._setCurrentTimeOnHandleIn()):(this.onPlayNextEntityClicked(),this.isCurrentPreviewPicture&&(this.framesSeenOfPicture=1,this.playPicture(),this.updateProgressBar()))},onPlayerPlayingEntityChange(r){this.playingEntityIndex=r,this.isCurrentPreviewMovie&&(this.isComparing&&this.rawPlayerComparison.currentIndex!==r&&this.rawPlayerComparison.playNext(),this.movieDimensions={width:this.currentPreview.width,height:this.currentPreview.height}),this.$options.silent||this.scrollToEntity(this.playingEntityIndex)},continuePlayingPlaylist(r,n){const d=this.framesPerImage[r]*1e3/this.fps,f=Date.now()-n;if(this.isPlaying){if(f<d){this.framesSeenOfPicture=Math.max(Math.floor(f/1e3*this.fps),1),this.playingPictureTimeout=setTimeout(()=>{this.continuePlayingPlaylist(r,n)},100);return}}else return;const g=this.currentEntity.preview_file_previews;g&&g.length===this.currentPreviewIndex?this.$nextTick(()=>{this.onPlayNextEntity(!0),this.framesSeenOfPicture=1}):(this.currentPreviewIndex++,this.$nextTick(()=>{this.playingPictureTimeout=setTimeout(()=>{this.continuePlayingPlaylist(this.playingEntityIndex,Date.now())},100)}))},onVideoLoaded(){this.currentPreview&&(this.movieDimensions={width:this.currentPreview.width,height:this.currentPreview.height},this.isPlaying||this.loadAnnotation(this.getAnnotation(0)))},onModelLoaded(){const r=this.modelPlayer?.getAnimations()||[];this.objectModel.isAnimation=r.length>0,this.objectModel.isAnimation?(this.objectModel.availableAnimations=r.map(n=>({label:n,value:n})),this.objectModel.currentAnimation=r[0],this.$nextTick(()=>{this.playModel()})):(this.objectModel.availableAnimations=[],this.objectModel.currentAnimation=null)},onPreviewChanged({entity:r,previewFile:n,previousPreviewFileId:h}){n&&(this.$options.silent||(this.currentPreviewIndex=0,this.changePreviewFile(r,n,h),this.updateRoomStatus(h)))},changePreviewFile(r,n,h){this.pause();const d=this.entityList.find(f=>f.id===r.id&&f.preview_file_id===h);d&&(d.preview_file_id=n.id,d.preview_file_task_id=n.task_id,d.preview_file_extension=n.extension,d.preview_file_annotations=n.annotations,d.preview_file_width=n.width,d.preview_file_height=n.height,d.preview_file_duration=n.duration,d.preview_file_previews=n.previews,d.preview_file_revision=n.revision,this.rawPlayer&&(this.rawPlayer.getCurrentTimeRaw()<.1?this.rawPlayer.loadEntity(this.playingEntityIndex,0):this.rawPlayer.reloadCurrentEntity()),this.$emit("preview-changed",{entity:r,previewFileId:n.id,previousPreviewFileId:h}),this.clearCanvas(),this.updateTaskPanel())},onEntityDropped(r){const n=this.$refs["playlisted-entities"],h=n.scrollLeft,d=this.findEntity(r.after);if(!d)this.$emit("new-entity-dropped",r);else{const f=this.findEntityIndex(r.after);let g=this.findEntityIndex(r.before);f>g&&(g+=1),this.$options.silent=!0,this.moveSelectedEntity(d,f,g),this.$nextTick(()=>{n.scrollLeft=h,setTimeout(()=>{this.$options.silent=!1},500)}),this.$emit("order-change",r)}},findEntity(r){const n=r.entity_id,h=r.preview_file_id;return this.entityList.find(d=>d.id===n&&d.preview_file_id===h)},findEntityIndex(r){const n=r.entity_id,h=r.preview_file_id;return this.entityList.findIndex(d=>d.id===n&&d.preview_file_id===h)},moveSelectedEntityToLeft(){const r=this.playingEntityIndex,n=this.previousEntityIndex,h=this.currentEntity;this.moveSelectedEntity(h,r,n);const d={before:{entity_id:this.entityList[n].id,preview_file_id:this.entityList[n].preview_file_id},after:{entity_id:this.entityList[r].id,preview_file_id:this.entityList[r].preview_file_id}};this.$emit("order-change",d)},moveSelectedEntityToRight(){const r=this.playingEntityIndex,n=this.nextEntityIndex,h=this.currentEntity;this.moveSelectedEntity(h,r,n);const d={before:{entity_id:this.entityList[r].id,preview_file_id:this.entityList[r].preview_file_id},after:{entity_id:this.entityList[n].id,preview_file_id:this.entityList[n].preview_file_id}};this.$emit("order-change",d)},moveSelectedEntity(r,n,h){if(this.currentEntity&&this.playingEntityIndex>=0&&n>=0&&h>=0){const d=[...this.entityList];d.splice(n,1),d.splice(h,0,r),this.entityList=[],this.$nextTick(()=>{this.entityList=d,this.$nextTick(()=>{this.playingEntityIndex=h,this.scrollToEntity(this.playingEntityIndex)})})}},resetHeight(){this.$nextTick(()=>{let r=window.innerHeight-90;this.tempMode||(r=this.container?this.container.offsetHeight:0),r-=this.$refs.header?this.$refs.header.offsetHeight:0,this.$refs["button-bar"]&&(r-=this.$refs["button-bar"].offsetHeight),this.$refs["playlisted-entities"]&&(r-=this.$refs["playlisted-entities"].offsetHeight),this.$refs["video-progress"]&&(r-=this.$refs["video-progress"].$el.offsetHeight),this.$refs["playlist-progress"]&&(r-=this.$refs["playlist-progress"].$el.offsetHeight),this.isWaveformDisplayed&&(r-=60),this.$refs["video-container"]&&(this.$refs["video-container"].style.height=`${r}px`),this.$refs["task-info"]&&!this.isCommentsHidden&&(this.$refs["task-info"].$el.style.height=`${r}px`),this.$refs["picture-preview-wrapper"]&&(this.$refs["picture-preview-wrapper"].style.height=`${r}px`),this.$refs["full-playlist-player"]&&(this.$refs["full-playlist-player"].style.height=`${r}px`),this.pictureDefaultHeight=r,this.rawPlayer&&this.rawPlayer.resetHeight(r),this.isComparing&&this.$refs["raw-player-comparison"]&&this.$refs["raw-player-comparison"].resetHeight(r),this.$nextTick(()=>{this.resetCanvas(),this.updateProgressBar()})})},getComparisonTaskTypeOptions(){return Object.keys(this.currentEntity.preview_files).filter(h=>!!this.currentEntity.preview_files[h]).map(h=>({label:this.taskTypeMap.get(h).name,value:this.taskTypeMap.get(h).id})).sort((h,d)=>-h.label.localeCompare(d.label,void 0,{numeric:!0}))},isComparisonTaskTypeAvailable(){return this.taskTypeOptions.findIndex(r=>r.value===this.savedTaskTypeToCompare)!==-1},rebuildComparisonOptions(){this.comparisonEntityMissing=!1,this.entityList.length>0?(this.taskTypeOptions=this.getComparisonTaskTypeOptions(),this.taskTypeOptions.length>0&&(this.isComparisonTaskTypeAvailable()?this.taskTypeToCompare=this.savedTaskTypeToCompare:(this.taskTypeToCompare=this.taskTypeOptions[0].value,this.comparisonEntityMissing=!0)),this.rebuildRevisionOptions()):(this.taskTypeOptions=[],this.revisionOptions=[])},rebuildRevisionOptions(){if(this.currentEntity&&this.currentEntity.preview_files[this.taskTypeToCompare]){const r=this.currentEntity.preview_files[this.taskTypeToCompare].map(n=>n.revision);this.revisionOptions=[{label:"Last",value:null}].concat(r.sort((n,h)=>h-n).map(n=>({label:`v${n}`,value:`${n}`}))),this.revisionOptions.length>0&&(this.revisionToCompare=this.revisionOptions[0].value)}else this.revisionOptions=[]},rebuildEntityListToCompare(){this.taskTypeToCompare?this.entityListToCompare=this.entityList.map(r=>{if(!r.preview_files||r.preview_files==={})return{preview_file_id:"",preview_file_extension:"none"};let n=r.preview_files[this.taskTypeToCompare],h=this.taskTypeToCompare;if(n||(h=Object.keys(r.preview_files)[0],n=r.preview_files[h]),!n)return null;let d=n.find(f=>`${f.revision}`===this.revisionToCompare);return d||(d=r.preview_files[h][0]),{preview_file_id:d.id,preview_file_extension:d.extension}}):this.buildEntityListToCompare=[]},resetComparison(){this.rebuildRevisionOptions(),this.$nextTick(()=>{this.rawPlayerComparison.loadEntity(this.playingEntityIndex),this.$nextTick(()=>{setTimeout(()=>{this.syncComparisonPlayer()},100),this.isPlaying&&this.play()})})},toggleDlButtons(){this.isDlButtonsHidden=!this.isDlButtonsHidden},onPictureLoaded(){this.$nextTick(async()=>{this.resetCanvasSize();const r=this.isPlaying;await this.resetPictureCanvas(),this.isPlaying=r})},onObjectBackgroundSelected(){this.objectBackgroundUrl=this.currentBackground?.url;const r=!!this.objectBackgroundUrl;this.isObjectBackground=r,this.isEnvironmentSkybox=r},isDefaultBackground(r){const n=this.currentProduction.default_preview_background_file_id;return n?r.id===n:r.is_default},onBuildClicked(){this.runBuild(!1)},onBuildFullClicked(){this.runBuild(!0)},runBuild(r=!1){(this.isCurrentUserManager||this.isCurrentUserSupervisor)&&!this.isJobRunning&&!this.isBuildLaunched&&(this.isBuildLaunched=!0,this.runPlaylistBuild({playlist:this.playlist,full:r}).then(()=>{this.isBuildLaunched=!1}).catch(console.error))},playBuild(r){this.isFullMode=!0;const n=this.getBuildPath(r);this.$options.fullPlayingPath!==n&&(this.$options.fullPlayingPath=n,this.fullPlayer.src=n,this.fullPlayer.currentTime=0,this.setPlaylistProgress(0))},setPlaylistProgress(r){this.playlistProgress=r;const n=Math.round(this.playlistProgress*this.fps);if(this.playlistShotPosition[n]){const h=this.playlistShotPosition[n].index;h!==this.playingEntityIndex&&h&&this.playEntity(h)}},onRemoveBuildJob(r){r.playlist_id=this.playlist.id,this.removeBuildJob(r)},showTaskTypeModal(){this.modals.taskType=!0},hideTaskTypeModal(){this.modals.taskType=!1},confirmChangeTaskType(r){this.$emit("task-type-changed",r),this.modals.taskType=!1},configureFullPlayer(){this.fullPlayer&&(this.fullPlayer.addEventListener("loadedmetadata",()=>{this.playlistDuration=this.entityList.reduce((r,n)=>r+n.preview_file_duration,0)}),this.fullPlayer.addEventListener("ended",()=>{this.pause()}))},onPreviousPreviewClicked(){const r=this.currentPreviewIndex-1;this.currentPreviewIndex=r<0?this.currentEntityPreviewLength-1:r,this.updateRoomStatus()},onNextPreviewClicked(){const r=this.currentPreviewIndex+1;this.currentPreviewIndex=r>this.currentEntityPreviewLength-1?0:r,this.updateRoomStatus()},onPreviousComparisonPictureClicked(){const r=this.currentComparisonPreviewIndex-1;this.currentComparisonPreviewIndex=r<0?this.currentComparisonPreviewLength-1:r,this.updateRoomStatus()},onNextComparisonPictureClicked(){const r=this.currentComparisonPreviewIndex+1;this.currentComparisonPreviewIndex=r>this.currentComparisonPreviewLength-1?0:r,this.updateRoomStatus()},onTaskTypeToCompareChanged(){this.saveUserComparisonChoice(),this.rebuildEntityListToCompare(),this.updateRoomStatus()},onRevisionToCompareChanged(){this.isComparing&&this.$nextTick(()=>{this.rebuildEntityListToCompare(),this.$nextTick(()=>{this.pause(),this.rawPlayerComparison.loadEntity(this.playingEntityIndex),this.rawPlayerComparison.setCurrentTimeRaw(this.currentTimeRaw),this.updateRoomStatus()})})},onEntitiesWheel(r){!r.deltaX&&(r.preventDefault(),this.$refs["playlisted-entities"].scrollLeft+=r.deltaY)},onProgressPlaylistChanged(r){if(this.isFullMode){const f=r/this.fps;this.fullPlayer.currentTime=f,this.playlistProgress=f}const{index:n,start:h}=this.playlistShotPosition[r],d=(r/this.fps-h)*this.fps+1;n!==this.playingEntityIndex?this.$nextTick(()=>{this.playEntity(n,!1,d),this.onFrameUpdate(d)}):this.isPlayingPicture?this.framesSeenOfPicture=d+1:this.setCurrentTimeRaw(d/this.fps)},saveUserComparisonChoice(){this.savedTaskTypeToCompare=this.taskTypeToCompare,this.sendUpdatePlayingStatus()},configureWaveForm(){if(document.getElementById("waveform"))try{this.wavesurfer=Ye.create({container:"#waveform",waveColor:"#00B242",progressColor:"#008732",backend:"MediaElement",mediaType:"video",height:60,fillParent:!0,minPxPerSec:1}),this.wavesurfer.on("error",n=>{console.error("Error loading audio:",n)}),this.wavesurfer.on("seeking",this.onWaveformSeeking)}catch(n){console.error(n)}},onWaveformSeeking(r){!this.$options.isWaveformSeekingSilent&&!this.isPlaying&&(this.$options.isWaveformSeekingSilent=!0,this.setCurrentTimeRaw(r),setTimeout(()=>{this.$options.isWaveformSeekingSilent=!1},500))},loadWaveForm(){if(this.isWaveformDisplayed&&this.isCurrentPreviewMovie){if(this.rawPlayer?.currentPlayer?.src)try{this.wavesurfer&&this.wavesurfer.destroy(),this.configureWaveForm(),setTimeout(()=>{this.wavesurfer.load(this.rawPlayer.currentPlayer.src)},100)}catch(r){console.error("Error loading waveform:",r)}}else this.wavesurfer&&this.wavesurfer.destroy()},updateProgressBar(r){const n=r||this.frameNumber;this.progress&&this.progress.updateProgressBar(n+1),this.playlistDuration&&!this.isFullMode&&this.currentEntity&&(this.playlistProgress=this.currentEntity.start_duration+n/this.fps)},resetHandles(r){if(this.playlist.for_entity==="shot"){r=r||this.currentEntity;const n=this.shotMap.get(r?.id);this.handleIn=n?.data?.handle_in||0,this.handleOut=n?.data?.handle_out||this.nbFrames}},resetPlaylistFrameData(){let r=0,n=0;return this.entityList.forEach((h,d)=>{const f=h.preview_nb_frames||2*this.fps*this.frameDuration;this.framesPerImage[d]=f;const g=Math.round((h.preview_file_duration||0)*this.fps)||f;h.start_duration=(n+1)/this.fps;for(let x=0;x<g;x++)this.playlistShotPosition[n+x]={index:d,name:h.name,extension:h.preview_file_extension,start:h.start_duration,width:h.preview_file_width,height:h.preview_file_height,id:h.preview_file_id};n+=g,r+=g/this.fps;const w=h.preview_file_task_id,C=this.taskMap.get(w);if(C){const x=this.taskStatusMap.get(C.task_status_id);h.task_status_color=x.color}}),this.playlistDuration=r,r},onRawPlayerFrameUpdate(r){this.isFullMode||this.onFrameUpdate(r)},onEntityDragStart(r,n){r.dataTransfer.setData("entityId",n.id),r.dataTransfer.setData("previewFileId",n.preview_file_id)},onPanZoomClicked(){this.isZoomEnabled?(this.isZoomEnabled=!1,this.isAnnotationsDisplayed=!0):(this.isDrawing=!1,this.isAnnotationsDisplayed=!1,this.isZoomEnabled=!0)},resumePanZoom(){this.isCurrentPreviewMovie?this.rawPlayer.resumePanZoom():this.isCurrentPreviewPicture&&this.picturePlayer.resumePanZoom()},pausePanZoom(){this.isCurrentPreviewMovie?this.rawPlayer.pausePanZoom():this.isCurrentPreviewPicture&&this.picturePlayer.pausePanZoom()},resetPanZoom(){this.isCurrentPreviewMovie?this.rawPlayer.resetPanZoom():this.isCurrentPreviewPicture&&this.picturePlayer.resetPanZoom()},setPanZoom(r,n,h){this.isCurrentPreviewMovie?this.rawPlayer.setPanZoom(r,n,h):this.isCurrentPreviewPicture&&this.picturePlayer.setPanZoom(r,n,h)},setComparisonPanZoom(r,n,h){this.isCurrentPreviewMovie?this.rawPlayerComparison.setPanZoom(r,n,h):this.isCurrentPreviewPicture&&this.picturePlayerComparison.setPanZoom(r,n,h)},onPanZoomChanged({x:r,y:n,scale:h}){this.postPanZoomChanged(r,n,h)},onComparisonPanZoomChanged({x:r,y:n,scale:h}){this.postComparisonPanZoomChanged(r,n,h)},resetPlaylist(){this.currentPreviewIndex=0,this.currentComparisonPreviewIndex=0,this.entityList=this.entities,this.resetPlaylistFrameData(),this.playingEntityIndex=0,this.pause(),this.rawPlayer&&this.rawPlayer.setCurrentFrame(0),this.currentTimeRaw=0,this.updateProgressBar(),this.updateTaskPanel(),this.rebuildComparisonOptions(),this.clearCanvas(),this.annotations=[],this.movieDimensions={width:0,height:0},this.isComparing=!1,this.entityList.length===0&&this.clearPlayer(),this.resetHeight(),this.resetCanvas().then(()=>{this.currentPreview!==null&&(this.resetHandles(),this.movieDimensions={width:this.currentPreview.width,height:this.currentPreview.height},this.annotations=this.currentEntity.preview_file_annotations,this.loadAnnotation(this.getAnnotation(0)))}),this.rawPlayer.setVolume(this.volume)}},watch:{isAnnotationsDisplayed(){this.$options.isRoomSilent=!0,this.isAnnotationsDisplayed&&this.isZoomEnabled&&(this.isZoomEnabled=!1),this.isAnnotationsDisplayed||(this.isDrawing?this.onAnnotateClicked():this.isTyping&&this.onTypeClicked()),this.$options.isRoomSilent=!1,this.resetCanvasVisibility(),this.$options.isRoomSilent||this.updateRoomStatus()},isDrawing(){this.isDrawing&&this.isZoomEnabled&&(this.isZoomEnabled=!1),!this.isDrawing&&this.isLaserModeOn&&(this.isLaserModeOn=!1),this.isDrawing&&!this.isAnnotationsDisplayed&&(this.isAnnotationsDisplayed=!0)},isTyping(){this.isTyping&&this.isZoomEnabled&&(this.isZoomEnabled=!1),this.isAnnotationsDisplayed||(this.isAnnotationsDisplayed=!0)},isZoomEnabled(){this.isZoomEnabled?(this.resumePanZoom(),this.silentRoom=!0,this.isDrawing?this.onAnnotateClicked():this.isTyping&&this.onTypeClicked(),this.$nextTick(()=>{this.isAnnotationsDisplayed&&(this.isAnnotationsDisplayed=!1),this.resetCanvasVisibility()}),this.silentRoom=!1):(this.pausePanZoom(),this.resetPanZoom()),this.$nextTick(()=>{this.updateRoomStatus()})},"objectModel.currentAnimation"(){this.isCurrentPreviewModel&&this.objectModel.isAnimation&&this.playModel()},framesSeenOfPicture(){this.isCurrentPreviewPicture&&this.updateProgressBar(this.framesSeenOfPicture-1)},isLoading(){this.isLoading||this.resetHeight()},currentPreviewIndex(){this.endAnnotationSaving(),this.resetUndoStacks(),this.resetHeight(),this.$nextTick(()=>{this.isCurrentPreviewPicture?this.resetPictureCanvas():this.resetCanvas()}),this.currentPreview&&(this.resetPanZoom(),this.movieDimensions={width:this.currentPreview.width,height:this.currentPreview.height})},playingEntityIndex(){this.endAnnotationSaving(),this.updateTaskPanel(),this.resetUndoStacks(),this.currentPreviewIndex=0,this.currentComparisonPreviewIndex=0,this.isCurrentPreviewMovie?this.$nextTick(()=>{this.loadWaveForm(),this.isPlaying&&this.play()}):this.wavesurfer&&this.isWaveformDisplayed&&this.wavesurfer.destroy(),this.currentEntity&&(this.annotations=this.currentEntity.preview_file_annotations||[],this.movieDimensions={width:this.currentPreview.width,height:this.currentPreview.height}),this.$nextTick(()=>{this.isComparing&&(this.rebuildComparisonOptions(),this.rebuildRevisionOptions()),this.$nextTick(()=>{this.isCurrentPreviewPicture&&!this.isPlaying?(this.triggerResize(),this.resetHeight(),this.resetPictureCanvas()):this.resetCanvas(),this.resetPanZoom(),this.resetCanvasVisibility()})})},fullScreen(){this.resetHeight(),setTimeout(()=>{this.isCurrentPreviewPicture&&(this.triggerResize(),this.resetHeight(),this.resetPictureCanvas())},300)},isComparing(){this.isComparing&&(this.pause(),this.resetComparison(),this.rebuildEntityListToCompare(),this.rebuildComparisonOptions()),this.$nextTick().then(()=>{this.triggerResize(),this.resetPictureCanvas(),this.resetCanvas(),this.syncComparisonPlayer()})},taskTypeToCompare(){this.isComparing&&this.resetComparison()},entities(r,n){(!this.oldEntities||this.oldEntities.length===0)&&this.resetPlaylist()},playlist(r,n){n&&(this.room&&this.room.people.includes(this.user.id)&&this.leaveRoom(),this.closeRoom(n.id)),this.endAnnotationSaving(),this.room.id=this.playlist.id,this.room.localId=os(),this.openRoom(r.id),this.forClient=(!!this.playlist.for_client).toString(),this.$nextTick(()=>{this.updateProgressBar(),this.clearCanvas(),this.$nextTick(()=>{this.currentPreview&&(this.movieDimensions={width:this.currentPreview.width,height:this.currentPreview.height})})})},isAddingEntity(){this.$nextTick(()=>{this.updateProgressBar()})},isEntitiesHidden(){this.$nextTick(()=>{setTimeout(()=>{this.triggerResize()},300)})},isComparisonOverlay(){this.$nextTick(()=>{this.resetCanvas().then(this.reloadCurrentAnnotation)})},isWaveformDisplayed(){this.isWaveformDisplayed&&(this.resetHeight(),this.loadWaveForm()),this.$nextTick(()=>{this.updateRoomStatus()})},isLaserModeOn(){!this.isDrawing&&this.isLaserModeOn&&this.onAnnotateClicked(),this.updateRoomStatus()},isFullMode(){this.isComparing=!1,this.isFullMode?this.$nextTick(()=>{this.playEntity(0)}):(this.$options.fullPlayingPath="",this.onFrameUpdate(0))},volume(){this.rawPlayer.setVolume(this.volume),ye.setPreference("player:volume",this.volume)}},socket:{events:{...yo.socket.events,...vo.socket.events}}},Yd={key:0,ref:"header",class:"playlist-header flexrow"},Ud={key:0,class:"flexrow-item for-client"},Gd={class:"flexrow-item playlist-name"},qd=["title"],Kd=["title"],Zd={class:"flexrow filler"},Jd=["src"],Qd={class:"picture-preview"},tf={style:{width:"100%"},class:"preview-standard-file has-text-centered"},ef=["href"],sf={class:"text"},rf={key:2,class:"loading-wrapper"},nf={class:"canvas-wrapper",ref:"canvas-wrapper",oncontextmenu:"return false"},of={id:"playlist-annotation-canvas",ref:"annotation-canvas",class:"canvas"},af={key:1,ref:"button-bar",class:"playlist-footer flexrow"},lf={key:0,class:"flexrow flexrow-item comparison-buttons"},hf=["title"],cf=["title"],uf={key:1,class:"flexrow flexrow-item mr0"},df={key:2,class:"flexrow flexrow-item mr0"},ff=["title"],pf=["title"],gf=["title"],mf={class:"is-hidden-touch is-hidden-desktop-only"},yf=["title"],vf=["title"],wf=["href","title"],Cf={key:0,class:"separator"},bf={key:5,class:"flexrow flexrow-item mr0"},_f={key:6,class:"separator"},xf={key:8,class:"flexrow flexrow-item comparison-buttons"},Pf={class:"flexrow comparison-combos"},Sf={key:3,class:"flexrow flexrow-item comparison-list"},Tf={class:"flexrow-item comparison-index"},kf={key:4,class:"flexrow flexrow-item comparison-missing"},Of={key:9,class:"flexrow"},Ef={key:11,class:"flexrow"},Df={key:0,class:"separator"},Mf={class:"annotation-tools"},Af={class:"annotation-tools"},Ff={key:12,class:"flexrow-item playlist-button",style:{position:"relative"}},Lf=["href"],Rf=["href"],jf={key:0},If={key:1},Bf={class:"build-title"},Wf={key:1},Hf={key:2},$f=["onClick"],zf=["href"],Vf=["onClick"],Nf={id:"annotation-snapshot",ref:"annotation-snapshot"},Xf={id:"resize-annotation-canvas",ref:"resize-annotation-canvas"};function Yf(r,n,h,d,f,g){const w=G("button-simple"),C=G("preview-room"),x=G("raw-video-player"),P=G("picture-viewer"),E=G("object-viewer"),D=G("sound-viewer"),W=G("pdf-viewer"),N=G("download-icon"),q=G("multi-picture-viewer"),Y=G("spinner"),nt=G("task-info"),Et=G("video-progress"),mt=G("combobox-styled"),bt=G("arrow-up-right-icon"),yt=G("speed-button"),ht=G("button-sound"),Q=G("combobox"),ut=G("globe-icon"),vt=G("color-picker"),wt=G("pencil-picker"),at=G("play-icon"),$t=G("playlist-progress"),Xt=G("playlisted-entity"),ie=G("notify-client-modal"),Me=G("delete-modal"),ae=G("select-task-type-modal");return M(),R("div",{ref:"container",class:St({dark:!0,"full-height":!h.isAddingEntity||h.isLoading,"playlist-player":!0})},[h.tempMode?V("",!0):(M(),R("div",Yd,[h.playlist&&h.playlist.for_client&&!r.isCurrentUserClient?(M(),R("div",Ud,U(r.$t("playlists.client_playlist")),1)):V("",!0),L("span",Gd,U(h.playlist.name||""),1),L("span",{class:"flexrow-item time-indicator",title:r.$t("playlists.actions.entity_index")},U(r.entityList.length>0?r.playingEntityIndex+1:0),9,qd),n[27]||(n[27]=L("span",{class:"flexrow-item time-indicator"}," / ",-1)),L("span",{class:"flexrow-item time-indicator mr1",title:r.$t("playlists.actions.entities_number")},U(r.entityList.length),9,Kd),f.isFullMode?V("",!0):(M(),et(w,{key:1,class:"button playlist-button flexrow-item",icon:"back",title:r.$t("playlists.actions.previous_shot"),onClick:g.onPlayPreviousEntityClicked},null,8,["title","onClick"])),f.isFullMode?V("",!0):(M(),et(w,{key:2,class:"playlist-button flexrow-item",icon:"forward",title:r.$t("playlists.actions.next_shot"),onClick:g.onPlayNextEntityClicked},null,8,["title","onClick"])),n[28]||(n[28]=L("div",{class:"filler"},null,-1)),f.isFullMode?(M(),et(w,{key:3,class:"playlist-button topbar-button flexrow-item",text:r.$t("playlists.actions.exit_play_full"),title:r.$t("playlists.actions.exit_play_full"),onClick:n[0]||(n[0]=z=>f.isFullMode=!1)},null,8,["text","title"])):V("",!0),r.isValidRoomId(h.playlist)&&!f.isFullMode?(M(),et(C,{key:4,room:f.room,onOpenRoom:r.openRoom,onJoinRoom:r.joinRoom,onLeaveRoom:r.leaveRoom},null,8,["room","onOpenRoom","onJoinRoom","onLeaveRoom"])):V("",!0),!h.isLoading&&r.isCurrentUserManager&&h.playlist.for_client?(M(),et(w,{key:5,class:"playlist-button topbar-button flexrow-item full-button",icon:"bell",text:r.$t("playlists.notify_clients"),onClick:g.onNotifyClientsClicked},null,8,["text","onClick"])):V("",!0),g.isAllowToEdit?(M(),R(Ht,{key:6},[h.isLoading?V("",!0):(M(),et(w,{key:0,class:"playlist-button topbar-button flexrow-item full-button",icon:"plus",text:g.addEntitiesText,onClick:n[1]||(n[1]=z=>r.$emit("show-add-entities")),active:h.isAddingEntity||f.isFullMode},null,8,["text","active"])),H(w,{onClick:n[2]||(n[2]=z=>r.$emit("edit-clicked")),class:"edit-button playlist-button flexrow-item",title:r.$t("playlists.actions.edit"),icon:"edit"},null,8,["title"]),H(w,{onClick:g.showDeleteModal,class:"delete-button playlist-button flexrow-item",title:r.$t("playlists.actions.delete"),icon:"trash"},null,8,["onClick","title"])],64)):V("",!0)],512)),st(L("div",Zd,[L("div",{class:St({filler:!0,flexrow:!0,"video-container":!0,"flexrow-reverse":!r.isComparisonOverlay}),ref:"video-container"},[st(L("video",{ref:"full-playlist-player",class:"raw-player",style:lt({position:r.isComparisonOverlay?"absolute":"relative"})},null,4),[[rt,f.isFullMode]]),st(H(x,{ref:"raw-player-comparison",class:"raw-player",name:"comparison",style:lt({position:r.isComparisonOverlay?"absolute":"relative"}),entities:r.entityListToCompare,"full-screen":r.fullScreen,"is-hd":r.isHd,"is-repeating":r.isRepeating,muted:!0,"handle-in":h.playlist.for_entity==="shot"?f.handleIn:-1,"handle-out":h.playlist.for_entity==="shot"?f.handleOut:-1},null,8,["style","entities","full-screen","is-hd","is-repeating","handle-in","handle-out"]),[[rt,r.isComparing&&r.isCurrentPreviewMovie&&g.isMovieComparison&&!f.isFullMode&&!h.isLoading]]),st(L("div",{class:"picture-preview-comparison-wrapper",style:lt({position:r.isComparisonOverlay?"absolute":"static",left:0,right:0})},[st(H(P,{ref:"picture-player-comparison",class:"picture-preview",big:!0,"default-height":f.pictureDefaultHeight,"full-screen":r.fullScreen,light:!1,"margin-bottom":0,panzoom:!0,preview:g.currentPreviewToCompare,"is-comparing":r.isComparing,onPanzoomChanged:g.onComparisonPanZoomChanged,onLoaded:g.onPictureLoaded,"high-quality":""},null,8,["default-height","full-screen","preview","is-comparing","onPanzoomChanged","onLoaded"]),[[rt,r.isComparing&&g.isPictureComparison]]),r.isComparing&&g.isMovieComparison?(M(),R("video",{key:0,ref:"picture-video-player-comparison",class:"picture-preview",src:r.currentComparisonPreviewPath,onPanzoomChanged:n[3]||(n[3]=(...z)=>g.onComparisonPanZoomChanged&&g.onComparisonPanZoomChanged(...z)),controls:"",loop:"",muted:""},null,40,Jd)):V("",!0),st(L("span",Qd," It's not a picture preview ",512),[[rt,r.isComparing&&!g.isPictureComparison&&!g.isMovieComparison]])],4),[[rt,r.isComparing&&!h.isLoading&&!r.isCurrentPreviewFile&&(r.isCurrentPreviewMovie&&!g.isMovieComparison||!r.isCurrentPreviewMovie)]]),st(H(x,{ref:"raw-player",class:"raw-player",style:lt({position:r.isComparisonOverlay?"absolute":"relative",opacity:r.overlayOpacity}),entities:r.entityList,"full-screen":r.fullScreen,"is-hd":r.isHd,"is-repeating":r.isRepeating,"current-preview-index":r.currentPreviewIndex,muted:r.isMuted,panzoom:!0,onEntityChange:g.onPlayerPlayingEntityChange,onFrameUpdate:g.onRawPlayerFrameUpdate,onMaxDurationUpdate:r.onMaxDurationUpdate,onMetadataLoaded:r.onMetadataLoaded,onPanzoomChanged:g.onPanZoomChanged,onPlayNext:g.onPlayNext,onRepeat:r.onVideoRepeated,onVideoLoaded:g.onVideoLoaded},null,8,["style","entities","full-screen","is-hd","is-repeating","current-preview-index","muted","onEntityChange","onFrameUpdate","onMaxDurationUpdate","onMetadataLoaded","onPanzoomChanged","onPlayNext","onRepeat","onVideoLoaded"]),[[rt,r.isCurrentPreviewMovie&&!f.isFullMode&&!h.isLoading]]),st(H(E,{ref:"object-player",class:"object-player","background-url":g.backgroundUrl,"full-screen":r.fullScreen,"is-environment-skybox":f.isEnvironmentSkybox,"is-wireframe":f.isWireframe,"preview-url":r.isCurrentPreviewModel?r.currentPreviewDlPath:null,style:lt({position:r.isComparisonOverlay?"absolute":"static",opacity:r.overlayOpacity}),onModelLoaded:g.onModelLoaded},null,8,["background-url","full-screen","is-environment-skybox","is-wireframe","preview-url","style","onModelLoaded"]),[[rt,r.isCurrentPreviewModel&&!h.isLoading]]),r.isCurrentPreviewSound&&!h.isLoading?(M(),et(D,{key:0,ref:"sound-player",class:"sound-player","preview-url":r.currentPreviewDlPath,"full-screen":r.fullScreen,onPlayEnded:r.pause},null,8,["preview-url","full-screen","onPlayEnded"])):V("",!0),r.isCurrentPreviewPdf&&!h.isLoading?(M(),et(W,{key:1,ref:"pdf-player",preview:r.currentPreview,"default-height":f.pictureDefaultHeight},null,8,["preview","default-height"])):V("",!0),st(L("p",tf,[r.extension&&r.extension.length>0?(M(),R("a",{key:0,class:"button",ref:"preview-file",href:r.currentPreviewDlPath},[H(N,{class:"icon"}),L("span",sf,U(r.$t("tasks.download_pdf_file",{extension:r.extension})),1)],8,ef)):V("",!0)],512),[[rt,r.isCurrentPreviewFile&&!h.isLoading]]),st(L("div",{class:"picture-preview-wrapper flexrow",ref:"picture-player-wrapper",style:lt({position:r.isComparisonOverlay?"absolute":"static",opacity:r.overlayOpacity,left:0,right:0,"z-index":1})},[H(q,{ref:"picture-player",big:!0,"default-height":f.pictureDefaultHeight,"full-screen":r.fullScreen,light:!1,"margin-bottom":0,panzoom:!0,"current-preview":{...r.currentPreview,position:r.currentPreviewIndex+1},previews:g.picturePreviews,onPanzoomChanged:g.onPanZoomChanged,"high-qualiy":""},null,8,["default-height","full-screen","current-preview","previews","onPanzoomChanged"])],4),[[rt,r.isCurrentPreviewPicture&&!h.isLoading]]),h.isLoading?(M(),R("div",rf,[H(Y)])):V("",!0),st(L("div",nf,[L("canvas",of,null,512)],512),[[rt,!r.isCurrentPreviewFile&&f.isAnnotationsDisplayed&&!r.isCurrentPreviewModel]])],2),st(H(nt,{ref:"task-info",class:"flexrow-item task-info-column","current-frame":parseInt(r.currentFrame)-1,"current-parent-preview":r.currentPreview,fps:r.fps,extendable:!1,"is-preview":!1,silent:r.isCommentsHidden,task:r.task,player:this,"show-assignees":r.isCurrentUserManager||r.isCurrentUserSupervisor,onTimeCodeClicked:r.onTimeCodeClicked},null,8,["current-frame","current-parent-preview","fps","silent","task","show-assignees","onTimeCodeClicked"]),[[rt,!r.isCommentsHidden]])],512),[[rt,!h.isAddingEntity||h.isLoading]]),st(H(Et,{ref:"video-progress",class:"video-progress pull-bottom",annotations:r.annotations,empty:!r.isCurrentPreviewMovie,"frame-duration":r.frameDuration,"is-full-mode":f.isFullMode,"is-full-screen":r.fullScreen||r.isEntitiesHidden,"movie-dimensions":f.movieDimensions,"nb-frames":r.isCurrentPreviewMovie?r.nbFrames:r.isCurrentPreviewPicture&&r.currentEntity.preview_nb_frames?r.currentEntity.preview_nb_frames:Math.round(2*r.fps),"handle-in":h.playlist.for_entity==="shot"?f.handleIn:-1,"handle-out":h.playlist.for_entity==="shot"?f.handleOut:-1,"preview-id":r.currentPreview?r.currentPreview.id:"",onStartScrub:r.onScrubStart,onEndScrub:r.onScrubEnd,onProgressChanged:r.onProgressChanged,onHandleInChanged:r.onHandleInChanged,onHandleOutChanged:r.onHandleOutChanged},null,8,["annotations","empty","frame-duration","is-full-mode","is-full-screen","movie-dimensions","nb-frames","handle-in","handle-out","preview-id","onStartScrub","onEndScrub","onProgressChanged","onHandleInChanged","onHandleOutChanged"]),[[rt,h.playlist.id&&!h.isAddingEntity]]),st(L("div",{id:"sound-container",style:lt({height:f.isWaveformDisplayed?"60px":"0px",width:"100%"})},n[29]||(n[29]=[L("div",{id:"waveform"},null,-1)]),4),[[rt,f.isWaveformDisplayed]]),h.playlist.id&&!h.isAddingEntity?(M(),R("div",af,[h.tempMode?(M(),R("div",lf,[L("span",{class:"flexrow-item time-indicator",title:r.$t("playlists.actions.entity_index")},U(r.entityList.length>0?r.playingEntityIndex+1:0),9,hf),n[30]||(n[30]=L("span",{class:"flexrow-item time-indicator"}," / ",-1)),L("span",{class:"flexrow-item time-indicator mr1",title:r.$t("playlists.actions.entities_number")},U(r.entityList.length),9,cf),H(w,{class:"button playlist-button flexrow-item",onClick:g.onPlayPreviousEntityClicked,title:r.$t("playlists.actions.previous_shot"),icon:"back"},null,8,["onClick","title"]),H(w,{class:"playlist-button flexrow-item",onClick:g.onPlayNextEntityClicked,title:r.$t("playlists.actions.next_shot"),icon:"forward"},null,8,["onClick","title"])])):V("",!0),r.isCurrentPreviewMovie||r.isCurrentPreviewPicture||r.isCurrentPreviewSound||r.isCurrentPreviewModel?(M(),R("div",uf,[r.isPlaying?(M(),et(w,{key:1,class:"button playlist-button flexrow-item",onClick:r.pauseClicked,title:r.$t("playlists.actions.pause"),icon:"pause"},null,8,["onClick","title"])):(M(),et(w,{key:0,class:"button playlist-button flexrow-item",onClick:r.playClicked,title:r.$t("playlists.actions.play"),icon:"play"},null,8,["onClick","title"])),f.objectModel.isAnimation?(M(),et(mt,{key:2,class:"flexrow-item",options:f.objectModel.availableAnimations,"is-dark":!0,thin:!0,"is-reversed":"",modelValue:f.objectModel.currentAnimation,"onUpdate:modelValue":n[4]||(n[4]=z=>f.objectModel.currentAnimation=z)},null,8,["options","modelValue"])):V("",!0)])):V("",!0),r.isCurrentPreviewMovie&&!f.isFullMode?(M(),R("div",df,[L("span",{class:"flexrow-item time-indicator",title:r.$t("playlists.actions.current_time")},U(r.currentTime),9,ff),n[32]||(n[32]=L("span",{class:"flexrow-item time-indicator is-hidden-touch is-hidden-desktop-only"}," / ",-1)),L("span",{class:"flexrow-item time-indicator is-hidden-touch is-hidden-desktop-only",title:r.$t("playlists.actions.max_duration")},U(r.maxDuration),9,pf),L("span",{class:"flexrow-item time-indicator mr05 nowrap",title:r.$t("playlists.actions.frame_number")},[as(" ("+U(r.currentFrame)+" ",1),L("span",mf," / "+U((r.nbFrames+"").padStart(3,"0")),1),n[31]||(n[31]=as(") "))],8,gf)])):V("",!0),n[35]||(n[35]=L("div",{class:"separator"},null,-1)),r.isCurrentPreviewPicture?(M(),R("div",{key:3,class:"flexrow-item",title:r.$t("playlists.actions.frame_number")},U((r.framesSeenOfPicture+"").padStart(2,"0"))+" / "+U(r.currentEntity.preview_nb_frames?r.currentEntity.preview_nb_frames:Math.round(2*r.fps)),9,yf)):V("",!0),r.currentEntityPreviewLength>1?(M(),R("div",{key:4,class:St(["flexrow flexrow-item",{mr0:r.isCurrentPreviewPicture}])},[H(w,{class:"button playlist-button flexrow-item",icon:"left",title:r.$t("playlists.actions.files_previous"),disabled:r.isPlaying,onClick:g.onPreviousPreviewClicked},null,8,["title","disabled","onClick"]),L("span",{class:"ml05 mr05 nowrap",title:r.$t("playlists.actions.files_position")},U(r.currentPreviewIndex+1)+" / "+U(r.currentEntityPreviewLength),9,vf),H(w,{class:"button playlist-button flexrow-item",icon:"right",title:r.$t("playlists.actions.files_next"),disabled:r.isPlaying,onClick:g.onNextPreviewClicked},null,8,["title","disabled","onClick"]),L("a",{class:"button playlist-button flexrow-item",href:r.currentPreviewPath,title:r.$t("playlists.actions.see_original_file"),target:"blank"},[H(bt,{class:"icon is-small"})],8,wf),r.isCurrentPreviewPicture?V("",!0):(M(),R("div",Cf))],2)):V("",!0),r.isCurrentPreviewMovie&&!f.isFullMode?(M(),R("div",bf,[H(w,{class:"button playlist-button flexrow-item",active:r.isRepeating,title:r.$t("playlists.actions.looping"),icon:"repeat",onClick:r.onRepeatClicked},null,8,["active","title","onClick"]),r.isCurrentPreviewMovie?(M(),et(w,{key:0,class:"playlist-button flexrow-item",title:r.$t("playlists.actions."+(r.isHd?"switch_ld":"switch_hd")),text:r.isHd?"HD":"LD",onClick:n[5]||(n[5]=z=>r.isHd=!r.isHd)},null,8,["title","text"])):V("",!0),H(yt,{class:"playlist-button flexrow-item",modelValue:r.speed,"onUpdate:modelValue":n[6]||(n[6]=z=>r.speed=z)},null,8,["modelValue"]),H(w,{class:"button playlist-button flexrow-item mr0",active:f.isShowAnnotationsWhilePlaying,title:r.$t("playlists.actions.toggle_playing_annotations"),icon:"triangle",onClick:n[7]||(n[7]=z=>f.isShowAnnotationsWhilePlaying=!f.isShowAnnotationsWhilePlaying)},null,8,["active","title"]),H(ht,{class:"flexrow-item playlist-button",onChangeSound:r.onToggleSoundClicked,muted:r.isMuted,"onUpdate:muted":n[8]||(n[8]=z=>r.isMuted=z),volume:r.volume,"onUpdate:volume":n[9]||(n[9]=z=>r.volume=z)},null,8,["onChangeSound","muted","volume"]),H(w,{class:"button playlist-button flexrow-item",active:f.isWaveformDisplayed,title:r.$t("playlists.actions.toggle_waveform"),icon:"waveform",onClick:n[10]||(n[10]=z=>f.isWaveformDisplayed=!f.isWaveformDisplayed)},null,8,["active","title"])])):V("",!0),f.isFullMode?V("",!0):(M(),R("div",_f)),!h.tempMode&&!f.isFullMode?(M(),et(w,{key:7,class:"playlist-button flexrow-item",title:r.$t("playlists.actions.change_task_type"),icon:"check",onClick:g.showTaskTypeModal},null,8,["title","onClick"])):V("",!0),(r.isCurrentPreviewMovie||r.isCurrentPreviewPicture)&&!f.isFullMode?(M(),R("div",xf,[f.taskTypeOptions&&f.taskTypeOptions.length>0?(M(),et(w,{key:0,class:"comparison-button flexrow-item playlist-button",active:r.isComparing,title:r.$t("playlists.actions.split_screen"),icon:"compare",onClick:r.onCompareClicked},null,8,["active","title","onClick"])):V("",!0),L("div",Pf,[r.isComparing?(M(),et(Q,{key:0,class:"playlist-button flexrow-item comparison-list",options:f.taskTypeOptions,modelValue:f.taskTypeToCompare,"onUpdate:modelValue":[n[11]||(n[11]=z=>f.taskTypeToCompare=z),g.onTaskTypeToCompareChanged]},null,8,["options","modelValue","onUpdate:modelValue"])):V("",!0),r.isComparing?(M(),et(Q,{key:1,class:"playlist-button flexrow-item comparison-list",options:f.revisionOptions,"onUpdate:modelValue":[g.onRevisionToCompareChanged,n[12]||(n[12]=z=>f.revisionToCompare=z)],modelValue:f.revisionToCompare},null,8,["options","onUpdate:modelValue","modelValue"])):V("",!0),r.isComparing?(M(),et(Q,{key:2,class:"playlist-button flexrow-item comparison-list",options:g.comparisonModeOptions,modelValue:f.comparisonMode,"onUpdate:modelValue":[n[13]||(n[13]=z=>f.comparisonMode=z),r.updateRoomStatus]},null,8,["options","modelValue","onUpdate:modelValue"])):V("",!0),r.isComparing&&g.currentRevisionToCompare&&g.currentComparisonPreviewLength>1?(M(),R("div",Sf,[H(w,{class:"button playlist-button flexrow-item",icon:"left",onClick:g.onPreviousComparisonPictureClicked},null,8,["onClick"]),L("span",Tf,U(f.currentComparisonPreviewIndex+1)+" / "+U(g.currentComparisonPreviewLength),1),H(w,{class:"button playlist-button flexrow-item",icon:"right",onClick:g.onNextComparisonPictureClicked},null,8,["onClick"])])):V("",!0),r.isComparing&&f.comparisonEntityMissing?(M(),R("div",kf,"  "+U(r.$t("playlists.comparing_missing_plan")),1)):V("",!0)])])):V("",!0),n[36]||(n[36]=L("span",{class:"filler"},null,-1)),r.isCurrentPreviewModel?(M(),R("div",Of,[H(mt,{class:"background-combo mr05",active:!!f.currentBackground,disabled:!r.productionBackgrounds.length,"is-compact":!r.productionBackgrounds.length,"is-reversed":"","keep-order":"",thin:"",options:g.backgroundOptions,modelValue:f.currentBackground,"onUpdate:modelValue":n[14]||(n[14]=z=>f.currentBackground=z),onChange:n[15]||(n[15]=z=>g.onObjectBackgroundSelected())},{icon:ns(()=>[H(ut,{class:"icon is-small mr05"})]),_:1},8,["active","disabled","is-compact","options","modelValue"]),H(w,{class:"playlist-button flexrow-item",active:f.isObjectBackground&&f.isEnvironmentSkybox,disabled:!f.objectBackgroundUrl||!f.isObjectBackground,icon:"image",title:r.$t("playlists.actions.toggle_environment_skybox"),onClick:n[16]||(n[16]=z=>f.isEnvironmentSkybox=!f.isEnvironmentSkybox)},null,8,["active","disabled","title"]),H(w,{class:"playlist-button flexrow-item",active:f.isWireframe,icon:"codepen",title:r.$t("playlists.actions.toggle_wireframe"),onClick:n[17]||(n[17]=z=>f.isWireframe=!f.isWireframe)},null,8,["active","title"])])):V("",!0),(r.isCurrentUserManager||r.isCurrentUserSupervisor)&&h.tempMode?(M(),R(Ht,{key:10},[n[33]||(n[33]=L("div",{class:"separator"},null,-1)),H(w,{onClick:n[18]||(n[18]=z=>r.$emit("save-clicked")),class:"playlist-button flexrow-item",title:r.$t("playlists.actions.save_playlist"),icon:"save"},null,8,["title"])],64)):V("",!0),!r.isCurrentUserArtist&&(r.isCurrentPreviewMovie||r.isCurrentPreviewPicture)&&!f.isFullMode?(M(),R("div",Ef,[(r.isCurrentUserManager||r.isCurrentUserSupervisor)&&h.tempMode?(M(),R("div",Df)):V("",!0),(r.isCurrentUserManager||r.isCurrentUserSupervisor)&&!h.isAddingEntity?(M(),et(w,{key:1,class:"playlist-button flexrow-item",active:f.isAnnotationsDisplayed,icon:"pen",title:r.$t("playlists.actions.toggle_annotations"),onClick:n[19]||(n[19]=z=>f.isAnnotationsDisplayed=!f.isAnnotationsDisplayed)},null,8,["active","title"])):V("",!0),r.isCurrentPreviewMovie||r.isCurrentPreviewPicture?(M(),et(w,{key:2,class:"playlist-button flexrow-item",active:f.isZoomEnabled,icon:"loupe",title:r.$t("playlists.actions.annotation_zoom_pan"),onClick:n[20]||(n[20]=z=>g.onPanZoomClicked())},null,8,["active","title"])):V("",!0),H(lo,{name:"slide"},{default:ns(()=>[st(L("div",Mf,[H(vt,{color:r.textColor,onTogglePalette:r.onPickPencilColor,onChange:r.onChangeTextColor},null,8,["color","onTogglePalette","onChange"])],512),[[rt,r.isTyping]])]),_:1}),H(w,{class:"playlist-button flexrow-item",active:r.isTyping,title:r.$t("playlists.actions.annotation_text"),onClick:r.onTypeClicked,icon:"type"},null,8,["active","title","onClick"]),H(lo,{name:"slide"},{default:ns(()=>[st(L("div",Af,[H(wt,{pencil:r.pencilWidth,sizes:r.pencilPalette,onTogglePalette:r.onPickPencilWidth,onChange:r.onChangePencilWidth},null,8,["pencil","sizes","onTogglePalette","onChange"]),H(vt,{color:r.pencilColor,onTogglePalette:r.onPickPencilColor,onChange:r.onChangePencilColor},null,8,["color","onTogglePalette","onChange"])],512),[[rt,r.isDrawing]])]),_:1}),H(w,{class:St({"playlist-button":!0,"flexrow-item":!0,active:r.isDrawing}),title:r.$t("playlists.actions.annotation_draw"),onClick:r.onAnnotateClicked,icon:"pencil"},null,8,["class","title","onClick"]),(r.isCurrentUserManager||r.isCurrentUserSupervisor)&&!h.isAddingEntity?(M(),et(w,{key:3,onClick:n[21]||(n[21]=z=>f.isLaserModeOn=!f.isLaserModeOn),class:"playlist-button flexrow-item",active:f.isLaserModeOn,icon:"laser",title:r.$t("playlists.actions.toggle_laser")},null,8,["active","title"])):V("",!0),st(H(w,{class:St({"playlist-button":!0,"flexrow-item":!0,active:r.isDrawing}),title:r.$t("playlists.actions.annotation_erase"),onClick:r.onEraseClicked,icon:"eraser"},null,8,["class","title","onClick"]),[[rt,!1]]),H(w,{class:"playlist-button flexrow-item",icon:"delete",title:r.$t("playlists.actions.annotation_delete"),onClick:r.onDeleteClicked},null,8,["title","onClick"])])):V("",!0),n[37]||(n[37]=L("div",{class:"separator"},null,-1)),H(w,{class:"button playlist-button flexrow-item",active:!r.isCommentsHidden,title:r.$t("playlists.actions.comments"),onClick:r.onCommentClicked,icon:"comment"},null,8,["active","title","onClick"]),H(w,{class:"playlist-button flexrow-item",title:r.$t("playlists.actions.entity_list"),active:!r.isEntitiesHidden,onClick:r.onFilmClicked,icon:"film"},null,8,["title","active","onClick"]),h.tempMode?V("",!0):(M(),R("div",Ff,[L("div",{class:St({"build-options":!0,hidden:f.isDlButtonsHidden})},[L("a",{class:"dl-button zip-button",href:g.zipDlPath},U(r.$t("playlists.download_zip")),9,Lf),L("a",{class:"dl-button zip-button",href:g.csvDlPath},U(r.$t("playlists.download_csv")),9,Rf),L("span",{class:St({"dl-button":!0,"mp4-button":!0,disabled:!(r.isCurrentUserManager||r.isCurrentUserSupervisor)||g.isJobRunning,hidden:f.isDlButtonsHidden}),onClick:n[22]||(n[22]=(...z)=>g.onBuildClicked&&g.onBuildClicked(...z))},U(r.$t("playlists.build_mp4"))+" - concat ",3),L("span",{class:St({"dl-button":!0,"mp4-2-button":!0,disabled:!(r.isCurrentUserManager||r.isCurrentUserSupervisor)||g.isJobRunning,hidden:f.isDlButtonsHidden}),onClick:n[23]||(n[23]=(...z)=>g.onBuildFullClicked&&g.onBuildFullClicked(...z))},U(r.$t("playlists.build_mp4"))+" - full ",3)],2),L("div",{class:St({"build-list":!0,hidden:f.isDlButtonsHidden})},[!h.playlist.build_jobs||h.playlist.build_jobs.length===0?(M(),R("span",jf,U(r.$t("playlists.no_build")),1)):(M(),R("div",If,[L("div",Bf,U(r.$t("playlists.available_build")),1),(M(!0),R(Ht,null,ee(h.playlist.build_jobs,z=>(M(),R("div",{class:"flexrow",key:z.id},[z.status==="running"?(M(),et(Y,{key:0,class:"build-spinner"})):V("",!0),z.status==="running"?(M(),R("span",Wf,U(r.$t("playlists.building")),1)):z.status==="failed"?(M(),R("span",Hf,U(r.$t("playlists.failed")),1)):(M(),R(Ht,{key:3},[r.joinedRoom?V("",!0):(M(),R("button",{key:0,class:"job-button mr05",onClick:J=>g.playBuild(z)},[H(at,{size:12})],8,$f)),L("a",{class:"flexrow-item",href:g.getBuildPath(z)},U(g.formatDate(z.created_at)),9,zf)],64)),n[34]||(n[34]=L("span",{class:"filler"},null,-1)),L("button",{class:"job-button",onClick:J=>g.onRemoveBuildJob(z)}," x ",8,Vf)]))),128))]))],2),r.isCurrentUserArtist?V("",!0):(M(),et(w,{key:0,class:"playlist-button",title:r.$t("playlists.actions.download"),icon:"download",onClick:g.toggleDlButtons},null,8,["title","onClick"]))])),r.isFullScreenEnabled?(M(),et(w,{key:13,class:"button playlist-button flexrow-item",title:r.$t("playlists.actions.fullscreen"),onClick:r.onFullscreenClicked,icon:"maximize"},null,8,["title","onClick"])):V("",!0)],512)):V("",!0),st(H($t,{ref:"playlist-progress",class:"video-progress pull-bottom","entity-list":r.entityList,fps:r.fps,"frame-duration":r.frameDuration,"is-full-mode":f.isFullMode,"is-full-screen":r.fullScreen||r.isEntitiesHidden,"nb-frames":r.isCurrentPreviewMovie?r.nbFrames:0,"playlist-duration":f.playlistDuration,"playlist-progress":f.playlistProgress,"playlist-shot-position":f.playlistShotPosition,onStartScrub:r.onScrubStart,onEndScrub:r.onScrubEnd,onProgressPlaylistChanged:g.onProgressPlaylistChanged},null,8,["entity-list","fps","frame-duration","is-full-mode","is-full-screen","nb-frames","playlist-duration","playlist-progress","playlist-shot-position","onStartScrub","onEndScrub","onProgressPlaylistChanged"]),[[rt,h.playlist.id&&!h.isAddingEntity]]),h.playlist.id?(M(),R("div",{key:2,class:St({"playlisted-entities":!0,flexrow:!0,hidden:r.isEntitiesHidden}),ref:"playlisted-entities",onWheel:n[25]||(n[25]=(...z)=>g.onEntitiesWheel&&g.onEntitiesWheel(...z))},[h.isLoading?(M(),et(Y,{key:0,class:"spinner"})):(M(!0),R(Ht,{key:1},ee(r.entityList,(z,J)=>(M(),R("div",{class:"flexrow-item has-text-centered playlisted-wrapper",key:z.id},[H(Xt,{ref_for:!0,ref:"entity-"+J,entity:z,index:J,"is-playing":r.playingEntityIndex===J,draggable:"true",onDragstart:se=>g.onEntityDragStart(se,z),onEntityToAdd:n[24]||(n[24]=se=>r.$emit("entity-to-add",se)),onEntityDropped:g.onEntityDropped,onPlayClick:g.entityListClicked,onPreviewChanged:g.onPreviewChanged,onRemoveEntity:g.removeEntity},null,8,["entity","index","is-playing","onDragstart","onEntityDropped","onPlayClick","onPreviewChanged","onRemoveEntity"])]))),128))],34)):V("",!0),f.modals.notifyClients?(M(),et(ie,{key:3,active:"","is-loading":f.loading.notifyClients,"is-error":f.errors.notifyClients,"is-success":f.success.notifyClients,onConfirm:g.confirmNotifyClients,onCancel:n[26]||(n[26]=z=>f.modals.notifyClients=!1)},null,8,["is-loading","is-error","is-success","onConfirm"])):V("",!0),H(Me,{active:f.modals.delete,"is-loading":f.loading.deletePlaylist,"is-error":f.errors.deletePlaylist,text:g.deleteText,"error-text":r.$t("playlists.delete_error"),onConfirm:g.confirmRemovePlaylist,onCancel:g.hideDeleteModal},null,8,["active","is-loading","is-error","text","error-text","onConfirm","onCancel"]),H(ae,{active:f.modals.taskType,"task-type-list":g.entityTaskTypes,onConfirm:g.confirmChangeTaskType,onCancel:g.hideTaskTypeModal},null,8,["active","task-type-list","onConfirm","onCancel"]),L("canvas",Nf,null,512),L("canvas",Xf,null,512)],2)}const wp=Tt(Xd,[["render",Yf],["__scopeId","data-v-178170de"]]);export{eu as B,hu as C,vp as E,Yu as L,Lu as O,vd as P,ld as R,Dd as S,Vd as V,Md as _,yo as a,zu as b,Kc as c,wp as d,Ao as e,pd as f,Mo as g,X as h,ur as i,vo as p};
//# sourceMappingURL=PlaylistPlayer-DoTL8QsR.js.map
