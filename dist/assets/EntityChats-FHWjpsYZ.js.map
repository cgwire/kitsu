{"version":3,"file":"EntityChats-FHWjpsYZ.js","sources":["../../src/components/layouts/PageLeftSideLayout.vue","../../src/components/pages/EntityChats.vue"],"sourcesContent":["<template>\n  <div ref=\"page\" class=\"columns fixed-page\">\n    <div class=\"column left-side-column\">\n      <slot name=\"side\" />\n    </div>\n    <div class=\"column main-column\">\n      <slot name=\"main\" />\n    </div>\n  </div>\n</template>\n\n<script>\nexport default {\n  name: 'page-left-side-layout'\n}\n</script>\n","<template>\n  <page-left-side-layout>\n    <template #side>\n      <div class=\"chat-column\">\n        <spinner class=\"mt1\" v-if=\"loading.list\" />\n        <div class=\"chat-list\" v-else>\n          <div\n            :key=\"chat.id\"\n            :class=\"chatClass(chat)\"\n            @click=\"selectChat(chat)\"\n            v-for=\"chat in chatList\"\n          >\n            <div class=\"flexrow\">\n              <entity-thumbnail\n                class=\"flexrow-item mr1\"\n                :height=\"40\"\n                :empty-height=\"40\"\n                :empty-width=\"60\"\n                :entity=\"{\n                  id: chat.object_id,\n                  preview_file_id: chat.preview_file_id\n                }\"\n              />\n              <div class=\"flexcolumn flexrow-item ml1\">\n                <div class=\"chat-item-project-name\">\n                  {{ getChatProjectName(chat) }}\n                </div>\n                <div class=\"chat-item-title\">\n                  {{ chat.entity_name }}\n                </div>\n                <div class=\"chat-item-subtitle\">\n                  {{ getChatDate(chat) }}\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </template>\n\n    <template #main>\n      <div class=\"selected-entity-chat\">\n        <entity-chat\n          ref=\"entityChat\"\n          :entity=\"entity\"\n          :name=\"chatList.find(c => c.object_id === entity.id)?.entity_name\"\n        />\n      </div>\n    </template>\n  </page-left-side-layout>\n</template>\n\n<script>\nimport { mapGetters, mapActions } from 'vuex'\n\nimport { formatListMixin } from '@/components/mixins/format'\n\nimport EntityChat from '@/components/pages/entities/EntityChat.vue'\nimport EntityThumbnail from '@/components/widgets/EntityThumbnail.vue'\nimport PageLeftSideLayout from '@/components/layouts/PageLeftSideLayout.vue'\nimport Spinner from '@/components/widgets/Spinner.vue'\n\nexport default {\n  name: 'entity-chats',\n\n  mixins: [formatListMixin],\n\n  components: {\n    EntityChat,\n    EntityThumbnail,\n    PageLeftSideLayout,\n    Spinner\n  },\n\n  data() {\n    return {\n      chats: [],\n      entity: null,\n      loading: {\n        list: false\n      }\n    }\n  },\n\n  async mounted() {\n    this.loading.list = true\n    this.chats = await this.getEntityChats()\n    if (this.$route.query.entity_id) {\n      this.selectFromQuery()\n    } else {\n      this.selectFirstChat()\n    }\n    this.loading.list = false\n  },\n\n  computed: {\n    ...mapGetters(['productionMap', 'user']),\n\n    chatList() {\n      return [...this.chats].sort((a, b) => {\n        if (!a.last_message) return 1\n        if (!b.last_message) return -1\n        if (a.last_message === b.last_message) {\n          return a.entity_name.localeCompare(b.entity_name)\n        }\n        return a.last_message < b.last_message\n      })\n    }\n  },\n\n  methods: {\n    ...mapActions(['getEntityChats']),\n\n    selectFirstChat() {\n      if (this.chats.length > 0) {\n        const chat = this.chats[this.chats.length - 1]\n        this.entity = { id: chat.object_id }\n      }\n    },\n\n    selectFromQuery() {\n      const chat = this.chats.find(\n        c => c.object_id === this.$route.query.entity_id\n      )\n      if (chat) {\n        this.entity = { id: chat.object_id }\n      } else {\n        this.selectFirstChat()\n      }\n    },\n\n    selectChat(chat) {\n      this.entity = { id: chat.object_id }\n      this.$nextTick(() => {\n        this.$refs.entityChat.focusMessageBox()\n      })\n      this.$router.push({ query: { entity_id: chat.object_id } })\n    },\n\n    chatClass(chat) {\n      return {\n        'chat-item': true,\n        selected: this.entity && this.entity.id === chat.object_id\n      }\n    },\n\n    getChatProjectName(chat) {\n      return this.productionMap.get(chat.project_id).name\n    },\n\n    getChatDate(chat) {\n      if (!chat.last_message) return this.$t('chats.no_message_yet')\n      return this.formatDate(chat.last_message)\n    }\n  },\n\n  watch: {\n    '$route.query.entity_id'() {\n      this.selectFromQuery()\n    }\n  },\n\n  socket: {\n    events: {\n      async 'chat:joined'(eventData) {\n        if (\n          !this.chats.some(c => c.id === eventData.chat_id) &&\n          this.user.id === eventData.person_id\n        ) {\n          this.chats = await this.getEntityChats()\n        }\n      },\n\n      'chat:left'(eventData) {\n        if (\n          this.chats.some(c => c.id === eventData.chat_id) &&\n          this.user.id === eventData.person_id\n        ) {\n          this.chats = this.chats.filter(c => c.id !== eventData.chat_id)\n        }\n      },\n\n      'chat:new-message'(eventData) {\n        const chat = this.chats.find(c => c.id === eventData.chat_id)\n        if (chat) {\n          chat.last_message = eventData.last_message\n        }\n      }\n    }\n  },\n\n  head() {\n    return {\n      title: `${this.$t('chats.title')} - Kitsu`\n    }\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.chat-column {\n  border: 1px solid var(--border);\n  height: 100%;\n  overflow-y: auto;\n  padding-top: 60px;\n}\n\n.selected-entity-chat {\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n  max-height: 100%;\n  padding: 1em;\n  padding-top: 60px;\n}\n\n.chat-item {\n  border: 2px solid transparent;\n  border-bottom: 2px solid var(--border-alt);\n  color: var(--text);\n  cursor: pointer;\n  padding: 1em;\n\n  &:hover {\n    border-color: var(--background-selectable);\n  }\n\n  &.selected {\n    border-color: var(--background-selected);\n  }\n\n  .chat-item-project-name {\n    color: $grey;\n    font-size: 0.7em;\n    font-weight: bold;\n    text-transform: uppercase;\n  }\n\n  .chat-item-title {\n    font-weight: bold;\n  }\n\n  .chat-item-subtitle {\n    color: $grey;\n    font-size: 0.8em;\n  }\n}\n</style>\n"],"names":["_sfc_main","_hoisted_2","_hoisted_3","_openBlock","_createElementBlock","_hoisted_1","_createElementVNode","_renderSlot","_ctx","formatListMixin","EntityChat","EntityThumbnail","PageLeftSideLayout","Spinner","mapGetters","a","b","mapActions","chat","c","eventData","_hoisted_4","_hoisted_5","_hoisted_6","_hoisted_7","_hoisted_8","_hoisted_9","_createBlock","_component_page_left_side_layout","$data","_component_spinner","_Fragment","_renderList","$options","_normalizeClass","$event","_createVNode","_component_entity_thumbnail","_toDisplayString","_component_entity_chat"],"mappings":"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"}