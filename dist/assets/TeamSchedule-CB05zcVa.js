import{f as i,x as c,C as u,a_ as p,$ as h,S as m,a$ as r,m as f,b0 as d,g as D,bK as l,b5 as _,cb as b,a3 as v,n as y}from"./index-BQ0lsE7G.js";const g={name:"team-schedule",mixins:[i],components:{ComboboxDepartment:c,ComboboxNumber:u,Datepicker:p,PeopleField:h,Schedule:m},data(){return{endDate:r().add(3,"months"),personDates:{},scheduleItems:[],selectedDepartment:null,selectedEndDate:null,selectedPerson:null,selectedStartDate:null,startDate:r(),zoomLevel:1,zoomOptions:[{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}],loading:{schedule:!1},errors:{schedule:!1}}},mounted(){this.init()},computed:{...f(["displayedPeople","taskTypeMap","user"]),locale(){return this.user.locale==="fr_FR"?d.fr:d.en},selectablePeople(){const t=this.displayedPeople.filter(e=>!e.is_bot);return this.selectedDepartment?t.filter(e=>e.departments.includes(this.selectedDepartment)):t}},methods:{...D(["assignSelectedTasks","fetchPersonTasks","getPersonsTasksDates","loadPeople","unassignPersonFromTask","updateTask"]),async init(){this.loading.schedule=!0,await Promise.all([this.loadPeople(),this.loadPersonDates()]),this.refreshSchedule(),this.startDate=r(),this.endDate=r().add(3,"months"),Object.values(this.personDates).forEach(t=>{t.startDate.isBefore(this.startDate)&&(this.startDate=t.startDate.clone()),t.endDate.isAfter(this.endDate)&&(this.endDate=t.endDate.clone())}),this.selectedStartDate=this.startDate.toDate(),this.selectedEndDate=this.endDate.toDate()},async loadPersonDates(t=!1){const e=await this.getPersonsTasksDates();this.personDates={},e.forEach(s=>{this.personDates[s.person_id]={endDate:l(s.max_date),startDate:l(s.min_date)}}),t&&this.scheduleItems.forEach(s=>{const a=this.personDates[s.id];a&&(s.startDate=a.startDate,s.endDate=a.endDate)})},refreshSchedule(){const t=this.selectedPerson?[this.selectedPerson]:this.selectablePeople;this.scheduleItems=this.convertScheduleItems(t)},convertScheduleItems(t){return t.map(e=>{let s=r(),a=r();const n=this.personDates[e.id];return n&&n.startDate&&n.endDate&&(s=l(n.startDate),a=l(n.endDate)),{...e,avatar:!0,color:e.color||_.fromString(e.name,!0),startDate:s,endDate:a,expanded:!1,loading:!1,editable:!1,route:b(e.id,"schedule"),children:[]}})},buildTaskScheduleItem(t,e){let s=r(),a;if(!e.start_date||!e.due_date)return null;e.start_date&&(s=l(e.start_date));const n=this.formatDuration(e.estimation);e.due_date&&(a=l(e.due_date)),(!a||a.isBefore(s))&&(a=s.clone().add(1,"days"));const o=this.taskTypeMap.get(e.task_type_id);return{...e,name:`${e.full_entity_name} / ${o.name}`,startDate:s,endDate:a,loading:!1,man_days:n,editable:!0,unresizable:!0,color:o.color,parentElement:t}},saveTaskScheduleItem(t){return this.updateTask({taskId:t.id,data:{start_date:t.startDate.format("YYYY-MM-DD"),due_date:t.endDate.format("YYYY-MM-DD")}})},async onScheduleItemChanged(t){t.type==="Task"&&(await this.saveTaskScheduleItem(t),await this.loadPersonDates(!0))},onScheduleItemAssigned(t,e){t.type==="Task"&&this.assignSelectedTasks({personId:e.id,taskIds:[t.id]})},onScheduleItemUnassigned(t,e){t.type==="Task"&&this.unassignPersonFromTask({person:e,task:t})},async expandPersonElement(t,e){if(t.expanded=!t.expanded,!!t.expanded){t.loading=!0,t.children=[];try{const s=await this.fetchPersonTasks(t.id);t.children=s.map(a=>this.buildTaskScheduleItem(t,a)).filter(Boolean).sort(v.firstBy("startDate").thenBy("project_name").thenBy("name")),e&&e(t)}catch(s){console.error(s)}t.loading=!1}},onUpdateSelectedStartDate(t){this.startDate=l(t)},onUpdateSelectedEndDate(t){this.endDate=l(t)}},socket:{},watch:{selectedDepartment(){this.selectedPerson&&!this.selectablePeople.includes(this.selectedPerson)&&this.$refs["people-field"].clear(),this.refreshSchedule()},selectedPerson(){this.refreshSchedule()}},metaInfo(){return{title:`${this.$t("team_schedule.title_main")} - Kitsu`}}};var P=function(){var e=this,s=e._self._c;return s("div",{staticClass:"columns fixed-page"},[s("div",{staticClass:"column main-column"},[s("div",{staticClass:"flexrow project-dates"},[s("div",{staticClass:"flexrow-item"},[s("label",{staticClass:"label"},[e._v(" "+e._s(e.$t("main.start_date"))+" ")]),s("datepicker",{attrs:{"wrapper-class":"datepicker","input-class":"date-input input short",language:e.locale,"monday-first":!0,typeable:!0,format:"yyyy-MM-dd"},on:{selected:e.onUpdateSelectedStartDate},model:{value:e.selectedStartDate,callback:function(a){e.selectedStartDate=a},expression:"selectedStartDate"}})],1),s("div",{staticClass:"flexrow-item"},[s("label",{staticClass:"label"},[e._v(" "+e._s(e.$t("main.end_date"))+" ")]),s("datepicker",{attrs:{"wrapper-class":"datepicker","input-class":"date-input input short",language:e.locale,"monday-first":!0,typeable:!0,format:"yyyy-MM-dd"},on:{selected:e.onUpdateSelectedEndDate},model:{value:e.selectedEndDate,callback:function(a){e.selectedEndDate=a},expression:"selectedEndDate"}})],1),s("combobox-number",{staticClass:"flexrow-item zoom-level",attrs:{label:e.$t("schedule.zoom_level"),options:e.zoomOptions},model:{value:e.zoomLevel,callback:function(a){e.zoomLevel=a},expression:"zoomLevel"}}),s("combobox-department",{staticClass:"flexrow-item",attrs:{label:e.$t("main.department")},model:{value:e.selectedDepartment,callback:function(a){e.selectedDepartment=a},expression:"selectedDepartment"}}),s("div",{staticClass:"flexrow-item people-filter"},[s("label",{staticClass:"label"},[e._v(" "+e._s(e.$t("main.person"))+" ")]),s("people-field",{ref:"people-field",attrs:{people:e.selectablePeople,placeholder:e.$t("team_schedule.person_placeholder"),wide:""},model:{value:e.selectedPerson,callback:function(a){e.selectedPerson=a},expression:"selectedPerson"}})],1),s("div",{staticClass:"filler"}),s("div",{staticClass:"button",on:{click:function(a){return e.$refs.schedule.scrollToToday()}}},[e._v("today")])],1),s("schedule",{attrs:{"end-date":e.endDate,"hide-man-days":!0,hierarchy:e.scheduleItems,"is-error":e.errors.schedule,"is-loading":e.loading.schedule,multiline:!0,reassignable:!0,"start-date":e.startDate,"with-milestones":!1,"zoom-level":e.zoomLevel},on:{"item-changed":e.onScheduleItemChanged,"item-assign":e.onScheduleItemAssigned,"item-unassign":e.onScheduleItemUnassigned,"root-element-expanded":e.expandPersonElement}})],1)])},S=[],x=y(g,P,S,!1,null,"de9975a4",null,null);const T=x.exports;export{T as default};
//# sourceMappingURL=TeamSchedule-CB05zcVa.js.map
