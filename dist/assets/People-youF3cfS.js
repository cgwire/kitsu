import{_ as b,M as x,a as w,r,o as n,c as v,d as l,t as c,I as R,f as d,n as g,h as m,B as U,g as h,b as q}from"./index-Dw-uod2x.js";import{c as C}from"./csv-Dt0ViJ8m.js";import{s as N}from"./search-CWIHq9c3.js";import{B}from"./ButtonHrefLink-k9TyPB_D.js";import{T as Q}from"./TextField-EpYNDuEI.js";import{C as O}from"./ComboboxDepartment-DQ8ZI2WM.js";import{C as H}from"./ComboboxStudio-D4rrWH2h.js";import{C as K}from"./ComboboxStyled-DrFBZe-s.js";import{P as j,E as z,a as G}from"./PeopleList-Og6_QhMJ.js";import{H as J}from"./HardDeleteModal-BWVmHjcR.js";import{I as W,a as X}from"./ImportRenderModal-DOvk26U4.js";import{P as Y}from"./PageTitle-CBcleFeD.js";import{R as Z}from"./RouteTabs-BV9uY71q.js";import{S as $}from"./SearchField-B9agWdMK.js";import{S as ee}from"./SearchQueryList-eqDHREjk.js";import"./string-B0Tq569e.js";import"./upload-Cv4TfmRi.js";import"./DepartmentName-kmEXEkam.js";import"./time-DOQFDZTc.js";import"./Combobox-Z_ENhFXj.js";import"./DateField-BoSZf4Hb.js";import"./grablist-Da7oVI-6.js";import"./dom-tO7tlkHV.js";import"./DepartmentNamesCell-B71hATyQ.js";import"./copy-C1lXCnZO.js";import"./shield-check-BkxEIRrB.js";import"./RowActionsCell-C9aLugox.js";import"./trash-gURpboxh.js";import"./refresh-cw-D3rKtSvX.js";import"./TableInfo-BOYXFWEz.js";import"./triangle-alert-D6jyW-fK.js";import"./FileUpload-Cng9V_As.js";import"./ModalFooter-Dmgqo0ae.js";import"./Checkbox-in6UcoC-.js";import"./ConfirmModal-DnlSFX-8.js";import"./BooleanField-DWHGtZOu.js";import"./check-B15weKo7.js";import"./ColorField-COd1sznp.js";import"./trash-2-B6whY4z4.js";import"./chevron-up-DrIzzrNn.js";const te={name:"change-password-modal",mixins:[x],props:{active:{type:Boolean,default:!1},person:{type:Object,default:()=>{}}},emits:["cancel","confirm"],data(){return{form:{password:"",password2:""},isLoading:!1,isError:!1,isErrorDisableTwoFactorAuthentication:!1,isValid:!0}},components:{TextField:Q},methods:{...w(["changePasswordPerson","disableTwoFactorAuthenticationPerson"]),confirmClicked(){this.isErrorDisableTwoFactorAuthentication=!1,this.isError=!1,this.isLoading=!0,this.changePasswordPerson({person:this.person,form:this.form}).then(()=>{this.$emit("confirm")}).catch(e=>{e.isValidPassword===!1?this.isValid=!1:this.isError=!0}).finally(()=>{this.isLoading=!1})},disableTwoFactorAuthenticationClicked(){this.isErrorDisableTwoFactorAuthentication=!1,this.isError=!1,this.isLoading=!0,this.disableTwoFactorAuthenticationPerson(this.person).catch(()=>{this.isErrorDisableTwoFactorAuthentication=!0}).finally(()=>{this.isLoading=!1})},resetForm(){this.person&&(this.form={password:"",password2:""},this.isLoading=!1,this.isError=!1,this.isErrorDisableTwoFactorAuthentication=!1,this.isValid=!0)}},watch:{person(){this.resetForm()},active(){this.active&&(this.resetForm(),setTimeout(()=>{this.$refs["first-password"]?.focus()},100))}}},oe={class:"modal-content"},se={class:"box"},ie={class:"title"},re={class:"flexrow"},ae=["disabled"],le=["disabled"],ne={key:0,class:"error has-text-right mt1"},de={key:1,class:"error has-text-right mt1"},me={key:2,class:"error has-text-right mt1"};function pe(e,t,i,u,o,s){const f=r("text-field");return n(),v("div",{class:g({modal:!0,"is-active":i.active})},[l("div",{class:"modal-background",onClick:t[0]||(t[0]=a=>e.$emit("cancel"))}),l("div",oe,[l("div",se,[l("h1",ie,c(e.$t("people.change_password_for"))+" "+c(i.person.name),1),l("form",{onSubmit:t[5]||(t[5]=R(()=>{},["prevent"]))},[d(f,{autocomplete:"new-password",disabled:i.person.is_generated_from_ldap,label:e.$t("people.fields.password"),ref:"first-password",type:"password",onEnter:t[1]||(t[1]=a=>s.confirmClicked()),modelValue:o.form.password,"onUpdate:modelValue":t[2]||(t[2]=a=>o.form.password=a)},null,8,["disabled","label","modelValue"]),d(f,{autocomplete:"new-password",disabled:i.person.is_generated_from_ldap,label:e.$t("people.fields.password_2"),type:"password",onEnter:t[3]||(t[3]=a=>s.confirmClicked()),modelValue:o.form.password2,"onUpdate:modelValue":t[4]||(t[4]=a=>o.form.password2=a)},null,8,["disabled","label","modelValue"])],32),l("div",re,[l("button",{class:g({button:!0,"is-primary":!0,"flexrow-item":!0,"is-loading":o.isLoading}),disabled:i.person.is_generated_from_ldap,onClick:t[6]||(t[6]=(...a)=>s.confirmClicked&&s.confirmClicked(...a))},c(e.$t("profile.change_password.button")),11,ae),l("button",{class:g({button:!0,"flexrow-item":!0,"is-loading":o.isLoading,"is-warning":!0}),disabled:!(i.person.totp_enabled||i.person.email_otp_enabled||i.person.fido_enabled),onClick:t[7]||(t[7]=(...a)=>s.disableTwoFactorAuthenticationClicked&&s.disableTwoFactorAuthenticationClicked(...a))},c(e.$t("people.disable_2FA")),11,le),t[9]||(t[9]=l("div",{class:"filler"},null,-1)),l("button",{class:"button is-link flexrow-item",onClick:t[8]||(t[8]=a=>e.$emit("cancel"))},c(e.$t("main.cancel")),1)]),o.isValid?m("",!0):(n(),v("div",ne,c(e.$t("profile.change_password.unvalid")),1)),o.isError?(n(),v("div",de,c(e.$t("people.change_password_error")),1)):m("",!0),o.isErrorDisableTwoFactorAuthentication?(n(),v("div",me,c(e.$t("people.disable_2FA_error")),1)):m("",!0)])])],2)}const ce=b(te,[["render",pe],["__scopeId","data-v-6f42c5c1"]]),he={name:"people",mixins:[N],components:{ButtonHrefLink:B,ButtonSimple:U,ChangePasswordModal:ce,ComboboxDepartment:O,ComboboxStudio:H,ComboboxStyled:K,EditAvatarModal:G,EditPersonModal:z,HardDeleteModal:J,ImportModal:X,ImportRenderModal:W,PageTitle:Y,PeopleList:j,RouteTabs:Z,SearchField:$,SearchQueryList:ee},data(){return{activeTab:"active",csvColumns:["First Name","Last Name"],optionalCsvColumns:["Phone","Role","Contract Type","Studio","Active"],dataMatchers:["Email"],role:"all",roleOptions:[{label:"all",value:"all"},{label:"admin",value:"admin"},{label:"client",value:"client"},{label:"manager",value:"manager"},{label:"supervisor",value:"supervisor"},{label:"user",value:"user"},{label:"vendor",value:"vendor"}],errors:{avatar:!1,del:!1,edit:!1,invite:!1,userLimit:!1},loading:{createAndInvite:!1,del:!1,deletingAvatar:!1,edit:!1,invite:!1,savingSearch:!1,updatingAvatar:!1},modals:{avatar:!1,changePassword:!1,del:!1,edit:!1,importModal:!1,isImportRenderDisplayed:!1},parsedCSV:[],personToDelete:{},personToEdit:{role:"user"},personToChangePassword:{},selectedDepartment:"",selectedStudio:"",success:{invite:!1},tabs:[{name:"active",label:this.$t("main.active")},{name:"unactive",label:this.$t("people.unactive")}]}},async mounted(){this.activeTab=this.$route.query.tab||"active",this.role=this.$route.query.role||"all",this.selectedDepartment=this.$route.query.department||"",this.selectedStudio=this.$route.query.studio||"",this.setSearchFromUrl(),await this.loadPeople(),this.onSearchChange()},computed:{...q(["displayedPeople","isCurrentUserAdmin","isPeopleLoading","isPeopleLoadingError","isImportPeopleLoading","isImportPeopleLoadingError","peopleSearchQueries","personCsvFormData","studioMap"]),currentPeople(){let e=this.displayedPeople.filter(t=>!t.is_bot);return this.role!=="all"&&(e=e.filter(t=>t.role===this.role)),this.selectedDepartment&&(e=e.filter(t=>t.departments.includes(this.selectedDepartment))),this.selectedStudio&&(e=e.filter(t=>t.studio_id===this.selectedStudio)),e.map(t=>({...t,studio:this.studioMap.get(t.studio_id)}))},deleteText(){const e=this.personToDelete?.full_name;return e?this.$t("people.delete_text",{personName:e}):""},filteredPeople(){const e={};return this.displayedPeople.forEach(t=>{const i=t.email;e[i]=!0}),e},searchField(){return this.$refs["people-search-field"]},activePeople(){return this.currentPeople.filter(e=>e.active)},unactivePeople(){return this.currentPeople.filter(e=>!e.active)}},methods:{...w(["clearPersonAvatar","deletePeople","editPerson","invitePerson","loadPeople","newPerson","newPersonAndInvite","removePeopleSearch","savePeopleSearch","setPeopleSearch","uploadPersonAvatar","uploadPersonFile"]),renderImport(e,t){this.loading.importing=!0,this.errors.importing=!1,this.formData=e,t==="file"&&(e=e.get("file")),C.processCSV(e).then(i=>{this.parsedCSV=i,this.hideImportModal(),this.loading.importing=!1,this.showImportRenderModal()})},async uploadImportFile(e,t){const i=new FormData,u="import.csv",o=C.turnEntriesToCsvString(e),s=new File([o],u,{type:"text/csv"});i.append("file",s),this.$store.commit("PERSON_CSV_FILE_SELECTED",i),this.loading.importing=!0,this.errors.importing=!1;try{await this.uploadPersonFile(t),this.hideImportRenderModal(),await this.loadPeople()}catch(f){console.error(f),this.errors.importing=!0}finally{this.loading.importing=!1}},resetImport(){this.errors.importing=!1,this.hideImportRenderModal(),this.$store.commit("PERSON_CSV_FILE_SELECTED",null),this.$refs["import-modal"]?.reset(),this.showImportModal()},async deleteAvatar(){this.loading.deletingAvatar=!0;try{await this.clearPersonAvatar(this.personToEdit),this.modals.avatar=!1,this.onSearchChange()}catch{this.errors.avatar=!0}finally{this.loading.deletingAvatar=!1}},async updateAvatar(e){this.loading.updatingAvatar=!0;try{await this.uploadPersonAvatar({person:this.personToEdit,formData:e}),this.modals.avatar=!1,this.onSearchChange()}catch{this.errors.avatar=!0}finally{this.loading.updatingAvatar=!1}},confirmEditPeople(e){let t="editPerson";this.personToEdit.id===void 0?t="newPerson":e.id=this.personToEdit.id,this.loading.edit=!0,this.errors.edit=!1,this.errors.userLimit=!1,this[t](e).then(()=>{this.loading.edit=!1,this.modals.edit=!1,this.onSearchChange()}).catch(i=>{i.body?.message?.includes("limit")??!1?this.errors.userLimit=!0:this.errors.edit=!0,this.loading.edit=!1})},confirmCreateAndInvite(e){this.loading.createAndInvite=!0,this.errors.edit=!1,this.errors.userLimit=!1,this.newPersonAndInvite(e).then(()=>{this.loading.createAndInvite=!1,this.modals.edit=!1,this.onSearchChange()}).catch(t=>{console.error(t),t.body?.message?.includes("limit")??!1?this.errors.userLimit=!0:this.errors.edit=!0,this.loading.createAndInvite=!1})},confirmInvite(e){e.id=this.personToEdit.id,this.loading.invite=!0,this.errors.invite=!1,this.invitePerson(e).then(()=>{this.loading.invite=!1,this.success.invite=!0,this.onSearchChange()}).catch(t=>{console.error(t),this.loading.invite=!1,this.success.invite=!1,this.errors.invite=!0})},confirmDeletePeople(){this.loading.del=!0,this.errors.del=!1,this.deletePeople(this.personToDelete).then(()=>{this.loading.del=!1,this.modals.del=!1,this.onSearchChange()}).catch(e=>{console.error(e),this.loading.del=!1,this.errors.del=!0})},onSearchChange(){if(this.searchField){const e=this.searchField?.getValue();e?.length!==1&&this.setPeopleSearch(e),this.setSearchInUrl()}this.tabs[0].label=`${this.$t("main.active")} (${this.activePeople.length})`,this.tabs[1].label=`${this.$t("people.unactive")} (${this.unactivePeople.length})`},onAvatarClicked(e){this.personToEdit=e,this.errors.avatar=!1,this.modals.avatar=!0},onDeleteClicked(e){this.personToDelete=e,this.modals.del=!0},onEditClicked(e){this.errors.invite=!1,this.success.invite=!1,this.personToEdit=e,this.modals.edit=!0},onChangePasswordClicked(e){this.personToChangePassword=e,this.modals.changePassword=!0},onNewClicked(){this.errors.invite=!1,this.success.invite=!1,this.personToEdit={role:"user"},this.modals.edit=!0},showImportModal(){this.modals.importModal=!0},hideImportModal(){this.modals.importModal=!1},showImportRenderModal(){this.modals.isImportRenderDisplayed=!0},hideImportRenderModal(){this.modals.isImportRenderDisplayed=!1},saveSearchQuery(e){this.loading.savingSearch||(this.loading.savingSearch=!0,this.savePeopleSearch(e).catch(console.error).finally(()=>{this.loading.savingSearch=!1}))},removeSearchQuery(e){this.removePeopleSearch(e).catch(console.error)},updateRoute(){const e=this.searchField.getValue(),t=this.selectedDepartment,i=this.selectedStudio,u=this.role;this.$router.push({query:{search:e,department:t,studio:i,role:u}})}},watch:{"modals.edit"(){this.modals.edit&&(this.loading.createAndInvite=!1,this.errors.edit=!1,this.errors.invite=!1,this.errors.userLimit=!1,this.loading.edit=!1,this.loading.invite=!1,this.success.invite=!1)},selectedDepartment(){this.updateRoute()},selectedStudio(){this.updateRoute()},role(){this.updateRoute()},"$route.query.tab"(){this.activeTab=this.$route.query.tab||"active"},"$route.query.search"(e){this.searchField?.setValue(e),this.onSearchChange()}},head(){return{title:`${this.$t("people.title")} - Kitsu`}}},ue={class:"people page fixed-page"},fe={class:"flexrow page-header"},ve={class:"flexrow search-options"},ge={class:"query-list"};function Ce(e,t,i,u,o,s){const f=r("page-title"),a=r("button-simple"),P=r("button-href-link"),_=r("search-field"),y=r("combobox-studio"),S=r("combobox-department"),k=r("combobox-styled"),E=r("search-query-list"),I=r("route-tabs"),A=r("people-list"),T=r("import-render-modal"),D=r("import-modal"),L=r("edit-avatar-modal"),F=r("edit-person-modal"),M=r("change-password-modal"),V=r("hard-delete-modal");return n(),v("div",ue,[l("div",fe,[d(f,{class:"flexrow-item filler",text:e.$t("people.title")},null,8,["text"]),e.isCurrentUserAdmin?(n(),h(a,{key:0,class:"flexrow-item",title:e.$t("main.csv.import_file"),"is-responsive":!0,icon:"import",onClick:s.showImportModal},null,8,["title","onClick"])):m("",!0),d(P,{class:"flexrow-item",title:e.$t("main.csv.export_file"),icon:"export",path:"/api/export/csv/persons.csv"},null,8,["title"]),e.isCurrentUserAdmin?(n(),h(a,{key:1,class:"flexrow-item",text:e.$t("people.new_person"),"is-responsive":!0,icon:"plus",onClick:s.onNewClicked},null,8,["text","onClick"])):m("",!0)]),l("div",ve,[d(_,{ref:"people-search-field",class:"search flexrow-item","can-save":!0,onChange:s.onSearchChange,onSave:s.saveSearchQuery,placeholder:"ex: John Doe"},null,8,["onChange","onSave"]),d(y,{class:"flexrow-item","all-studios-label":"",label:e.$t("main.studio"),modelValue:o.selectedStudio,"onUpdate:modelValue":t[0]||(t[0]=p=>o.selectedStudio=p)},null,8,["label","modelValue"]),d(S,{class:"flexrow-item","all-departments-label":"",label:e.$t("main.department"),modelValue:o.selectedDepartment,"onUpdate:modelValue":t[1]||(t[1]=p=>o.selectedDepartment=p)},null,8,["label","modelValue"]),d(k,{class:"flexrow-item",label:e.$t("people.fields.role"),"locale-key-prefix":"people.role.",options:o.roleOptions,modelValue:o.role,"onUpdate:modelValue":t[2]||(t[2]=p=>o.role=p)},null,8,["label","options","modelValue"])]),l("div",ge,[e.isPeopleLoading?m("",!0):(n(),h(E,{key:0,queries:e.peopleSearchQueries,type:"people",onRemoveSearch:s.removeSearchQuery},null,8,["queries","onRemoveSearch"]))]),d(I,{class:"mb0","active-tab":o.activeTab,tabs:o.tabs},null,8,["active-tab","tabs"]),d(A,{entries:o.activeTab==="active"?s.activePeople:s.unactivePeople,"is-loading":e.isPeopleLoading,"is-error":e.isPeopleLoadingError,onAvatarClicked:s.onAvatarClicked,onDeleteClicked:s.onDeleteClicked,onEditClicked:s.onEditClicked,onChangePasswordClicked:s.onChangePasswordClicked},null,8,["entries","is-loading","is-error","onAvatarClicked","onDeleteClicked","onEditClicked","onChangePasswordClicked"]),o.modals.isImportRenderDisplayed?(n(),h(T,{key:0,active:"","is-loading":e.isImportPeopleLoading,"is-error":e.isImportPeopleLoadingError,"parsed-csv":o.parsedCSV,"form-data":e.personCsvFormData,columns:[...o.dataMatchers,...o.csvColumns,...o.optionalCsvColumns],"data-matchers":o.dataMatchers,database:s.filteredPeople,onReupload:s.resetImport,onCancel:s.hideImportRenderModal,onConfirm:s.uploadImportFile},null,8,["is-loading","is-error","parsed-csv","form-data","columns","data-matchers","database","onReupload","onCancel","onConfirm"])):m("",!0),o.modals.importModal?(n(),h(D,{key:1,ref:"import-modal",active:"","is-loading":e.isImportPeopleLoading,"is-error":e.isImportPeopleLoadingError,"form-data":e.personCsvFormData,columns:[...o.dataMatchers,...o.csvColumns],"optional-columns":o.optionalCsvColumns,onCancel:s.hideImportModal,onConfirm:s.renderImport},null,8,["is-loading","is-error","form-data","columns","optional-columns","onCancel","onConfirm"])):m("",!0),o.modals.avatar?(n(),h(L,{key:2,active:"","error-text":e.$t("people.edit_avatar_error"),"is-deleting":o.loading.deletingAvatar,"is-error":o.errors.avatar,"is-updating":o.loading.updatingAvatar,person:o.personToEdit,onClose:t[3]||(t[3]=p=>o.modals.avatar=!1),onDelete:s.deleteAvatar,onUpdate:s.updateAvatar},null,8,["error-text","is-deleting","is-error","is-updating","person","onDelete","onUpdate"])):m("",!0),d(F,{active:o.modals.edit,"is-create-invite-loading":o.loading.createAndInvite,"is-error":o.errors.edit,"is-invite-loading":o.loading.invite,"is-invitation-success":o.success.invite,"is-invitation-error":o.errors.invite,"is-loading":o.loading.edit,"is-user-limit-error":o.errors.userLimit,"person-to-edit":o.personToEdit,onCancel:t[4]||(t[4]=p=>o.modals.edit=!1),onConfirm:s.confirmEditPeople,onConfirmInvite:s.confirmCreateAndInvite,onInvite:s.confirmInvite},null,8,["active","is-create-invite-loading","is-error","is-invite-loading","is-invitation-success","is-invitation-error","is-loading","is-user-limit-error","person-to-edit","onConfirm","onConfirmInvite","onInvite"]),o.modals.changePassword?(n(),h(M,{key:3,active:"",person:o.personToChangePassword,onCancel:t[5]||(t[5]=p=>o.modals.changePassword=!1),onConfirm:t[6]||(t[6]=p=>o.modals.changePassword=!1)},null,8,["person"])):m("",!0),o.modals.del?(n(),h(V,{key:4,active:"","error-text":e.$t("people.delete_error"),"is-loading":o.loading.del,"is-error":o.errors.del,"lock-text":o.personToDelete?o.personToDelete.full_name:"",text:s.deleteText,onCancel:t[7]||(t[7]=p=>o.modals.del=!1),onConfirm:s.confirmDeletePeople},null,8,["error-text","is-loading","is-error","lock-text","text","onConfirm"])):m("",!0)])}const rt=b(he,[["render",Ce],["__scopeId","data-v-0b6423c8"]]);export{rt as default};
//# sourceMappingURL=People-youF3cfS.js.map
