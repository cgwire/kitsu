import{_ as U,S as $,P as q,R as j,E as H,B as K,r as p,o as a,c as u,d as o,f as l,g as f,h as c,t as h,F as S,e as T,H as O,I,n as k,m as x,a as A,s as W,p as V,am as N,b as G}from"./index-DF-DoQlt.js";import{t as J}from"./time-BX5EcDEd.js";import{C as Q}from"./Combobox-A6pnhVs3.js";import{C as X}from"./ComboboxStatus-CBgYMSHg.js";import{C as Y}from"./ComboboxTaskType-C7Rz0ksS.js";import{D as Z}from"./DateField-BBlawoBq.js";import{P as ee}from"./PeopleField-BoranyvF.js";import{P as te}from"./PreviewPlayer-Bpr7Jn1C.js";import se from"./TaskInfo-C2DOZkHo.js";import{T as ie}from"./TaskTypeName-C0px4urt.js";import{V as oe}from"./ValidationTag-Cx26FfxH.js";import"./PlaylistPlayer-ByYDRf10.js";import"./ComboboxSimple-B2TmvsnK.js";import"./ModalFooter-Chk0SGv-.js";import"./TextField-BKWlN2Ov.js";import"./video-Yn96Kb74.js";import"./clipboard-CQqgyZ_h.js";import"./dom-tO7tlkHV.js";import"./ComboboxStyled-BlKJF8gk.js";import"./DeleteModal-DwXK5r5w.js";import"./index-Bnig1aiX.js";import"./BaseModal-D3KB-h7q.js";import"./ComboboxDepartment-Cjj8YvK6.js";import"./DepartmentName-DCchDYyW.js";import"./ComboboxStudio-D3qg68ZP.js";import"./play-DUQ3D5JY.js";import"./render-DYxr_jus.js";import"./string-B0Tq569e.js";import"./EmojiButton-CJhEAvTS.js";import"./FileUpload-GCzHM4-i.js";import"./ConfirmModal-BIIMruUl.js";import"./triangle-alert-CW28Rlrw.js";import"./thumbs-up-UCZcudrF.js";import"./copy-DgQ7ppWI.js";import"./vue.esm-bundler-pS9-uSLU.js";import"./VideoViewer-B89y-Tko.js";import"./csv-IlynXFQz.js";import"./BuildFilterModal-C18AF9bI.js";import"./ComboboxBoolean-DT116Lfu.js";import"./DeleteEntities-5LkT8YiQ.js";import"./HardDeleteModal-BLE4oONO.js";import"./SearchField-BdP8lRoc.js";import"./corner-right-up-xDF204hE.js";const ne={name:"production-news-feed",mixins:[J],components:{ButtonSimple:K,Combobox:Q,ComboboxStatus:X,ComboboxTaskType:Y,DateField:Z,EntityThumbnail:H,PeopleAvatar:j,PeopleField:ee,PreviewPlayer:te,ProductionName:q,TaskTypeName:ie,ValidationTag:oe,Spinner:$,TaskInfo:se},data(){return{after:null,before:null,currentNewsId:null,currentPage:1,currentTask:null,episodeId:"",isFiltersDisplayed:!1,isStatsDisplayed:!1,errors:{news:!1},loading:{more:!1,news:!1,currentTask:!0},person:null,previewMode:"comments",previewOptions:[{label:this.$t("news.only_comments"),value:"comments"},{label:this.$t("news.only_previews"),value:"previews"}],taskStatusId:"",taskTypeId:""}},mounted(){this.$options.silent=!0,this.previewMode=localStorage.getItem("news:preview-mode")||"comments",this.taskTypeId=localStorage.getItem("news:task-type-id")||"",this.$route&&this.$route.query&&this.$route.query.task_type_id&&(this.taskTypeId=this.$route.query.task_type_id),this.taskStatusId=localStorage.getItem("news:task-status-id")||"",this.$route&&this.$route.query&&this.$route.query.task_status_id&&(this.taskStatusId=this.$route.query.task_status_id),this.before=null,this.after=null,this.$options.silent=!1,window.addEventListener("keydown",this.onKeyDown,!1),this.loading.news||this.init()},beforeUnmount(){window.removeEventListener("keydown",this.onKeyDown)},computed:{...G(["currentProduction","isTVShow","newsList","newsTotal","newsStats","newsListByDay","personMap","productionMap","productionTaskStatuses","productionTaskTypes","runningEpisodes","taskStatusMap","taskTypeMap","taskStatusMap","user"]),statMax(){return this.newsStats?Object.keys(this.newsStats).reduce((e,t)=>Math.max(this.newsStats[t],e),0):0},isStudio(){return!this.$route.path.includes("productions")},params(){return{isStudio:this.isStudio||void 0,productionId:this.isStudio?void 0:this.currentProduction?.id,only_preview:this.previewMode==="previews",page_size:this.previewMode==="previews"?6:50,task_type_id:this.taskTypeId!==""?this.taskTypeId:void 0,task_status_id:this.taskStatusId!==""?this.taskStatusId:void 0,person_id:this.person?this.person.id:void 0,page:this.currentPage,episode_id:this.episodeId!=="all"?this.episodeId:void 0,before:N(this.before,this.timezone),after:N(this.after,this.timezone)}},taskStatusList(){return[{id:"",color:"#999",short_name:this.$t("news.all")}].concat(V([...this.productionTaskStatuses]))},taskTypeList(){return[{id:"",color:"#999",name:this.$t("news.all")}].concat(V([...this.productionTaskTypes]))},runningEpisodeOptions(){return[{value:"all",label:this.$t("news.all")}].concat(this.runningEpisodes.map(e=>({label:e.name,value:e.id})))},team(){return W(this.currentProduction?.team.map(e=>this.personMap.get(e)).filter(Boolean)??[])},renderedStats(){return this.newsStats?Object.keys(this.newsStats).map(e=>{const{color:t,short_name:d}=this.taskStatusMap.get(e);return{id:e,name:d.toUpperCase(),color:t,value:this.newsStats[e]}}).sort((e,t)=>t.value-e.value):""}},methods:{...A(["loadNews","loadSingleNews","loadMoreNews","loadTask"]),onKeyDown(e){if(this.newsList&&this.newsList.length>0&&e.altKey){let t=this.lastSelection?this.lastSelection:0;[37,38].includes(e.keyCode)?(t=t-1<0?this.newsList.length-1:t-1,this.onNewsSelected(this.newsList[t])):[39,40].includes(e.keyCode)&&(t=t+1>=this.newsList.length?0:t+1,this.onNewsSelected(this.newsList[t]))}},loadFollowingNews(){!this.loading.more&&!this.loading.news&&(this.loading.more=!0,this.currentPage+=1,this.loadMoreNews(this.params).then(()=>{this.loading.more=!1}))},formatDay(e){return x.tz(e,"UTC").tz(this.timezone).format("LL")},formatTime(e){return x.tz(e,"UTC").tz(this.timezone).format("HH:mm")},personName(e){const t=this.personMap.get(e.author_id);return t?t.full_name:""},buildTaskFromNews(e){return{id:e.task_id,task_status_id:e.task_status_id,task_type_id:e.task_type_id,episode_id:e.episode_id}},buildTaskTypeFromNews(e){return{...this.taskTypeMap.get(e.task_type_id),episode_id:e.episode_id}},onNewsSelected(e){this.loading.currentTask=!0;const t=this.newsList.findIndex(d=>d.id===e.id);this.lastSelection!==t?(this.lastSelection=t,this.loadTask({taskId:e.task_id}).then(d=>{this.loading.currentTask=!1,this.currentTask=d,this.currentNewsId=e.id}).catch(console.error),this.scrollToLine(e)):(this.lastSelection=-1,this.currentTask=null,this.currentNewsId="")},scrollToLine(e){const t=this.$refs[`news-${e.id}`];if(t&&this.$refs.body){const m=t[0].getBoundingClientRect(),i=this.$refs.body.getBoundingClientRect(),n=m.bottom>i.bottom-30,w=m.top<i.top+30;if(n){const _=m.bottom-i.bottom+30;this.setScrollPosition(this.$refs.body.scrollTop+_)}else if(w){const _=i.top-m.top+30;this.setScrollPosition(this.$refs.body.scrollTop-_)}}},setScrollPosition(e){this.$refs.body&&(this.$refs.body.scrollTop=e)},init(){if(!this.loading.news&&!this.$options.silent){this.currentPage=1,this.loading.news=!0,this.errors.news=!1,this.currentTask=null;const e={task_status_id:this.params.task_status_id,task_type_id:this.params.task_type_id};this.$router&&this.$router.push({query:e}),this.loadNews(this.params).then(()=>{this.loading.news=!1}).catch(t=>{console.error(t),this.loading.news=!1,this.errors.news=!0})}},onBodyScroll(e){if(!this.$refs.body)return;const t=e.target;this.$refs.body.scrollHeight-this.$refs.body.offsetHeight<t.scrollTop+200&&this.loadFollowingNews()},getPreviewPath(e){const t=e.preview_file_id,d=e.preview_file_extension;return`/api/pictures/originals/preview-files/${t}.${d}`},getPreviewDlPath(e){return`/api/pictures/originals/preview-files/${e.preview_file_id}/download`},hasRetakeValue(e){const t=this.taskStatusMap.get(e.task_status_id);return t?e.change&&t.is_retake:!1},hasDoneValue(e){const t=this.taskStatusMap.get(e.task_status_id);return t?e.change&&t.is_done:!1},toggleFilters(){this.isFiltersDisplayed=!this.isFiltersDisplayed},toggleStats(){this.isStatsDisplayed=!this.isStatsDisplayed}},socket:{events:{"preview-file:add-file"(e){const t=e.comment_id,d=e.preview_file_id,m=e.extension;this.$store.commit("NEWS_ADD_PREVIEW",{previewId:d,commentId:t,extension:m})},"news:new"(e){e.project_id===this.currentProduction.id&&(!this.taskTypeId||this.taskTypeId===e.task_type_id)&&(!this.taskStatusId||this.taskStatusId===e.task_status_id)&&this.loadSingleNews({productionId:this.currentProduction.id,newsId:e.news_id})},"task:update"(e){const t=this.newsList.find(d=>d.task_id===e.task_id);t&&this.loadSingleNews({productionId:this.currentProduction.id,newsId:t.id})}}},watch:{currentProduction(){this.init()},previewMode(){localStorage.setItem("news:preview-mode",this.previewMode),this.init()},taskTypeId(){localStorage.setItem("news:task-type-id",this.taskTypeId),this.init()},taskStatusId(){localStorage.setItem("news:task-status-id",this.taskStatusId),this.init()},person(){this.init()},before(){this.init()},after(){this.init()},$route(){this.init()},episodeId(){this.init()}},head(){return this.currentProduction?{title:`${this.currentProduction.name} | ${this.$t("news.title")} - Kitsu`}:{title:`${this.$t("news.title")} - Kitsu`}}},re={class:"columns fixed-page"},ae={class:"column main-column"},le={class:"timeline-wrapper"},de={class:"has-text-right filler filter-button"},pe={class:"filters flexrow"},ue={class:"flexrow-item selector"},ce={class:"label person-label"},me={key:0,class:"filters flexrow mt1"},he={class:"timeline"},_e={key:0,class:"empty-list has-text-centered"},fe={key:1,class:"has-text-centered mt2"},ke={class:"has-text-centered subtitle timeline-entry"},we={key:0},ye=["onClick"],ge={class:"date flexrow-item"},ve={key:0,class:"flexrow-item production-name-wrapper"},be={class:"flexrow-item task-type-wrapper"},Se={class:"flexrow-item validation-wrapper"},Te={class:"flexrow-item comment-content"},Ie={class:"news-info flexrow"},xe={class:"flexrow-item flexrow"},Ve={class:"strong ml05"},Ne={key:1,class:"preview"},Me=["onClick"],Pe={class:"date flexrow-item"},De={class:"flexrow-item task-type-wrapper"},Ce={class:"flexrow-item comment-content"},Fe={class:"news-info flexrow"},Le={class:"flexrow-item flexrow"},Be={class:"strong ml05 flexrow-item"},ze={key:0,class:"has-text-centered"},Ee={id:"side-column",class:"column side-column"};function Re(e,t,d,m,i,n){const w=p("button-simple"),_=p("combobox"),M=p("combobox-status"),P=p("combobox-task-type"),D=p("people-field"),y=p("date-field"),C=p("spinner"),F=p("production-name"),g=p("people-avatar"),v=p("task-type-name"),L=p("validation-tag"),b=p("entity-thumbnail"),B=p("preview-player"),z=p("task-info");return a(),u("div",re,[o("div",ae,[o("div",{class:"news page",ref:"body",onScrollPassive:t[7]||(t[7]=(...r)=>n.onBodyScroll&&n.onBodyScroll(...r))},[o("div",le,[o("div",de,[l(w,{icon:"filter",active:i.isFiltersDisplayed,title:e.$t("main.more_filters"),onClick:n.toggleFilters},null,8,["active","title","onClick"])]),o("div",pe,[e.isTVShow?(a(),f(_,{key:0,class:"flexrow-item selector",label:e.$t("shots.fields.episode"),options:n.runningEpisodeOptions,modelValue:i.episodeId,"onUpdate:modelValue":t[0]||(t[0]=r=>i.episodeId=r)},null,8,["label","options","modelValue"])):c("",!0),l(M,{class:"flexrow-item selector",label:e.$t("news.task_status"),"task-status-list":n.taskStatusList,modelValue:i.taskStatusId,"onUpdate:modelValue":t[1]||(t[1]=r=>i.taskStatusId=r)},null,8,["label","task-status-list","modelValue"]),l(P,{class:"flexrow-item selector",label:e.$t("news.task_type"),"task-type-list":n.taskTypeList,modelValue:i.taskTypeId,"onUpdate:modelValue":t[2]||(t[2]=r=>i.taskTypeId=r)},null,8,["label","task-type-list","modelValue"]),o("div",ue,[o("label",ce,h(e.$t("main.person")),1),l(D,{class:"person-field",people:n.team,small:"",modelValue:i.person,"onUpdate:modelValue":t[3]||(t[3]=r=>i.person=r)},null,8,["people","modelValue"])])]),i.isFiltersDisplayed?(a(),u("div",me,[l(y,{class:"flexrow-item","max-date":e.today,label:e.$t("main.from"),"with-margin":!1,modelValue:i.after,"onUpdate:modelValue":t[4]||(t[4]=r=>i.after=r)},null,8,["max-date","label","modelValue"]),l(y,{class:"flexrow-item","max-date":e.today,label:e.$t("main.to"),"with-margin":!1,modelValue:i.before,"onUpdate:modelValue":t[5]||(t[5]=r=>i.before=r)},null,8,["max-date","label","modelValue"]),l(_,{class:"flexrow-item selector",label:e.$t("news.infos"),options:i.previewOptions,modelValue:i.previewMode,"onUpdate:modelValue":t[6]||(t[6]=r=>i.previewMode=r)},null,8,["label","options","modelValue"])])):c("",!0),o("div",he,[!i.loading.news&&(!e.newsList||e.newsList.length===0)?(a(),u("div",_e,h(e.$t("news.no_news")),1)):c("",!0),i.loading.news?(a(),u("div",fe,[l(C)])):c("",!0),i.loading.news?c("",!0):(a(!0),u(S,{key:2},T(e.newsListByDay(e.timezone),r=>(a(),u("div",{key:r.length>0?r[0].created_at:""},[o("div",ke,[t[8]||(t[8]=o("span",{class:"big-dot"},null,-1)),O(" "+h(r.length>0?n.formatDay(r[0].created_at):""),1)]),(a(!0),u(S,null,T(r,(s,E)=>(a(),u("div",{key:"news-"+s.id,ref_for:!0,ref:"news-"+s.id},[i.previewMode==="comments"?(a(),u("div",we,[o("div",{class:k({"news-line":!0,"timeline-entry":!0,flexrow:!0,selected:s.id===i.currentNewsId}),onClick:I(R=>n.onNewsSelected(s),["prevent"])},[o("span",{class:k({dot:!0,red:n.hasRetakeValue(s),green:n.hasDoneValue(s)})},null,2),o("span",ge,h(n.formatTime(s.created_at)),1),n.isStudio?(a(),u("div",ve,[l(F,{production:e.productionMap.get(s.project_id),"only-avatar":""},null,8,["production"])])):c("",!0),e.personMap.get(s.author_id)?(a(),f(g,{key:1,class:"flexrow-item",person:e.personMap.get(s.author_id),size:30,"font-size":14,"is-link":!1},null,8,["person"])):c("",!0),o("div",be,[l(v,{class:"task-type-name","task-type":n.buildTaskTypeFromNews(s),"production-id":s.project_id,"is-static":!0},null,8,["task-type","production-id"])]),o("div",Se,[l(L,{class:"validation-tag",task:n.buildTaskFromNews(s),"is-static":!0,thin:!s.change},null,8,["task","thin"])]),o("div",Te,[o("div",Ie,[o("span",xe,[l(b,{class:"ml1 entity-thumbnail mr1 flexrow-item",entity:{id:s.task_entity_id,preview_file_id:s.entity_preview_file_id},"with-link":!1},null,8,["entity"]),o("span",Ve,h(s.full_entity_name),1)])])])],10,ye)])):c("",!0),s.preview_file_id&&i.previewMode==="previews"?(a(),u("div",Ne,[o("div",{class:k({"news-line":!0,"timeline-entry":!0,flexrow:!0,selected:s.id===i.currentNewsId}),onClick:I(R=>n.onNewsSelected(s),["prevent"])},[o("span",{class:k({dot:!0,red:n.hasRetakeValue(s),green:n.hasDoneValue(s)})},null,2),o("span",Pe,h(n.formatTime(s.created_at)),1),e.personMap.get(s.author_id)?(a(),f(g,{key:0,class:"flexrow-item",person:e.personMap.get(s.author_id),size:30,"no-link":!0},null,8,["person"])):c("",!0),o("div",De,[l(v,{class:"task-type-name","task-type":n.buildTaskTypeFromNews(s),"production-id":s.project_id},null,8,["task-type","production-id"])]),o("div",Ce,[o("div",Fe,[o("span",Le,[s.entity_preview_file_id?(a(),f(b,{key:0,class:"ml1",entity:{id:s.task_entity_id,preview_file_id:s.entity_preview_file_id},"with-link":!1},null,8,["entity"])):c("",!0),o("span",Be,h(s.full_entity_name),1)])])])],10,Me),i.previewMode==="previews"?(a(),u("div",ze,[l(B,{"canvas-id":`annotation-canvas-${r[0].created_at.substring(0,10)}-${E}`,previews:s.preview_files,task:{id:s.task_id,project_id:s.project_id,task_type_id:s.task_type_id,assignees:[]},"read-only":!0,light:!0,big:!0},null,8,["canvas-id","previews","task"])])):c("",!0)])):c("",!0)]))),128))]))),128))])])],544)]),o("div",Ee,[l(z,{task:i.currentTask,"is-loading":i.loading.currentTask,"with-actions":""},null,8,["task","is-loading"])])])}const Nt=U(ne,[["render",Re],["__scopeId","data-v-31295afb"]]);export{Nt as default};
//# sourceMappingURL=ProductionNewsFeed-Dlr8YtXj.js.map
