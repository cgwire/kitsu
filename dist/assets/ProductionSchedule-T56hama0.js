import{cj as ae,ck as le,cl as N,aP as R,aE as O,p as X,cm as oe,k as M,o as u,w as de,e as c,f as h,ai as F,d as S,b as $,ac as ee,af as re,ad as ue,_ as ce,m as he,a as me,bT as pe,ce as fe,u as ge,Q as ye,aG as _e,aF as De,ao as ve,ak as Se,cn as ke,K as be,Z as Ve,$ as Te,aI as Ee,b9 as we,B as Pe,r as v,c as m,t as b,F as x,g as A,G as Q,a7 as Me,bL as D,bS as L,co as B,cp as Ie,A as C,cq as z,a3 as xe,cr as G,cs as Ce,M as Ye,ct as Ae,b$ as H,cu as Oe,a2 as Z,aJ as J,bR as Be}from"./index-qtxoT1kv.js";import{B as Ue}from"./BaseModal-rMDujnTR.js";import{G as Le}from"./grip-vertical-B3Im8axW.js";/**
 * @license lucide-vue-next v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=ae("list-restart",[["path",{d:"M21 5H3",key:"1fi0y6"}],["path",{d:"M7 12H3",key:"13ou7f"}],["path",{d:"M7 19H3",key:"wbqt3n"}],["path",{d:"M12 18a5 5 0 0 0 9-3 4.5 4.5 0 0 0-4.5-4.5c-1.33 0-2.54.54-3.41 1.41L11 14",key:"qth677"}],["path",{d:"M11 10v4h4",key:"172dkj"}]]),Fe={__name:"EditScheduleVersionModal",props:{isError:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},scheduleVersionToEdit:{type:Object,required:!0},version:{type:String,required:!0},versionOptions:{type:Array,required:!0}},emits:["cancel","confirm"],setup(e,{emit:s}){const a=e,o=s,{t}=le(),n=N({id:null,name:"",locked:"false",version:a.version||""}),d=N({name:!1}),k=R(null),I=R(null),f=O(()=>!!a.scheduleVersionToEdit?.id),V=O(()=>!!n.name&&!d.name),_=O(()=>f.value?t("schedule.edit_version"):t("schedule.create_version")),T=O(()=>[{label:t("schedule.fields.new"),value:"new",separator:!0},{label:`${t("schedule.versions.from")} ${t("schedule.versions.reference")}`,value:"ref",separator:!0},...a.versionOptions.filter(i=>!i.canceled).sort(X.firstBy("created_at")).map(i=>({label:`${t("schedule.versions.from")} ${i.name}`,value:i.id}))]);function E(i){if(d.name=!1,!i||a.scheduleVersionToEdit.name===i)return;a.versionOptions.map(y=>y.name).includes(i)&&(d.name=!0)}function w(){if(!V.value)return;const i={id:a.scheduleVersionToEdit.id??null,name:n.name,locked:n.locked==="true",version:n.version};o("confirm",i)}return oe(()=>{n.id=a.scheduleVersionToEdit.id||null,n.name=a.scheduleVersionToEdit.name||"",n.locked=a.scheduleVersionToEdit.locked?"true":"false",n.version=a.version||"new",f.value?I.value?.focus():k.value?.focus()}),(i,r)=>(u(),M(Ue,{active:"",title:_.value,onCancel:r[5]||(r[5]=y=>i.$emit("cancel"))},{default:de(()=>[c("form",{onSubmit:r[3]||(r[3]=F(()=>{},["prevent"]))},[f.value?S("",!0):(u(),M($,{key:0,ref_key:"versionCombobox",ref:k,label:i.$t("schedule.fields.create_from_version"),options:T.value,modelValue:n.version,"onUpdate:modelValue":r[0]||(r[0]=y=>n.version=y)},null,8,["label","options","modelValue"])),h(ee,{ref_key:"nameField",ref:I,label:i.$t("schedule.fields.name"),"error-text":i.$t("schedule.edit_version_exist"),errored:d.name,maxlength:20,onEnter:w,"onUpdate:modelValue":[E,r[1]||(r[1]=y=>n.name=y)],modelValue:n.name,modelModifiers:{trim:!0}},null,8,["label","error-text","errored","modelValue"]),f.value?(u(),M(re,{key:1,label:i.$t("schedule.fields.locked"),modelValue:n.locked,"onUpdate:modelValue":r[2]||(r[2]=y=>n.locked=y)},null,8,["label","modelValue"])):S("",!0)],32),h(ue,{"error-text":i.$t("schedule.edit_version_error"),"is-error":e.isError,"is-loading":e.isLoading,"is-disabled":!V.value,onConfirm:w,onCancel:r[4]||(r[4]=y=>i.$emit("cancel"))},null,8,["error-text","is-error","is-loading","is-disabled"])]),_:1},8,["title"]))}},K="prev",U="ref",W=1,qe={name:"production-schedule",components:{ButtonSimple:Pe,Checkbox:we,ChevronDownIcon:Ee,ChevronRightIcon:Te,Combobox:$,ComboboxNumber:Ve,ComboboxTaskType:be,ConfirmModal:ke,DateField:Se,EditScheduleVersionModal:Fe,GripVerticalIcon:Le,HardDeleteModal:ve,ListRestartIcon:ze,PeopleAvatar:De,PeopleName:_e,Schedule:ye,Spinner:ge,TrashIcon:fe,TextField:ee,XIcon:pe},data(){return{assignments:{assigned:!1,entityTypes:null,excludes:[],forcedDailyQuota:null,loading:!1,saving:!1,startDate:null,endDate:null,task:{},type:null,unassign:!1},availableTaskTypes:[],daysOffByPerson:[],draggedEntities:[],endDate:C().add(6,"months").endOf("day"),isSidePanelOpen:!1,scheduleItems:[],startDate:C().startOf("day"),selectedStartDate:null,selectedEndDate:null,selectedTaskType:null,zoomLevel:W,zoomOptions:[{label:this.$t("main.week"),value:0},{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}],mode:K,modeOptions:[{label:this.$t("schedule.mode_prev"),value:"prev"},{label:this.$t("schedule.mode_real"),value:"real"}],scheduleVersionToEdit:{},version:U,loading:{schedule:!1,editScheduleVersion:!1,applyScheduleVersion:!1},errors:{schedule:!1,editScheduleVersion:!1,deleteScheduleVersion:!1,applyScheduleVersion:!1},modals:{editScheduleVersion:!1,deleteScheduleVersion:!1,applyScheduleVersion:!1}}},mounted(){this.reset()},computed:{...me(["currentEpisode","currentProduction","isCurrentUserManager","isCurrentUserSupervisor","isTVShow","organisation","personMap","productionAssetTypes","scheduleVersions","user"]),estimatedDailyQuota(){const e=J(this.assignments.startDate),s=J(this.assignments.endDate),a=Be(e,s),o=this.draggedEntities.reduce((n,d)=>n+(d.children?.length??0),0),t=this.availablePersons.length;return a&&t?o/a/t:0},assetMap(){return Z.cache.assetMap},assets(){return Z.cache.assets},assetTypeMap(){return Oe.cache.assetTypeMap},availablePersons(){const e=this.taskTypeMap.get(this.selectedTaskType.task_type_id);return this.team.filter(s=>!this.assignments.excludes.includes(s.id)&&s.role!=="client"&&(["admin","manager"].includes(s.role)||!s.departments.length||s.departments.includes(e?.department_id)))},currentVersion(){return this.scheduleVersions.find(e=>e.id===this.version)},hasDraggedEntities(){return this.draggedEntities.some(e=>e.children.length)},isLockedSchedule(){return this.mode==="real"||this.currentVersion?.locked||!this.isCurrentUserManager},shotMap(){return H.cache.shotMap},shots(){return H.cache.shots},taskTypeMap(){return Ae.cache.taskTypeMap},team(){return Ye(this.currentProduction.team.map(e=>this.personMap.get(e)).filter(e=>e&&!e.is_bot))},isVersioned(){return this.mode==="prev"&&this.version!=="ref"},versionOptions(){const e=this.scheduleVersions.filter(o=>!o.canceled).sort(X.firstBy("created_at")).map(o=>({label:o.locked?`${o.name} (${this.$t("schedule.versions.locked")})`:o.name,value:o.id})),s=this.scheduleVersions.find(o=>o.id===this.currentProduction.from_schedule_version_id);return[{label:s?`${this.$t("schedule.versions.reference")} (${this.$t("schedule.versions.from")} ${s.name})`:this.$t("schedule.versions.reference"),value:U,separator:!0},...e]}},methods:{...he(["applyScheduleVersionToProduction","assignSelectedTasks","createScheduleVersion","createScheduleVersionedTask","deleteScheduleVersion","editProduction","loadAggregatedPersonDaysOff","loadAssets","loadAssetTypeScheduleItems","loadEpisodeScheduleItems","loadScheduleItems","loadScheduleVersions","loadSequenceScheduleItems","loadShots","loadTasks","loadTasksFromScheduleVersion","saveScheduleItem","unassignPersonFromTask","unassignSelectedTasks","updateScheduleVersion","updateScheduleVersionedTask","updateTask"]),updateRoute({mode:e,version:s,zoom:a}){const o={...this.$route.query};e!==void 0&&(o.mode=e||void 0),s!==void 0&&(o.version=s||void 0),a!==void 0&&(o.zoom=String(a)),JSON.stringify(o)!==JSON.stringify(this.$route.query)&&this.$router.push({query:o})},async loadData(){return this.loading.schedule=!0,this.availableTaskTypes=[],await this.loadScheduleVersions(),this.loadScheduleItems(this.currentProduction).then(e=>{const s=D(this.selectedStartDate),a=D(this.selectedEndDate);e=e.map(o=>{const t=this.taskTypeMap.get(o.task_type_id);let n,d;o.start_date?n=D(o.start_date):n=C(),n.isSameOrAfter(a)&&(n=a.clone().add(-1,"days")),n.isBefore(s)&&(n=s.clone()),o.end_date?d=D(o.end_date):d=n.clone().add(1,"days"),d.isSameOrAfter(a)&&(d=a.clone());const k=G(t.id,this.currentProduction.id,this.currentEpisode?this.currentEpisode.id:null,t.for_entity);return{...o,color:t.color,for_entity:t.for_entity,name:`${t.for_entity} / ${t.name}`,priority:t.priority,startDate:n,endDate:d,editable:this.isInDepartment(t)&&!this.isLockedSchedule,expanded:!1,loading:!1,route:t.for_entity==="Shot"&&this.isTVShow?null:k,children:[]}}),this.scheduleItems=Ce(e,this.currentProduction,this.taskTypeMap),this.availableTaskTypes=this.scheduleItems.map(o=>({...this.taskTypeMap.get(o.task_type_id),name:o.name})),this.loading.schedule=!1}).catch(e=>{console.error(e),this.loading.schedule=!1})},async reset(){this.closeSidePanel(),this.currentProduction.start_date&&(this.startDate=D(this.currentProduction.start_date)),this.currentProduction.end_date&&(this.endDate=D(this.currentProduction.end_date)),this.selectedStartDate=this.startDate.toDate(),this.selectedEndDate=this.endDate.toDate(),await this.loadData();const e=this.$route.query.mode,s=this.$route.query.version,a=Number(this.$route.query.zoom);this.mode=this.modeOptions.map(o=>o.value).includes(e)?e:K,this.version=this.versionOptions.map(o=>o.value).includes(s)?s:U,this.zoomLevel=this.zoomOptions.map(o=>o.value).includes(a)?a:W},convertScheduleItems(e,s){return s.map(a=>{let o;a.start_date?o=D(a.start_date):o=C(),o.isBefore(this.startDate)&&(o=this.startDate.clone()),o.isAfter(this.endDate)&&(o=this.endDate.clone());let t;a.end_date?t=D(a.end_date):t=o.clone().add(1,"days"),t.isBefore(o)&&(t=o.clone().add(1,"days")),t.isAfter(this.endDate)&&(t=this.endDate.clone());const n={...a,startDate:o,endDate:t,expanded:!1,loading:!1,editable:this.isInDepartment(this.taskTypeMap.get(a.task_type_id))&&!this.isLockedSchedule,children:[],parentElement:e};return this.isTVShow&&(n.route=G(a.task_type_id,this.currentProduction.id,a.object_id,e.for_entity)),n})},async expandTaskTypeElement(e,s=null,a=!1,o=!0){if(e.expanded=a||!e.expanded,e.expanded){try{e.loading=!0,this.selectedTaskType=this.isTVShow?null:e,this.assignments.loading=o,e.children=[],e.people={},e.entitiesByType={};const t=this.isTVShow?["Asset","Shot"].includes(e.for_entity)?this.loadEpisodeScheduleItems:this.loadSequenceScheduleItems:e.for_entity==="Shot"?this.loadSequenceScheduleItems:this.loadAssetTypeScheduleItems,n={production:this.currentProduction,taskType:this.taskTypeMap.get(e.task_type_id)},d=await t(n);let k=this.convertScheduleItems(e,d);const I=new Map(k.map(f=>[f.object_id,f]));if(this.isTVShow)e.children=k;else{e.for_entity==="Asset"&&await this.loadAssets({withShared:!1,withTasks:!1}),e.for_entity==="Shot"&&await this.loadShots();let f=await this.loadTasks({project_id:this.currentProduction.id,task_type_id:e.task_type_id,relations:"true"});if(this.isVersioned){const i=this.taskTypeMap.get(e.task_type_id),r=await this.loadTasksFromScheduleVersion({version:{id:this.version},taskType:i}),y=new Map(r.map(g=>[g.task_id,g]));f=f.map(g=>{const p=y.get(g.id);return p?.start_date?{...g,versionedTaskId:p.id,start_date:p.start_date,due_date:p.due_date,estimation:p.estimation,assignees:p.assignees}:null}).filter(Boolean)}const V=[...new Set(f.flatMap(i=>i.assignees))];await this.loadDaysOff(V);const _={},T={};f.forEach(i=>{i.start_date&&(e.for_entity==="Asset"?(i.entity=this.assetMap.get(i.entity_id),i.entity_type_id=i.entity.asset_type_id):e.for_entity==="Shot"?(i.entity=this.shotMap.get(i.entity_id),i.entity_type_id=i.entity.sequence_id):i.entity_type_id=e.for_entity,!i.entity?.canceled&&(_[i.entity_type_id]||(_[i.entity_type_id]={}),i.assignees.length||(i.assignees=["unassigned"]),i.assignees.forEach(r=>{const y=I.get(i.entity_type_id);let g;if(this.mode==="real"){if(!i.real_start_date)return;g=D(i.real_start_date)}else g=D(i.start_date);if(g.isAfter(this.endDate))return;g.isBefore(y.startDate)&&(y.startDate=g.clone()),i.startDate=g;let p;if(this.mode==="real"?p=i.done_date?D(i.done_date):C.tz():i.due_date?p=D(i.due_date):i.end_date?p=D(i.end_date):i.estimation&&(p=B(i.startDate,Math.ceil(z(this.organisation,i.estimation))-1,this.daysOffByPerson[r])),!p||p.isBefore(g)){const Y=g.isoWeekday()===5?3:1;p=g.clone().add(Y,"days")}if(!p.isSameOrAfter(g)){const Y=g.isoWeekday()===5?3:1;p=g.clone().add(Y,"days")}p.isBefore(this.startDate)||(p.isAfter(y.endDate)&&(y.endDate=p.clone()),i.endDate=p,_[i.entity_type_id][r]||(_[i.entity_type_id][r]=[],T[r]=r!=="unassigned"?{...this.personMap.get(r),daysOff:this.daysOffByPerson[r]}:{id:r,avatar:!1,color:"#888",full_name:this.$t("main.unassigned")}),i.editable=!this.isLockedSchedule,i.unresizable=!1,i.parentElement=y,_[i.entity_type_id][r].push(i))})))}),e.for_entity==="Asset"&&(k=k.filter(i=>{const r=this.assetTypeMap.get(i.object_id);return r&&(!r.task_types.length||r.task_types.includes(e.task_type_id))}));const E=([i],[r])=>i==="unassigned"?1:r==="unassigned"?-1:T[i].full_name.localeCompare(T[r].full_name),w=(i,r)=>i.entity?.name.localeCompare(r.entity?.name,void 0,{numeric:!0});k.forEach(i=>{const r=_[i.object_id]||{},y=new Map(Object.entries(r).sort(E).map(([g,p])=>[g,p.sort(w)]));i.children=y}),e.children=xe(k),e.people=T,e.entitiesByType=Object.fromEntries(Object.entries(_).map(([i,r])=>[i,Object.entries(r).flatMap(([y,g])=>y!=="unassigned"?g.map(p=>p.entity_id):void 0).filter(Boolean)]))}}catch(t){console.error(t),e.children=[],e.people=[]}finally{e.loading=!1}s&&s(e),this.selectTaskTypeElement(e,null,o)}},async loadDaysOff(e){this.daysOffByPerson=[];for(const s of e){const a=await this.loadAggregatedPersonDaysOff({personId:s}).catch(()=>[]);this.daysOffByPerson[s]=a}},filteredAssignments(e){return this.assignments.assigned?e:e.filter(s=>!s.assigned)},saveTaskChanged(e){return this.isVersioned?this.updateScheduleVersionedTask({id:e.versionedTaskId,estimation:e.estimation,startDate:e.startDate.format("YYYY-MM-DD"),dueDate:e.endDate.format("YYYY-MM-DD"),assignees:e.assignees}):this.updateTask({taskId:e.id,data:{estimation:e.estimation,start_date:e.startDate.format("YYYY-MM-DD"),due_date:e.endDate.format("YYYY-MM-DD")}})},async onScheduleItemChanged(e){if(e.type==="Task"){const s=e.assignees.flatMap(a=>this.daysOffByPerson[a]).filter(Boolean);e.startDate=B(e.startDate,0,s),e.endDate=B(e.startDate,Math.ceil(z(this.organisation,e.estimation))-1,s),e.startDate.isBefore(e.parentElement.startDate)&&(e.parentElement.startDate=e.startDate.clone(),this.updateScheduleItem(e.parentElement),e.parentElement.startDate.isBefore(e.parentElement.parentElement.startDate)&&(e.parentElement.parentElement.startDate=e.parentElement.startDate.clone(),this.updateScheduleItem(e.parentElement.parentElement))),e.endDate.isAfter(e.parentElement.endDate)&&(e.parentElement.endDate=e.endDate.clone(),this.updateScheduleItem(e.parentElement),e.parentElement.endDate.isAfter(e.parentElement.parentElement.endDate)&&(e.parentElement.parentElement.endDate=e.parentElement.endDate.clone(),this.updateScheduleItem(e.parentElement.parentElement))),await this.saveTaskChanged(e);return}if(e.startDate&&e.endDate&&e.parentElement)e.parentElement.startDate=this.getMinDate(e.parentElement),e.parentElement.endDate=this.getMaxDate(e.parentElement),this.isVersioned||this.saveScheduleItem(e.parentElement);else if(!e.parentElement){const s=this.getMinDate(e),a=this.getMaxDate(e);e.startDate.isAfter(s)&&(e.startDate=s),e.endDate.isBefore(a)&&(e.endDate=a)}await this.updateScheduleItem(e)},async updateScheduleItem(e){const s=this.scheduleItems.find(a=>a===e);s&&(s.startDate=e.startDate,s.start_date=e.startDate.format("YYYY-MM-DD"),s.endDate=e.endDate,s.end_date=e.endDate.format("YYYY-MM-DD")),this.isVersioned||await this.saveScheduleItem(e)},getMinDate(e){let s=this.endDate.clone();return e.children.forEach(a=>{a.startDate&&a.startDate.isBefore(s)&&(s=a.startDate)}),s.clone()},getMaxDate(e){let s=this.startDate.clone();return e.children.forEach(a=>{a.endDate&&a.endDate.isAfter(s)&&(s=a.endDate)}),s.clone()},isInDepartment(e){return this.isCurrentUserManager?!0:this.isCurrentUserSupervisor?this.user.departments.length===0?!0:e.department_id&&this.user.departments.includes(e.department_id):!1},scrollScheduleToToday(){this.$refs.schedule?.scrollToToday()},resetSidePanel(){this.assignments={...this.assignments,entityTypes:null,excludes:[],forcedDailyQuota:null,loading:!1,saving:!1,startDate:null,endDate:null,task:{},type:null,unassign:!1}},toggleSidePanel(){this.isSidePanelOpen&&this.assignments.type==="task"&&(this.assignments.type=null,this.isSidePanelOpen=!1),this.isSidePanelOpen=!this.isSidePanelOpen,this.isSidePanelOpen&&this.assignments.type!=="task"&&!this.assignments.entityTypes&&this.selectedTaskType&&this.selectTaskTypeElement(this.selectedTaskType)},selectParentElement(e){e.expanded?this.selectTaskTypeElement(e):this.expandTaskTypeElement(e,()=>{this.$refs.schedule?.refreshItemPositions(e)})},onSelectTaskType(e){this.selectedTaskType=this.scheduleItems.find(s=>s.task_type_id===e),this.expandTaskTypeElement(this.selectedTaskType,()=>{this.$refs.schedule?.refreshItemPositions(this.selectedTaskType)},!0,!1)},async selectTaskTypeElement(e,s=void 0,a=!0){if(this.isTVShow)return;this.selectedTaskType=e,a&&this.resetSidePanel(),this.assignments.loading=!0;const o=await this.loadTasks({project_id:this.currentProduction.id,task_type_id:this.selectedTaskType.task_type_id,relations:"true"});if(e.for_entity==="Asset")await this.loadAssets({withShared:!1,withTasks:!1}),this.assignments.entityTypes=this.productionAssetTypes.filter(t=>!t.task_types.length||t.task_types.includes(e.task_type_id)).map(t=>({id:t.id,name:t.name,for_entity:e.for_entity,expanded:t.id===s?.object_id,entity_type_id:t.id,children:this.assets.filter(n=>n.asset_type_id===t.id&&!n.canceled&&!n.shared&&o.some(d=>d.entity_id===n.id)).map(n=>({...n,assigned:e.entitiesByType[t.id]?.includes(n.id)}))}));else if(e.for_entity==="Shot"){await this.loadShots();const t=this.shots.filter(n=>o.some(d=>d.entity_id===n.id)).reduce((n,d)=>(n[d.parent_id]||(n[d.parent_id]=[]),d.assigned=e.entitiesByType[d.parent_id]?.includes(d.id),n[d.parent_id].push(d),n),{});this.assignments.entityTypes=Object.keys(t).map(n=>{const d=t[n];return{id:n,name:d[0].sequence_name,for_entity:e.for_entity,expanded:n===s?.object_id,children:d}})}this.assignments.loading=!1},selectTaskElement(e,s,a,o){if(o.length!==1){this.closeSidePanel();return}this.resetSidePanel(),this.isSidePanelOpen=!0,this.selectedTaskType=e,this.draggedEntities=[{...s,children:[{...a.entity}]}],this.assignments.type="task";const t=e.start_date,n=D(t).isAfter(e.end_date)?t:e.end_date;this.assignments.startDate=t,this.assignments.endDate=n,this.assignments.task={...a,estimation:z(this.organisation,a.estimation),startDate:a.startDate.format("YYYY-MM-DD"),endDate:a.endDate.format("YYYY-MM-DD")},this.assignments.excludes=this.team.filter(d=>!a.assignees.includes(d.id)).map(d=>d.id),this.assignments.unassign=!0},closeSidePanel(){this.isSidePanelOpen=!1,this.resetSidePanel()},onAssignmentItemSelected(e){const s=C().utc().toDate();this.assignments.type="entity",this.assignments.startDate=e.start_date||s,this.assignments.endDate=e.end_date||s,e.children=this.filteredAssignments(e.children),this.draggedEntities=[e]},onAssignmentItemDragStart(e,s,a){e.stopPropagation(),e.dataTransfer.dropEffect="move",e.dataTransfer.effectAllowed="move",e.dataTransfer.setData(`task-type-${a.task_type_id}`,!0),e.dataTransfer.setData("taskTypeId",a.task_type_id),e.dataTransfer.setData("entityId",s.id),s.children=this.filteredAssignments(s.children),this.draggedEntities=[s]},onScheduleItemDropped(e,s){this.assignments.type="entity";const a=e.start_date||s.start_date,o=D(a).isAfter(s.end_date)?a:s.end_date;this.assignments.startDate=a,this.assignments.endDate=o},removeFromAssignments(e){this.assignments.excludes.push(e.id)},submitAssignments(){this.assignments.type==="entity"?this.saveAssignments():this.assignments.type==="task"&&this.saveTask()},async saveAssignments(){this.assignments.saving=!0;const e=await this.loadTasks({project_id:this.currentProduction.id,task_type_id:this.selectedTaskType.task_type_id,relations:"true"}),a=1/(this.assignments.forcedDailyQuota??this.estimatedDailyQuota);for(const o of this.draggedEntities){const t=D(this.assignments.startDate),n=D(this.assignments.endDate);let d=0,k=0,I=t.clone();for(const f of o.children){const V=e.find(i=>i.entity_id===f.id);if(!V)continue;let _;this.isVersioned&&(_=(await this.loadTasksFromScheduleVersion({version:{id:this.version},taskType:{id:V.task_type_id}})).find(r=>r.task_id===V.id)??{taskId:V.id,version:this.version,assignees:[]},V.versionedTaskId=_.id),this.assignments.unassign&&(this.isVersioned?_.assignees=[]:await this.unassignSelectedTasks({taskIds:[V.id]})),d++;let T=I,E=null,w=null;for(;k<this.availablePersons.length;){w=this.availablePersons[k],T=B(T,0,this.daysOffByPerson[w.id]);const{due_date:i}=Ie(this.organisation,t,E,d*a,this.daysOffByPerson[w.id]);if(E=D(i),E.isAfter(n))k++,d=1,T=t.clone(),E=null;else{this.isVersioned?(_.startDate=T.format("YYYY-MM-DD"),_.dueDate=E.format("YYYY-MM-DD"),_.estimation=L(this.organisation,a),_.assignees.push(w.id),_.id?await this.updateScheduleVersionedTask(_):await this.createScheduleVersionedTask(_)):await Promise.all([this.assignSelectedTasks({personId:w.id,taskIds:[V.id]}),this.updateTask({taskId:V.id,data:{estimation:L(this.organisation,a),start_date:T.format("YYYY-MM-DD"),due_date:E.format("YYYY-MM-DD")}})]),d*a%1!==0?I=E.clone():I=E.clone().add(1,"days");break}}}this.expandTaskTypeElement(this.selectedTaskType,()=>{this.$refs.schedule?.refreshItemPositions(this.selectedTaskType)},!0,!1)}this.assignments.saving=!1},async saveTask(){this.assignments.saving=!0;try{const e={...this.assignments.task,startDate:D(this.assignments.task.startDate),endDate:D(this.assignments.task.endDate),estimation:L(this.organisation,this.assignments.task.estimation),assignees:this.availablePersons.map(s=>s.id)};await this.onScheduleItemChanged(e),this.isVersioned||(await this.unassignSelectedTasks({taskIds:[e.id]}),await Promise.all(e.assignees.map(s=>this.assignSelectedTasks({personId:s,taskIds:[e.id]})))),this.assignments.task.startDate=e.startDate.format("YYYY-MM-DD"),this.assignments.task.endDate=e.endDate.format("YYYY-MM-DD"),this.expandTaskTypeElement(this.selectedTaskType,()=>{this.$refs.schedule?.refreshItemPositions(this.selectedTaskType)},!0,!1)}catch(e){console.error(e)}finally{this.assignments.saving=!1}},async onScheduleItemAssigned(e,s){if(e.assignees.push(s),e.parentElement.children.get(s).push(e),this.isVersioned)return this.updateScheduleVersionedTask({id:e.versionedTaskId,assignees:e.assignees});await this.assignSelectedTasks({personId:s,taskIds:[e.id]})},async onScheduleItemUnassigned(e,s){e.assignees=e.assignees.filter(o=>o!==s);const a=e.parentElement.children.get(s);if(a.splice(a.indexOf(e),1),this.isVersioned)return this.updateScheduleVersionedTask({id:e.versionedTaskId,assignees:e.assignees});await this.unassignPersonFromTask({person:{id:s},task:e})},onZoomLevelChanged(e){this.updateRoute({zoom:e})},onModeChanged(e){this.updateRoute({mode:e}),this.closeSidePanel(),this.refreshSchedule()},onVersionChanged(e){this.updateRoute({version:e}),this.closeSidePanel(),this.refreshSchedule()},refreshSchedule(){this.scheduleItems.forEach(e=>{e.expanded&&this.expandTaskTypeElement(e,()=>{this.$refs.schedule?.refreshItemPositions(e)},!0,!1)})},openEditScheduleVersion(e={}){this.scheduleVersionToEdit=e,this.modals.editScheduleVersion=!0},openDeleteScheduleVersion(e){this.scheduleVersionToEdit=this.scheduleVersions.find(({id:s})=>s===e),this.modals.deleteScheduleVersion=!0},async editVersion(e){if(this.modals.editScheduleVersion=!1,e.id)await this.updateScheduleVersion(e);else{const s=await this.createScheduleVersion(e);this.version=s.id,this.onVersionChanged(this.version)}this.scheduleVersionToEdit={}},async deleteVersion(e){this.modals.deleteScheduleVersion=!1,await this.deleteScheduleVersion(e),this.version===e.id&&(this.version=U,this.onVersionChanged(this.version)),this.scheduleVersionToEdit={}},async applyToProduction(){this.loading.applyScheduleVersion=!0,this.errors.applyScheduleVersion=!1;try{await this.applyScheduleVersionToProduction(this.version),this.modals.applyScheduleVersion=!1}catch(e){console.error(e),this.errors.applyScheduleVersion=!0}finally{this.loading.applyScheduleVersion=!1}await this.loadScheduleVersions()}},watch:{selectedStartDate(){this.startDate=D(this.selectedStartDate);const e=this.startDate.format("YYYY-MM-DD");this.currentProduction.start_date&&this.currentProduction.start_date!==e&&this.editProduction({...this.currentProduction,start_date:e})},selectedEndDate(){this.endDate=D(this.selectedEndDate);const e=this.endDate.format("YYYY-MM-DD");this.currentProduction.end_date&&this.currentProduction.end_date!==e&&this.editProduction({...this.currentProduction,end_date:e})},currentProduction(){this.reset()}},head(){return{title:`${this.currentProduction.name} | ${this.$t("schedule.title")} - Kitsu`}}},je={class:"columns fixed-page"},Ne={class:"column main-column"},Re={class:"flexrow project-dates"},Qe={class:"flexrow-item"},Ge={class:"flexrow-item"},He={key:0,class:"flexrow-item ml1"},Ze={class:"label"},Je={class:"flexrow"},Ke={class:"flexrow",style:{"margin-top":"23px"}},We={key:0,class:"column side-column"},Xe={class:"side"},$e={class:"mt1"},es={class:"details"},ss={key:0,class:"mt2"},ts={key:1,class:"assignments parent mt1"},ns=["onDragstart","onClick"],is={class:"name"},as=["onClick"],ls={key:0,class:"assignments children"},os=["onDragstart","onClick"],ds={class:"name"},rs={key:2,class:"assignments mt1"},us={class:"flexrow"},cs={class:"flexrow-item"},hs={class:"flexrow-item"},ms={key:0},ps={key:1,class:"dragged-items"},fs={class:"assignees"},gs=["title"],ys={key:0},_s={class:"has-text-centered"},Ds={key:1},vs={class:"assignee"},Ss={class:"person"},ks={key:1,class:"flexrow mt2"},bs={class:"mr05"},Vs={key:2,class:"mt2"},Ts={key:3,class:"flexrow mt2"},Es={class:"flexrow-item"},ws={class:"flexrow-item"},Ps={key:4,class:"flexrow mt2"},Ms={class:"mt2 has-text-right"},Is=["disabled","text"];function xs(e,s,a,o,t,n){const d=v("date-field"),k=v("combobox-number"),I=v("combobox"),f=v("button-simple"),V=v("schedule"),_=v("x-icon"),T=v("combobox-task-type"),E=v("spinner"),w=v("grip-vertical-icon"),i=v("chevron-right-icon"),r=v("chevron-down-icon"),y=v("list-restart-icon"),g=v("people-avatar"),p=v("people-name"),Y=v("checkbox"),q=v("text-field"),se=v("trash-icon"),te=v("edit-schedule-version-modal"),ne=v("hard-delete-modal"),ie=v("confirm-modal");return u(),m(x,null,[c("div",je,[c("div",Ne,[c("div",Re,[c("div",Qe,[h(d,{"can-delete":!1,label:e.$t("main.start_date"),utc:"",modelValue:t.selectedStartDate,"onUpdate:modelValue":s[0]||(s[0]=l=>t.selectedStartDate=l)},null,8,["label","modelValue"])]),c("div",Ge,[h(d,{"can-delete":!1,label:e.$t("main.end_date"),utc:"",modelValue:t.selectedEndDate,"onUpdate:modelValue":s[1]||(s[1]=l=>t.selectedEndDate=l)},null,8,["label","modelValue"])]),h(k,{class:"flexrow-item zoom-level nowrap",label:e.$t("schedule.zoom_level"),options:t.zoomOptions,modelValue:t.zoomLevel,"onUpdate:modelValue":[s[2]||(s[2]=l=>t.zoomLevel=l),n.onZoomLevelChanged]},null,8,["label","options","modelValue","onUpdate:modelValue"]),h(I,{class:"flexrow-item ml1",label:e.$t("schedule.mode"),modelValue:t.mode,"onUpdate:modelValue":[s[3]||(s[3]=l=>t.mode=l),n.onModeChanged],options:t.modeOptions},null,8,["label","modelValue","options","onUpdate:modelValue"]),t.mode==="prev"?(u(),m("div",He,[c("label",Ze,b(e.$t("schedule.version")),1),c("div",Je,[h(I,{class:"flexrow-item",modelValue:t.version,"onUpdate:modelValue":[s[4]||(s[4]=l=>t.version=l),n.onVersionChanged],options:n.versionOptions},null,8,["modelValue","options","onUpdate:modelValue"]),h(f,{class:"ml05",icon:"calendar-plus",title:e.$t("schedule.new_version"),onClick:s[5]||(s[5]=l=>n.openEditScheduleVersion())},null,8,["title"]),h(f,{class:"ml05",disabled:t.version==="ref",icon:"pencil",title:e.$t("schedule.edit_version"),onClick:s[6]||(s[6]=l=>n.openEditScheduleVersion(n.currentVersion))},null,8,["disabled","title"]),h(f,{class:"ml05",disabled:t.version==="ref",icon:"trash",title:e.$t("schedule.delete_version"),onClick:s[7]||(s[7]=l=>n.openDeleteScheduleVersion(t.version))},null,8,["disabled","title"])])])):S("",!0),s[29]||(s[29]=c("div",{class:"filler"},null,-1)),c("div",Ke,[!e.isTVShow&&t.mode==="prev"?(u(),M(f,{key:0,class:"flexrow-item",disabled:t.version==="ref",icon:"save",text:e.$t("schedule.apply_to_prod"),onClick:s[8]||(s[8]=l=>t.modals.applyScheduleVersion=!0)},null,8,["disabled","text"])):S("",!0),h(f,{class:"flexrow-item",icon:"clock",text:e.$t("schedule.today"),onClick:n.scrollScheduleToToday},null,8,["text","onClick"]),e.isTVShow?S("",!0):(u(),M(f,{key:1,active:t.isSidePanelOpen&&t.assignments.type!=="task",class:"flexrow-item",disabled:n.isLockedSchedule,icon:"list",text:e.$t("menu.assign_tasks"),onClick:n.toggleSidePanel},null,8,["active","disabled","text","onClick"]))])]),h(V,{ref:"schedule","start-date":t.startDate,"end-date":t.endDate,hierarchy:t.scheduleItems,"zoom-level":t.zoomLevel,"is-loading":t.loading.schedule,"is-error":t.errors.schedule,"is-estimation-linked":"","hide-man-days":"",multiline:e.isTVShow,reassignable:!n.isLockedSchedule,subchildren:!e.isTVShow,type:t.mode,onItemAssign:n.onScheduleItemAssigned,onItemChanged:n.onScheduleItemChanged,onItemDrop:n.onScheduleItemDropped,onItemSelected:n.selectTaskTypeElement,onItemUnassign:n.onScheduleItemUnassigned,onRootElementExpanded:n.expandTaskTypeElement,onRootElementSelected:n.selectParentElement,onTaskSelected:n.selectTaskElement,onTaskUnselected:s[9]||(s[9]=l=>n.closeSidePanel())},null,8,["start-date","end-date","hierarchy","zoom-level","is-loading","is-error","multiline","reassignable","subchildren","type","onItemAssign","onItemChanged","onItemDrop","onItemSelected","onItemUnassign","onRootElementExpanded","onRootElementSelected","onTaskSelected"])]),t.isSidePanelOpen&&!n.isLockedSchedule&&!e.isTVShow?(u(),m("div",We,[c("div",Xe,[c("a",{class:"close-button",onClick:s[10]||(s[10]=(...l)=>n.toggleSidePanel&&n.toggleSidePanel(...l))},[h(_,{class:"align-middle",size:16})]),c("h2",$e,b(t.assignments.type==="task"?e.$t("schedule.edit_task"):e.$t("menu.assign_tasks")),1),c("div",es,[h(T,{class:"mb05","add-placeholder":"",placeholder:e.$t("schedule.select_task_type"),label:e.$t("news.task_type"),"task-type-list":t.availableTaskTypes,"model-value":t.selectedTaskType?.task_type_id,"onUpdate:modelValue":n.onSelectTaskType},null,8,["placeholder","label","task-type-list","model-value","onUpdate:modelValue"]),!t.assignments.loading&&t.assignments.entityTypes?.length&&!t.assignments.type?(u(),M(f,{key:0,class:"mt2 mb05",icon:"user-check","is-on":t.assignments.assigned,title:e.$t("schedule.show_assigned"),onClick:s[11]||(s[11]=l=>t.assignments.assigned=!t.assignments.assigned)},null,8,["is-on","title"])):S("",!0)]),t.assignments.loading?(u(),m("div",ss,[h(E,{class:"mauto",size:20})])):t.assignments.type?(u(),m("div",rs,[c("form",{class:"mt1",onSubmit:s[23]||(s[23]=F(l=>n.submitAssignments(),["prevent"]))},[c("div",us,[c("div",cs,[h(d,{"can-delete":!1,disabled:t.assignments.type!=="entity",label:e.$t("main.start_date"),utc:"",modelValue:t.assignments.startDate,"onUpdate:modelValue":s[12]||(s[12]=l=>t.assignments.startDate=l)},null,8,["disabled","label","modelValue"])]),c("div",hs,[h(d,{"can-delete":!1,disabled:t.assignments.type!=="entity",label:e.$t("main.end_date"),utc:"",modelValue:t.assignments.endDate,"onUpdate:modelValue":s[13]||(s[13]=l=>t.assignments.endDate=l)},null,8,["disabled","label","modelValue"])])]),(u(!0),m(x,null,A(t.draggedEntities,l=>(u(),m("div",{key:l.id},[c("div",{class:"dragged-type",style:Q({background:t.selectedTaskType.color})},b(l.name),5),l.children.length?(u(),m("ul",ps,[(u(!0),m(x,null,A(l.children,P=>(u(),m("li",{class:"dragged-item",key:P.id,style:Q({background:`color-mix(in srgb, ${t.selectedTaskType.color} 40%, transparent)`,"border-left":`4px solid ${t.selectedTaskType.color}`})},b(l.name)+" / "+b(P.name),5))),128))])):(u(),m("div",ms,b(e.$t("schedule.no_entity")),1)),s[30]||(s[30]=c("hr",null,null,-1))]))),128)),c("table",fs,[c("thead",null,[c("tr",null,[c("td",null,[Me(b(e.$t("schedule.assign"))+" ",1),t.assignments.excludes.length?(u(),m("a",{key:0,class:"reset-assignees",title:e.$t("schedule.reset_list"),onClick:s[14]||(s[14]=l=>t.assignments.excludes=[])},[h(y,{class:"align-middle",size:18,"stroke-width":1.5})],8,gs)):S("",!0)])])]),n.availablePersons.length?(u(),m("tbody",Ds,[(u(!0),m(x,null,A(n.availablePersons,l=>(u(),m("tr",{key:l.id},[c("td",vs,[c("div",Ss,[h(g,{"is-link":!1,"font-size":14,person:l,size:28},null,8,["person"]),h(p,{person:l},null,8,["person"])]),h(f,{class:"is-small",icon:"minus",title:e.$t("main.avatar.unassign",{personName:l.name}),type:"button",onClick:P=>n.removeFromAssignments(l)},null,8,["title","onClick"])])]))),128))])):(u(),m("tbody",ys,[c("tr",null,[c("td",_s,b(e.$t("schedule.no_assignee")),1)])]))]),t.assignments.type==="entity"?(u(),M(Y,{key:0,class:"pa05",disabled:!n.availablePersons.length,label:e.$t("schedule.force_unassign"),toggle:!0,modelValue:t.assignments.unassign,"onUpdate:modelValue":s[15]||(s[15]=l=>t.assignments.unassign=l)},null,8,["disabled","label","modelValue"])):S("",!0),t.assignments.type==="entity"?(u(),m("div",ks,[c("label",bs,b(e.$t("schedule.forced_daily_quotas")),1),h(q,{class:"mb0 daily-quotas","input-class":" is-small",step:.01,type:"number",modelValue:t.assignments.forcedDailyQuota,"onUpdate:modelValue":s[16]||(s[16]=l=>t.assignments.forcedDailyQuota=l)},null,8,["modelValue"]),t.assignments.forcedDailyQuota?(u(),m("a",{key:0,class:"reset-quotas ml05",onClick:s[17]||(s[17]=l=>t.assignments.forcedDailyQuota=null)},[h(se,{class:"align-middle",size:14})])):S("",!0)])):S("",!0),t.assignments.type==="entity"?(u(),m("div",Vs,b(e.$t("schedule.estimated_daily_quotas"))+" "+b(n.estimatedDailyQuota.toFixed(2)),1)):S("",!0),t.assignments.type==="task"?(u(),m("div",Ts,[c("div",Es,[h(d,{"can-delete":!1,label:e.$t("main.start_date"),utc:"","with-margin":!1,modelValue:t.assignments.task.startDate,"onUpdate:modelValue":s[18]||(s[18]=l=>t.assignments.task.startDate=l)},null,8,["label","modelValue"])]),c("div",ws,[h(d,{"can-delete":!1,disabled:"",label:e.$t("main.end_date"),utc:"","with-margin":!1,modelValue:t.assignments.task.endDate,"onUpdate:modelValue":s[19]||(s[19]=l=>t.assignments.task.endDate=l)},null,8,["label","modelValue"])])])):S("",!0),t.assignments.type==="task"?(u(),m("div",Ps,[h(q,{class:"mb0 estimation mr05","input-class":" thin",label:e.$t("main.estimation"),step:.01,placeholder:"0.00",type:"number","unit-label":e.$t("schedule.md"),modelValue:t.assignments.task.estimation,"onUpdate:modelValue":s[20]||(s[20]=l=>t.assignments.task.estimation=l)},null,8,["label","unit-label","modelValue"])])):S("",!0),c("div",Ms,[t.assignments.type==="entity"?(u(),m(x,{key:0},[h(f,{disabled:!n.hasDraggedEntities||!n.availablePersons.length,"is-loading":t.assignments.saving,"is-primary":"",text:e.$t("main.apply"),type:"submit"},null,8,["disabled","is-loading","text"]),c("button",{class:"button is-link ml05",disabled:t.assignments.saving,text:e.$t("main.back"),type:"button",onClick:s[21]||(s[21]=l=>t.assignments.type=null)},b(e.$t("main.back")),9,Is)],64)):S("",!0),t.assignments.type==="task"?(u(),m(x,{key:1},[h(f,{disabled:!t.assignments.task.estimation,"is-loading":t.assignments.saving,"is-primary":"",text:e.$t("main.apply"),type:"submit"},null,8,["disabled","is-loading","text"]),c("button",{class:"button is-link ml05",onClick:s[22]||(s[22]=l=>n.closeSidePanel())},b(e.$t("main.cancel")),1)],64)):S("",!0)])],32)])):(u(),m("ul",ts,[(u(!0),m(x,null,A(t.assignments.entityTypes,l=>(u(),m("li",{key:l.id},[c("div",{class:"assignment-item",draggable:"true",onDragstart:P=>n.onAssignmentItemDragStart(P,l,t.selectedTaskType),onClick:P=>n.onAssignmentItemSelected(l)},[h(w,{class:"icon"}),c("span",is,b(l.name)+" ("+b(n.filteredAssignments(l.children).length)+") ",1),c("span",{class:"expand",onClick:F(P=>l.expanded=!l.expanded,["stop"])},[l.expanded?(u(),M(r,{key:1})):(u(),M(i,{key:0}))],8,as)],40,ns),l.expanded?(u(),m("ul",ls,[(u(!0),m(x,null,A(n.filteredAssignments(l.children),P=>(u(),m("li",{key:P.id},[c("div",{class:"assignment-item",draggable:"true",onDragstart:j=>n.onAssignmentItemDragStart(j,{...l,children:[P]},t.selectedTaskType),onClick:j=>n.onAssignmentItemSelected({...l,children:[P]})},[h(w,{class:"icon"}),c("span",ds,b(P.name),1)],40,os)]))),128))])):S("",!0)]))),128))]))])])):S("",!0)]),t.modals.editScheduleVersion?(u(),M(te,{key:0,"schedule-version-to-edit":t.scheduleVersionToEdit,version:t.version,"version-options":e.scheduleVersions,"is-loading":t.loading.editScheduleVersion,"is-error":t.errors.editScheduleVersion,onCancel:s[24]||(s[24]=l=>t.modals.editScheduleVersion=!1),onConfirm:n.editVersion},null,8,["schedule-version-to-edit","version","version-options","is-loading","is-error","onConfirm"])):S("",!0),t.modals.deleteScheduleVersion?(u(),M(ne,{key:1,active:"","error-text":e.$t("schedule.delete_version_error"),"is-loading":t.loading.delete,"is-error":t.errors.deleteScheduleVersion,"lock-text":t.scheduleVersionToEdit?.name,text:e.$t("schedule.delete_version_message",{name:t.scheduleVersionToEdit?.name}),onCancel:s[25]||(s[25]=l=>t.modals.deleteScheduleVersion=!1),onConfirm:s[26]||(s[26]=l=>n.deleteVersion(t.scheduleVersionToEdit))},null,8,["error-text","is-loading","is-error","lock-text","text"])):S("",!0),t.modals.applyScheduleVersion?(u(),M(ie,{key:2,active:"",text:e.$t("schedule.apply_to_prod_confirm"),"error-text":e.$t("schedule.apply_to_prod_error"),"is-loading":t.loading.applyScheduleVersion,"is-error":t.errors.applyScheduleVersion,onCancel:s[27]||(s[27]=l=>t.modals.applyScheduleVersion=!1),onConfirm:s[28]||(s[28]=l=>n.applyToProduction())},null,8,["text","error-text","is-loading","is-error"])):S("",!0)],64)}const Os=ce(qe,[["render",xs],["__scopeId","data-v-a58fd2c7"]]);export{K as DEFAULT_MODE,U as DEFAULT_VERSION,W as DEFAULT_ZOOM,Os as default};
//# sourceMappingURL=ProductionSchedule-T56hama0.js.map
