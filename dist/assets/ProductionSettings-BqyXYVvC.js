import{_ as v,m as E,a as P,b as M,ah as N,r as c,c as r,o as a,d as p,f as u,e as s,t as l,F as S,g as $,a8 as X,aT as x,bT as G,k as T,B as j,ad as Z,af as tt,al as et,aq as st,ag as ot,aM as L,aL as U,cH as R,ck as it,j as at,aj as nt,l as w,n as g,Q as z,cI as rt,cJ as lt,aJ as dt,bH as ut,q as ct,bN as V,aC as C,C as mt,b9 as pt,U as ht,cK as H,L as _t,ab as ft,cL as kt,cM as O,a7 as yt,a4 as q,w as F,K as bt,a2 as I}from"./index-DxngxtIo.js";import{B as Tt}from"./BooleanCell-CKTtFe72.js";import{P as gt}from"./ProductionBrief-Dy1BBnT8.js";import{T as vt}from"./TaskStatusCell-Bs4R4jAv.js";import{S as Pt}from"./StatusAutomationList-t1PFt--i.js";import{G as J}from"./grip-vertical-BvQE7BoX.js";const wt={name:"production-backgrounds",components:{BooleanField:N,Combobox:M},data(){return{selectedBackgroundId:null}},computed:{...P(["backgrounds","currentProduction","productionBackgrounds"]),remainingBackgrounds(){return this.backgrounds.filter(({id:t})=>!this.currentProduction.preview_background_files.includes(t))},remainingBackgroundsOptions(){return this.remainingBackgrounds.map(t=>({label:t.name,value:t.id}))}},methods:{...E(["addBackgroundToProduction","removeBackgroundFromProduction","setDefaultBackgroundToProduction"]),addBackground(){this.addBackgroundToProduction(this.selectedBackgroundId)},removeBackground(t){this.removeBackgroundFromProduction(t)},resetSelection(){this.selectedBackgroundId=this.remainingBackgrounds[0]?.id||""},isGlobalDefaultBackground(t){return t.is_default&&this.isCurrentDefaultBackground(t)},isCurrentDefaultBackground(t){const e=this.currentProduction.default_preview_background_file_id;return e?t.id===e:t.is_default},setDefaultBackground(t,e){this.setDefaultBackgroundToProduction(e?t.id:null)}},watch:{remainingBackgrounds:{deep:!0,immediate:!0,handler(){this.resetSelection()}}}},St={class:"production-backgrounds"},At={key:0,class:"flexrow mt1 mb1"},It={key:1,class:"box"},Ct={key:2,class:"datatable"},Dt={class:"datatable-head"},Vt={class:"name"},$t={class:"is-default"},Et={class:"datatable-body"},Bt={class:"name"},Ft={class:"flexrow"},Lt=["href"],Ut=["src","alt"],Rt={class:"is-default"},Ot=["onClick"];function qt(t,e,n,_,i,o){const f=c("combobox"),y=c("boolean-field");return a(),r("div",St,[o.remainingBackgrounds?.length?(a(),r("div",At,[u(f,{class:"flexrow-item mb0",options:o.remainingBackgroundsOptions,modelValue:i.selectedBackgroundId,"onUpdate:modelValue":e[0]||(e[0]=d=>i.selectedBackgroundId=d)},null,8,["options","modelValue"]),s("button",{class:"button flexrow-item",onClick:e[1]||(e[1]=(...d)=>o.addBackground&&o.addBackground(...d))},l(t.$t("main.add")),1)])):p("",!0),t.currentProduction.preview_background_files?.length?(a(),r("table",Ct,[s("thead",Dt,[s("tr",null,[s("th",Vt,l(t.$t("backgrounds.fields.name")),1),s("th",$t,l(t.$t("backgrounds.fields.is_default")),1),e[2]||(e[2]=s("th",{class:"actions"},null,-1))])]),s("tbody",Et,[(a(!0),r(S,null,$(t.productionBackgrounds,d=>(a(),r("tr",{class:"datatable-row",key:d.id},[s("td",Bt,[s("span",Ft,[s("a",{class:"thumbnail-wrapper thumbnail-picture entity-thumbnail flexrow-item",href:d.url,target:"_blank"},[s("img",{src:d.thumbnail,alt:d.name,width:"100",height:"67"},null,8,Ut)],8,Lt),X(" "+l(d.name),1)])]),s("td",Rt,[u(y,{class:"ml05 mb0",disabled:o.isGlobalDefaultBackground(d),label:t.$t("backgrounds.fields.is_default"),"model-value":String(o.isCurrentDefaultBackground(d)),onClick:k=>o.setDefaultBackground(d,k==="true")},null,8,["disabled","label","model-value","onClick"])]),s("td",null,[s("button",{class:"button",onClick:k=>o.removeBackground(d.id)},l(t.$t("main.remove")),9,Ot)])]))),128))])])):(a(),r("div",It,l(t.$t("settings.production.empty_list")),1))])}const Mt=v(wt,[["render",qt],["__scopeId","data-v-3d68c5bb"]]),Nt={name:"production-board",components:{BooleanField:N,ValidationTag:x},data(){return{availableRoles:["user","vendor","supervisor","manager","admin"]}},computed:{...P(["currentProduction","productionTaskStatuses"]),sortedProductionTaskStatuses(){return G([...this.productionTaskStatuses],this.currentProduction)}},methods:{...E(["editTaskStatusLink","loadContext"]),getActiveRoles(t){return this.currentProduction.task_statuses_link[t.id]?.roles_for_board||[]},isActiveRole(t,e){return this.getActiveRoles(t).includes(e)},async updateRolesForBoard(t,e,n=!0){const _=[...this.getActiveRoles(t)];e.forEach(o=>{n&&!this.isActiveRole(t,o)?_.push(o):!n&&this.isActiveRole(t,o)&&_.splice(_.indexOf(o),1)});const i={...this.currentProduction.task_statuses_link[t.id],roles_for_board:_,project_id:this.currentProduction.id,task_status_id:t.id};await this.editTaskStatusLink(i),await this.loadContext()}}},xt={class:"production-board"},Gt={key:0,class:"box"},jt={key:1,class:"datatable"},zt={class:"th-name"},Ht={class:"th-short-name"},Jt={class:"th-roles"},Kt={class:"datatable-body"},Qt={class:"name"},Yt={class:"roles"},Wt=["onClick"],Xt=["onClick"];function Zt(t,e,n,_,i,o){const f=c("validation-tag"),y=c("boolean-field");return a(),r("div",xt,[t.currentProduction.task_statuses?.length?(a(),r("table",jt,[s("thead",null,[s("tr",null,[s("th",zt,l(t.$t("task_status.fields.name")),1),s("th",Ht,l(t.$t("task_status.fields.short_name")),1),s("th",Jt,l(t.$t("board.settings.visible")),1)])]),s("tbody",Kt,[(a(!0),r(S,null,$(o.sortedProductionTaskStatuses,d=>(a(),r(S,null,[d?(a(),r("tr",{class:"datatable-row task-status",key:d.id},[s("td",null,l(d.name),1),s("td",Qt,[u(f,{"is-static":!0,task:{task_status_id:d.id}},null,8,["task"])]),s("td",Yt,[(a(!0),r(S,null,$(i.availableRoles,k=>(a(),T(y,{class:"role-field",key:`${d.id}-${k}`,label:t.$t(`people.role.${k}`),"model-value":String(o.isActiveRole(d,k)),onClick:A=>o.updateRolesForBoard(d,[k],A==="true")},null,8,["label","model-value","onClick"]))),128)),o.getActiveRoles(d).length<i.availableRoles.length?(a(),r("button",{key:0,class:"button",onClick:k=>o.updateRolesForBoard(d,i.availableRoles)},l(t.$t("board.settings.select_all")),9,Wt)):(a(),r("button",{key:1,class:"button",onClick:k=>o.updateRolesForBoard(d,i.availableRoles,!1)},l(t.$t("board.settings.unselect_all")),9,Xt))])])):p("",!0)],64))),256))])])):(a(),r("div",Gt,l(t.$t("settings.production.empty_list")),1))])}const te=v(Nt,[["render",Zt],["__scopeId","data-v-c258ff92"]]),ee={name:"production-parameters",components:{ComboboxBoolean:ot,ComboboxStyled:st,DateField:et,FileUpload:tt,TextField:Z,ButtonSimple:j},emits:["confirm"],data(){return{formData:null,isLoading:!1,isError:!1,isLocalTVShow:!1,productionTypeOptions:it,homepageOptions:R,form:{name:"",code:"",start_date:new Date,end_date:new Date,nb_episodes:0,episode_span:0,fps:"",max_retakes:0,is_clients_isolated:"false",is_preview_download_allowed:"false",is_set_preview_automated:"false",is_publish_default_for_artists:"false",ratio:"",resolution:"",production_type:"short"}}},computed:{...P(["currentProduction","productionAvatarFormData","isTVShow"])},mounted(){this.resetForm()},watch:{currentProduction:{handler(){this.resetForm(),this.updateTvShowRelatedDatas(this.isTVShow)},deep:!0},"form.production_type"(t){this.updateTvShowRelatedDatas(t==="tvshow")}},methods:{...E(["editProduction","storeProductionPicture","uploadProductionAvatar"]),onFileSelected(t){this.formData=t,this.storeProductionPicture(t)},isEmpty(t){return!t||t.length===0},runConfirmation(){this.$emit("confirm",this.form)},updateTvShowRelatedDatas(t){this.isLocalTVShow=t,t&&this.currentProduction?(this.form.nb_episodes=this.currentProduction.nb_episodes,this.form.episode_span=this.currentProduction.episode_span):(this.form.nb_episodes=0,this.form.episode_span=0)},resetForm(){this.$refs.fileField?.reset(),this.storeProductionPicture(null),this.currentProduction?this.form={name:this.currentProduction.name,code:this.currentProduction.code,start_date:U(this.currentProduction.start_date).toDate(),end_date:U(this.currentProduction.end_date).toDate(),production_type:this.currentProduction.production_type||"short",episode_span:this.currentProduction.episode_span,fps:this.currentProduction.fps,max_retakes:this.currentProduction.max_retakes,nb_episodes:this.currentProduction.nb_episodes,is_clients_isolated:this.currentProduction.is_clients_isolated?"true":"false",is_preview_download_allowed:this.currentProduction.is_preview_download_allowed?"true":"false",is_set_preview_automated:this.currentProduction.is_set_preview_automated?"true":"false",is_publish_default_for_artists:this.currentProduction.is_publish_default_for_artists?"true":"false",ratio:this.currentProduction.ratio,resolution:this.currentProduction.resolution,homepage:this.currentProduction.homepage}:this.form={name:"",code:"",start_date:new Date,end_date:new Date,production_type:"short",nb_episodes:0,episode_span:0,max_retakes:0,is_clients_isolated:"false",is_preview_download_allowed:"false",is_set_preview_automated:"false",is_publish_default_for_artists:"false",fps:"",ratio:"",resolution:"",homepage:R[0].value}},async editParameters(){this.isLoading=!0,this.isError=!1;try{this.productionAvatarFormData&&await this.uploadProductionAvatar(this.currentProduction.id),await this.editProduction({...this.form,id:this.currentProduction.id,start_date:L(this.form.start_date),end_date:L(this.form.end_date)})}catch{this.isError=!0}this.isLoading=!1}}},se={class:"columns"},oe={class:"column is-one-third box"},ie={class:"columns"},ae={class:"mr1"},ne={key:9},re={class:"label"},le={key:10,class:"error mt1"},de={class:"has-text-right mt2"};function ue(t,e,n,_,i,o){const f=c("text-field"),y=c("date-field"),d=c("combobox-styled"),k=c("combobox-boolean"),A=c("file-upload"),B=c("button-simple"),b=at("focus");return a(),r("div",se,[s("div",oe,[s("form",{class:"form",onSubmit:e[14]||(e[14]=nt(()=>{},["prevent"]))},[w(u(f,{label:t.$t("productions.fields.name"),onEnter:o.runConfirmation,modelValue:i.form.name,"onUpdate:modelValue":e[0]||(e[0]=m=>i.form.name=m)},null,8,["label","onEnter","modelValue"]),[[b]]),u(f,{label:t.$t("productions.fields.code"),onEnter:o.runConfirmation,modelValue:i.form.code,"onUpdate:modelValue":e[1]||(e[1]=m=>i.form.code=m)},null,8,["label","onEnter","modelValue"]),s("div",ie,[s("div",ae,[u(y,{class:"mb0","can-delete":!1,label:t.$t("productions.fields.start_date"),"max-date":i.form.end_date,"with-margin":!1,modelValue:i.form.start_date,"onUpdate:modelValue":e[2]||(e[2]=m=>i.form.start_date=m)},null,8,["label","max-date","modelValue"])]),s("div",null,[u(y,{class:"mb0","can-delete":!1,label:t.$t("productions.fields.end_date"),"min-date":i.form.start_date,"with-margin":!1,modelValue:i.form.end_date,"onUpdate:modelValue":e[3]||(e[3]=m=>i.form.end_date=m)},null,8,["label","min-date","modelValue"])])]),u(d,{class:"mb2","locale-key-prefix":"productions.type.",label:t.$t("productions.fields.type"),options:i.productionTypeOptions,onEnter:o.runConfirmation,modelValue:i.form.production_type,"onUpdate:modelValue":e[4]||(e[4]=m=>i.form.production_type=m)},null,8,["label","options","onEnter","modelValue"]),t.currentProduction&&t.currentProduction.id?(a(),T(d,{key:0,class:"mb2","locale-key-prefix":"productions.homepage.",label:t.$t("productions.fields.homepage"),options:i.homepageOptions,onEnter:o.runConfirmation,modelValue:i.form.homepage,"onUpdate:modelValue":e[5]||(e[5]=m=>i.form.homepage=m)},null,8,["label","options","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(f,{key:1,type:"number",max:60,step:.001,label:t.$t("productions.fields.fps"),onEnter:o.runConfirmation,modelValue:i.form.fps,"onUpdate:modelValue":e[6]||(e[6]=m=>i.form.fps=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(f,{key:2,label:t.$t("productions.fields.ratio"),onEnter:o.runConfirmation,modelValue:i.form.ratio,"onUpdate:modelValue":e[7]||(e[7]=m=>i.form.ratio=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(f,{key:3,label:t.$t("productions.fields.resolution"),onEnter:o.runConfirmation,modelValue:i.form.resolution,"onUpdate:modelValue":e[8]||(e[8]=m=>i.form.resolution=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(k,{key:4,label:t.$t("productions.fields.is_clients_isolated"),onEnter:o.runConfirmation,modelValue:i.form.is_clients_isolated,"onUpdate:modelValue":e[9]||(e[9]=m=>i.form.is_clients_isolated=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(k,{key:5,label:t.$t("productions.fields.is_preview_download_allowed"),onEnter:o.runConfirmation,modelValue:i.form.is_preview_download_allowed,"onUpdate:modelValue":e[10]||(e[10]=m=>i.form.is_preview_download_allowed=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(k,{key:6,label:t.$t("productions.fields.is_set_preview_automated"),onEnter:o.runConfirmation,modelValue:i.form.is_set_preview_automated,"onUpdate:modelValue":e[11]||(e[11]=m=>i.form.is_set_preview_automated=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(k,{key:7,label:t.$t("productions.fields.is_publish_default"),onEnter:o.runConfirmation,modelValue:i.form.is_publish_default_for_artists,"onUpdate:modelValue":e[12]||(e[12]=m=>i.form.is_publish_default_for_artists=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(f,{key:8,type:"number",step:1,label:t.$t("productions.fields.max_retakes"),onEnter:o.runConfirmation,modelValue:i.form.max_retakes,"onUpdate:modelValue":e[13]||(e[13]=m=>i.form.max_retakes=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),r("div",ne,[s("label",re,l(t.$t("productions.picture")),1),u(A,{ref:"fileField","is-primary":!1,label:t.$t("main.csv.upload_file"),onFileselected:o.onFileSelected,accept:".png,.jpg,.jpeg"},null,8,["label","onFileselected"])])):p("",!0),i.isError?(a(),r("p",le,l(t.$t("productions.edit_error")),1)):p("",!0),s("div",de,[u(B,{"is-primary":!0,class:g({"is-loading":i.isLoading}),disabled:i.isLoading,text:t.$t("main.save"),onClick:o.editParameters},null,8,["class","disabled","text","onClick"])])],32)])])}const ce=v(ee,[["render",ue],["__scopeId","data-v-2784be8e"]]),me={name:"status-automation-item",components:{TaskStatusCell:vt,TaskTypeName:z},props:{statusAutomation:{type:Object,default:null},productionId:{type:String,default:null},deletable:{type:Boolean,default:!1}},computed:{...P(["isCurrentUserClient","getTaskStatus","getTaskType"]),statusAutomationPath(){const t={name:"status-automation",params:{production_id:this.productionId,status_automation_id:this.statusAutomation.id,type:rt(this.statusAutomation.for_entity)}};return(this.statusAutomation.episode_id||this.$route.params.episode_id)&&(t.name="episode-status-automation",t.params.episode_id=this.statusAutomation.episode_id||this.$route.params.episode_id),t}}},pe={class:"status-automation flexrow"},he={class:"flexrow-item entity-type"},_e={class:"in-task-type flexrow-item"},fe={class:"in-task-status flexrow-item"},ke={class:"flexrow-item trigger-type"},ye={class:"out-task-type flexrow-item"},be={key:0,class:"flexrow-item"},Te={class:"out-task-status flexrow-item"};function ge(t,e,n,_,i,o){const f=c("task-type-name"),y=c("task-status-cell");return a(),r("div",pe,[s("span",he,l(n.statusAutomation.entity_type),1),s("span",_e,[u(f,{class:"in-task-type flexrow-item","task-type":t.getTaskType(n.statusAutomation.in_task_type_id)},null,8,["task-type"])]),s("span",fe,[n.statusAutomation.in_field_type!=="ready_for"?(a(),T(y,{key:0,entry:t.getTaskStatus(n.statusAutomation.in_task_status_id)},null,8,["entry"])):p("",!0)]),s("span",ke," changes "+l(n.statusAutomation.out_field_type==="ready_for"?"ready for to":"task status for"),1),s("span",ye,[u(f,{"task-type":t.getTaskType(n.statusAutomation.out_task_type_id)},null,8,["task-type"])]),n.statusAutomation.out_field_type==="status"?(a(),r("span",be," to ")):p("",!0),s("span",Te,[n.statusAutomation.out_field_type==="status"?(a(),T(y,{key:0,entry:t.getTaskStatus(n.statusAutomation.out_task_status_id)},null,8,["entry"])):p("",!0)])])}const ve=v(me,[["render",ge],["__scopeId","data-v-37b59f3a"]]),Pe={name:"combobox-status-automation",components:{ChevronDownIcon:dt,ComboboxMask:lt,StatusAutomationItem:ve},emits:["update:modelValue"],data(){return{showStatusAutomationsList:!1}},props:{label:{default:"",type:String},statusAutomationsList:{default:()=>[],type:Array},modelValue:{default:"",type:String},narrow:{default:!1,type:Boolean},withMargin:{default:!0,type:Boolean},addPlaceholder:{default:!1,type:Boolean}},mounted(){this.selectedStatusAutomation=this.statusAutomation},computed:{...P(["isDarkTheme","statusAutomationMap"]),currentStatusAutomation(){return this.modelValue?this.statusAutomationMap.get(this.modelValue):this.addPlaceholder?{short_name:"+ status",color:"#999"}:this.statusAutomationsList[0]}},methods:{selectStatusAutomation(t){this.$emit("update:modelValue",t.id),this.showStatusAutomationsList=!1},backgroundColor(t){return(!t||t.is_default)&&!this.isDarkTheme?"#ECECEC":(!t||t.is_default)&&this.isDarkTheme?"#5F626A":this.isDarkTheme?ut.darkenColor(t.color):t.color},color(t){return!t||!t.is_default||this.isDarkTheme?"white":"#333"},toggleStatusAutomationsList(){this.showStatusAutomationsList=!this.showStatusAutomationsList}}},we={key:0,class:"label"},Se={class:"status-automation-combo"},Ae={class:"selected-status-automation-line flexrow-item"},Ie={key:0,class:"select-input",ref:"select"},Ce=["onClick"];function De(t,e,n,_,i,o){const f=c("status-automation-item"),y=c("chevron-down-icon"),d=c("combobox-mask");return a(),r("div",{class:g({field:n.withMargin,"field--narrow":n.narrow})},[n.label.length>0?(a(),r("label",we,l(n.label),1)):p("",!0),s("div",Se,[s("div",{class:"flexrow",onClick:e[0]||(e[0]=(...k)=>o.toggleStatusAutomationsList&&o.toggleStatusAutomationsList(...k))},[s("div",Ae,[o.currentStatusAutomation?(a(),T(f,{key:0,"status-automation":o.currentStatusAutomation},null,8,["status-automation"])):p("",!0)]),u(y,{class:"down-icon flexrow-item"})]),i.showStatusAutomationsList?(a(),r("div",Ie,[(a(!0),r(S,null,$(n.statusAutomationsList,k=>(a(),r("div",{class:"status-automation-line",key:k.id,onClick:A=>o.selectStatusAutomation(k)},[k?(a(),T(f,{key:0,"status-automation":k},null,8,["status-automation"])):p("",!0)],8,Ce))),128))],512)):p("",!0)]),u(d,{displayed:i.showStatusAutomationsList,onClick:o.toggleStatusAutomationsList},null,8,["displayed","onClick"])],2)}const Ve=v(Pe,[["render",De],["__scopeId","data-v-d5d44aae"]]),$e={name:"production-status-automations",components:{ComboboxStatusAutomation:Ve,StatusAutomationList:Pt},data(){return{statusAutomations:[],statusAutomationId:""}},mounted(){this.remainingStatusAutomations.length>0&&(this.statusAutomationId=this.remainingStatusAutomations[0].id)},computed:{...P(["currentProduction","productionStatusAutomations","statusAutomationMap","remainingStatusAutomations"])},methods:{...E(["addStatusAutomationToProduction"]),isEmpty(t){return!t||t.length===0},addStatusAutomation(){this.addStatusAutomationToProduction(this.statusAutomationId),this.remainingStatusAutomations.length>0?this.statusAutomationId=this.remainingStatusAutomations[0].id:this.statusAutomationId=""}}},Ee={class:"columns"},Be={class:"column"},Fe={key:0,class:"flexrow mt1 mb1 add-status-automation"},Le={key:1,class:"box"};function Ue(t,e,n,_,i,o){const f=c("combobox-status-automation"),y=c("status-automation-list");return a(),r("div",Ee,[s("div",Be,[t.remainingStatusAutomations.length>0?(a(),r(S,{key:0},[t.remainingStatusAutomations?(a(),r("div",Fe,[u(f,{class:"flexrow-item selector","status-automations-list":t.remainingStatusAutomations,modelValue:i.statusAutomationId,"onUpdate:modelValue":e[0]||(e[0]=d=>i.statusAutomationId=d)},null,8,["status-automations-list","modelValue"]),s("button",{class:"button flexrow-item",onClick:e[1]||(e[1]=(...d)=>o.addStatusAutomation&&o.addStatusAutomation(...d))},l(t.$t("main.add")),1)])):p("",!0)],64)):p("",!0),o.isEmpty(t.productionStatusAutomations)?(a(),r("div",Le,l(t.$t("settings.production.empty_automation_list")),1)):p("",!0),o.isEmpty(t.productionStatusAutomations)?p("",!0):(a(),T(y,{key:2,entries:t.productionStatusAutomations},null,8,["entries"]))])])}const Re=v($e,[["render",Ue],["__scopeId","data-v-f177d5cf"]]),Oe={name:"production-task-type",components:{GripVerticalIcon:J,TaskTypeCell:ct},props:{taskType:{required:!0,type:Object},scheduleItem:{required:!0,type:Object}},emits:["date-changed","remove"],data(){return{startDate:null,endDate:null,silent:!0}},computed:{...P(["currentProduction","getTaskTypePriority"]),productionTimeRange(){return{to:V(this.currentProduction.start_date).toDate(),from:V(this.currentProduction.end_date).toDate()}},endDateTimeRange(){return{to:this.startDate,from:V(this.currentProduction.end_date).toDate()}}},mounted(){this.startDate=V(this.scheduleItem.start_date).toDate(),this.endDate=V(this.scheduleItem.end_date).toDate(),this.$nextTick(()=>{this.silent=!1})},watch:{startDate(){if(this.silent)return;const t=C(this.startDate);let e=C(this.endDate);this.silent=!0,e.isBefore(t)&&(e=t.clone().add(1,"days"),this.endDate=e.toDate());const n={...this.scheduleItem};n.startDate=t,n.endDate=e,this.$emit("date-changed",n),this.$nextTick(()=>{this.silent=!1})},endDate(){if(this.silent)return;let t=C(this.startDate);const e=C(this.endDate);this.silent=!0,e.isBefore(t)&&(t=e.clone().add(-1,"days"),this.startDate=t.toDate());const n={...this.scheduleItem};n.startDate=t,n.endDate=e,this.$emit("date-changed",n),this.$nextTick(()=>{this.silent=!1})},scheduleItem(){this.silent=!0,this.startDate=V(this.scheduleItem.start_date).toDate(),this.endDate=V(this.scheduleItem.end_date).toDate(),this.$nextTick(()=>{this.silent=!1})}}},qe={class:"grab"},Me={class:"short-name"},Ne={class:"remove"};function xe(t,e,n,_,i,o){const f=c("grip-vertical-icon"),y=c("task-type-cell");return a(),r("tr",{class:"datatable-row",key:n.taskType.id},[s("td",qe,[u(f,{class:"grab"})]),u(y,{"task-type":n.taskType},null,8,["task-type"]),s("td",Me,l(n.taskType.short_name),1),s("td",Ne,[s("button",{class:"button",onClick:e[0]||(e[0]=d=>t.$emit("remove",{scheduleItem:n.scheduleItem,taskType:n.taskType}))},l(t.$t("main.remove")),1)])])}const Ge=v(Oe,[["render",xe],["__scopeId","data-v-ebe11ac1"]]),je={name:"setting-importer",components:{ButtonSimple:j,ComboboxProduction:mt},emits:["import-from-production","import-item"],data(){return{importProductionId:null}},props:{items:{type:Array,default:()=>[]},loadingImport:{type:Boolean,default:!0}},mounted(){this.availableProductions.length>0&&(this.importProductionId=this.availableProductions[0].id)},computed:{...P(["currentProduction","openProductions"]),availableProductions(){return this.openProductions.filter(t=>t.id!==this.currentProduction.id)},sizeStyle(){return{width:this.size?this.size+"px":"auto"}}}},ze={key:0,class:"project-import flexcolumn"},He={key:0,class:"import-list"},Je=["onClick"],Ke={class:"infos mt05"};function Qe(t,e,n,_,i,o){const f=c("combobox-production"),y=c("button-simple");return a(),r("div",null,[o.availableProductions.length>0?(a(),r("div",ze,[u(f,{class:"flexrow-item",label:t.$t("settings.import_from_production"),"production-list":o.availableProductions,"with-margin":!1,modelValue:i.importProductionId,"onUpdate:modelValue":e[0]||(e[0]=d=>i.importProductionId=d)},null,8,["label","production-list","modelValue"]),u(y,{class:"flexrow-item mt05",disabled:!i.importProductionId,"is-loading":n.loadingImport,text:t.$t("main.import"),onClick:e[1]||(e[1]=d=>t.$emit("import-from-production",i.importProductionId))},null,8,["disabled","is-loading","text"])])):p("",!0),s("div",null,[s("p",{class:g({label:!0,mt2:o.availableProductions.length>0})},l(t.$t("settings.available_items")),3),n.items.length>0?(a(),r("div",He,[(a(!0),r(S,null,$(n.items,d=>(a(),r("div",{key:`unlisted-item-${d.id}`,class:"flexrow item-to-add mb05",onClick:k=>t.$emit("import-item",d)},[pt(t.$slots,"item-line",{item:d},void 0,!0)],8,Je))),128))])):p("",!0),s("p",Ke,l(t.$t("settings.no_more_available_items")),1)])])}const Ye=v(je,[["render",Qe],["__scopeId","data-v-0afc0fce"]]),We={name:"production-task-types",components:{ComboboxTaskType:_t,draggable:H,ProductionTaskType:Ge,RouteSectionTabs:ht,SettingImporter:Ye,TaskTypeName:z},data(){return{activeTab:"assets",assetTaskTypes:{list:[]},editTaskTypes:{list:[]},episode_span:0,episodeTaskTypes:{list:[]},sequenceTaskTypes:{list:[]},shotTaskTypes:{list:[]},taskTypeId:"",loading:{import:!1,episode_span:!1,scheduleTimeUpdate:!1,scheduleTimeDelete:!1},errors:{episode_span:!1,scheduleTimeUpdate:!1,delete:!1}}},mounted(){this.remainingTaskTypesForEntity.length>0?this.taskTypeId=this.remainingTaskTypesForEntity[0].id:this.taskTypeId=null,this.$route.query.section?this.activeTab=this.$route.query.section:this.isShotsOnly?this.activeTab="shots":this.activeTab="assets",this.resetDisplayedTaskTypes(),this.currentProduction&&(this.episode_span=this.currentProduction.episode_span,this.loadAllScheduleItems(this.currentProduction).then(()=>{this.resetDisplayedTaskTypes()}).catch(t=>{console.error(t)}))},computed:{...P(["currentProduction","currentScheduleItems","getProductionTaskTypes","productionTaskTypes","productionAssetTaskTypes","productionShotTaskTypes","productionEditTaskTypes","productionSequenceTaskTypes","productionEpisodeTaskTypes","taskStatusMap","taskTypeMap","taskTypes","isTVShow"]),remainingTaskTypes(){return q(this.taskTypes.filter(t=>!this.currentProduction.task_types.includes(t.id)))},remainingTaskTypesForEntity(){return q(this.remainingTaskTypes.filter(t=>`${t.for_entity.toLowerCase()}s`===this.activeTab))},isAssetsOnly(){return this.currentProduction.production_type==="assets"},isShotsOnly(){return this.currentProduction.production_type==="shots"},taskTypeGroups(){let t=[];return this.isShotsOnly||t.push(this.assetTaskTypes),this.isAssetsOnly||(t=t.concat([this.shotTaskTypes,this.editTaskTypes,this.sequenceTaskTypes,this.episodeTaskTypes])),t},taskTypeTabs(){return[{label:this.$t("assets.title"),name:"assets"},{label:this.$t("shots.title"),name:"shots"},{label:this.$t("sequences.title"),name:"sequences"},{label:this.$t("episodes.title"),name:"episodes"},{label:this.$t("edits.title"),name:"edits"}]}},methods:{...E(["addTaskTypeToProduction","createScheduleItem","deleteScheduleItem","editProduction","editTaskTypeLink","loadAllScheduleItems","loadContext","removeTaskTypeFromProduction","saveScheduleItem"]),isEmpty(t){return!t||t.length===0},resetDisplayedTaskTypes(){["Asset","Shot","Sequence","Episode","Edit"].forEach(t=>{const e=this[`production${t}TaskTypes`];let n=yt([...e],this.currentProduction);n=n.map(_=>({taskType:_,scheduleItem:this.getScheduleItemForTaskType(_)})),this[`${t.toLowerCase()}TaskTypes`]={entity:`${t.toLowerCase()}s`,title:this.$t(`${t.toLowerCase()}s.title`),list:n}})},getScheduleItemForTaskType(t){return this.currentScheduleItems.find(n=>n.task_type_id===t.id)||{start_date:O(C()),end_date:O(C())}},async addTaskType(t){const e=t&&t.id?t.id:this.taskTypeId;await this.addTaskTypeToProduction({taskTypeId:e,priority:this.assetTaskTypes.length});try{await this.createScheduleItem({startDate:C(),endDate:C(),project_id:this.currentProduction.id,task_type_id:e})}catch(n){console.error(n)}this.remainingTaskTypesForEntity.length>0?this.taskTypeId=this.remainingTaskTypesForEntity[0].id:this.taskTypeId=null,this.resetDisplayedTaskTypes()},async removeTaskType({taskType:t,scheduleItem:e}){this.errors.delete=!1;try{await this.removeTaskTypeFromProduction(t.id),e!==null&&(this.loading.scheduleTimeDelete=!0,await this.deleteScheduleItem(e),this.loading.scheduleTimeDelete=!1)}catch{this.errors.delete=!0,this.loading.scheduleTimeDelete=!1;return}await this.$nextTick(),this.remainingTaskTypesForEntity.length>0?this.taskTypeId=this.remainingTaskTypesForEntity[0].id:this.taskTypeId=null,this.resetDisplayedTaskTypes()},async editEpisodeSpan(){this.loading.episode_span=!0,this.errors.episode_span=!1;try{await this.editProduction({id:this.currentProduction.id,episode_span:this.episode_span})}catch(t){this.errors.episode_span=!0,console.error(t)}this.loading.episode_span=!1},async onDateChanged(t){this.errors.scheduleTimeUpdate=!1;try{await this.saveScheduleItem(t)}catch(e){console.error(e),this.errors.scheduleTimeUpdate=!0}},async savePriorities(t){const e=new Date().getTime();this.lastCall=this.lastCall||0,e-this.lastCall>1e3&&!this.isSaving?(this.lastCall=e,this.isSaving=!0,await kt.runPromiseAsSeries(t.map(async n=>await this.editTaskTypeLink(n))),this.isSaving=!1,this.newSaveCall&&await this.savePriorities(t),setTimeout(()=>{this.$store.commit("SORT_VALIDATION_COLUMNS",this.taskTypeMap)},100)):this.newSaveCall=!0},async updatePriorities(t){const e=[];t.forEach((n,_)=>{_+=1;const i={projectId:this.currentProduction.id,taskTypeId:n.taskType.id,priority:_};e.push(i)}),await this.savePriorities(e),await this.loadContext()},async importTaskTypesFromProduction(t){this.loading.import=!0;const e=this.getProductionTaskTypes(t).filter(_=>`${_.for_entity.toLowerCase()}s`===this.activeTab),n=ft.capitalize(this.activeTab).slice(0,-1);await this[`production${n}TaskTypes`].forEach(async _=>{const i=this.getScheduleItemForTaskType(e[0]);await this.removeTaskType({taskType:_,scheduleItem:i})}),setTimeout(async()=>{await e.forEach(async _=>{await this.addTaskType(_)}),this.loading.import=!1},500)}},watch:{currentProduction:{handler(){this.episode_span=this.currentProduction.episode_span,this.loadAllScheduleItems(this.currentProduction),this.resetDisplayedTaskTypes()},deep:!0},$route(){this.$route.query.section&&(this.activeTab=this.$route.query.section,this.$nextTick(()=>{this.remainingTaskTypesForEntity.length>0?this.taskTypeId=this.remainingTaskTypesForEntity[0].id:this.taskTypeId=null}))}}},Xe={class:"columns"},Ze={class:"column"},ts={key:0,class:"flexrow mt1 mb1 add-task-type"},es=["disabled"],ss={key:1,class:"error mt1 mb1"},os={key:2,class:"box"},is={key:0,class:"datatable list"},as={key:1,class:"empty"},ns={class:"column"};function rs(t,e,n,_,i,o){const f=c("route-section-tabs"),y=c("combobox-task-type"),d=c("production-task-type"),k=c("draggable"),A=c("task-type-name"),B=c("setting-importer");return a(),r("div",null,[s("div",null,[u(f,{class:"section-tabs","active-tab":i.activeTab,route:t.$route,tabs:o.taskTypeTabs},null,8,["active-tab","route","tabs"]),s("div",Xe,[s("div",Ze,[o.remainingTaskTypes.length>0?(a(),r("div",ts,[u(y,{class:"flexrow-item selector","task-type-list":o.remainingTaskTypesForEntity,modelValue:i.taskTypeId,"onUpdate:modelValue":e[0]||(e[0]=b=>i.taskTypeId=b)},null,8,["task-type-list","modelValue"]),s("button",{class:"button flexrow-item",disabled:i.loading.scheduleTimeDelete,onClick:e[1]||(e[1]=(...b)=>o.addTaskType&&o.addTaskType(...b))},l(t.$t("main.add")),9,es)])):p("",!0),i.errors.delete||i.errors.scheduleTimeUpdate?(a(),r("p",ss,l(t.$t("productions.edit_error")),1)):p("",!0),o.isEmpty(t.currentProduction.task_types)?(a(),r("div",os,l(t.$t("settings.production.empty_list")),1)):(a(!0),r(S,{key:3},$(o.taskTypeGroups,(b,m)=>(a(),r("div",{key:m},[b.list.length>0&&b.entity===i.activeTab?(a(),r("table",is,[u(k,{class:"datatable-body","item-key":"taskType.id",tag:"tbody",onEnd:D=>o.updatePriorities(b.list),modelValue:b.list,"onUpdate:modelValue":D=>b.list=D},{item:F(({element:D})=>[u(d,{class:"task-type","task-type":D.taskType,"schedule-item":D.scheduleItem,onDateChanged:o.onDateChanged,onRemove:o.removeTaskType},null,8,["task-type","schedule-item","onDateChanged","onRemove"])]),_:2},1032,["onEnd","modelValue","onUpdate:modelValue"])])):p("",!0),b.list.length===0&&b.entity===i.activeTab?(a(),r("p",as,l(t.$t("task_types.no_task_types")),1)):p("",!0)]))),128))]),s("div",ns,[u(B,{items:o.remainingTaskTypesForEntity,"loading-import":i.loading.import,onImportFromProduction:o.importTaskTypesFromProduction,onImportItem:o.addTaskType},{"item-line":F(({item:b})=>[u(A,{class:"pointer","task-type":b},null,8,["task-type"])]),_:1},8,["items","loading-import","onImportFromProduction","onImportItem"])])])])])}const ls=v(We,[["render",rs],["__scopeId","data-v-10477862"]]),ds={name:"production-settings",components:{BooleanCell:Tt,Combobox:M,ComboboxStatus:bt,draggable:H,GripVerticalIcon:J,ProductionBackgrounds:Mt,ProductionBoard:te,ProductionBrief:gt,ProductionParameters:ce,ProductionStatusAutomations:Re,ProductionTaskTypes:ls,ValidationTag:x},data(){return{activeTab:"parameters",assetTypeId:"",taskStatusItems:[],taskStatusId:""}},mounted(){if(!this.isCurrentUserManager){this.$router.push({name:"not-found"});return}this.remainingAssetTypes.length>0&&(this.assetTypeId=this.remainingAssetTypes[0].value),this.remainingTaskStatuses.length>0&&(this.taskStatusId=this.remainingTaskStatuses[0].id),this.$route.query.tab&&(this.activeTab=this.$route.query.tab)},computed:{...P(["assetTypes","currentProduction","isCurrentUserManager","productionAssetTypes","productionTaskStatuses","taskStatus"]),remainingAssetTypes(){return this.assetTypes.filter(t=>!this.currentProduction.asset_types.includes(t.id)).map(t=>({label:t.name,value:t.id}))},remainingTaskStatuses(){return this.taskStatus.filter(t=>!this.currentProduction.task_statuses.includes(t.id)&&!t.for_concept)},sortedProductionTaskStatuses(){return G(this.productionTaskStatuses,this.currentProduction)}},methods:{...E(["addAssetTypeToProduction","addTaskStatusToProduction","editTaskStatusLink","loadContext","removeAssetTypeFromProduction","removeTaskStatusFromProduction"]),isEmpty(t){return!t||t.length===0},isActiveTab(t){return this.activeTab===t},addAssetType(){this.addAssetTypeToProduction(this.assetTypeId),this.remainingAssetTypes.length>0&&(this.assetTypeId=this.remainingAssetTypes[0].value)},removeAssetType(t){this.removeAssetTypeFromProduction(t)},async addTaskStatus(){await this.addTaskStatusToProduction(this.taskStatusId),await this.loadContext(),this.taskStatusId=this.remainingTaskStatuses[0]?.id},async removeTaskStatus(t){await this.removeTaskStatusFromProduction(t),await this.loadContext(),this.taskStatusId=this.remainingTaskStatuses[0]?.id},async updateTaskStatusPriority(){await this.updateTaskStatusPriorities(this.taskStatusItems)},async updateTaskStatusPriorities(t){const e=t.map((n,_)=>({...this.currentProduction.task_statuses_link[n.id],priority:_+1,project_id:this.currentProduction.id,task_status_id:n.id}));for(const n of e)await this.editTaskStatusLink(n);await this.loadContext()}},watch:{activeTab(){this.$route.query.tab!==this.activeTab&&this.$router.push({query:{tab:this.activeTab}})},sortedProductionTaskStatuses:{immediate:!0,handler(){this.taskStatusItems=JSON.parse(JSON.stringify(this.sortedProductionTaskStatuses))}}},head(){return{title:`${this.currentProduction.name} | ${this.$t("settings.title")} - Kitsu`}}},us={class:"production-settings fixed-page"},cs={class:"wrapper"},ms={class:"tabs"},ps={class:"tab"},hs={class:"tab"},_s={class:"tab"},fs={class:"flexrow mt1 mb1 add-asset-type"},ks={key:0,class:"box"},ys={key:1,class:"datatable list"},bs={class:"datatable-body"},Ts={class:"name"},gs=["onClick"],vs={class:"tab"},Ps={class:"tab"},ws={key:0,class:"flexrow mt1 mb1 add-task-status"},Ss={key:1,class:"box"},As={key:2,class:"datatable"},Is={class:"th-name"},Cs={class:"th-short-name"},Ds={class:"th-bool"},Vs={class:"th-bool"},$s={class:"th-bool"},Es={class:"th-bool"},Bs={class:"datatable-row task-status"},Fs={class:"grab"},Ls={class:"name"},Us=["onClick"],Rs={class:"tab"},Os={class:"tab"},qs={class:"tab"};function Ms(t,e,n,_,i,o){const f=c("production-parameters"),y=c("production-brief"),d=c("combobox"),k=c("production-task-types"),A=c("combobox-status"),B=c("grip-vertical-icon"),b=c("validation-tag"),m=c("boolean-cell"),D=c("draggable"),K=c("production-board"),Q=c("production-status-automations"),Y=c("production-backgrounds");return a(),r("div",us,[s("div",cs,[s("div",ms,[s("ul",null,[s("li",{class:g({"is-active":o.isActiveTab("parameters")})},[s("a",{onClick:e[0]||(e[0]=h=>i.activeTab="parameters")},l(t.$t("productions.parameters.title")),1)],2),s("li",{class:g({"is-active":o.isActiveTab("brief")})},[s("a",{onClick:e[1]||(e[1]=h=>i.activeTab="brief")},l(t.$t("productions.brief.title")),1)],2),s("li",{class:g({"is-active":o.isActiveTab("taskStatus")})},[s("a",{onClick:e[2]||(e[2]=h=>i.activeTab="taskStatus")},l(t.$t("task_status.title")),1)],2),s("li",{class:g({"is-active":o.isActiveTab("board")})},[s("a",{onClick:e[3]||(e[3]=h=>i.activeTab="board")},l(t.$t("board.settings.title")),1)],2),s("li",{class:g({"is-active":o.isActiveTab("taskTypes")})},[s("a",{onClick:e[4]||(e[4]=h=>i.activeTab="taskTypes")},l(t.$t("task_types.title")),1)],2),s("li",{class:g({"is-active":o.isActiveTab("assetTypes")})},[s("a",{onClick:e[5]||(e[5]=h=>i.activeTab="assetTypes")},l(t.$t("asset_types.title")),1)],2),s("li",{class:g({"is-active":o.isActiveTab("statusAutomations")})},[s("a",{onClick:e[6]||(e[6]=h=>i.activeTab="statusAutomations")},l(t.$t("status_automations.title")),1)],2),s("li",{class:g({"is-active":o.isActiveTab("backgrounds")})},[s("a",{onClick:e[7]||(e[7]=h=>i.activeTab="backgrounds")},l(t.$t("backgrounds.title")),1)],2)])]),w(s("div",ps,[u(f)],512),[[I,o.isActiveTab("parameters")]]),w(s("div",hs,[u(y)],512),[[I,o.isActiveTab("brief")]]),w(s("div",_s,[s("div",fs,[u(d,{class:"flexrow-item",options:o.remainingAssetTypes,modelValue:i.assetTypeId,"onUpdate:modelValue":e[8]||(e[8]=h=>i.assetTypeId=h)},null,8,["options","modelValue"]),s("button",{class:"button flexrow-item",onClick:e[9]||(e[9]=(...h)=>o.addAssetType&&o.addAssetType(...h))},l(t.$t("main.add")),1)]),o.isEmpty(t.currentProduction.asset_types)?(a(),r("div",ks,l(t.$t("settings.production.empty_list")),1)):(a(),r("table",ys,[s("tbody",bs,[(a(!0),r(S,null,$(t.productionAssetTypes,h=>(a(),r("tr",{class:"datatable-row",key:h.id},[s("td",Ts,l(h.name),1),s("td",null,[s("button",{class:"button",onClick:W=>o.removeAssetType(h.id)},l(t.$t("main.remove")),9,gs)])]))),128))])]))],512),[[I,o.isActiveTab("assetTypes")]]),w(s("div",vs,[u(k)],512),[[I,o.isActiveTab("taskTypes")]]),w(s("div",Ps,[o.isEmpty(o.remainingTaskStatuses)?p("",!0):(a(),r("div",ws,[u(A,{class:"flexrow-item selector","task-status-list":o.remainingTaskStatuses,modelValue:i.taskStatusId,"onUpdate:modelValue":e[10]||(e[10]=h=>i.taskStatusId=h)},null,8,["task-status-list","modelValue"]),s("button",{class:"button flexrow-item",onClick:e[11]||(e[11]=(...h)=>o.addTaskStatus&&o.addTaskStatus(...h))},l(t.$t("main.add")),1)])),o.isEmpty(t.currentProduction.task_statuses)?(a(),r("div",Ss,l(t.$t("settings.production.empty_list")),1)):(a(),r("table",As,[s("thead",null,[s("tr",null,[e[13]||(e[13]=s("th",{class:"th-grab"},null,-1)),s("th",Is,l(t.$t("task_status.fields.name")),1),s("th",Cs,l(t.$t("task_status.fields.short_name")),1),s("th",Ds,l(t.$t("task_status.fields.is_done")),1),s("th",Vs,l(t.$t("task_status.fields.is_retake")),1),s("th",$s,l(t.$t("task_status.fields.is_artist_allowed")),1),s("th",Es,l(t.$t("task_status.fields.is_client_allowed")),1)])]),u(D,{class:"datatable-body","item-key":"id",tag:"tbody",modelValue:i.taskStatusItems,"onUpdate:modelValue":e[12]||(e[12]=h=>i.taskStatusItems=h),onEnd:o.updateTaskStatusPriority},{item:F(({element:h})=>[s("tr",Bs,[s("td",Fs,[u(B)]),s("td",null,l(h.name),1),s("td",Ls,[u(b,{"is-static":!0,task:{task_status_id:h.id}},null,8,["task"])]),u(m,{value:h.is_done},null,8,["value"]),u(m,{value:h.is_retake},null,8,["value"]),u(m,{value:h.is_artist_allowed},null,8,["value"]),u(m,{value:h.is_client_allowed},null,8,["value"]),s("td",null,[s("button",{class:"button",onClick:W=>o.removeTaskStatus(h.id)},l(t.$t("main.remove")),9,Us)])])]),_:1},8,["modelValue","onEnd"])]))],512),[[I,o.isActiveTab("taskStatus")]]),w(s("div",Rs,[u(K)],512),[[I,o.isActiveTab("board")]]),w(s("div",Os,[u(Q)],512),[[I,o.isActiveTab("statusAutomations")]]),w(s("div",qs,[u(Y)],512),[[I,o.isActiveTab("backgrounds")]])])])}const Js=v(ds,[["render",Ms],["__scopeId","data-v-9de5dce4"]]);export{Js as default};
//# sourceMappingURL=ProductionSettings-BqyXYVvC.js.map
