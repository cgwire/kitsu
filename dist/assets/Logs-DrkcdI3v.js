import{_ as w,m as E,a as L,u as F,aH as A,aG as x,al as I,B as C,an as M,aC as $,bD as D,r as p,c as r,o as i,e as s,d as u,f as h,t as a,F as g,g as T,aj as P,k,a8 as S,q as j,T as z,v as G,z as V,bE as N,n as B}from"./index-C7LygRgU.js";const q={name:"events",mixins:[M],components:{ButtonSimple:C,DateField:I,PeopleAvatar:x,PeopleName:A,Spinner:F},data(){return{PAGE_SIZE:1e3,currentDate:new Date,events:[],isLoading:!0,selectedEvents:{},displayLimit:1e3}},mounted(){this.loadDayEvents()},computed:{...L(["personMap","user"]),today(){return $().toDate()},displayedEvents(){return this.events.slice(0,this.displayLimit)},hasMoreEvents(){return this.events.length>this.displayLimit}},methods:{...E(["loadEvents"]),loadDayEvents(){const e=$(this.currentDate).add(1,"days"),t=$(this.currentDate);this.selectedEvents={},this.displayLimit=this.PAGE_SIZE,this.isLoading=!0,this.loadEvents({after:D(t,this.timezone),before:D(e,this.timezone)}).then(d=>{this.events=d.map(_=>{const[o,n]=_.name.split(":");return{id:_.id,date:this.formatDate(_.created_at),data:_.data,name:o,shortType:n.substring(0,3),type:n,user_id:_.user_id}})}).catch(d=>{console.error(d)}).finally(()=>{this.isLoading=!1})},selectLine(e){this.selectedEvents[e.id]=!this.selectedEvents[e.id]},isLink(e){return["project_id","task_id"].includes(e)},getLink(e,t){const d=e.data.project_id,_=t.substring(0,t.length-3);if(_==="project")return`/productions/${d}/news-feed`;{const o=e.data[t];return`/productions/${d}/${_}s/${o}`}}},watch:{currentDate(){this.loadDayEvents()}},head(){return{title:`${this.$t("logs.title")} - Kitsu`}}},Z={class:"mt1"},K={class:"flexrow"},R={class:"flexrow-item nb-events"},W={key:0,class:"mt2 empty"},H={key:1,class:"has-text-centered"},O={key:2,class:"log-list"},U=["onClick"],J={class:"date tag mr1"},Q=["title","data-status"],X={class:"name tag mr1"},Y={class:"flexrow"},ee={class:"key"},te=["href"],se={key:0,class:"has-text-centered mt1"};function ie(e,t,d,_,o,n){const v=p("date-field"),m=p("button-simple"),y=p("spinner"),b=p("people-avatar"),c=p("people-name");return i(),r("div",Z,[s("div",K,[h(v,{class:"flexrow-item","can-delete":!1,"max-date":n.today,label:e.$t("logs.current_date_label"),modelValue:o.currentDate,"onUpdate:modelValue":t[0]||(t[0]=l=>o.currentDate=l)},null,8,["max-date","label","modelValue"]),h(m,{class:"flexrow-item small",icon:"refresh",onClick:n.loadDayEvents},null,8,["onClick"]),s("span",R,a(o.events.length)+" "+a(e.$t("logs.events")),1)]),!o.isLoading&&!o.events.length?(i(),r("div",W,a(e.$t("logs.empty_list")),1)):u("",!0),o.isLoading?(i(),r("div",H,[h(y)])):(i(),r("div",O,[(i(!0),r(g,null,T(n.displayedEvents,l=>(i(),r("div",{class:"event-line",key:l.id,onClick:f=>n.selectLine(l)},[s("span",J,a(l.date),1),s("span",{class:"type tag",title:l.type,"data-status":l.shortType},a(l.shortType),9,Q),s("span",X,a(l.name),1),o.selectedEvents[l.id]?(i(),r("ul",{key:0,onClick:t[1]||(t[1]=P(()=>{},["stop"]))},[s("li",Y,[t[3]||(t[3]=s("span",{class:"key"},"user",-1)),l.user_id?(i(),k(b,{key:0,class:"flexrow-item",size:20,"font-size":10,person:e.personMap.get(l.user_id)},null,8,["person"])):u("",!0),l.user_id?(i(),k(c,{key:1,class:"flexrow-item",person:e.personMap.get(l.user_id),"with-link":""},null,8,["person"])):u("",!0)]),(i(!0),r(g,null,T(Object.keys(l.data).sort(),f=>(i(),r("li",{key:`${l.id}-${f}`},[s("span",ee,a(f),1),n.isLink(f)?(i(),r("a",{key:0,href:n.getLink(l,f)},a(l.data[f]),9,te)):(i(),r(g,{key:1},[S(a(l.data[f]),1)],64))]))),128))])):u("",!0)],8,U))),128)),n.hasMoreEvents?(i(),r("div",se,[h(m,{text:e.$t("main.load_more"),onClick:t[2]||(t[2]=l=>o.displayLimit+=o.PAGE_SIZE)},null,8,["text"])])):u("",!0)]))])}const ae=w(q,[["render",ie],["__scopeId","data-v-016ec5df"]]),oe={name:"preview-file-list",mixins:[V],components:{ButtonSimple:C,ProductionNameCell:G,TableInfo:z,TaskTypeCell:j},props:{previewFiles:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1}},emits:["mark-broken-clicked"],computed:{...L(["productionMap","taskTypeMap"])},methods:{...E(["loadTask"]),onBodyScroll(e){const t=e.target;this.$refs.headerWrapper.style.left=`-${t.scrollLeft}px`},async redirectToTask(e){const t=await this.loadTask({taskId:e.task_id});return this.$router.push(N(t,t.project,t.project.production_type==="tvshow",t.episode,this.taskTypeMap))}}},ne={class:"data-list"},le={style:{overflow:"hidden"}},re={class:"datatable",ref:"headerWrapper"},de={class:"datatable-head"},ce={class:"datatable-row-header"},pe={class:"date"},_e={class:"production"},ue={class:"entity-name"},me={class:"task-type"},he={class:"revision"},ve={class:"status"},fe={class:"datatable"},ke={class:"datatable-body"},ye=["onClick"],ge={class:"date"},we={class:"production"},be={class:"entity-name"},$e={class:"revision"},Te=["data-status"],Ee={class:"end-cell has-text-right"};function Le(e,t,d,_,o,n){const v=p("table-info"),m=p("production-name-cell"),y=p("task-type-cell"),b=p("button-simple");return i(),r("div",ne,[s("div",le,[s("table",re,[s("thead",de,[s("tr",ce,[s("th",pe,a(e.$t("logs.preview_files.date")),1),s("th",_e,a(e.$t("logs.preview_files.production")),1),s("th",ue,a(e.$t("logs.preview_files.entity_name")),1),s("th",me,a(e.$t("logs.preview_files.task_type_id")),1),s("th",he,a(e.$t("logs.preview_files.revision")),1),s("th",ve,a(e.$t("logs.preview_files.status")),1),t[1]||(t[1]=s("th",{class:"end-cell"},null,-1))])])],512)]),h(v,{"is-loading":d.isLoading,"is-error":d.isError},null,8,["is-loading","is-error"]),d.previewFiles.length>0?(i(),r("div",{key:0,onScrollPassive:t[0]||(t[0]=(...c)=>n.onBodyScroll&&n.onBodyScroll(...c))},[s("table",fe,[s("tbody",ke,[(i(!0),r(g,null,T(d.previewFiles,c=>(i(),r("tr",{key:c.id,class:"datatable-row",onClick:l=>n.redirectToTask(c)},[s("td",ge,a(e.formatDate(c.created_at)),1),s("td",we,[h(m,{entry:e.productionMap.get(c.project_id)},null,8,["entry"])]),s("td",be,a(c.full_entity_name),1),h(y,{class:"task-type","task-type":e.taskTypeMap.get(c.task_type_id)},null,8,["task-type"]),s("td",$e,a(c.revision),1),s("td",{class:"status","data-status":c.status},a(c.status),9,Te),s("td",Ee,[c.status==="processing"?(i(),k(b,{key:0,class:"mark-broken-button",text:e.$t("logs.preview_files.mark_broken"),onClick:P(l=>e.$emit("mark-broken-clicked",c.id),["stop"])},null,8,["text","onClick"])):u("",!0)])],8,ye))),128))])])],32)):u("",!0)])}const Ce=w(oe,[["render",Le],["__scopeId","data-v-fa444a29"]]),De={name:"preview-files",mixins:[M],components:{ButtonSimple:C,PreviewFileList:Ce},data(){return{previewFilesLoading:!0,previewFiles:[]}},computed:{...L(["personMap","taskTypeMap","user"]),displayedPreviewFiles(){return this.previewFiles.filter(e=>e.status!=="ready")}},methods:{...E(["getRunningPreviewFiles","markPreviewFileAsBroken"]),async reload(){this.previewFiles=[],this.previewFilesLoading=!0,this.previewFiles=await this.getRunningPreviewFiles(),this.previewFilesLoading=!1},async markBrokenClicked(e){const t=this.previewFiles.find(d=>d.id===e);t.status="broken",await this.markPreviewFileAsBroken(e)}},mounted(){this.reload()}},Be={class:"mt1"},Me={class:"flexrow"},Pe={class:"flexrow-item"},Fe={key:0,class:"empty"};function Ae(e,t,d,_,o,n){const v=p("button-simple"),m=p("preview-file-list");return i(),r("div",Be,[s("p",Me,[s("em",Pe,a(e.$t("logs.preview_files.explanation")),1),t[0]||(t[0]=s("span",{class:"filler"},null,-1)),h(v,{class:"flexrow-item",icon:"refresh",onClick:n.reload},null,8,["onClick"])]),o.previewFiles.length===0&&!o.previewFilesLoading?(i(),r("p",Fe,a(e.$t("logs.preview_files.empty_list")),1)):(i(),k(m,{key:1,"preview-files":o.previewFiles,"is-loading":o.previewFilesLoading,onMarkBrokenClicked:n.markBrokenClicked},null,8,["preview-files","is-loading","onMarkBrokenClicked"]))])}const xe=w(De,[["render",Ae],["__scopeId","data-v-41e06691"]]),Ie={name:"logs",components:{Events:ae,PreviewFiles:xe},data(){return{activeTab:"events"}},mounted(){this.$route.query.tab&&(this.activeTab=this.$route.query.tab)},methods:{isActiveTab(e){return this.activeTab===e}},watch:{activeTab(){this.$route.query.tab!==this.activeTab&&this.$router.push({query:{tab:this.activeTab}})}}},Se={class:"logs fixed-page"},je={class:"tabs logs-tabs"};function ze(e,t,d,_,o,n){const v=p("events"),m=p("preview-files");return i(),r("div",Se,[s("div",je,[s("ul",null,[s("li",{class:B({"is-active":n.isActiveTab("events")})},[s("a",{onClick:t[0]||(t[0]=y=>o.activeTab="events")},a(e.$t("logs.title")),1)],2),s("li",{class:B({"is-active":n.isActiveTab("preview_files")})},[s("a",{onClick:t[1]||(t[1]=y=>o.activeTab="preview_files")},a(e.$t("logs.preview_files.title")),1)],2)])]),n.isActiveTab("events")?(i(),k(v,{key:0})):u("",!0),n.isActiveTab("preview_files")?(i(),k(m,{key:1})):u("",!0)])}const Ve=w(Ie,[["render",ze],["__scopeId","data-v-1c1caddd"]]);export{Ve as default};
//# sourceMappingURL=Logs-DrkcdI3v.js.map
