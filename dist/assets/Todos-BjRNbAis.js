import{_ as D,Y as L,B as C,m as S,r as n,o as r,c,d as i,f as u,t as p,F as P,e as M,h as d,k as A,v as U,g as _,as as I,u as T,aE as F,a as V,b as q}from"./index-C2m_IhNF.js";import{s as Y}from"./search-CWIHq9c3.js";import{C as j}from"./Combobox-DQpIQydI.js";import{C as Q}from"./ComboboxProduction-Dndrtu96.js";import{D as x,U as G,T as N,K as R}from"./UserCalendar-30ZLCOJl.js";import{D as z}from"./DeleteModal-CaB_X4-T.js";import{T as H}from"./TableInfo-B2X54z7i.js";import{R as K}from"./RouteSectionTabs-B7npqca_.js";import{S as J}from"./SearchField-DO27Jrsj.js";import{S as W}from"./SearchQueryList-BrkMtSsZ.js";import X from"./TaskInfo-C8qSIbPH.js";import{T as Z}from"./TodosList-C3TWuqz_.js";import"./dom-tO7tlkHV.js";import"./format-CUjWrpVJ.js";import"./PreviewPlayer-CsSraBfQ.js";import"./PlaylistPlayer-DoTL8QsR.js";import"./ComboboxSimple-DU0Ahozo.js";import"./ComboboxTaskType-CiBcPUsC.js";import"./TaskTypeName-bEgQZfX7.js";import"./ModalFooter-BJ98b-60.js";import"./TextField-p_HJuEKt.js";import"./video-Yn96Kb74.js";import"./clipboard-CQqgyZ_h.js";import"./ComboboxStyled-fscUNRmK.js";import"./index-KDZ8UbBO.js";import"./BaseModal-BCd5z4wK.js";import"./ComboboxDepartment-whRm-Bo0.js";import"./DepartmentName-C_7ZW05X.js";import"./ComboboxStudio-q2R7SCuH.js";import"./play-B4GV49GM.js";import"./render-Bqw3AFAH.js";import"./string-B0Tq569e.js";import"./EmojiButton-B9I5hDFH.js";import"./FileUpload-C4E3YXqL.js";import"./ComboboxStatus-DYpCiml-.js";import"./ConfirmModal-CYuRpfjg.js";import"./triangle-alert-DAfmXCpT.js";import"./ValidationTag-C6BUHddW.js";import"./thumbs-up-DoHhBcNt.js";import"./copy-BH2iDnK6.js";import"./vue.esm-bundler-Cb2j4MJL.js";import"./VideoViewer-Da8LCLxo.js";import"./EntityPreview-DQBzHKkN.js";import"./eye-CKzk1Q6q.js";import"./DateField-OvNA3wsX.js";import"./InfoQuestionMark-jpROAGzb.js";import"./PageSubtitle-LvZN62xu.js";import"./ProductionNameCell-Bu7vB3PB.js";import"./TaskTypeCell-DM2gnWrD.js";import"./briefcase-DXQKuIYE.js";import"./BooleanField-BK_C2MOf.js";import"./check-_fRnDsm9.js";import"./ColorField--VnpcHkf.js";import"./trash-2-DSHW2jWN.js";import"./chevron-up-kHAV03RH.js";import"./csv-cx9HGs3n.js";import"./BuildFilterModal-C3nrV5vY.js";import"./ComboboxBoolean-DJwCfClJ.js";import"./PeopleField-CJ8IkJD1.js";import"./DeleteEntities-ZGV8gTRL.js";import"./HardDeleteModal-CyBgP8oG.js";import"./corner-right-up-xElzR7oO.js";import"./MetadataHeader-BasyloSw.js";import"./DescriptionCell-JDDrCWCB.js";import"./ValidationCell-D9FwmVzb.js";const $={name:"day-off-list",components:{ButtonSimple:C,DayOffModal:x,DeleteModal:z,TableInfo:H},props:{daysOff:{default:()=>[],type:Array},isLoading:{default:!1,type:Boolean},isError:{default:!1,type:Boolean},dayOffError:{default:!1,type:[String,Boolean]}},emits:["set-day-off","unset-day-off"],data(){return{dayOffToEdit:null,modals:{setDayOff:!1,unsetDayOff:!1}}},computed:{dayOffInfo(){const{description:e,date:t,end_date:o}=this.personDayOff,h=o&&t!==o?`${t} - ${o}`:t;return`${e||this.$t("timesheets.day_off")} (${h})`},isDayOffError(){return!!this.dayOffError},dayOffTextError(){return this.dayOffError?.length?this.dayOffError:null},sortedDaysOff(){return[...this.daysOff].sort((e,t)=>t.date.localeCompare(e.date)).map(e=>({...e,period:e.date!==e.end_date?`${e.date} - ${e.end_date}`:e.date,date:S.utc(e.date).toDate(),end_date:S.utc(e.end_date||e.date).toDate()}))}},methods:{formatSimpleDate:L,openSetDayOffModal(e=null){e||(e={date:new Date}),this.dayOffToEdit=e,this.modals.setDayOff=!0},openUnsetDayOffModal(e){this.dayOffToEdit=e,this.modals.unsetDayOff=!0},closeSetDayOffModal(){this.modals.setDayOff=!1},closeUnsetDayOffModal(){this.modals.unsetDayOff=!1}}},ee={class:"day-off-list data-list"},te={class:"flexrow header"},se={key:0,class:"datatable-wrapper"},oe={class:"datatable"},ae={class:"datatable-head"},re={class:"datatable-row-header datatable-row-header--nobd period"},ie={class:"datatable-row-header datatable-row-header--nobd description"},ne={key:0,class:"datatable-body"},de={class:"period"},le={class:"description"},fe={class:"actions"},ce={key:1,class:"datatable-body"},ue={key:1,class:"has-text-centered mt2 mb1 strong"},he={key:2,class:"has-text-centered footer-info"};function me(e,t,o,h,a,s){const y=n("button-simple"),l=n("table-info"),f=n("day-off-modal"),b=n("delete-modal");return r(),c("div",ee,[i("div",te,[t[2]||(t[2]=i("div",{class:"filler"},null,-1)),u(y,{class:"flexrow-item",text:e.$t("days_off.add"),icon:"plus",onClick:s.openSetDayOffModal},null,8,["text","onClick"])]),s.sortedDaysOff.length>0?(r(),c("div",se,[i("table",oe,[i("thead",ae,[i("tr",null,[i("th",re,p(e.$t("days_off.period")),1),i("th",ie,p(e.$t("days_off.description")),1),t[3]||(t[3]=i("th",{class:"datatable-row-header datatable-row-header--nobd"},null,-1))])]),s.sortedDaysOff.length&&!o.isLoading?(r(),c("tbody",ne,[(r(!0),c(P,null,M(s.sortedDaysOff,m=>(r(),c("tr",{class:"datatable-row",key:m.id},[i("td",de,p(m.period),1),i("td",le,p(m.description),1),i("td",fe,[u(y,{onClick:g=>s.openSetDayOffModal(m),title:e.$t("days_off.edit"),icon:"edit"},null,8,["onClick","title"]),u(y,{onClick:g=>s.openUnsetDayOffModal(m),title:e.$t("days_off.delete"),icon:"trash"},null,8,["onClick","title"])])]))),128))])):o.isLoading?d("",!0):(r(),c("tbody",ce,t[4]||(t[4]=[i("tr",{class:"datatable-row"},[i("td",{class:"datatable-row-header",colspan:"4"})],-1)])))])])):d("",!0),s.sortedDaysOff.length===0&&!o.isLoading?(r(),c("div",ue,[i("p",null,p(e.$t("days_off.no_days_off")),1)])):d("",!0),u(l,{"is-loading":o.isLoading,"is-error":o.isError},null,8,["is-loading","is-error"]),o.isLoading?d("",!0):(r(),c("p",he,p(s.sortedDaysOff.length)+" "+p(e.$tc("days_off.nb_days_off",s.sortedDaysOff.length)),1)),u(f,{active:a.modals.setDayOff,"day-off-to-edit":a.dayOffToEdit,"is-error":s.isDayOffError,"error-text":s.dayOffTextError,onConfirm:t[0]||(t[0]=m=>{e.$emit("set-day-off",m)}),onCancel:s.closeSetDayOffModal},null,8,["active","day-off-to-edit","is-error","error-text","onCancel"]),u(b,{active:a.modals.unsetDayOff,text:e.$t("days_off.confirm_unset_day_offs",{start:s.formatSimpleDate(a.dayOffToEdit?.date),end:s.formatSimpleDate(a.dayOffToEdit?.end_date)}),"is-error":s.isDayOffError,"error-text":s.dayOffTextError,onConfirm:t[1]||(t[1]=m=>e.$emit("unset-day-off",a.dayOffToEdit)),onCancel:s.closeUnsetDayOffModal},null,8,["active","text","is-error","error-text","onCancel"])])}const ye=D($,[["render",me],["__scopeId","data-v-92774c89"]]),pe={name:"todos",mixins:[Y],components:{Combobox:j,ComboboxProduction:Q,DayOffList:ye,KanbanBoard:R,RouteSectionTabs:K,SearchField:J,SearchQueryList:W,TaskInfo:X,TimesheetList:N,TodosList:Z,UserCalendar:G},data(){return{currentFilter:"all_tasks",currentSort:"priority",currentSection:"todos",daysOff:[],dayOffError:!1,filterOptions:["all_tasks","due_this_week"].map(e=>({label:e,value:e})),loading:{doneTasks:!1,timesheets:!1,savingSearch:!1},productionId:void 0,selectedDate:S().format("YYYY-MM-DD"),sortOptions:["entity_name","priority","task_status_short_name","start_date","due_date","estimation","last_comment_date"].map(e=>({label:e,value:e}))}},async mounted(){this.updateActiveTab(),await this.$nextTick(),await this.loadData(),this.setSearchFromUrl(),this.onSearchChange()},afterDestroy(){this.$store.commit("USER_LOAD_TODOS_END",{tasks:[],userFilters:{},taskTypeMap:this.taskTypeMap})},computed:{...q(["displayedDoneTasks","displayedTodos","doneSelectionGrid","getProductionTaskStatuses","isTodosLoading","isTodosLoadingError","nbSelectedTasks","openProductions","productionMap","selectedTasks","taskStatuses","taskTypeMap","timeSpentMap","timeSpentTotal","todoListScrollPosition","todoSearchQueries","todoSelectionGrid","user"]),searchField(){return this.$refs["todos-search-field"]},boardTasks(){return this.sortedTasks.concat(this.sortedDoneTasks)},boardStatuses(){if(this.selectedProduction)return this.getBoardStatusesByProduction(this.selectedProduction);const e={};return this.openProductions.forEach(t=>{this.getBoardStatusesByProduction(t).forEach(h=>{e[h.id]||(e[h.id]=[]),e[h.id].push(t.id)})}),this.taskStatuses.filter(t=>!t.for_concept).map(t=>({...t,productions:e[t.id]||[]})).filter(t=>t.productions.length>0).sort((t,o)=>t.priority-o.priority)},productionList(){return[{name:this.$t("main.all")},...this.openProductions]},selectedProduction(){return this.productionMap.get(this.productionId)},pendingTasks(){return this.sortedTasks.filter(e=>e.taskStatus.is_feedback_request)},notPendingTasks(){return this.sortedTasks.filter(e=>!e.taskStatus.is_feedback_request)},todoTabs(){const e=this.openProductions.some(t=>this.getBoardStatusesByProduction(t).length);return[{label:this.$t("main.tasks"),name:"todos"},e?{label:this.$t("board.title"),name:"board"}:void 0,{label:this.$t("tasks.calendar"),name:"calendar"},{label:`${this.$t("tasks.pending")} (${this.pendingTasks.length})`,name:"pending"},{label:`${this.$t("tasks.validated")} (${this.loading.doneTasks?"…":this.sortedDoneTasks.length})`,name:"done"},{label:this.$t("timesheets.title"),name:"timesheets"},{label:this.$t("days_off.title"),name:"daysoff"}].filter(Boolean)},loggableTodos(){return this.sortedTasks.filter(e=>this.taskTypeMap.get(e.task_type_id).allow_timelog)},loggableDoneTasks(){return this.sortedDoneTasks.filter(e=>this.taskTypeMap.get(e.task_type_id).allow_timelog)},todoList(){return this.$refs["todo-list"]},haveDoneList(){return this.$refs["done-list"]},sortedTasks(){let e=this.displayedTodos;return this.productionId&&(e=e.filter(t=>t.project_id===this.productionId)),this.sortTasks(e,this.currentFilter,this.currentSort)},sortedDoneTasks(){let e=this.displayedDoneTasks;return this.productionId&&(e=e.filter(t=>t.project_id===this.productionId)),this.sortTasks(e,this.currentFilter,this.currentSort)}},methods:{...V(["clearSelectedTasks","loadAggregatedPersonDaysOff","loadOpenProductions","loadUserTimeSpents","loadTodos","loadDoneTasks","removeTodoSearch","saveTodoSearch","setDayOff","setTimeSpent","setTodoListScrollPosition","setTodosSearch","unsetDayOff"]),isActiveTab(e){return this.currentSection===e},async loadData(e=!1){this.loading.doneTasks=!0,await this.loadTodos({date:this.selectedDate,forced:e}),this.loadDoneTasks().then(()=>{this.loading.doneTasks=!1}),this.$nextTick(()=>{this.todoList?.setScrollPosition(this.todoListScrollPosition)}),this.resizeHeaders(),this.daysOff=await this.loadAggregatedPersonDaysOff({personId:this.user.id})},async loadTimeSpents(){this.isTasksLoading=!0,await this.loadUserTimeSpents({date:this.selectedDate}),this.isTasksLoading=!1},resizeHeaders(){this.$nextTick(()=>{this.todoList?.resizeHeaders(),this.haveDoneList?.resizeHeaders()})},updateActiveTab(){const e=["board","calendar","daysoff","done","pending","timesheets"],t=this.$route.query.section;this.currentSection=e.includes(t)?t:"todos";const o=this.openProductions.find(({id:h})=>h===this.$route.query.productionId);o?this.productionId=o.id:this.$router.push({query:{productionId:this.productionId,section:this.currentSection}}),this.clearSelectedTasks()},onSearchChange(){this.setSearchInUrl(),this.searchField&&this.setTodosSearch(this.searchField.getValue())},async saveSearchQuery(e){if(!this.loading.savingSearch)try{this.loading.savingSearch=!0,await this.saveTodoSearch(e),this.loading.savingSearch=!1}catch(t){console.error(t)}},async removeSearchQuery(e){try{await this.removeTodoSearch(e)}catch(t){console.error(t)}},async onDateChanged(e){this.loading.timesheets=!0,this.selectedDate=S(e).format("YYYY-MM-DD"),await this.loadTimeSpents(),this.loading.timesheets=!1},async onSetDayOff(e){this.dayOffError=!1;try{await this.setDayOff({...e,personId:this.user.id}),this.$refs["timesheet-list"]?.closeSetDayOffModal(),this.$refs["day-off-list"]?.closeSetDayOffModal()}catch(t){this.dayOffError=t.body?.message||!0}await this.loadData(!0)},async onUnsetDayOff(e){this.dayOffError=!1;try{await this.unsetDayOff(e),this.$refs["timesheet-list"]?.closeUnsetDayOffModal(),this.$refs["day-off-list"]?.closeUnsetDayOffModal()}catch(t){this.dayOffError=t.body?.message||!0}await this.loadData(!0)},onTimeSpentChange(e){e.personId=this.user.id,e.date=this.selectedDate,this.setTimeSpent(e)},async onAssignation(e){this.user.id===e.person_id&&(await this.loadOpenProductions(),await this.loadData(!0))},getBoardStatusesByProduction(e){const t=this.getProductionTaskStatuses(e.id).filter(o=>o.for_concept?!1:e.task_statuses_link?.[o.id]?.roles_for_board?.includes(this.user.role));return F(t,e)},sortTasks(e,t,o){e=t==="all_tasks"?[...e]:e.filter(l=>{const f=I(l.due_date);return S().startOf("week").isSame(f,"week")});const h=o==="entity_name",a=o==="priority",s=o==="due_date",y=o==="start_date";return h?e.sort(T.firstBy("project_name").thenBy("task_type_name").thenBy("full_entity_name")):a?e.sort(T.firstBy("priority",-1).thenBy((l,f)=>l.due_date?f.due_date?l.due_date.localeCompare(f.due_date):-1:1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name")):s?e.sort(T.firstBy((l,f)=>l.due_date?f.due_date?l.due_date.localeCompare(f.due_date):-1:1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name")):y?e.sort(T.firstBy((l,f)=>l.start_date?f.start_date?l.start_date.localeCompare(f.start_date):-1:1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name")):e.sort(T.firstBy(o,-1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name"))}},socket:{events:{"task:assign"(e){this.onAssignation(e)},"task:unassign"(e){this.onAssignation(e)}}},watch:{productionId(){this.$router.push({query:{productionId:this.productionId,section:this.currentSection}})},"$route.query.section"(){this.updateActiveTab()},"$route.query.search"(e){this.searchField?.setValue(e),this.onSearchChange()}},head(){return{title:`${this.$t("tasks.my_tasks")} - Kitsu`}}},_e={class:"columns fixed-page"},ge={class:"column main-column"},ke={class:"todos page"},Te={class:"flexrow"},Se={key:0,class:"query-list"},be={key:2},De={key:4},Oe={key:0,class:"column side-column"};function ve(e,t,o,h,a,s){const y=n("route-section-tabs"),l=n("search-field"),f=n("combobox-production"),b=n("combobox"),m=n("search-query-list"),g=n("todos-list"),O=n("kanban-board"),v=n("user-calendar"),B=n("timesheet-list"),w=n("day-off-list"),E=n("task-info");return r(),c("div",_e,[i("div",ge,[i("div",ke,[u(y,{class:"section-tabs mt05","active-tab":a.currentSection,route:e.$route,tabs:s.todoTabs},null,8,["active-tab","route","tabs"]),A(i("div",Te,[u(l,{ref:"todos-search-field",class:"flexrow-item search-field","can-save":!0,onChange:s.onSearchChange,onSave:s.saveSearchQuery},null,8,["onChange","onSave"]),u(f,{class:"flexrow-item production-field",label:e.$t("main.production"),"production-list":s.productionList,modelValue:a.productionId,"onUpdate:modelValue":t[0]||(t[0]=k=>a.productionId=k)},null,8,["label","production-list","modelValue"]),t[3]||(t[3]=i("span",{class:"filler"},null,-1)),u(b,{class:"flexrow-item",label:e.$t("main.show"),options:a.filterOptions,"locale-key-prefix":"tasks.",modelValue:a.currentFilter,"onUpdate:modelValue":t[1]||(t[1]=k=>a.currentFilter=k)},null,8,["label","options","modelValue"]),u(b,{class:"flexrow-item",label:e.$t("main.sorted_by"),options:a.sortOptions,"locale-key-prefix":"tasks.fields.",modelValue:a.currentSort,"onUpdate:modelValue":t[2]||(t[2]=k=>a.currentSort=k)},null,8,["label","options","modelValue"])],512),[[U,!s.isActiveTab("daysoff")]]),s.isActiveTab("daysoff")?d("",!0):(r(),c("div",Se,[u(m,{queries:e.todoSearchQueries,type:"todo",onRemoveSearch:s.removeSearchQuery},null,8,["queries","onRemoveSearch"])])),s.isActiveTab("todos")?(r(),_(g,{key:1,ref:"todo-list","empty-text":e.$t("people.no_task_assigned"),"is-loading":e.isTodosLoading,"is-error":e.isTodosLoadingError,tasks:s.notPendingTasks,"selection-grid":e.todoSelectionGrid,onScroll:e.setTodoListScrollPosition},null,8,["empty-text","is-loading","is-error","tasks","selection-grid","onScroll"])):d("",!0),s.isActiveTab("pending")?(r(),c("div",be," ")):d("",!0),s.isActiveTab("pending")?(r(),_(g,{key:3,ref:"pending-list","empty-text":e.$t("people.no_task_assigned"),"is-loading":e.isTodosLoading,"is-error":e.isTodosLoadingError,tasks:s.pendingTasks,"selection-grid":e.todoSelectionGrid,onScroll:e.setTodoListScrollPosition},null,8,["empty-text","is-loading","is-error","tasks","selection-grid","onScroll"])):d("",!0),s.isActiveTab("done")?(r(),c("div",De," ")):d("",!0),s.isActiveTab("done")?(r(),_(g,{key:5,ref:"done-list",class:"done-list",done:"","is-loading":a.loading.doneTasks||e.isTodosLoading,"is-error":e.isTodosLoadingError,"selection-grid":e.doneSelectionGrid,tasks:s.sortedDoneTasks},null,8,["is-loading","is-error","selection-grid","tasks"])):d("",!0),s.isActiveTab("board")?(r(),_(O,{key:6,"is-loading":e.isTodosLoading,"is-error":e.isTodosLoadingError,production:s.selectedProduction,statuses:s.boardStatuses,tasks:s.boardTasks,user:e.user},null,8,["is-loading","is-error","production","statuses","tasks","user"])):d("",!0),s.isActiveTab("calendar")?(r(),_(v,{key:7,"days-off":a.daysOff,"is-loading":e.isTodosLoading,tasks:s.sortedTasks},null,8,["days-off","is-loading","tasks"])):d("",!0),s.isActiveTab("timesheets")?(r(),_(B,{key:8,ref:"timesheet-list",tasks:s.loggableTodos,"done-tasks":s.loggableDoneTasks,"is-loading":a.loading.timesheets||e.isTodosLoading,"is-error":e.isTodosLoadingError,"days-off":a.daysOff,"day-off-error":a.dayOffError,"time-spent-map":e.timeSpentMap,"time-spent-total":e.timeSpentTotal,"hide-done":s.loggableDoneTasks.length===0,"hide-day-off":!1,onDateChanged:s.onDateChanged,onTimeSpentChange:s.onTimeSpentChange,onSetDayOff:s.onSetDayOff,onUnsetDayOff:s.onUnsetDayOff},null,8,["tasks","done-tasks","is-loading","is-error","days-off","day-off-error","time-spent-map","time-spent-total","hide-done","onDateChanged","onTimeSpentChange","onSetDayOff","onUnsetDayOff"])):d("",!0),s.isActiveTab("daysoff")?(r(),_(w,{key:9,ref:"day-off-list","days-off":a.daysOff,"day-off-error":a.dayOffError,onSetDayOff:s.onSetDayOff,onUnsetDayOff:s.onUnsetDayOff},null,8,["days-off","day-off-error","onSetDayOff","onUnsetDayOff"])):d("",!0)])]),e.nbSelectedTasks>0?(r(),c("div",Oe,[u(E,{task:e.selectedTasks.values().next().value,"with-actions":""},null,8,["task"])])):d("",!0)])}const Vt=D(pe,[["render",ve],["__scopeId","data-v-95950c89"]]);export{Vt as default};
//# sourceMappingURL=Todos-BjRNbAis.js.map
