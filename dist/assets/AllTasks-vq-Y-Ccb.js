import{_ as C,m as P,a as E,V as N,q as U,T as j,u as B,v as A,x as $,E as G,y as Y,z as q,A as V,r as l,c as p,o as d,e as a,d as _,f as c,t as o,F as v,g as L,n as D,k,G as O,H as K,I as z,J as F,K as x,L as H,C as W,M as Q,w as I,N as J}from"./index-5jsdBhLs.js";import{P as R}from"./PageLayout-2sJKcT-A.js";const X={name:"all-task-list",mixins:[Y,q],components:{EntityThumbnail:G,PeopleAvatarWithMenu:$,ProductionNameCell:A,Spinner:B,TableInfo:j,TaskTypeCell:U,ValidationCell:N},emits:["more-clicked","task-selected"],data(){return{lastSelection:null,page:1,selectionGrid:{}}},props:{isError:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},isMore:{type:Boolean,default:!1},isMoreLoading:{type:Boolean,default:!1},stats:{type:Object,default:()=>{}},tasks:{type:Array,default:()=>[]}},mounted(){window.addEventListener("keydown",this.onKeyDown,!1)},beforeUnmount(){window.removeEventListener("keydown",this.onKeyDown)},computed:{...E(["assetMap","editMap","episodeMap","nbSelectedTasks","personMap","user","selectedTasks","sequenceMap","shotMap","taskMap","isCurrentUserManager","isCurrentUserSupervisor","taskTypeMap"]),nbFrames(){let t=0;return this.tasks.forEach(e=>{t+=e.entity_nb_frames}),t}},methods:{...P(["addSelectedTask","addSelectedTasks","clearSelectedTasks","updateTask","unassignPersonFromTask","removeSelectedTask"]),getParentName(t){return t.sequence_name?t.episode_name?`${t.episode_name} - ${t.sequence_name}`:t.sequence_name:t.entity_type_name},getTaskName(t){return t.entity_name},getDate(t){return t?V(t,"YYYY-MM-DD").toDate():null},formatDate(t){return t?V(t).format("YYYY-MM-DD"):""},isEstimationBurned(t){return t.estimation&&t.estimation>0&&t.duration>t.estimation},onKeyDown(t){if(this.tasks.length>0&&t.altKey){let e=this.lastSelection?this.lastSelection:0;[37,38].includes(t.keyCode)?(e=e-1<0?e=this.tasks.length-1:e-1,this.selectTask({},e,this.tasks[e]),this.pauseEvent(t)):[39,40].includes(t.keyCode)&&(e=e+1>=this.tasks.length?e=0:e+1,this.selectTask({},e,this.tasks[e]),this.pauseEvent(t))}},selectTask(t,e,s){if(t&&t.target&&(["INPUT"].includes(t.target.nodeName)||t.target.parentNode&&["HEADER"].includes(t.target.parentNode.nodeName)||["cell day selected"].includes(t.target.className)))return;const f=this.selectionGrid[s.id],i=Object.keys(this.selectionGrid).length>1;this.clearSelectedTasks({task:s}),this.resetSelection(),this.selectionGrid[s.id]?(this.removeSelectedTask({task:s}),this.selectionGrid[s.id]=void 0):(!f||i)&&(this.addSelectedTask({task:s}),this.$emit("task-selected",s),this.selectionGrid[s.id]=!0,this.lastSelection=e)},setScrollPosition(t){this.$refs.body&&(this.$refs.body.scrollTop=t)},resetSelection(){this.selectionGrid={},this.lastSelection=null}},watch:{tasks(){this.page=1,this.resetSelection()},nbSelectedTasks(){this.nbSelectedTasks===0&&this.resetSelection()}}},Z={class:"data-list"},tt={ref:"body",class:"datatable-wrapper"},et={class:"datatable"},st={ref:"thead",class:"datatable-head"},at={class:"row-header"},ot={class:"thumbnail",ref:"th-thumbnail"},it=["title"],nt={class:"empty",ref:""},lt={class:"datatable-body"},rt=["onClick"],dt={class:"project"},ut={class:"thumbnail"},ct={class:"asset-type"},mt={class:"name"},pt={class:"assignees"},ht={class:"flexrow"},ft={class:"estimation number-cell"},_t={class:"start-date"},kt={class:"due-date"},yt={class:"done-date"},bt={key:0,class:"has-text-centered"},gt={key:0,class:"has-text-centered nb-tasks"};function Tt(t,e,s,f,i,r){const m=l("production-name-cell"),y=l("entity-thumbnail"),b=l("task-type-cell"),g=l("validation-cell"),T=l("people-avatar-with-menu"),S=l("spinner"),M=l("table-info");return d(),p("div",Z,[a("div",tt,[a("table",et,[a("thead",st,[a("tr",at,[a("th",{class:"project",ref:"th-name"},o(t.$t("tasks.fields.production")),513),a("th",ot,null,512),a("th",{class:"asset-type",ref:"th-type"},o(t.$t("tasks.fields.parent")),513),a("th",{class:"name",ref:"th-name"},o(t.$t("tasks.fields.entity")),513),a("th",{class:"name",ref:"th-name"},o(t.$t("tasks.fields.task_type")),513),a("th",{class:"status",ref:"th-status"},o(t.$t("tasks.fields.task_status")),513),a("th",{class:"assignees",ref:"th-assignees"},o(t.$t("tasks.fields.assignees")),513),a("th",{ref:"th-estimation",class:"estimation number-cell",title:t.$t("main.estimation")},o(t.$t("tasks.fields.estimation").substring(0,3))+". ",9,it),a("th",{class:"duration number-cell",ref:"th-duration"},o(t.$t("tasks.fields.duration").substring(0,3))+". ",513),a("th",{class:"start-date",ref:"th-date"},o(t.$t("tasks.fields.start_date")),513),a("th",{class:"due-date",ref:"th-date"},o(t.$t("tasks.fields.due_date")),513),a("th",{class:"done-date",ref:"th-date"},o(t.$t("tasks.fields.done_date")),513),a("th",nt,"Â ",512)])],512),a("tbody",lt,[(d(!0),p(v,null,L(s.tasks,(n,w)=>(d(),p("tr",{ref_for:!0,ref:"task-"+n.id,key:n.id,class:D({"task-line":!0,"datatable-row":!0,selected:i.selectionGrid[n.id]}),onClick:h=>r.selectTask(h,w,n)},[a("td",dt,[c(m,{class:"project",entry:{id:n.project_id,name:n.project_name},"only-avatar":!0,"is-link":!1},null,8,["entry"])]),a("td",ut,[c(y,{class:"flexrow-item","preview-file-id":n.last_preview_file_id,width:50,height:33,"empty-width":50,"empty-height":33},null,8,["preview-file-id"])]),a("td",ct,o(r.getParentName(n)),1),a("td",mt,o(n.entity_name),1),c(b,{class:"name","task-type":t.taskTypeMap.get(n.task_type_id)},null,8,["task-type"]),c(g,{class:"status unselectable","task-test":n,"is-border":!1,"is-assignees":!1,selectable:!1,"is-static":!0},null,8,["task-test"]),a("td",pt,[a("div",ht,[(d(!0),p(v,null,L(n.assignees,h=>(d(),k(T,{class:"flexrow-item",key:n.id+"-"+h,person:t.personMap.get(h),size:30,"font-size":16,onUnassign:u=>t.onUnassign(n,u)},null,8,["person","onUnassign"]))),128))])]),a("td",ft,o(t.formatDuration(n.estimation)),1),a("td",{class:D({duration:!0,"number-cell":!0,error:r.isEstimationBurned(n)})},o(t.formatDuration(n.duration)),3),a("td",_t,o(r.formatDate(n.start_date)),1),a("td",kt,o(r.formatDate(n.due_date)),1),a("td",yt,o(r.formatDate(n.done_date)),1),e[1]||(e[1]=a("td",{class:"empty"},null,-1))],10,rt))),128))])]),s.isMore&&!s.isLoading?(d(),p("div",bt,[s.isMoreLoading?(d(),k(S,{key:0,class:"mt2"})):s.isLoading?_("",!0):(d(),p("button",{key:1,class:"button mt2",onClick:e[0]||(e[0]=n=>t.$emit("more-clicked"))},o(t.$t("main.load_more")),1))])):_("",!0),c(M,{"is-loading":s.isLoading,"is-error":s.isError},null,8,["is-loading","is-error"])],512),s.isLoading?_("",!0):(d(),p("p",gt,o(s.stats.total)+" "+o(t.$tc("tasks.number",s.stats.total))+" ("+o(t.formatDuration(s.stats.total_duration))+" "+o(t.isDurationInHours?t.$tc("main.hours_spent",t.formatDuration(s.stats.total_duration,!1)):t.$tc("main.days_spent",t.formatDuration(s.stats.total_duration,!1)))+" / "+o(t.formatDuration(s.stats.total_estimation))+" "+o(t.isDurationInHours?t.$tc("main.hours_estimated",t.formatDuration(s.stats.total_estimation,!1)):t.$tc("main.days_estimated",t.formatDuration(s.stats.total_estimatio,!1)))+") ",1))])}const St=C(X,[["render",Tt],["__scopeId","data-v-2010941e"]]),Mt={name:"status-stats",props:{stats:Array},computed:{statMax(){return this.stats?this.stats.reduce((t,e)=>Math.max(e.value,t),0):0}}},wt={class:"status-stats"},It=["title"],vt={class:"stat-text"};function Lt(t,e,s,f,i,r){return d(),p("div",wt,[(d(!0),p(v,null,L(s.stats,m=>(d(),p("div",{key:"stat-"+m.name,class:"stat-wrapper"},[(d(),p("div",{key:"stat-value-"+m.name.toLowerCase(),class:"stat-line",title:m.name+": "+m.value,style:O({background:m.color,width:m.value/r.statMax*100+"%"})},[a("span",vt,o(m.name)+" : "+o(m.value),1)],12,It))]))),128))])}const Ct=C(Mt,[["render",Lt],["__scopeId","data-v-c23a229f"]]),Vt={name:"all-tasks",components:{AllTaskList:St,ComboboxDepartment:Q,ComboboxProduction:W,ComboboxTaskType:H,ComboboxStatus:x,ComboboxStudio:F,PageLayout:R,PeopleField:z,StatusStats:Ct,TaskInfo:K},data(){return{filters:{productionId:null,departmentId:null,studioId:null,taskStatusId:null,taskTypeId:null,person:null},isMore:!1,isMoreLoading:!1,isLoading:!1,isLoadingError:!1,tasks:[],stats:{status:[]}}},mounted(){const t=this.$route.query;t.project_id&&(this.filters.productionId=t.project_id),t.task_status_id&&(this.filters.taskStatusId=t.task_status_id),t.task_type_id&&(this.filters.taskTypeId=t.task_type_id),t.person_id&&(this.filters.person=this.activePeopleWithoutBot.find(e=>e.id===t.person_id)),this.reload()},computed:{...E(["activePeopleWithoutBot","getProductionTaskStatuses","getProductionTaskTypes","nbSelectedTasks","openProductions","personMap","productionMap","selectedTasks","taskStatus","taskStatusMap","taskTypes"]),taskStatusList(){const t=this.filters.productionId,e=this.getProductionTaskStatuses(t).filter(s=>!s.for_concept);return this.addAllValue(e)},taskTypeList(){const t=this.filters.productionId,e=this.getProductionTaskTypes(t).filter(s=>s.for_entity!=="Concept");return this.addAllValue(e)},personList(){const t=this.filters.productionId,e=this.productionMap.get(t);return e?J(e.team.map(s=>this.personMap.get(s)).filter(s=>s&&!s.is_bot)):this.activePeopleWithoutBot},productionList(){return this.addAllValue(this.openProductions)},params(){return{project_id:this.filters.productionId,task_status_id:this.filters.taskStatusId,task_type_id:this.filters.taskTypeId,person_id:this.filters.person?this.filters.person.map(t=>t.id).join(","):null,department_id:this.filters.departmentId,studio_id:this.filters.studioId}},statusStats(){return[...this.stats.status].sort((t,e)=>e.amount-t.amount).map(t=>{const e=this.taskStatusMap.get(t.task_status_id);return{name:e.short_name.toUpperCase(),color:e.color,value:t.amount}})}},methods:{...P(["clearSelectedTasks","loadOpenTasks","loadTask"]),addAllValue(t){return[{id:"",color:"#999",name:this.$t("main.all"),short_name:this.$t("main.all")}].concat([...t])},async reload(){this.isLoading=!0,this.page=1,this.clearSelectedTasks(),this.tasks=[];try{const t={};Object.keys(this.params).forEach(s=>{this.params[s]&&(t[s]=this.params[s])}),this.$router.push({query:t});const e=await this.loadOpenTasks(this.params);this.tasks=e.data,this.stats=e.stats,this.isMore=e.is_more}catch(t){this.isLoadingError=!0,console.error(t)}this.isLoading=!1},loadMore(){this.isMoreLoading=!0,this.page=(this.page||1)+1;const t={...this.params,page:this.page};this.loadOpenTasks(t).then(e=>{this.tasks=this.tasks.concat(e.data),this.isMore=e.is_more,this.isMoreLoading=!1}).catch(e=>{this.isMoreLoading=!1,this.isMoreLoadingError=!0,console.error(e)})},taskClicked(t){this.$router.push({name:"Task",params:{id:t.id}})}},watch:{filters:{handler(){this.reload()},deep:!0},"filters.person":{handler(){this.reload()},deep:!0}},socket:{events:{"task:update"(t){const e=this.tasks.find(s=>s.id===t.task_id);e&&this.loadTask({taskId:e.id}).then(s=>{Object.assign(e,s)})}}},head(){return{title:`${this.$t("tasks.all_tasks")} - Kitsu`}}},Dt={class:"all-tasks"},Pt={class:"filters flexrow mt1"},Et={class:"filters flexrow mt1 mb1"},Nt={class:"flexrow-item selector"},Ut={class:"label person-label"};function jt(t,e,s,f,i,r){const m=l("combobox-production"),y=l("combobox-status"),b=l("combobox-task-type"),g=l("combobox-studio"),T=l("combobox-department"),S=l("people-field"),M=l("all-task-list"),n=l("status-stats"),w=l("task-info"),h=l("page-layout");return d(),k(h,null,{main:I(()=>[a("div",Dt,[a("div",Pt,[c(m,{class:"flexrow-item mb0",label:t.$t("main.production"),"production-list":r.productionList,modelValue:i.filters.productionId,"onUpdate:modelValue":e[0]||(e[0]=u=>i.filters.productionId=u)},null,8,["label","production-list","modelValue"]),c(y,{class:"flexrow-item selector mb0",label:t.$t("news.task_status"),"task-status-list":r.taskStatusList,modelValue:i.filters.taskStatusId,"onUpdate:modelValue":e[1]||(e[1]=u=>i.filters.taskStatusId=u)},null,8,["label","task-status-list","modelValue"]),c(b,{class:"flexrow-item selector mb0",label:t.$t("news.task_type"),"task-type-list":r.taskTypeList,modelValue:i.filters.taskTypeId,"onUpdate:modelValue":e[2]||(e[2]=u=>i.filters.taskTypeId=u)},null,8,["label","task-type-list","modelValue"])]),a("div",Et,[c(g,{class:"mr1",label:t.$t("people.fields.studio"),modelValue:i.filters.studioId,"onUpdate:modelValue":e[3]||(e[3]=u=>i.filters.studioId=u)},null,8,["label","modelValue"]),c(T,{class:"flexrow-item",label:t.$t("main.department"),modelValue:i.filters.departmentId,"onUpdate:modelValue":e[4]||(e[4]=u=>i.filters.departmentId=u)},null,8,["label","modelValue"]),a("div",Nt,[a("label",Ut,o(t.$t("main.person")),1),c(S,{class:"person-field",multiple:!0,people:r.personList,modelValue:i.filters.person,"onUpdate:modelValue":e[5]||(e[5]=u=>i.filters.person=u)},null,8,["people","modelValue"])])]),c(M,{tasks:i.tasks,stats:i.stats,"is-loading":i.isLoading,"is-error":i.isLoadingError,"is-more":i.isMore,"is-more-loading":i.isMoreLoading,onTaskClicked:r.taskClicked,onMoreClicked:r.loadMore},null,8,["tasks","stats","is-loading","is-error","is-more","is-more-loading","onTaskClicked","onMoreClicked"])])]),side:I(()=>[c(w,{task:t.selectedTasks.values().next().value},{default:I(()=>[i.isLoading?_("",!0):(d(),k(n,{key:0,stats:r.statusStats},null,8,["stats"]))]),_:1},8,["task"])]),_:1})}const $t=C(Vt,[["render",jt],["__scopeId","data-v-ea3313ab"]]);export{$t as default};
//# sourceMappingURL=AllTasks-vq-Y-Ccb.js.map
