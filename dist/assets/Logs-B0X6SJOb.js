import{af as M,B as L,ah as E,aF as P,bt as x,x as A,m as C,aB as w,b as B,bu as D,_ as g,r as p,o as a,c,e as t,f as h,t as i,d as f,F as $,g as T,n as N,$ as S,l as k,s as j,v as I,T as V,y as z,bv as q,p as F}from"./index-a83mlrHR.js";const K={name:"events",mixins:[M],components:{ButtonSimple:L,DateField:E,PeopleAvatar:P,PeopleName:x,Spinner:A},data(){return{currentDate:new Date,events:[],isLoading:!0,selectedEvents:{}}},mounted(){this.loadDayEvents()},computed:{...C(["personMap","productionMap","user"]),today(){return w().toDate()}},methods:{...B(["loadEvents"]),formatType(e){return e.name.split(":")[1].substring(0,3)},loadDayEvents(){const e=w(this.currentDate).add(1,"days"),s=w(this.currentDate);this.selectedEvents={},this.isLoading=!0,this.loadEvents({after:D(s,this.timezone),before:D(e,this.timezone)}).then(n=>{this.isLoading=!1,this.events=n}).catch(n=>{this.isLoading=!1,console.error(n)})},selectLine(e){this.selectedEvents[e.id]=!this.selectedEvents[e.id]},isLink(e){return["project_id","task_id"].includes(e)},getLink(e,s){const n=e.data.project_id,v=s.substring(0,s.length-3);if(v==="project")return`/productions/${n}/news-feed`;{const l=e.data[s];return`/productions/${n}/${v}s/${l}`}}},watch:{currentDate(){this.loadDayEvents()}},head(){return{title:`${this.$t("logs.title")} - Kitsu`}}},R={class:"mt1"},W={class:"flexrow"},G={class:"flexrow-item nb-events"},O={key:0,class:"mt2 empty"},U={key:1,class:"has-text-centered"},H={key:2,class:"log-list"},J=["onClick"],Q={class:"date tag mr1"},X=["title","data-status"],Y={class:"name tag mr1"},Z={class:"flexrow"},ee={class:"key"},te=["href"],se={key:1};function ae(e,s,n,v,l,r){const _=p("date-field"),u=p("button-simple"),y=p("spinner"),b=p("people-avatar"),d=p("people-name");return a(),c("div",R,[t("div",W,[h(_,{class:"flexrow-item","can-delete":!1,"max-date":r.today,label:e.$t("logs.current_date_label"),modelValue:l.currentDate,"onUpdate:modelValue":s[0]||(s[0]=o=>l.currentDate=o)},null,8,["max-date","label","modelValue"]),h(u,{class:"flexrow-item small",icon:"refresh",onClick:r.loadDayEvents},null,8,["onClick"]),t("span",G,i(l.events.length)+" "+i(e.$t("logs.events")),1)]),!l.isLoading&&l.events.length===0?(a(),c("div",O,i(e.$t("logs.empty_list")),1)):f("",!0),l.isLoading?(a(),c("div",U,[h(y)])):(a(),c("div",H,[(a(!0),c($,null,T(l.events,o=>(a(),c("div",{class:"mt05 event-line",key:o.id,onClick:m=>r.selectLine(o)},[t("div",null,[t("span",Q,i(e.formatDate(o.created_at)),1),t("span",{class:"type tag",title:o.name.split(":")[1],"data-status":r.formatType(o)},i(r.formatType(o)),9,X),t("span",Y,i(o.name.split(":")[0]),1)]),N(t("ul",null,[t("li",Z,[s[1]||(s[1]=t("span",{class:"key"},"user",-1)),o.user_id?(a(),k(b,{key:0,class:"flexrow-item",size:20,person:e.personMap.get(o.user_id)},null,8,["person"])):f("",!0),o.user_id?(a(),k(d,{key:1,class:"flexrow-item",person:e.personMap.get(o.user_id)},null,8,["person"])):f("",!0)]),(a(!0),c($,null,T(Object.keys(o.data).sort(),m=>(a(),c("li",{class:"variable",key:o.id+"-"+m},[t("span",ee,i(m),1),r.isLink(m)?(a(),c("a",{key:0,href:r.getLink(o,m)},i(o.data[m]),9,te)):(a(),c("span",se,i(o.data[m]),1))]))),128))],512),[[S,l.selectedEvents[o.id]]])],8,J))),128))]))])}const ie=g(K,[["render",ae],["__scopeId","data-v-631689ea"]]),oe={name:"preview-file-list",mixins:[j],components:{ButtonSimple:L,ProductionNameCell:I,TableInfo:V,TaskTypeCell:z},props:{previewFiles:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1}},emits:["mark-broken-clicked"],data(){return{currentTask:null}},computed:{...C(["personMap","productionMap","taskTypeMap"])},methods:{...B(["loadTask","markBroken"]),onBodyScroll(e){const s=e.target;this.$refs.headerWrapper.style.left=`-${s.scrollLeft}px`},async redirectToTask(e,s){if(e.target.parentNode.className==="mark-broken-button button"||e.target.className==="mark-broken-button button")return;const n=await this.loadTask({taskId:s.task_id});return this.$router.push(q(n,n.project,n.project.production_type==="tvshow",n.episode,this.taskTypeMap))}}},ne={class:"data-list"},le={style:{overflow:"hidden"}},re={class:"datatable",ref:"headerWrapper"},ce={class:"datatable-head"},de={class:"datatable-row-header"},pe={class:"date"},_e={class:"production"},ue={class:"entity-name"},me={class:"task-type"},he={class:"revision"},fe={class:"status"},ve={class:"datatable"},ke={class:"datatable-body"},ye=["onClick"],ge={class:"date"},be={class:"production"},we={class:"entity-name"},$e={class:"revision"},Te=["data-status"],Le={class:"end-cell has-text-right"};function Ce(e,s,n,v,l,r){const _=p("table-info"),u=p("production-name-cell"),y=p("task-type-cell"),b=p("button-simple");return a(),c("div",ne,[t("div",le,[t("table",re,[t("thead",ce,[t("tr",de,[t("th",pe,i(e.$t("logs.preview_files.date")),1),t("th",_e,i(e.$t("logs.preview_files.production")),1),t("th",ue,i(e.$t("logs.preview_files.entity_name")),1),t("th",me,i(e.$t("logs.preview_files.task_type_id")),1),t("th",he,i(e.$t("logs.preview_files.revision")),1),t("th",fe,i(e.$t("logs.preview_files.status")),1),s[1]||(s[1]=t("th",{class:"end-cell"},null,-1))])])],512)]),h(_,{"is-loading":n.isLoading,"is-error":n.isError},null,8,["is-loading","is-error"]),n.previewFiles.length>0?(a(),c("div",{key:0,onScrollPassive:s[0]||(s[0]=(...d)=>r.onBodyScroll&&r.onBodyScroll(...d))},[t("table",ve,[t("tbody",ke,[(a(!0),c($,null,T(n.previewFiles,d=>(a(),c("tr",{key:d.id,class:"datatable-row",onClick:o=>r.redirectToTask(o,d)},[t("td",ge,i(e.formatDate(d.created_at)),1),t("td",be,[h(u,{entry:e.productionMap.get(d.project_id)},null,8,["entry"])]),t("td",we,i(d.full_entity_name),1),h(y,{class:"task-type","task-type":e.taskTypeMap.get(d.task_type_id)},null,8,["task-type"]),t("td",$e,i(d.revision),1),t("td",{class:"status","data-status":d.status},i(d.status),9,Te),t("td",Le,[d.status==="processing"?(a(),k(b,{key:0,class:"mark-broken-button",text:e.$t("logs.preview_files.mark_broken"),onClick:o=>e.$emit("mark-broken-clicked",d.id)},null,8,["text","onClick"])):f("",!0)])],8,ye))),128))])])],32)):f("",!0)])}const Be=g(oe,[["render",Ce],["__scopeId","data-v-5ac8f4fd"]]),De={name:"preview-files",mixins:[M],components:{ButtonSimple:L,PreviewFileList:Be},data(){return{previewFilesLoading:!0,previewFiles:[]}},computed:{...C(["personMap","taskTypeMap","user"]),displayedPreviewFiles(){return this.previewFiles.filter(e=>e.status!=="ready")}},methods:{...B(["getRunningPreviewFiles","markPreviewFileAsBroken"]),async reload(){this.previewFiles=[],this.previewFilesLoading=!0,this.previewFiles=await this.getRunningPreviewFiles(),this.previewFilesLoading=!1},async markBrokenClicked(e){const s=this.previewFiles.find(n=>n.id===e);s.status="broken",await this.markPreviewFileAsBroken(e)}},mounted(){this.reload()}},Fe={class:"mt1"},Me={class:"flexrow"},Ee={class:"flexrow-item"},Pe={key:0,class:"empty"};function xe(e,s,n,v,l,r){const _=p("button-simple"),u=p("preview-file-list");return a(),c("div",Fe,[t("p",Me,[t("em",Ee,i(e.$t("logs.preview_files.explanation")),1),s[0]||(s[0]=t("span",{class:"filler"},null,-1)),h(_,{class:"flexrow-item",icon:"refresh",onClick:r.reload},null,8,["onClick"])]),l.previewFiles.length===0&&!l.previewFilesLoading?(a(),c("p",Pe,i(e.$t("logs.preview_files.empty_list")),1)):(a(),k(u,{key:1,"preview-files":l.previewFiles,"is-loading":l.previewFilesLoading,onMarkBrokenClicked:r.markBrokenClicked},null,8,["preview-files","is-loading","onMarkBrokenClicked"]))])}const Ae=g(De,[["render",xe],["__scopeId","data-v-41e06691"]]),Ne={name:"logs",components:{Events:ie,PreviewFiles:Ae},data(){return{activeTab:"events"}},mounted(){this.$route.query.tab&&(this.activeTab=this.$route.query.tab)},methods:{isActiveTab(e){return this.activeTab===e}},watch:{activeTab(){this.$route.query.tab!==this.activeTab&&this.$router.push({query:{tab:this.activeTab}})}}},Se={class:"logs fixed-page"},je={class:"tabs logs-tabs"};function Ie(e,s,n,v,l,r){const _=p("events"),u=p("preview-files");return a(),c("div",Se,[t("div",je,[t("ul",null,[t("li",{class:F({"is-active":r.isActiveTab("events")})},[t("a",{onClick:s[0]||(s[0]=y=>l.activeTab="events")},i(e.$t("logs.title")),1)],2),t("li",{class:F({"is-active":r.isActiveTab("preview_files")})},[t("a",{onClick:s[1]||(s[1]=y=>l.activeTab="preview_files")},i(e.$t("logs.preview_files.title")),1)],2)])]),r.isActiveTab("events")?(a(),k(_,{key:0})):f("",!0),r.isActiveTab("preview_files")?(a(),k(u,{key:1})):f("",!0)])}const ze=g(Ne,[["render",Ie],["__scopeId","data-v-1c1caddd"]]);export{ze as default};
//# sourceMappingURL=Logs-B0X6SJOb.js.map
