import{_ as w,m as L,a as C,u as M,aG as P,aF as x,ak as A,B,am as E,aB as $,bA as D,r as p,c as r,o as i,e as t,d as u,f as k,t as a,F as g,g as T,k as v,a7 as j,q as z,T as I,v as S,z as V,bB as N,ai as q,n as F}from"./index-HWsAVBQH.js";const K={name:"events",mixins:[E],components:{ButtonSimple:B,DateField:A,PeopleAvatar:x,PeopleName:P,Spinner:M},data(){return{currentDate:new Date,events:[],isLoading:!0,selectedEvents:{}}},mounted(){this.loadDayEvents()},computed:{...C(["personMap","user"]),today(){return $().toDate()}},methods:{...L(["loadEvents"]),loadDayEvents(){const e=$(this.currentDate).add(1,"days"),s=$(this.currentDate);this.selectedEvents={},this.isLoading=!0,this.loadEvents({after:D(s,this.timezone),before:D(e,this.timezone)}).then(d=>{this.events=d.map(_=>{const[o,l]=_.name.split(":");return{id:_.id,date:this.formatDate(_.created_at),data:_.data,name:o,shortType:l.substring(0,3),type:l,user_id:_.user_id}})}).catch(d=>{console.error(d)}).finally(()=>{this.isLoading=!1})},selectLine(e){this.selectedEvents[e.id]=!this.selectedEvents[e.id]},isLink(e){return["project_id","task_id"].includes(e)},getLink(e,s){const d=e.data.project_id,_=s.substring(0,s.length-3);if(_==="project")return`/productions/${d}/news-feed`;{const o=e.data[s];return`/productions/${d}/${_}s/${o}`}}},watch:{currentDate(){this.loadDayEvents()}},head(){return{title:`${this.$t("logs.title")} - Kitsu`}}},R={class:"mt1"},W={class:"flexrow"},G={class:"flexrow-item nb-events"},O={key:0,class:"mt2 empty"},U={key:1,class:"has-text-centered"},H={key:2,class:"log-list"},J=["onClick"],Q={class:"date tag mr1"},X=["title","data-status"],Y={class:"name tag mr1"},Z={key:0},ee={class:"flexrow"},te={class:"key"},se=["href"];function ie(e,s,d,_,o,l){const m=p("date-field"),h=p("button-simple"),y=p("spinner"),b=p("people-avatar"),c=p("people-name");return i(),r("div",R,[t("div",W,[k(m,{class:"flexrow-item","can-delete":!1,"max-date":l.today,label:e.$t("logs.current_date_label"),modelValue:o.currentDate,"onUpdate:modelValue":s[0]||(s[0]=n=>o.currentDate=n)},null,8,["max-date","label","modelValue"]),k(h,{class:"flexrow-item small",icon:"refresh",onClick:l.loadDayEvents},null,8,["onClick"]),t("span",G,a(o.events.length)+" "+a(e.$t("logs.events")),1)]),!o.isLoading&&!o.events.length?(i(),r("div",O,a(e.$t("logs.empty_list")),1)):u("",!0),o.isLoading?(i(),r("div",U,[k(y)])):(i(),r("div",H,[(i(!0),r(g,null,T(o.events,n=>(i(),r("div",{class:"event-line",key:n.id,onClick:f=>l.selectLine(n)},[t("span",Q,a(n.date),1),t("span",{class:"type tag",title:n.type,"data-status":n.shortType},a(n.shortType),9,X),t("span",Y,a(n.name),1),o.selectedEvents[n.id]?(i(),r("ul",Z,[t("li",ee,[s[1]||(s[1]=t("span",{class:"key"},"user",-1)),n.user_id?(i(),v(b,{key:0,class:"flexrow-item",size:20,"font-size":10,person:e.personMap.get(n.user_id)},null,8,["person"])):u("",!0),n.user_id?(i(),v(c,{key:1,class:"flexrow-item",person:e.personMap.get(n.user_id),"with-link":""},null,8,["person"])):u("",!0)]),(i(!0),r(g,null,T(Object.keys(n.data).sort(),f=>(i(),r("li",{key:`${n.id}-${f}`},[t("span",te,a(f),1),l.isLink(f)?(i(),r("a",{key:0,href:l.getLink(n,f)},a(n.data[f]),9,se)):(i(),r(g,{key:1},[j(a(n.data[f]),1)],64))]))),128))])):u("",!0)],8,J))),128))]))])}const ae=w(K,[["render",ie],["__scopeId","data-v-e8750090"]]),oe={name:"preview-file-list",mixins:[V],components:{ButtonSimple:B,ProductionNameCell:S,TableInfo:I,TaskTypeCell:z},props:{previewFiles:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1}},emits:["mark-broken-clicked"],computed:{...C(["productionMap","taskTypeMap"])},methods:{...L(["loadTask"]),onBodyScroll(e){const s=e.target;this.$refs.headerWrapper.style.left=`-${s.scrollLeft}px`},async redirectToTask(e){const s=await this.loadTask({taskId:e.task_id});return this.$router.push(N(s,s.project,s.project.production_type==="tvshow",s.episode,this.taskTypeMap))}}},ne={class:"data-list"},le={style:{overflow:"hidden"}},re={class:"datatable",ref:"headerWrapper"},de={class:"datatable-head"},ce={class:"datatable-row-header"},pe={class:"date"},_e={class:"production"},ue={class:"entity-name"},me={class:"task-type"},he={class:"revision"},fe={class:"status"},ke={class:"datatable"},ve={class:"datatable-body"},ye=["onClick"],ge={class:"date"},we={class:"production"},be={class:"entity-name"},$e={class:"revision"},Te=["data-status"],Le={class:"end-cell has-text-right"};function Ce(e,s,d,_,o,l){const m=p("table-info"),h=p("production-name-cell"),y=p("task-type-cell"),b=p("button-simple");return i(),r("div",ne,[t("div",le,[t("table",re,[t("thead",de,[t("tr",ce,[t("th",pe,a(e.$t("logs.preview_files.date")),1),t("th",_e,a(e.$t("logs.preview_files.production")),1),t("th",ue,a(e.$t("logs.preview_files.entity_name")),1),t("th",me,a(e.$t("logs.preview_files.task_type_id")),1),t("th",he,a(e.$t("logs.preview_files.revision")),1),t("th",fe,a(e.$t("logs.preview_files.status")),1),s[1]||(s[1]=t("th",{class:"end-cell"},null,-1))])])],512)]),k(m,{"is-loading":d.isLoading,"is-error":d.isError},null,8,["is-loading","is-error"]),d.previewFiles.length>0?(i(),r("div",{key:0,onScrollPassive:s[0]||(s[0]=(...c)=>l.onBodyScroll&&l.onBodyScroll(...c))},[t("table",ke,[t("tbody",ve,[(i(!0),r(g,null,T(d.previewFiles,c=>(i(),r("tr",{key:c.id,class:"datatable-row",onClick:n=>l.redirectToTask(c)},[t("td",ge,a(e.formatDate(c.created_at)),1),t("td",we,[k(h,{entry:e.productionMap.get(c.project_id)},null,8,["entry"])]),t("td",be,a(c.full_entity_name),1),k(y,{class:"task-type","task-type":e.taskTypeMap.get(c.task_type_id)},null,8,["task-type"]),t("td",$e,a(c.revision),1),t("td",{class:"status","data-status":c.status},a(c.status),9,Te),t("td",Le,[c.status==="processing"?(i(),v(b,{key:0,class:"mark-broken-button",text:e.$t("logs.preview_files.mark_broken"),onClick:q(n=>e.$emit("mark-broken-clicked",c.id),["stop"])},null,8,["text","onClick"])):u("",!0)])],8,ye))),128))])])],32)):u("",!0)])}const Be=w(oe,[["render",Ce],["__scopeId","data-v-fa444a29"]]),De={name:"preview-files",mixins:[E],components:{ButtonSimple:B,PreviewFileList:Be},data(){return{previewFilesLoading:!0,previewFiles:[]}},computed:{...C(["personMap","taskTypeMap","user"]),displayedPreviewFiles(){return this.previewFiles.filter(e=>e.status!=="ready")}},methods:{...L(["getRunningPreviewFiles","markPreviewFileAsBroken"]),async reload(){this.previewFiles=[],this.previewFilesLoading=!0,this.previewFiles=await this.getRunningPreviewFiles(),this.previewFilesLoading=!1},async markBrokenClicked(e){const s=this.previewFiles.find(d=>d.id===e);s.status="broken",await this.markPreviewFileAsBroken(e)}},mounted(){this.reload()}},Fe={class:"mt1"},Ee={class:"flexrow"},Me={class:"flexrow-item"},Pe={key:0,class:"empty"};function xe(e,s,d,_,o,l){const m=p("button-simple"),h=p("preview-file-list");return i(),r("div",Fe,[t("p",Ee,[t("em",Me,a(e.$t("logs.preview_files.explanation")),1),s[0]||(s[0]=t("span",{class:"filler"},null,-1)),k(m,{class:"flexrow-item",icon:"refresh",onClick:l.reload},null,8,["onClick"])]),o.previewFiles.length===0&&!o.previewFilesLoading?(i(),r("p",Pe,a(e.$t("logs.preview_files.empty_list")),1)):(i(),v(h,{key:1,"preview-files":o.previewFiles,"is-loading":o.previewFilesLoading,onMarkBrokenClicked:l.markBrokenClicked},null,8,["preview-files","is-loading","onMarkBrokenClicked"]))])}const Ae=w(De,[["render",xe],["__scopeId","data-v-41e06691"]]),je={name:"logs",components:{Events:ae,PreviewFiles:Ae},data(){return{activeTab:"events"}},mounted(){this.$route.query.tab&&(this.activeTab=this.$route.query.tab)},methods:{isActiveTab(e){return this.activeTab===e}},watch:{activeTab(){this.$route.query.tab!==this.activeTab&&this.$router.push({query:{tab:this.activeTab}})}}},ze={class:"logs fixed-page"},Ie={class:"tabs logs-tabs"};function Se(e,s,d,_,o,l){const m=p("events"),h=p("preview-files");return i(),r("div",ze,[t("div",Ie,[t("ul",null,[t("li",{class:F({"is-active":l.isActiveTab("events")})},[t("a",{onClick:s[0]||(s[0]=y=>o.activeTab="events")},a(e.$t("logs.title")),1)],2),t("li",{class:F({"is-active":l.isActiveTab("preview_files")})},[t("a",{onClick:s[1]||(s[1]=y=>o.activeTab="preview_files")},a(e.$t("logs.preview_files.title")),1)],2)])]),l.isActiveTab("events")?(i(),v(m,{key:0})):u("",!0),l.isActiveTab("preview_files")?(i(),v(h,{key:1})):u("",!0)])}const Ne=w(je,[["render",Se],["__scopeId","data-v-1c1caddd"]]);export{Ne as default};
//# sourceMappingURL=Logs-Ds5k2sqr.js.map
