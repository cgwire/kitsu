import{_ as U,S as x,R as z,r as d,o as n,c as l,d as m,f as c,t as _,F as g,k as j,v as q,g as h,h as f,aE as Y,aF as V,aG as F,m as p,as as k,ao as N,u as y,a as Q,ap as S,aq as b,b as R}from"./index-C2m_IhNF.js";import{f as G}from"./format-CUjWrpVJ.js";import{s as H}from"./search-CWIHq9c3.js";import{C as K}from"./Combobox-DQpIQydI.js";import{C as J}from"./ComboboxNumber-CjSlWfmA.js";import{C as W}from"./ComboboxProduction-Dndrtu96.js";import{U as X,T as Z,K as $}from"./UserCalendar-30ZLCOJl.js";import{R as ee}from"./RouteSectionTabs-B7npqca_.js";import{S as se}from"./Schedule-BBoWBvCl.js";import{S as te}from"./SearchField-DO27Jrsj.js";import{S as re}from"./SearchQueryList-BrkMtSsZ.js";import oe from"./TaskInfo-C8qSIbPH.js";import{T as ae}from"./TodosList-C3TWuqz_.js";import"./dom-tO7tlkHV.js";import"./PreviewPlayer-CsSraBfQ.js";import"./PlaylistPlayer-DoTL8QsR.js";import"./ComboboxSimple-DU0Ahozo.js";import"./ComboboxTaskType-CiBcPUsC.js";import"./TaskTypeName-bEgQZfX7.js";import"./ModalFooter-BJ98b-60.js";import"./TextField-p_HJuEKt.js";import"./video-Yn96Kb74.js";import"./clipboard-CQqgyZ_h.js";import"./ComboboxStyled-fscUNRmK.js";import"./DeleteModal-CaB_X4-T.js";import"./index-KDZ8UbBO.js";import"./BaseModal-BCd5z4wK.js";import"./ComboboxDepartment-whRm-Bo0.js";import"./DepartmentName-C_7ZW05X.js";import"./ComboboxStudio-q2R7SCuH.js";import"./play-B4GV49GM.js";import"./render-Bqw3AFAH.js";import"./string-B0Tq569e.js";import"./EmojiButton-B9I5hDFH.js";import"./FileUpload-C4E3YXqL.js";import"./ComboboxStatus-DYpCiml-.js";import"./ConfirmModal-CYuRpfjg.js";import"./triangle-alert-DAfmXCpT.js";import"./ValidationTag-C6BUHddW.js";import"./thumbs-up-DoHhBcNt.js";import"./copy-BH2iDnK6.js";import"./vue.esm-bundler-Cb2j4MJL.js";import"./VideoViewer-Da8LCLxo.js";import"./EntityPreview-DQBzHKkN.js";import"./eye-CKzk1Q6q.js";import"./TableInfo-B2X54z7i.js";import"./DateField-OvNA3wsX.js";import"./InfoQuestionMark-jpROAGzb.js";import"./PageSubtitle-LvZN62xu.js";import"./ProductionNameCell-Bu7vB3PB.js";import"./TaskTypeCell-DM2gnWrD.js";import"./briefcase-DXQKuIYE.js";import"./list-chevrons-up-down-ByJjEZOU.js";import"./BooleanField-BK_C2MOf.js";import"./check-_fRnDsm9.js";import"./ColorField--VnpcHkf.js";import"./trash-2-DSHW2jWN.js";import"./chevron-up-kHAV03RH.js";import"./csv-cx9HGs3n.js";import"./BuildFilterModal-C3nrV5vY.js";import"./ComboboxBoolean-DJwCfClJ.js";import"./PeopleField-CJ8IkJD1.js";import"./DeleteEntities-ZGV8gTRL.js";import"./HardDeleteModal-CyBgP8oG.js";import"./corner-right-up-xElzR7oO.js";import"./MetadataHeader-BasyloSw.js";import"./DescriptionCell-JDDrCWCB.js";import"./ValidationCell-D9FwmVzb.js";const ie={name:"person",mixins:[G,H],components:{Combobox:K,ComboboxNumber:J,ComboboxProduction:W,KanbanBoard:$,PeopleAvatar:z,RouteSectionTabs:ee,Schedule:se,SearchField:te,SearchQueryList:re,Spinner:x,TaskInfo:oe,TimesheetList:Z,TodosList:ae,UserCalendar:X},data(){return{activeTab:"todos",currentSort:"entity_name",daysOff:[],dayOffError:!1,init:!1,isDoneTasksLoading:!1,isDoneTasksLoadingError:!1,isTasksLoading:!1,isTasksLoadingError:!1,loading:{savingSearch:!1},person:null,productionId:void 0,selectedDate:p().format("YYYY-MM-DD"),sortOptions:["entity_name","priority","task_status_short_name","start_date","due_date","estimation","last_comment_date"].map(e=>({label:e,value:e})),zoomLevel:1,zoomOptions:[{label:this.$t("main.week"),value:0},{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}]}},mounted(){this.productionId=this.$route.query.productionId||void 0,this.updateActiveTab(),this.loadPerson(this.$route.params.person_id),setTimeout(()=>{this.searchField?.focus(),this.$refs["schedule-widget"]?.scrollToDate(this.tasksStartDate)},300),this.setSearchFromUrl(),this.onSearchChange(),this.init=!0},afterDestroy(){this.$store.commit("LOAD_PERSON_TASKS_END",{tasks:[],userFilters:{},taskTypeMap:this.taskTypeMap})},computed:{...R(["displayedPersonTasks","displayedPersonDoneTasks","getProductionTaskStatuses","isCurrentUserAdmin","isCurrentUserManager","isCurrentUserSupervisor","nbSelectedTasks","personMap","personTasksScrollPosition","personTaskSearchQueries","personTaskSelectionGrid","personTimeSpentMap","personTimeSpentTotal","openProductions","productionMap","selectedTasks","taskStatuses","taskTypeMap","user"]),isCurrentUserAllowed(){return this.isCurrentUserManager||this.user.id===this.person.id?!0:this.isCurrentUserSupervisor?this.user.departments.some(s=>this.person.departments.includes(s)):!1},loggablePersonTasks(){return this.sortedTasks.filter(e=>this.taskTypeMap.get(e.task_type_id).allow_timelog)},loggableDoneTasks(){return this.sortedDoneTasks.filter(e=>this.taskTypeMap.get(e.task_type_id).allow_timelog)},searchField(){return this.$refs["person-tasks-search-field"]},taskList(){return this.$refs["task-list"]},haveDoneList(){return this.$refs["done-list"]},sortedTasks(){let e=this.sortTasks([...this.displayedPersonTasks]);return this.productionId&&(e=e.filter(s=>s.project_id===this.productionId)),e},sortedDoneTasks(){let e=this.sortTasks([...this.displayedPersonDoneTasks]);return this.productionId&&(e=e.filter(s=>s.project_id===this.productionId)),e},sortedAllTasks(){let e=this.sortTasks([...this.displayedPersonTasks,...this.displayedPersonDoneTasks]);return this.productionId&&(e=e.filter(s=>s.project_id===this.productionId)),e},tasksStartDate(){return this.scheduleTasks.length?S(this.scheduleTasks):p()},tasksEndDate(){return this.scheduleTasks.length?b(this.scheduleTasks):p().add(15,"days")},scheduleTasks(){return this.scheduleItems.flatMap(e=>e.children)},scheduleItems(){const e=new Map;this.sortedAllTasks.forEach(o=>{if(!e.get(o.project_id)){const t=this.productionMap.get(o.project_id),i=this.buildProjectScheduleItem(t);e.set(o.project_id,i)}const a=e.get(o.project_id),r=this.buildTaskScheduleItem(a,o);r&&a.children.push(r)});const s=Array.from(e.values());return s.forEach(o=>{let a=p(),r=p().add(1,"days"),t=0;o.children.length>0&&(a=S(o.children),r=b(o.children)),o.children.forEach(i=>{i.estimation&&(t+=i.estimation)}),Object.assign(o,{startDate:a,endDate:r,man_days:t,daysOff:this.daysOff})}),s},boardTasks(){const e=this.sortedAllTasks;return this.selectedProduction?e.filter(s=>s.project_id===this.selectedProduction.id):e},boardStatuses(){if(this.selectedProduction)return this.getBoardStatusesByProduction(this.selectedProduction);const e={};return this.userOpenProductions.forEach(s=>{this.getBoardStatusesByProduction(s).forEach(a=>{e[a.id]||(e[a.id]=[]),e[a.id].push(s.id)})}),this.taskStatuses.filter(s=>!s.for_concept).map(s=>({...s,productions:e[s.id]||[]})).filter(s=>s.productions.length>0).sort((s,o)=>s.priority-o.priority)},productionList(){return[{name:this.$t("main.all")},...this.userOpenProductions]},selectedProduction(){return this.productionMap.get(this.productionId)},userOpenProductions(){return this.person?this.openProductions.filter(e=>e.team.includes(this.person.id)):[]},todoTabs(){const e=this.openProductions.some(s=>this.getBoardStatusesByProduction(s).length);return[{label:this.$t("main.tasks"),name:"todos"},e?{label:this.$t("board.title"),name:"board"}:void 0,{label:this.$t("tasks.calendar"),name:"calendar"},{label:this.$t("schedule.title"),name:"schedule"},{label:`${this.$t("tasks.validated")} (${this.isDoneTasksLoading?"â€¦":this.displayedPersonDoneTasks.length})`,name:"done"},{label:this.$t("timesheets.title"),name:"timesheets"}].filter(Boolean)}},methods:{...Q(["clearSelectedTasks","loadAggregatedPersonDaysOff","loadPersonDoneTasks","loadPersonTasks","loadPersonTimeSpents","setPersonTasksSearch","savePersonTasksSearch","removePersonTasksSearch","setDayOff","setPersonTasksScrollPosition","setTimeSpent","unsetDayOff","updateTask"]),sortTasks(e){const s=this.currentSort==="entity_name",o=this.currentSort==="priority",a=this.currentSort==="due_date",r=this.currentSort==="start_date";return s?e.sort(y.firstBy("project_name").thenBy("task_type_name").thenBy("full_entity_name")):o?e.sort(y.firstBy("priority",-1).thenBy((t,i)=>t.due_date?i.due_date?t.due_date.localeCompare(i.due_date):-1:1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name")):a?e.sort(y.firstBy((t,i)=>t.due_date?i.due_date?t.due_date.localeCompare(i.due_date):-1:1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name")):r?e.sort(y.firstBy((t,i)=>t.start_date?i.start_date?t.start_date.localeCompare(i.start_date):-1:1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name")):e.sort(y.firstBy(this.currentSort,-1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name"))},onAssignation(e){this.person.id===e.person_id&&this.loadPerson(this.person.id)},buildProjectScheduleItem(e){return{...e,avatar:!0,color:N.fromString(e.name,!0),priority:1,expanded:!0,loading:!1,children:[],editable:!1}},buildTaskScheduleItem(e,s){let o=p(),a;if(!s.start_date&&!s.real_start_date&&!s.due_date&&!s.end_date)return null;s.start_date?o=k(s.start_date):s.real_start_date&&(o=k(s.real_start_date));const r=s.estimation;s.due_date?a=k(s.due_date):s.end_date?a=k(s.end_date):s.estimation&&(a=o.clone().add(r,"days")),(!a||a.isBefore(o))&&(a=o.clone().add(1,"days"));const t=this.taskTypeMap.get(s.task_type_id);return{...s,name:`${s.full_entity_name} / ${t.name}`,startDate:o,endDate:a,expanded:!1,loading:!1,man_days:r,editable:!1,unresizable:!1,parentElement:e,color:t.color,children:[]}},isActiveTab(e){return this.init&&this.activeTab===e},onSearchChange(e){e=e||this.searchField?.getValue(),this.setSearchInUrl(e),this.setPersonTasksSearch(e)},async loadPerson(e){if(this.person=this.personMap.get(e),!this.person){this.$router.push({name:"not-found"});return}if(!(this.person.is_bot||!this.isCurrentUserAllowed)){this.isTasksLoading=!0,this.isDoneTasksLoading=!0,this.isTasksLoadingError=!1;try{await this.loadPersonTasks({personId:this.person.id,date:this.selectedDate}),setTimeout(()=>{this.$nextTick(()=>{this.taskList?.setScrollPosition(this.personTasksScrollPosition)}),this.resizeHeaders()},0),this.isTasksLoading=!1;try{await this.loadPersonDoneTasks(this.person.id),this.isDoneTasksLoading=!1}catch{this.isDoneTasksLoadingError=!0,this.isDoneTasksLoading=!1}}catch{this.isTasksLoading=!1,this.isTasksLoadingError=!0}this.loadDaysOff()}},async loadDaysOff(){const e=this.person.id;try{this.daysOff=await this.loadAggregatedPersonDaysOff({personId:e})}catch(s){console.error(s)}},async loadTimeSpents(){this.isTasksLoading=!0,await this.loadPersonTimeSpents({personId:this.person.id,date:this.selectedDate}),this.isTasksLoading=!1},resizeHeaders(){this.$nextTick(()=>{this.taskList?.resizeHeaders(),this.haveDoneList?.resizeHeaders()})},saveSearchQuery(e){this.loading.savingSearch||(this.loading.savingSearch=!0,this.savePersonTasksSearch(e).catch(console.error).finally(()=>{this.loading.savingSearch=!1}))},removeSearchQuery(e){this.removePersonTasksSearch(e).catch(s=>{s&&console.error(s)})},updateActiveTab(){const e=["board","calendar","done","schedule","timesheets"],s=this.$route.query.section;if(this.activeTab=e.includes(s)?s:"todos",this.activeTab==="board"){const o=this.userOpenProductions.find(({id:a})=>a===this.$route.query.productionId);o?this.productionId=o.id:this.$router.push({query:{productionId:this.productionId,section:this.activeTab,search:this.$route.query.search}})}this.clearSelectedTasks()},onTimeSpentChange(e){e.personId=this.person.id,e.date=this.selectedDate,this.setTimeSpent(e)},async onDateChanged(e){this.selectedDate=p(e).format("YYYY-MM-DD"),await this.loadTimeSpents()},async onSetDayOff(e){this.dayOffError=!1;try{await this.setDayOff({...e,personId:this.person.id}),this.$refs["timesheet-list"]?.closeSetDayOffModal()}catch(s){this.dayOffError=s.body?.message||!0}await this.loadDaysOff()},async onUnsetDayOff(e){this.dayOffError=!1;try{await this.unsetDayOff(e),this.$refs["timesheet-list"]?.closeUnsetDayOffModal()}catch(s){this.dayOffError=s.body?.message||!0}await this.loadDaysOff()},saveTaskScheduleItem(e){e.estimation&&(e.endDate=V(e.startDate,Math.ceil(F(this.organisation,e.estimation))-1,e.parentElement.daysOff)),e.man_days=e.estimation||0,e.startDate&&e.endDate&&this.updateTask({taskId:e.id,data:{estimation:e.estimation,start_date:e.startDate.format("YYYY-MM-DD"),due_date:e.endDate.format("YYYY-MM-DD")}})},getBoardStatusesByProduction(e){const s=this.getProductionTaskStatuses(e.id).filter(o=>o.for_concept?!1:e.task_statuses_link?.[o.id]?.roles_for_board?.includes(this.user.role));return Y(s,e)}},head(){return{title:`${this.person?.name||"..."} - Kitsu`}},watch:{"$route.params.person_id"(e){this.updateActiveTab(),this.person&&this.person.id!==e&&this.loadPerson(e)},"$route.query.search"(e){this.searchField?.setValue(e),this.onSearchChange(e)},activeTab(){this.$nextTick(()=>{this.$refs["schedule-widget"]?.scrollToDate(this.tasksStartDate)})},"$route.query.section"(){this.updateActiveTab()},productionId(){this.$router.push({query:{...this.$route.query,productionId:this.productionId}})},zoomLevel(){this.$refs["schedule-widget"]?.scrollToDate(this.tasksStartDate)}},socket:{events:{"task:assign"(e){this.onAssignation(e)},"task:unassign"(e){this.onAssignation(e)}}}},ne={ref:"page",class:"columns fixed-page"},de={class:"column main-column"},le={key:0,class:"person page"},ce={ref:"header",class:"flexrow page-header"},ue={class:"flexrow-item"},he={class:"flexrow-item entity-title"},pe={ref:"search",class:"flexrow"},me={key:0,ref:"query",class:"query-list"},fe={key:1},ye={key:2,class:"has-text-centered"},ke={key:0,class:"column side-column"};function Te(e,s,o,a,r,t){const i=d("people-avatar"),D=d("route-section-tabs"),v=d("search-field"),P=d("combobox-production"),L=d("combobox-number"),O=d("combobox"),I=d("search-query-list"),T=d("todos-list"),B=d("kanban-board"),C=d("user-calendar"),A=d("timesheet-list"),w=d("schedule"),M=d("spinner"),E=d("task-info");return n(),l("div",ne,[m("div",de,[r.person?(n(),l("div",le,[m("div",ce,[m("div",ue,[c(i,{person:r.person,size:80,"font-size":30,"is-text":!1},null,8,["person"])]),m("div",he,_(r.person.name),1)],512),!r.person.is_bot&&t.isCurrentUserAllowed?(n(),l(g,{key:0},[c(D,{class:"section-tabs mt1","active-tab":r.activeTab,route:e.$route,tabs:t.todoTabs},null,8,["active-tab","route","tabs"]),j(m("div",pe,[c(v,{ref:"person-tasks-search-field",class:"search-field flexrow-item","can-save":"",onChange:t.onSearchChange,onSave:t.saveSearchQuery},null,8,["onChange","onSave"]),c(P,{class:"flexrow-item production-field",label:e.$t("main.production"),"production-list":t.productionList,modelValue:r.productionId,"onUpdate:modelValue":s[0]||(s[0]=u=>r.productionId=u)},null,8,["label","production-list","modelValue"]),s[4]||(s[4]=m("span",{class:"filler"},null,-1)),t.isActiveTab("schedule")?(n(),h(L,{key:0,class:"flexrow-item zoom-level mb0",label:e.$t("schedule.zoom_level"),options:r.zoomOptions,modelValue:r.zoomLevel,"onUpdate:modelValue":s[1]||(s[1]=u=>r.zoomLevel=u)},null,8,["label","options","modelValue"])):f("",!0),c(O,{class:"flexrow-item",label:e.$t("main.sorted_by"),options:r.sortOptions,"locale-key-prefix":"tasks.fields.",modelValue:r.currentSort,"onUpdate:modelValue":s[2]||(s[2]=u=>r.currentSort=u)},null,8,["label","options","modelValue"])],512),[[q,!t.isActiveTab("calendar")]]),t.isActiveTab("calendar")?f("",!0):(n(),l("div",me,[c(I,{queries:e.personTaskSearchQueries,type:"person",onRemoveSearch:t.removeSearchQuery},null,8,["queries","onRemoveSearch"])],512)),t.isActiveTab("todos")?(n(),h(T,{key:1,ref:"task-list","empty-text":e.$t("people.no_task_assigned"),"is-loading":r.isTasksLoading,"is-error":r.isTasksLoadingError,"selection-grid":e.personTaskSelectionGrid,tasks:t.sortedTasks,onScroll:e.setPersonTasksScrollPosition},null,8,["empty-text","is-loading","is-error","selection-grid","tasks","onScroll"])):t.isActiveTab("done")?(n(),h(T,{key:2,ref:"done-list",done:"","empty-text":e.$t("people.no_task_assigned"),"is-loading":r.isDoneTasksLoading,"is-error":r.isDoneTasksLoadingError,"selection-grid":e.personTaskSelectionGrid,tasks:t.sortedDoneTasks},null,8,["empty-text","is-loading","is-error","selection-grid","tasks"])):t.isActiveTab("board")?(n(),h(B,{key:3,"is-loading":r.isTasksLoading,"is-error":r.isTasksLoadingError,production:t.selectedProduction,statuses:t.boardStatuses,tasks:t.boardTasks,user:e.user},null,8,["is-loading","is-error","production","statuses","tasks","user"])):t.isActiveTab("calendar")?(n(),h(C,{key:4,class:"calendar","is-loading":r.isTasksLoading,"days-off":r.daysOff,tasks:t.sortedAllTasks},null,8,["is-loading","days-off","tasks"])):t.isActiveTab("timesheets")&&e.isCurrentUserManager?(n(),h(A,{key:5,ref:"timesheet-list",tasks:t.loggablePersonTasks,"done-tasks":t.loggableDoneTasks,"is-loading":r.isTasksLoading,"is-error":r.isTasksLoadingError,"days-off":r.daysOff,"day-off-error":r.dayOffError,"time-spent-map":e.personTimeSpentMap,"time-spent-total":e.personTimeSpentTotal,"hide-done":!1,"hide-day-off":!(e.isCurrentUserAdmin||e.user.id===r.person.id),onDateChanged:t.onDateChanged,onTimeSpentChange:t.onTimeSpentChange,onSetDayOff:t.onSetDayOff,onUnsetDayOff:t.onUnsetDayOff},null,8,["tasks","done-tasks","is-loading","is-error","days-off","day-off-error","time-spent-map","time-spent-total","hide-day-off","onDateChanged","onTimeSpentChange","onSetDayOff","onUnsetDayOff"])):t.isActiveTab("schedule")?(n(),l(g,{key:6},[t.scheduleItems.length>0?(n(),h(w,{key:0,ref:"schedule-widget","days-off":r.daysOff,"start-date":t.tasksStartDate.clone().add(-3,"months"),"end-date":t.tasksEndDate.clone().add(3,"months"),hierarchy:t.scheduleItems,"zoom-level":r.zoomLevel,"is-loading":r.isTasksLoading,"is-estimation-linked":!0,"with-milestones":!1,onItemChanged:t.saveTaskScheduleItem,onEstimationChanged:s[3]||(s[3]=u=>t.saveTaskScheduleItem(u.item))},null,8,["days-off","start-date","end-date","hierarchy","zoom-level","is-loading","onItemChanged"])):r.isTasksLoading?(n(),l("div",fe,[c(M)])):(n(),l("div",ye,_(e.$t("main.empty_schedule")),1))],64)):f("",!0)],64)):f("",!0)])):f("",!0)]),e.nbSelectedTasks===1?(n(),l("div",ke,[c(E,{task:e.selectedTasks.values().next().value},null,8,["task"])])):f("",!0)],512)}const Ms=U(ie,[["render",Te],["__scopeId","data-v-65f7b7b4"]]);export{Ms as default};
//# sourceMappingURL=Person-BRxaNMrO.js.map
