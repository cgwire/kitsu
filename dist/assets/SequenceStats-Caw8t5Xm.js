import{ao as M,T as w,m as k,bm as T,bo as P,_ as L,r as h,o,c as l,e as n,t as d,F as f,g as q,A as g,l as _,w as E,a3 as V,d as m,f as u,ba as b,B as D,C as B,S as x,av as F,b as O,aB as A,ab as Q,ac as U}from"./index-a83mlrHR.js";import{S as N}from"./StatsCell-B2gZqQaR.js";const R={name:"sequence-stats-list",mixins:[M],components:{StatsCell:N,TableInfo:w},props:{countMode:{type:String,default:"count"},displayMode:{type:String,default:"pie"},entries:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1},sequenceStats:{type:Object,default:()=>{}},showAll:{type:Boolean,default:!1},validationColumns:{type:Array,default:()=>[]}},computed:{...k(["currentProduction","currentEpisode","displayedSequencesLength","isCurrentUserClient","isTVShow","sequenceSearchText","taskTypeMap"]),entryStats(){return this.entries.filter(e=>this.isEntryStats(e.id))},isEmptyList(){return this.entries&&this.entries.length===0&&!this.isLoading&&!this.isError&&(!this.sequenceSearchText||this.sequenceSearchText.length===0)}},methods:{chartColors(e,t){return T(this.sequenceStats,e,t)},chartData(e,t,s="count"){return P(this.sequenceStats,e,t,s)},isStats(e,t){return this.sequenceStats[e]&&this.sequenceStats[e][t]},isEntryStats(e){if(!this.sequenceStats[e]&&this.sequenceSearchText)return!1;if(!this.sequenceStats[e])return!0;let t=!1;return Object.keys(this.sequenceStats[e]).forEach(s=>{t=t||this.sequenceStats[e][s]}),t},editPath(e){return this.getPath("edit-sequence",e)},deletePath(e){return this.getPath("delete-sequence",e)},taskTypePath(e){const t={name:"task-type",params:{production_id:this.currentProduction.id,task_type_id:e,type:"shots"}};return this.isTVShow&&this.currentEpisode&&(t.name="episode-task-type",t.params.episode_id=this.currentEpisode.id),t},getPath(e,t){const s={name:e,params:{production_id:this.currentProduction.id}};return this.isTVShow&&this.currentEpisode&&(s.name=`episode-${e}`,s.params.episode_id=this.currentEpisode.id),t&&(s.params.sequence_id=t),s}}},Y={class:"data-list"},j={class:"datatable"},K={class:"datatable-head"},z={scope:"col",class:"validation"},G={key:1,class:"flexrow-item"},H={key:0,class:"datatable-body"},J={key:0,class:"all-line datatable-row"},W={scope:"row",class:"name datatable-row-header"},X={scope:"row",class:"name datatable-row-header"},Z={key:1},I={key:0,class:"has-text-centered"},$={class:"info"},ee={key:1,class:"has-text-centered"},te={class:"info"},se={key:2,class:"has-text-centered nb-sequences"};function ae(e,t,s,p,r,a){const v=h("router-link"),S=h("stats-cell"),y=h("table-info");return o(),l("div",Y,[n("div",{class:"datatable-wrapper",ref:"body",onScrollPassive:t[0]||(t[0]=(...i)=>e.onBodyScroll&&e.onBodyScroll(...i))},[n("table",j,[n("thead",K,[n("tr",null,[n("th",{scope:"col",class:"name datatable-row-header",ref:"th-sequence"},d(e.$t("shots.fields.sequence")),513),n("th",z,d(e.$t("main.all")),1),s.isLoading?m("",!0):(o(!0),l(f,{key:0},q(s.validationColumns,i=>(o(),l("th",{scope:"col",class:"validation validation-cell",key:i},[n("div",{class:"flexrow validation-content",style:g(e.getValidationStyle(i))},[e.isCurrentUserClient?(o(),l("span",G,d(e.taskTypeMap.get(i).name),1)):(o(),_(v,{key:0,class:"flexrow-item",title:e.taskTypeMap.get(i).name,to:a.taskTypePath(i)},{default:E(()=>[V(d(e.taskTypeMap.get(i).name),1)]),_:2},1032,["title","to"]))],4)]))),128)),t[1]||(t[1]=n("th",{scope:"col",class:"actions"},null,-1))])]),s.isLoading?m("",!0):(o(),l("tbody",H,[s.showAll&&!a.isEmptyList?(o(),l("tr",J,[n("th",W,d(e.$t("sequences.all_sequences")),1),u(S,{class:"all-validation",colors:a.chartColors("all","all"),data:a.chartData("all","all"),"frames-data":a.chartData("all","all","frames"),"count-mode":s.countMode,"display-mode":s.displayMode},null,8,["colors","data","frames-data","count-mode","display-mode"]),(o(!0),l(f,null,q(s.validationColumns,i=>(o(),_(S,{style:g(e.getValidationStyle(i)),key:"all-"+i,colors:a.chartColors("all",i),data:a.chartData("all",i),"frames-data":a.chartData("all",i,"frames"),"count-mode":s.countMode,"display-mode":s.displayMode},null,8,["style","colors","data","frames-data","count-mode","display-mode"]))),128)),t[2]||(t[2]=n("td",{class:"actions"},null,-1))])):m("",!0),(o(!0),l(f,null,q(a.entryStats,i=>(o(),l("tr",{class:"datatable-row",key:i.id},[n("td",X,d(i.name),1),a.isStats(i.id,"all")?(o(),_(S,{key:0,colors:a.chartColors(i.id,"all"),data:a.chartData(i.id,"all"),"frames-data":a.chartData(i.id,"all","frames"),"count-mode":s.countMode,"display-mode":s.displayMode},null,8,["colors","data","frames-data","count-mode","display-mode"])):(o(),l("td",Z)),(o(!0),l(f,null,q(s.validationColumns,c=>(o(),l(f,{key:i.id+"-"+c},[a.isStats(i.id,c)?(o(),_(S,{key:i.id+c,style:g(e.getValidationStyle(c)),colors:a.chartColors(i.id,c),data:a.chartData(i.id,c),"frames-data":a.chartData(i.id,c,"frames"),"count-mode":s.countMode,"display-mode":s.displayMode},null,8,["style","colors","data","frames-data","count-mode","display-mode"])):(o(),l("td",{key:1,style:g(e.getValidationStyle(c))},null,4))],64))),128)),t[3]||(t[3]=n("td",{class:"actions"},null,-1))]))),128))]))])],544),u(y,{"is-loading":s.isLoading,"is-error":s.isError},null,8,["is-loading","is-error"]),a.isEmptyList&&!e.isCurrentUserClient&&!s.isLoading?(o(),l("div",I,[t[4]||(t[4]=n("p",{class:"info"},[n("img",{src:b})],-1)),n("p",$,d(e.$t("sequences.empty_list")),1)])):m("",!0),a.isEmptyList&&e.isCurrentUserClient&&!s.isLoading?(o(),l("div",ee,[t[5]||(t[5]=n("p",{class:"info"},[n("img",{src:b})],-1)),n("p",te,d(e.$t("sequences.empty_list_client")),1)])):m("",!0),!a.isEmptyList&&!s.isLoading?(o(),l("p",se,d(e.displayedSequencesLength)+" "+d(e.$tc("sequences.number",e.displayedSequencesLength)),1)):m("",!0)])}const ie=L(R,[["render",ae],["__scopeId","data-v-48a175a3"]]),oe={name:"sequence-stats",components:{ButtonSimple:D,Combobox:B,SearchField:x,SearchQueryList:F,SequenceStatsList:ie},data(){return{countMode:"count",displayMode:"pie",initialLoading:!0,countModeOptions:[{label:"shots",value:"count"},{label:"frames",value:"frames"}],displayModeOptions:[{label:"pie",value:"pie"},{label:"count",value:"count"}],loading:{savingSearch:!1}}},computed:{...k(["currentEpisode","currentProduction","displayedSequences","isCurrentUserManager","isShotsLoading","isShotsLoadingError","isTVShow","searchSequenceFilters","sequences","sequenceMap","sequencesPath","sequenceStats","sequenceSearchText","sequenceSearchQueries","sequenceListScrollPosition","shotValidationColumns","taskTypeMap","taskStatusMap"])},mounted(){this.loadShots(()=>{this.initSequences().then(()=>{this.initialLoading=!1}).catch(e=>console.error(e)),this.setDefaultSearchText(),this.setDefaultListScrollPosition()})},methods:{...O(["computeSequenceStats","hideAssignations","initSequences","loadShots","removeSequenceSearch","saveSequenceSearch","setLastProductionScreen","setSequenceStatsSearch","setSequenceListScrollPosition","showAssignations"]),reloadData(){this.initialLoading=!0,this.loadShots(()=>{this.initialLoading=!1,this.computeSequenceStats()})},setDefaultSearchText(){this.sequenceSearchText.length>0&&this.$refs["sequence-search-field"].setValue(this.sequenceSearchText)},setDefaultListScrollPosition(){this.$refs["sequence-list"]&&this.$refs["sequence-list"].setScrollPosition(this.sequenceListScrollPosition)},navigateToList(){this.$router.push(this.sequencesPath)},onSearchChange(){const e=this.$refs["sequence-search-field"].getValue();this.setSequenceStatsSearch(e)},changeSearch(e){this.$refs["sequence-search-field"].setValue(e.search_query),this.$refs["sequence-search-field"].$emit("change",e.search_query)},saveSearchQuery(e){this.loading.savingSearch||(this.loading.savingSearch=!0,this.saveSequenceSearch(e).catch(console.error).finally(()=>{this.loading.savingSearch=!1}))},removeSearchQuery(e){this.removeSequenceSearch(e).catch(console.error)},saveScrollPosition(e){this.setSequenceListScrollPosition(e)},exportStatisticsToCsv(){const e=[A().format("YYYYMMDD"),this.currentProduction.name,"sequences","statistics"];this.currentEpisode&&e.splice(2,0,this.currentEpisode.name);const t=Q.slugify(e.join("_"));U.generateStatReports(t,this.sequenceStats,this.taskTypeMap,this.taskStatusMap,this.sequenceMap,this.countMode,this.currentProduction)},onFieldChanged({entry:e,fieldName:t,value:s}){const p={id:e.id};p[t]=s,this.editSequence(p)}},watch:{currentProduction(){this.$refs["sequence-search-field"].setValue(""),this.$store.commit("SET_SEQUENCE_LIST_SCROLL_POSITION",0),this.isTVShow||this.loadShots(()=>{this.initSequences().then(this.handleModalsDisplay).catch(e=>console.error(e))})},currentEpisode(){this.isTVShow&&this.currentEpisode&&this.loadShots(()=>{this.initSequences().then(this.handleModalsDisplay).then(()=>{this.initialLoading=!1}).catch(e=>console.error(e))})},searchSequenceFilters:{deep:!0,handler(){this.computeSequenceStats()}}},head(){return this.isTVShow?{title:`${this.currentProduction?this.currentProduction.name:""} - ${this.currentEpisode?this.currentEpisode.name:""} | ${this.$t("sequences.title")} - Kitsu`}:{title:`${this.currentProduction?this.currentProduction.name:""} | ${this.$t("sequences.title")} - Kitsu`}}},ne={class:"sequences page fixed-page"},le={class:"sequence-list-header page-header flexrow"},re={class:"query-list mt1"};function ce(e,t,s,p,r,a){const v=h("search-field"),S=h("combobox"),y=h("button-simple"),i=h("search-query-list"),c=h("sequence-stats-list");return o(),l("div",ne,[n("div",le,[u(v,{class:"flexrow-item mt1",ref:"sequence-search-field","can-save":!0,onChange:a.onSearchChange,onSave:a.saveSearchQuery,placeholder:"ex: e01 s01 anim=wip"},null,8,["onChange","onSave"]),u(S,{class:"mb0 flexrow-item",label:e.$t("statistics.display_mode"),"locale-key-prefix":"statistics.",options:r.displayModeOptions,modelValue:r.displayMode,"onUpdate:modelValue":t[0]||(t[0]=C=>r.displayMode=C)},null,8,["label","options","modelValue"]),u(S,{class:"mb0 flexrow-item",label:e.$t("statistics.count_mode"),"locale-key-prefix":"statistics.",options:r.countModeOptions,modelValue:r.countMode,"onUpdate:modelValue":t[1]||(t[1]=C=>r.countMode=C)},null,8,["label","options","modelValue"]),t[2]||(t[2]=n("span",{class:"filler"},null,-1)),u(y,{class:"flexrow-item",icon:"refresh",title:e.$t("main.reload"),onClick:a.reloadData},null,8,["title","onClick"]),u(y,{class:"flexrow-item",icon:"download",title:e.$t("main.csv.export_file"),onClick:a.exportStatisticsToCsv},null,8,["title","onClick"])]),n("div",re,[u(i,{queries:e.sequenceSearchQueries,type:"sequenceStat",onChangeSearch:a.changeSearch,onRemoveSearch:a.removeSearchQuery},null,8,["queries","onChangeSearch","onRemoveSearch"])]),u(c,{ref:"sequence-list","count-mode":r.countMode,"display-mode":r.displayMode,entries:e.displayedSequences,"is-loading":e.isShotsLoading||r.initialLoading,"is-error":e.isShotsLoadingError,"validation-columns":e.shotValidationColumns,"sequence-stats":e.sequenceStats,"show-all":e.sequenceSearchText.length===0,onFieldChanged:a.onFieldChanged,onScroll:a.saveScrollPosition},null,8,["count-mode","display-mode","entries","is-loading","is-error","validation-columns","sequence-stats","show-all","onFieldChanged","onScroll"])])}const he=L(oe,[["render",ce],["__scopeId","data-v-6c91e36f"]]);export{he as default};
//# sourceMappingURL=SequenceStats-Caw8t5Xm.js.map
