import{q as $,s as B,E as N,u as j,v as A,x as U,T as G,y as x,V as Y,m as E,b as V,z as I,_ as L,r,o as d,c as p,e as a,t as i,F as M,g as w,p as P,f as c,l as v,d as C,A as q,a as O,G as K,H as z,P as F,I as W,J as H,K as Q,w as S}from"./index-a83mlrHR.js";import{P as J}from"./PageLayout-B0r1kUra.js";const R={name:"all-task-list",mixins:[$,B],components:{EntityThumbnail:N,PeopleAvatarWithMenu:j,ProductionNameCell:A,Spinner:U,TableInfo:G,TaskTypeCell:x,ValidationCell:Y},emits:["more-clicked","task-selected"],data(){return{lastSelection:null,page:1,selectionGrid:{}}},props:{isError:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},isMore:{type:Boolean,default:!1},isMoreLoading:{type:Boolean,default:!1},stats:{type:Object,default:()=>{}},tasks:{type:Array,default:()=>[]}},mounted(){window.addEventListener("keydown",this.onKeyDown,!1)},beforeUnmount(){window.removeEventListener("keydown",this.onKeyDown)},computed:{...E(["assetMap","editMap","episodeMap","nbSelectedTasks","personMap","user","selectedTasks","sequenceMap","shotMap","taskMap","isCurrentUserManager","isCurrentUserSupervisor","taskTypeMap"]),isTimeSpentPlural(){return Math.floor((this.stats.total_duration?this.stats.total_duration:0)/60/8)>=1},isTimeEstimatedPlural(){return Math.floor((this.stats.total_estimation?this.stats.total_estimation:0)/60/8)>=1},nbFrames(){let t=0;return this.tasks.forEach(s=>{t+=s.entity_nb_frames}),t}},methods:{...V(["addSelectedTask","addSelectedTasks","clearSelectedTasks","updateTask","unassignPersonFromTask","removeSelectedTask"]),getParentName(t){return t.sequence_name?t.episode_name?`${t.episode_name} - ${t.sequence_name}`:t.sequence_name:t.entity_type_name},getTaskName(t){return t.entity_name},getDate(t){return t?I(t,"YYYY-MM-DD").toDate():null},formatDate(t){return t?I(t).format("YYYY-MM-DD"):""},isEstimationBurned(t){return t.estimation&&t.estimation>0&&t.duration>t.estimation},onKeyDown(t){if(this.tasks.length>0&&t.altKey){let s=this.lastSelection?this.lastSelection:0;[37,38].includes(t.keyCode)?(s=s-1<0?s=this.tasks.length-1:s-1,this.selectTask({},s,this.tasks[s]),this.pauseEvent(t)):[39,40].includes(t.keyCode)&&(s=s+1>=this.tasks.length?s=0:s+1,this.selectTask({},s,this.tasks[s]),this.pauseEvent(t))}},selectTask(t,s,e){if(t&&t.target&&(["INPUT"].includes(t.target.nodeName)||t.target.parentNode&&["HEADER"].includes(t.target.parentNode.nodeName)||["cell day selected"].includes(t.target.className)))return;const h=this.selectionGrid[e.id],l=Object.keys(this.selectionGrid).length>1;this.clearSelectedTasks({task:e}),this.resetSelection(),this.selectionGrid[e.id]?(this.removeSelectedTask({task:e}),this.selectionGrid[e.id]=void 0):(!h||l)&&(this.addSelectedTask({task:e}),this.$emit("task-selected",e),this.selectionGrid[e.id]=!0,this.lastSelection=s)},setScrollPosition(t){this.$refs.body&&(this.$refs.body.scrollTop=t)},resetSelection(){this.selectionGrid={},this.lastSelection=null}},watch:{tasks(){this.page=1,this.resetSelection()},nbSelectedTasks(){this.nbSelectedTasks===0&&this.resetSelection()}}},X={class:"data-list"},Z={ref:"body",class:"datatable-wrapper"},tt={class:"datatable"},st={ref:"thead",class:"datatable-head"},et={class:"row-header"},at={class:"thumbnail",ref:"th-thumbnail"},it=["title"],ot={class:"empty",ref:""},lt={class:"datatable-body"},nt=["onClick"],rt={class:"project"},dt={class:"thumbnail"},ct={class:"asset-type"},ut={class:"name"},mt={class:"assignees"},pt={class:"flexrow"},ht={class:"estimation number-cell"},_t={class:"start-date"},ft={class:"due-date"},kt={class:"done-date"},yt={key:0,class:"has-text-centered"},gt={key:0,class:"has-text-centered nb-tasks"};function bt(t,s,e,h,l,n){const u=r("production-name-cell"),_=r("entity-thumbnail"),f=r("task-type-cell"),k=r("validation-cell"),y=r("people-avatar-with-menu"),g=r("spinner"),b=r("table-info");return d(),p("div",X,[a("div",Z,[a("table",tt,[a("thead",st,[a("tr",et,[a("th",{class:"project",ref:"th-name"},i(t.$t("tasks.fields.production")),513),a("th",at,null,512),a("th",{class:"asset-type",ref:"th-type"},i(t.$t("tasks.fields.parent")),513),a("th",{class:"name",ref:"th-name"},i(t.$t("tasks.fields.entity")),513),a("th",{class:"name",ref:"th-name"},i(t.$t("tasks.fields.task_type")),513),a("th",{class:"status",ref:"th-status"},i(t.$t("tasks.fields.task_status")),513),a("th",{class:"assignees",ref:"th-assignees"},i(t.$t("tasks.fields.assignees")),513),a("th",{ref:"th-estimation",class:"estimation number-cell",title:t.$t("main.estimation")},i(t.$t("tasks.fields.estimation").substring(0,3))+". ",9,it),a("th",{class:"duration number-cell",ref:"th-duration"},i(t.$t("tasks.fields.duration").substring(0,3))+". ",513),a("th",{class:"start-date",ref:"th-date"},i(t.$t("tasks.fields.start_date")),513),a("th",{class:"due-date",ref:"th-date"},i(t.$t("tasks.fields.due_date")),513),a("th",{class:"done-date",ref:"th-date"},i(t.$t("tasks.fields.done_date")),513),a("th",ot,"Â ",512)])],512),a("tbody",lt,[(d(!0),p(M,null,w(e.tasks,(o,T)=>(d(),p("tr",{ref_for:!0,ref:"task-"+o.id,key:o.id,class:P({"task-line":!0,"datatable-row":!0,selected:l.selectionGrid[o.id]}),onClick:m=>n.selectTask(m,T,o)},[a("td",rt,[c(u,{class:"project",entry:{id:o.project_id,name:o.project_name},"only-avatar":!0,"is-link":!1},null,8,["entry"])]),a("td",dt,[c(_,{class:"flexrow-item","preview-file-id":o.last_preview_file_id,width:50,height:33,"empty-width":50,"empty-height":33},null,8,["preview-file-id"])]),a("td",ct,i(n.getParentName(o)),1),a("td",ut,i(o.entity_name),1),c(f,{class:"name","task-type":t.taskTypeMap.get(o.task_type_id)},null,8,["task-type"]),c(k,{class:"status unselectable","task-test":o,"is-border":!1,"is-assignees":!1,selectable:!1,"is-static":!0},null,8,["task-test"]),a("td",mt,[a("div",pt,[(d(!0),p(M,null,w(o.assignees,m=>(d(),v(y,{class:"flexrow-item",key:o.id+"-"+m,person:t.personMap.get(m),size:30,"font-size":16,onUnassign:D=>t.onUnassign(o,D)},null,8,["person","onUnassign"]))),128))])]),a("td",ht,i(t.formatDuration(o.estimation)),1),a("td",{class:P({duration:!0,"number-cell":!0,error:n.isEstimationBurned(o)})},i(t.formatDuration(o.duration)),3),a("td",_t,i(n.formatDate(o.start_date)),1),a("td",ft,i(n.formatDate(o.due_date)),1),a("td",kt,i(n.formatDate(o.done_date)),1),s[1]||(s[1]=a("td",{class:"empty"},null,-1))],10,nt))),128))])]),e.isMore?(d(),p("div",yt,[e.isMoreLoading?(d(),v(g,{key:0,class:"mt2"})):(d(),p("button",{key:1,class:"button mt2",onClick:s[0]||(s[0]=o=>t.$emit("more-clicked"))},i(t.$t("main.load_more")),1))])):C("",!0),c(b,{"is-loading":e.isLoading,"is-error":e.isError},null,8,["is-loading","is-error"])],512),e.isLoading?C("",!0):(d(),p("p",gt,i(e.stats.total)+" "+i(t.$tc("tasks.number",e.stats.total))+" ("+i(t.formatDuration(e.stats.total_estimation))+" "+i(t.$tc("main.days_estimated",n.isTimeEstimatedPlural))+", "+i(t.formatDuration(e.stats.total_duration))+" "+i(t.$tc("main.days_spent",n.isTimeSpentPlural))+") ",1))])}const Tt=L(R,[["render",bt],["__scopeId","data-v-e0c0cbb0"]]),St={name:"status-stats",props:{stats:Array},computed:{statMax(){return this.stats?this.stats.reduce((t,s)=>Math.max(s.value,t),0):0}}},Mt={class:"status-stats"},wt=["title"],vt={class:"stat-text"};function Lt(t,s,e,h,l,n){return d(),p("div",Mt,[(d(!0),p(M,null,w(e.stats,u=>(d(),p("div",{key:"stat-"+u.name,class:"stat-wrapper"},[(d(),p("div",{key:"stat-value-"+u.name.toLowerCase(),class:"stat-line",title:u.name+": "+u.value,style:q({background:u.color,width:u.value/n.statMax*100+"%"})},[a("span",vt,i(u.name)+" : "+i(u.value),1)],12,wt))]))),128))])}const It=L(St,[["render",Lt],["__scopeId","data-v-c23a229f"]]),Pt={name:"all-tasks",components:{AllTaskList:Tt,ComboboxProduction:O,ComboboxTaskType:K,ComboboxStatus:z,PageLayout:J,PageTitle:F,PeopleField:W,StatusStats:It,TaskInfo:H},data(){return{filters:{productionId:null,taskStatusId:null,taskTypeId:null,person:null},isMore:!1,isMoreLoading:!1,isLoading:!1,isLoadingError:!1,tasks:[],stats:{status:[]}}},mounted(){const t=this.$route.query;t.project_id&&(this.filters.productionId=t.project_id),t.task_status_id&&(this.filters.taskStatusId=t.task_status_id),t.task_type_id&&(this.filters.taskTypeId=t.task_type_id),t.person_id&&(this.filters.person=this.activePeopleWithoutBot.find(s=>s.id===t.person_id)),this.reload()},computed:{...E(["activePeopleWithoutBot","getProductionTaskStatuses","getProductionTaskTypes","nbSelectedTasks","openProductions","personMap","productionMap","selectedTasks","taskStatus","taskStatusMap","taskTypes"]),taskStatusList(){const t=this.filters.productionId,s=this.getProductionTaskStatuses(t).filter(e=>!e.for_concept);return this.addAllValue(s)},taskTypeList(){const t=this.filters.productionId,s=this.getProductionTaskTypes(t).filter(e=>e.for_entity!=="Concept");return this.addAllValue(s)},personList(){const t=this.filters.productionId,s=this.productionMap.get(t);return s?Q(s.team.map(e=>this.personMap.get(e)).filter(e=>e&&!e.is_bot)):this.activePeopleWithoutBot},productionList(){return this.addAllValue(this.openProductions)},params(){return{project_id:this.filters.productionId,task_status_id:this.filters.taskStatusId,task_type_id:this.filters.taskTypeId,person_id:this.filters.person?this.filters.person.id:null}},statusStats(){return[...this.stats.status].sort((t,s)=>s.amount-t.amount).map(t=>{const s=this.taskStatusMap.get(t.task_status_id);return{name:s.short_name.toUpperCase(),color:s.color,value:t.amount}})}},methods:{...V(["clearSelectedTasks","loadOpenTasks","loadTask"]),addAllValue(t){return[{id:"",color:"#999",name:this.$t("main.all"),short_name:this.$t("main.all")}].concat([...t])},async reload(){this.isLoading=!0,this.page=1,this.clearSelectedTasks(),this.tasks=[];try{const t={};Object.keys(this.params).forEach(e=>{this.params[e]&&(t[e]=this.params[e])}),this.$router.push({query:t});const s=await this.loadOpenTasks(this.params);this.tasks=s.data,this.stats=s.stats,this.isMore=s.is_more}catch(t){this.isLoadingError=!0,console.error(t)}this.isLoading=!1},loadMore(){this.isMoreLoading=!0,this.page=(this.page||1)+1;const t={...this.params,page:this.page};this.loadOpenTasks(t).then(s=>{this.tasks=this.tasks.concat(s.data),this.isMore=s.is_more,this.isMoreLoading=!1}).catch(s=>{this.isMoreLoading=!1,this.isMoreLoadingError=!0,console.error(s)})},taskClicked(t){this.$router.push({name:"Task",params:{id:t.id}})}},watch:{filters:{handler(){this.reload()},deep:!0}},socket:{events:{"task:update"(t){const s=this.tasks.find(e=>e.id===t.task_id);s&&this.loadTask({taskId:s.id}).then(e=>{Object.assign(s,e)})}}},head(){return{title:`${this.$t("tasks.all_tasks")} - Kitsu`}}},Ct={class:"all-tasks"},Et={class:"filters flexrow"},Vt={class:"flexrow-item selector"},Dt={class:"label person-label"};function $t(t,s,e,h,l,n){const u=r("page-title"),_=r("combobox-production"),f=r("combobox-status"),k=r("combobox-task-type"),y=r("people-field"),g=r("all-task-list"),b=r("status-stats"),o=r("task-info"),T=r("page-layout");return d(),v(T,null,{main:S(()=>[a("div",Ct,[c(u,{class:"flexrow-item title mt1",text:t.$t("tasks.all_tasks")},null,8,["text"]),a("div",Et,[c(_,{class:"flexrow-item",label:t.$t("main.production"),"production-list":n.productionList,modelValue:l.filters.productionId,"onUpdate:modelValue":s[0]||(s[0]=m=>l.filters.productionId=m)},null,8,["label","production-list","modelValue"]),c(f,{class:"flexrow-item selector",label:t.$t("news.task_status"),"task-status-list":n.taskStatusList,modelValue:l.filters.taskStatusId,"onUpdate:modelValue":s[1]||(s[1]=m=>l.filters.taskStatusId=m)},null,8,["label","task-status-list","modelValue"]),c(k,{class:"flexrow-item selector",label:t.$t("news.task_type"),"task-type-list":n.taskTypeList,modelValue:l.filters.taskTypeId,"onUpdate:modelValue":s[2]||(s[2]=m=>l.filters.taskTypeId=m)},null,8,["label","task-type-list","modelValue"]),a("div",Vt,[a("label",Dt,i(t.$t("main.person")),1),c(y,{class:"person-field",people:n.personList,modelValue:l.filters.person,"onUpdate:modelValue":s[3]||(s[3]=m=>l.filters.person=m)},null,8,["people","modelValue"])])]),c(g,{tasks:l.tasks,stats:l.stats,"is-loading":l.isLoading,"is-error":l.isLoadingError,"is-more":l.isMore,"is-more-loading":l.isMoreLoading,onTaskClicked:n.taskClicked,onMoreClicked:n.loadMore},null,8,["tasks","stats","is-loading","is-error","is-more","is-more-loading","onTaskClicked","onMoreClicked"])])]),side:S(()=>[c(o,{task:t.selectedTasks.values().next().value},{default:S(()=>[c(b,{stats:n.statusStats},null,8,["stats"])]),_:1},8,["task"])]),_:1})}const jt=L(Pt,[["render",$t],["__scopeId","data-v-bacc5a9e"]]);export{jt as default};
//# sourceMappingURL=AllTasks-lzTBGgTn.js.map
