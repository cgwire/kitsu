import{p as m}from"./index-Bnig1aiX.js";import{_ as l,S as p,b as f,r as v,o as a,c as h,d,f as c,h as g,k as w,v as y,i as u}from"./index-DF-DoQlt.js";import{f as T}from"./video-Yn96Kb74.js";import{d as $}from"./dom-tO7tlkHV.js";const C={name:"video-viewer",mixins:[$],components:{Spinner:p},props:{name:{type:String,default:""},big:{type:Boolean,default:!1},isComparing:{type:Boolean,default:!1},isComparisonOverlay:{type:Boolean,default:!1},isHd:{type:Boolean,default:!1},isDrawing:{type:Boolean,default:!1},isTyping:{type:Boolean,default:!1},isMuted:{type:Boolean,default:!1},isRepeating:{type:Boolean,default:!1},light:{type:Boolean,default:!1},currentFrame:{type:Number,default:0},nbFrames:{type:Number,default:0},preview:{type:Object,default:()=>{}},defaultHeight:{type:Number,default:0},fullScreen:{type:Boolean,default:!1},isRoundedTopBorder:{type:Boolean,default:!1},panzoom:{type:Boolean,default:!1}},emits:["click","duration-changed","frame-update","play-ended","size-changed","video-end","video-loaded"],data(){return{annotations:[],currentTimeRaw:0,isLoading:!1,maxDuration:"00:00.000",videoDuration:0}},mounted(){this.$options.currentTimeCalls=[],this.container.style.height=this.defaultHeight+"px",this.isLoading=!0,this.isMuted&&(this.video.muted=this.isMuted),setTimeout(()=>{this.video&&(this.video.readyState===4&&(this.configureVideo(),this.onWindowResize(),this.isLoading=!1,this.setCurrentTime(0),this.setCurrentTimeRaw(0),this.$nextTick(()=>{this.video.currentTime=0}),this.$emit("video-loaded")),this.video.addEventListener("focus",function(){this.blur()},!1),this.video.addEventListener("resize",this.resetSize),this.video.addEventListener("loadedmetadata",()=>{this.video&&(this.configureVideo(),this.onWindowResize(),this.setCurrentTime(0),this.setCurrentTimeRaw(0),this.$emit("video-loaded"))}),this.video.addEventListener("canplay",()=>{this.isLoading=!1}),this.video.addEventListener("ended",()=>{this.isLoading=!1}),this.video.addEventListener("error",e=>{console.error("An error occurred while loading a video",e),this.$refs.movie&&(this.$refs.movie.style.height=this.defaultHeight+"px"),this.isLoading=!1}),this.video.addEventListener("loadstart",()=>{this.isLoading=!0}),this.video.addEventListener("stalled",()=>{this.isLoading=!0}),this.video.addEventListener("waiting",()=>{this.name.indexOf("comparison")<0&&(this.isLoading=!0)}),window.addEventListener("resize",this.onWindowResize))},0),this.panzoom&&(this.panzoomInstance=m(this.container,{bounds:!0,boundsPadding:.2,maxZoom:5,minZoom:1}),this.pausePanZoom())},beforeUnmount(){this.pause(),window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("resize",this.onWindowResize),this.panzoomInstance?.dispose()},computed:{...f(["currentProduction"]),container(){return this.$refs.container},extension(){return this.preview?this.preview.extension:""},fps(){return parseFloat(this.currentProduction?.fps)||25},frameDuration(){return Math.round(1/this.fps*1e4)/1e4},isAvailable(){return!["broken","processing"].includes(this.status)},isMovie(){return this.extension==="mp4"},isVideo(){return this.$refs.movie&&this.videoDuration&&this.videoDuration>0},status(){return this.preview&&this.preview.status?this.preview.status:"ready"},video(){return this.$refs.movie},moviePath(){return this.extension==="mp4"&&this.isAvailable&&!this.isHd?`/api/movies/low/preview-files/${this.preview.id}.mp4`:this.extension==="mp4"&&this.isAvailable?`/api/movies/originals/preview-files/${this.preview.id}.mp4`:null},movieDlPath(){return this.preview&&this.isAvailable?`/api/movies/originals/preview-files/${this.preview.id}/download`:""},posterPath(){return this.extension==="mp4"&&this.isAvailable?`/api/pictures/previews/preview-files/${this.preview.id}.png`:null}},methods:{formatFrame:T,getNaturalDimensions(){return{height:this.video?this.video.videoHeight:0,width:this.video?this.video.videoWidth:0}},getDimensions(){const e=this.getNaturalDimensions(),i=e.height/e.width||1,o=this.container?this.container.offsetWidth:0,n=this.container?this.container.offsetHeight:0;let s=o,t=Math.floor(s*i);return t>n&&(t=n,s=t/i),{width:s,height:t}},getLastPushedCurrentTime(){const e=this.$options.currentTimeCalls.length;return e>0?this.$options.currentTimeCalls[e-1]:this.currentTimeRaw},setCurrentFrame(e){this.setCurrentTime(e*this.frameDuration)},setCurrentTimeRaw(e){e<this.frameDuration&&(e=0),this.video.currentTime=e},setCurrentTime(e){this.$options.currentTimeCalls||(this.$options.currentTimeCalls=[]),this.$options.currentTimeCalls.push(e),this.runSetCurrentTime()},runSetCurrentTime(){if(this.$options.currentTimeCalls.length===0)this.$options.running=!1;else{this.$options.running=!0;const e=this.$options.currentTimeCalls.shift();this.video.currentTime!==e&&(this.video.currentTime=Number(e.toPrecision(4))+.001),setTimeout(()=>{this.runSetCurrentTime()},10)}},configureVideo(){this.video.onended=this.onVideoEnd,this.video.currentTime===0&&this.mountVideo()},mountVideo(){this.isMovie&&(this.video.mute=this.isMuted,this.videoDuration=this.video.duration,this.isLoading=!1,this.$emit("duration-changed",this.videoDuration),this.resetSize(),setTimeout(()=>{this.resetSize()},500))},resetSize(){const{height:e}=this.getDimensions();if(e>0){this.container.style.height=this.defaultHeight+"px",this.video.style.height=e+"px";const i=this.video.getBoundingClientRect(),o=this.container.getBoundingClientRect(),n=i.top-o.top,s=i.left-o.left,t=i.width,r=i.height;(!this.previousDimensions||this.previousDimensions.width!==t||this.previousDimensions.height!==r||this.previousDimensions.left!==s||this.previousDimensions.top!==n)&&this.$emit("size-changed",{width:t,height:r,top:n,left:s}),this.previousDimensions={width:t,height:r,top:n,left:s}}else this.$emit("size-changed",{width:0,height:0,top:0,left:0})},getFrameFromPlayer(){const e=this.video?this.video.currentTime:0;if(e===0)return 0;let i=Math.ceil(e/this.frameDuration)+1;return i=Number(i.toPrecision(4)),i=Math.min(i,this.nbFrames),i},play(){!this.isPlaying&&this.videoDuration===this.video.currentTime&&this.name.indexOf("comparison")<0&&this.setCurrentTime(0),this.video.play(),this.name.indexOf("comparison")<0&&this.runEmitTimeUpdateLoop()},runEmitTimeUpdateLoop(){clearInterval(this.$options.playLoop),this.$options.playLoop=setInterval(this.emitFrameChange,this.frameDuration)},emitFrameChange(){const e=this.getFrameFromPlayer();this.$emit("frame-update",e)},pause(){this.video.pause(),clearInterval(this.$options.playLoop),this.video.currentTime=this.currentFrame*this.frameDuration,this.$emit("frame-update",this.currentFrame)},toggleMute(){this.video.muted=!this.video.muted},goPreviousFrame(){const e=this.currentFrame-1;if(!(e<0))return this.video.currentTime=e*this.frameDuration+.001,this.$emit("frame-update",e),e},goNextFrame(){const e=this.currentFrame+1;if(!(e>=this.nbFrames))return this.video.currentTime=e*this.frameDuration+.001,this.$emit("frame-update",e),e},onVideoEnd(){this.isPlaying=!1,clearInterval(this.$options.playLoop),this.isRepeating?(this.$emit("video-end"),this.video.currentTime=0,this.play()):this.$emit("play-ended")},onWindowResize(){this.mountVideo()},resetPanZoom(){this.panzoomInstance&&(this.panzoomInstance.moveTo(0,0),this.panzoomInstance.zoomAbs(0,0,1))},pausePanZoom(){this.panzoomInstance&&this.panzoomInstance.pause()},resumePanZoom(){this.panzoomInstance&&this.panzoomInstance.resume()},setSpeed(e){this.video&&(this.video.playbackRate=e)},setVolume(e){this.video&&(this.video.volume=e/100)}},watch:{preview(){this.resetPanZoom(),this.maxDuration="00:00.000",this.pause(),this.$nextTick(()=>{this.resetPanZoom(),setTimeout(()=>{this.resetPanZoom()},100)})},light(){this.resetPanZoom(),this.mountVideo()},isComparing(){this.resetPanZoom(),this.mountVideo()},isComparingOverlay(){this.resetPanZoom(),this.mountVideo()},isMuted(){this.video.muted=this.isMuted},fullScreen(){this.resetPanZoom()}}},L={key:0,class:"loading-background"},D=["src","poster"];function b(e,i,o,n,s,t){const r=v("spinner");return a(),h("div",{ref:"container",class:"video-player",style:u({"border-top-left-radius":o.isRoundedTopBorder?"10px":"","border-top-right-radius":o.isRoundedTopBorder?"10px":""}),onClick:i[0]||(i[0]=x=>e.$emit("click"))},[d("div",{class:"video-wrapper",style:u({"border-top-left-radius":o.isRoundedTopBorder?"10px":"","border-top-right-radius":o.isRoundedTopBorder?"10px":""})},[s.isLoading?(a(),h("div",L,[c(r,{class:"spinner"})])):g("",!0),w(d("video",{ref:"movie",class:"annotation-movie",src:t.moviePath,poster:t.posterPath,preload:"auto",type:"video/mp4"},null,8,D),[[y,!s.isLoading]])],4)],4)}const R=l(C,[["render",b],["__scopeId","data-v-a0278b59"]]);export{R as V};
//# sourceMappingURL=VideoViewer-B89y-Tko.js.map
