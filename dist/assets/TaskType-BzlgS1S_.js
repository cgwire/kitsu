import{_ as G,U as me,R as fe,E as ae,aG as A,y as N,a as X,u as R,aY as z,aX as J,D as Z,a1 as ee,l as te,b as K,r as T,o as r,c as o,d as l,t as d,h,F as M,e as P,n as V,f as _,g as C,H as F,m as q,bH as j,X as se,Y as $,bG as pe,bA as ne,a8 as ye,B as ke,w as O,J as v,as as k,aF as U,aa as _e,c2 as ge,aK as ie,c3 as Te,c4 as Se,c5 as be,c6 as De,c7 as ve,s as we,A as Ee,aw as Me,p as Ce}from"./index-C2m_IhNF.js";import{c as H}from"./csv-cx9HGs3n.js";import{s as Ie}from"./string-B0Tq569e.js";import{f as Y}from"./format-CUjWrpVJ.js";import{s as Pe}from"./search-CWIHq9c3.js";import{C as Fe}from"./ComboboxNumber-CjSlWfmA.js";import{C as Ae}from"./ComboboxOptions-XCxMu4bW.js";import{C as Ve}from"./ComboboxStatus-DYpCiml-.js";import{C as Be}from"./ComboboxStyled-fscUNRmK.js";import{C as qe}from"./ComboboxTaskType-CiBcPUsC.js";import{D as re}from"./DateField-OvNA3wsX.js";import{d as le}from"./dom-tO7tlkHV.js";import{d as W}from"./video-Yn96Kb74.js";import{C as xe}from"./corner-down-right-CXJTGBY_.js";import{I as Oe,a as Ue}from"./ImportRenderModal-DmK76ufV.js";import{S as Le}from"./Schedule-BBoWBvCl.js";import{S as Re}from"./SearchField-DO27Jrsj.js";import{S as Ne}from"./SearchQueryList-BrkMtSsZ.js";import Ge from"./TaskInfo-C8qSIbPH.js";import{C as ze}from"./Combobox-DQpIQydI.js";import{E as Ke}from"./EntityPreview-DQBzHKkN.js";import{P as Ye}from"./PeopleAvatarWithMenu-D34IaHhi.js";import{T as Qe}from"./TableInfo-B2X54z7i.js";import{V as He}from"./ValidationCell-D9FwmVzb.js";import{V as We}from"./ValidationTag-C6BUHddW.js";import{T as je}from"./TaskTypeName-bEgQZfX7.js";import{C as $e}from"./corner-left-up-D3eQ9gWL.js";import"./PreviewPlayer-CsSraBfQ.js";import"./PlaylistPlayer-DoTL8QsR.js";import"./ComboboxSimple-DU0Ahozo.js";import"./ModalFooter-BJ98b-60.js";import"./TextField-p_HJuEKt.js";import"./clipboard-CQqgyZ_h.js";import"./DeleteModal-CaB_X4-T.js";import"./index-KDZ8UbBO.js";import"./BaseModal-BCd5z4wK.js";import"./ComboboxDepartment-whRm-Bo0.js";import"./DepartmentName-C_7ZW05X.js";import"./ComboboxStudio-q2R7SCuH.js";import"./play-B4GV49GM.js";import"./render-Bqw3AFAH.js";import"./EmojiButton-B9I5hDFH.js";import"./FileUpload-C4E3YXqL.js";import"./ConfirmModal-CYuRpfjg.js";import"./triangle-alert-DAfmXCpT.js";import"./thumbs-up-DoHhBcNt.js";import"./copy-BH2iDnK6.js";import"./vue.esm-bundler-Cb2j4MJL.js";import"./VideoViewer-Da8LCLxo.js";import"./Checkbox-ByQFc4Am.js";import"./list-chevrons-up-down-ByJjEZOU.js";import"./briefcase-DXQKuIYE.js";import"./BooleanField-BK_C2MOf.js";import"./check-_fRnDsm9.js";import"./ColorField--VnpcHkf.js";import"./trash-2-DSHW2jWN.js";import"./chevron-up-kHAV03RH.js";import"./BuildFilterModal-C3nrV5vY.js";import"./ComboboxBoolean-DJwCfClJ.js";import"./PeopleField-CJ8IkJD1.js";import"./DeleteEntities-ZGV8gTRL.js";import"./HardDeleteModal-CyBgP8oG.js";import"./corner-right-up-xElzR7oO.js";import"./eye-CKzk1Q6q.js";import"./user-minus-CqOv0SEt.js";import"./user-DnbVK0KB.js";const Xe={name:"estimation-helper",mixins:[le,Y],components:{CornerDownRightIcon:xe,EntityThumbnail:ae,PeopleAvatar:fe,PeopleName:me},props:{entityType:{type:String,default:"Asset"},tasks:{type:Array,default:()=>[]}},emits:["estimation-changed"],data(){return{lastSelection:0,lastShiftSelection:0,selectionGrid:{}}},computed:{...K(["currentProduction","isCurrentUserManager","isCurrentUserSupervisor","organisation","personMap","taskStatusMap","taskTypeMap","user"]),isAssets(){return this.entityType==="Asset"},isShots(){return this.entityType==="Shot"},tasksByPerson(){return[...this.tasks].sort(this.compareFirstAssignees)},assetMap(){return te.cache.assetMap},editMap(){return ee.cache.editMap},episodeMap(){return Z.cache.episodeMap},sequenceMap(){return J.cache.sequenceMap},shotMap(){return z.cache.shotMap},entityMap(){return this[`${this.entityType.toLowerCase()}Map`]},assignees(){const e=new Set,t={countMap:new Map,frameMap:new Map,estimationMap:new Map,secondMap:new Map},i={countMap:new Map,frameMap:new Map,estimationMap:new Map,secondMap:new Map},n=[];return this.tasks.forEach(a=>{const s=this.getEntity(a.entity_id);a.assignees.forEach(f=>{e.add(f),this.addAssigneeStatsToMaps(t,f,a,s);const m=this.taskStatusMap.get(a.task_status_id);!m.is_done&&!m.is_feedback_request&&this.addAssigneeStatsToMaps(i,f,a,s)})}),e.forEach((a,s)=>n.push(this.personMap.get(s))),n.sort(R.firstBy("name")).map(a=>{const s=this.getAssigneeStats(a,t),f=this.getAssigneeStats(a,i);return{...a,alltasks:s,remaining:f}})}},methods:{...X(["updateTask"]),frameToSeconds:W,getEntity(e){return this.entityMap.get(e)},compareFirstAssignees(e,t){if(e.assignees.length>0&&t.assignees.length>0){const i=this.personMap.get(e.assignees[0]),n=this.personMap.get(t.assignees[0]);return i.name.localeCompare(n.name)}else return e.assignees.length>0?-1:t.assignees.length>0?1:-1},getSeconds(e){const t=this.getEntity(e.entity_id);return W(t.nb_frames,this.currentProduction,t)},estimationUpdated(e,t){const i=e.target.value;if(i&&i.length>0){const n=parseFloat(e.target.value);this.saveEstimations(n,t)}},saveEstimations(e,t){const i=Object.keys(this.selectionGrid);i.length>1?i.forEach(n=>{this.$emit("estimation-changed",{taskId:n,days:e})}):this.$emit("estimation-changed",{taskId:t.id,days:e})},onKeyDown(e){e.key==="Tab"?(this.pauseEvent(e),e.shiftKey?this.selectPrevious():this.selectNext()):e.key==="ArrowDown"?(this.pauseEvent(e),this.selectNext(e.shiftKey)):e.key==="ArrowUp"&&(this.pauseEvent(e),this.selectPrevious(e.shiftKey))},clearSelection(){this.selectionGrid={}},addToSelection(e){this.selectionGrid[e]=!0},selectTask(e,t,i){e.shiftKey?(e.ctrlKey||e.metaKey||this.clearSelection(),this.selectTaskRange(i)):(e.ctrlKey||e.metaKey||this.clearSelection(),this.selectSingleTask(i)),this.isInDepartment(t)&&this.focusInput(this.$refs[this.tasksByPerson[i].id+"-estimation"][0])},selectPrevious(e){let t=this.lastSelection;t=t-1<0?this.tasksByPerson.length-1:t-1,this.selectTask({shiftKey:e},this.tasksByPerson[t],t)},selectNext(e){let t=this.lastSelection;t=t+1>=this.tasksByPerson.length?0:t+1,this.selectTask({shiftKey:e},this.tasksByPerson[t],t)},selectSingleTask(e){const t=this.tasksByPerson[e];this.addToSelection(t.id),this.lastSelection=e,this.lastShiftSelection=e},selectTaskRange(e){this.lastSelection=e,(this.lastShiftSelection>e?N(e,this.lastShiftSelection):N(this.lastShiftSelection,e)).map(n=>this.tasksByPerson[n].id).forEach(n=>{this.addToSelection(n)})},isInDepartment(e){if(this.isCurrentUserManager)return!0;if(this.isCurrentUserSupervisor){if(this.user.departments.length===0)return!0;{const t=this.taskTypeMap.get(e.task_type_id);return t.department_id&&this.user.departments.includes(t.department_id)}}else return!1},getAssigneeStats(e,t){const i=t.estimationMap.get(e.id)||0,n=t.secondMap.get(e.id)||0,a=t.frameMap.get(e.id)||0,s=t.countMap.get(e.id)||0,f=A(this.organisation,i),m=i>0?n/f:0,I=i>0?s/f:0,y=i>0?a/f:0;return{count:t.countMap.get(e.id)||0,estimation:this.formatDuration(i),frames:a,quota:m.toFixed(2),quotaFrames:y.toFixed(2),quotaCount:I.toFixed(2),seconds:n.toFixed(2)}},addAssigneeStatsToMaps(e,t,i,n){if(e.countMap.set(t,(e.countMap.get(t)||0)+1),e.estimationMap.set(t,(e.estimationMap.get(t)||0)+i.estimation),!this.isAssets){const a=n.nb_frames||0,s=W(a,this.currentProduction,n);e.secondMap.set(t,(e.secondMap.get(t)||0)+s),e.frameMap.set(t,(e.frameMap.get(t)||0)+a)}}}},Je={class:"estimation-wrapper"},Ze={class:"estimation-helper columns"},et={ref:"body",class:"task-list column datatable-wrapper"},tt={class:"datatable"},st={class:"datatable-head"},it={class:"assignees"},at={key:0,class:"asset-type"},nt={key:1,class:"sequence"},rt={class:"name"},lt={key:2,class:"frames numeric-cell"},ot={key:3,class:"seconds numeric-cell"},dt={class:"estimation numeric-cell"},ut={class:"datatable-body"},ct={class:"assignees"},ht={key:0,class:"flexrow"},mt={class:"thumbnail"},ft={key:0,class:"asset-type"},pt={key:1,class:"sequence"},yt={class:"name"},kt={key:2,class:"frames numeric-cell"},_t={key:3,class:"frames numeric-cell"},gt=["onClick"],Tt=["onChange","value"],St={key:1},bt={class:"person-list column datatable-wrapper"},Dt={class:"datatable"},vt={ref:"thead",class:"datatable-head"},wt={class:"assignees"},Et={class:"count numeric-cell"},Mt={class:"frames numeric-cell"},Ct={class:"seconds numeric-cell"},It={class:"estimation numeric-cell"},Pt={class:"quota numeric-cell"},Ft={class:"quota numeric-cell"},At={class:"quota numeric-cell"},Vt={class:"datatable-body"},Bt={class:"datatable-row task-line"},qt={class:"person flexrow"},xt={class:"count numeric-cell"},Ot={class:"frames numeric-cell"},Ut={class:"seconds numeric-cell"},Lt={class:"estimation numeric-cell"},Rt={class:"quota numeric-cell"},Nt={class:"quota numeric-cell"},Gt={class:"quota numeric-cell"},zt={class:"datatable-row task-line"},Kt={class:"person flexrow"},Yt={class:"count numeric-cell"},Qt={class:"frames numeric-cell"},Ht={class:"seconds numeric-cell"},Wt={class:"estimation numeric-cell"},jt={class:"quota numeric-cell"},$t={class:"quota numeric-cell"},Xt={class:"quota numeric-cell"};function Jt(e,t,i,n,a,s){const f=T("people-avatar"),m=T("people-name"),I=T("entity-thumbnail"),y=T("corner-down-right-icon");return r(),o("div",Je,[l("div",Ze,[l("div",et,[l("table",tt,[l("thead",st,[l("tr",null,[l("th",it,d(e.$t("tasks.fields.assignees")),1),t[4]||(t[4]=l("th",{class:"thumbnail"},null,-1)),s.isAssets?(r(),o("th",at,d(e.$t("tasks.fields.asset_type")),1)):s.isShots?(r(),o("th",nt,d(e.$t("tasks.fields.sequence")),1)):h("",!0),l("th",rt,d(e.$t("tasks.fields.entity_name")),1),s.isShots?(r(),o("th",lt,d(e.$t("tasks.fields.frames")),1)):h("",!0),s.isShots?(r(),o("th",ot,d(e.$t("tasks.fields.seconds").substring(0,3))+". ",1)):h("",!0),l("th",dt,d(e.$t("tasks.fields.estimation").substring(0,3))+". ",1)])]),l("tbody",ut,[(r(!0),o(M,null,P(s.tasksByPerson,(c,E)=>(r(),o("tr",{ref_for:!0,ref:"task-"+c.id,key:c.id,class:V({"datatable-row":!0,selected:a.selectionGrid[c.id],"task-line":!0})},[l("td",ct,[c.assignees.length?(r(),o("span",ht,[(r(!0),o(M,null,P(c.assignees,p=>(r(),o("span",{class:"flexrow",key:`${c.id}-${p}`},[_(f,{class:"flexrow-item",person:e.personMap.get(p),size:30,"font-size":17},null,8,["person"]),c.assignees.length===1?(r(),C(m,{key:0,class:"flexrow-item",person:e.personMap.get(p)},null,8,["person"])):h("",!0)]))),128))])):h("",!0)]),l("td",mt,[_(I,{entity:s.getEntity(c.entity.id),width:50,height:33,"empty-width":50,"empty-height":31},null,8,["entity"])]),s.isAssets?(r(),o("td",ft,d(s.getEntity(c.entity.id).asset_type_name),1)):s.isShots?(r(),o("td",pt,d(s.getEntity(c.entity.id).sequence_name),1)):h("",!0),l("td",yt,d(s.getEntity(c.entity.id).name),1),s.isShots?(r(),o("td",kt,d(s.getEntity(c.entity.id).nb_frames),1)):h("",!0),s.isShots?(r(),o("td",_t,d(s.getSeconds(c)),1)):h("",!0),l("td",{onClick:p=>s.selectTask(p,c,E),class:"estimation numeric-cell"},[s.isInDepartment(c)?(r(),o("input",{key:0,ref_for:!0,ref:c.id+"-estimation",class:"input stylehidden",min:"0",step:"any",type:"number",onBlur:t[0]||(t[0]=(...p)=>e.onInputBlur&&e.onInputBlur(...p)),onChange:p=>s.estimationUpdated(p,c,E),onKeydown:t[1]||(t[1]=(...p)=>s.onKeyDown&&s.onKeyDown(...p)),onMouseout:t[2]||(t[2]=(...p)=>e.onInputMouseOut&&e.onInputMouseOut(...p)),onMouseover:t[3]||(t[3]=(...p)=>e.onInputMouseOver&&e.onInputMouseOver(...p)),value:e.formatDuration(c.estimation,!1)},null,40,Tt)):(r(),o("span",St,d(e.formatDuration(c.estimation)),1))],8,gt)],2))),128))])])],512),l("div",bt,[l("table",Dt,[l("thead",vt,[l("tr",null,[l("th",wt,d(e.$t("tasks.fields.assignees")),1),l("th",Et,d(e.$t("tasks.fields.count")),1),l("th",Mt,d(e.$t("tasks.fields.frames")),1),l("th",Ct,d(e.$t("tasks.fields.seconds").substring(0,3))+". ",1),l("th",It,d(e.$t("tasks.fields.estimation").substring(0,3))+". ",1),l("th",Pt,d(e.$t("tasks.fields.estimated_quota")+" "+e.$t("tasks.fields.seconds").substring(0,3))+". ",1),l("th",Ft,d(e.$t("tasks.fields.estimated_quota")+" "+e.$t("tasks.fields.frames").substring(0,3))+". ",1),l("th",At,d(e.$t("tasks.fields.estimated_quota")+" "+e.$t("tasks.fields.count"))+". ",1)])],512),l("tbody",Vt,[(r(!0),o(M,null,P(s.assignees,c=>(r(),o(M,{key:c.id},[l("tr",Bt,[l("td",qt,[_(f,{class:"flexrow-item",person:c,size:30,"font-size":17},null,8,["person"]),_(m,{class:"flexrow-item",person:c},null,8,["person"])]),l("td",xt,d(c.alltasks.count),1),l("td",Ot,d(c.alltasks.frames),1),l("td",Ut,d(c.alltasks.seconds),1),l("td",Lt,d(c.alltasks.estimation),1),l("td",Rt,d(c.alltasks.quota),1),l("td",Nt,d(c.alltasks.quotaFrames),1),l("td",Gt,d(c.alltasks.quotaCount),1)]),l("tr",zt,[l("td",Kt,[_(y,{class:"ml05 mr05",size:12}),F(" "+d(e.$t("main.remaining")),1)]),l("td",Yt,d(c.remaining.count),1),l("td",Qt,d(c.remaining.frames),1),l("td",Ht,d(c.remaining.seconds),1),l("td",Wt,d(c.remaining.estimation),1),l("td",jt,d(c.remaining.quota),1),l("td",$t,d(c.remaining.quotaFrames),1),l("td",Xt,d(c.remaining.quotaCount),1)])],64))),128))])])])])])}const Zt=G(Xe,[["render",Jt],["__scopeId","data-v-a61a1dd3"]]),es={name:"task-list-numbers",mixins:[Y],props:{isShots:{default:!1,type:Boolean},tasks:{default:()=>[],type:Array}},computed:{...K(["isPaperProduction"]),shotMap(){return z.cache.shotMap},timeSpent(){return this.tasks.reduce((e,t)=>e+t.duration,0)},timeEstimated(){return this.tasks.reduce((e,t)=>e+t.estimation,0)},nbFrames(){return this.tasks.reduce((e,t)=>{const i=this.shotMap.get(t.entity.id);return i&&i.nb_frames&&(e+=i.nb_frames),e},0)},nbDrawings(){return this.tasks.reduce((e,t)=>e+t.nb_drawings,0)}}},ts={class:"has-text-centered nb-tasks"},ss={key:0},is={key:1};function as(e,t,i,n,a,s){return r(),o("p",ts,[F(d(i.tasks.length)+" "+d(e.$tc("tasks.number",i.tasks.length))+" ("+d(e.formatDuration(s.timeEstimated))+" "+d(e.isDurationInHours?e.$tc("main.hours_estimated",e.formatDuration(s.timeEstimated,!1)):e.$tc("main.days_estimated",e.formatDuration(s.timeEstimated,!1)))+", "+d(e.formatDuration(s.timeSpent))+" "+d(e.isDurationInHours?e.$tc("main.hours_spent",e.formatDuration(s.timeSpent,!1)):e.$tc("main.days_spent",e.formatDuration(s.timeSpent,!1))),1),i.isShots&&!e.isPaperProduction?(r(),o("span",ss,", "+d(s.nbFrames)+" "+d(e.$tc("main.nb_frames",s.nbFrames)),1)):h("",!0),i.isShots&&e.isPaperProduction?(r(),o("span",is,", "+d(s.nbDrawings)+" "+d(e.$tc("main.nb_drawings",s.nbDrawings)),1)):h("",!0),t[0]||(t[0]=F(") "))])}const oe=G(es,[["render",as]]),ns={name:"task-list",mixins:[le,Y],components:{Combobox:ze,DateField:re,EntityPreview:Ke,EntityThumbnail:ae,PeopleAvatarWithMenu:Ye,TableInfo:Qe,TaskListNumbers:oe,ValidationCell:He,ValidationTag:We},emits:["scroll","task-selected"],data(){return{difficultyOptions:[{label:"•",value:1},{label:"••",value:2},{label:"•••",value:3},{label:"••••",value:4},{label:"•••••",value:5}],lastSelection:null,page:1,selectionGrid:{},selectedDate:q().toDate()}},props:{disabledDates:{type:Object,default:()=>{}},entityType:{type:String,default:"Asset"},isContactSheet:{type:Boolean,default:!1},isError:{type:Boolean,default:!1},isGrouped:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},tasks:{type:Array,default:()=>[]},withSchedule:{type:Boolean,default:!1}},mounted(){window.addEventListener("keydown",this.onKeyDown,!1)},beforeUnmount(){window.removeEventListener("keydown",this.onKeyDown)},computed:{...K(["isCurrentUserManager","isCurrentUserSupervisor","isPaperProduction","nbSelectedTasks","personMap","user","selectedTasks","taskMap","taskTypeMap"]),assetMap(){return te.cache.assetMap},editMap(){return ee.cache.editMap},episodeMap(){return Z.cache.episodeMap},sequenceMap(){return J.cache.sequenceMap},shotMap(){return z.cache.shotMap},isAssets(){return this.entityType==="Asset"},isEpisodes(){return this.entityType==="Episode"},isSequences(){return this.entityType==="Sequence"},isShots(){return this.entityType==="Shot"},displayedTasks(){return this.tasks&&this.tasks.length>0?this.tasks.slice(0,60*this.page):[]},tasksByParent(){const e=[];if(this.tasks.length>0){if(this.isShots){let t={name:this.tasks[0].sequence_name,tasks:[]},i=null;this.tasks.forEach(n=>{const a=this.shotMap.get(n.entity.id);i&&this.shotMap.get(i.entity.id)?.sequence_id!==a?.sequence_id&&(e.push(t),t={name:n.sequence_name,tasks:[]}),t.tasks.push(n),i=n}),e.push(t)}else if(this.isAssets){let t={name:this.tasks[0].entity_type_name,tasks:[]},i=null;this.tasks.forEach(n=>{const a=this.assetMap.get(n.entity.id);i&&this.assetMap.get(i.entity.id)?.asset_type_id!==a?.asset_type_id&&(e.push(t),t={name:n.entity_type_name,tasks:[]}),t.tasks.push(n),i=n}),e.push(t)}}return e}},methods:{...X(["addSelectedTask","addSelectedTasks","clearSelectedTasks","updateTask","unassignPersonFromTask","removeSelectedTask"]),getTaskName(e){return this.entityType==="Shot"?`${e.sequence_name} / ${this.getEntity(e.entity.id).name}`:e.entity_name},isTaskChanged(e,t){const i=e.start_date?e.start_date.substring(0,10):"",n=e.due_date?e.due_date.substring(0,10):"";return t.start_date!==void 0&&i!==t.start_date||t.due_date!==void 0&&n!==t.due_date||t.estimation!==void 0&&e.estimation!==t.estimation||t.difficulty!==void 0&&e.difficulty!==t.difficulty||t.nb_drawings!==void 0&&e.nb_drawings!==t.nb_drawings},getDate(e){return e?q(e,"YYYY-MM-DD").toDate():null},updateEstimation(e){const t=this.organisation.format_duration_in_hours?e*60:ne(this.organisation,e);this.updateTasksEstimation({estimation:t})},onUnassign(e,t){this.selectedTasks.size>0&&this.selectedTasks.forEach(i=>{this.unassignPersonFromTask({task:i,person:t})}),this.unassignPersonFromTask({task:e,person:t})},updateStartDate(e){Object.keys(this.selectionGrid).forEach(t=>{const i=this.taskMap.get(t),n=i.due_date?se(i.due_date):null;let a;if(e){const s=q(e);if(i.start_date&&i.start_date.substring(0,10)===$(s))return;a=j(this.organisation,s,n,A(this.organisation,i.estimation))}else a={start_date:null,due_date:i.due_date};i.difficulty&&(a.difficulty=i.difficulty),this.isTaskChanged(i,a)&&this.updateTask({taskId:t,data:a}).catch(console.error)})},updateDueDate(e){Object.keys(this.selectionGrid).forEach(t=>{const i=this.taskMap.get(t),n=i.start_date?se(i.start_date):null;let a;if(e){const s=q(e);if(i.due_date&&i.due_date.substring(0,10)===$(s))return;a=pe(this.organisation,n,s,A(this.organisation,i.estimation))}else a={start_date:i.start_date,due_date:null};this.isTaskChanged(i,a)&&this.updateTask({taskId:t,data:a}).catch(console.error)})},updateTasksEstimation({estimation:e}){Object.keys(this.selectionGrid).forEach(t=>{const i=this.taskMap.get(t);let n={estimation:e};if(i.start_date){const a=q(i.start_date),s=i.due_date?q(i.due_date):null;n=j(this.organisation,a,s,A(this.organisation,e)),n.estimation=e}this.isTaskChanged(i,n)&&this.updateTask({taskId:t,data:n}).catch(console.error)})},updateDifficulty(e){this.updateTasksData({difficulty:e})},updateNbDrawings(e){this.updateTasksData({nb_drawings:e})},updateTasksData(e){Object.keys(this.selectionGrid).forEach(t=>{const i=this.taskMap.get(t);this.isTaskChanged(i,e)&&this.updateTask({taskId:t,data:e}).catch(console.error)})},formatDate(e){return e?q(e).format("YYYY-MM-DD"):""},isEstimationBurned(e){return e.estimation&&e.estimation>0&&e.duration>e.estimation},onBodyScroll(e){if(!this.$refs.body)return;const t=e.target;this.$refs.body.scrollHeight-this.$refs.body.offsetHeight<t.scrollTop+100&&this.page++,this.$emit("scroll",{top:t.scrollTop})},getEntity(e){return this[`${this.entityType.toLowerCase()}Map`].get(e)||{}},onKeyDown(e){if(this.tasks.length>0&&e.altKey){let t=this.lastSelection?this.lastSelection:0;[37,38].includes(e.keyCode)?(t=t-1<0?this.tasks.length-1:t-1,this.selectTask({},t,this.tasks[t]),this.pauseEvent(e)):[39,40].includes(e.keyCode)&&(t=t+1>=this.tasks.length?0:t+1,this.selectTask({},t,this.tasks[t]),this.pauseEvent(e))}},selectTask(e,t,i){if(e&&e.target&&(["INPUT"].includes(e.target.nodeName)||e.target.className.indexOf("selected-line")>=0||e.target.className.indexOf("down-icon")>=0||e.target.className.indexOf("flexrow")>=0||e.target.className.indexOf("c-mask")>=0||e.target.className.indexOf("option-line")>=0||e.target.className.indexOf("combobox")>=0||e.target.className===""||e.target.parentNode&&["difficulty"].includes(e.target.className)||e.target.parentNode&&["HEADER"].includes(e.target.parentNode.nodeName)||["cell day selected"].includes(e.target.className)))return;const n=this.selectionGrid[i.id],a=Object.keys(this.selectionGrid).length>1;if(!(e.ctrlKey||e.metaKey)&&!e.shiftKey&&(this.clearSelectedTasks(),this.resetSelection()),!e.shiftKey)n?(this.removeSelectedTask({task:i}),this.selectionGrid[i.id]=void 0):(!n||a)&&(this.addSelectedTask({task:i}),this.$emit("task-selected",i),this.selectionGrid[i.id]=!0,this.lastSelection=t);else{this.selectionGrid={};const f=(this.lastSelection>t?N(t,this.lastSelection):N(this.lastSelection,t)).map(m=>({task:this.tasks[m]}));f.forEach(m=>{this.selectionGrid[m.task.id]=!0}),this.addSelectedTasks(f)}this.scrollToLine(i.id)},setScrollPosition(e){this.$refs.body&&(this.$refs.body.scrollTop=e)},scrollToLine(e){const t=this.$refs[`task-${e}`];if(t&&this.$refs.body){const n=t[0].getBoundingClientRect(),a=this.$refs.body.getBoundingClientRect(),s=n.bottom>a.bottom-30,f=n.top<a.top+30;if(s){const m=n.bottom-a.bottom+30;this.setScrollPosition(this.$refs.body.scrollTop+m)}else if(f){const m=a.top-n.top+30;this.setScrollPosition(this.$refs.body.scrollTop-m)}}},isInDepartment(e){if(this.isCurrentUserManager)return!0;if(this.isCurrentUserSupervisor){if(this.user.departments.length===0)return!0;const t=this.taskTypeMap.get(e.task_type_id);return t.department_id&&this.user.departments.includes(t.department_id)}return!1},resetSelection(){this.selectionGrid={},this.lastSelection=null},getTableData(){const e=[this.isAssets?this.$t("tasks.fields.asset_type"):this.$t("tasks.fields.sequence"),this.$t("tasks.fields.entity_name"),this.$t("tasks.fields.task_status"),this.$t("tasks.fields.assignees"),this.$t("tasks.fields.difficulty"),this.$t("tasks.fields.estimation"),this.$t("tasks.fields.duration"),this.$t("tasks.fields.retake_count"),this.$t("tasks.fields.start_date"),this.$t("tasks.fields.due_date"),this.$t("tasks.fields.real_start_date"),this.$t("tasks.fields.real_end_date"),this.$t("tasks.fields.done_date"),this.$t("tasks.fields.last_comment_date")];if(this.isShots){const i=this.isPaperProduction?this.$t("tasks.fields.drawings"):this.$t("tasks.fields.frames");e.splice(4,0,i)}const t=[e];return this.tasks.forEach(i=>{if(!i)return;const n=i.assignees.map(s=>{const f=this.personMap.get(s);return f?f.name:""}).join(", "),a=[this.isAssets?this.getEntity(i.entity.id).asset_type_name:this.getEntity(i.entity.id).sequence_name,this.getEntity(i.entity.id).name,i.task_status_short_name,n,i.difficulty,this.formatDuration(i.estimation,!1),this.formatDuration(i.duration,!1),i.retake_count,this.formatDate(i.start_date),this.formatDate(i.due_date),this.formatDate(i.real_start_date),this.formatDate(i.end_date),this.formatDate(i.done_date),this.formatDate(i.last_comment_date)];if(this.isShots){const s=this.isPaperProduction?i.nb_drawings||0:this.getEntity(i.entity.id).nb_frames;a.splice(4,0,s)}t.push(a)}),t}},watch:{tasks(){this.page=1,this.resetSelection()},nbSelectedTasks(){this.nbSelectedTasks===0&&this.resetSelection()}}},rs={class:"data-list"},ls={class:"datatable"},os={ref:"thead",class:"datatable-head"},ds={class:"row-header"},us={class:"thumbnail",ref:"th-thumbnail"},cs=["title"],hs={key:10,class:"empty"},ms={class:"datatable-body"},fs=["onClick"],ps={class:"thumbnail flexrow"},ys={key:0,class:"asset-type"},ks={key:1,class:"sequence"},_s={class:"name"},gs=["title"],Ts={class:"assignees"},Ss={class:"flexrow"},bs={key:2,class:"frames number-cell"},Ds={key:3,class:"drawings number-cell"},vs=["value"],ws={class:"difficulty number-cell"},Es={class:"estimation number-cell"},Ms=["value"],Cs={class:"retake-count number-cell"},Is={key:4,class:"start-date"},Ps={key:5,class:"due-date"},Fs={key:6,class:"real-start-date"},As={key:7,class:"real-end-date"},Vs={key:8,class:"done-date"},Bs={key:9,class:"last-comment-date"},qs={key:10},xs={key:1,class:"list-wrapper"},Os={class:"task-grid"},Us=["onClick"],Ls={class:"task-name"},Rs={class:"flexrow task-data"},Ns={key:2,class:"task-grid list-wrapper"},Gs=["onClick"],zs={class:"task-name"},Ks={class:"flexrow task-data"};function Ys(e,t,i,n,a,s){const f=T("entity-thumbnail"),m=T("validation-cell"),I=T("people-avatar-with-menu"),y=T("combobox"),c=T("date-field"),E=T("table-info"),p=T("entity-preview"),w=T("validation-tag"),S=T("task-list-numbers");return r(),o(M,null,[l("div",rs,[i.isContactSheet?s.tasksByParent&&s.tasksByParent.length>0&&i.isGrouped?(r(),o("div",xs,[(r(!0),o(M,null,P(s.tasksByParent,(u,D)=>(r(),o("div",{key:`task-section-${D}`},[l("h2",null,d(u.name),1),l("div",Os,[(r(!0),o(M,null,P(u.tasks,(g,B)=>(r(),o("div",{class:V({"task-card":!0,selected:a.selectionGrid[g.id]}),key:g.id,onClick:x=>s.selectTask(x,B,g)},[g.entity?(r(),C(p,{key:0,class:"flexrow-item",entity:s.getEntity(g.entity.id),height:133,width:200,"empty-width":200,"empty-height":133,"show-movie":!1,"no-preview":""},null,8,["entity"])):h("",!0),l("span",Ls,d(s.getTaskName(g)),1),l("div",Rs,[_(w,{class:"flexrow-item",task:g,thin:""},null,8,["task"]),t[4]||(t[4]=l("div",{class:"filler"},null,-1)),(r(!0),o(M,null,P(g.assignees,x=>(r(),C(I,{class:"flexrow-item",key:`${g.id}-${x}`,person:e.personMap.get(x),size:20,"font-size":10,onUnassign:Q=>s.onUnassign(g,Q)},null,8,["person","onUnassign"]))),128))])],10,Us))),128))])]))),128))])):(r(),o("div",Ns,[(r(!0),o(M,null,P(s.displayedTasks,(u,D)=>(r(),o("div",{class:V({"task-card":!0,selected:a.selectionGrid[u.id]}),key:u.id,onClick:g=>s.selectTask(g,D,u)},[u.entity?(r(),C(p,{key:0,class:"flexrow-item",entity:s.getEntity(u.entity.id),height:133,width:200,"empty-width":200,"empty-height":133,"show-movie":!1,"no-preview":""},null,8,["entity"])):h("",!0),l("span",zs,d(s.getTaskName(u)),1),l("div",Ks,[_(w,{class:"flexrow-item",task:u,thin:""},null,8,["task"]),t[5]||(t[5]=l("div",{class:"filler"},null,-1)),(r(!0),o(M,null,P(u.assignees,g=>(r(),C(I,{class:"flexrow-item",key:`${u.id}-${g}`,person:e.personMap.get(g),size:20,"font-size":10,onUnassign:B=>s.onUnassign(u,B)},null,8,["person","onUnassign"]))),128))])],10,Gs))),128))])):(r(),o("div",{key:0,ref:"body",class:V(["datatable-wrapper",{"with-schedule":i.withSchedule}]),onScrollPassive:t[3]||(t[3]=(...u)=>s.onBodyScroll&&s.onBodyScroll(...u))},[l("table",ls,[l("thead",os,[l("tr",ds,[l("th",us,null,512),s.isAssets?(r(),o("th",{key:0,class:"asset-type",ref:"th-type"},d(e.$t("tasks.fields.asset_type")),513)):!s.isEpisodes&&!s.isSequences?(r(),o("th",{key:1,class:"sequence",ref:"th-type"},d(e.$t("tasks.fields.sequence")),513)):h("",!0),l("th",{class:"name",ref:"th-name"},d(e.$t("tasks.fields.entity_name")),513),l("th",{class:"status",ref:"th-status"},d(e.$t("tasks.fields.task_status")),513),l("th",{class:"assignees",ref:"th-assignees"},d(e.$t("tasks.fields.assignees")),513),s.isShots&&!e.isPaperProduction?(r(),o("th",{key:2,ref:"th-frames",class:"frames number-cell"},d(e.$t("tasks.fields.frames")),513)):h("",!0),s.isShots&&e.isPaperProduction?(r(),o("th",{key:3,ref:"th-drawings",class:"drawings number-cell"},d(e.$t("tasks.fields.drawings")),513)):h("",!0),l("th",{class:"difficulty number-cell",ref:"th-difficulty"},d(e.$t("tasks.fields.difficulty")),513),l("th",{ref:"th-estimation",class:"estimation number-cell",title:e.$t("main.estimation")},d(e.$t("tasks.fields.estimation").substring(0,3))+". ",9,cs),l("th",{class:"duration number-cell",ref:"th-duration"},d(e.$t("tasks.fields.duration").substring(0,3))+". ",513),l("th",{class:"retake-count number-cell",ref:"th-retake-count"},d(e.$t("tasks.fields.retake_count")),513),i.withSchedule?h("",!0):(r(),o("th",{key:4,class:"start-date",ref:"th-estimation"},d(e.$t("tasks.fields.start_date")),513)),i.withSchedule?h("",!0):(r(),o("th",{key:5,class:"due-date",ref:"th-estimation"},d(e.$t("tasks.fields.due_date")),513)),i.withSchedule?h("",!0):(r(),o("th",{key:6,class:"real-start-date",ref:"th-status"},d(e.$t("tasks.fields.real_start_date")),513)),i.withSchedule?h("",!0):(r(),o("th",{key:7,class:"real-end-date",ref:"th-status"},d(e.$t("tasks.fields.real_end_date")),513)),i.withSchedule?h("",!0):(r(),o("th",{key:8,class:"done-date",ref:"th-status"},d(e.$t("tasks.fields.done_date")),513)),i.withSchedule?h("",!0):(r(),o("th",{key:9,class:"last-comment-date",ref:"th-status"},d(e.$t("tasks.fields.last_comment_date")),513)),i.withSchedule?h("",!0):(r(),o("th",hs," "))])],512),l("tbody",ms,[(r(!0),o(M,null,P(i.tasks,(u,D)=>(r(),o("tr",{ref_for:!0,ref:`task-${u.id}`,key:u.id,class:V({"task-line":!0,"datatable-row":!0,selected:a.selectionGrid[u.id]}),onClick:g=>s.selectTask(g,D,u)},[l("td",ps,[u.entity?(r(),C(f,{key:0,class:"flexrow-item",entity:s.getEntity(u.entity.id),width:50,height:33,"empty-width":50,"empty-height":33},null,8,["entity"])):h("",!0)]),s.isAssets?(r(),o("td",ys,d(s.getEntity(u.entity.id).asset_type_name),1)):!s.isEpisodes&&!s.isSequences?(r(),o("td",ks,d(s.getEntity(u.entity.id).sequence_name),1)):h("",!0),l("td",_s,[l("div",{class:"ellipsis nowrap",title:s.getEntity(u.entity.id).name},d(s.getEntity(u.entity.id).name),9,gs)]),_(m,{class:"status unselectable","task-test":u,"is-border":!1,"is-assignees":!1,selectable:!1,"is-static":!0},null,8,["task-test"]),l("td",Ts,[l("div",Ss,[(r(!0),o(M,null,P(u.assignees,g=>(r(),C(I,{class:"flexrow-item",key:`${u.id}-${g}`,person:e.personMap.get(g),size:30,"font-size":16,onUnassign:B=>s.onUnassign(u,B)},null,8,["person","onUnassign"]))),128))])]),s.isShots&&!e.isPaperProduction?(r(),o("td",bs,d(s.getEntity(u.entity.id).nb_frames),1)):h("",!0),s.isShots&&e.isPaperProduction?(r(),o("td",Ds,[s.isInDepartment(u)&&a.selectionGrid[u.id]?(r(),o("input",{key:0,class:"input",min:"0",step:"1",type:"number",ref_for:!0,ref:`${u.id}-drawings`,value:u.nb_drawings,onChange:t[0]||(t[0]=g=>s.updateNbDrawings(g.target.value))},null,40,vs)):(r(),o(M,{key:1},[F(d(u.nb_drawings||0),1)],64))])):h("",!0),l("td",ws,[s.isInDepartment(u)&&a.selectionGrid[u.id]?(r(),C(y,{key:0,class:"difficulty-combobox",options:a.difficultyOptions,"with-margin":!1,value:u.difficulty,"onUpdate:modelValue":[t[1]||(t[1]=g=>s.updateDifficulty(g)),g=>u.difficulty=g],modelValue:u.difficulty},null,8,["options","value","modelValue","onUpdate:modelValue"])):(r(!0),o(M,{key:1},P(u.difficulty,g=>(r(),o("span",{class:"difficulty number-cell",key:`${u.id}-difficulty-${g}`}," • "))),128))]),l("td",Es,[s.isInDepartment(u)&&a.selectionGrid[u.id]?(r(),o("input",{key:0,class:"input",min:"0",step:"any",type:"number",ref_for:!0,ref:`${u.id}-estimation`,value:e.formatDuration(u.estimation,!1),onChange:t[2]||(t[2]=g=>s.updateEstimation(g.target.value))},null,40,Ms)):(r(),o(M,{key:1},[F(d(e.formatDuration(u.estimation)),1)],64))]),l("td",{class:V({duration:!0,"number-cell":!0,error:s.isEstimationBurned(u)})},d(e.formatDuration(u.duration)),3),l("td",Cs,[(r(!0),o(M,null,P(u.retake_count,g=>(r(),o(M,{key:g},[F(" • ")],64))),128))]),i.withSchedule?h("",!0):(r(),o("td",Is,[s.isInDepartment(u)&&a.selectionGrid[u.id]?(r(),C(c,{key:0,class:"flexrow-item","with-margin":!1,"min-date":i.disabledDates.to,"model-value":s.getDate(u.start_date),"onUpdate:modelValue":s.updateStartDate},null,8,["min-date","model-value","onUpdate:modelValue"])):(r(),o(M,{key:1},[F(d(s.formatDate(u.start_date)),1)],64))])),i.withSchedule?h("",!0):(r(),o("td",Ps,[s.isInDepartment(u)&&a.selectionGrid[u.id]?(r(),C(c,{key:0,class:"flexrow-item","with-margin":!1,"model-value":s.getDate(u.due_date),"max-date":i.disabledDates.from,"onUpdate:modelValue":s.updateDueDate},null,8,["model-value","max-date","onUpdate:modelValue"])):(r(),o(M,{key:1},[F(d(s.formatDate(u.due_date)),1)],64))])),i.withSchedule?h("",!0):(r(),o("td",Fs,d(s.formatDate(u.real_start_date)),1)),i.withSchedule?h("",!0):(r(),o("td",As,d(s.formatDate(u.end_date)),1)),i.withSchedule?h("",!0):(r(),o("td",Vs,d(s.formatDate(u.done_date)),1)),i.withSchedule?h("",!0):(r(),o("td",Bs,d(s.formatDate(u.last_comment_date)),1)),i.withSchedule?h("",!0):(r(),o("td",qs))],10,fs))),128))])]),_(E,{"is-loading":i.isLoading,"is-error":i.isError},null,8,["is-loading","is-error"])],34)),ye(e.$slots,"default",{},void 0,!0)]),i.isLoading?h("",!0):(r(),C(S,{key:0,"is-shots":s.isShots,tasks:i.tasks},null,8,["is-shots","tasks"]))],64)}const Qs=G(ns,[["render",Ys],["__scopeId","data-v-7a7895cc"]]),L={all(e){return e},dueweek(e){const t=v().isoWeek();return e.filter(i=>k(i.due_date).isoWeek()===t)},duepreviousweek(e){const t=v().add(-7,"days").isoWeek();return e.filter(i=>k(i.due_date).isoWeek()===t)},duenextweek(e){const t=v().add(7,"days").isoWeek();return e.filter(i=>k(i.due_date).isoWeek()===t)},duebeforetoday(e){const t=v();return e.filter(i=>k(i.due_date).isBefore(t))},duemonth(e){const t=v().month();return e.filter(i=>k(i.due_date).month()===t)},duepreviousmonth(e){const t=v().add(-1,"months").month();return e.filter(i=>k(i.due_date).month()===t)},duenextmonth(e){const t=v().add(1,"months").month();return e.filter(i=>k(i.due_date).month()===t)},dueaftertoday(e){const t=v();return e.filter(i=>k(i.due_date).isAfter(t))},overestimation(e){return e.filter(t=>t.estimation&&t.duration>t.estimation)},approvallate(e,t){const i=v();return e.filter(n=>k(n.due_date).isBefore(i)&&!(t.get(n.task_status_id).is_feedback_request||t.get(n.task_status_id).is_done))},donelate(e,t){const i=v();return e.filter(n=>k(n.due_date).isBefore(i)&&!t.get(n.task_status_id).is_done)}},Hs={name:"task-type",mixins:[Y,Pe],components:{ButtonSimple:ke,CornerLeftUpIcon:$e,ComboboxNumber:Fe,ComboboxOptions:Ae,ComboboxStatus:Ve,ComboboxStyled:Be,ComboboxTaskType:qe,DateField:re,EstimationHelper:Zt,ImportModal:Ue,ImportRenderModal:Oe,Schedule:Le,SearchField:Re,SearchQueryList:Ne,TaskList:Qs,TaskInfo:Ge,TaskListNumbers:oe,TaskTypeName:je},data(){return{activeTab:"tasks",daysOffByPerson:{},timesheetByPerson:{},currentSort:"entity_name",currentScheduleItem:null,currentTask:null,contactSheetMode:!1,dataDisplay:{estimations:!0,statuses:!0,timesheets:!1,beforeAfterTasks:!1},dataDisplayOptions:[{label:this.$t("tasks.fields.estimation"),value:"estimations"},{label:this.$t("tasks.fields.task_status"),value:"statuses"},{label:this.$t("tasks.fields.timesheets"),value:"timesheets"},{label:this.$t("tasks.fields.before_after_tasks"),value:"beforeAfterTasks"}],dataMatchers:["Parent","Entity"],difficultyFilter:"-1",dueDateFilter:"all",entityType:"Asset",estimationFilter:"all",importCsvFormData:{},isScheduleVisible:!1,optionalColumns:["Estimation","Start date","Due date","Difficulty"],parsedCSV:[],priorityFilter:"-1",selection:{},tasks:[],taskStatusIdFilter:null,difficultyOptions:[{label:"all_tasks",value:"-1"},{label:"difficulty.very_easy",value:"1"},{label:"difficulty.easy",value:"2"},{label:"difficulty.medium",value:"3"},{label:"difficulty.hard",value:"4"},{label:"difficulty.very_hard",value:"5"}],dueDateOptions:[{label:"all_tasks",value:"all"},{label:"due_this_week",value:"dueweek"},{label:"due_previous_week",value:"duepreviousweek"},{label:"due_next_week",value:"duenextweek"},{label:"due_this_month",value:"duemonth"},{label:"due_previous_month",value:"duepreviousmonth"},{label:"due_next_month",value:"duenextmonth"},{label:"due_before_today",value:"duebeforetoday"},{label:"due_after_today",value:"dueaftertoday"}],estimationOptions:[{label:"all_tasks",value:"all"},{label:"estimation_over",value:"overestimation"},{label:"estimation_approval_late",value:"approvallate"},{label:"estimation_done_late",value:"donelate"}],errors:{entities:!1,importing:!1,importingError:null},loading:{entities:!1,importing:!1,savingSearch:!1},modals:{isImportRenderDisplayed:!1,importing:!1},priorityOptions:[{label:"all_tasks",value:"-1"},{label:"priority.normal",value:"0"},{label:"priority.high",value:"1"},{label:"priority.very_high",value:"2"},{label:"priority.emergency",value:"3"}],schedule:{currentColor:"status",startDate:null,endDate:null,scheduleItems:[],taskTypeAfter:null,taskTypeBefore:null,taskTypeEndDate:null,taskTypeStartDate:null,zoomLevel:1,zoomOptions:[{label:this.$t("main.week"),value:0},{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}],colorOptions:[{label:"Neutral",value:"neutral"},{label:"Status",value:"status"},{label:"Late",value:"late"}]}}},created(){if(!this.currentProduction)this.setProduction(this.$route.params.production_id);else{const e={productionId:this.currentProduction.id};this.currentEpisode&&(e.episodeId=this.currentEpisode.id),this.$store.commit("RESET_PRODUCTION_PATH",e)}},mounted(){if(!this.currentTaskType?.id){this.$router.push({name:"not-found"});return}this.setOptionalImportColumns(),this.searchField?.setValue(this.$route.query.search||""),this.clearSelectedTasks();const e=this.$route.path.includes("assets"),t=this.$route.path.includes("shots"),i=this.$route.path.includes("edits"),n=this.$route.path.includes("sequences");this.entityType=e?"Asset":t?"Shot":i?"Edit":n?"Sequence":"Episode",this.updateActiveTab(),setTimeout(()=>{this.initData(!1),this.resetScheduleScroll()},100)},beforeUnmount(){this.clearSelectedTasks()},computed:{...K(["assetsPath","assetValidationColumns","currentEpisode","currentProduction","currentTaskType","editsPath","editValidationColumns","episodesPath","episodeValidationColumns","isCurrentUserManager","isCurrentUserSupervisor","isPaperProduction","isTVShow","nbSelectedTasks","organisation","personMap","productionTaskStatuses","selectedTasks","sequenceSubscriptions","sequencesPath","sequenceValidationColumns","shotsByEpisode","shotsPath","shotValidationColumns","taskMap","taskSearchQueries","user"]),isEpisodesSection(){return this.$route.meta.section==="episodes"},taskStatusList(){return[{id:"",color:"#999",short_name:this.$t("news.all")}].concat(Ce([...this.productionTaskStatuses]))},taskTypeList(){const e=this.entityType.toLowerCase();return this[`${e}ValidationColumns`].map(t=>this.taskTypeMap.get(t))},taskTypeListBeforeFilter(){const e=this.taskTypeList.findIndex(i=>i.id===this.currentTaskType.id),t=[{id:null,name:this.$t("tasks.fields.no_task_type")}];return e!==-1&&t.push(...this.taskTypeList.slice(0,e).reverse()),t},taskTypeListAfterFilter(){const e=this.taskTypeList.findIndex(i=>i.id===this.currentTaskType.id),t=[{id:null,name:this.$t("tasks.fields.no_task_type")}];return e!==-1&&t.push(...this.taskTypeList.slice(e+1)),t},currentTaskTypeBefore(){return this.taskTypeList.find(e=>e.id===this.schedule.taskTypeBefore)},currentTaskTypeAfter(){return this.taskTypeList.find(e=>e.id===this.schedule.taskTypeAfter)},taskTypeStartDate(){return v(this.schedule.taskTypeStartDate).utc()},taskTypeEndDate(){return v(this.schedule.taskTypeEndDate).utc()},isSupervisorInDepartment(){const e=this.user.departments||[];return this.isCurrentUserManager||this.isCurrentUserSupervisor&&(!e.length||e.includes((this.currentTaskType||{}).department_id))},entityMap(){return this[`${this.entityType.toLowerCase()}Map`]},assetMap(){return te.cache.assetMap},editMap(){return ee.cache.editMap},episodeMap(){return Z.cache.episodeMap},sequenceMap(){return J.cache.sequenceMap},shotMap(){return z.cache.shotMap},taskStatusMap(){return Me.cache.taskStatusMap},taskTypeMap(){return Ee.cache.taskTypeMap},productionStartDate(){return k(this.currentProduction.start_date)},productionEndDate(){return k(this.currentProduction.end_date)},disabledDates(){return{to:k(this.currentProduction.start_date).toDate(),from:k(this.currentProduction.end_date).toDate(),days:[6,0]}},startDisabledDates(){return{to:k(this.currentProduction.start_date).toDate(),from:k(this.currentProduction.end_date).toDate(),days:[6,0]}},endDisabledDates(){return{to:k(this.currentProduction.start_date).toDate(),from:k(this.currentProduction.end_date).toDate(),days:[6,0]}},entityTasks(){return this.getTasks(Array.from(this.entityMap.values()))},title(){if(this.currentProduction){if(this.isTVShow&&this.currentEpisode){const e=this.currentEpisode.id==="all"?this.$t("main.all_assets"):this.currentEpisode.name;return`${this.currentProduction.name} / ${e} / ${this.currentTaskType.name}`}return`${this.currentProduction.name} / ${this.currentTaskType.name}`}return this.$t("main.loading")},backPath(){let e={};return this.isActiveTab("schedule")?e={name:"schedule",params:{production_id:this.currentProduction.id},query:{search:""}}:(this.currentTaskType.for_entity==="Shot"&&(e=this.shotsPath),this.currentTaskType.for_entity==="Asset"&&(e=this.assetsPath),this.currentTaskType.for_entity==="Edit"&&(e=this.editsPath),this.currentTaskType.for_entity==="Episode"&&(e=this.episodesPath),this.currentTaskType.for_entity==="Sequence"&&(e=this.sequencesPath)),{...e,query:{search:""}}},tasksPath(){return this.getRoute("task-type")},schedulePath(){return this.getRoute("task-type-schedule")},estimationPath(){return this.getRoute("task-type-estimation")},sortOptions(){return["entity_name","task_status_short_name","priority","nb_frames","difficulty","estimation","duration","retake_count","start_date","due_date","real_start_date","end_date","last_comment_date"].map(e=>({label:e,value:e}))},searchQueries(){return this.taskSearchQueries.filter(e=>e.entity_type===this.entityType)},team(){return we(this.currentProduction.team.map(e=>this.personMap.get(e)).filter(e=>e&&!e.is_bot))},searchField(){return this.$refs["task-search-field"]}},methods:{...X(["addSelectedTask","clearSelectedTasks","initTaskType","loadAggregatedPersonDaysOff","loadEpisodeScheduleItems","loadProductionDaysOff","loadProductionTimeSpents","loadScheduleItems","removeTaskSearch","saveScheduleItem","saveTaskSearch","setProduction","subscribeToSequence","updateTask","unsubscribeFromSequence","uploadTaskTypeEstimations"]),setOptionalImportColumns(){this.optionalColumns=["Estimation","Start date","Due date","Difficulty"],this.isPaperProduction&&this.optionalColumns.unshift("Drawings")},initData(e){this.resetTasks(),this.focusSearchField({preventScroll:!0}),this.tasks.length<2?(this.loading.entities=!0,this.errors.entities=!1,this.initTaskType(e).then(this.setCurrentScheduleItem).then(()=>{this.loading.entities=!1,this.resetTasks(),this.focusSearchField({preventScroll:!0});let t=this.$route.query.search;!t&&this.searchField&&(t=this.searchField.getValue()),t&&this.onSearchChange(t),setTimeout(()=>{this.setSearchFromUrl(),this.resetTaskTypeDates()},200),this.resetScheduleItems(!0),this.dueDateFilter=this.$route.query.duedate||"all",this.estimationFilter=this.$route.query.late||"all",this.priorityFilter=this.$route.query.priority||"-1",this.difficultyFilter=this.$route.query.difficulty||"-1",this.taskStatusIdFilter=this.$route.query.task_status_id||"";const i=this.$route.query.task_id,n=this.taskMap.get(i);if(n){const a=this.tasks.findIndex(s=>s.id===i);this.$nextTick(()=>{this.$refs["task-list"]?.selectTask({},a,n)})}}).catch(t=>{console.error(t),this.loading.entities=!1,this.errors.entities=!0})):(this.loading.entities=!0,this.setCurrentScheduleItem().then(()=>{this.resetTaskTypeDates(),this.loading.entities=!1;let t=this.$route.query.search;!t&&this.searchField&&(t=this.searchField.getValue()),t&&this.onSearchChange(t),this.resetScheduleItems(!0)}))},setCurrentScheduleItem(){return this.isTVShow&&!["all","main"].includes(this.currentEpisode.id)?this.loadEpisodeScheduleItems({production:this.currentProduction,taskType:this.currentTaskType}).then(e=>(this.currentScheduleItem=e.find(t=>t.task_type_id===this.currentTaskType.id&&t.object_id===this.currentEpisode.id),this.currentScheduleItem)):this.loadScheduleItems(this.currentProduction).then(e=>(this.currentScheduleItem=e.find(t=>t.task_type_id===this.currentTaskType.id),this.currentScheduleItem))},isActiveTab(e){return this.activeTab===e},updateActiveTab(){this.$route.path.indexOf("schedule")>0?this.activeTab="schedule":this.$route.path.indexOf("estimation")>0?this.activeTab="estimation":this.activeTab="tasks"},getRoute(e){const t=this.$route.params.task_type_id,i=this.currentTaskType?this.currentTaskType.id:t,n={name:e,params:{production_id:this.currentProduction.id,task_type_id:i}};return this.currentTaskType.for_entity==="Episode"?n.name=`episodes-${n.name}`:this.isTVShow&&this.currentEpisode&&(n.name=`episode-${n.name}`,n.params.episode_id=this.currentEpisode.id),n},onSearchChange(e){if(e&&e.length!==1){e=e.toLowerCase().trim();const t=(this.currentProduction.descriptors||[]).filter(f=>f.entity_type===this.entityType),i=Te(e)||[],n=Se(e)||[],a=be(t,[],e),s=De(this.$options.taskIndex,e);if(i.length>0||n.length>0||a.length>0||s.length>0){let f;const m=s.concat(a);i.length>0?f=ie(this.$options.taskIndex,i):(this.resetTasks(),f=this.tasks),f=ve(f,m,this.taskMap),this.tasks=this.sortTasks(f)}else this.resetTasks()}else this.resetTasks();this.resetScheduleItems(),this.setSearchInUrl(),this.clearSelectedTasks(),L[this.dueDateFilter]&&(this.tasks=L[this.dueDateFilter](this.tasks)),L[this.estimationFilter]&&(this.tasks=L[this.estimationFilter](this.tasks,this.taskStatusMap)),this.priorityFilter!=="-1"&&(this.tasks=this.tasks.filter(t=>t.priority===parseInt(this.priorityFilter))),this.difficultyFilter!=="-1"&&(this.tasks=this.tasks.filter(t=>t.difficulty===parseInt(this.difficultyFilter))),this.taskStatusIdFilter!==null&&this.taskStatusIdFilter!==""&&(this.tasks=this.tasks.filter(t=>t.task_status_id===this.taskStatusIdFilter))},saveSearchQuery(e){if(this.loading.savingSearch)return;const t=this.entityType;this.loading.savingSearch=!0,this.saveTaskSearch({searchQuery:e,entityType:t}).catch(console.error).finally(()=>{this.loading.savingSearch=!1})},removeSearchQuery(e){this.removeTaskSearch(e).catch(console.error)},updateUrlParams(){const e=this.searchField.getValue(),t=this.dueDateFilter,i=this.estimationFilter,n=this.priorityFilter,a=this.difficultyFilter,s=this.taskStatusIdFilter||null;this.$router.push({query:{search:e,duedate:t,late:i,priority:n,difficulty:a,task_status_id:s}})},applyTaskFilters(){this.onSearchChange(this.searchField.getValue()),this.sortTasks(),this.$refs["task-list"]?.resetSelection(),this.updateUrlParams(),this.clearSelectedTasks()},onTaskSelected(e){this.currentTask=e,this.updateTaskInQuery()},onTaskListScroll({top:e}){this.$refs["schedule-widget"]?.setScrollPosition(e)},onScheduleScroll({top:e}){this.$refs["task-list"]?.setScrollPosition(e)},toggleContactSheetMode(){this.contactSheetMode=!this.contactSheetMode,this.isScheduleVisible=!1},toggleSchedule(){this.isScheduleVisible=!this.isScheduleVisible,this.resetScheduleItems(!0)},updateTaskInQuery(){if(this.nbSelectedTasks===1){const t=Array.from(this.selectedTasks.keys())[0];this.$router.push({query:{...this.$route.query,task_id:t}})}else this.$router.push({query:{...this.$route.query,task_id:void 0}})},resetTasks(){let e=this.entityTasks;["Episode","Sequence"].includes(this.entityTypes)&&(e=e.filter(t=>!this.entityMap.get(t.entity_id).canceled)),this.tasks=this.sortTasks(e),this.resetTaskIndex()},resetTaskIndex(){this.entityTasks&&(this.$options.taskIndex=ge(this.entityTasks,this.personMap,this.taskStatusMap),this.$options.taskIndex.me=ie(this.$options.taskIndex,this.user.full_name.split(" ")))},getTasks(e){const t=[];return e.forEach(i=>{i.canceled||!i.tasks?.length||this.isTVShow&&!this.isEpisodesSection&&!["all",i.episode_id||"main"].includes(this.currentEpisode?.id)||i.tasks.forEach(n=>{const a=this.taskMap.get(n.id||n);a&&(this.$store.commit("SET_TASK_EXTRA_DATA",{task:a,data:i.data}),a.task_type_id===this.currentTaskType.id&&t.push(a))})}),t},sortTasks(e){e||(e=this.tasks);const t=["task_status_short_name","entity_name","due_date"].includes(this.currentSort);return this.currentSort==="nb_frames"?this.tasks=e.sort((i,n)=>{const a=this.getEntity(i.entity.id)?.nb_frames||0;return(this.getEntity(n.entity.id)?.nb_frames||0)-a}):this.currentSort!==name?this.tasks=e.sort(R.firstBy(this.currentSort,t?1:-1).thenBy("entity_name")):this.tasks=e.sort(R.firstBy("entity_name")),e},getEntity(e){return this[`${this.entityType.toLowerCase()}Map`].get(e)||{}},onExportClick(){const e=this.$refs["task-list"].getTableData(),t=[$(v()),this.currentProduction.name,this.currentTaskType.name,"tasks"];this.currentEpisode&&t.splice(1,0,this.currentEpisode.name);const i=Ie.slugify(t.join("_"));H.buildCsvFile(i,e)},updateEstimation({taskId:e,days:t,item:i,daysOff:n}){const a=ne(this.organisation,t),s=this.taskMap.get(e);let f={estimation:a};if(s.start_date){const m=k(s.start_date),I=s.due_date?k(s.due_date):null;f={...f,...j(this.organisation,m,I,A(this.organisation,a),n)},i&&(i.startDate=k(f.start_date),i.endDate=k(f.due_date),i.startDate&&i.endDate&&(i.parentElement.startDate=this.getMinDate(i.parentElement),i.parentElement.endDate=this.getMaxDate(i.parentElement)))}this.updateTask({taskId:e,data:f}).catch(console.error)},onDataDisplayChange(e){if(e.key==="timesheets"&&e.value){this.resetScheduleItems();return}e.key==="beforeAfterTasks"&&e.value&&(this.schedule.taskTypeBefore||(this.schedule.taskTypeBefore=this.taskTypeListBeforeFilter[1]?.id),this.schedule.taskTypeAfter||(this.schedule.taskTypeAfter=this.taskTypeListAfterFilter[1]?.id),this.resetScheduleItems())},async resetScheduleItems(e=!1){this.isActiveTab("schedule")?await this.resetScheduleItemsForScheduleTab():this.isActiveTab("tasks")&&this.isScheduleVisible&&await this.resetScheduleItemsForTasksTab(),e&&this.resetScheduleScroll()},async resetScheduleItemsForScheduleTab(){if(!this.currentScheduleItem)return;const e=this.buildAssignationMap(),t=this.currentScheduleItem.start_date,i=this.currentScheduleItem.end_date;if(this.daysOffByPerson=await this.loadProductionDaysOff({startDate:t,endDate:i}).catch(()=>({})),this.dataDisplay.timesheets){const a=Object.keys(e).filter(s=>s!=="unassigned"&&e[s].length>0);this.timesheetByPerson=await this.loadTimesheets(a,t,i)}const n=this.team.map(a=>this.buildPersonElement(a,e,this.dataDisplay.beforeAfterTasks)).filter(a=>a?.children.length>0);e.unassigned.length>0&&n.push(this.buildPersonElement({id:"unassigned"},e,this.dataDisplay.beforeAfterTasks)),this.schedule.scheduleItems=n},async resetScheduleItemsForTasksTab(){if(!this.currentScheduleItem)return;const e=this.buildAssignationMap(),t=this.currentScheduleItem.start_date,i=this.currentScheduleItem.end_date;if(this.daysOffByPerson=await this.loadProductionDaysOff({startDate:t,endDate:i}).catch(()=>({})),this.dataDisplay.timesheets){const a=Object.keys(e).filter(s=>s!=="unassigned"&&e[s].length>0);this.timesheetByPerson=await this.loadTimesheets(a,t,i)}const n=[{id:"",color:"transparent",children:[],timesheet:[],expanded:!0}];this.tasks.forEach(a=>{const s=this.personMap.get(a.assignees[0])||{id:"unassigned"},f={[s.id]:[a]},m=this.buildPersonElement(s,f,this.dataDisplay.beforeAfterTasks);n[0].startDate=m.startDate,n[0].endDate=m.endDate,n[0].children.push(...m.children),n[0].timesheet.push(...m.timesheet)}),this.schedule.scheduleItems=n},buildAssignationMap(){const e={unassigned:[]};return this.team.forEach(t=>{t&&(e[t.id]=[])}),this.tasks.forEach(t=>{t.assignees.length>0?t.assignees.forEach(i=>{e[i]||(e[i]=[]),e[i].push(t)}):e.unassigned.push(t)}),e},async loadTimesheets(e,t,i){const n=await this.loadProductionTimeSpents({taskType:this.currentTaskType,startDate:t,endDate:i}).catch(()=>({})),a={};for(const s of e){const f=n[s]?.sort(R.firstBy("date").thenBy("task_id"))||[];f.forEach(y=>{y.task=this.tasks.find(c=>c.id===y.task_id),y.startDate=k(y.date),y.endDate=k(y.date)});const m=[],I=this.organisation.hours_by_day*60;for(const y of f){const c=m.length?m[m.length-1]:null;c&&c.task_id===y.task_id&&(c.date===y.date||c.duration>=I&&y.startDate.diff(c.startDate,"days")===1)?m[m.length-1]={...c,duration:c.duration+y.duration,endDate:y.endDate}:m.push(y)}a[s]=m}return a},buildPersonElement(e,t,i=!1){if(!e)return null;let n=0,a,s;const f=t[e.id];let m;e.id==="unassigned"?m={avatar:!1,id:e.id,name:this.$t("main.unassigned"),color:"#888",priority:1,expanded:!0,loading:!1,children:[],editable:!1,timesheet:[]}:m={avatar:!0,has_avatar:e.has_avatar,avatarPath:e.avatarPath,initials:e.initials,id:e.id,name:e.full_name,color:e.color,priority:1,expanded:!0,loading:!1,children:[],editable:!1,daysOff:this.daysOffByPerson[e.id],timesheet:this.timesheetByPerson[e.id]??[],route:_e(e.id,"schedule")};const I=f.map(y=>{const c=y.estimation;let E,p=v(this.schedule.taskTypeStartDate);if(y.start_date?p=k(y.start_date):y.real_start_date&&(p=k(y.real_start_date)),p.isAfter(this.schedule.endDate)&&(p=this.schedule.endDate.clone().add(-1,"days")),p.isBefore(this.schedule.startDate)&&(p=this.schedule.startDate.clone()),y.due_date?E=k(y.due_date):y.end_date?E=k(y.end_date):E=U(p,Math.ceil(A(this.organisation,y.estimation))-1,m.daysOff),!E||E.isBefore(p)){const S=p.isoWeekday()===5?3:1;E=p.clone().add(S,"days")}E.isAfter(this.schedule.endDate)&&(E=this.schedule.endDate.clone().add(-1,"days"),p.isAfter(E)&&(p=E.clone().add(-1,"days"))),c&&(n+=c),(!a||a.isAfter(p))&&(a=p.clone()),(!s||s.isBefore(E))&&(s=E.clone());const w={...y,name:y.entity_name,startDate:p,endDate:E,expanded:!1,loading:!1,man_days:c,editable:this.isSupervisorInDepartment,unresizable:!1,parentElement:m,color:this.getTaskElementColor(y,E),children:[]};if(i){const u=this.entityMap.get(y.entity_id)?.tasks.map(D=>this.taskMap.get(D)).filter(Boolean);this.schedule.taskTypeBefore&&(w.previousElement=u.find(D=>D.task_type_id===this.schedule.taskTypeBefore)),this.schedule.taskTypeAfter&&(w.nextElement=u.find(D=>D.task_type_id===this.schedule.taskTypeAfter))}if(w.previousElement){const S=w.previousElement;let u;S.start_date?u=k(S.start_date):S.real_start_date&&(u=k(S.real_start_date));let D;S.due_date?D=k(S.due_date):S.end_date?D=k(S.end_date):D=U(u,Math.ceil(A(this.organisation,S.estimation))-1,m.daysOff),u&&D?(w.previousElement.name=`[${this.currentTaskTypeBefore.name}] ${S.entity_name}`,w.previousElement.startDate=u,w.previousElement.endDate=D,w.previousElement.color=this.getTaskElementColor(S,D)):w.previousElement=null}if(w.nextElement){const S=w.nextElement;let u;S.start_date?u=k(S.start_date):S.real_start_date&&(u=k(S.real_start_date));let D;S.due_date?D=k(S.due_date):S.end_date?D=k(S.end_date):D=U(u,Math.ceil(A(this.organisation,S.estimation))-1,m.daysOff),u&&D?(w.nextElement.name=`[${this.currentTaskTypeAfter.name}] ${S.entity_name}`,w.nextElement.startDate=u,w.nextElement.endDate=D,w.nextElement.color=this.getTaskElementColor(S,D)):w.nextElement=null}return w});return{...m,children:I,startDate:a,endDate:s,man_days:n}},getTaskElementColor(e,t){if(this.schedule.currentColor==="status"){let i=this.taskStatusMap.get(e.task_status_id).color;return i==="#f5f5f5"&&(i="#999"),i}else if(this.schedule.currentColor==="late")return!this.taskStatusMap.get(e.task_status_id).is_done&&t.isBefore(v())?"#FF3860":"#999";return null},saveTaskScheduleItem(e){e.estimation&&(e.endDate=U(e.startDate,Math.ceil(A(this.organisation,e.estimation))-1,e.parentElement.daysOff)),e.man_days=e.estimation||0,e.startDate&&e.endDate&&(e.parentElement.startDate=this.getMinDate(e.parentElement),e.parentElement.endDate=this.getMaxDate(e.parentElement),this.updateTask({taskId:e.id,data:{estimation:e.estimation,start_date:e.startDate.format("YYYY-MM-DD"),due_date:e.endDate.format("YYYY-MM-DD")}}))},getMinDate(e){let i=this.productionEndDate.clone();return e.children.forEach(n=>{n.startDate&&n.startDate.isBefore(i)&&(i=n.startDate)}),i.clone()},getMaxDate(e){let i=this.productionStartDate.clone();return e.children.forEach(n=>{n.endDate&&n.endDate.isAfter(i)&&(i=n.endDate)}),i.clone()},expandPersonElement(e){e.expanded=!e.expanded},showImportModal(){this.modals.importing=!0},hideImportModal(){this.modals.importing=!1},showImportRenderModal(){this.modals.isImportRenderDisplayed=!0},hideImportRenderModal(){this.modals.isImportRenderDisplayed=!1},resetImport(){this.errors.importing=!1,this.errors.importingError=null,this.hideImportRenderModal(),this.importCsvFormData=void 0,this.$refs["import-modal"].reset(),this.showImportModal()},uploadImportFile(e){const t=new FormData,i="import.csv",n=H.turnEntriesToCsvString(e),a=new File([n],i,{type:"text/csv"});t.append("file",a),this.loading.importing=!0,this.errors.importing=!1,this.errors.importingError=null,this.importCsvFormData=t,this.uploadTaskTypeEstimations(this.importCsvFormData).then(()=>{this.hideImportRenderModal()}).catch(s=>{this.errors.importingError=s,this.errors.importing=!0}).finally(()=>{this.loading.importing=!1})},renderImport(e,t){this.loading.importing=!0,this.errors.importing=!1,t==="file"&&(e=e.get("file")),H.processCSV(e).then(i=>{this.parsedCSV=i,this.hideImportModal(),this.loading.importing=!1,this.showImportRenderModal()})},resetTaskTypeDates(){this.currentScheduleItem&&(this.schedule.taskTypeStartDate=k(this.currentScheduleItem.start_date).toDate(),this.schedule.taskTypeEndDate=k(this.currentScheduleItem.end_date).toDate())},resetScheduleScroll(){if(!this.$refs["schedule-widget"])return;const e=v();if(e.isBefore(v(this.schedule.taskTypeStartDate))||e.isAfter(v(this.schedule.taskTypeEndDate))){const t=v(this.schedule.taskTypeStartDate).add(this.isScheduleVisible?0:20,"days");this.$refs["schedule-widget"].scrollToDate(t)}else this.$refs["schedule-widget"].scrollToToday()}},watch:{$route(){this.updateActiveTab()},"$route.query.search"(){const e=this.searchField.getValue(),t=this.$route.query.search;t&&t!==e&&(this.searchField.setValue(t),this.onSearchChange(t))},currentProduction(){this.setOptionalImportColumns(),this.initData(!0)},nbSelectedTasks(){this.updateTaskInQuery()},currentEpisode(){this.currentEpisode&&!this.backPath.params?.episode_id&&this.$store.commit("RESET_PRODUCTION_PATH",{productionId:this.currentProduction.id,episodeId:this.currentEpisode.id})},difficultyFilter(){this.applyTaskFilters()},dueDateFilter(){this.applyTaskFilters()},estimationFilter(){this.applyTaskFilters()},priorityFilter(){this.applyTaskFilters()},taskStatusIdFilter(){this.applyTaskFilters()},currentSort(){this.sortTasks(),this.$refs["task-list"].resetSelection(),this.resetScheduleItems(),this.clearSelectedTasks(),this.updateTaskInQuery()},"schedule.currentColor"(){this.resetScheduleItems()},activeTab(){this.resetScheduleItems(!0)},currentScheduleItem(){this.currentScheduleItem&&this.resetTaskTypeDates()},"schedule.taskTypeStartDate"(){v(this.schedule.taskTypeStartDate).utc().format("YYYY-MM-DD")!==this.currentScheduleItem.start_date&&(this.$store.commit("SET_SCHEDULE_ITEM_DATES",{scheduleItem:this.currentScheduleItem,dates:{startDate:v(this.schedule.taskTypeStartDate).utc(),endDate:v(this.schedule.taskTypeEndDate).utc()}}),this.saveScheduleItem(this.currentScheduleItem))},"schedule.taskTypeEndDate"(){v(this.schedule.taskTypeEndDate).utc().format("YYYY-MM-DD")!==this.currentScheduleItem.end_date&&(this.$store.commit("SET_SCHEDULE_ITEM_DATES",{scheduleItem:this.currentScheduleItem,dates:{startDate:v(this.schedule.taskTypeStartDate).utc(),endDate:v(this.schedule.taskTypeEndDate).utc()}}),this.saveScheduleItem(this.currentScheduleItem))}},socket:{events:{"task:update"(e){this.resetScheduleItems(),!this.isActiveTab("schedule")&&this.taskMap.get(e.task_id)&&this.selectedTasks===0&&this.searchField&&this.searchField.getValue()===""&&(this.resetTaskIndex(),this.$nextTick(()=>{this.onSearchChange(this.searchField.getValue())}))}}},head(){return{title:`${this.title} - Kitsu`}}},Ws={class:"task-type columns fixed-page"},js={class:"column main-column"},$s={class:"task-type page",ref:"page"},Xs={class:"task-type-header page-header flexrow-item",ref:"header"},Js={class:"flexcolumn-item flexrow"},Zs={key:1,class:"flexrow-item"},ei={class:"flexrow-item"},ti={class:"tabs mt1"},si={class:"flexcolumn-item flexrow align-end mb1"},ii={class:"flexrow-item search-options"},ai={key:0,class:"flexrow-item flexrow align-end"},ni={key:1,class:"flexrow-item flexrow align-end"},ri={"flexrow-item":""},li={key:0,class:"label"},oi={key:0,class:"flexrow-item flexrow ml1"},di={key:3,class:"flexrow-item"},ui={key:4,class:"flexrow-item"},ci={key:5,class:"flexrow-item"},hi={key:6,class:"flexrow-item color-option"},mi={key:7,class:"flexrow-item zoom-level"},fi={key:0,class:"query-list"},pi={key:2,class:"task-type-schedule flexrow-item"},yi={key:3,class:"task-type-estimation flexrow-item"},ki={key:0,class:"column side-column"};function _i(e,t,i,n,a,s){const f=T("corner-left-up-icon"),m=T("router-link"),I=T("task-type-name"),y=T("button-simple"),c=T("search-field"),E=T("combobox-status"),p=T("combobox-styled"),w=T("combobox-options"),S=T("combobox-task-type"),u=T("date-field"),D=T("combobox-number"),g=T("search-query-list"),B=T("schedule"),x=T("task-list"),Q=T("task-list-numbers"),de=T("estimation-helper"),ue=T("import-render-modal"),ce=T("import-modal"),he=T("task-info");return r(),o("div",Ws,[l("div",js,[l("div",$s,[l("div",Xs,[l("div",Js,[_(m,{class:"back-link flexrow-item",to:s.backPath},{default:O(()=>[_(f)]),_:1},8,["to"]),t[17]||(t[17]=l("div",{class:"flexrow-item"},null,-1)),_(I,{class:"flexrow-item",style:{"font-size":"1.2em"},"task-type":e.currentTaskType},null,8,["task-type"]),t[18]||(t[18]=l("div",{class:"filler"},null,-1)),s.isActiveTab("tasks")?(r(),C(y,{key:0,class:"flexrow-item",icon:"grid","is-on":a.contactSheetMode,title:e.$t("tasks.show_contact_sheet"),onClick:t[0]||(t[0]=b=>s.toggleContactSheetMode())},null,8,["is-on","title"])):h("",!0),!s.isActiveTab("schedule")&&!s.isActiveTab("estimation")&&s.isSupervisorInDepartment?(r(),o("div",Zs,[_(y,{icon:"import",title:e.$t("main.csv.import_file"),onClick:s.showImportModal},null,8,["title","onClick"])])):h("",!0),l("div",ei,[!s.isActiveTab("schedule")&&!s.isActiveTab("estimation")?(r(),C(y,{key:0,icon:"export",title:e.$t("main.csv.export_file"),onClick:s.onExportClick},null,8,["title","onClick"])):h("",!0)])]),l("div",ti,[l("ul",null,[l("li",{class:V({"is-active":s.isActiveTab("tasks")})},[_(m,{to:s.tasksPath},{default:O(()=>[F(d(e.$t("tasks.tasks")),1)]),_:1},8,["to"])],2),l("li",{class:V({"is-active":s.isActiveTab("schedule")})},[_(m,{to:s.schedulePath},{default:O(()=>[F(d(e.$t("schedule.title")),1)]),_:1},8,["to"])],2),l("li",{class:V({"is-active":s.isActiveTab("estimation")})},[_(m,{to:s.estimationPath},{default:O(()=>[F(d(e.$t("estimation.title")),1)]),_:1},8,["to"])],2)])]),l("div",si,[l("div",ii,[_(c,{ref:"task-search-field","can-save":!0,"focus-options":{preventScroll:!0},onChange:s.onSearchChange,onSave:s.saveSearchQuery,placeholder:"ex: retake chara"},null,8,["onChange","onSave"])]),s.isActiveTab("tasks")?(r(),o("div",ai,[_(E,{class:"flexrow-item selector",label:e.$t("news.task_status"),"task-status-list":s.taskStatusList,"with-margin":!1,modelValue:a.taskStatusIdFilter,"onUpdate:modelValue":t[1]||(t[1]=b=>a.taskStatusIdFilter=b)},null,8,["label","task-status-list","modelValue"]),_(p,{class:"flexrow-item",label:e.$t("tasks.fields.difficulty"),options:a.difficultyOptions,"locale-key-prefix":"tasks.",modelValue:a.difficultyFilter,"onUpdate:modelValue":t[2]||(t[2]=b=>a.difficultyFilter=b)},null,8,["label","options","modelValue"]),_(p,{class:"flexrow-item",label:e.$t("tasks.due_date"),options:a.dueDateOptions,"locale-key-prefix":"tasks.",modelValue:a.dueDateFilter,"onUpdate:modelValue":t[3]||(t[3]=b=>a.dueDateFilter=b)},null,8,["label","options","modelValue"]),_(p,{class:"flexrow-item",label:e.$t("tasks.late"),options:a.estimationOptions,"locale-key-prefix":"tasks.",modelValue:a.estimationFilter,"onUpdate:modelValue":t[4]||(t[4]=b=>a.estimationFilter=b)},null,8,["label","options","modelValue"]),_(p,{class:"flexrow-item",label:e.$t("task_types.fields.priority"),options:a.priorityOptions,"locale-key-prefix":"tasks.",modelValue:a.priorityFilter,"onUpdate:modelValue":t[5]||(t[5]=b=>a.priorityFilter=b)},null,8,["label","options","modelValue"])])):h("",!0),s.isActiveTab("schedule")||s.isActiveTab("tasks")&&a.isScheduleVisible?(r(),o("div",ni,[l("div",ri,[s.isActiveTab("tasks")?(r(),o("label",li,d(e.$t("schedule.title")),1)):h("",!0),_(w,{class:"display-options",options:a.dataDisplayOptions,title:e.$t("tasks.data_display"),modelValue:a.dataDisplay,"onUpdate:modelValue":t[6]||(t[6]=b=>a.dataDisplay=b),onChange:s.onDataDisplayChange},null,8,["options","title","modelValue","onChange"])]),a.dataDisplay.beforeAfterTasks?(r(),o("div",oi,[_(S,{class:"flexrow-item",disabled:s.taskTypeListBeforeFilter.length<2,label:e.$t("tasks.fields.tasks_before"),"task-type-list":s.taskTypeListBeforeFilter,"with-margin":!1,modelValue:a.schedule.taskTypeBefore,"onUpdate:modelValue":t[7]||(t[7]=b=>a.schedule.taskTypeBefore=b),onChange:t[8]||(t[8]=b=>s.resetScheduleItems())},null,8,["disabled","label","task-type-list","modelValue"]),_(S,{class:"flexrow-item",disabled:s.taskTypeListAfterFilter.length<2,label:e.$t("tasks.fields.tasks_after"),"task-type-list":s.taskTypeListAfterFilter,"with-margin":!1,modelValue:a.schedule.taskTypeAfter,"onUpdate:modelValue":t[9]||(t[9]=b=>a.schedule.taskTypeAfter=b),onChange:t[10]||(t[10]=b=>s.resetScheduleItems())},null,8,["disabled","label","task-type-list","modelValue"])])):h("",!0)])):h("",!0),t[19]||(t[19]=l("div",{class:"filler"},null,-1)),s.isActiveTab("tasks")&&!a.contactSheetMode?(r(),C(y,{key:2,active:a.isScheduleVisible,class:"flexrow-item",icon:"calendar","is-medium":"",text:e.$t("schedule.title"),onClick:t[11]||(t[11]=b=>s.toggleSchedule())},null,8,["active","text"])):h("",!0),s.isActiveTab("tasks")?(r(),o("div",di,[_(p,{label:e.$t("main.sorted_by"),options:s.sortOptions,"locale-key-prefix":"tasks.fields.",modelValue:a.currentSort,"onUpdate:modelValue":t[12]||(t[12]=b=>a.currentSort=b)},null,8,["label","options","modelValue"])])):h("",!0),s.isActiveTab("schedule")&&e.isCurrentUserManager?(r(),o("div",ui,[_(u,{class:"flexrow-item","can-delete":!1,"min-date":s.startDisabledDates.to,"max-date":s.startDisabledDates.from,label:e.$t("main.start_date"),utc:"","week-days-disabled":"","with-margin":!1,modelValue:a.schedule.taskTypeStartDate,"onUpdate:modelValue":t[13]||(t[13]=b=>a.schedule.taskTypeStartDate=b)},null,8,["min-date","max-date","label","modelValue"])])):h("",!0),s.isActiveTab("schedule")&&e.isCurrentUserManager?(r(),o("div",ci,[_(u,{class:"flexrow-item","can-delete":!1,"min-date":s.endDisabledDates.to,"max-date":s.endDisabledDates.from,label:e.$t("main.end_date"),utc:"","week-days-disabled":"","with-margin":!1,modelValue:a.schedule.taskTypeEndDate,"onUpdate:modelValue":t[14]||(t[14]=b=>a.schedule.taskTypeEndDate=b)},null,8,["min-date","max-date","label","modelValue"])])):h("",!0),s.isActiveTab("schedule")?(r(),o("div",hi,[_(p,{class:"flexrow-item",label:e.$t("tasks.colors.title"),options:a.schedule.colorOptions,"locale-key-prefix":"tasks.colors.","no-field":"",modelValue:a.schedule.currentColor,"onUpdate:modelValue":t[15]||(t[15]=b=>a.schedule.currentColor=b)},null,8,["label","options","modelValue"])])):h("",!0),s.isActiveTab("schedule")?(r(),o("div",mi,[s.isActiveTab("schedule")?(r(),C(D,{key:0,class:"mt0 nowrap",label:e.$t("schedule.zoom_level"),options:a.schedule.zoomOptions,"no-field":"",modelValue:a.schedule.zoomLevel,"onUpdate:modelValue":t[16]||(t[16]=b=>a.schedule.zoomLevel=b)},null,8,["label","options","modelValue"])):h("",!0)])):h("",!0)])],512),!a.loading.entities&&s.searchQueries.length?(r(),o("div",fi,[_(g,{queries:s.searchQueries,type:"taskType",onRemoveSearch:s.removeSearchQuery},null,8,["queries","onRemoveSearch"])])):h("",!0),s.isActiveTab("tasks")?(r(),C(x,{key:1,ref:"task-list","disabled-dates":s.disabledDates,"entity-type":a.entityType,"is-contact-sheet":a.contactSheetMode,"is-error":a.errors.entities,"is-grouped":a.currentSort==="entity_name","is-loading":a.loading.entities,tasks:a.tasks,"with-schedule":a.isScheduleVisible,onTaskSelected:s.onTaskSelected,onScroll:s.onTaskListScroll},{default:O(()=>[a.isScheduleVisible&&!a.contactSheetMode?(r(),C(B,{key:0,ref:"schedule-widget",class:"task-schedule","start-date":s.productionStartDate,"end-date":s.productionEndDate,"sub-start-date":s.taskTypeStartDate,"sub-end-date":s.taskTypeEndDate,"hide-entities":"","hide-root":"",hierarchy:a.schedule.scheduleItems,"zoom-level":a.schedule.zoomLevel,"is-loading":a.loading.entities,"invert-lines-color":"","is-estimation-linked":"","with-estimations":a.dataDisplay.estimations,"with-ghosts":a.dataDisplay.beforeAfterTasks,"with-statuses":a.dataDisplay.statuses,"with-timesheets":a.dataDisplay.timesheets,onItemChanged:s.saveTaskScheduleItem,onRootElementExpanded:s.expandPersonElement,onEstimationChanged:s.updateEstimation,onScroll:s.onScheduleScroll},null,8,["start-date","end-date","sub-start-date","sub-end-date","hierarchy","zoom-level","is-loading","with-estimations","with-ghosts","with-statuses","with-timesheets","onItemChanged","onRootElementExpanded","onEstimationChanged","onScroll"])):h("",!0)]),_:1},8,["disabled-dates","entity-type","is-contact-sheet","is-error","is-grouped","is-loading","tasks","with-schedule","onTaskSelected","onScroll"])):h("",!0),s.isActiveTab("schedule")?(r(),o("div",pi,[_(B,{ref:"schedule-widget","start-date":s.productionStartDate,"end-date":s.productionEndDate,"sub-start-date":s.taskTypeStartDate,"sub-end-date":s.taskTypeEndDate,hierarchy:a.schedule.scheduleItems,"zoom-level":a.schedule.zoomLevel,"is-loading":a.loading.entities,"is-estimation-linked":!0,"with-estimations":a.dataDisplay.estimations,"with-ghosts":a.dataDisplay.beforeAfterTasks,"with-statuses":a.dataDisplay.statuses,"with-timesheets":a.dataDisplay.timesheets,onItemChanged:s.saveTaskScheduleItem,onRootElementExpanded:s.expandPersonElement,onEstimationChanged:s.updateEstimation},null,8,["start-date","end-date","sub-start-date","sub-end-date","hierarchy","zoom-level","is-loading","with-estimations","with-ghosts","with-statuses","with-timesheets","onItemChanged","onRootElementExpanded","onEstimationChanged"]),a.loading.entities?h("",!0):(r(),C(Q,{key:0,"is-shots":a.entityType==="Shot",tasks:a.tasks},null,8,["is-shots","tasks"]))])):h("",!0),s.isActiveTab("estimation")?(r(),o("div",yi,[_(de,{ref:"estimation-widget","entity-type":a.entityType,tasks:a.tasks,onEstimationChanged:s.updateEstimation},null,8,["entity-type","tasks","onEstimationChanged"])])):h("",!0),_(ue,{active:a.modals.isImportRenderDisplayed,"is-loading":a.loading.importing,"is-error":a.errors.importing,"import-error":a.errors.importingError,"parsed-csv":a.parsedCSV,"form-data":a.importCsvFormData,columns:[...a.dataMatchers,...a.optionalColumns],"data-matchers":a.dataMatchers,database:{},"disable-update":!0,onReupload:s.resetImport,onCancel:s.hideImportRenderModal,onConfirm:s.uploadImportFile},null,8,["active","is-loading","is-error","import-error","parsed-csv","form-data","columns","data-matchers","onReupload","onCancel","onConfirm"]),_(ce,{ref:"import-modal",active:a.modals.importing,"is-loading":a.loading.importing,"is-error":a.errors.importing,"form-data":a.importCsvFormData,columns:a.dataMatchers,"optional-columns":a.optionalColumns,onCancel:s.hideImportModal,onConfirm:s.renderImport},null,8,["active","is-loading","is-error","form-data","columns","optional-columns","onCancel","onConfirm"])],512)]),e.nbSelectedTasks>=1?(r(),o("div",ki,[_(he,{task:e.selectedTasks.values().next().value,"with-actions":""},null,8,["task"])])):h("",!0)])}const Fa=G(Hs,[["render",_i],["__scopeId","data-v-85a93585"]]);export{Fa as default};
//# sourceMappingURL=TaskType-BzlgS1S_.js.map
