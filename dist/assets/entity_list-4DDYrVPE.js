import{a1 as p,D as m,aX as y,aY as f,l as g,x as k,ao as T}from"./index-Dw-uod2x.js";import{s as S}from"./string-B0Tq569e.js";const $={emits:["change-sort","delete-all-tasks","field-changed","keep-task-panel-open","scroll"],created(){this.initHiddenColumns(this.validationColumns,this.hiddenColumns)},mounted(){this.resizeHeaders&&this.resizeHeaders(),window.addEventListener("keydown",this.onKeyDown,!1),window.addEventListener("keyup",this.onKeyUp,!1),this.stickedColumns=k.getObjectPreference(this.localStorageStickKey)||{},this.domEvents&&this.addEvents(this.domEvents)},beforeUnmount(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp),this.domEvents&&(this.removeEvents(this.domEvents),document.body.style.cursor="default")},data(){return{columnSelectorDisplayed:!1}},computed:{visibleMetadataDescriptors(){return this.metadataDescriptors.filter(e=>{const t=this.metadataDisplayHeaders[e.field_name];return t===void 0||t})},nonStickedVisibleMetadataDescriptors(){return this.visibleMetadataDescriptors.filter(e=>!this.stickedColumns[e.id]&&this.metadataDescriptorIsInDepartmentFilter(e))},stickedVisibleMetadataDescriptors(){return this.visibleMetadataDescriptors.filter(e=>this.stickedColumns[e.id]&&this.metadataDescriptorIsInDepartmentFilter(e))},nonStickedDisplayedValidationColumns(){return this.displayedValidationColumns.filter(e=>!this.stickedColumns[e]&&this.validationColumnsIsInDepartmentFilter(e))},stickedDisplayedValidationColumns(){return this.displayedValidationColumns.filter(e=>this.stickedColumns[e]&&this.validationColumnsIsInDepartmentFilter(e))},isEmptyTask(){return!this.isEmptyList&&!this.isLoading&&this.validationColumns&&this.validationColumns.length===0}},methods:{onBodyScroll(e){const t=e.target;this.$emit("scroll",t.scrollTop)},updateOffsets(){this.isLoading||this.$nextTick(()=>{let e=this.$refs["th-episode"]?this.$refs["th-episode"].clientWidth:0;if(this.offsets={},this.isShowInfos)for(let t=0;t<this.stickedVisibleMetadataDescriptors.length;t++)this.offsets[`editor-${t}`]=e,e+=this.$refs[`editor-${t}`][0].$el.clientWidth;for(let t=0;t<this.stickedDisplayedValidationColumns.length;t++)this.offsets[`validation-${t}`]=e,e+=this.$refs[`validation-${t}`][0].$el.clientWidth})},onInputKeyUp(e,t,s){const i=this.visibleMetadataDescriptors.length+4,n=this.displayedEpisodesLength;return this.keyMetadataNavigation(i,n,t,s,e.key),this.pauseEvent(e)},getBackground(e){return T.hexToRGBa(e,.08)},buildHideKey(e){return`column-${this.currentProduction.id}-${e}`},initHiddenColumns(e,t){e&&t&&e.forEach(s=>{const i=this.buildHideKey(s);t[s]=localStorage.getItem(i)==="true"})},hideColumn(e){const t=this.buildHideKey(e);let s=!0;return localStorage.getItem(t)==="true"&&(s=!1),localStorage.setItem(t,s),this.hiddenColumns[e]=s,s},setScrollPosition(e){this.$refs.body&&(this.$refs.body.scrollTop=e)},setScrollLeftPosition(e){this.$refs.body&&(this.$refs.body.scrollLeft=e)},getValidationStyle(e){const t=this.taskTypeMap.get(e);return t?{"border-left":`1px solid ${t.color}`,background:this.getBackground(t.color)}:{}},onTaskSelected(e,t){const s=this.stickedDisplayedValidationColumns.length,i=[];if(t||(e={...e},e.y+=s),this.$emit("keep-task-panel-open",!0),e.isShiftKey){if(this.lastSelection){let n=this.lastSelection.x,a=e.x,l=this.lastSelection.y;t||(l+=s);let r=e.y;const d=this[`${this.type}SelectionGrid`];e.x<this.lastSelection.x&&(n=e.x,a=this.lastSelection.x),e.y<this.lastSelection.y&&(l=e.y,r=this.lastSelection.y,t||(r+=s));for(let h=n;h<=a;h++)for(let c=l;c<=r;c++){const o=this.$refs[`validation-${h}-${c}`]?.[0],C=d?.[h]?.[c];if(o?.selectable&&!C){let u=o.columnY;t||(u+=s),i.push({entity:o.entity,column:o.column,task:o.task,x:o.rowX,y:u})}}this.$store.commit("ADD_SELECTED_TASK",e),this.updateTaskInQuery()}}else e.isCtrlKey||(this.$store.commit("CLEAR_SELECTED_TASKS"),this.updateTaskInQuery());if(i.length===0?(this.$store.commit("ADD_SELECTED_TASK",e),this.updateTaskInQuery()):(this.$store.commit("ADD_SELECTED_TASKS",i),this.updateTaskInQuery()),!e.isShiftKey&&e.isUserClick){const n=e.x;let a=e.y;t||(a-=s),this.lastSelection={x:n,y:a};const l=`validation-${n}-${a}`,r=this.$refs[l][0];this.$nextTick(()=>{this.scrollToValidationCell(r)})}this.$nextTick(()=>{this.$emit("keep-task-panel-open",!1)})},onTaskUnselected(e,t){t||(e={...e},e.y+=this.stickedDisplayedValidationColumns.length),e.isCtrlKey?this.$store.commit("REMOVE_SELECTED_TASK",e):this.nbSelectedTasks===1?this.$store.commit("REMOVE_SELECTED_TASK",e):(this.$store.commit("CLEAR_SELECTED_TASKS"),this.$store.commit("ADD_SELECTED_TASK",e)),this.updateTaskInQuery()},showHeaderMenu(e,t,s){const i=this.$refs.headerMenu.$el;if(i.className==="header-menu")i.className="header-menu hidden";else{i.className="header-menu";let n=s.srcElement.parentNode.parentNode;n.tagName!=="TH"&&(n=n.parentNode);const a=n.getBoundingClientRect(),l=a.left,r=a.bottom,d=Math.max(100,a.width-1);i.style.left=`${l}px`,i.style.top=`${r}px`,i.style.width=`${d}px`}this.lastHeaderMenuDisplayed=e,this.lastHeaderMenuDisplayedIndexInGrid=t},onMinimizeColumnToggled(){this.hideColumn(this.lastHeaderMenuDisplayed),this.showHeaderMenu()},onDeleteAllTasksClicked(){this.$emit("delete-all-tasks",this.lastHeaderMenuDisplayed),this.showHeaderMenu()},onSortByTaskTypeClicked(){const e=this.lastHeaderMenuDisplayed;this.$emit("change-sort",{type:"status",column:e,name:this.taskTypeMap.get(e).name}),this.showHeaderMenu()},onSelectColumn(e){const t=this.lastHeaderMenuDisplayed,s=[];let i;switch(e){case"asset":i=g.cache.result;break;case"edit":i=p.cache.result;break;case"episode":i=m.cache.result;break;case"sequence":i=y.cache.result;break;case"shot":i=f.cache.result;break;default:throw new Error(`Invalid entity type: ${e}`)}i.forEach((n,a)=>{s.push({entity:n,column:this.taskTypeMap.get(t),task:this.taskMap.get(n.validations.get(t)),x:a,y:this.lastHeaderMenuDisplayedIndexInGrid})}),this.$store.commit("CLEAR_SELECTED_TASKS"),this.$nextTick(()=>{this.$store.commit("ADD_SELECTED_TASKS",s),this.updateTaskInQuery(),this.showHeaderMenu()})},getEntityLineNumber(e,t,s){this.$options.lineIndex={};const i=`${t}-${s}`,n=this.$options.lineIndex[i];if(n)return n;{let a=0,l=0;for(;a<s;)l+=e[a].length,a++;const r=t+l;return this.$options.lineIndex[i]=r,r}},getGroupKey(e,t,s){const i=e[0]?e[0][s]+e[0].canceled:"";return`${t}-${i}`},onDescriptionChanged(e,t){this.$emit("field-changed",{entry:e,fieldName:"description",value:t})},onNumberFieldKeyDown(e){["ArrowDown","ArrowUp"].includes(e.key)&&this.pauseEvent(e)},toggleColumnSelector(){this.columnSelectorDisplayed=!this.columnSelectorDisplayed},metadataDescriptorIsInDepartmentFilter(e){return this.departmentFilter.length===0||e.departments.length===0||this.departmentFilter.some(t=>e.departments.includes(t))},validationColumnsIsInDepartmentFilter(e){return this.departmentFilter.length===0||this.taskTypeMap.get(e)?.department_id===null||this.departmentFilter.includes(this.taskTypeMap.get(e).department_id)},isMetadataColumnEditAllowed(e){if(typeof e=="string"){if(this.isCurrentUserManager)return!0;if(this.isCurrentUserSupervisor){if(this.user.departments.length===0)return!0;{const t=this.visibleMetadataDescriptors.find(s=>s.id===e);if(t.departments.length===this.user.departments.length)return this.user.departments.every(s=>t.departments.includes(s))}}}return!1},isValidResolution(e){if(!e)return!0;const t=this.getMetadataFieldValue({field_name:"resolution"},e);return!t||t.length===0?!0:new RegExp(/\d{3,4}x\d{3,4}/).test(t)},toggleStickedColumns(e){const t=!this.stickedColumns[e];this.stickedColumns={...this.stickedColumns,[e]:t},k.setObjectPreference(this.localStorageStickKey,this.stickedColumns)},stickColumnClicked(){this.toggleStickedColumns(this.lastHeaderMenuDisplayed),this.showHeaderMenu()},metadataStickColumnClicked(e){this.toggleStickedColumns(this.lastMetadaDataHeaderMenuDisplayed),this.showMetadataHeaderMenu(this.lastMetadaDataHeaderMenuDisplayed,e)},updateTaskInQuery(){if(this.nbSelectedTasks===1){const t=Array.from(this.selectedTasks.keys())[0];this.$router.push({query:{...this.$route.query,task_id:t}})}else this.$router.push({query:{...this.$route.query,task_id:void 0}})},getEntityMap(){return{asset:g.cache.assetMap,shot:f.cache.shotMap,sequence:y.cache.sequenceMap,episode:m.cache.episodeMap,edit:p.cache.editMap}[this.type]},selectTaskFromQuery(){const e=this.$route.query.task_id,t=this.taskMap.get(e);if(t){const i=this.getEntityMap().get(t.entity_id);if(i){const n=this.taskTypeMap.get(t.task_type_id);let a=this[`displayed${S.capitalize(this.type)}s`];["asset","shot"].includes(this.type)&&(a=a.flat());const l=a.findIndex(d=>d.id===i.id),r=this.displayedValidationColumns.indexOf(t.task_type_id);this.$store.commit("ADD_SELECTED_TASK",{task:t,entity:i,column:n,x:l,y:r})}}},startBrowsing(e){e.target.tagName!=="INPUT"&&(document.body.style.cursor="grabbing",this.isBrowsingX=!0,this.isBrowsingY=!0,this.initialClientX=this.getClientX(e),this.initialClientY=this.getClientY(e))},startBrowsingX(e){document.body.style.cursor="grabbing",this.isBrowsingX=!0,this.initialClientX=this.getClientX(e)},startBrowsingY(e){document.body.style.cursor="grabbing",this.isBrowsingY=!0,this.initialClientY=this.getClientY(e)},stopBrowsing(e){document.body.style.cursor="default",this.isBrowsingX=!1,this.isBrowsingY=!1,this.initialClientX=null,this.initialClientY=null},onMouseMove(e){this.isBrowsingX&&this.scrollTableLeft(e),this.isBrowsingY&&this.scrollTableTop(e)},scrollTableLeft(e){const t=this.$refs.body,s=t.scrollLeft,i=e.movementX||this.getClientX(e)-this.initialClientX,n=s-i;this.initialClientX=this.getClientX(e),t.scrollLeft=n},scrollTableTop(e){const t=this.$refs.body,s=t.scrollTop,i=e.movementY||this.getClientY(e)-this.initialClientY,n=s-i;this.initialClientY=this.getClientY(e),t.scrollTop=n}},watch:{nbSelectedTasks(){this.updateTaskInQuery()},"displaySettings.bigThumbnails"(){this.updateOffsets()}}};export{$ as e};
//# sourceMappingURL=entity_list-4DDYrVPE.js.map
