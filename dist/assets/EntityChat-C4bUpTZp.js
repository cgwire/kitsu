import{q as E,aF as j,cx as L,bR as D,m as B,z as v,cy as T,bF as N,cz as S,cA as Y,aD as b,_ as z,r as h,o as n,c as i,F as g,g as _,e as l,t as y,f as m,d as C,cB as P,cC as H,B as V,x as X,K as F,b as K,k as G,l as x,n as O,aZ as q,bj as R,a9 as U,a3 as I}from"./index-a83mlrHR.js";const Z={name:"entity-chat-days",mixins:[E],components:{PeopleAvatar:j,PreviewModal:L,XIcon:D},emits:["delete-message"],data(){return{currentAttachment:null}},props:{messages:{type:Array,default:()=>[]}},computed:{...B(["departmentMap","personMap","user"]),messageList(){const e=[...this.messages].sort((s,a)=>v(s.created_at).isAfter(v(a.created_at))),t=[];let r={data:null},p=null;return e.forEach(s=>{const a=v(s.created_at).tz(this.user.timezone);if(p&&a.format("YYYY-MM-DD")===p.date)if(r&&r.data&&s.person_id===r.data.person_id&&v(s.created_at).diff(r.data.created_at,"m")<5)r.texts.push(s);else{const d={data:s,texts:[s||""]};r=d,p.messages.push(d)}else{const d={data:s,texts:[s||""]};p={title:a.format("LL"),date:a.format("YYYY-MM-DD"),messages:[d]},r=d,t.push(p)}}),t.reverse()}},methods:{renderComment:T,renderDate(e){return e=v(N(e)).tz(this.user.timezone),e.tz(this.user.timezone).format("HH:mm")},getAttachmentThumbnailPath:S,getDownloadAttachmentPath:Y,pictureAttachments(e){return e?e.filter(t=>b.IMG_EXTENSIONS.includes(t.extension)).sort((t,r)=>t.name.localeCompare(r.name,void 0,{numeric:!0})):[]},fileAttachments(e){return e?e.filter(t=>!b.IMG_EXTENSIONS.includes(t.extension)).sort((t,r)=>t.name.localeCompare(r.name,void 0,{numeric:!0})):[]},scrollToBottom(){this.$refs.messages.scrollTop=this.$refs.messages.offsetHeight}}},J={class:"messages",ref:"messages"},Q={class:"day-title"},W={class:"message-content"},$={class:"message-header-wrapper flexrow"},ee={class:"message-sender mr05"},te={class:"message-date"},se=["innerHTML"],ae={key:0,class:"attachments"},ne=["src","onClick"],ie=["href"],re=["onClick"];function oe(e,t,r,p,s,a){const d=h("people-avatar"),k=h("x-icon"),A=h("preview-modal");return n(),i("div",J,[(n(!0),i(g,null,_(a.messageList,M=>(n(),i("div",{class:"day-messages",key:M.title},[l("div",Q,[l("span",null,y(M.title),1)]),(n(!0),i(g,null,_(M.messages,u=>(n(),i("div",{class:"message",key:u.id},[m(d,{class:"message-avatar flexrow-item",person:e.personMap.get(u.data.person_id),size:30,"font-size":15},null,8,["person"]),l("div",W,[l("div",$,[l("div",ee,y(e.personMap.get(u.data.person_id).name),1),l("div",te,y(a.renderDate(u.data.created_at)),1)]),(n(!0),i(g,null,_(u.texts,f=>(n(),i("div",{class:"message-text",key:"submessage-"+f.id},[l("div",{innerHTML:a.renderComment(f?f.text:"",[],[],e.personMap,e.departmentMap,"")},null,8,se),f?(n(),i("div",ae,[(n(!0),i(g,null,_(a.pictureAttachments(f.attachment_files),c=>(n(),i("img",{class:"attachment-thumbnail",key:c.id,src:a.getAttachmentThumbnailPath(c),onClick:w=>s.currentAttachment=c},null,8,ne))),128)),(n(!0),i(g,null,_(a.fileAttachments(f.attachment_files),c=>(n(),i("a",{class:"attachment",target:"_blank",key:c.id,href:a.getDownloadAttachmentPath(c)},y(c.name),9,ie))),128))])):C("",!0),u.data.person_id===e.user.id?(n(),i("div",{key:1,class:"delete-message-button",onClick:c=>e.$emit("delete-message",u.data.id)},[m(k,{size:12})],8,re)):C("",!0)]))),128))])]))),128))]))),128)),m(A,{active:s.currentAttachment!=null,attachment:s.currentAttachment,onCancel:t[0]||(t[0]=M=>s.currentAttachment=null)},null,8,["active","attachment"])],512)}const le=z(Z,[["render",oe],["__scopeId","data-v-bfad8a88"]]),de={name:"entity-chat",mixins:[E],components:{AddAttachmentModal:P,ConfirmModal:H,ButtonSimple:V,EntityChatDays:le,PeopleAvatar:j,Spinner:X,XIcon:D},data(){return{attachments:[],chat:{},errors:{addAttachment:!1,chat:!1,deleteMessage:!1,join:!1,leave:!1,send:!1},loading:{addAttachment:!1,chat:!1,deleteMessage:!1,join:!1,leave:!1,send:!1},modals:{addAttachment:!1,deleteMessage:!1},participants:[],currentMessage:"",messages:[],messageMap:new Map}},props:{entity:{type:Object,default:()=>{}},name:{type:String,default:""}},mounted(){this.entity&&this.reset()},computed:{...B(["mainConfig","personMap","user"]),isInChat(){return this.participants.includes(this.user.id)},participantList(){return F(this.participants.map(e=>this.personMap.get(e)))}},methods:{...K(["deleteChatMessage","getChatMessage","getEntityChat","getEntityChatMessages","joinEntityChat","leaveEntityChat","sendChatMessage"]),async reset(){this.loading.chat=!0,this.errors.chat=!1;try{this.chat=await this.getEntityChat(this.entity.id),this.messages=await this.getEntityChatMessages(this.entity.id),this.messages.forEach(e=>this.messageMap.set(e.id,e)),this.participants=this.chat.participants||[]}catch(e){this.errors.chat=!0,console.error(e)}finally{this.loading.chat=!1}},async joinChat(){this.loading.join=!0,this.errors.join=!1;try{await this.joinEntityChat(this.entity.id)}catch(e){this.errors.join=!0,console.error(e)}finally{this.loading.join=!1}},async leaveChat(){this.loading.leave=!0,this.errors.leave=!1;try{await this.leaveEntityChat(this.entity.id)}catch(e){this.errors.leave=!0,console.error(e)}finally{this.loading.leave=!1}},async sendMessage(e){if(e&&e.keyCode===13&&e.shiftKey){this.currentMessage+=`
`;return}this.errors.send=!1,this.loading.send=!0;try{const t=await this.sendChatMessage({entityId:this.entity.id,message:this.currentMessage,attachments:this.attachments});this.currentMessage="",this.attachments=[],this.messages.push(t),this.messageMap.set(t.id,t),this.$refs.messages.scrollToBottom(),this.$nextTick(()=>{this.$refs.messageBox.focus()})}catch(t){this.errors.send=!0,console.error(t)}finally{this.loading.send=!1}},showConfirmDeleteMessage(e){this.modals.deleteMessage=!0,this.errors.deleteMessage=!1,this.loading.deleteMessage=!1,this.messageToDeleteId=e},async deleteMessage(){const e=this.messageToDeleteId;this.errors.deleteMessage=!1;try{this.loading.deleteMessage=!0,this.messages=this.messages.filter(t=>t.id!==e),this.messageMap.delete(e),await this.deleteChatMessage({entityId:this.entity.id,messageId:e}),this.modals.deleteMessage=!1,this.messageToDeleteId=null}catch(t){this.errors.deleteMessage=!0,console.error(t)}finally{this.loading.deleteMessage=!1}},focusMessageBox(){const e=this.$refs.messageBox;e&&e.focus()},addAttachment(e){this.attachments=this.attachments.concat(e),this.closeAttachmentModal()},closeAttachmentModal(){this.modals.addAttachment=!1},removeAttachment(e){this.attachments=this.attachments.filter(t=>t!==e)}},socket:{events:{"chat:joined"(e){e.chat_id===this.chat.id&&!this.participants.includes(e.person_id)&&this.participants.push(e.person_id)},"chat:left"(e){e.chat_id===this.chat.id&&this.participants.includes(e.person_id)&&(this.participants=this.participants.filter(t=>t!==e.person_id))},async"chat:new-message"(e){if(e.chat_id===this.chat.id){const t=await this.getChatMessage({entityId:this.entity.id,messageId:e.chat_message_id});this.messageMap.has(e.chat_message_id)||(this.messageMap.set(t.id,t),this.messages.push(t),this.focusMessageBox())}},"chat:deleted-message"(e){e.chat_id===this.chat.id&&(this.messages=this.messages.filter(t=>t.id!==e.message_id))}}},watch:{entity(){this.entity&&this.reset()}}},ce={class:"mt1 entity-chat"},he={key:0,class:"has-text-centered"},me={class:"participants flexrow"},ue={key:0,class:"has-text-centered filler"},ge={key:2,class:"join-chat"},fe=["is-loading"],pe={key:3,class:"message-box"},_e=["disabled"],ye={class:"buttons"},Me={key:0,class:"attachments"},ve=["onClick"];function Ce(e,t,r,p,s,a){const d=h("button-simple"),k=h("people-avatar"),A=h("spinner"),M=h("entity-chat-days"),u=h("x-icon"),f=h("add-attachment-modal"),c=h("confirm-modal"),w=G("focus");return n(),i("div",ce,[r.entity?(n(),i(g,{key:1},[l("div",me,[(n(!0),i(g,null,_(a.participantList,o=>(n(),x(k,{class:"flexrow-item",key:o.id,person:o,size:20,"font-size":10},null,8,["person"]))),128)),t[6]||(t[6]=l("span",{class:"filler"},null,-1)),a.isInChat?(n(),x(d,{key:0,class:"flexrow-item",text:e.$t("chats.leave"),"is-loading":s.loading.leave,onClick:a.leaveChat},null,8,["text","is-loading","onClick"])):C("",!0)]),s.loading.chat?(n(),i("div",ue,[m(A,{class:"mt1"})])):(n(),x(M,{key:1,ref:"messages",messages:s.messages,onDeleteMessage:a.showConfirmDeleteMessage},null,8,["messages","onDeleteMessage"])),a.isInChat?(n(),i("div",pe,[l("div",null,[O((n(),i("textarea",{id:"message-box",ref:"messageBox",disabled:s.loading.send,onKeydown:t[2]||(t[2]=R(U((...o)=>a.sendMessage&&a.sendMessage(...o),["prevent"]),["enter"])),"onUpdate:modelValue":t[3]||(t[3]=o=>s.currentMessage=o)},t[7]||(t[7]=[I("          ")]),40,_e)),[[w],[q,s.currentMessage]]),l("div",ye,[m(d,{class:"attach-button",icon:"attach",onClick:t[4]||(t[4]=o=>s.modals.addAttachment=!0)}),t[8]||(t[8]=l("div",{class:"filler"},null,-1)),m(d,{class:"send-button",icon:"send","is-loading":s.loading.send,onClick:a.sendMessage},null,8,["is-loading","onClick"])])]),s.attachments.length>0?(n(),i("div",Me,[(n(!0),i(g,null,_(s.attachments,o=>(n(),i("div",{class:"attachment-name",key:o.name},[I(y(o.get("file").name)+" ",1),l("span",{onClick:ke=>a.removeAttachment(o)},[m(u,{size:8})],8,ve)]))),128))])):C("",!0)])):(n(),i("div",ge,[l("button",{class:"button","is-loading":s.loading.join,onClick:t[1]||(t[1]=(...o)=>a.joinChat&&a.joinChat(...o))},y(e.$t("chats.join")),9,fe)]))],64)):(n(),i(g,{key:0},[l("p",null,y(e.$t("chats.no_chat")),1),e.mainConfig.indexer_configured?(n(),i("div",he,[m(d,{text:e.$t("chats.search_entity"),onClick:t[0]||(t[0]=o=>e.$router.push("entity-search"))},null,8,["text"])])):C("",!0)],64)),m(f,{ref:"add-attachment-modal",active:s.modals.addAttachment,"is-loading":s.loading.addAttachment,"is-error":s.errors.addAttachment,title:r.name,onCancel:a.closeAttachmentModal,onConfirm:a.addAttachment},null,8,["active","is-loading","is-error","title","onCancel","onConfirm"]),m(c,{active:s.modals.deleteMessage,"confirm-button-text":e.$t("chats.delete_message_confirm"),text:e.$t("chats.delete_message"),"is-loading":s.loading.deleteMessage,"is-error":s.errors.deleteMessage,onCancel:t[5]||(t[5]=o=>s.modals.deleteMessage=!1),onConfirm:a.deleteMessage},null,8,["active","confirm-button-text","text","is-loading","is-error","onConfirm"])])}const xe=z(de,[["render",Ce],["__scopeId","data-v-35fce976"]]);export{xe as E};
//# sourceMappingURL=EntityChat-C4bUpTZp.js.map
