import{cm as ae,cn as le,co as j,aR as N,aF as A,p as K,cp as oe,k as w,o as u,w as de,e as c,f as m,aj as z,d as S,b as X,ad as $,ag as re,ae as ue,aK as ce,_ as he,m as me,a as pe,bW as fe,ch as ge,u as ye,R as _e,aH as De,aG as ve,ap as Se,al as ke,cq as be,L as Ve,$ as Te,a0 as Ee,aJ as we,bb as Me,B as Pe,r as v,c as f,t as V,F as I,g as C,G as R,a8 as Ie,bN as _,cr as U,bU as O,cs as xe,A as x,bV as L,a4 as Ye,ct as Q,cu as Ce,N as Ae,cv as Oe,c2 as G,cw as Be,a3 as H,aL as J,cx as Ue}from"./index-BsDo8rDw.js";import{G as Le}from"./grip-vertical-DIC0iJov.js";/**
 * @license lucide-vue-next v0.552.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=ae("list-restart",[["path",{d:"M21 5H3",key:"1fi0y6"}],["path",{d:"M7 12H3",key:"13ou7f"}],["path",{d:"M7 19H3",key:"wbqt3n"}],["path",{d:"M12 18a5 5 0 0 0 9-3 4.5 4.5 0 0 0-4.5-4.5c-1.33 0-2.54.54-3.41 1.41L11 14",key:"qth677"}],["path",{d:"M11 10v4h4",key:"172dkj"}]]),Fe={__name:"EditScheduleVersionModal",props:{isError:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},scheduleVersionToEdit:{type:Object,required:!0},version:{type:String,required:!0},versionOptions:{type:Array,required:!0}},emits:["cancel","confirm"],setup(e,{emit:t}){const i=e,o=t,{t:s}=le(),n=j({id:null,name:"",locked:"false",version:i.version||""}),r=j({name:!1}),b=N(null),M=N(null),y=A(()=>!!i.scheduleVersionToEdit?.id),D=A(()=>!!n.name&&!r.name),k=A(()=>y.value?s("schedule.edit_version"):s("schedule.create_version")),P=A(()=>[{label:s("schedule.fields.new"),value:"new",separator:!0},{label:`${s("schedule.versions.from")} ${s("schedule.versions.reference")}`,value:"ref",separator:!0},...i.versionOptions.filter(d=>!d.canceled).sort(K.firstBy("created_at")).map(d=>({label:`${s("schedule.versions.from")} ${d.name}`,value:d.id}))]);function T(d){if(r.name=!1,!d||i.scheduleVersionToEdit.name===d)return;i.versionOptions.map(h=>h.name).includes(d)&&(r.name=!0)}function l(){if(!D.value)return;const d={id:i.scheduleVersionToEdit.id??null,name:n.name,locked:n.locked==="true",version:n.version};o("confirm",d)}return oe(()=>{n.id=i.scheduleVersionToEdit.id||null,n.name=i.scheduleVersionToEdit.name||"",n.locked=i.scheduleVersionToEdit.locked?"true":"false",n.version=i.version||"new",y.value?M.value?.focus():b.value?.focus()}),(d,p)=>(u(),w(ce,{active:"",title:k.value,onCancel:p[5]||(p[5]=h=>d.$emit("cancel"))},{default:de(()=>[c("form",{onSubmit:p[3]||(p[3]=z(()=>{},["prevent"]))},[y.value?S("",!0):(u(),w(X,{key:0,ref_key:"versionCombobox",ref:b,label:d.$t("schedule.fields.create_from_version"),options:P.value,modelValue:n.version,"onUpdate:modelValue":p[0]||(p[0]=h=>n.version=h)},null,8,["label","options","modelValue"])),m($,{ref_key:"nameField",ref:M,label:d.$t("schedule.fields.name"),"error-text":d.$t("schedule.edit_version_exist"),errored:r.name,maxlength:20,onEnter:l,"onUpdate:modelValue":[T,p[1]||(p[1]=h=>n.name=h)],modelValue:n.name,modelModifiers:{trim:!0}},null,8,["label","error-text","errored","modelValue"]),y.value?(u(),w(re,{key:1,label:d.$t("schedule.fields.locked"),modelValue:n.locked,"onUpdate:modelValue":p[2]||(p[2]=h=>n.locked=h)},null,8,["label","modelValue"])):S("",!0)],32),m(ue,{"error-text":d.$t("schedule.edit_version_error"),"is-error":e.isError,"is-loading":e.isLoading,"is-disabled":!D.value,onConfirm:l,onCancel:p[4]||(p[4]=h=>d.$emit("cancel"))},null,8,["error-text","is-error","is-loading","is-disabled"])]),_:1},8,["title"]))}},W="prev",B="ref",Z=1,qe={name:"production-schedule",components:{ButtonSimple:Pe,Checkbox:Me,ChevronDownIcon:we,ChevronRightIcon:Ee,Combobox:X,ComboboxNumber:Te,ComboboxTaskType:Ve,ConfirmModal:be,DateField:ke,EditScheduleVersionModal:Fe,GripVerticalIcon:Le,HardDeleteModal:Se,ListRestartIcon:ze,PeopleAvatar:ve,PeopleName:De,Schedule:_e,Spinner:ye,TrashIcon:ge,TextField:$,XIcon:fe},data(){return{assignments:{assigned:!1,entityTypes:null,excludes:[],forcedDailyQuota:null,loading:!1,saving:!1,startDate:null,endDate:null,task:{},type:null,unassign:!1},availableTaskTypes:[],daysOffByPerson:{},draggedEntities:[],endDate:x().add(6,"months").endOf("day"),isSidePanelOpen:!1,scheduleItems:[],startDate:x().startOf("day"),selectedStartDate:null,selectedEndDate:null,selectedTaskType:null,zoomLevel:Z,zoomOptions:[{label:this.$t("main.week"),value:0},{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}],mode:W,modeOptions:[{label:this.$t("schedule.mode_prev"),value:"prev"},{label:this.$t("schedule.mode_real"),value:"real"}],scheduleVersionToEdit:{},version:B,loading:{schedule:!1,editScheduleVersion:!1,applyScheduleVersion:!1},errors:{schedule:!1,editScheduleVersion:!1,deleteScheduleVersion:!1,applyScheduleVersion:!1},modals:{editScheduleVersion:!1,deleteScheduleVersion:!1,applyScheduleVersion:!1}}},mounted(){this.reset()},computed:{...pe(["currentEpisode","currentProduction","isCurrentUserManager","isCurrentUserSupervisor","isTVShow","organisation","personMap","productionAssetTypes","scheduleVersions","user"]),estimatedDailyQuota(){const e=J(this.assignments.startDate),t=J(this.assignments.endDate),i=Ue(e,t),o=this.draggedEntities.reduce((n,r)=>n+(r.children?.length??0),0),s=this.availablePersons.length;return i&&s?o/i/s:0},assetMap(){return H.cache.assetMap},assets(){return H.cache.assets},assetTypeMap(){return Be.cache.assetTypeMap},availablePersons(){const e=this.taskTypeMap.get(this.selectedTaskType.task_type_id);return this.team.filter(t=>!this.assignments.excludes.includes(t.id)&&t.role!=="client"&&(["admin","manager"].includes(t.role)||!t.departments.length||t.departments.includes(e?.department_id)))},currentVersion(){return this.scheduleVersions.find(e=>e.id===this.version)},hasDraggedEntities(){return this.draggedEntities.some(e=>e.children.length)},isLockedSchedule(){return this.mode==="real"||this.currentVersion?.locked||!this.isCurrentUserManager},shotMap(){return G.cache.shotMap},shots(){return G.cache.shots},taskTypeMap(){return Oe.cache.taskTypeMap},team(){return Ae(this.currentProduction.team.map(e=>this.personMap.get(e)).filter(e=>e&&!e.is_bot))},isVersioned(){return this.mode==="prev"&&this.version!=="ref"},versionOptions(){const e=this.scheduleVersions.filter(o=>!o.canceled).sort(K.firstBy("created_at")).map(o=>({label:o.locked?`${o.name} (${this.$t("schedule.versions.locked")})`:o.name,value:o.id})),t=this.scheduleVersions.find(o=>o.id===this.currentProduction.from_schedule_version_id);return[{label:t?`${this.$t("schedule.versions.reference")} (${this.$t("schedule.versions.from")} ${t.name})`:this.$t("schedule.versions.reference"),value:B,separator:!0},...e]}},methods:{...me(["applyScheduleVersionToProduction","assignSelectedTasks","createScheduleVersion","createScheduleVersionedTask","deleteScheduleVersion","editProduction","loadAssets","loadAssetTypeScheduleItems","loadEpisodeScheduleItems","loadProductionDaysOff","loadScheduleItems","loadScheduleVersions","loadSequenceScheduleItems","loadShots","loadTasks","loadTasksFromScheduleVersion","saveScheduleItem","unassignPersonFromTask","unassignSelectedTasks","updateScheduleVersion","updateScheduleVersionedTask","updateTask"]),updateRoute({mode:e,version:t,zoom:i}){const o={...this.$route.query};e!==void 0&&(o.mode=e||void 0),t!==void 0&&(o.version=t||void 0),i!==void 0&&(o.zoom=String(i)),JSON.stringify(o)!==JSON.stringify(this.$route.query)&&this.$router.push({query:o})},async loadData(){return this.loading.schedule=!0,this.availableTaskTypes=[],await this.loadScheduleVersions(this.currentProduction),this.loadScheduleItems(this.currentProduction).then(e=>{const t=_(this.selectedStartDate),i=_(this.selectedEndDate);e=e.map(o=>{const s=this.taskTypeMap.get(o.task_type_id);let n,r;o.start_date?n=_(o.start_date):n=x(),n.isSameOrAfter(i)&&(n=i.clone().add(-1,"days")),n.isBefore(t)&&(n=t.clone()),o.end_date?r=_(o.end_date):r=n.clone().add(1,"days"),r.isSameOrAfter(i)&&(r=i.clone());const b=Q(s.id,this.currentProduction.id,this.currentEpisode?this.currentEpisode.id:null,s.for_entity);return{...o,color:s.color,for_entity:s.for_entity,name:`${s.for_entity} / ${s.name}`,priority:s.priority,startDate:n,endDate:r,editable:this.isInDepartment(s)&&!this.isLockedSchedule,expanded:!1,loading:!1,route:s.for_entity==="Shot"&&this.isTVShow?null:b,children:[]}}),this.scheduleItems=Ce(e,this.currentProduction,this.taskTypeMap),this.availableTaskTypes=this.scheduleItems.map(o=>({...this.taskTypeMap.get(o.task_type_id),name:o.name})),this.loading.schedule=!1}).catch(e=>{console.error(e),this.loading.schedule=!1})},async reset(){this.closeSidePanel(),this.currentProduction.start_date&&(this.startDate=_(this.currentProduction.start_date)),this.currentProduction.end_date&&(this.endDate=_(this.currentProduction.end_date)),this.selectedStartDate=this.startDate.toDate(),this.selectedEndDate=this.endDate.toDate(),await this.loadData();const e=this.$route.query.mode,t=this.$route.query.version,i=Number(this.$route.query.zoom);this.mode=this.modeOptions.map(o=>o.value).includes(e)?e:W,this.version=this.versionOptions.map(o=>o.value).includes(t)?t:B,this.zoomLevel=this.zoomOptions.map(o=>o.value).includes(i)?i:Z},convertScheduleItems(e,t){return t.map(i=>{let o;i.start_date?o=_(i.start_date):o=x(),o.isBefore(this.startDate)&&(o=this.startDate.clone()),o.isAfter(this.endDate)&&(o=this.endDate.clone());let s;i.end_date?s=_(i.end_date):s=o.clone().add(1,"days"),s.isBefore(o)&&(s=o.clone().add(1,"days")),s.isAfter(this.endDate)&&(s=this.endDate.clone());const n={...i,startDate:o,endDate:s,expanded:!1,loading:!1,editable:this.isInDepartment(this.taskTypeMap.get(i.task_type_id))&&!this.isLockedSchedule,children:[],parentElement:e};return this.isTVShow&&(n.route=Q(i.task_type_id,this.currentProduction.id,i.object_id,e.for_entity)),n})},async expandTaskTypeElement(e,t=null,i=!1,o=!0){if(e.expanded=i||!e.expanded,e.expanded){try{e.loading=!0,this.selectedTaskType=this.isTVShow?null:e,this.assignments.loading=o,e.children=[],e.people={},e.entitiesByType={};const s=this.isTVShow?["Asset","Shot"].includes(e.for_entity)?this.loadEpisodeScheduleItems:this.loadSequenceScheduleItems:e.for_entity==="Shot"?this.loadSequenceScheduleItems:this.loadAssetTypeScheduleItems,n={production:this.currentProduction,taskType:this.taskTypeMap.get(e.task_type_id)},r=await s(n);let b=this.convertScheduleItems(e,r);const M=new Map(b.map(y=>[y.object_id,y]));if(this.isTVShow)e.children=b;else{e.for_entity==="Asset"&&await this.loadAssets({withShared:!1,withTasks:!1}),e.for_entity==="Shot"&&await this.loadShots();let y=await this.loadTasks({project_id:this.currentProduction.id,task_type_id:e.task_type_id,relations:"true"});if(this.isVersioned){const l=this.taskTypeMap.get(e.task_type_id),d=await this.loadTasksFromScheduleVersion({version:{id:this.version},taskType:l}),p=new Map(d.map(h=>[h.task_id,h]));y=y.map(h=>{const g=p.get(h.id);return g?.start_date?{...h,versionedTaskId:g.id,start_date:g.start_date,due_date:g.due_date,estimation:g.estimation,assignees:g.assignees}:null}).filter(Boolean)}this.daysOffByPerson=await this.loadProductionDaysOff({startDate:this.startDate.format("YYYY-MM-DD"),endDate:this.endDate.format("YYYY-MM-DD")}).catch(()=>({}));const D={},k={};y.forEach(l=>{l.start_date&&(e.for_entity==="Asset"?(l.entity=this.assetMap.get(l.entity_id),l.entity_type_id=l.entity.asset_type_id):e.for_entity==="Shot"?(l.entity=this.shotMap.get(l.entity_id),l.entity_type_id=l.entity.sequence_id):l.entity_type_id=e.for_entity,!l.entity?.canceled&&(D[l.entity_type_id]||(D[l.entity_type_id]={}),l.assignees.length||(l.assignees=["unassigned"]),l.assignees.forEach(d=>{const p=M.get(l.entity_type_id);let h;if(this.mode==="real"){if(!l.real_start_date)return;h=_(l.real_start_date)}else h=_(l.start_date);if(h.isAfter(this.endDate))return;h.isBefore(p.startDate)&&(p.startDate=h.clone()),l.startDate=h;let g;if(this.mode==="real"?g=l.done_date?_(l.done_date):x.tz():l.due_date?g=_(l.due_date):l.end_date?g=_(l.end_date):l.estimation&&(g=O(l.startDate,Math.ceil(L(this.organisation,l.estimation))-1,this.daysOffByPerson[d])),!g||g.isBefore(h)){const Y=h.isoWeekday()===5?3:1;g=h.clone().add(Y,"days")}if(!g.isSameOrAfter(h)){const Y=h.isoWeekday()===5?3:1;g=h.clone().add(Y,"days")}g.isBefore(this.startDate)||(g.isAfter(p.endDate)&&(p.endDate=g.clone()),l.endDate=g,D[l.entity_type_id][d]||(D[l.entity_type_id][d]=[],k[d]=d!=="unassigned"?{...this.personMap.get(d),daysOff:this.daysOffByPerson[d]}:{id:d,avatar:!1,color:"#888",full_name:this.$t("main.unassigned")}),l.editable=!this.isLockedSchedule,l.unresizable=!1,l.parentElement=p,D[l.entity_type_id][d].push(l))})))}),e.for_entity==="Asset"&&(b=b.filter(l=>{const d=this.assetTypeMap.get(l.object_id);return d&&(!d.task_types.length||d.task_types.includes(e.task_type_id))}));const P=([l],[d])=>l==="unassigned"?1:d==="unassigned"?-1:k[l].full_name.localeCompare(k[d].full_name),T=(l,d)=>l.entity?.name.localeCompare(d.entity?.name,void 0,{numeric:!0});b.forEach(l=>{const d=D[l.object_id]||{},p=new Map(Object.entries(d).sort(P).map(([h,g])=>[h,g.sort(T)]));l.children=p}),e.children=Ye(b),e.people=k,e.entitiesByType=Object.fromEntries(Object.entries(D).map(([l,d])=>[l,Object.entries(d).flatMap(([p,h])=>p!=="unassigned"?h.map(g=>g.entity_id):void 0).filter(Boolean)]))}}catch(s){console.error(s),e.children=[],e.people=[]}finally{e.loading=!1}t&&t(e),this.selectTaskTypeElement(e,null,o)}},filteredAssignments(e){return this.assignments.assigned?e:e.filter(t=>!t.assigned)},saveTaskChanged(e){return this.isVersioned?this.updateScheduleVersionedTask({id:e.versionedTaskId,estimation:e.estimation,startDate:e.startDate.format("YYYY-MM-DD"),dueDate:e.endDate.format("YYYY-MM-DD"),assignees:e.assignees}):this.updateTask({taskId:e.id,data:{estimation:e.estimation,start_date:e.startDate.format("YYYY-MM-DD"),due_date:e.endDate.format("YYYY-MM-DD")}})},async onScheduleItemChanged(e){if(e.type==="Task"){const t=e.assignees.flatMap(i=>this.daysOffByPerson[i]).filter(Boolean);e.startDate=O(e.startDate,0,t),e.endDate=O(e.startDate,Math.ceil(L(this.organisation,e.estimation))-1,t),e.startDate.isBefore(e.parentElement.startDate)&&(e.parentElement.startDate=e.startDate.clone(),this.updateScheduleItem(e.parentElement),e.parentElement.startDate.isBefore(e.parentElement.parentElement.startDate)&&(e.parentElement.parentElement.startDate=e.parentElement.startDate.clone(),this.updateScheduleItem(e.parentElement.parentElement))),e.endDate.isAfter(e.parentElement.endDate)&&(e.parentElement.endDate=e.endDate.clone(),this.updateScheduleItem(e.parentElement),e.parentElement.endDate.isAfter(e.parentElement.parentElement.endDate)&&(e.parentElement.parentElement.endDate=e.parentElement.endDate.clone(),this.updateScheduleItem(e.parentElement.parentElement))),await this.saveTaskChanged(e);return}if(e.startDate&&e.endDate&&e.parentElement)e.parentElement.startDate=this.getMinDate(e.parentElement),e.parentElement.endDate=this.getMaxDate(e.parentElement),this.isVersioned||this.saveScheduleItem(e.parentElement);else if(!e.parentElement){const t=this.getMinDate(e),i=this.getMaxDate(e);e.startDate.isAfter(t)&&(e.startDate=t),e.endDate.isBefore(i)&&(e.endDate=i)}await this.updateScheduleItem(e)},async updateScheduleItem(e){const t=this.scheduleItems.find(i=>i===e);t&&(t.startDate=e.startDate,t.start_date=e.startDate.format("YYYY-MM-DD"),t.endDate=e.endDate,t.end_date=e.endDate.format("YYYY-MM-DD")),this.isVersioned||await this.saveScheduleItem(e)},getMinDate(e){let t=this.endDate.clone();return e.children.forEach(i=>{i.startDate&&i.startDate.isBefore(t)&&(t=i.startDate)}),t.clone()},getMaxDate(e){let t=this.startDate.clone();return e.children.forEach(i=>{i.endDate&&i.endDate.isAfter(t)&&(t=i.endDate)}),t.clone()},isInDepartment(e){return this.isCurrentUserManager?!0:this.isCurrentUserSupervisor?this.user.departments.length===0?!0:e.department_id&&this.user.departments.includes(e.department_id):!1},scrollScheduleToToday(){this.$refs.schedule?.scrollToToday()},resetSidePanel(){this.assignments={...this.assignments,entityTypes:null,excludes:[],forcedDailyQuota:null,loading:!1,saving:!1,startDate:null,endDate:null,task:{},type:null,unassign:!1}},toggleSidePanel(){this.isSidePanelOpen&&this.assignments.type==="task"&&(this.assignments.type=null,this.isSidePanelOpen=!1),this.isSidePanelOpen=!this.isSidePanelOpen,this.isSidePanelOpen&&this.assignments.type!=="task"&&!this.assignments.entityTypes&&this.selectedTaskType&&this.selectTaskTypeElement(this.selectedTaskType)},selectParentElement(e){e.expanded?this.selectTaskTypeElement(e):this.expandTaskTypeElement(e,()=>{this.$refs.schedule?.refreshItemPositions(e)})},onSelectTaskType(e){this.selectedTaskType=this.scheduleItems.find(t=>t.task_type_id===e),this.expandTaskTypeElement(this.selectedTaskType,()=>{this.$refs.schedule?.refreshItemPositions(this.selectedTaskType)},!0,!1)},async selectTaskTypeElement(e,t=void 0,i=!0){if(this.isTVShow)return;this.selectedTaskType=e,i&&this.resetSidePanel(),this.assignments.loading=!0;const o=await this.loadTasks({project_id:this.currentProduction.id,task_type_id:this.selectedTaskType.task_type_id,relations:"true"});if(e.for_entity==="Asset")await this.loadAssets({withShared:!1,withTasks:!1}),this.assignments.entityTypes=this.productionAssetTypes.filter(s=>!s.task_types.length||s.task_types.includes(e.task_type_id)).map(s=>({id:s.id,name:s.name,for_entity:e.for_entity,expanded:s.id===t?.object_id,entity_type_id:s.id,children:this.assets.filter(n=>n.asset_type_id===s.id&&!n.canceled&&!n.shared&&o.some(r=>r.entity_id===n.id)).map(n=>({...n,assigned:e.entitiesByType[s.id]?.includes(n.id)}))}));else if(e.for_entity==="Shot"){await this.loadShots();const s=this.shots.filter(n=>o.some(r=>r.entity_id===n.id)).reduce((n,r)=>(n[r.parent_id]||(n[r.parent_id]=[]),r.assigned=e.entitiesByType[r.parent_id]?.includes(r.id),n[r.parent_id].push(r),n),{});this.assignments.entityTypes=Object.keys(s).map(n=>{const r=s[n];return{id:n,name:r[0].sequence_name,for_entity:e.for_entity,expanded:n===t?.object_id,children:r}})}this.assignments.loading=!1},selectTaskElement(e,t,i,o){if(o.length!==1){this.closeSidePanel();return}this.resetSidePanel(),this.isSidePanelOpen=!0,this.selectedTaskType=e,this.draggedEntities=[{...t,children:[{...i.entity}]}],this.assignments.type="task";const s=e.start_date,n=_(s).isAfter(e.end_date)?s:e.end_date;this.assignments.startDate=s,this.assignments.endDate=n,this.assignments.task={...i,estimation:L(this.organisation,i.estimation),startDate:i.startDate.format("YYYY-MM-DD"),endDate:i.endDate.format("YYYY-MM-DD")},this.assignments.excludes=this.team.filter(r=>!i.assignees.includes(r.id)).map(r=>r.id),this.assignments.unassign=!0},closeSidePanel(){this.isSidePanelOpen=!1,this.resetSidePanel()},onAssignmentItemSelected(e){const t=x().utc().toDate();this.assignments.type="entity",this.assignments.startDate=e.start_date||t,this.assignments.endDate=e.end_date||t,e.children=this.filteredAssignments(e.children),this.draggedEntities=[e]},onAssignmentItemDragStart(e,t,i){e.stopPropagation(),e.dataTransfer.dropEffect="move",e.dataTransfer.effectAllowed="move",e.dataTransfer.setData(`task-type-${i.task_type_id}`,!0),e.dataTransfer.setData("taskTypeId",i.task_type_id),e.dataTransfer.setData("entityId",t.id),t.children=this.filteredAssignments(t.children),this.draggedEntities=[t]},onScheduleItemDropped(e,t){this.assignments.type="entity";const i=e.start_date||t.start_date,o=_(i).isAfter(t.end_date)?i:t.end_date;this.assignments.startDate=i,this.assignments.endDate=o},removeFromAssignments(e){this.assignments.excludes.push(e.id)},submitAssignments(){this.assignments.type==="entity"?this.saveAssignments():this.assignments.type==="task"&&this.saveTask()},async saveAssignments(){this.assignments.saving=!0;const e=await this.loadTasks({project_id:this.currentProduction.id,task_type_id:this.selectedTaskType.task_type_id,relations:"true"}),i=1/(this.assignments.forcedDailyQuota??this.estimatedDailyQuota);for(const o of this.draggedEntities){const s=_(this.assignments.startDate),n=_(this.assignments.endDate);let r=0,b=0,M=s.clone();for(const y of o.children){const D=e.find(d=>d.entity_id===y.id);if(!D)continue;let k;this.isVersioned&&(k=(await this.loadTasksFromScheduleVersion({version:{id:this.version},taskType:{id:D.task_type_id}})).find(p=>p.task_id===D.id)??{taskId:D.id,version:this.version,assignees:[]},D.versionedTaskId=k.id),this.assignments.unassign&&(this.isVersioned?k.assignees=[]:await this.unassignSelectedTasks({taskIds:[D.id]})),r++;let P=M,T=null,l=null;for(;b<this.availablePersons.length;){l=this.availablePersons[b],P=O(P,0,this.daysOffByPerson[l.id]);const{due_date:d}=xe(this.organisation,s,T,r*i,this.daysOffByPerson[l.id]);if(T=_(d),T.isAfter(n))b++,r=1,P=s.clone(),T=null;else{this.isVersioned?(k.startDate=P.format("YYYY-MM-DD"),k.dueDate=T.format("YYYY-MM-DD"),k.estimation=U(this.organisation,i),k.assignees.push(l.id),k.id?await this.updateScheduleVersionedTask(k):await this.createScheduleVersionedTask(k)):await Promise.all([this.assignSelectedTasks({personId:l.id,taskIds:[D.id]}),this.updateTask({taskId:D.id,data:{estimation:U(this.organisation,i),start_date:P.format("YYYY-MM-DD"),due_date:T.format("YYYY-MM-DD")}})]),r*i%1!==0?M=T.clone():M=T.clone().add(1,"days");break}}}this.expandTaskTypeElement(this.selectedTaskType,()=>{this.$refs.schedule?.refreshItemPositions(this.selectedTaskType)},!0,!1)}this.assignments.saving=!1},async saveTask(){this.assignments.saving=!0;try{const e={...this.assignments.task,startDate:_(this.assignments.task.startDate),endDate:_(this.assignments.task.endDate),estimation:U(this.organisation,this.assignments.task.estimation),assignees:this.availablePersons.map(t=>t.id)};await this.onScheduleItemChanged(e),this.isVersioned||(await this.unassignSelectedTasks({taskIds:[e.id]}),await Promise.all(e.assignees.map(t=>this.assignSelectedTasks({personId:t,taskIds:[e.id]})))),this.assignments.task.startDate=e.startDate.format("YYYY-MM-DD"),this.assignments.task.endDate=e.endDate.format("YYYY-MM-DD"),this.expandTaskTypeElement(this.selectedTaskType,()=>{this.$refs.schedule?.refreshItemPositions(this.selectedTaskType)},!0,!1)}catch(e){console.error(e)}finally{this.assignments.saving=!1}},async onScheduleItemAssigned(e,t){if(e.assignees.push(t),e.parentElement.children.get(t).push(e),this.isVersioned)return this.updateScheduleVersionedTask({id:e.versionedTaskId,assignees:e.assignees});await this.assignSelectedTasks({personId:t,taskIds:[e.id]})},async onScheduleItemUnassigned(e,t){e.assignees=e.assignees.filter(o=>o!==t);const i=e.parentElement.children.get(t);if(i.splice(i.indexOf(e),1),this.isVersioned)return this.updateScheduleVersionedTask({id:e.versionedTaskId,assignees:e.assignees});await this.unassignPersonFromTask({person:{id:t},task:e})},onZoomLevelChanged(e){this.updateRoute({zoom:e})},onModeChanged(e){this.updateRoute({mode:e}),this.closeSidePanel(),this.refreshSchedule()},onVersionChanged(e){this.updateRoute({version:e}),this.closeSidePanel(),this.refreshSchedule()},refreshSchedule(){this.scheduleItems.forEach(e=>{e.expanded&&this.expandTaskTypeElement(e,()=>{this.$refs.schedule?.refreshItemPositions(e)},!0,!1)})},openEditScheduleVersion(e={}){this.scheduleVersionToEdit=e,this.modals.editScheduleVersion=!0},openDeleteScheduleVersion(e){this.scheduleVersionToEdit=this.scheduleVersions.find(({id:t})=>t===e),this.modals.deleteScheduleVersion=!0},async editVersion(e){if(this.modals.editScheduleVersion=!1,e.id)await this.updateScheduleVersion(e);else{const t=await this.createScheduleVersion({production:this.currentProduction,version:e});this.version=t.id,this.onVersionChanged(this.version)}this.scheduleVersionToEdit={}},async deleteVersion(e){this.modals.deleteScheduleVersion=!1,await this.deleteScheduleVersion(e),this.version===e.id&&(this.version=B,this.onVersionChanged(this.version)),this.scheduleVersionToEdit={}},async applyToProduction(){this.loading.applyScheduleVersion=!0,this.errors.applyScheduleVersion=!1;try{await this.applyScheduleVersionToProduction(this.version),this.modals.applyScheduleVersion=!1}catch(e){console.error(e),this.errors.applyScheduleVersion=!0}finally{this.loading.applyScheduleVersion=!1}await this.loadScheduleVersions(this.currentProduction)}},watch:{selectedStartDate(){this.startDate=_(this.selectedStartDate);const e=this.startDate.format("YYYY-MM-DD");this.currentProduction.start_date&&this.currentProduction.start_date!==e&&this.editProduction({...this.currentProduction,start_date:e})},selectedEndDate(){this.endDate=_(this.selectedEndDate);const e=this.endDate.format("YYYY-MM-DD");this.currentProduction.end_date&&this.currentProduction.end_date!==e&&this.editProduction({...this.currentProduction,end_date:e})},currentProduction(e){e&&this.reset()}},head(){return{title:`${this.currentProduction.name} | ${this.$t("schedule.title")} - Kitsu`}}},je={class:"columns fixed-page"},Ne={class:"column main-column"},Re={class:"flexrow project-dates"},Qe={class:"flexrow-item"},Ge={class:"flexrow-item"},He={key:0,class:"flexrow-item ml1"},Je={class:"label"},We={class:"flexrow"},Ze={class:"flexrow",style:{"margin-top":"23px"}},Ke={key:0,class:"column side-column"},Xe={class:"side"},$e={class:"mt1"},es={class:"details"},ss={key:0,class:"mt2"},ts={key:1,class:"assignments parent mt1"},ns=["onDragstart","onClick"],is={class:"name"},as=["onClick"],ls={key:0,class:"assignments children"},os=["onDragstart","onClick"],ds={class:"name"},rs={key:2,class:"assignments mt1"},us={class:"flexrow"},cs={class:"flexrow-item"},hs={class:"flexrow-item"},ms={key:0},ps={key:1,class:"dragged-items"},fs={class:"assignees"},gs=["title"],ys={key:0},_s={class:"has-text-centered"},Ds={key:1},vs={class:"assignee"},Ss={class:"person"},ks={key:1,class:"flexrow mt2"},bs={class:"mr05"},Vs={key:2,class:"mt2"},Ts={key:3,class:"flexrow mt2"},Es={class:"flexrow-item"},ws={class:"flexrow-item"},Ms={key:4,class:"flexrow mt2"},Ps={class:"mt2 has-text-right"},Is=["disabled","text"];function xs(e,t,i,o,s,n){const r=v("date-field"),b=v("combobox-number"),M=v("combobox"),y=v("button-simple"),D=v("schedule"),k=v("x-icon"),P=v("combobox-task-type"),T=v("spinner"),l=v("grip-vertical-icon"),d=v("chevron-right-icon"),p=v("chevron-down-icon"),h=v("list-restart-icon"),g=v("people-avatar"),Y=v("people-name"),ee=v("checkbox"),F=v("text-field"),se=v("trash-icon"),te=v("edit-schedule-version-modal"),ne=v("hard-delete-modal"),ie=v("confirm-modal");return u(),f(I,null,[c("div",je,[c("div",Ne,[c("div",Re,[c("div",Qe,[m(r,{"can-delete":!1,label:e.$t("main.start_date"),utc:"",modelValue:s.selectedStartDate,"onUpdate:modelValue":t[0]||(t[0]=a=>s.selectedStartDate=a)},null,8,["label","modelValue"])]),c("div",Ge,[m(r,{"can-delete":!1,label:e.$t("main.end_date"),utc:"",modelValue:s.selectedEndDate,"onUpdate:modelValue":t[1]||(t[1]=a=>s.selectedEndDate=a)},null,8,["label","modelValue"])]),m(b,{class:"flexrow-item zoom-level nowrap",label:e.$t("schedule.zoom_level"),options:s.zoomOptions,modelValue:s.zoomLevel,"onUpdate:modelValue":[t[2]||(t[2]=a=>s.zoomLevel=a),n.onZoomLevelChanged]},null,8,["label","options","modelValue","onUpdate:modelValue"]),m(M,{class:"flexrow-item ml1",label:e.$t("schedule.mode"),modelValue:s.mode,"onUpdate:modelValue":[t[3]||(t[3]=a=>s.mode=a),n.onModeChanged],options:s.modeOptions},null,8,["label","modelValue","options","onUpdate:modelValue"]),s.mode==="prev"?(u(),f("div",He,[c("label",Je,V(e.$t("schedule.version")),1),c("div",We,[m(M,{class:"flexrow-item",modelValue:s.version,"onUpdate:modelValue":[t[4]||(t[4]=a=>s.version=a),n.onVersionChanged],options:n.versionOptions},null,8,["modelValue","options","onUpdate:modelValue"]),m(y,{class:"ml05",icon:"calendar-plus",title:e.$t("schedule.new_version"),onClick:t[5]||(t[5]=a=>n.openEditScheduleVersion())},null,8,["title"]),m(y,{class:"ml05",disabled:s.version==="ref",icon:"pencil",title:e.$t("schedule.edit_version"),onClick:t[6]||(t[6]=a=>n.openEditScheduleVersion(n.currentVersion))},null,8,["disabled","title"]),m(y,{class:"ml05",disabled:s.version==="ref",icon:"trash",title:e.$t("schedule.delete_version"),onClick:t[7]||(t[7]=a=>n.openDeleteScheduleVersion(s.version))},null,8,["disabled","title"])])])):S("",!0),t[29]||(t[29]=c("div",{class:"filler"},null,-1)),c("div",Ze,[!e.isTVShow&&s.mode==="prev"?(u(),w(y,{key:0,class:"flexrow-item",disabled:s.version==="ref",icon:"save",text:e.$t("schedule.apply_to_prod"),onClick:t[8]||(t[8]=a=>s.modals.applyScheduleVersion=!0)},null,8,["disabled","text"])):S("",!0),m(y,{class:"flexrow-item",icon:"clock",text:e.$t("schedule.today"),onClick:n.scrollScheduleToToday},null,8,["text","onClick"]),e.isTVShow?S("",!0):(u(),w(y,{key:1,active:s.isSidePanelOpen&&s.assignments.type!=="task",class:"flexrow-item",disabled:n.isLockedSchedule,icon:"list",text:e.$t("menu.assign_tasks"),onClick:n.toggleSidePanel},null,8,["active","disabled","text","onClick"]))])]),m(D,{ref:"schedule","start-date":s.startDate,"end-date":s.endDate,hierarchy:s.scheduleItems,"zoom-level":s.zoomLevel,"is-loading":s.loading.schedule,"is-error":s.errors.schedule,"is-estimation-linked":"","hide-man-days":"",multiline:e.isTVShow,reassignable:!n.isLockedSchedule,subchildren:!e.isTVShow,type:s.mode,onItemAssign:n.onScheduleItemAssigned,onItemChanged:n.onScheduleItemChanged,onItemDrop:n.onScheduleItemDropped,onItemSelected:n.selectTaskTypeElement,onItemUnassign:n.onScheduleItemUnassigned,onRootElementExpanded:n.expandTaskTypeElement,onRootElementSelected:n.selectParentElement,onTaskSelected:n.selectTaskElement,onTaskUnselected:t[9]||(t[9]=a=>n.closeSidePanel())},null,8,["start-date","end-date","hierarchy","zoom-level","is-loading","is-error","multiline","reassignable","subchildren","type","onItemAssign","onItemChanged","onItemDrop","onItemSelected","onItemUnassign","onRootElementExpanded","onRootElementSelected","onTaskSelected"])]),s.isSidePanelOpen&&!n.isLockedSchedule&&!e.isTVShow?(u(),f("div",Ke,[c("div",Xe,[c("a",{class:"close-button",onClick:t[10]||(t[10]=(...a)=>n.toggleSidePanel&&n.toggleSidePanel(...a))},[m(k,{class:"align-middle",size:16})]),c("h2",$e,V(s.assignments.type==="task"?e.$t("schedule.edit_task"):e.$t("menu.assign_tasks")),1),c("div",es,[m(P,{class:"mb05","add-placeholder":"",placeholder:e.$t("schedule.select_task_type"),label:e.$t("news.task_type"),"task-type-list":s.availableTaskTypes,"model-value":s.selectedTaskType?.task_type_id,"onUpdate:modelValue":n.onSelectTaskType},null,8,["placeholder","label","task-type-list","model-value","onUpdate:modelValue"]),!s.assignments.loading&&s.assignments.entityTypes?.length&&!s.assignments.type?(u(),w(y,{key:0,class:"mt2 mb05",icon:"user-check","is-on":s.assignments.assigned,title:e.$t("schedule.show_assigned"),onClick:t[11]||(t[11]=a=>s.assignments.assigned=!s.assignments.assigned)},null,8,["is-on","title"])):S("",!0)]),s.assignments.loading?(u(),f("div",ss,[m(T,{class:"mauto",size:20})])):s.assignments.type?(u(),f("div",rs,[c("form",{class:"mt1",onSubmit:t[23]||(t[23]=z(a=>n.submitAssignments(),["prevent"]))},[c("div",us,[c("div",cs,[m(r,{"can-delete":!1,disabled:s.assignments.type!=="entity",label:e.$t("main.start_date"),utc:"",modelValue:s.assignments.startDate,"onUpdate:modelValue":t[12]||(t[12]=a=>s.assignments.startDate=a)},null,8,["disabled","label","modelValue"])]),c("div",hs,[m(r,{"can-delete":!1,disabled:s.assignments.type!=="entity",label:e.$t("main.end_date"),utc:"",modelValue:s.assignments.endDate,"onUpdate:modelValue":t[13]||(t[13]=a=>s.assignments.endDate=a)},null,8,["disabled","label","modelValue"])])]),(u(!0),f(I,null,C(s.draggedEntities,a=>(u(),f("div",{key:a.id},[c("div",{class:"dragged-type",style:R({background:s.selectedTaskType.color})},V(a.name),5),a.children.length?(u(),f("ul",ps,[(u(!0),f(I,null,C(a.children,E=>(u(),f("li",{class:"dragged-item",key:E.id,style:R({background:`color-mix(in srgb, ${s.selectedTaskType.color} 40%, transparent)`,"border-left":`4px solid ${s.selectedTaskType.color}`})},V(a.name)+" / "+V(E.name),5))),128))])):(u(),f("div",ms,V(e.$t("schedule.no_entity")),1)),t[30]||(t[30]=c("hr",null,null,-1))]))),128)),c("table",fs,[c("thead",null,[c("tr",null,[c("td",null,[Ie(V(e.$t("schedule.assign"))+" ",1),s.assignments.excludes.length?(u(),f("a",{key:0,class:"reset-assignees",title:e.$t("schedule.reset_list"),onClick:t[14]||(t[14]=a=>s.assignments.excludes=[])},[m(h,{class:"align-middle",size:18,"stroke-width":1.5})],8,gs)):S("",!0)])])]),n.availablePersons.length?(u(),f("tbody",Ds,[(u(!0),f(I,null,C(n.availablePersons,a=>(u(),f("tr",{key:a.id},[c("td",vs,[c("div",Ss,[m(g,{"is-link":!1,"font-size":14,person:a,size:28},null,8,["person"]),m(Y,{person:a},null,8,["person"])]),m(y,{class:"is-small",icon:"minus",title:e.$t("main.avatar.unassign",{personName:a.name}),type:"button",onClick:E=>n.removeFromAssignments(a)},null,8,["title","onClick"])])]))),128))])):(u(),f("tbody",ys,[c("tr",null,[c("td",_s,V(e.$t("schedule.no_assignee")),1)])]))]),s.assignments.type==="entity"?(u(),w(ee,{key:0,class:"pa05",disabled:!n.availablePersons.length,label:e.$t("schedule.force_unassign"),toggle:!0,modelValue:s.assignments.unassign,"onUpdate:modelValue":t[15]||(t[15]=a=>s.assignments.unassign=a)},null,8,["disabled","label","modelValue"])):S("",!0),s.assignments.type==="entity"?(u(),f("div",ks,[c("label",bs,V(e.$t("schedule.forced_daily_quotas")),1),m(F,{class:"mb0 daily-quotas","input-class":" is-small",step:.01,type:"number",modelValue:s.assignments.forcedDailyQuota,"onUpdate:modelValue":t[16]||(t[16]=a=>s.assignments.forcedDailyQuota=a)},null,8,["modelValue"]),s.assignments.forcedDailyQuota?(u(),f("a",{key:0,class:"reset-quotas ml05",onClick:t[17]||(t[17]=a=>s.assignments.forcedDailyQuota=null)},[m(se,{class:"align-middle",size:14})])):S("",!0)])):S("",!0),s.assignments.type==="entity"?(u(),f("div",Vs,V(e.$t("schedule.estimated_daily_quotas"))+" "+V(n.estimatedDailyQuota.toFixed(2)),1)):S("",!0),s.assignments.type==="task"?(u(),f("div",Ts,[c("div",Es,[m(r,{"can-delete":!1,label:e.$t("main.start_date"),utc:"","with-margin":!1,modelValue:s.assignments.task.startDate,"onUpdate:modelValue":t[18]||(t[18]=a=>s.assignments.task.startDate=a)},null,8,["label","modelValue"])]),c("div",ws,[m(r,{"can-delete":!1,disabled:"",label:e.$t("main.end_date"),utc:"","with-margin":!1,modelValue:s.assignments.task.endDate,"onUpdate:modelValue":t[19]||(t[19]=a=>s.assignments.task.endDate=a)},null,8,["label","modelValue"])])])):S("",!0),s.assignments.type==="task"?(u(),f("div",Ms,[m(F,{class:"mb0 estimation mr05","input-class":" thin",label:e.$t("main.estimation"),step:.01,placeholder:"0.00",type:"number","unit-label":e.$t("schedule.md"),modelValue:s.assignments.task.estimation,"onUpdate:modelValue":t[20]||(t[20]=a=>s.assignments.task.estimation=a)},null,8,["label","unit-label","modelValue"])])):S("",!0),c("div",Ps,[s.assignments.type==="entity"?(u(),f(I,{key:0},[m(y,{disabled:!n.hasDraggedEntities||!n.availablePersons.length,"is-loading":s.assignments.saving,"is-primary":"",text:e.$t("main.apply"),type:"submit"},null,8,["disabled","is-loading","text"]),c("button",{class:"button is-link ml05",disabled:s.assignments.saving,text:e.$t("main.back"),type:"button",onClick:t[21]||(t[21]=a=>s.assignments.type=null)},V(e.$t("main.back")),9,Is)],64)):S("",!0),s.assignments.type==="task"?(u(),f(I,{key:1},[m(y,{disabled:!s.assignments.task.estimation,"is-loading":s.assignments.saving,"is-primary":"",text:e.$t("main.apply"),type:"submit"},null,8,["disabled","is-loading","text"]),c("button",{class:"button is-link ml05",onClick:t[22]||(t[22]=a=>n.closeSidePanel())},V(e.$t("main.cancel")),1)],64)):S("",!0)])],32)])):(u(),f("ul",ts,[(u(!0),f(I,null,C(s.assignments.entityTypes,a=>(u(),f("li",{key:a.id},[c("div",{class:"assignment-item",draggable:"true",onDragstart:E=>n.onAssignmentItemDragStart(E,a,s.selectedTaskType),onClick:E=>n.onAssignmentItemSelected(a)},[m(l,{class:"icon"}),c("span",is,V(a.name)+" ("+V(n.filteredAssignments(a.children).length)+") ",1),c("span",{class:"expand",onClick:z(E=>a.expanded=!a.expanded,["stop"])},[a.expanded?(u(),w(p,{key:1})):(u(),w(d,{key:0}))],8,as)],40,ns),a.expanded?(u(),f("ul",ls,[(u(!0),f(I,null,C(n.filteredAssignments(a.children),E=>(u(),f("li",{key:E.id},[c("div",{class:"assignment-item",draggable:"true",onDragstart:q=>n.onAssignmentItemDragStart(q,{...a,children:[E]},s.selectedTaskType),onClick:q=>n.onAssignmentItemSelected({...a,children:[E]})},[m(l,{class:"icon"}),c("span",ds,V(E.name),1)],40,os)]))),128))])):S("",!0)]))),128))]))])])):S("",!0)]),s.modals.editScheduleVersion?(u(),w(te,{key:0,"schedule-version-to-edit":s.scheduleVersionToEdit,version:s.version,"version-options":e.scheduleVersions,"is-loading":s.loading.editScheduleVersion,"is-error":s.errors.editScheduleVersion,onCancel:t[24]||(t[24]=a=>s.modals.editScheduleVersion=!1),onConfirm:n.editVersion},null,8,["schedule-version-to-edit","version","version-options","is-loading","is-error","onConfirm"])):S("",!0),s.modals.deleteScheduleVersion?(u(),w(ne,{key:1,active:"","error-text":e.$t("schedule.delete_version_error"),"is-loading":s.loading.delete,"is-error":s.errors.deleteScheduleVersion,"lock-text":s.scheduleVersionToEdit?.name,text:e.$t("schedule.delete_version_message",{name:s.scheduleVersionToEdit?.name}),onCancel:t[25]||(t[25]=a=>s.modals.deleteScheduleVersion=!1),onConfirm:t[26]||(t[26]=a=>n.deleteVersion(s.scheduleVersionToEdit))},null,8,["error-text","is-loading","is-error","lock-text","text"])):S("",!0),s.modals.applyScheduleVersion?(u(),w(ie,{key:2,active:"",text:e.$t("schedule.apply_to_prod_confirm"),"error-text":e.$t("schedule.apply_to_prod_error"),"is-loading":s.loading.applyScheduleVersion,"is-error":s.errors.applyScheduleVersion,onCancel:t[27]||(t[27]=a=>s.modals.applyScheduleVersion=!1),onConfirm:t[28]||(t[28]=a=>n.applyToProduction())},null,8,["text","error-text","is-loading","is-error"])):S("",!0)],64)}const As=he(qe,[["render",xs],["__scopeId","data-v-0ad5d755"]]);export{W as DEFAULT_MODE,B as DEFAULT_VERSION,Z as DEFAULT_ZOOM,As as default};
//# sourceMappingURL=ProductionSchedule-Dh2goxmx.js.map
