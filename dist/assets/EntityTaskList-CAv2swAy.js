import{m as v,ab as E,bw as I,bF as C,bx as z,aB as M,cd as b,b as $,bK as A,bL as Y,s as L,aF as B,x as S,X as O,aI as N,_ as D,r as h,o as r,c as l,f as m,F as g,g as T,e as s,p as F,t as a,l as w,d as k,aP as U,E as j,y as P,L as R,T as W}from"./index-ip1P4Oag.js";import{P as V}from"./PeopleNameCell-BnzFZMcu.js";const pe={data(){return{currentSection:"infos",zoomLevel:1,entityNavOptions:[{label:"Infos",value:"infos"},{label:"Chat",value:"chat"},{label:"Casting",value:"casting"},{label:"Schedule",value:"schedule"},{label:"Preview Files",value:"preview-files"},{label:"Timelog",value:"time-logs"}],zoomOptions:[{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}]}},computed:{...v(["organisation"]),entityTabs(){return this.entityNavOptions.map(t=>({label:t.label,name:t.value}))},thumbnailPath(){return`/api/pictures/originals/preview-files/${this.currentEntity.preview_file_id}.png`},isPreview(){return this.currentEntity&&this.currentEntity.preview_file_id&&this.currentEntity.preview_file_id.length>0},currentTasks(){const t=this[`current${E.capitalize(this.type)}`];return!t||!t.tasks?[]:t?t.tasks.map(e=>this.taskMap.get(e)).filter(e=>e).sort((e,u)=>{const _=this.getTaskTypePriority(e.task_type_id),d=this.getTaskTypePriority(u.task_type_id);return _-d}):[]},tasksStartDate(){return this.scheduleItems.length>0&&this.scheduleItems[0].children.length>0?I(this.scheduleItems[0].children).clone().add(-60,"days"):C(this.currentProduction.start_date)},tasksEndDate(){return this.scheduleItems.length>0&&this.scheduleItems[0].children.length>0?z(this.scheduleItems[0].children).clone().add(60,"days"):C(this.currentProduction.end_date)},scheduleItems(){let t=0;const e={avatar:!1,id:"root",name:"Tasks",color:"#888",priority:1,expanded:!0,loading:!1,children:[],editable:!0},u=M(),_=this.currentTasks.map(o=>{const f=o.estimation;let y=u.clone(),c;if(!o.start_date&&!o.real_start_date&&!o.due_date&&!o.end_date)return null;o.start_date?y=b(o.start_date):o.real_start_date&&(y=b(o.real_start_date)),o.due_date?c=b(o.due_date):o.end_date?c=b(o.end_date):o.estimation&&(c=y.clone().add(f,"days")),(!c||c.isBefore(y))&&(c=y.clone().add(1,"days")),f&&(t+=o.estimation);const i=this.taskTypeMap.get(o.task_type_id);return{...o,name:i.name,startDate:y,endDate:c,expanded:!1,loading:!1,man_days:f,editable:!0,unresizable:!1,parentElement:e,color:i.color,children:[]}}).filter(o=>o!==null);let d=M(),n=M().add(1,"days");return _.length>0&&(d=I(_),n=z(_)),Object.assign(e,{children:_,startDate:d,endDate:n,man_days:t}),[e]}},methods:{...$(["addSelectedTask","clearSelectedTasks","updateTask"]),changeTab(t){this.selectedTab=t},onEditClicked(){this.modals.edit=!0},onTaskSelected(t){this.clearSelectedTasks(),!this.currentTask||this.currentTask.id!==t.id?(this.addSelectedTask(t),this.currentTask=t):this.currentTask=null},saveTaskScheduleItem(t){const e=A(t.startDate,t.endDate),u=Y(this.organisation,e);t.man_days=u,t.startDate&&t.endDate&&this.updateTask({taskId:t.id,data:{estimation:u,start_date:t.startDate.format("YYYY-MM-DD"),due_date:t.endDate.format("YYYY-MM-DD")}})}},watch:{$route(){const t=this.route.params[`${this.type}_id`],e=this[`current${E.capitalize(this.type)}`];e&&e!==t&&this.init(),this.currentSection=this.route.query.section||"infos"},currentSection(){this.currentSection==="schedule"&&this.scheduleItems.length>0&&this.$refs["schedule-widget"]&&this.$refs["schedule-widget"].scrollToDate(this.scheduleItems[0].startDate)},zoomLevel(){this.$refs["schedule-widget"]&&this.$refs["schedule-widget"].scrollToDate(this.scheduleItems[0].startDate)}}},q={name:"entity-news",mixins:[L],components:{PeopleAvatar:B,Spinner:S,TaskTypeName:O,ValidationTag:N},data(){return{isLoading:!1,newsList:[]}},props:{entity:{type:Object,default:()=>{}}},mounted(){this.reset()},computed:{...v(["currentProduction","personMap","taskTypeMap","taskStatusMap"])},methods:{...$(["getEntityNews"]),buildTaskFromNews(t){return{task_status_id:t.task_status_id}},buildTaskTypeFromNews(t){return{...this.taskTypeMap.get(t.task_type_id),episode_id:t.episode_id}},hasRetakeValue(t){const e=this.taskStatusMap.get(t.task_status_id);return e?t.change&&e.is_retake:!1},hasDoneValue(t){const e=this.taskStatusMap.get(t.task_status_id);return e?t.change&&e.is_done:!1},reset(){this.entity&&(this.isLoading=!0,this.getEntityNews(this.entity.id).then(t=>{this.newsList=t.data}).catch(t=>{console.error(t),this.newsList=[]}).finally(()=>{this.isLoading=!1}))}},watch:{entity(){this.reset()}},socket:{events:{"news:new"(t){t.project_id===this.currentProduction.id&&(!this.taskTypeId||this.taskTypeId===t.task_type_id)&&(!this.taskStatusId||this.taskStatusId===t.task_status_id)&&this.reset()}}}},G={class:"news flexcolumn"},H={key:0,class:"has-text-centered"},K={key:1,class:"timeline mt1"},X={class:"date flexrow-item"},J={class:"flexrow-item task-type-wrapper ml1"},Q={class:"flexrow-item validation-wrapper"},Z={key:2};function x(t,e,u,_,d,n){const o=h("spinner"),f=h("people-avatar"),y=h("task-type-name"),c=h("validation-tag");return r(),l("div",G,[d.isLoading?(r(),l("div",H,[m(o)])):d.newsList.length?(r(),l("div",K,[(r(!0),l(g,null,T(d.newsList,i=>(r(),l("div",{class:"timeline-entry flexrow",key:`news-${i.id}`},[s("span",{class:F({dot:!0,red:n.hasRetakeValue(i),green:n.hasDoneValue(i)})},null,2),s("span",X,a(t.formatFullDate(i.created_at).substring(10,0)),1),t.personMap.get(i.author_id)?(r(),w(f,{key:0,class:"flexrow-item","font-size":14,"is-link":!1,person:t.personMap.get(i.author_id),size:30},null,8,["person"])):k("",!0),s("div",J,[m(y,{class:"task-type-name","is-static":!0,"production-id":t.currentProduction.id,"task-type":n.buildTaskTypeFromNews(i)},null,8,["production-id","task-type"])]),s("div",Q,[m(c,{"is-priority":!1,"is-static":!0,task:n.buildTaskFromNews(i),thin:!i.change},null,8,["task","thin"])])]))),128))])):(r(),l("div",Z,a(t.$t("news.no_news")),1))])}const _e=D(q,[["render",x],["__scopeId","data-v-aa79b909"]]),tt={name:"entity-preview-files",components:{DownloadIcon:U,EntityThumbnail:j,PeopleNameCell:V,Spinner:S,TaskTypeCell:P},data(){return{isLoading:!1,previewFiles:[]}},props:{entity:{type:Object,default:()=>{}}},mounted(){this.entity&&this.reset()},computed:{...v(["currentProduction","isCurrentUserArtist","personMap","taskMap","taskTypeMap"])},methods:{...$(["getEntityPreviewFiles"]),getTaskType(t){const e=this.taskMap.get(t.task_id);return this.taskTypeMap.get(e.task_type_id)},getDownloadPath(t){const e=this.previewFiles.find(_=>_.id===t);return e?`/api/${e.extension==="mp4"?"movies":"pictures"}/originals/preview-files/${t}/download`:""},renderFileSize:R,reset(){this.isLoading=!0,this.getEntityPreviewFiles(this.entity.id).then(t=>{this.previewFiles=t,this.isLoading=!1}).catch(t=>{console.error(t),this.previewFiles=[],this.isLoading=!1})}},watch:{entity(){this.entity&&this.reset()}}},et={class:"mt1 flexcolumn wrapper preview-files"},st={key:0,class:"has-text-centered"},at={key:1},it={class:"datatable"},nt={class:"datatable-head"},rt={class:"datatable-row-header"},ot={class:"type"},lt={class:"original-name"},dt={class:"revision"},ct={class:"extension"},ut={class:"size"},ht={class:"status"},pt={class:"person"},_t={class:"datatable-body"},yt={class:"thumbnail"},mt={class:"original-name"},ft={class:"revision"},kt={class:"extension"},gt={class:"size"},Tt={class:"status"},vt={class:"download"},bt=["href","title"],wt={key:2};function $t(t,e,u,_,d,n){const o=h("spinner"),f=h("entity-thumbnail"),y=h("task-type-cell"),c=h("people-name-cell"),i=h("download-icon");return r(),l("div",et,[d.isLoading?(r(),l("div",st,[m(o)])):d.previewFiles.length>0?(r(),l("div",at,[s("table",it,[s("thead",nt,[s("tr",rt,[e[0]||(e[0]=s("th",{class:"thumbnail"},null,-1)),s("th",ot,a(t.$t("entities.preview_files.task_type")),1),s("th",lt,a(t.$t("entities.preview_files.original_file_name")),1),s("th",dt,a(t.$t("entities.preview_files.revision")),1),s("th",ct,a(t.$t("entities.preview_files.extension")),1),s("th",ut,a(t.$t("entities.preview_files.size")),1),s("th",ht,a(t.$t("entities.preview_files.status")),1),s("th",pt,a(t.$t("entities.preview_files.uploader")),1),e[1]||(e[1]=s("th",{class:"end-cell"},null,-1))])]),s("tbody",_t,[(r(!0),l(g,null,T(d.previewFiles,p=>(r(),l("tr",{key:p.id,class:"datatable-row"},[s("td",yt,[m(f,{class:"preview-thumbnail","preview-file-id":p.id,"empty-width":60,width:60},null,8,["preview-file-id"])]),m(y,{class:"type","task-type":n.getTaskType(p),"production-id":t.currentProduction.id},null,8,["task-type","production-id"]),s("td",mt,a(p.original_name),1),s("td",ft,a(p.revision),1),s("td",kt,a(p.extension),1),s("td",gt,a(n.renderFileSize(p.file_size)),1),s("td",Tt,a(p.validation_status),1),m(c,{class:"person",person:t.personMap.get(p.person_id)},null,8,["person"]),s("td",vt,[t.isCurrentUserArtist?k("",!0):(r(),l("a",{key:0,class:"button flexrow-item",href:n.getDownloadPath(p.id),title:t.$t("playlists.actions.download_file")},[m(i,{class:"icon is-small"})],8,bt))])]))),128))])])])):(r(),l("div",wt,a(t.$t("entities.preview_files.no_preview_files")),1))])}const ye=D(tt,[["render",$t],["__scopeId","data-v-305f83e4"]]),Dt={name:"entity-time-logs",mixins:[L],components:{PeopleNameCell:V,Spinner:S,TaskTypeCell:P},props:{entity:{type:Object,default:()=>{}}},data(){return{logs:[],isLoading:!1}},mounted(){this.entity&&this.reset()},computed:{...v(["currentProduction","personMap","taskMap","taskTypeMap"])},methods:{...$(["getEntityTimeLogs"]),getTaskType(t){const e=this.taskMap.get(t.task_id);return this.taskTypeMap.get(e.task_type_id)},reset(){this.isLoading=!0,this.getEntityTimeLogs(this.entity.id).then(t=>{this.logs=t,this.isLoading=!1}).catch(t=>{console.error(t),this.logs=[],this.isLoading=!1})}},watch:{entity(){this.entity&&this.reset()}}},Mt={class:"mt1 wrapper time-logs"},Lt={key:0,class:"has-text-centered"},St={key:1},Pt={class:"datatable"},Et={class:"datatable-head"},It={class:"datatable-row-header"},Ct={class:"date"},zt={class:"person"},Bt={class:"type"},Nt={class:"duration"},Ft={class:"datatable"},Vt={class:"datatable-body"},At={class:"date"},Yt={class:"duration"},Ot={key:2};function Ut(t,e,u,_,d,n){const o=h("spinner"),f=h("people-name-cell"),y=h("task-type-cell");return r(),l("div",Mt,[d.isLoading?(r(),l("div",Lt,[m(o)])):d.logs.length>0?(r(),l("div",St,[s("table",Pt,[s("thead",Et,[s("tr",It,[s("th",Ct,a(t.$t("main.date")),1),s("th",zt,a(t.$t("main.person")),1),s("th",Bt,a(t.$t("entities.preview_files.task_type")),1),s("th",Nt,a(t.$t("tasks.fields.duration")),1),e[0]||(e[0]=s("th",{class:"end-cell"},null,-1))])])]),s("table",Ft,[s("tbody",Vt,[(r(!0),l(g,null,T(d.logs,c=>(r(),l("tr",{key:c.id,class:"datatable-row"},[s("td",At,a(t.formatSimpleDate(c.date)),1),m(f,{class:"person",person:t.personMap.get(c.person_id)},null,8,["person"]),m(y,{class:"type","task-type":n.getTaskType(c),"production-id":t.currentProduction.id},null,8,["task-type","production-id"]),s("td",Yt,a(t.formatDuration(c.duration)),1),e[1]||(e[1]=s("td",{class:"end-cell"},null,-1))]))),128))])])])):(r(),l("div",Ot,a(t.$t("entities.logs.no_logs")),1))])}const me=D(Dt,[["render",Ut],["__scopeId","data-v-635f4737"]]),jt={name:"entity-task-list",mixins:[L],components:{PeopleAvatar:B,TableInfo:W,TaskTypeCell:P,ValidationTag:N},props:{entries:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1}},emits:["task-selected"],data(){return{currentTask:null}},computed:{...v(["currentProduction","getTaskTypePriority","isCurrentUserClient","isCurrentUserVendor","personMap","taskMap","taskTypeMap"]),sortedEntries(){return[...this.entries].sort((t,e)=>{if(!t)return!1;const u=this.taskTypeMap.get(t.task_type_id),_=this.taskTypeMap.get(e.task_type_id),d=this.getTaskTypePriority(t.task_type_id),n=this.getTaskTypePriority(e.task_type_id);return d===n?u.name.localeCompare(_.name,void 0,{numeric:!0}):d-n})}},methods:{onBodyScroll(t){const e=t.target;this.$refs.headerWrapper.style.left=`-${e.scrollLeft}px`},getTask(t){return typeof t=="string"?this.taskMap.get(t):t},getTaskStartDate(t){return t&&t.start_date?t.start_date.substring(0,10):""},getTaskDueDate(t){return t&&t.due_date?t.due_date.substring(0,10):""},getTaskEstimation(t){return t&&t.estimation?this.formatDuration(t.estimation):""},getTaskDuration(t){return t&&t.duration?this.formatDuration(t.duration):""},getTaskType(t){const e=this.getTask(t);return e?this.taskTypeMap.get(e.task_type_id):null},getAssignees(t){const e=this.getTask(t);return e?e.assignees:[]},selectTask(t){var e;t.id===((e=this.currentTask)==null?void 0:e.id)?this.currentTask=null:this.currentTask=t,this.$emit("task-selected",t)}}},Rt={class:"data-list"},Wt={class:"datatable",ref:"headerWrapper"},qt={class:"datatable-head"},Gt={class:"datatable-row-header"},Ht={class:"type"},Kt={class:"status"},Xt={class:"estimation"},Jt={class:"estimation"},Qt={class:"startdate"},Zt={class:"duedate"},xt={class:"assignees"},te={class:"datatable"},ee={class:"datatable-body"},se=["onClick"],ae={class:"status"},ie={class:"estimation"},ne={class:"estimation"},re={class:"startdate"},oe={class:"duedate"},le={class:"assignees"},de={key:0,class:"flexrow"};function ce(t,e,u,_,d,n){const o=h("table-info"),f=h("task-type-cell"),y=h("validation-tag"),c=h("people-avatar");return r(),l("div",Rt,[s("div",null,[s("table",Wt,[s("thead",qt,[s("tr",Gt,[s("th",Ht,a(t.$t("tasks.fields.task_type")),1),s("th",Kt,a(t.$t("tasks.fields.task_status")),1),s("th",Xt,a(t.$t("tasks.fields.estimation").substring(0,3))+". ",1),s("th",Jt,a(t.$t("tasks.fields.duration").substring(0,3))+". ",1),s("th",Qt,a(t.$t("tasks.fields.start_date_short")),1),s("th",Zt,a(t.$t("tasks.fields.due_date")),1),s("th",xt,a(t.$t("tasks.fields.assignees")),1),e[1]||(e[1]=s("th",{class:"end-cell"},null,-1))])])],512)]),m(o,{"is-loading":u.isLoading,"is-error":u.isError},null,8,["is-loading","is-error"]),u.entries.length>0?(r(),l("div",{key:0,class:"task-list-body",onScrollPassive:e[0]||(e[0]=(...i)=>n.onBodyScroll&&n.onBodyScroll(...i))},[s("table",te,[s("tbody",ee,[(r(!0),l(g,null,T(n.sortedEntries,i=>(r(),l("tr",{key:i.id,class:F({selected:d.currentTask&&d.currentTask.id===i.id,"datatable-row":!0,"datatable-row--selectable":!0}),onClick:p=>n.selectTask(i)},[n.getTaskType(i.id)?(r(),w(f,{key:0,class:"type","task-type":n.getTaskType(i.id),"production-id":t.currentProduction.id,"task-id":i.id},null,8,["task-type","production-id","task-id"])):k("",!0),s("td",ae,[n.getTask(i.id)?(r(),w(y,{key:0,task:n.getTask(i.id),"is-static":!0},null,8,["task"])):k("",!0)]),s("td",ie,a(n.getTaskEstimation(i)),1),s("td",ne,a(n.getTaskDuration(i)),1),s("td",re,a(n.getTaskStartDate(i)),1),s("td",oe,a(n.getTaskDueDate(i)),1),s("td",le,[!t.isCurrentUserClient&&!t.isCurrentUserVendor?(r(),l("div",de,[(r(!0),l(g,null,T(n.getAssignees(i),p=>(r(),l("div",{class:"avatar-wrapper",key:p},[(r(),w(c,{class:"person-avatar flexrow-item",key:i.id+"-"+p,person:t.personMap.get(p),size:30,"font-size":15},null,8,["person"]))]))),128))])):k("",!0)]),e[2]||(e[2]=s("td",{class:"end-cell"},null,-1))],10,se))),128))])])],32)):k("",!0)])}const fe=D(jt,[["render",ce],["__scopeId","data-v-ea939c5a"]]);export{_e as E,ye as a,fe as b,me as c,pe as e};
//# sourceMappingURL=EntityTaskList-CAv2swAy.js.map
