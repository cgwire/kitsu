import{_ as Y,aE as j,S as q,P as F,E as X,B as J,r,o as m,c as u,d as l,t as p,f as d,w as G,H as v,F as y,h as g,e as H,g as I,X as c,u as T,bv as k,aR as D,m as h,aa as K,ar as Z,a as Q,b as W}from"./index-DF-DoQlt.js";import{f as $}from"./format-D3oTyBU9.js";import{C as ee}from"./ComboboxDepartment-Cjj8YvK6.js";import{C as te}from"./ComboboxNumber-CceJFOvK.js";import{C as se}from"./ComboboxProduction-BSS6F4qN.js";import{C as ae}from"./ComboboxStudio-D3qg68ZP.js";import{C as oe}from"./ComboboxTaskType-C7Rz0ksS.js";import{D as ne}from"./DateField-BBlawoBq.js";import{D as ie}from"./DepartmentName-DCchDYyW.js";import{P as le}from"./PeopleField-BoranyvF.js";import{S as de}from"./Schedule-CQRPXrDs.js";import{T as re}from"./TaskTypeName-C0px4urt.js";import{T as me}from"./TableInfo-D6xnVb4C.js";import ue from"./TaskInfo-C2DOZkHo.js";import"./dom-tO7tlkHV.js";import"./ModalFooter-Chk0SGv-.js";import"./TextField-BKWlN2Ov.js";import"./list-chevrons-up-down-XSfnSgdq.js";import"./briefcase-CdxHi4GF.js";import"./csv-IlynXFQz.js";import"./string-B0Tq569e.js";import"./PreviewPlayer-Bpr7Jn1C.js";import"./PlaylistPlayer-ByYDRf10.js";import"./ComboboxSimple-B2TmvsnK.js";import"./video-Yn96Kb74.js";import"./clipboard-CQqgyZ_h.js";import"./Combobox-A6pnhVs3.js";import"./ComboboxStyled-BlKJF8gk.js";import"./DeleteModal-DwXK5r5w.js";import"./index-Bnig1aiX.js";import"./BaseModal-D3KB-h7q.js";import"./play-DUQ3D5JY.js";import"./render-DYxr_jus.js";import"./EmojiButton-CJhEAvTS.js";import"./FileUpload-GCzHM4-i.js";import"./ComboboxStatus-CBgYMSHg.js";import"./ConfirmModal-BIIMruUl.js";import"./triangle-alert-CW28Rlrw.js";import"./ValidationTag-Cx26FfxH.js";import"./thumbs-up-UCZcudrF.js";import"./copy-DgQ7ppWI.js";import"./vue.esm-bundler-pS9-uSLU.js";import"./VideoViewer-B89y-Tko.js";import"./BuildFilterModal-C18AF9bI.js";import"./ComboboxBoolean-DT116Lfu.js";import"./DeleteEntities-5LkT8YiQ.js";import"./HardDeleteModal-BLE4oONO.js";import"./SearchField-BdP8lRoc.js";import"./corner-right-up-xDF204hE.js";const x=1,pe={name:"team-schedule",mixins:[$],components:{ButtonSimple:J,ComboboxDepartment:ee,ComboboxNumber:te,ComboboxProduction:se,ComboboxStudio:ae,ComboboxTaskType:oe,DateField:ne,DepartmentName:ie,EntityThumbnail:X,PeopleField:le,ProductionName:F,Schedule:de,Spinner:q,TableInfo:me,TaskInfo:ue,TaskTypeName:re,XIcon:j},data(){return{draggedTasks:[],endDate:h().add(3,"months"),isTaskSidePanelOpen:!1,personDates:{},scheduleItems:[],selectedDepartment:null,selectedEndDate:null,selectedPerson:null,selectedProduction:null,selectedStartDate:null,selectedStudio:null,startDate:h(),unassignedTasks:[],totalUnassignedTasks:0,zoomLevel:x,zoomOptions:[{label:"1",value:1},{label:"2",value:2},{label:"3",value:3},{label:"4",value:4}],loading:{hasMoreUnassignedTasks:!1,unassignedTasks:!1},errors:{unassignedTasks:!1,schedule:!1},filters:{productionId:null,taskTypeId:null},pagination:{unassignedTasks:1}}},mounted(){this.selectedDepartment=this.$route.query.department||void 0,this.selectedStudio=this.$route.query.studio||void 0,this.selectedProduction=this.$route.query.production||void 0;const e=Number(this.$route.query.zoom);this.zoomLevel=this.zoomOptions.map(t=>t.value).includes(e)?e:x,this.init()},computed:{...W(["daysOff","departmentMap","displayedPeople","getProductionTaskTypes","openProductions","organisation","productionMap","taskTypeMap"]),daysOffByPerson(){return this.daysOff.reduce((e,t)=>(e[t.person_id]||(e[t.person_id]=[]),e[t.person_id].push(t),e),{})},selectablePeople(){let e=this.displayedPeople.filter(t=>!t.is_bot);return this.selectedDepartment&&(e=e.filter(t=>t.departments.includes(this.selectedDepartment))),this.selectedStudio&&(e=e.filter(t=>t.studio_id===this.selectedStudio)),this.selectedProduction&&(e=e.filter(t=>this.productionMap.get(this.selectedProduction).team.includes(t.id))),e},productionList(){return this.addAllValue(this.openProductions)},taskTypeList(){const e=this.filters.productionId,t=this.getProductionTaskTypes(e).filter(o=>o.for_entity!=="Concept");return this.addAllValue(t)}},methods:{...Q(["assignSelectedTasks","fetchPersonTasks","getPersonsTasksDates","loadDaysOff","loadOpenTasks","loadPeople","unassignPersonFromTask","updateTask"]),addAllValue(e){return[{id:"",color:"#999",name:this.$t("main.all"),short_name:this.$t("main.all")},...e]},async init(){await this.loadPeople(),await this.loadPersonDates(),await this.loadDaysOff(),this.refreshSchedule(),this.scrollScheduleToToday(),this.startDate=h(),this.endDate=h().add(3,"months"),Object.values(this.personDates).forEach(e=>{e.startDate.isBefore(this.startDate)&&(this.startDate=e.startDate.clone()),e.endDate.isAfter(this.endDate)&&(this.endDate=e.endDate.clone())}),this.selectedStartDate=this.startDate.toDate(),this.selectedEndDate=this.endDate.toDate()},toggleTaskSidePanel(){this.isTaskSidePanelOpen=!this.isTaskSidePanelOpen,this.isTaskSidePanelOpen||(this.unassignedTasks=[],this.errors.unassignedTasks=!1)},async loadUnassignedTasks(e=!1){this.loading.unassignedTasks=!0,this.errors.unassignedTasks=!1;const t=e?this.pagination.unassignedTasks+1:1;try{const{data:o,is_more:i,stats:s}=await this.loadOpenTasks({limit:20,page:t,person_id:"unassigned",project_id:this.filters.productionId,task_type_id:this.filters.taskTypeId});e?this.pagination.unassignedTasks++:this.unassignedTasks=[],this.unassignedTasks=this.unassignedTasks.concat(o.map(n=>({...n,full_name:`${n.entity_type_name} / ${n.entity_name} / ${n.type_name}`,man_days:D(this.organisation,n.estimation),department:this.departmentMap.get(this.taskTypeMap.get(n.task_type_id)?.department_id),production:this.productionMap.get(n.project_id)}))),this.totalUnassignedTasks=s.total,this.loading.hasMoreUnassignedTasks=i}catch(o){this.errors.unassignedTasks=!0,console.error(o)}this.loading.unassignedTasks=!1},async loadPersonDates(e=!1){const t=await this.getPersonsTasksDates();this.personDates={},t.forEach(o=>{this.personDates[o.person_id]={endDate:c(o.max_date),startDate:c(o.min_date)}}),e&&this.scheduleItems.forEach(o=>{const i=this.personDates[o.id];i&&(o.startDate=i.startDate,o.endDate=i.endDate)})},refreshSchedule(){const e=this.selectedPerson?[this.selectedPerson]:this.selectablePeople;this.scheduleItems=this.convertScheduleItems(e)},convertScheduleItems(e){return e.map(t=>{let o=h(),i=h();const s=this.personDates[t.id];return s&&s.startDate&&s.endDate&&(o=c(s.startDate),i=c(s.endDate)),{...t,avatar:!0,color:t.color||Z.fromString(t.name,!0),startDate:o,endDate:i,expanded:!1,loading:!1,editable:!1,route:K(t.id,"schedule"),children:[],daysOff:this.daysOffByPerson[t.id]}})},buildTaskScheduleItem(e,t){let o=h(),i;if(!t.start_date||!t.due_date)return null;t.start_date&&(o=c(t.start_date)),t.due_date?i=c(t.due_date):t.end_date?i=c(t.end_date):t.estimation&&(i=k(t.startDate,Math.ceil(D(this.organisation,t.estimation))-1,t.parentElement.daysOff)),(!i||i.isBefore(o))&&(i=o.clone().add(1,"days"));const s=this.taskTypeMap.get(t.task_type_id);return{...t,name:`${t.full_entity_name} / ${s.name}`,startDate:o,endDate:i,man_days:t.estimation,editable:!0,unresizable:!1,color:s.color,parentElement:e}},saveTaskScheduleItem(e){return this.updateTask({taskId:e.id,data:{start_date:e.startDate.format("YYYY-MM-DD"),due_date:e.endDate.format("YYYY-MM-DD"),estimation:e.estimation}})},onTaskDragStart(e,t){e.stopPropagation(),e.target.classList.add("drag"),e.dataTransfer.dropEffect="move",e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("taskId",t.id),this.draggedTasks=[t]},onTaskDrag(e){e.stopPropagation(),e.target.classList.add("dragging")},onTaskDragEnd(e){e.target.classList.remove("drag"),e.target.classList.remove("dragging"),this.draggedTasks=[]},async onScheduleItemDropped(e,t,o){if(e.type==="Task"){const i=this.buildTaskScheduleItem(t,e);t.children.push(i),t.children.sort(T.firstBy("startDate").thenBy("project_name").thenBy("name")),o&&o(t),await this.assignSelectedTasks({personId:t.id,taskIds:[i.id]}),await this.saveTaskScheduleItem(i),await this.loadUnassignedTasks()}},async onScheduleItemChanged(e){e.type==="Task"&&(e.startDate=k(e.startDate,0,e.parentElement.daysOff),e.estimation&&(e.endDate=k(e.startDate,Math.ceil(D(this.organisation,e.estimation))-1,e.parentElement.daysOff)),await this.saveTaskScheduleItem(e),await this.loadPersonDates(!0),await this.loadDaysOff())},onScheduleItemAssigned(e,t){e.type==="Task"&&(t.children.sort(T.firstBy("startDate").thenBy("project_name").thenBy("name")),this.assignSelectedTasks({personId:t.id,taskIds:[e.id]}))},onScheduleItemUnassigned(e,t){e.type==="Task"&&this.unassignPersonFromTask({person:t,task:e})},async expandPersonElement(e,t){if(e.expanded=!e.expanded,!!e.expanded){e.loading=!0,e.children=[];try{const o=await this.fetchPersonTasks(e.id);e.children=o.map(i=>this.buildTaskScheduleItem(e,i)).filter(Boolean).sort(T.firstBy("startDate").thenBy("project_name").thenBy("name")),t&&t(e)}catch(o){console.error(o)}e.loading=!1}},onUpdateSelectedStartDate(e){this.startDate=c(e)},onUpdateSelectedEndDate(e){this.endDate=c(e)},scrollScheduleToToday(){this.$refs.schedule?.scrollToToday()},updateRoute({department:e,production:t,studio:o,zoom:i}){const s={...this.$route.query};e!==void 0&&(s.department=e||void 0),t!==void 0&&(s.production=t||void 0),o!==void 0&&(s.studio=o||void 0),i!==void 0&&(s.zoom=String(i)),JSON.stringify(s)!==JSON.stringify(this.$route.query)&&this.$router.push({query:s})}},watch:{selectedDepartment(e){this.updateRoute({department:e}),this.selectedPerson&&!this.selectablePeople.includes(this.selectedPerson)&&this.$refs["people-field"].clear(),this.refreshSchedule()},selectedStudio(e){this.updateRoute({studio:e}),this.selectedPerson&&!this.selectablePeople.includes(this.selectedPerson)&&this.$refs["people-field"].clear(),this.refreshSchedule()},selectedPerson(){this.refreshSchedule()},selectedProduction(e){this.updateRoute({production:e}),this.refreshSchedule()},zoomLevel(e){this.updateRoute({zoom:e})},isTaskSidePanelOpen:{immediate:!0,handler(){this.isTaskSidePanelOpen&&this.loadUnassignedTasks()}}},head(){return{title:`${this.$t("team_schedule.title_main")} - Kitsu`}}},ce={class:"columns fixed-page"},he={class:"column main-column"},fe={class:"flexrow date-filters"},ge={class:"flexrow-item"},_e={class:"label"},ye={class:"flexrow-item"},Te={class:"label"},ke={class:"flexrow"},De={class:"flexrow filters"},be={class:"flexrow-item people-filter"},Se={class:"label"},Pe={key:0,class:"column side-column"},ve={class:"mt1"},Ie={class:"mb2"},xe={class:"task-list"},we=["onDragstart"],Ve={class:"ui-droppable unassigned-task"},Ue={class:"flexrow"},Ee={class:"flexrow-item filler"},Oe={class:"ellipsis strong entity-name"},Ce={class:"flexrow"},Be={key:0},Le={key:1},Me={key:0,class:"has-text-centered"},ze={key:1},Ae={key:2},Ne={class:"has-text-centered pa1"},Re={key:3,class:"has-text-centered"};function Ye(e,t,o,i,s,n){const b=r("date-field"),w=r("combobox-number"),_=r("button-simple"),V=r("combobox-studio"),U=r("combobox-department"),S=r("combobox-production"),E=r("people-field"),O=r("schedule"),C=r("x-icon"),B=r("combobox-task-type"),L=r("entity-thumbnail"),M=r("production-name"),z=r("task-type-name"),A=r("department-name"),P=r("spinner"),N=r("table-info"),R=r("task-info");return m(),u("div",ce,[l("div",he,[l("div",fe,[l("div",ge,[l("label",_e,p(e.$t("main.start_date")),1),d(b,{utc:"",modelValue:s.selectedStartDate,"onUpdate:modelValue":[t[0]||(t[0]=a=>s.selectedStartDate=a),n.onUpdateSelectedStartDate]},null,8,["modelValue","onUpdate:modelValue"])]),l("div",ye,[l("label",Te,p(e.$t("main.end_date")),1),d(b,{utc:"",modelValue:s.selectedEndDate,"onUpdate:modelValue":[t[1]||(t[1]=a=>s.selectedEndDate=a),n.onUpdateSelectedEndDate]},null,8,["modelValue","onUpdate:modelValue"])]),d(w,{class:"flexrow-item zoom-level",label:e.$t("schedule.zoom_level"),options:s.zoomOptions,modelValue:s.zoomLevel,"onUpdate:modelValue":t[2]||(t[2]=a=>s.zoomLevel=a)},null,8,["label","options","modelValue"]),t[16]||(t[16]=l("div",{class:"filler"},null,-1)),l("div",ke,[d(_,{class:"flexrow-item",icon:"clock",text:e.$t("schedule.today"),onClick:n.scrollScheduleToToday},null,8,["text","onClick"]),d(_,{active:s.isTaskSidePanelOpen,class:"flexrow-item",icon:"list",text:e.$t("tasks.unassigned_tasks"),onClick:n.toggleTaskSidePanel},null,8,["active","text","onClick"])])]),l("div",De,[d(V,{class:"flexrow-item","all-studios-label":"",label:e.$t("main.studio"),modelValue:s.selectedStudio,"onUpdate:modelValue":t[3]||(t[3]=a=>s.selectedStudio=a)},null,8,["label","modelValue"]),d(U,{class:"flexrow-item","all-departments-label":"",label:e.$t("main.department"),modelValue:s.selectedDepartment,"onUpdate:modelValue":t[4]||(t[4]=a=>s.selectedDepartment=a)},null,8,["label","modelValue"]),d(S,{class:"flexrow-item",label:e.$t("main.production"),"production-list":n.productionList,modelValue:s.selectedProduction,"onUpdate:modelValue":t[5]||(t[5]=a=>s.selectedProduction=a)},null,8,["label","production-list","modelValue"]),l("div",be,[l("label",Se,p(e.$t("main.person")),1),d(E,{ref:"people-field",people:n.selectablePeople,placeholder:e.$t("team_schedule.person_placeholder"),wide:"",modelValue:s.selectedPerson,"onUpdate:modelValue":t[6]||(t[6]=a=>s.selectedPerson=a)},null,8,["people","placeholder","modelValue"])])]),d(O,{ref:"schedule","dragged-items":s.draggedTasks,"end-date":s.endDate,"hide-man-days":!0,hierarchy:s.scheduleItems,"is-error":s.errors.schedule,"is-estimation-linked":!0,multiline:!0,reassignable:!0,"start-date":s.startDate,"with-milestones":!1,"zoom-level":s.zoomLevel,onItemAssign:n.onScheduleItemAssigned,onItemChanged:n.onScheduleItemChanged,onItemDrop:n.onScheduleItemDropped,onItemUnassign:n.onScheduleItemUnassigned,onRootElementExpanded:n.expandPersonElement},null,8,["dragged-items","end-date","hierarchy","is-error","start-date","zoom-level","onItemAssign","onItemChanged","onItemDrop","onItemUnassign","onRootElementExpanded"])]),s.isTaskSidePanelOpen?(m(),u("div",Pe,[d(R,null,{default:G(()=>[l("a",{class:"close-button",onClick:t[7]||(t[7]=(...a)=>n.toggleTaskSidePanel&&n.toggleTaskSidePanel(...a))},[d(C,{class:"align-middle",size:16})]),l("h2",ve,[v(p(e.$t("tasks.unassigned_tasks"))+" ",1),s.loading.unassignedTasks?g("",!0):(m(),u(y,{key:0},[v(" ("+p(s.totalUnassignedTasks)+") ",1)],64))]),l("div",Ie,[d(S,{class:"mb05",label:e.$t("main.production"),"production-list":n.productionList,modelValue:s.filters.productionId,"onUpdate:modelValue":[t[8]||(t[8]=a=>s.filters.productionId=a),t[9]||(t[9]=a=>n.loadUnassignedTasks())]},null,8,["label","production-list","modelValue"]),d(B,{class:"mb05",label:e.$t("news.task_type"),"task-type-list":n.taskTypeList,modelValue:s.filters.taskTypeId,"onUpdate:modelValue":[t[10]||(t[10]=a=>s.filters.taskTypeId=a),t[11]||(t[11]=a=>n.loadUnassignedTasks())]},null,8,["label","task-type-list","modelValue"])]),s.unassignedTasks.length>0?(m(),u(y,{key:0},[l("ul",xe,[(m(!0),u(y,null,H(s.unassignedTasks,a=>(m(),u("li",{class:"task-item",draggable:!0,key:a.id,onDragstart:f=>n.onTaskDragStart(f,a),onDrag:t[12]||(t[12]=(...f)=>n.onTaskDrag&&n.onTaskDrag(...f)),onDragend:t[13]||(t[13]=(...f)=>n.onTaskDragEnd&&n.onTaskDragEnd(...f))},[l("div",Ve,[l("div",Ue,[d(L,{class:"task-thumbnail flexrow-item","preview-file-id":a.entity_preview_file_id,width:150,height:50,"empty-width":100,"empty-height":66},null,8,["preview-file-id"]),l("div",Ee,[d(M,{class:"production-name",production:a.production,"with-avatar":!1},null,8,["production"]),l("div",Oe,p(a.full_name.split(" / ").slice(0,-1).join(" / ")),1),l("div",Ce,[a.man_days?(m(),u("em",Be,p(a.man_days)+" "+p(e.$tc("main.man_days",a.man_days)),1)):(m(),u("em",Le,p(e.$t("main.no_estimation")),1)),t[17]||(t[17]=l("span",{class:"filler"},null,-1)),d(z,{class:"task-type-name","task-type":{id:a.task_type_id,color:a.type_color,name:a.type_name},rounded:"",thin:""},null,8,["task-type"])])])]),a.department?(m(),I(A,{key:0,class:"task-department",department:a.department,"no-padding":"","only-dot":""},null,8,["department"])):g("",!0)])],40,we))),128))]),s.loading.hasMoreUnassignedTasks?(m(),u("div",Me,[s.loading.unassignedTasks?(m(),I(P,{key:0,class:"mt2"})):(m(),u("button",{key:1,class:"button mt2",onClick:t[14]||(t[14]=a=>n.loadUnassignedTasks(!0))},p(e.$t("main.load_more")),1))])):g("",!0)],64)):s.loading.unassignedTasks?(m(),u("div",ze,[d(P,{class:"mt2"})])):s.errors.unassignedTasks?(m(),u("div",Ae,[d(N,{"is-error":""}),l("div",Ne,[d(_,{class:"has-text-centered",text:e.$t("main.reload"),onClick:t[15]||(t[15]=a=>n.loadUnassignedTasks())},null,8,["text"])])])):(m(),u("div",Re,[l("em",null,p(e.$t("main.no_results")),1)]))]),_:1})])):g("",!0)])}const zt=Y(pe,[["render",Ye],["__scopeId","data-v-c76d4bca"]]);export{x as DEFAULT_ZOOM,zt as default};
//# sourceMappingURL=TeamSchedule-BfhcDRYx.js.map
