import{_ as F,m as Y,a as j,bT as R,O as J,H as K,T as X,u as Z,Q as G,P as H,I as Q,E as W,ay as $,ak as ee,K as se,C as te,Z as ae,L as ne,B as oe,z as ie,r,c,o as u,e as l,d as g,f as d,t as m,w as le,a7 as v,F as y,g as de,k as I,aJ as p,p as T,co as k,cq as D,A as h,ba as re,bF as ue}from"./index-C9eTF2EQ.js";import{C as ce}from"./ComboboxStudio-DTiNFEIh.js";const x=1,me={name:"team-schedule",mixins:[ie],components:{ButtonSimple:oe,ComboboxDepartment:ne,ComboboxNumber:ae,ComboboxProduction:te,ComboboxStudio:ce,ComboboxTaskType:se,DateField:ee,DepartmentName:$,EntityThumbnail:W,PeopleField:Q,ProductionName:H,Schedule:G,Spinner:Z,TableInfo:X,TaskInfo:K,TaskTypeName:J,XIcon:R},data(){return{draggedTasks:[],endDate:h().add(3,"months"),isTaskSidePanelOpen:!1,personDates:{},scheduleItems:[],selectedDepartment:null,selectedEndDate:null,selectedPerson:null,selectedProduction:null,selectedStartDate:null,selectedStudio:null,startDate:h(),unassignedTasks:[],totalUnassignedTasks:0,zoomLevel:x,zoomOptions:[{label:"1",value:1},{label:"2",value:2},{label:"3",value:3},{label:"4",value:4}],loading:{hasMoreUnassignedTasks:!1,unassignedTasks:!1},errors:{unassignedTasks:!1,schedule:!1},filters:{productionId:null,taskTypeId:null},pagination:{unassignedTasks:1}}},mounted(){this.selectedDepartment=this.$route.query.department||void 0,this.selectedStudio=this.$route.query.studio||void 0,this.selectedProduction=this.$route.query.production||void 0;const e=Number(this.$route.query.zoom);this.zoomLevel=this.zoomOptions.map(s=>s.value).includes(e)?e:x,this.init()},computed:{...j(["daysOff","departmentMap","displayedPeople","getProductionTaskTypes","openProductions","organisation","productionMap","taskTypeMap"]),daysOffByPerson(){return this.daysOff.reduce((e,s)=>(e[s.person_id]||(e[s.person_id]=[]),e[s.person_id].push(s),e),{})},selectablePeople(){let e=this.displayedPeople.filter(s=>!s.is_bot);return this.selectedDepartment&&(e=e.filter(s=>s.departments.includes(this.selectedDepartment))),this.selectedStudio&&(e=e.filter(s=>s.studio_id===this.selectedStudio)),this.selectedProduction&&(e=e.filter(s=>this.productionMap.get(this.selectedProduction).team.includes(s.id))),e},productionList(){return this.addAllValue(this.openProductions)},taskTypeList(){const e=this.filters.productionId,s=this.getProductionTaskTypes(e).filter(n=>n.for_entity!=="Concept");return this.addAllValue(s)}},methods:{...Y(["assignSelectedTasks","fetchPersonTasks","getPersonsTasksDates","loadDaysOff","loadOpenTasks","loadPeople","unassignPersonFromTask","updateTask"]),addAllValue(e){return[{id:"",color:"#999",name:this.$t("main.all"),short_name:this.$t("main.all")},...e]},async init(){await this.loadPeople(),await this.loadPersonDates(),await this.loadDaysOff(),this.refreshSchedule(),this.scrollScheduleToToday(),this.startDate=h(),this.endDate=h().add(3,"months"),Object.values(this.personDates).forEach(e=>{e.startDate.isBefore(this.startDate)&&(this.startDate=e.startDate.clone()),e.endDate.isAfter(this.endDate)&&(this.endDate=e.endDate.clone())}),this.selectedStartDate=this.startDate.toDate(),this.selectedEndDate=this.endDate.toDate()},toggleTaskSidePanel(){this.isTaskSidePanelOpen=!this.isTaskSidePanelOpen,this.isTaskSidePanelOpen||(this.unassignedTasks=[],this.errors.unassignedTasks=!1)},async loadUnassignedTasks(e=!1){this.loading.unassignedTasks=!0,this.errors.unassignedTasks=!1;const s=e?this.pagination.unassignedTasks+1:1;try{const{data:n,is_more:i,stats:t}=await this.loadOpenTasks({limit:20,page:s,person_id:"unassigned",project_id:this.filters.productionId,task_type_id:this.filters.taskTypeId});e?this.pagination.unassignedTasks++:this.unassignedTasks=[],this.unassignedTasks=this.unassignedTasks.concat(n.map(o=>({...o,full_name:`${o.entity_type_name} / ${o.entity_name} / ${o.type_name}`,man_days:D(this.organisation,o.estimation),department:this.departmentMap.get(this.taskTypeMap.get(o.task_type_id)?.department_id),production:this.productionMap.get(o.project_id)}))),this.totalUnassignedTasks=t.total,this.loading.hasMoreUnassignedTasks=i}catch(n){this.errors.unassignedTasks=!0,console.error(n)}this.loading.unassignedTasks=!1},async loadPersonDates(e=!1){const s=await this.getPersonsTasksDates();this.personDates={},s.forEach(n=>{this.personDates[n.person_id]={endDate:p(n.max_date),startDate:p(n.min_date)}}),e&&this.scheduleItems.forEach(n=>{const i=this.personDates[n.id];i&&(n.startDate=i.startDate,n.endDate=i.endDate)})},refreshSchedule(){const e=this.selectedPerson?[this.selectedPerson]:this.selectablePeople;this.scheduleItems=this.convertScheduleItems(e)},convertScheduleItems(e){return e.map(s=>{let n=h(),i=h();const t=this.personDates[s.id];return t&&t.startDate&&t.endDate&&(n=p(t.startDate),i=p(t.endDate)),{...s,avatar:!0,color:s.color||ue.fromString(s.name,!0),startDate:n,endDate:i,expanded:!1,loading:!1,editable:!1,route:re(s.id,"schedule"),children:[],daysOff:this.daysOffByPerson[s.id]}})},buildTaskScheduleItem(e,s){let n=h(),i;if(!s.start_date||!s.due_date)return null;s.start_date&&(n=p(s.start_date)),s.due_date?i=p(s.due_date):s.end_date?i=p(s.end_date):s.estimation&&(i=k(s.startDate,Math.ceil(D(this.organisation,s.estimation))-1,s.parentElement.daysOff)),(!i||i.isBefore(n))&&(i=n.clone().add(1,"days"));const t=this.taskTypeMap.get(s.task_type_id);return{...s,name:`${s.full_entity_name} / ${t.name}`,startDate:n,endDate:i,man_days:s.estimation,editable:!0,unresizable:!1,color:t.color,parentElement:e}},saveTaskScheduleItem(e){return this.updateTask({taskId:e.id,data:{start_date:e.startDate.format("YYYY-MM-DD"),due_date:e.endDate.format("YYYY-MM-DD"),estimation:e.estimation}})},onTaskDragStart(e,s){e.stopPropagation(),e.target.classList.add("drag"),e.dataTransfer.dropEffect="move",e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("taskId",s.id),this.draggedTasks=[s]},onTaskDrag(e){e.stopPropagation(),e.target.classList.add("dragging")},onTaskDragEnd(e){e.target.classList.remove("drag"),e.target.classList.remove("dragging"),this.draggedTasks=[]},async onScheduleItemDropped(e,s,n){if(e.type==="Task"){const i=this.buildTaskScheduleItem(s,e);s.children.push(i),s.children.sort(T.firstBy("startDate").thenBy("project_name").thenBy("name")),n&&n(s),await this.assignSelectedTasks({personId:s.id,taskIds:[i.id]}),await this.saveTaskScheduleItem(i),await this.loadUnassignedTasks()}},async onScheduleItemChanged(e){e.type==="Task"&&(e.startDate=k(e.startDate,0,e.parentElement.daysOff),e.estimation&&(e.endDate=k(e.startDate,Math.ceil(D(this.organisation,e.estimation))-1,e.parentElement.daysOff)),await this.saveTaskScheduleItem(e),await this.loadPersonDates(!0),await this.loadDaysOff())},onScheduleItemAssigned(e,s){e.type==="Task"&&(s.children.sort(T.firstBy("startDate").thenBy("project_name").thenBy("name")),this.assignSelectedTasks({personId:s.id,taskIds:[e.id]}))},onScheduleItemUnassigned(e,s){e.type==="Task"&&this.unassignPersonFromTask({person:s,task:e})},async expandPersonElement(e,s){if(e.expanded=!e.expanded,!!e.expanded){e.loading=!0,e.children=[];try{const n=await this.fetchPersonTasks(e.id);e.children=n.map(i=>this.buildTaskScheduleItem(e,i)).filter(Boolean).sort(T.firstBy("startDate").thenBy("project_name").thenBy("name")),s&&s(e)}catch(n){console.error(n)}e.loading=!1}},onUpdateSelectedStartDate(e){this.startDate=p(e)},onUpdateSelectedEndDate(e){this.endDate=p(e)},scrollScheduleToToday(){this.$refs.schedule?.scrollToToday()},updateRoute({department:e,studio:s,zoom:n}){const i={...this.$route.query};e!==void 0&&(i.department=e||void 0),s!==void 0&&(i.studio=s||void 0),n!==void 0&&(i.zoom=String(n)),JSON.stringify(i)!==JSON.stringify(this.$route.query)&&this.$router.push({query:i})}},watch:{selectedDepartment(e){this.updateRoute({department:e}),this.selectedPerson&&!this.selectablePeople.includes(this.selectedPerson)&&this.$refs["people-field"].clear(),this.refreshSchedule()},selectedStudio(e){this.updateRoute({studio:e}),this.selectedPerson&&!this.selectablePeople.includes(this.selectedPerson)&&this.$refs["people-field"].clear(),this.refreshSchedule()},selectedPerson(){this.refreshSchedule()},selectedProduction(){this.updateRoute({production_id:this.selectedProduction}),this.refreshSchedule()},zoomLevel(e){this.updateRoute({zoom:e})},isTaskSidePanelOpen:{immediate:!0,handler(){this.isTaskSidePanelOpen&&this.loadUnassignedTasks()}}},head(){return{title:`${this.$t("team_schedule.title_main")} - Kitsu`}}},pe={class:"columns fixed-page"},he={class:"column main-column"},fe={class:"flexrow date-filters"},ge={class:"flexrow-item"},_e={class:"label"},ye={class:"flexrow-item"},Te={class:"label"},ke={class:"flexrow"},De={class:"flexrow filters"},be={class:"flexrow-item people-filter"},Se={class:"label"},Pe={key:0,class:"column side-column"},ve={class:"mt1"},Ie={class:"mb2"},xe={class:"task-list"},we=["onDragstart"],Ve={class:"ui-droppable unassigned-task"},Ue={class:"flexrow"},Ee={class:"flexrow-item filler"},Oe={class:"ellipsis strong entity-name"},Be={class:"flexrow"},Ce={key:0},Le={key:1},ze={key:0,class:"has-text-centered"},Me={key:1},Ae={key:2},Ne={class:"has-text-centered pa1"},qe={key:3,class:"has-text-centered"};function Fe(e,s,n,i,t,o){const b=r("date-field"),w=r("combobox-number"),_=r("button-simple"),V=r("combobox-studio"),U=r("combobox-department"),S=r("combobox-production"),E=r("people-field"),O=r("schedule"),B=r("x-icon"),C=r("combobox-task-type"),L=r("entity-thumbnail"),z=r("production-name"),M=r("task-type-name"),A=r("department-name"),P=r("spinner"),N=r("table-info"),q=r("task-info");return u(),c("div",pe,[l("div",he,[l("div",fe,[l("div",ge,[l("label",_e,m(e.$t("main.start_date")),1),d(b,{utc:"",modelValue:t.selectedStartDate,"onUpdate:modelValue":[s[0]||(s[0]=a=>t.selectedStartDate=a),o.onUpdateSelectedStartDate]},null,8,["modelValue","onUpdate:modelValue"])]),l("div",ye,[l("label",Te,m(e.$t("main.end_date")),1),d(b,{utc:"",modelValue:t.selectedEndDate,"onUpdate:modelValue":[s[1]||(s[1]=a=>t.selectedEndDate=a),o.onUpdateSelectedEndDate]},null,8,["modelValue","onUpdate:modelValue"])]),d(w,{class:"flexrow-item zoom-level",label:e.$t("schedule.zoom_level"),options:t.zoomOptions,modelValue:t.zoomLevel,"onUpdate:modelValue":s[2]||(s[2]=a=>t.zoomLevel=a)},null,8,["label","options","modelValue"]),s[16]||(s[16]=l("div",{class:"filler"},null,-1)),l("div",ke,[d(_,{class:"flexrow-item",icon:"clock",text:e.$t("schedule.today"),onClick:o.scrollScheduleToToday},null,8,["text","onClick"]),d(_,{active:t.isTaskSidePanelOpen,class:"flexrow-item",icon:"list",text:e.$t("tasks.unassigned_tasks"),onClick:o.toggleTaskSidePanel},null,8,["active","text","onClick"])])]),l("div",De,[d(V,{class:"flexrow-item",label:e.$t("main.studio"),modelValue:t.selectedStudio,"onUpdate:modelValue":s[3]||(s[3]=a=>t.selectedStudio=a)},null,8,["label","modelValue"]),d(U,{class:"flexrow-item",label:e.$t("main.department"),modelValue:t.selectedDepartment,"onUpdate:modelValue":s[4]||(s[4]=a=>t.selectedDepartment=a)},null,8,["label","modelValue"]),d(S,{class:"flexrow-item",label:e.$t("main.production"),"production-list":o.productionList,modelValue:t.selectedProduction,"onUpdate:modelValue":s[5]||(s[5]=a=>t.selectedProduction=a)},null,8,["label","production-list","modelValue"]),l("div",be,[l("label",Se,m(e.$t("main.person")),1),d(E,{ref:"people-field",people:o.selectablePeople,placeholder:e.$t("team_schedule.person_placeholder"),wide:"",modelValue:t.selectedPerson,"onUpdate:modelValue":s[6]||(s[6]=a=>t.selectedPerson=a)},null,8,["people","placeholder","modelValue"])])]),d(O,{ref:"schedule","dragged-items":t.draggedTasks,"end-date":t.endDate,"hide-man-days":!0,hierarchy:t.scheduleItems,"is-error":t.errors.schedule,"is-estimation-linked":!0,multiline:!0,reassignable:!0,"start-date":t.startDate,"with-milestones":!1,"zoom-level":t.zoomLevel,onItemAssign:o.onScheduleItemAssigned,onItemChanged:o.onScheduleItemChanged,onItemDrop:o.onScheduleItemDropped,onItemUnassign:o.onScheduleItemUnassigned,onRootElementExpanded:o.expandPersonElement},null,8,["dragged-items","end-date","hierarchy","is-error","start-date","zoom-level","onItemAssign","onItemChanged","onItemDrop","onItemUnassign","onRootElementExpanded"])]),t.isTaskSidePanelOpen?(u(),c("div",Pe,[d(q,null,{default:le(()=>[l("a",{class:"close-button",onClick:s[7]||(s[7]=(...a)=>o.toggleTaskSidePanel&&o.toggleTaskSidePanel(...a))},[d(B,{class:"align-middle",size:16})]),l("h2",ve,[v(m(e.$t("tasks.unassigned_tasks"))+" ",1),t.loading.unassignedTasks?g("",!0):(u(),c(y,{key:0},[v(" ("+m(t.totalUnassignedTasks)+") ",1)],64))]),l("div",Ie,[d(S,{class:"mb05",label:e.$t("main.production"),"production-list":o.productionList,modelValue:t.filters.productionId,"onUpdate:modelValue":[s[8]||(s[8]=a=>t.filters.productionId=a),s[9]||(s[9]=a=>o.loadUnassignedTasks())]},null,8,["label","production-list","modelValue"]),d(C,{class:"mb05",label:e.$t("news.task_type"),"task-type-list":o.taskTypeList,modelValue:t.filters.taskTypeId,"onUpdate:modelValue":[s[10]||(s[10]=a=>t.filters.taskTypeId=a),s[11]||(s[11]=a=>o.loadUnassignedTasks())]},null,8,["label","task-type-list","modelValue"])]),t.unassignedTasks.length>0?(u(),c(y,{key:0},[l("ul",xe,[(u(!0),c(y,null,de(t.unassignedTasks,a=>(u(),c("li",{class:"task-item",draggable:!0,key:a.id,onDragstart:f=>o.onTaskDragStart(f,a),onDrag:s[12]||(s[12]=(...f)=>o.onTaskDrag&&o.onTaskDrag(...f)),onDragend:s[13]||(s[13]=(...f)=>o.onTaskDragEnd&&o.onTaskDragEnd(...f))},[l("div",Ve,[l("div",Ue,[d(L,{class:"task-thumbnail flexrow-item","preview-file-id":a.entity_preview_file_id,width:150,height:50,"empty-width":100,"empty-height":66},null,8,["preview-file-id"]),l("div",Ee,[d(z,{class:"production-name",production:a.production,"with-avatar":!1},null,8,["production"]),l("div",Oe,m(a.full_name.split(" / ").slice(0,-1).join(" / ")),1),l("div",Be,[a.man_days?(u(),c("em",Ce,m(a.man_days)+" "+m(e.$tc("main.man_days",a.man_days)),1)):(u(),c("em",Le,m(e.$t("main.no_estimation")),1)),s[17]||(s[17]=l("span",{class:"filler"},null,-1)),d(M,{class:"task-type-name","task-type":{id:a.task_type_id,color:a.type_color,name:a.type_name},rounded:"",thin:""},null,8,["task-type"])])])]),a.department?(u(),I(A,{key:0,class:"task-department",department:a.department,"no-padding":"","only-dot":""},null,8,["department"])):g("",!0)])],40,we))),128))]),t.loading.hasMoreUnassignedTasks?(u(),c("div",ze,[t.loading.unassignedTasks?(u(),I(P,{key:0,class:"mt2"})):(u(),c("button",{key:1,class:"button mt2",onClick:s[14]||(s[14]=a=>o.loadUnassignedTasks(!0))},m(e.$t("main.load_more")),1))])):g("",!0)],64)):t.loading.unassignedTasks?(u(),c("div",Me,[d(P,{class:"mt2"})])):t.errors.unassignedTasks?(u(),c("div",Ae,[d(N,{"is-error":""}),l("div",Ne,[d(_,{class:"has-text-centered",text:e.$t("main.reload"),onClick:s[15]||(s[15]=a=>o.loadUnassignedTasks())},null,8,["text"])])])):(u(),c("div",qe,[l("em",null,m(e.$t("main.no_results")),1)]))]),_:1})])):g("",!0)])}const Re=F(me,[["render",Fe],["__scopeId","data-v-9979ee37"]]);export{x as DEFAULT_ZOOM,Re as default};
//# sourceMappingURL=TeamSchedule-D2xYLwHJ.js.map
