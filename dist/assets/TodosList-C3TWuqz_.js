import{_ as V,R as O,r as p,o as l,c as d,d as c,g,h as u,t as r,E as X,y as L,X as j,m as y,Y as C,bG as z,aG as P,bH as B,bA as A,s as I,a as F,b as Y,i as w,F as _,e as T,n as G,f as b,w as W,H as M}from"./index-C2m_IhNF.js";import{d as J}from"./dom-tO7tlkHV.js";import{d as Q}from"./BuildFilterModal-C3nrV5vY.js";import{f as Z}from"./format-CUjWrpVJ.js";import{M as $,s as ee}from"./MetadataHeader-BasyloSw.js";import{D as te}from"./DescriptionCell-JDDrCWCB.js";import{a as se}from"./render-Bqw3AFAH.js";import{P as ae}from"./ProductionNameCell-Bu7vB3PB.js";import{T as ie}from"./TaskTypeCell-DM2gnWrD.js";import{T as oe}from"./TableInfo-B2X54z7i.js";import{V as ne}from"./ValidationCell-D9FwmVzb.js";import{D as le}from"./DateField-OvNA3wsX.js";const de={name:"last-comment-cell",emits:["click"],components:{PeopleAvatar:O},data(){return{timeout:null}},props:{task:{type:Object,required:!0}},computed:{commentText(){const e=this.task.last_comment.text,s=140;let t=e||"";return e!==void 0&&e.length>s&&(t=e.slice(0,s)+"..."),t}},methods:{renderMarkdown:se}},re={class:"flexrow"},ce=["innerHTML"],me={key:2,class:"flexrow-item last-comment no-comment"};function ue(e,s,t,o,i,a){const f=p("people-avatar");return l(),d("td",{onClick:s[0]||(s[0]=h=>e.$emit("click"))},[c("div",re,[t.task.last_comment.person?(l(),g(f,{key:0,class:"flexrow-item avatar-wrapper",size:25,"font-size":14,person:t.task.last_comment.person,"is-link":!1},null,8,["person"])):u("",!0),a.commentText&&a.commentText.length>0?(l(),d("span",{key:1,class:"flexrow-item last-comment pointer",innerHTML:a.renderMarkdown(a.commentText)},null,8,ce)):t.task.last_comment.person?(l(),d("span",me,r(e.$t("main.empty_comment")),1)):u("",!0)])])}const he=V(de,[["render",ue],["__scopeId","data-v-5ab3e5d1"]]),pe="/assets/empty_todo-DRNJ3Abm.png",fe={name:"todos-list",mixins:[J,Z,ee,Q],components:{EntityThumbnail:X,DateField:le,DescriptionCell:te,LastCommentCell:he,MetadataHeader:$,PeopleAvatar:O,ProductionNameCell:ae,TableInfo:oe,TaskTypeCell:ie,ValidationCell:ne},props:{done:{type:Boolean,default:!1},tasks:{type:Array,default:()=>[]},isError:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},isToCheck:{type:Boolean,default:!1},emptyText:{type:String,default:""},disabledDates:{type:Object,default:()=>{}}},emits:["scroll","task-selected"],data(){return{colTypePosX:"",colNamePosX:"",lastSelection:null,selectionGrid:{},selectedDate:y().toDate()}},mounted(){this.resizeHeaders(),window.addEventListener("keydown",this.onKeyDown,!1),this.$refs["th-prod"]&&(this.colTypePosX=this.$refs["th-prod"].offsetWidth+"px",this.colNamePosX=this.$refs["th-prod"].offsetWidth+this.$refs["th-type"].offsetWidth+"px")},beforeUnmount(){window.removeEventListener("keydown",this.onKeyDown)},computed:{...Y(["nbSelectedTasks","selectedTasks","openProductions","personMap","productionMap","taskMap","taskTypeMap","user","isCurrentUserManager","isCurrentUserSupervisor"]),displayedTasks(){return this.tasks},isEditable(){return this.isCurrentUserManager||this.isCurrentUserSupervisor},isDescriptionPresent(){return this.tasks.some(e=>e.entity_description&&e.entity_description.length>0)},metadataDescriptorsMap(){const e={};return this.isToCheck||this.openProductions.forEach(s=>{s.descriptors.forEach(t=>{if(this.user.departments.some(i=>t.departments.includes(i))){t.field_name in e||(e[t.field_name]={});const i=e[t.field_name];t.entity_type in i||(i[t.entity_type]={}),i[t.entity_type][s.id]=t}})}),e},timeSpent(){return this.displayedTasks.reduce((e,s)=>e+s.duration,0)},timeEstimated(){return this.displayedTasks.reduce((e,s)=>e+s.estimation,0)},isEpisodeVisible(){return this.displayedTasks.some(e=>e.source_id||e.episode_names?.length>0||!["Shot","Sequence","Edit"].includes(e.entity_type_name)&&e.episode_id)}},methods:{...F(["addSelectedTask","addSelectedTasks","clearSelectedTasks","removeSelectedTask","updateTask"]),assetEpisodes(e,s){if(["Episode","Sequence","Shot","Edit"].includes(e.entity_type_name))return"";const t=e.episode_name||"MP",o=(e.episode_names||[]).filter(a=>a!==t);let i="";return o.length>2?s?i=o.join(", "):i=o.slice(0,2).join(", ")+", ...":o.length>0&&(i=o.join(", ")),o.length>0?t+", "+i:t},getSortedPeople(e){const s=e.map(t=>this.personMap.get(t));return I(s)},setScrollPosition(e){this.$refs.body&&(this.$refs.body.scrollTop=e)},getDate(e){return e?y(e,"YYYY-MM-DD").toDate():null},formatDate(e){return e?C(e):""},onBodyScroll(e){if(!this.$refs.body)return;const s=e.target;this.$emit("scroll",s.scrollTop)},getTaskType(e){const s={...this.taskTypeMap.get(e.task_type_id)},t=this.productionMap.get(e.project_id);return s.episode_id=e.episode_id,t&&t.production_type==="tvshow"&&!e.episode_id&&(s.episode_id=t.first_episode_id),s},entityPath(e){const s=e.sequence_name?"shot":"asset",t={name:s,params:{production_id:e.project_id}};s==="asset"?t.params.asset_id=e.entity_id:t.params.shot_id=e.entity_id;const o=this.productionMap.get(e.project_id);let i=e.episode_id;return o&&o.production_type==="tvshow"&&!i&&(s==="shot"?i=o.first_episode_id:i="main"),i&&(t.name=`episode-${s}`,t.params.episode_id=i),t},onKeyDown(e){if(this.tasks.length>0&&e.altKey){let s=this.lastSelection?this.lastSelection:0;[37,38].includes(e.keyCode)?(s=s-1<0?this.tasks.length-1:s-1,this.selectTask({},s,this.tasks[s]),this.pauseEvent(e)):[39,40].includes(e.keyCode)&&(s=s+1>=this.tasks.length?0:s+1,this.selectTask({},s,this.tasks[s]),this.pauseEvent(e))}},scrollToValidationCell(e){if(e){const t=e.$el.getBoundingClientRect(),o=this.$refs.body.getBoundingClientRect(),i=t.bottom>o.bottom-20,a=t.top<o.top+20,f=t.right>o.right-20,h=t.left<o.left+20;if(i){const k=t.bottom-o.bottom+20;this.setScrollPosition(this.$refs.body.scrollTop+k)}else if(a){const k=o.top-t.top+20;this.setScrollPosition(this.$refs.body.scrollTop-k)}if(f){const k=t.right-o.right+20;this.setScrollLeftPosition(this.$refs.body.scrollLeft+k)}else if(h){const k=o.left-t.left+20;this.setScrollLeftPosition(this.$refs.body.scrollLeft-k)}}},select(e,s){const t="validation-"+e+"-"+s,o=this.$refs[t];return o&&o[0].$el.click(),o?o[0]:0},resizeHeaders(){const e=this.$refs["body-tbody"];if(e&&e.children){const t=e.children[0];[{index:1,name:"type"},{index:3,name:"name"}].forEach(i=>{const a=Math.max(t.children[i.index].offsetWidth,100);this.$refs["th-"+i.name].style["min-width"]=`${a}px`})}},mergeMetadataDescriptors(e){const s=Object.keys(e)[0],t=Object.keys(e[s])[0],o={departments:[],field_name:e[s][t].field_name,name:e[s][t].name};return Object.keys(e).forEach(i=>Object.keys(e[i]).forEach(a=>{o.departments=[...new Set([...e[i][a].departments,...o.departments])]})),o},getMetadataDescriptor(e,s){const t=s.task_type_for_entity,o=s.project_id;return this.metadataDescriptorsMap[e]&&this.metadataDescriptorsMap[e][t]&&this.metadataDescriptorsMap[e][t][o]?this.metadataDescriptorsMap[e][t][o]:null},isTaskChanged(e,s){const t=e.start_date?e.start_date.substring(0,10):"",o=e.due_date?e.due_date.substring(0,10):"";return s.start_date!==void 0&&t!==s.start_date||s.due_date!==void 0&&o!==s.due_date||s.estimation!==void 0&&e.estimation!==s.estimation},isEstimationBurned(e){return this.isToCheck&&e.estimation>0&&e.duration>e.estimation},updateEstimation(e){const s=this.organisation.format_duration_in_hours?e*60:A(this.organisation,e);this.updateTasksEstimation({estimation:s})},updateTasksEstimation({estimation:e}){Object.keys(this.selectionGrid).forEach(s=>{const t=this.taskMap.get(s);let o={estimation:e};if(t.start_date){const i=y(t.start_date),a=t.due_date?y(t.due_date):null;o=B(this.organisation,i,a,P(this.organisation,e)),o.estimation=e}this.isTaskChanged(t,o)&&this.updateTask({taskId:s,data:o}).catch(console.error)})},updateStartDate(e){Object.keys(this.selectionGrid).forEach(s=>{const t=this.taskMap.get(s),o=t.due_date?j(t.due_date):null;let i;if(e){const a=y(e);if(t.start_date&&t.start_date.substring(0,10)===C(a))return;i=B(this.organisation,a,o,P(this.organisation,t.estimation))}else i={start_date:null,due_date:t.due_date};this.isTaskChanged(t,i)&&this.updateTask({taskId:s,data:i}).catch(console.error)})},updateDueDate(e){Object.keys(this.selectionGrid).forEach(s=>{const t=this.taskMap.get(s),o=t.start_date?j(t.start_date):null;let i;if(e){const a=y(e);if(t.due_date&&t.due_date.substring(0,10)===C(a))return;i=z(this.organisation,o,a,P(this.organisation,t.estimation))}else i={start_date:t.start_date,due_date:null};this.isTaskChanged(t,i)&&this.updateTask({taskId:s,data:i}).catch(console.error)})},selectTask(e,s,t){if(e&&e.target&&(["INPUT"].includes(e.target.nodeName)||e.target.className.indexOf("selected-line")>=0||e.target.className.indexOf("down-icon")>=0||e.target.className.indexOf("c-mask")>=0||e.target.className.indexOf("option-line")>=0||e.target.className.indexOf("combobox")>=0||e.target.parentNode&&["HEADER"].includes(e.target.parentNode.nodeName)||["cell day selected"].includes(e.target.className)))return;const o=this.selectionGrid[t.id],i=Object.keys(this.selectionGrid).length>1;if(e&&!(e.ctrlKey||e.metaKey)&&!e.shiftKey&&(this.clearSelectedTasks(),this.resetSelection()),e&&!e.shiftKey)o&&!i?(this.removeSelectedTask({task:t}),this.selectionGrid[t.id]=void 0):(!o||i)&&(this.addSelectedTask({task:t}),this.$emit("task-selected",t),this.selectionGrid[t.id]=!0,this.lastSelection=s);else{this.selectionGrid={};const f=(this.lastSelection>s?L(s,this.lastSelection):L(this.lastSelection,s)).map(h=>({task:this.tasks[h]}));f.forEach(h=>{this.selectionGrid[h.task.id]=!0}),this.addSelectedTasks(f)}this.scrollToLine(t.id)},resetSelection(){this.selectionGrid={},this.lastSelection=null},scrollToLine(e){const s=this.$refs[`task-${e}`];if(s&&this.$refs.body){const o=s[0].getBoundingClientRect(),i=this.$refs.body.getBoundingClientRect(),a=o.bottom>i.bottom-30,f=o.top<i.top+30;if(a){const h=o.bottom-i.bottom+30;this.setScrollPosition(this.$refs.body.scrollTop+h)}else if(f){const h=i.top-o.top+30;this.setScrollPosition(this.$refs.body.scrollTop-h)}}}},watch:{tasks(){this.resetSelection()},nbSelectedTasks(){this.nbSelectedTasks===0&&this.resetSelection()}}},_e={class:"data-list task-list"},ke={key:0,class:"datatable"},ge={class:"datatable-head"},ye={key:0,scope:"col",class:"episode"},be={key:2,class:"description",scope:"col"},De=["title"],Te={scope:"col",class:"duration number-cell"},Se={key:3,scope:"col",class:"start-date"},we={scope:"col",class:"due-date"},Me={scope:"col",class:"status"},Ee={key:0,scope:"col",class:"last-comment"},Ce={key:1,scope:"col",class:"end-date"},Pe={key:5,class:"actions"},ve={key:0,class:"datatable-body"},Le=["onClick"],je={class:"production datatable-row-header datatable-row-header--nobd",scope:"row"},Be={class:"flexrow"},Ge={key:0,class:"episode"},Ve=["title"],Oe={key:2,class:"assignees"},Re={class:"avatars"},Ne={class:"estimation number-cell"},xe=["value"],Ue={key:3,class:"start-date"},qe={class:"due-date"},He={key:0},Ke={key:0},Xe=["id","checked"],ze=["for"],Ae={key:1},Ie={key:1,class:"end-date"},Fe={key:5,class:"actions"},Ye={key:0,class:"has-text-centered empty-list"},We={key:1,class:"has-text-centered footer-info"};function Je(e,s,t,o,i,a){const f=p("metadata-header"),h=p("production-name-cell"),k=p("task-type-cell"),R=p("entity-thumbnail"),N=p("router-link"),x=p("description-cell"),U=p("people-avatar"),v=p("date-field"),q=p("validation-cell"),H=p("last-comment-cell"),K=p("table-info");return l(),d("div",_e,[c("div",{class:"datatable-wrapper",ref:"body",onScrollPassive:s[1]||(s[1]=(...n)=>a.onBodyScroll&&a.onBodyScroll(...n))},[t.isLoading?u("",!0):(l(),d("table",ke,[c("thead",ge,[c("tr",null,[c("th",{scope:"col",class:"production datatable-row-header datatable-row-header--nobd",ref:"th-prod"},r(e.$t("tasks.fields.production")),513),c("th",{scope:"col",class:"type datatable-row-header datatable-row-header--nobd",ref:"th-type",style:w({left:i.colTypePosX})},r(e.$t("tasks.fields.task_type")),5),c("th",{scope:"col",class:"name datatable-row-header",ref:"th-name",style:w({left:i.colNamePosX})},r(e.$t("tasks.fields.entity")),5),a.isEpisodeVisible?(l(),d("th",ye,r(e.$t("assets.fields.episode")),1)):u("",!0),t.isToCheck?(l(),d("th",{key:1,class:"assignees",ref:"th-assignees"},r(e.$t("tasks.fields.assignees")),513)):u("",!0),a.isDescriptionPresent&&!t.isToCheck?(l(),d("th",be,r(e.$t("assets.fields.description")),1)):u("",!0),c("th",{scope:"col",class:"estimation",title:e.$t("main.estimation")},r(e.$t("main.estimation_short")),9,De),c("th",Te,r(e.$t("tasks.fields.duration").substring(0,3))+". ",1),t.isToCheck?u("",!0):(l(),d("th",Se,r(e.$t("tasks.fields.start_date_short")),1)),c("th",we,r(e.$t("tasks.fields.due_date")),1),(l(!0),d(_,null,T(Object.keys(a.metadataDescriptorsMap),n=>(l(),g(f,{key:"desc-header"+n,descriptor:a.mergeMetadataDescriptors(a.metadataDescriptorsMap[n]),"no-menu":!0},null,8,["descriptor"]))),128)),c("th",Me,r(e.$t("tasks.fields.task_status")),1),t.isToCheck?(l(),d("th",Pe)):(l(),d(_,{key:4},[t.done?(l(),d("th",Ce,r(e.$t("tasks.fields.end_date")),1)):(l(),d("th",Ee,r(e.$t("tasks.fields.last_comment")),1))],64))])]),t.tasks.length>0?(l(),d("tbody",ve,[(l(!0),d(_,null,T(a.displayedTasks,(n,S)=>(l(),d("tr",{key:n+"-"+S,class:G(["datatable-row datatable-row--selectable",{selected:i.selectionGrid[n.id]}]),onClick:m=>a.selectTask(m,S,n)},[c("td",je,[b(h,{"is-tooltip":!0,entry:e.productionMap.get(n.project_id),"only-avatar":!0,"is-link":!1},null,8,["entry"])]),b(k,{class:"type datatable-row-header datatable-row-header--nobd","production-id":n.project_id,"task-type":a.getTaskType(n),style:w({left:i.colTypePosX}),"is-link":!1},null,8,["production-id","task-type","style"]),c("td",{class:"name datatable-row-header",style:w({left:i.colNamePosX})},[c("div",Be,[b(R,{"empty-width":60,"empty-height":40,entity:{preview_file_id:n.entity_preview_file_id}},null,8,["entity"]),b(N,{class:"entity-name",to:a.entityPath(n)},{default:W(()=>[M(r(n.full_entity_name),1)]),_:2},1032,["to"])])],4),a.isEpisodeVisible?(l(),d("td",Ge,[c("div",{class:"flexrow",title:a.assetEpisodes(n,!0)},r(a.assetEpisodes(n,!1)),9,Ve)])):u("",!0),a.isDescriptionPresent&&!t.isToCheck?(l(),g(x,{key:1,class:"description",entry:{description:n.entity_description}},null,8,["entry"])):u("",!0),t.isToCheck?(l(),d("td",Oe,[c("div",Re,[(l(!0),d(_,null,T(a.getSortedPeople(n.assignees),m=>(l(),g(U,{key:`${n.id}-${m.id}`,person:m,size:30,"font-size":16},null,8,["person"]))),128))])])):u("",!0),c("td",Ne,[a.isEditable&&i.selectionGrid[n.id]?(l(),d("input",{key:0,class:"input",min:"0",step:"any",type:"number",value:e.formatDuration(n.estimation,!1),onChange:s[0]||(s[0]=m=>a.updateEstimation(m.target.value))},null,40,xe)):(l(),d(_,{key:1},[M(r(e.formatDuration(n.estimation)),1)],64))]),c("td",{class:G(["duration number-cell",{error:a.isEstimationBurned(n)}])},r(e.formatDuration(n.duration)),3),t.isToCheck?u("",!0):(l(),d("td",Ue,[a.isEditable&&i.selectionGrid[n.id]?(l(),g(v,{key:0,class:"flexrow-item","min-date":t.disabledDates,"model-value":a.getDate(n.start_date),"with-margin":!1,"onUpdate:modelValue":a.updateStartDate},null,8,["min-date","model-value","onUpdate:modelValue"])):(l(),d(_,{key:1},[M(r(a.formatDate(n.start_date)),1)],64))])),c("td",qe,[a.isEditable&&i.selectionGrid[n.id]?(l(),g(v,{key:0,class:"flexrow-item","min-date":t.disabledDates,"model-value":a.getDate(n.due_date),"with-margin":!1,"onUpdate:modelValue":a.updateDueDate},null,8,["min-date","model-value","onUpdate:modelValue"])):(l(),d(_,{key:1},[M(r(a.formatDate(n.due_date)),1)],64))]),(l(!0),d(_,null,T(Object.keys(a.metadataDescriptorsMap),m=>(l(),d("td",{class:"metadata-descriptor",key:"desc-"+n.id+"-"+m},[n.entity_data&&a.getMetadataDescriptor(m,n)?(l(),d("div",He,[e.getDescriptorChecklistValues(a.getMetadataDescriptor(m,n)).length>0?(l(),d("div",Ke,[(l(!0),d(_,null,T(e.getDescriptorChecklistValues(a.getMetadataDescriptor(m,n)),(D,E)=>(l(),d("p",{key:`${n.id}-
                    ${a.getMetadataDescriptor(m,n).id}
                    -${E}-${D.text}-div`},[c("input",{type:"checkbox",disabled:"",id:`${n.id}
                      -${a.getMetadataDescriptor(m,n).id}
                      -${E}-${D.text}-input`,checked:e.getMetadataChecklistValues(a.getMetadataDescriptor(m,n),n)[D.text]},null,8,Xe),c("label",{style:{cursor:"pointer"},for:`${n.id}
                      -${a.getMetadataDescriptor(m,n).id}
                      -${E}-${D.text}-input`},r(D.text),9,ze)]))),128))])):(l(),d("p",Ae,r(e.getMetadataFieldValue(a.getMetadataDescriptor(m,n),n)),1))])):u("",!0)]))),128)),b(q,{class:"status unselectable",ref_for:!0,ref:"validation-"+S+"-0",clickable:!1,column:n.taskStatus,"column-y":0,"is-assignees":!1,"is-border":!1,"row-x":S,selected:i.selectionGrid[n.id],"task-test":n},null,8,["column","row-x","selected","task-test"]),t.isToCheck?(l(),d("th",Fe)):(l(),d(_,{key:4},[t.done?(l(),d("td",Ie,r(a.formatDate(n.end_date)),1)):(l(),g(H,{key:0,class:"last-comment",task:n},null,8,["task"]))],64))],10,Le))),128))])):u("",!0)]))],544),b(K,{"is-loading":t.isLoading,"is-error":t.isError},null,8,["is-loading","is-error"]),t.tasks.length===0&&!t.isLoading?(l(),d("div",Ye,[s[2]||(s[2]=c("p",null,[c("img",{src:pe})],-1)),c("p",null,r(t.emptyText),1)])):u("",!0),t.tasks.length&&!t.isLoading?(l(),d("p",We,r(t.tasks.length)+" "+r(e.$tc("tasks.tasks",t.tasks.length))+" ("+r(e.formatDuration(a.timeSpent))+" "+r(e.isDurationInHours?e.$tc("main.hours_spent",e.formatDuration(a.timeSpent,!1)):e.$tc("main.days_spent",e.formatDuration(a.timeSpent,!1)))+" / "+r(e.formatDuration(a.timeEstimated))+" "+r(e.isDurationInHours?e.$tc("main.hours_estimated",e.formatDuration(a.timeEstimated,!1)):e.$tc("main.days_estimated",e.formatDuration(a.timeEstimated,!1)))+" ) ",1)):u("",!0)])}const rt=V(fe,[["render",Je],["__scopeId","data-v-48b88676"]]);export{rt as T};
//# sourceMappingURL=TodosList-C3TWuqz_.js.map
