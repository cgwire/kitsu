import{_ as A,s as N,B as Y,al as j,M as q,a as F,G as R,ah as J,as as G,E as W,I as K,i as X,W as H,x as Q,T as Z,J as $,z as h,m as ee,b as se,cV as y,cd as p,bA as te,cW as ae,cX as P,aE as k,r,o as u,c,e as i,t as m,f as d,w as ne,a3 as v,F as D,d as f,g as oe,A as le,l as b}from"./index-a83mlrHR.js";import{C as ie}from"./ComboboxStudio-C-gA3FSB.js";const de={name:"team-schedule",mixins:[N],components:{ButtonSimple:Y,ComboboxDepartment:j,ComboboxNumber:q,ComboboxProduction:F,ComboboxStudio:ie,ComboboxTaskType:R,DateField:J,DepartmentName:G,EntityThumbnail:W,PeopleField:K,ProductionName:X,Schedule:H,Spinner:Q,TableInfo:Z,TaskInfo:$},data(){return{draggedTasks:[],endDate:h().add(3,"months"),isTaskSidePanelOpen:!1,personDates:{},scheduleItems:[],selectedDepartment:null,selectedEndDate:null,selectedPerson:null,selectedStartDate:null,selectedStudio:null,startDate:h(),unassignedTasks:[],totalUnassignedTasks:0,zoomLevel:1,zoomOptions:[{label:"1",value:1},{label:"2",value:2},{label:"3",value:3},{label:"4",value:4}],loading:{hasMoreUnassignedTasks:!1,unassignedTasks:!1},errors:{unassignedTasks:!1,schedule:!1},filters:{productionId:null,taskTypeId:null},pagination:{unassignedTasks:1}}},mounted(){this.selectedDepartment=this.$route.query.department||void 0,this.selectedStudio=this.$route.query.studio||void 0;const e=parseInt(this.$route.query.zoom)||1;this.zoomLevel=Math.min(Math.max(e,1),4),this.init()},computed:{...ee(["daysOff","departmentMap","displayedPeople","getProductionTaskTypes","openProductions","organisation","productionMap","studios","taskTypeMap","user"]),daysOffByPerson(){return this.daysOff.reduce((e,s)=>(e[s.person_id]||(e[s.person_id]=[]),e[s.person_id].push(s),e),{})},selectablePeople(){let e=this.displayedPeople.filter(s=>!s.is_bot);return this.selectedDepartment&&(e=e.filter(s=>s.departments.includes(this.selectedDepartment))),this.selectedStudio&&(e=e.filter(s=>s.studio_id===this.selectedStudio)),e},productionList(){return this.addAllValue(this.openProductions)},taskTypeList(){const e=this.filters.productionId,s=this.getProductionTaskTypes(e).filter(n=>n.for_entity!=="Concept");return this.addAllValue(s)}},methods:{...se(["assignSelectedTasks","fetchPersonTasks","getPersonsTasksDates","loadDaysOff","loadOpenTasks","loadPeople","unassignPersonFromTask","updateTask"]),addAllValue(e){return[{id:"",color:"#999",name:this.$t("main.all"),short_name:this.$t("main.all")},...e]},async init(){await this.loadPeople(),await this.loadPersonDates(),await this.loadDaysOff(),this.refreshSchedule(),this.scrollScheduleToToday(),this.startDate=h(),this.endDate=h().add(3,"months"),Object.values(this.personDates).forEach(e=>{e.startDate.isBefore(this.startDate)&&(this.startDate=e.startDate.clone()),e.endDate.isAfter(this.endDate)&&(this.endDate=e.endDate.clone())}),this.selectedStartDate=this.startDate.toDate(),this.selectedEndDate=this.endDate.toDate()},toggleTaskSidePanel(){this.isTaskSidePanelOpen=!this.isTaskSidePanelOpen,this.isTaskSidePanelOpen||(this.unassignedTasks=[],this.errors.unassignedTasks=!1)},async loadUnassignedTasks(e=!1){this.loading.unassignedTasks=!0,this.errors.unassignedTasks=!1;const s=e?this.pagination.unassignedTasks+1:1;try{const{data:n,is_more:l,stats:t}=await this.loadOpenTasks({limit:20,page:s,person_id:"unassigned",project_id:this.filters.productionId,task_type_id:this.filters.taskTypeId});e?this.pagination.unassignedTasks++:this.unassignedTasks=[],this.unassignedTasks=this.unassignedTasks.concat(n.map(o=>{var g;return{...o,full_name:`${o.entity_type_name} / ${o.entity_name} / ${o.type_name}`,man_days:y(this.organisation,o.estimation),department:this.departmentMap.get((g=this.taskTypeMap.get(o.task_type_id))==null?void 0:g.department_id),production:this.productionMap.get(o.project_id)}})),this.totalUnassignedTasks=t.total,this.loading.hasMoreUnassignedTasks=l}catch(n){this.errors.unassignedTasks=!0,console.error(n)}this.loading.unassignedTasks=!1},async loadPersonDates(e=!1){const s=await this.getPersonsTasksDates();this.personDates={},s.forEach(n=>{this.personDates[n.person_id]={endDate:p(n.max_date),startDate:p(n.min_date)}}),e&&this.scheduleItems.forEach(n=>{const l=this.personDates[n.id];l&&(n.startDate=l.startDate,n.endDate=l.endDate)})},refreshSchedule(){const e=this.selectedPerson?[this.selectedPerson]:this.selectablePeople;this.scheduleItems=this.convertScheduleItems(e)},convertScheduleItems(e){return e.map(s=>{let n=h(),l=h();const t=this.personDates[s.id];return t&&t.startDate&&t.endDate&&(n=p(t.startDate),l=p(t.endDate)),{...s,avatar:!0,color:s.color||te.fromString(s.name,!0),startDate:n,endDate:l,expanded:!1,loading:!1,editable:!1,route:ae(s.id,"schedule"),children:[],daysOff:this.daysOffByPerson[s.id]}})},buildTaskScheduleItem(e,s){let n=h(),l;if(!s.start_date||!s.due_date)return null;s.start_date&&(n=p(s.start_date)),s.due_date?l=p(s.due_date):s.end_date?l=p(s.end_date):s.estimation&&(l=P(s.startDate,Math.ceil(y(this.organisation,s.estimation))-1,s.parentElement.daysOff)),(!l||l.isBefore(n))&&(l=n.clone().add(1,"days"));const t=this.taskTypeMap.get(s.task_type_id);return{...s,name:`${s.full_entity_name} / ${t.name}`,startDate:n,endDate:l,man_days:s.estimation,editable:!0,unresizable:!1,color:t.color,parentElement:e}},saveTaskScheduleItem(e){return this.updateTask({taskId:e.id,data:{start_date:e.startDate.format("YYYY-MM-DD"),due_date:e.endDate.format("YYYY-MM-DD"),estimation:e.estimation}})},onTaskDragStart(e,s){e.stopPropagation(),e.target.classList.add("drag"),e.dataTransfer.dropEffect="move",e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("taskId",s.id),this.draggedTasks=[s]},onTaskDrag(e){e.stopPropagation(),e.target.classList.add("dragging")},onTaskDragEnd(e){e.target.classList.remove("drag"),e.target.classList.remove("dragging"),this.draggedTasks=[]},async onScheduleItemDropped(e,s,n){if(e.type==="Task"){const l=this.buildTaskScheduleItem(s,e);s.children.push(l),s.children.sort(k.firstBy("startDate").thenBy("project_name").thenBy("name")),n&&n(s),await this.assignSelectedTasks({personId:s.id,taskIds:[l.id]}),await this.saveTaskScheduleItem(l),await this.loadUnassignedTasks()}},async onScheduleItemChanged(e){e.type==="Task"&&(e.estimation&&(e.endDate=P(e.startDate,Math.ceil(y(this.organisation,e.estimation))-1,e.parentElement.daysOff)),await this.saveTaskScheduleItem(e),await this.loadPersonDates(!0),await this.loadDaysOff())},onScheduleItemAssigned(e,s){e.type==="Task"&&(s.children.sort(k.firstBy("startDate").thenBy("project_name").thenBy("name")),this.assignSelectedTasks({personId:s.id,taskIds:[e.id]}))},onScheduleItemUnassigned(e,s){e.type==="Task"&&this.unassignPersonFromTask({person:s,task:e})},async expandPersonElement(e,s){if(e.expanded=!e.expanded,!!e.expanded){e.loading=!0,e.children=[];try{const n=await this.fetchPersonTasks(e.id);e.children=n.map(l=>this.buildTaskScheduleItem(e,l)).filter(Boolean).sort(k.firstBy("startDate").thenBy("project_name").thenBy("name")),s&&s(e)}catch(n){console.error(n)}e.loading=!1}},onUpdateSelectedStartDate(e){this.startDate=p(e)},onUpdateSelectedEndDate(e){this.endDate=p(e)},scrollScheduleToToday(){var e;(e=this.$refs.schedule)==null||e.scrollToToday()},updateRoute({department:e,studio:s,zoom:n}){const l={...this.$route.query};e!==void 0&&(l.department=e||void 0),s!==void 0&&(l.studio=s||void 0),n!==void 0&&(l.zoom=String(n)),JSON.stringify(l)!==JSON.stringify(this.$route.query)&&this.$router.push({query:l})}},watch:{selectedDepartment(e){this.updateRoute({department:e}),this.selectedPerson&&!this.selectablePeople.includes(this.selectedPerson)&&this.$refs["people-field"].clear(),this.refreshSchedule()},selectedStudio(e){this.updateRoute({studio:e}),this.selectedPerson&&!this.selectablePeople.includes(this.selectedPerson)&&this.$refs["people-field"].clear(),this.refreshSchedule()},selectedPerson(){this.refreshSchedule()},zoomLevel(e){this.updateRoute({zoom:e})},isTaskSidePanelOpen:{immediate:!0,handler(){this.isTaskSidePanelOpen&&this.loadUnassignedTasks()}}},head(){return{title:`${this.$t("team_schedule.title_main")} - Kitsu`}}},re={class:"columns fixed-page"},ue={class:"column main-column"},ce={class:"flexrow project-dates"},me={class:"flexrow-item"},pe={class:"label"},he={class:"flexrow-item"},fe={class:"label"},ge={class:"flexrow-item people-filter"},_e={class:"label"},Te={class:"flexrow"},ye={key:0,class:"column side-column"},ke={class:"mt1"},De={class:"mb2"},be={class:"task-list"},Se=["onDragstart"],Pe={class:"flexrow"},ve={class:"flexrow-item filler"},Ie={class:"ellipsis"},xe={key:0},we={key:0,class:"has-text-centered"},Ve={key:1},Ue={key:2},Ee={class:"has-text-centered pa1"},Oe={key:3,class:"has-text-centered"};function Be(e,s,n,l,t,o){const g=r("date-field"),I=r("combobox-number"),x=r("combobox-department"),w=r("combobox-studio"),V=r("people-field"),T=r("button-simple"),U=r("schedule"),E=r("combobox-production"),O=r("combobox-task-type"),B=r("production-name"),C=r("entity-thumbnail"),M=r("department-name"),S=r("spinner"),z=r("table-info"),L=r("task-info");return u(),c("div",re,[i("div",ue,[i("div",ce,[i("div",me,[i("label",pe,m(e.$t("main.start_date")),1),d(g,{modelValue:t.selectedStartDate,"onUpdate:modelValue":[s[0]||(s[0]=a=>t.selectedStartDate=a),o.onUpdateSelectedStartDate]},null,8,["modelValue","onUpdate:modelValue"])]),i("div",he,[i("label",fe,m(e.$t("main.end_date")),1),d(g,{modelValue:t.selectedEndDate,"onUpdate:modelValue":[s[1]||(s[1]=a=>t.selectedEndDate=a),o.onUpdateSelectedEndDate]},null,8,["modelValue","onUpdate:modelValue"])]),d(I,{class:"flexrow-item zoom-level",label:e.$t("schedule.zoom_level"),options:t.zoomOptions,modelValue:t.zoomLevel,"onUpdate:modelValue":s[2]||(s[2]=a=>t.zoomLevel=a)},null,8,["label","options","modelValue"]),d(x,{class:"flexrow-item",label:e.$t("main.department"),modelValue:t.selectedDepartment,"onUpdate:modelValue":s[3]||(s[3]=a=>t.selectedDepartment=a)},null,8,["label","modelValue"]),d(w,{class:"flexrow-item",label:e.$t("main.studio"),modelValue:t.selectedStudio,"onUpdate:modelValue":s[4]||(s[4]=a=>t.selectedStudio=a)},null,8,["label","modelValue"]),i("div",ge,[i("label",_e,m(e.$t("main.person")),1),d(V,{ref:"people-field",people:o.selectablePeople,placeholder:e.$t("team_schedule.person_placeholder"),wide:"",modelValue:t.selectedPerson,"onUpdate:modelValue":s[5]||(s[5]=a=>t.selectedPerson=a)},null,8,["people","placeholder","modelValue"])]),s[15]||(s[15]=i("div",{class:"filler"},null,-1)),i("div",Te,[d(T,{class:"flexrow-item",icon:"clock",text:e.$t("schedule.today"),onClick:o.scrollScheduleToToday},null,8,["text","onClick"]),d(T,{active:t.isTaskSidePanelOpen,class:"flexrow-item",icon:"list",text:e.$t("tasks.unassigned_tasks"),onClick:o.toggleTaskSidePanel},null,8,["active","text","onClick"])])]),d(U,{ref:"schedule","dragged-items":t.draggedTasks,"end-date":t.endDate,"hide-man-days":!0,hierarchy:t.scheduleItems,"is-error":t.errors.schedule,"is-estimation-linked":!0,multiline:!0,reassignable:!0,"start-date":t.startDate,"with-milestones":!1,"zoom-level":t.zoomLevel,onItemAssign:o.onScheduleItemAssigned,onItemChanged:o.onScheduleItemChanged,onItemDrop:o.onScheduleItemDropped,onItemUnassign:o.onScheduleItemUnassigned,onRootElementExpanded:o.expandPersonElement},null,8,["dragged-items","end-date","hierarchy","is-error","start-date","zoom-level","onItemAssign","onItemChanged","onItemDrop","onItemUnassign","onRootElementExpanded"])]),t.isTaskSidePanelOpen?(u(),c("div",ye,[d(L,null,{default:ne(()=>[i("a",{class:"close-button",onClick:s[6]||(s[6]=(...a)=>o.toggleTaskSidePanel&&o.toggleTaskSidePanel(...a))},"x"),i("h2",ke,[v(m(e.$t("tasks.unassigned_tasks"))+" ",1),t.loading.unassignedTasks?f("",!0):(u(),c(D,{key:0},[v(" ("+m(t.totalUnassignedTasks)+") ",1)],64))]),i("div",De,[d(E,{class:"mb05",label:e.$t("main.production"),"production-list":o.productionList,modelValue:t.filters.productionId,"onUpdate:modelValue":[s[7]||(s[7]=a=>t.filters.productionId=a),s[8]||(s[8]=a=>o.loadUnassignedTasks())]},null,8,["label","production-list","modelValue"]),d(O,{class:"mb05",label:e.$t("news.task_type"),"task-type-list":o.taskTypeList,modelValue:t.filters.taskTypeId,"onUpdate:modelValue":[s[9]||(s[9]=a=>t.filters.taskTypeId=a),s[10]||(s[10]=a=>o.loadUnassignedTasks())]},null,8,["label","task-type-list","modelValue"])]),t.unassignedTasks.length>0?(u(),c(D,{key:0},[i("ul",be,[(u(!0),c(D,null,oe(t.unassignedTasks,a=>(u(),c("li",{class:"task-item",draggable:!0,key:a.id,onDragstart:_=>o.onTaskDragStart(_,a),onDrag:s[11]||(s[11]=(..._)=>o.onTaskDrag&&o.onTaskDrag(..._)),onDragend:s[12]||(s[12]=(..._)=>o.onTaskDragEnd&&o.onTaskDragEnd(..._))},[i("div",{class:"ui-droppable",style:le({borderColor:a.type_color})},[i("div",Pe,[i("div",ve,[d(B,{class:"strong mb05",production:a.production,size:25},null,8,["production"]),i("div",Ie,m(a.full_name),1),a.man_days?(u(),c("em",xe,m(e.$t("main.estimation"))+": "+m(a.man_days)+" "+m(e.$tc("main.man_days",a.man_days)),1)):f("",!0)]),a.entity_preview_file_id?(u(),b(C,{key:0,class:"task-thumbnail flexrow-item","preview-file-id":a.entity_preview_file_id},null,8,["preview-file-id"])):f("",!0)]),a.department?(u(),b(M,{key:0,class:"task-department",department:a.department,"no-padding":"","only-dot":""},null,8,["department"])):f("",!0)],4)],40,Se))),128))]),t.loading.hasMoreUnassignedTasks?(u(),c("div",we,[t.loading.unassignedTasks?(u(),b(S,{key:0,class:"mt2"})):(u(),c("button",{key:1,class:"button mt2",onClick:s[13]||(s[13]=a=>o.loadUnassignedTasks(!0))},m(e.$t("main.load_more")),1))])):f("",!0)],64)):t.loading.unassignedTasks?(u(),c("div",Ve,[d(S,{class:"mt2"})])):t.errors.unassignedTasks?(u(),c("div",Ue,[d(z,{"is-error":""}),i("div",Ee,[d(T,{class:"has-text-centered",text:e.$t("main.reload"),onClick:s[14]||(s[14]=a=>o.loadUnassignedTasks())},null,8,["text"])])])):(u(),c("div",Oe,[i("em",null,m(e.$t("main.no_results")),1)]))]),_:1})])):f("",!0)])}const ze=A(de,[["render",Be],["__scopeId","data-v-92dad111"]]);export{ze as default};
//# sourceMappingURL=TeamSchedule-wfAx80NV.js.map
