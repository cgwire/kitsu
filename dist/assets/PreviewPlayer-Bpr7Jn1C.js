const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/TaskInfo-C2DOZkHo.js","assets/index-DF-DoQlt.js","assets/index-CzFTCVgk.css","assets/csv-IlynXFQz.js","assets/string-B0Tq569e.js","assets/render-DYxr_jus.js","assets/video-Yn96Kb74.js","assets/dom-tO7tlkHV.js","assets/BuildFilterModal-C18AF9bI.js","assets/Combobox-A6pnhVs3.js","assets/Combobox-CmV6qQXF.css","assets/ComboboxStatus-CBgYMSHg.js","assets/ComboboxStatus-94FiNc0O.css","assets/ComboboxStyled-BlKJF8gk.js","assets/ComboboxStyled-REhbxSxE.css","assets/ComboboxTaskType-C7Rz0ksS.js","assets/TaskTypeName-C0px4urt.js","assets/TaskTypeName-gT-JIvMt.css","assets/ComboboxTaskType-DR8U23Q0.css","assets/ComboboxBoolean-DT116Lfu.js","assets/TextField-BKWlN2Ov.js","assets/TextField-NVCbKgc7.css","assets/ModalFooter-Chk0SGv-.js","assets/ModalFooter-Dz36SOxB.css","assets/PeopleField-BoranyvF.js","assets/PeopleField-DH48MJaw.css","assets/BuildFilterModal-D2ux6Rmn.css","assets/DeleteEntities-5LkT8YiQ.js","assets/HardDeleteModal-BLE4oONO.js","assets/HardDeleteModal-92WvEQHr.css","assets/DeleteEntities-7pcEixAx.css","assets/SearchField-BdP8lRoc.js","assets/SearchField-ekkIuyOx.css","assets/corner-right-up-xDF204hE.js","assets/thumbs-up-UCZcudrF.js","assets/DeleteModal-DwXK5r5w.js","assets/DeleteModal-C20vICPS.css","assets/PlaylistPlayer-ByYDRf10.js","assets/ComboboxSimple-B2TmvsnK.js","assets/ComboboxSimple-BNhrUcrQ.css","assets/clipboard-CQqgyZ_h.js","assets/index-Bnig1aiX.js","assets/BaseModal-D3KB-h7q.js","assets/BaseModal-2bLwXwZl.css","assets/ComboboxDepartment-Cjj8YvK6.js","assets/DepartmentName-DCchDYyW.js","assets/DepartmentName-X7EULdpW.css","assets/ComboboxDepartment-CvCdvAka.css","assets/ComboboxStudio-D3qg68ZP.js","assets/ComboboxStudio-DsgNaVrv.css","assets/play-DUQ3D5JY.js","assets/PlaylistPlayer-CvS_sPr8.css","assets/EmojiButton-CJhEAvTS.js","assets/FileUpload-GCzHM4-i.js","assets/FileUpload-BYTGcAam.css","assets/EmojiButton-B7KSe1yN.css","assets/ConfirmModal-BIIMruUl.js","assets/ConfirmModal-DFnTZHgQ.css","assets/triangle-alert-CW28Rlrw.js","assets/ValidationTag-Cx26FfxH.js","assets/ValidationTag-CX1L5uTW.css","assets/copy-DgQ7ppWI.js","assets/vue.esm-bundler-pS9-uSLU.js","assets/VideoViewer-B89y-Tko.js","assets/VideoViewer-zdMa9_OK.css","assets/TaskInfo-BB-2pcB2.css"])))=>i.map(i=>d[i]);
import{_ as re,M as Be,a5 as We,a as Le,aZ as tt,a_ as it,l as st,b as _e,r as v,o as r,c as l,d,g as T,h as c,f as b,n as Z,aS as nt,a$ as rt,b0 as ot,q as xe,F as H,e as te,t as g,k as $,a4 as ve,O as fe,I as he,R as Oe,B as Ae,x as ae,b1 as Ke,b2 as ye,w as le,H as X,i as de,U as at,b3 as lt,aM as Ze,W as dt,J as Fe,av as Ee,a7 as ct,p as mt,aD as ht,aE as ut,S as ft,a2 as Xe,v as me,b4 as pt,a3 as vt,Z as gt,b5 as wt,b6 as kt,T as He,b7 as yt}from"./index-DF-DoQlt.js";import{d as Ct,E as _t,S as bt,e as xt,f as Tt,O as Pt,L as St,V as At,_ as Dt,b as Ft,C as Et,B as Mt,c as Vt,g as It,h as Me,i as Rt}from"./PlaylistPlayer-ByYDRf10.js";import{c as Te,b as Bt}from"./render-DYxr_jus.js";import{s as Pe}from"./string-B0Tq569e.js";import{E as Ye,A as Ge,f as Ce}from"./EmojiButton-CJhEAvTS.js";import{C as Je}from"./ComboboxStatus-CBgYMSHg.js";import{C as Lt}from"./ConfirmModal-BIIMruUl.js";import{T as Ne}from"./TaskTypeName-C0px4urt.js";import{F as Qe}from"./FileUpload-GCzHM4-i.js";import{T as Ot}from"./triangle-alert-CW28Rlrw.js";import{d as ze}from"./dom-tO7tlkHV.js";import{V as Nt}from"./ValidationTag-Cx26FfxH.js";import{S as zt,T as Ut}from"./thumbs-up-UCZcudrF.js";import{C as jt}from"./copy-DgQ7ppWI.js";import{r as Wt}from"./vue.esm-bundler-pS9-uSLU.js";import{f as Se,a as $e,r as oe,b as Ht}from"./video-Yn96Kb74.js";import{M as qt}from"./ModalFooter-Chk0SGv-.js";import{T as Kt}from"./TextField-BKWlN2Ov.js";import{C as Zt}from"./Combobox-A6pnhVs3.js";import{C as Xt}from"./ComboboxStyled-BlKJF8gk.js";import{V as Yt}from"./VideoViewer-B89y-Tko.js";const Re={setTaskDraft(e,t){return localStorage.setItem("draft-"+e,t)},getTaskDraft(e){return localStorage.getItem("draft-"+e)},clearTaskDraft(e){return localStorage.removeItem("draft-"+e)}},Br={computed:{currentFps(){const e=this.getTask();return e&&parseInt(this.productionMap.get(e.project_id)?.fps)||25},entityFrames(){const e=this.getTask();if(!e||!e.entity)return 0;const t=this.shotMap.get(e.entity.id);return!t||!t.nb_frames?0:t.nb_frames}},methods:{getTask(){return this.currentTask||this.task},getComments(){return this.currentTaskComments||this.taskComments},resetComments(){this.taskComments=this.getTaskComments(this.task.id)},resetModals(){this.$refs["add-preview-modal"]&&this.$refs["add-preview-modal"].reset(),this.$refs["add-comment-image-modal"]&&this.$refs["add-comment-image-modal"].reset()},resetDraft(){const e=this.getTask();if(e&&this.$refs["add-comment"]){const t=Re.getTaskDraft(e.id);t?this.$refs["add-comment"].text=t:this.$refs["add-comment"].text=""}},confirmEditTaskComment(e){this.loading.editComment=!0,this.errors.editComment=!1;const t=e.attachmentFilesToDelete||[],s=e.newAttachmentFiles||[];delete e.attachmentFilesToDelete,delete e.newAttachmentFiles,Promise.all(t.map(m=>({attachment:m,comment:this.commentToEdit})).map(this.deleteAttachment)).then(m=>this.addAttachmentToComment({comment:this.commentToEdit,files:s})).then(()=>this.editTaskComment({taskId:this.getTask().id,comment:e})).then(()=>{this.$nextTick(()=>{this.resetComments()}),this.loading.editComment=!1,this.modals.editComment=!1}).catch(m=>{console.error(m),this.loading.editComment=!1,this.errors.editComment=!0})}}},Gt={name:"view-playlist-modal",mixins:[Be],components:{EditPlaylistModal:_t,PlaylistPlayer:Ct},props:{active:{type:Boolean,default:!1},taskIds:{type:Array},sort:{type:Boolean,default:!1}},emits:["cancel"],data(){return{previewFileMap:new Map,previewFileEntityMap:new Map,currentEntities:[],currentPlaylist:{id:"temp",name:"Temporary playlist",shots:[],for_entity:"shot"},errors:{edit:!1},loading:{edit:!1},modals:{edit:!1},playlistToEdit:{},isLoading:!1}},computed:{..._e(["currentEpisode","currentProduction","isTVShow","selectedTasks","taskMap"]),currentTaskIds(){return this.taskIds||Array.from(this.selectedTasks.keys())},isPlaylistPage(){return this.$route.path.indexOf("playlist")>0},playlistPlayer(){return this.$refs["playlist-player"]},isAssetPlaylist(){return this.currentEntityType==="asset"},isSequencePlaylist(){return this.currentEntityType==="sequence"},isShotPlaylist(){return this.currentEntityType==="shot"},currentEntityType(){let e="shot";return this.$route.path.indexOf("asset")>0&&(e="asset"),this.$route.path.indexOf("sequence")>0&&(e="sequence"),e},assetMap(){return st.cache.assetMap},shotMap(){return it.cache.shotMap},sequenceMap(){return tt.cache.sequenceMap},frameDuration(){return Math.round(1/this.fps*1e4)/1e4},fps(){return parseFloat(this.currentProduction?.fps)||25}},methods:{...Le(["changePlaylistPreview","editPlaylist","loadPlaylists","loadTempPlaylist","newPlaylist","updatePreviewAnnotation"]),async onPreviewChanged({entity:e,previewFileId:t,previousPreviewFileId:s}){await this.changePlaylistPreview({playlist:this.currentPlaylist,entity:e,previewFileId:t,previousPreviewFileId:s,remote:!1})},onAnnotationChanged({preview:e,additions:t,deletions:s,updates:m}){const n=e.task_id;this.updatePreviewAnnotation({taskId:n,preview:e,additions:t,deletions:s,updates:m})},onAnnotationsRefreshed(e){const t=this.previewFileEntityMap.get(e.id),s=this.previewFileMap.get(e.id);t&&(t.preview_file_annotations=e.annotations),s&&(s.annotations=e.annotations)},setupEntities(e){const t={};e.forEach(s=>{this.previewFileEntityMap.set(s.preview_file_id,s);const m=Object.values(s.preview_files);this.convertEntityToPlaylistFormat(s),m.forEach(n=>{n.forEach(i=>{this.previewFileMap.set(i.id,i)})}),t[s.id+"-"+s.preview_file_id]=s}),this.$store.commit("SET_PLAYLIST_ENTRY_MAP",t),this.currentPlaylist.shots=Object.values(t),this.currentEntities=Object.values(t)},convertEntityToPlaylistFormat(e){let t;if(this.isAssetPlaylist?t=this.assetMap.get(e.id):this.isSequencePlaylist?(t=this.sequenceMap.get(e.id),this.currentEpisode&&(t.episode_name=this.currentEpisode.name)):t=this.shotMap.get(e.id),t){const s={id:e.id,name:t.name,nb_frames:e.nb_frames||t.nb_frames||We,parent_name:t.sequence_name||t.episode_name||t.asset_type_name,preview_files:e.preview_files,preview_file_id:e.preview_file_id||t.preview_file_id,preview_file_extension:e.preview_file_extension||t.preview_file_extension,preview_file_revision:e.preview_file_revision||t.preview_file_revision,preview_file_width:e.preview_file_width||t.preview_file_width,preview_file_height:e.preview_file_height||t.preview_file_height,preview_file_duration:e.preview_file_duration||t.preview_file_duration,preview_file_task_id:e.task_id||e.preview_file_task_id||t.preview_file_task_id,preview_file_annotations:e.preview_file_annotations||t.preview_file_annotations,preview_file_previews:e.preview_file_previews||t.preview_file_previews,preview_nb_frames:e.nb_frames||t.nb_frames||We};return Object.assign(e,s),this.previewFileEntityMap.set(s.preview_file_id,s),(s.preview_file_previews||[]).forEach(n=>{n.duration=t.preview_file_duration,this.previewFileMap.set(n.id,n)}),s}else return e},onSaveClicked(){this.errors.editPlaylist=!1,this.playlistToEdit={for_entity:this.currentEntityType},this.modals.edit=!0},async savePlaylist(e){const t={name:e.name,production_id:this.currentProduction.id,for_client:e.for_client,for_entity:e.for_entity,is_for_all:e.is_for_all,task_type_id:e.task_type_id};this.isTVShow&&this.currentEpisode&&(t.episode_id=this.currentEpisode.id),this.errors.edit=!1,this.loading.edit=!0;try{const s=await this.newPlaylist(t);Object.assign(this.currentPlaylist,{id:s.id,name:s.name,for_client:s.for_client,for_entity:s.for_entity,is_for_all:s.is_for_all});const m={...this.currentPlaylist};m.shots=this.currentPlaylist.shots.map(n=>({entity_id:n.id,preview_file_id:n.preview_file_id})),await this.editPlaylist({data:m}),this.modals.edit=!1,this.loadPlaylists({})}catch(s){console.error(s),this.errors.edit=!0,this.loading.edit=!1}}},watch:{active(){this.active?(this.currentEntities=[],this.previewFileMap=new Map,this.previewFileEntityMap=new Map,this.isLoading=!0,this.loadTempPlaylist({taskIds:this.currentTaskIds,sort:this.sort}).then(e=>{this.currentPlaylist.for_entity=this.currentEntityType,this.setupEntities(e),this.isLoading=!1}).catch(console.error)):(this.playlistPlayer.pause(),this.playlistPlayer.clearCanvas(),this.currentEntities=[])}}},Jt={class:"modal-content wide xyz-in",xyz:"fade"},Qt={class:"box"};function $t(e,t,s,m,n,i){const w=v("playlist-player"),f=v("edit-playlist-modal");return r(),l("div",{id:"temp-playlist-modal",class:Z({dark:!0,modal:!0,"is-active":s.active})},[d("div",{class:"modal-background",onClick:t[0]||(t[0]=C=>e.$emit("cancel"))}),d("div",Jt,[d("div",Qt,[i.isPlaylistPage?c("",!0):(r(),T(w,{key:0,ref:"playlist-player",playlist:n.currentPlaylist,entities:n.currentEntities,"is-loading":n.isLoading,"temp-mode":!0,"current-entity-type":i.currentEntityType,onSaveClicked:i.onSaveClicked,onAnnotationChanged:i.onAnnotationChanged,onAnnotationsRefreshed:i.onAnnotationsRefreshed,onPreviewChanged:i.onPreviewChanged},null,8,["playlist","entities","is-loading","current-entity-type","onSaveClicked","onAnnotationChanged","onAnnotationsRefreshed","onPreviewChanged"]))])]),b(f,{active:n.modals.edit,"is-loading":n.loading.edit,"is-error":n.errors.edit,"playlist-to-edit":n.playlistToEdit,"type-disabled":!0,onConfirm:i.savePlaylist,onCancel:t[1]||(t[1]=C=>n.modals.edit=!1)},null,8,["active","is-loading","is-error","playlist-to-edit","onConfirm"])],2)}const Lr=re(Gt,[["render",$t],["__scopeId","data-v-c23beab1"]]);var Ve={exports:{}},qe;function ei(){return qe||(qe=1,(function(e){(()=>{var t={349:((i,w)=>{w.A=(f,C)=>{const p=f.__vccOpts||f;for(const[_,A]of C)p[_]=A;return p}}),431:(i=>{(function(){var w=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","tabSize","MozTabSize"],f=typeof window<"u",C=f&&window.mozInnerScreenX!=null;function p(_,A,V){if(!f)throw new Error("textarea-caret-position#getCaretCoordinates should only be called in a browser");var I=V&&V.debug||!1;if(I){var K=document.querySelector("#input-textarea-caret-position-mirror-div");K&&K.parentNode.removeChild(K)}var S=document.createElement("div");S.id="input-textarea-caret-position-mirror-div",document.body.appendChild(S);var P=S.style,z=window.getComputedStyle?window.getComputedStyle(_):_.currentStyle,h=_.nodeName==="INPUT";P.whiteSpace="pre-wrap",h||(P.wordWrap="break-word"),P.position="absolute",I||(P.visibility="hidden"),w.forEach(function(se){h&&se==="lineHeight"?P.lineHeight=z.height:P[se]=z[se]}),C?_.scrollHeight>parseInt(z.height)&&(P.overflowY="scroll"):P.overflow="hidden",S.textContent=_.value.substring(0,A),h&&(S.textContent=S.textContent.replace(/\s/g," "));var G=document.createElement("span");G.textContent=_.value.substring(A)||".",S.appendChild(G);var ie={top:G.offsetTop+parseInt(z.borderTopWidth),left:G.offsetLeft+parseInt(z.borderLeftWidth),height:parseInt(z.lineHeight)};return I?G.style.backgroundColor="#aaa":document.body.removeChild(S),ie}typeof i.exports<"u"?i.exports=p:f&&(window.getCaretCoordinates=p)})()}),434:((i,w,f)=>{f.d(w,{A:()=>G});function C(D,U){for(var L=[],R={},E=0;E<U.length;E++){var ee=U[E],Y=ee[0],pe=ee[1],ce=ee[2],ge=ee[3],o={id:D+":"+E,css:pe,media:ce,sourceMap:ge};R[Y]?R[Y].parts.push(o):L.push(R[Y]={id:Y,parts:[o]})}return L}var p=typeof document<"u";if(typeof DEBUG<"u"&&DEBUG&&!p)throw new Error("vue-style-loader cannot be used in a non-browser environment. Use { target: 'node' } in your Webpack config to indicate a server-rendering environment.");var _={},A=p&&(document.head||document.getElementsByTagName("head")[0]),V=null,I=0,K=!1,S=function(){},P=null,z="data-vue-ssr-id",h=typeof navigator<"u"&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function G(D,U,L,R){K=L,P=R||{};var E=C(D,U);return ie(E),function(Y){for(var pe=[],ce=0;ce<E.length;ce++){var ge=E[ce],o=_[ge.id];o.refs--,pe.push(o)}Y?(E=C(D,Y),ie(E)):E=[];for(var ce=0;ce<pe.length;ce++){var o=pe[ce];if(o.refs===0){for(var a=0;a<o.parts.length;a++)o.parts[a]();delete _[o.id]}}}}function ie(D){for(var U=0;U<D.length;U++){var L=D[U],R=_[L.id];if(R){R.refs++;for(var E=0;E<R.parts.length;E++)R.parts[E](L.parts[E]);for(;E<L.parts.length;E++)R.parts.push(y(L.parts[E]));R.parts.length>L.parts.length&&(R.parts.length=L.parts.length)}else{for(var ee=[],E=0;E<L.parts.length;E++)ee.push(y(L.parts[E]));_[L.id]={id:L.id,refs:1,parts:ee}}}}function se(){var D=document.createElement("style");return D.type="text/css",A.appendChild(D),D}function y(D){var U,L,R=document.querySelector("style["+z+'~="'+D.id+'"]');if(R){if(K)return S;R.parentNode.removeChild(R)}if(h){var E=I++;R=V||(V=se()),U=ue.bind(null,R,E,!1),L=ue.bind(null,R,E,!0)}else R=se(),U=De.bind(null,R),L=function(){R.parentNode.removeChild(R)};return U(D),function(Y){if(Y){if(Y.css===D.css&&Y.media===D.media&&Y.sourceMap===D.sourceMap)return;U(D=Y)}else L()}}var x=(function(){var D=[];return function(U,L){return D[U]=L,D.filter(Boolean).join(`
`)}})();function ue(D,U,L,R){var E=L?"":R.css;if(D.styleSheet)D.styleSheet.cssText=x(U,E);else{var ee=document.createTextNode(E),Y=D.childNodes;Y[U]&&D.removeChild(Y[U]),Y.length?D.insertBefore(ee,Y[U]):D.appendChild(ee)}}function De(D,U){var L=U.css,R=U.media,E=U.sourceMap;if(R&&D.setAttribute("media",R),P.ssrId&&D.setAttribute(z,U.id),E&&(L+=`
/*# sourceURL=`+E.sources[0]+" */",L+=`
/*# sourceMappingURL=data:application/json;base64,`+btoa(unescape(encodeURIComponent(JSON.stringify(E))))+" */"),D.styleSheet)D.styleSheet.cssText=L;else{for(;D.firstChild;)D.removeChild(D.firstChild);D.appendChild(document.createTextNode(L))}}}),498:(i=>{i.exports=function(w){return w[1]}}),666:((i,w,f)=>{var C=f(846);C.__esModule&&(C=C.default),typeof C=="string"&&(C=[[i.id,C,""]]),C.locals&&(i.exports=C.locals);var p=f(434).A;p("63f4e38b",C,!0,{sourceMap:!1,shadowMode:!1})}),846:((i,w,f)=>{f.r(w),f.d(w,{default:()=>I});var C=f(498),p=f.n(C),_=f(859),A=f.n(_),V=A()(p());V.push([i.id,".atwho-view{color:#000;border-radius:3px;box-shadow:0 0 5px rgba(0,0,0,.1);min-width:120px;z-index:11110!important}.atwho-ul{list-style:none}.atwho-li{display:block}.atwho-view{border-radius:6px;box-shadow:0 0 10px 0 hsla(211,9%,44%,.5)}.atwho-ul{max-height:135px;padding:0;margin:0}.atwho-li{box-sizing:border-box;height:27px;padding:0 12px;white-space:nowrap;display:flex;align-items:center}.atwho-li span{overflow:hidden;text-overflow:ellipsis}.atwho-cur{background:#5bb8ff;color:#fff}.atwho-wrap{position:relative}.atwho-panel{position:absolute}.atwho-inner{position:relative}.atwho-view{position:absolute;bottom:0;left:-.8em;cursor:default;background-color:hsla(0,0%,100%,.94);min-width:140px;max-width:180px;max-height:200px;overflow-y:auto}.atwho-view::-webkit-scrollbar{width:11px;height:11px}.atwho-view::-webkit-scrollbar-track{background-color:#f5f5f5}.atwho-view::-webkit-scrollbar-thumb{min-height:36px;border:2px solid transparent;border-top:3px solid transparent;border-bottom:3px solid transparent;background-clip:padding-box;border-radius:7px;background-color:#c4c4c4}",""]);const I=V}),859:(i=>{i.exports=function(w){var f=[];return f.toString=function(){return this.map(function(p){var _="",A=typeof p[5]<"u";return p[4]&&(_+="@supports (".concat(p[4],") {")),p[2]&&(_+="@media ".concat(p[2]," {")),A&&(_+="@layer".concat(p[5].length>0?" ".concat(p[5]):""," {")),_+=w(p),A&&(_+="}"),p[2]&&(_+="}"),p[4]&&(_+="}"),_}).join("")},f.i=function(p,_,A,V,I){typeof p=="string"&&(p=[[null,p,void 0]]);var K={};if(A)for(var S=0;S<this.length;S++){var P=this[S][0];P!=null&&(K[P]=!0)}for(var z=0;z<p.length;z++){var h=[].concat(p[z]);A&&K[h[0]]||(typeof I<"u"&&(typeof h[5]>"u"||(h[1]="@layer".concat(h[5].length>0?" ".concat(h[5]):""," {").concat(h[1],"}")),h[5]=I),_&&(h[2]&&(h[1]="@media ".concat(h[2]," {").concat(h[1],"}")),h[2]=_),V&&(h[4]?(h[1]="@supports (".concat(h[4],") {").concat(h[1],"}"),h[4]=V):h[4]="".concat(V)),f.push(h))}},f}})},s={};function m(i){var w=s[i];if(w!==void 0)return w.exports;var f=s[i]={id:i,exports:{}};return t[i](f,f.exports,m),f.exports}m.n=i=>{var w=i&&i.__esModule?()=>i.default:()=>i;return m.d(w,{a:w}),w},m.d=(i,w)=>{for(var f in w)m.o(w,f)&&!m.o(i,f)&&Object.defineProperty(i,f,{enumerable:!0,get:w[f]})},m.o=(i,w)=>Object.prototype.hasOwnProperty.call(i,w),m.r=i=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})},m.p="";var n={};(()=>{if(m.d(n,{default:()=>ge}),typeof window<"u"){var i=window.document.currentScript,w=i&&i.src.match(/(.+\/)[^/]+\.js(\?.*)?$/);w&&(m.p=w[1])}function f(o,a){if(typeof o!="object")return;if(o.getRangeAt){if(o.rangeCount===0)return;o=o.getRangeAt(0)}if(o.cloneRange){let k=o.cloneRange();k.collapse(!0),o=k.startContainer,o.nodeType===1&&(o=o.childNodes[k.startOffset])}if(!o)return;let u=o;for(;u&&u.nodeType!==1;)u=u.previousSibling;o=u||o.parentNode,o&&C(o,a)}function C(o,a){if(o.scrollIntoViewIfNeeded)o.scrollIntoViewIfNeeded(!1);else{a=a||o.parentElement;const u=o.offsetTop-a.scrollTop;(u<0||u>a.offsetHeight-o.offsetHeight)&&(a.scrollTop=o.offsetTop)}}function p(o){const a=window.getSelection();a&&(a.removeAllRanges(),a.addRange(o))}function _(){const o=window.getSelection();if(o&&o.rangeCount>0)return o.getRangeAt(0)}function A(o,a){return a.map(u=>({at:u,index:o.lastIndexOf(u)})).reduce((u,k)=>u.index>k.index?u:k)}function V(o,a){a=a||window;for(var u={top:o.offsetTop,left:o.offsetLeft},k=o.offsetParent;k!=null&&k!=a;)u.left+=k.offsetLeft,u.top+=k.offsetTop,k=k.offsetParent;return u}function I(o,a){do if(a(o))return o;while(o=o&&o.parentNode)}function K(){const o=_();if(o){const a=o.cloneRange();return a.collapse(!0),a.setStart(a.endContainer,0),a}}const S=Wt,P={class:"atwho-inner"},z={class:"atwho-view"},h={class:"atwho-ul"},G=["data-index"],ie=["textContent"],se={ref:"embeddedItem"};function y(o,a){return(0,S.openBlock)(),(0,S.createElementBlock)("div",{ref:"wrap",class:"atwho-wrap",onCompositionstart:a[2]||(a[2]=(...u)=>o.handleCompositionStart&&o.handleCompositionStart(...u)),onCompositionend:a[3]||(a[3]=(...u)=>o.handleCompositionEnd&&o.handleCompositionEnd(...u)),onInput:a[4]||(a[4]=u=>o.handleInput()),onKeydownCapture:a[5]||(a[5]=(...u)=>o.handleKeyDown&&o.handleKeyDown(...u))},[o.atwho?((0,S.openBlock)(),(0,S.createElementBlock)("div",{key:0,class:"atwho-panel",style:(0,S.normalizeStyle)(o.style)},[(0,S.createElementVNode)("div",P,[(0,S.createElementVNode)("div",z,[(0,S.createElementVNode)("ul",h,[((0,S.openBlock)(!0),(0,S.createElementBlock)(S.Fragment,null,(0,S.renderList)(o.atwho.list,(u,k)=>((0,S.openBlock)(),(0,S.createElementBlock)("li",{class:(0,S.normalizeClass)(["atwho-li",o.isCur(k)&&"atwho-cur"]),key:k,"data-index":k,onMouseenter:a[0]||(a[0]=(...F)=>o.handleItemHover&&o.handleItemHover(...F)),onClick:a[1]||(a[1]=(...F)=>o.handleItemClick&&o.handleItemClick(...F))},[(0,S.renderSlot)(o.$slots,"item",{item:u},()=>[(0,S.createElementVNode)("span",{textContent:(0,S.toDisplayString)(o.itemName(u))},null,8,ie)])],42,G))),128))])])])],4)):(0,S.createCommentVNode)("",!0),(0,S.withDirectives)((0,S.createElementVNode)("span",se,[(0,S.renderSlot)(o.$slots,"embeddedItem",{current:o.currentItem})],512),[[S.vShow,!1]]),(0,S.renderSlot)(o.$slots,"default")],544)}m(666);var x=m(349);const ue={},R={name:"VueAt",mixins:[(0,x.A)(ue,[["render",y]])],emits:["update:value","at","insert"],props:{value:{type:String,default:null},at:{type:String,default:null},ats:{type:Array,default:()=>["@"]},suffix:{type:String,default:" "},loop:{type:Boolean,default:!0},allowSpaces:{type:Boolean,default:!0},tabSelect:{type:Boolean,default:!1},avoidEmail:{type:Boolean,default:!0},showUnique:{type:Boolean,default:!0},hoverSelect:{type:Boolean,default:!0},members:{type:Array,default:()=>[]},nameKey:{type:String,default:""},filterMatch:{type:Function,default:(o,a,u)=>o.toLowerCase().indexOf(a.toLowerCase())>-1},deleteMatch:{type:Function,default:(o,a,u)=>a===o+u},scrollRef:{type:String,default:""}},data(){return{bindsValue:this.value!=null,customsEmbedded:!1,hasComposition:!1,atwho:null}},computed:{atItems(){return this.at?[this.at]:this.ats},currentItem(){return this.atwho?this.atwho.list[this.atwho.cur]:""},style(){if(this.atwho){const{list:o,cur:a,x:u,y:k}=this.atwho,{wrap:F}=this.$refs;if(F){const O=V(F),j=this.scrollRef?document.querySelector(this.scrollRef).scrollLeft:0,B=this.scrollRef?document.querySelector(this.scrollRef).scrollTop:0,N=u+j+window.pageXOffset-O.left+"px",J=k+B+window.pageYOffset-O.top+"px";return{left:N,top:J}}}return null}},watch:{"atwho.cur"(o){o!=null&&this.$nextTick(()=>{this.scrollToCur()})},members(){this.handleInput(!0)},value(o,a){this.bindsValue&&this.handleValueUpdate(o)}},mounted(){this.$slots.embeddedItem&&(this.customsEmbedded=!0),this.bindsValue&&this.handleValueUpdate(this.value)},methods:{itemName(o){const{nameKey:a}=this;return a?o[a]:o},isCur(o){return o===this.atwho.cur},handleValueUpdate(o){const a=this.$el.querySelector("[contenteditable]");o!==a.innerHTML&&(a.innerHTML=o,this.dispatchInput())},dispatchInput(){let o=this.$el.querySelector("[contenteditable]"),a=new Event("input",{bubbles:!0});o.dispatchEvent(a)},handleItemHover(o){this.hoverSelect&&this.selectByMouse(o)},handleItemClick(o){this.selectByMouse(o),this.insertItem()},handleDelete(o){const a=K();if(a){if(this.customsEmbedded&&a.endOffset>=1){let M=a.endContainer.childNodes[a.endOffset]||a.endContainer.childNodes[a.endOffset-1];if(!M||M.nodeType===Node.TEXT_NODE&&!/^\s?$/.test(M.data))return;M.nodeType===Node.TEXT_NODE?M.previousSibling&&(M=M.previousSibling):M.previousElementSibling&&(M=M.previousElementSibling);let Q=[].slice.call(M.childNodes);Q=[].reverse.call(Q),Q.unshift(M);let W;if([].some.call(Q,q=>{if(q.getAttribute&&q.getAttribute("data-at-embedded")!=null)return W=q,!0}),W){o.preventDefault(),o.stopPropagation();const q=_();q&&(q.setStartBefore(W),q.deleteContents(),p(q),this.handleInput())}return}const{atItems:u,members:k,suffix:F,deleteMatch:O,itemName:j}=this,B=a.toString(),{at:N,index:J}=A(B,u);if(J>-1){const M=B.slice(J+N.length);if(k.some(W=>{const q=j(W);return O(q,M,F)})){o.preventDefault(),o.stopPropagation();const W=_();W&&(W.setStart(W.endContainer,J),W.deleteContents(),p(W),this.handleInput())}}}},handleKeyDown(o){const{atwho:a}=this;if(a){if(o.keyCode===38||o.keyCode===40){o.metaKey||o.ctrlKey||(o.preventDefault(),o.stopPropagation(),this.selectByKeyboard(o));return}if(o.keyCode===13||this.tabSelect&&o.keyCode===9){o.preventDefault(),o.stopPropagation(),this.insertItem();return}if(o.keyCode===27){this.closePanel();return}}(o.keyCode>=48&&o.keyCode<=90||o.keyCode===8)&&setTimeout(()=>{this.handleInput()},50),o.keyCode===8&&this.handleDelete(o)},handleCompositionStart(){this.hasComposition=!0},handleCompositionEnd(){this.hasComposition=!1,this.handleInput()},handleInput(o){if(this.hasComposition)return;const a=this.$el.querySelector("[contenteditable]");this.$emit("update:value",a.innerHTML);const u=K();if(u){const{atItems:k,avoidEmail:F,allowSpaces:O,showUnique:j}=this;let B=!0;const N=u.toString(),{at:J,index:M}=A(N,k);M<0&&(B=!1);const Q=N[M-1],W=N.slice(M+J.length,N.length);if(F&&/^[a-z0-9]$/i.test(Q)&&(B=!1),!O&&/\s/.test(W)&&(B=!1),/^\s/.test(W)&&(B=!1),!B)this.closePanel();else{const{members:q,filterMatch:ne,itemName:we}=this;!o&&W&&this.$emit("at",W);const ke=q.filter(be=>{const et=we(be);return ne(et,W,J,be)});if(B=!1,ke.length&&(B=!0,!j)){let be=ke[0];W===we(be)&&(B=!1)}B?this.openPanel(ke,u,M,J):this.closePanel()}}},closePanel(){this.atwho&&(this.atwho=null)},openPanel(o,a,u,k){const F=()=>{const O=a.cloneRange();O.setStart(O.endContainer,u+k.length);const j=O.getClientRects()[0];this.atwho={range:a,offset:u,list:o,x:j.left,y:j.top-4,cur:0}};this.atwho?F():setTimeout(F,10)},scrollToCur(){let{wrap:o}=this.$refs,{cur:a}=this.atwho;const u=o.querySelector(`.atwho-li[data-index="${a}"]`),k=u.parentElement.parentElement;f(u,k)},selectByMouse(o){const u=+I(o.target,k=>k.getAttribute("data-index")).getAttribute("data-index");this.atwho={...this.atwho,cur:u}},selectByKeyboard(o){const a=o.keyCode===38?-1:1,{cur:u,list:k}=this.atwho,F=this.loop?(u+a+k.length)%k.length:Math.max(0,Math.min(u+a,k.length-1));this.atwho={...this.atwho,cur:F}},insertText(o,a){a.deleteContents();const u=a.endContainer;if(u.nodeType===Node.TEXT_NODE){const k=a.endOffset;u.data=u.data.slice(0,k)+o+u.data.slice(k),a.setEnd(u,k+o.length)}else{const k=document.createTextNode(o);a.insertNode(k),a.setEndAfter(k)}a.collapse(!1),p(a),this.dispatchInput()},insertHtml(o,a){a.deleteContents();const u=a.endContainer,k=document.createElement("span");if(k.appendChild(document.createTextNode(" ")),k.appendChild(this.htmlToElement(o)),k.appendChild(document.createTextNode(" ")),k.setAttribute("data-at-embedded",""),k.setAttribute("contenteditable",!1),u.nodeType===Node.TEXT_NODE){const F=a.endOffset;let O=u.splitText(F);u.parentNode.insertBefore(k,O),a.setEndBefore(O)}else{const F=document.createTextNode(this.suffix);a.insertNode(k),a.setEndAfter(k),a.insertNode(F),a.setEndAfter(F)}a.collapse(!1),p(a)},insertItem(){const{range:o,offset:a,list:u,cur:k}=this.atwho,{suffix:F,atItems:O,itemName:j,customsEmbedded:B}=this,N=o.cloneRange(),J=o.toString(),{at:M,index:Q}=A(J,O),W=B?Q:Q+M.length;N.setStart(N.endContainer,W),p(N),p(N);const q=u[k];if(B){const ne=this.$refs.embeddedItem.firstElementChild.innerHTML;this.insertHtml(ne,N)}else{const ne=j(q)+F;this.insertText(ne,N)}f(window.getSelection()),this.$emit("insert",q),this.handleInput(),f(N)},htmlToElement(o){const a=document.createElement("template");return o=o.trim(),a.innerHTML=o,a.content.firstChild}}};var E=m(431),ee=m.n(E);const ge={extends:R,name:"AtTextarea",emits:["update:value","at","insert"],computed:{style(){if(this.atwho){const{list:o,cur:a,x:u,y:k}=this.atwho,{wrap:F}=this.$refs,O=this.$el.querySelector("textarea");if(F){const j=u+O.offsetLeft-O.scrollLeft+"px",B=k+O.offsetTop-O.scrollTop+"px";return{left:j,top:B}}}return null}},methods:{handleValueUpdate(o){const a=this.$el.querySelector("textarea");o!==a.value&&(a.value=o,this.dispatchInput())},dispatchInput(){let o=this.$el.querySelector("textarea"),a=new Event("input",{bubbles:!0});o.dispatchEvent(a)},handleDelete(o){const a=this.$el.querySelector("textarea");if(a.selectionEnd-a.selectionStart>0)return;const k=a.value.slice(0,a.selectionEnd);if(k){const{atItems:F,members:O,suffix:j,deleteMatch:B,itemName:N}=this,{at:J,index:M}=A(k,F);if(M>-1){const Q=k.slice(M+J.length);O.some(q=>{const ne=N(q);return B(ne,Q,j)})&&(a.value=a.value.slice(0,M)+a.value.slice(a.selectionEnd-1),a.selectionStart=M+1,a.selectionEnd=M+1,this.handleInput())}}},handleInput(o){if(this.hasComposition)return;const a=this.$el.querySelector("textarea");this.$emit("update:value",a.value);const u=a.value.slice(0,a.selectionEnd);if(u){const{atItems:k,avoidEmail:F,allowSpaces:O}=this;let j=!0;const{at:B,index:N}=A(u,k);N<0&&(j=!1);const J=u[N-1],M=u.slice(N+B.length,u.length);if(F&&/^[a-z0-9]$/i.test(J)&&(j=!1),!O&&/\s/.test(M)&&(j=!1),/^\s/.test(M)&&(j=!1),!j)this.closePanel();else{const{members:Q,filterMatch:W,itemName:q}=this;o||this.$emit("at",M);const ne=Q.filter(we=>{const ke=q(we);return W(ke,M,B,we)});ne.length?this.openPanel(ne,M,N,B,o):this.closePanel()}}else this.closePanel()},openPanel(o,a,u,k){const F=()=>{const O=this.$el.querySelector("textarea"),j=u+k.length,B=ee()(O,j);this.atwho={chunk:a,offset:u,list:o,atEnd:j,x:B.left,y:B.top-4,cur:0}};this.atwho?F():setTimeout(F,10)},insertText(o,a){const u=a.selectionStart,k=a.selectionEnd;a.value=a.value.slice(0,u)+o+a.value.slice(k);const F=u+o.length;a.selectionStart=F,a.selectionEnd=F,this.dispatchInput()},insertItem(){const{chunk:o,offset:a,list:u,cur:k,atEnd:F}=this.atwho,{suffix:O,atItems:j,itemName:B}=this,N=this.$el.querySelector("textarea"),J=N.value.slice(0,F),{at:M,index:Q}=A(J,j),W=Q+M.length;N.selectionStart=W,N.focus();const q=u[k],ne=B(q)+O;this.insertText(ne,N),this.$emit("insert",q),this.handleInput()}}}})(),e.exports=n.default})()})(Ve)),Ve.exports}var ti=ei();const Ue=nt(ti),ii={name:"checklist",components:{CheckSquareIcon:zt,ClockIcon:ot,SquareIcon:rt},props:{checklist:{default:()=>[],type:Array},disabled:{default:!1,type:Boolean},frame:{default:-1,type:Number},isEditable:{type:Boolean,default:!0},isMoviePreview:{default:!1,type:Boolean},revision:{default:-1,type:Number}},emits:["add-item","emit-change","insert-item","remove-task","time-code-clicked"],computed:{filteredChecklist(){return this.checklist.filter(Boolean)}},methods:{addChecklistEntry(e){e===-1||e===this.checklist.length-1?this.$emit("add-item",{index:e,text:"",frame:-1,revision:-1,checked:!1}):this.$emit("insert-item",{index:e+1,text:"",frame:-1,revision:-1,checked:!1}),this.$nextTick(()=>{this.focusNext(e)})},removeChecklistEntry(e){const t=this.checklist[e];t.text.length===0&&(this.$emit("remove-task",t),this.focusPrevious(e))},focusPrevious(e){if(this.checklist.length>0){e===0&&(e=this.checklist.length),e--;const t=`checklist-entry-${e}`;this.$refs[t][0].focus()}},formatFrame:Se,focusNext(e){if(this.checklist.length>0){e===this.checklist.length-1&&(e=-1),e++;const t=`checklist-entry-${e}`;this.$refs[t][0].focus()}},setFrame(e){e.checked=!e.checked,e.revision=this.revision,e.frame=this.frame,e.checked=!e.checked,this.$emit("emit-change")},toggleEntryChecked(e){this.isEditable&&(e.checked=!e.checked,this.$emit("emit-change"))}}},si=["onClick"],ni=["onClick"],ri=["onClick"],oi=["placeholder","onKeydown","onKeyup","disabled","onUpdate:modelValue"];function ai(e,t,s,m,n,i){const w=v("check-square-icon"),f=v("square-icon"),C=v("clock-icon"),p=xe("autosize");return r(),l("div",null,[(r(!0),l(H,null,te(i.filteredChecklist,(_,A)=>(r(),l("div",{class:Z(["checklist-entry",{checked:_.checked,disabled:!s.isEditable}]),key:`comment-checklist-${A}`},[d("span",{class:"checklist-checkbox",onClick:V=>i.toggleEntryChecked(_)},[_.checked?(r(),T(w,{key:0,class:"icon"})):(r(),T(f,{key:1,class:"icon"}))],8,si),_.frame>=0?(r(),l("span",{key:0,class:"frame",onClick:V=>e.$emit("time-code-clicked",{frame:_.frame,revision:_.revision})}," v"+g(_.revision)+" - "+g(i.formatFrame(_.frame)),9,ni)):c("",!0),s.isMoviePreview?(r(),l("span",{key:1,onClick:V=>i.setFrame(_)},[b(C,{class:"icon clock"})],8,ri)):c("",!0),$(d("textarea",{class:"checklist-text",ref_for:!0,ref:`checklist-entry-${A}`,rows:"1",placeholder:e.$t("comments.task_placeholder"),onKeydown:fe(he(V=>i.addChecklistEntry(A),["prevent"]),["enter"]),onKeyup:[fe(V=>i.removeChecklistEntry(A),["backspace"]),fe(V=>i.focusPrevious(A),["up"]),fe(V=>i.focusNext(A),["down"])],disabled:_.text.length!==0&&s.disabled,"onUpdate:modelValue":V=>_.text=V},null,40,oi),[[p],[ve,_.text,void 0,{trim:!0}]])],2))),128))])}const je=re(ii,[["render",ai],["__scopeId","data-v-6639481f"]]),li={class:"toggle-container"},di=["aria-checked"],ci={key:0,class:"toggle-label"},mi={__name:"ToggleButton",props:{modelValue:{type:Boolean,required:!0},label:{type:String,default:""}},emits:["update:modelValue"],setup(e){return(t,s)=>(r(),l("div",li,[d("button",{type:"button",role:"switch",class:Z(["toggle-button",{"is-active":e.modelValue}]),onClick:s[0]||(s[0]=m=>t.$emit("update:modelValue",!e.modelValue)),"aria-checked":e.modelValue},s[1]||(s[1]=[d("span",{class:"toggle-slider"},null,-1)]),10,di),e.label?(r(),l("span",ci,g(e.label),1)):c("",!0)]))}},hi=re(mi,[["__scopeId","data-v-1c3fffdf"]]),ui=/v(\d+)/gi,fi={name:"add-comment",components:{AtTa:Ue,AddAttachmentModal:Ge,ButtonSimple:Ae,Checklist:je,ConfirmModal:Lt,ComboboxStatus:Je,EmojiButton:Ye,PeopleAvatar:Oe,TaskTypeName:Ne,ToggleButton:hi},emits:["add-comment","add-preview","annotation-snapshots-requested","clear-files","file-drop","remove-preview"],inject:["draftComment"],data(){return{isFrameAddition:!1,membersForAts:{"@":[],"#":[]},isDragging:!1,errors:{addCommentAttachment:!1},loading:{addCommentAttachment:!1},modals:{addCommentAttachment:!1,confirmFeedbackPublish:!1}}},props:{frame:{type:Number,default:0},isError:{type:Boolean,default:null},isMaxRetakesError:{type:Boolean,default:null},isMovie:{type:Boolean,default:!1},isLoading:{type:Boolean,default:null},task:{type:Object,default:()=>{}},taskStatus:{type:Array,default:()=>[]},taskTypes:{type:Array,default:()=>[]},team:{type:Array,default:()=>[]},fps:{type:Number,default:25},revision:{type:Number,default:1},time:{type:Number,default:0},previewForms:{type:Array,default:()=>[]}},beforeMount(){this.attachments||(this.attachments=[]),this.checklist||(this.checklist=[])},mounted(){this.isCurrentUserClient?this.isFrameAddition=ae.getBoolPreference("comments:add-frame-when-posting",!1):this.isFrameAddition=!1;const e=this.productionMap.get(this.task.project_id);this.mode=e?.is_publish_default_for_artists&&this.isCurrentUserArtist?"publish":"status",this.$nextTick(()=>{["drag","dragstart","dragend","dragover","dragenter","dragleave","drop"].forEach(t=>{this.$refs.wrapper&&this.$refs.wrapper.addEventListener(t,s=>{s.preventDefault(),s.stopPropagation()})})}),window.addEventListener("paste",this.onPaste,!1)},beforeUnmount(){window.removeEventListener("paste",this.onPaste,!1)},computed:{..._e(["departmentMap","isCurrentUserArtist","isCurrentUserClient","productionDepartmentIds","productionMap","taskStatusForCurrentUser","taskStatusMap","taskTypeMap","uploadProgress"]),attachments:{get(){return this.draftComment.attachments},set(e){this.draftComment.attachments=e}},checklist:{get(){return this.draftComment.checklist},set(e){this.draftComment.checklist=e}},link:{get(){return this.draftComment.link},set(e){this.draftComment.link=e}},mode:{get(){return this.draftComment.mode},set(e){this.draftComment.mode=e}},nextRevision:{get(){return this.draftComment.nextRevision},set(e){this.draftComment.nextRevision=e}},showCommentArea:{get(){return this.draftComment.showCommentArea},set(e){this.draftComment.showCommentArea=e}},showLinkField:{get(){return this.draftComment.showLinkField},set(e){this.draftComment.showLinkField=e}},task_status_id:{get(){return this.draftComment.task_status_id},set(e){this.draftComment.task_status_id=e}},text:{get(){return this.draftComment.text},set(e){this.draftComment.text=e,Re.setTaskDraft(this.task.id,this.text)}},attachmentModal(){return this.$refs["add-attachment-modal"]},isConcept(){return this.$route.path.includes("concept")},isValidForm(){return!!(this.mode==="status"||this.mode==="publish"&&this.previewForms.length&&(this.nextRevision===void 0||this.nextRevision>this.revision)&&(!this.showLinkField||!this.link||this.$refs["input-link"]?.checkValidity()))}},methods:{shortenText:Pe.shortenText,toggleLinkField(e=!1){this.showLinkField=!this.showLinkField,this.showLinkField&&this.$nextTick(()=>{this.$refs["input-link"]?.focus()}),e&&(this.link=null)},runAddComment(e,t,s,m,n,i,w=!1){if(!this.isValidForm)return;if(this.taskStatusMap.get(this.task_status_id).is_feedback_request&&this.previewForms.length===0&&!w){this.modals.confirmFeedbackPublish=!0;return}this.isFrameAddition&&(e=`@frame 

`+e,e=Te(e,this.revision,this.frame+1,this.fps)),this.$store.commit("CLEAR_UPLOAD_PROGRESS"),this.mode==="publish"?(this.showCommentArea||(e=""),t=[],s=[]):s=s.filter(C=>C.text.length),n=Number(n),(isNaN(n)||n<1)&&(n=void 0),this.showLinkField||(i=null),this.$emit("add-comment",e,t,s,m,n,i)},reset(){this.text="",this.link=null,this.attachments=[],this.checklist=[],this.nextRevision=void 0},focus(){const e=this.$refs["comment-textarea"];if(e){e.focus();const t=e.value.length;e.setSelectionRange(t,t)}},getRevision(e){if(!e)return;const s=e.get("file").name.matchAll(ui);return Array.from(s).pop()?.[1]},onAddChecklistItem(e){delete e.index,this.checklist.push(e)},onInsertChecklistItem(e){this.checklist.splice(e.index,0,e);for(let t=0;t<this.checklist.length;t++)this.checklist[t].index=t},resetStatus(){const e=this.taskStatusMap.get(this.task.task_status_id);(!this.isCurrentUserArtist||e.is_artist_allowed)&&(!this.isCurrentUserClient||e.is_client_allowed)?this.task_status_id=this.task.task_status_id:this.task_status_id=this.taskStatusForCurrentUser[0]?.id},onDragover(){this.isDragging=!0},onDragleave(){this.isDragging=!1},onDrop(e){if(e.target.id==="drop-mask"||e.target.parentElement?.className?.indexOf("add-attachment-box")>=0||e.target.parentElement?.className?.indexOf("add-attachment-buttons")>=0||e.target.parentElement?.className?.indexOf("attachment-modal-box")>=0)return;const t=[];for(let s=0;s<e.dataTransfer.files.length;s++){const m=new FormData;m.append("file",e.dataTransfer.files[s]),t.push(m)}this.mode==="publish"?this.$emit("file-drop",t):this.addCommentAttachment(t),this.isDragging=!1},onPaste(e){if(this.modals.addCommentAttachment||this.$refs["comment-textarea"]!==document.activeElement)return;const t=e.clipboardData.files;if(t.length>0){const s=new FormData;s.append("file",t[0]),this.addCommentAttachment([s])}},onAddCommentAttachmentClicked(){this.modals.addCommentAttachment=!0},addCommentAttachment(e){this.onCloseCommentAttachment(),this.attachments=this.attachments.concat(e)},onCloseCommentAttachment(){this.modals.addCommentAttachment=!1},removeAttachment(e){this.attachments=this.attachments.filter(t=>t!==e)},addChecklistEntry(e){(e===-1||e===this.checklist.length-1)&&this.checklist.push({text:"",checked:!1})},removeTask(e){this.checklist=ye(this.checklist,e)},async setValue(e){this.checklist=JSON.parse(JSON.stringify(e.checklist)),this.text=e.text,this.attachments=(await Promise.all(e.attachment_files.map(async t=>{const s=Ke(t),m=await fetch(s);if(!m.ok)return;const n=await m.blob(),i=new FormData;return i.append("file",n,t.name),i}))).filter(Boolean)},atOptionsFilter(e,t,s,m){const n=m?.isTaskType?"#":"@";return s!==n?!1:e?.toLowerCase().indexOf(t.toLowerCase())>-1},onAtTextChanged(e){e.includes("@frame")&&(this.text=Te(e,this.revision,this.frame+1,this.fps))},setAnnotationSnapshots(e){this.attachmentModal.addFiles(e)},showAnnotationLoading(){this.attachmentModal.showAnnotationLoading()},hideAnnotationLoading(){this.attachmentModal.hideAnnotationLoading()},onSelectEmoji(e){const t=this.$refs["comment-textarea"];this.text=Pe.insertInTextArea(t,e.i)}},watch:{task:{immediate:!0,handler(){this.resetStatus();const e=Re.getTaskDraft(this.task.id);e&&(this.text=e)}},mode(){this.mode==="publish"?(this.checklist=[],this.attachments=[],this.text&&this.text.length>0&&(this.showCommentArea=!0)):this.$emit("clear-files")},isFrameAddition(e){this.isCurrentUserClient&&ae.setPreference("comments:add-frame-when-posting",e)},previewForms:{deep:!0,immediate:!0,handler(){const e=this.previewForms?.findLast(t=>this.getRevision(t)>0);this.nextRevision=this.getRevision(e)}},taskTypes:{deep:!0,immediate:!0,handler(e){const t=e.map(s=>({isTaskType:!0,full_name:s.name,color:s.color,id:s.id,url:s.url}));t.push({isTaskType:!0,color:"#000",full_name:"All"}),this.membersForAts["#"]=t}},team:{deep:!0,immediate:!0,handler(){let e;this.isCurrentUserClient?e=this.team.filter(t=>["admin","manager","client"].includes(t.role)):e=[...this.team],this.isCurrentUserClient||(e=e.concat(this.productionDepartmentIds.map(t=>{const s=this.departmentMap.get(t);return{isDepartment:!0,full_name:s.name,color:s.color,id:t}}))),e.push({isTime:!0,at:"@",full_name:"frame"}),this.membersForAts["@"]=e}}}},pi={class:"media-content"},vi={class:"flexrow tab-row"},gi={key:3,class:"flexrow"},wi={class:"flexrow-item"},ki=["disabled","placeholder"],yi={key:1,class:"flexrow link-field"},Ci={class:"flexrow-item has-text-right",for:"input-link"},_i={class:"post-area"},bi={key:1,class:"post-area mt1"},xi={key:0,class:"attachment-title"},Ti={class:"m0"},Pi=["onClick"],Si={class:"progress-wrapper"},Ai={class:"flexrow preview-section"},Di={key:1,class:"flexrow mt2 mb1"},Fi={class:"flexrow-item column has-text-right",for:"input-revision"},Ei=["min","placeholder"],Mi=["title"],Vi={key:2,class:"attachment-title"},Ii=["onClick"],Ri={class:"flexrow button-row mt1"},Bi={key:4,class:"error pull-right"},Li={key:5,class:"error pull-right"};function Oi(e,t,s,m,n,i){const w=v("task-type-name"),f=v("people-avatar"),C=v("at-ta"),p=v("checklist"),_=v("emoji-button"),A=v("button-simple"),V=v("combobox-status"),I=v("toggle-button"),K=v("add-attachment-modal"),S=v("confirm-modal"),P=xe("autosize"),z=xe("focus");return r(),l("article",{ref:"wrapper",onDrop:t[20]||(t[20]=(...h)=>i.onDrop&&i.onDrop(...h)),onDragover:t[21]||(t[21]=(...h)=>i.onDragover&&i.onDragover(...h)),onDragleave:t[22]||(t[22]=(...h)=>i.onDragleave&&i.onDragleave(...h)),class:Z({"add-comment":!0,"word-break":!0,media:!0,"is-dragging":n.isDragging})},[d("div",pi,[d("div",vi,[d("span",{class:Z({"flexrow-item":!0,filler:!0,"has-text-centered":!0,active:i.mode==="status"}),onClick:t[0]||(t[0]=h=>i.mode="status")},g(e.$t("tasks.change_status")),3),i.isConcept?c("",!0):(r(),l("span",{key:0,class:Z({"flexrow-item":!0,filler:!0,"has-text-centered":!0,active:i.mode==="publish"}),onClick:t[1]||(t[1]=h=>i.mode="publish")},g(e.$t("tasks.publish_revision")),3))]),i.mode==="status"||i.showCommentArea?(r(),T(C,{key:0,ats:["#","@"],members:[...n.membersForAts["@"],...n.membersForAts["#"]],"name-key":"full_name",limit:2,"filter-match":i.atOptionsFilter,"onUpdate:value":i.onAtTextChanged},{item:le(({item:h})=>[h.isTime?(r(),l(H,{key:0},[X(" ⏱️ frame ")],64)):h.isDepartment?(r(),l(H,{key:1},[d("span",{class:"mr05",style:de({background:h.color,width:"10px",height:"10px","border-radius":"50%"})},"   ",4),X(" "+g(h.full_name),1)],64)):h.isTaskType?(r(),T(w,{key:2,"task-type":{color:h.color,name:h.full_name},"is-link":!1,thin:""},null,8,["task-type"])):(r(),l("div",gi,[b(f,{class:"flexrow-item",person:h,size:20,"font-size":11,"is-lazy":!1,"is-link":!1},null,8,["person"]),d("span",wi,g(h.full_name),1)]))]),default:le(()=>[$(d("textarea",{ref:"comment-textarea",class:"textarea flexrow-item",disabled:s.isLoading,placeholder:e.$t("comments.add_comment"),rows:"2",onKeyup:[t[2]||(t[2]=fe(he(h=>i.runAddComment(i.text,i.attachments,i.checklist,i.task_status_id,i.nextRevision,i.link),["ctrl"]),["enter"])),t[3]||(t[3]=fe(he(h=>i.runAddComment(i.text,i.attachments,i.checklist,i.task_status_id,i.nextRevision,i.link),["meta"]),["enter"]))],"onUpdate:modelValue":t[4]||(t[4]=h=>i.text=h)},null,40,ki),[[P],[z],[ve,i.text]])]),_:1},8,["members","filter-match","onUpdate:value"])):c("",!0),i.mode==="publish"&&i.showLinkField?(r(),l("div",yi,[d("label",Ci,g(e.$t("main.link")),1),$(d("input",{id:"input-link",ref:"input-link",class:"input flexrow-item filler preview-link",placeholder:"https://...",type:"url","onUpdate:modelValue":t[5]||(t[5]=h=>i.link=h)},null,512),[[ve,i.link,void 0,{trim:!0}]]),d("span",{class:"flexrow-item column preview-delete-link",onClick:t[6]||(t[6]=he(h=>i.toggleLinkField(!0),["prevent"]))}," x ")])):c("",!0),d("div",_i,[i.checklist.length>0?(r(),T(p,{key:0,checklist:i.checklist,frame:s.frame+1,revision:s.revision,"is-movie-preview":s.isMovie,onAddItem:i.onAddChecklistItem,onInsertItem:i.onInsertChecklistItem,onRemoveTask:i.removeTask},null,8,["checklist","frame","revision","is-movie-preview","onAddItem","onInsertItem","onRemoveTask"])):c("",!0),i.mode==="publish"?(r(),l("div",bi,[s.previewForms.length>0?(r(),l("div",xi,g(e.$t("comments.previews")),1)):c("",!0),(r(!0),l(H,null,te(s.previewForms,(h,G)=>(r(),l("div",{key:"preview-"+G,class:"preview-file"},[d("div",Ti,[X(g(i.shortenText(h.get("file").name,40))+" ",1),d("span",{onClick:ie=>e.$emit("remove-preview",h)},"x",8,Pi)]),d("div",Si,[d("div",{class:"progress",style:de({width:(e.uploadProgress[h.get("file").name]||0)+"%"})},null,4)])]))),128)),d("div",Ai,[d("button",{class:"button flexrow-item preview-button",onClick:t[7]||(t[7]=h=>e.$emit("add-preview"))},g(e.$t("comments.add_preview")),1)]),i.nextRevision!==void 0?(r(),l("div",Di,[d("label",Fi,g(e.$t("tasks.new_revision_number")),1),$(d("input",{id:"input-revision",class:"input flexrow-item column preview-revision",type:"number",min:s.revision+1,pattern:"[0-9]",placeholder:s.revision+1,onEnter:t[8]||(t[8]=h=>e.$emit("add-preview")),"onUpdate:modelValue":t[9]||(t[9]=h=>i.nextRevision=h)},null,40,Ei),[[ve,i.nextRevision,void 0,{trim:!0}]]),d("span",{class:"flexrow-item column preview-delete-revision",title:e.$t("tasks.auto_revision"),onClick:t[10]||(t[10]=he(h=>i.nextRevision=void 0,["prevent"]))}," x ",8,Mi)])):c("",!0)])):c("",!0),i.attachments.length>0?(r(),l("div",Vi,g(e.$t("comments.attachments")),1)):c("",!0),(r(!0),l(H,null,te(i.attachments,(h,G)=>(r(),l("div",{key:"attachment-"+G,class:"attachment-file"},[X(g(i.shortenText(h.get("file").name,40))+" ",1),d("span",{onClick:ie=>i.removeAttachment(h)},"x",8,Ii)]))),128)),d("div",Ri,[i.mode==="status"?(r(),T(_,{key:0,onSelect:i.onSelectEmoji},null,8,["onSelect"])):c("",!0),i.mode==="status"?(r(),T(A,{key:1,class:Z({"flexrow-item":!0,active:i.attachments.length!==0}),icon:"attach",title:e.$t("comments.add_attachment"),onClick:t[11]||(t[11]=h=>i.onAddCommentAttachmentClicked())},null,8,["class","title"])):c("",!0),i.mode==="status"?(r(),T(A,{key:2,class:Z({"flexrow-item":!0,active:i.checklist.length!==0}),icon:"list",title:e.$t("comments.add_checklist"),onClick:t[12]||(t[12]=h=>i.addChecklistEntry(-1))},null,8,["class","title"])):c("",!0),i.mode==="publish"?(r(),T(A,{key:3,class:Z({"flexrow-item":!0,active:i.showCommentArea}),icon:"comment",title:e.$t("comments.add_comment"),onClick:t[13]||(t[13]=h=>i.showCommentArea=!i.showCommentArea)},null,8,["class","title"])):c("",!0),i.mode==="publish"?(r(),T(A,{key:4,class:Z({"flexrow-item":!0,active:i.showLinkField}),icon:"link",title:e.$t("comments.add_link"),onClick:i.toggleLinkField},null,8,["class","title","onClick"])):c("",!0),t[23]||(t[23]=d("div",{class:"filler"},null,-1)),b(V,{class:"flexrow-item status-selector",narrow:!0,"color-only":!0,"task-status-list":s.taskStatus,"production-id":s.task.project_id,modelValue:i.task_status_id,"onUpdate:modelValue":t[14]||(t[14]=h=>i.task_status_id=h)},null,8,["task-status-list","production-id","modelValue"]),b(A,{class:Z({"post-button":!0,"flexrow-item":!0,"is-loading":s.isLoading}),icon:"send",disabled:!i.isValidForm,text:i.mode==="publish"?e.$t("tasks.publish"):e.$t("tasks.post"),title:i.mode==="publish"?e.$t("tasks.publish"):e.$t("comments.post_status"),onClick:t[15]||(t[15]=h=>i.runAddComment(i.text,i.attachments,i.checklist,i.task_status_id,i.nextRevision,i.link))},null,8,["class","disabled","text","title"])]),e.isCurrentUserClient&&s.isMovie?(r(),T(I,{key:3,class:"mb05",label:e.$t("comments.add_frame_to_comment"),modelValue:n.isFrameAddition,"onUpdate:modelValue":t[16]||(t[16]=h=>n.isFrameAddition=h)},null,8,["label","modelValue"])):c("",!0),s.isError?(r(),l("div",Bi,[d("em",null,g(e.$t("comments.error")),1)])):c("",!0),s.isMaxRetakesError?(r(),l("div",Li,[d("em",null,g(e.$t("comments.max_retakes_error")),1)])):c("",!0)])]),b(K,{ref:"add-attachment-modal",active:n.modals.addCommentAttachment,"is-loading":n.loading.addCommentAttachment,"is-error":n.errors.addCommentAttachment,"is-movie":s.isMovie,title:`${s.task.entity_name} / ${e.taskTypeMap.get(s.task.task_type_id).name}`,onCancel:i.onCloseCommentAttachment,onConfirm:i.addCommentAttachment,onAddSnapshots:t[17]||(t[17]=h=>e.$emit("annotation-snapshots-requested"))},null,8,["active","is-loading","is-error","is-movie","title","onCancel","onConfirm"]),b(S,{active:n.modals.confirmFeedbackPublish,text:e.$t("comments.confirm_publish"),"confirm-button-text":e.$t("comments.confirm_publish_button"),onCancel:t[18]||(t[18]=h=>n.modals.confirmFeedbackPublish=!1),onConfirm:t[19]||(t[19]=()=>{n.modals.confirmFeedbackPublish=!1,i.runAddComment(i.text,i.attachments,i.checklist,i.task_status_id,i.nextRevision,i.link,!0)})},null,8,["active","text","confirm-button-text"])],34)}const Or=re(fi,[["render",Oi],["__scopeId","data-v-a91398b6"]]),Ni={name:"add-preview-modal",mixins:[Be],components:{AlertTriangleIcon:Ot,FileUpload:Qe},props:{active:{type:Boolean,default:!1},confirmLabel:{type:String,default:""},extensions:{type:String,default:Ce.ALL_EXTENSIONS_STRING},isConcept:{type:Boolean,default:!1},isEditing:{type:Boolean,default:!1},isError:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},isMultiple:{type:Boolean,default:!0},message:{type:String,default:"tasks.revision_preview_file"},title:{type:String,default:""},fps:{type:Number,default:0},expectedFrames:{type:Number,default:0}},emits:["cancel","confirm","fileselected"],data(){return{forms:[],isWrongDuration:!1,isDraggingFile:!1}},computed:{previewField(){return this.$refs["preview-field"]}},methods:{setFiles(e){this.previewField.filesChange("file",e)},onFileSelected(e){this.forms=this.isMultiple?this.forms.concat(e):[e],this.$emit("fileselected",this.forms)},reset(){this.previewField?.reset(),this.forms=[],this.isWrongDuration=!1},onPaste(e){this.active&&e.clipboardData.files&&this.previewField.filesChange("",e.clipboardData.files)},getURL(e){return window.URL.createObjectURL(e.get("file"))},isImage(e){return e.get("file").type.startsWith("image")},isVideo(e){return e.get("file").type.startsWith("video")},isPdf(e){return e.get("file").type.indexOf("pdf")>0},removePreview(e){this.forms=this.forms.filter(t=>t!==e)},onFileDragover(e){e.preventDefault(),e.stopPropagation(),this.isDraggingFile=!0},onFileDragLeave(e){e.preventDefault(),e.stopPropagation(),e.target.id==="drop-mask"&&(this.isDraggingFile=!1)},onDrag(e){},onDrop(e){this.previewField.onDrop(e),this.isDraggingFile=!1,e.preventDefault()}},watch:{active(){this.reset()},forms:{deep:!0,handler(){this.$nextTick(()=>{this.isWrongDuration=!1,this.expectedFrames!==0&&Object.keys(this.$refs).forEach(e=>{const t=this.$refs[e];e.startsWith("video-")&&t[0]&&(t[0].onloadedmetadata=()=>{if(!t[0])return;Math.round(t[0].duration*this.fps)!==this.expectedFrames&&(this.isWrongDuration=!0)})})})}}},mounted(){this.forms=[],window.addEventListener("paste",this.onPaste,!1)},beforeUnmount(){window.removeEventListener("paste",this.onPaste)}},zi={class:"subtitle"},Ui={key:1,class:"title"},ji={key:2,class:"title"},Wi={key:3,class:"error"},Hi={key:4,class:"subtitle has-text-centered"},qi={key:5,class:"upload-previews"},Ki={class:"preview-name"},Zi=["onClick"],Xi=["src"],Yi=["src"],Gi=["src"],Ji={key:6,class:"mt1 message"},Qi={class:"message-body"},$i={key:7,class:"mb2 mt2 warning-text"},es={class:"has-text-right"};function ts(e,t,s,m,n,i){const w=v("file-upload"),f=v("alert-triangle-icon");return r(),l("div",{id:"add-comment-modal",class:Z({modal:!0,"is-active":s.active}),ref:"modal"},[d("div",{ref:"background",class:"modal-background",onClick:t[0]||(t[0]=C=>e.$emit("cancel"))},null,512),d("div",{class:"modal-content",onDragover:t[4]||(t[4]=(...C)=>i.onFileDragover&&i.onFileDragover(...C)),onDragleave:t[5]||(t[5]=(...C)=>i.onFileDragLeave&&i.onFileDragLeave(...C))},[d("div",{id:"modal-content",class:Z(["box content",{dragging:!0}])},[n.isDraggingFile?(r(),l("div",{key:0,ref:"dropMask",id:"drop-mask",class:"drop-mask",onDrop:t[1]||(t[1]=(...C)=>i.onDrop&&i.onDrop(...C))},g(e.$t("main.drop_files_here")),545)):c("",!0),d("h2",zi,g(s.title),1),s.isEditing?(r(),l("h1",Ui,g(e.$t("tasks.change_preview")),1)):(r(),l("h1",ji,g(s.isConcept?e.$t("concepts.add_concept"):e.$t("tasks.add_preview")),1)),d("p",null,g(e.$t("tasks.select_preview_file")),1),b(w,{ref:"preview-field",class:"preview-files-field",accept:s.extensions,"is-primary":!1,label:e.$t("main.select_file"),multiple:s.isMultiple,onFileselected:i.onFileSelected,"hide-file-names":""},null,8,["accept","label","multiple","onFileselected"]),s.isError?(r(),l("p",Wi,g(s.isConcept?e.$t("concepts.add_concept_error"):e.$t("tasks.add_preview_error")),1)):c("",!0),n.forms.length>0?(r(),l("h3",Hi," Selected Files ")):c("",!0),n.forms.length>0?(r(),l("div",qi,[(r(!0),l(H,null,te(n.forms,(C,p)=>(r(),l(H,{key:`preview-${p}`},[d("p",Ki,[X(g(C.get("file").name)+" ",1),d("span",{onClick:_=>i.removePreview(C)},"x",8,Zi)]),i.isImage(C)?(r(),l("img",{key:0,alt:"uploaded file",src:i.getURL(C)},null,8,Xi)):i.isVideo(C)?(r(),l("video",{key:1,ref_for:!0,ref:`video-${p}`,src:i.getURL(C),preload:"auto",class:"is-fullwidth",autoplay:"",controls:"",loop:"",muted:""},null,8,Yi)):i.isPdf(C)?(r(),l("iframe",{key:2,class:"is-fullwidth",frameborder:"0",src:i.getURL(C)},null,8,Gi)):c("",!0),t[6]||(t[6]=d("hr",null,null,-1))],64))),128))])):c("",!0),s.message?(r(),l("div",Ji,[d("div",Qi,g(e.$t(s.message)),1)])):c("",!0),n.isWrongDuration?(r(),l("p",$i,[b(f,{class:"icon mr05 warning"}),X(" "+g(e.$t("shots.wrong_file_duration")),1)])):c("",!0),d("p",es,[d("a",{class:Z({button:!0,"is-primary":!0,"is-loading":s.isLoading,"is-disabled":n.forms.length===0}),onClick:t[2]||(t[2]=C=>e.$emit("confirm",n.forms))},g(s.confirmLabel?.length?s.confirmLabel:s.isConcept?e.$t("main.confirmation"):e.$t("tasks.add_revision_confirm")),3),d("button",{onClick:t[3]||(t[3]=C=>e.$emit("cancel")),class:"button is-link"},g(e.$t("main.cancel")),1)])])],32)],2)}const Nr=re(Ni,[["render",ts],["__scopeId","data-v-951e7980"]]),is={name:"comment-menu",props:{isEditable:{type:Boolean,default:!0},isEmpty:{type:Boolean,default:!1},isPinnable:{type:Boolean,default:!0},isPinned:{type:Boolean,default:!1}},emits:["delete-clicked","edit-clicked","pin-clicked"]},ss={class:"comment-menu"};function ns(e,t,s,m,n,i){return r(),l("div",ss,[s.isPinnable&&!s.isEmpty?(r(),l("div",{key:0,onClick:t[0]||(t[0]=w=>e.$emit("pin-clicked"))},g(s.isPinned?e.$t("comments.unpin"):e.$t("comments.pin")),1)):c("",!0),s.isEditable?(r(),l("div",{key:1,onClick:t[1]||(t[1]=w=>e.$emit("edit-clicked"))},g(e.$t("main.edit")),1)):c("",!0),s.isEditable?(r(),l("div",{key:2,class:"error",onClick:t[2]||(t[2]=w=>e.$emit("delete-clicked"))},g(e.$t("main.delete")),1)):c("",!0)])}const rs=re(is,[["render",ns],["__scopeId","data-v-39644dee"]]),os={name:"comment",mixins:[ze],components:{AtTa:Ue,AddAttachmentModal:Ge,ButtonSimple:Ae,Checklist:je,ChevronDownIcon:dt,CopyIcon:jt,CommentMenu:rs,EmojiButton:Ye,LinkIcon:Ze,PaperclipIcon:lt,PeopleAvatar:Oe,PeopleName:at,ThumbsUpIcon:Ut,ValidationTag:Nt,TaskTypeName:Ne},data(){return{membersForAts:{"@":[],"#":[]},checklist:[],isReplyLoading:!1,menuVisible:!1,modals:{addAttachment:!1},replyAttachments:[],replyText:"",showReply:!1,uniqueClassName:(Math.random()+1).toString(36).substring(2)}},emits:["ack-comment","checklist-updated","delete-comment","duplicate-comment","edit-comment","pin-comment","time-code-clicked"],props:{comment:{type:Object,default:()=>{}},frame:{type:Number,default:0},fps:{type:Number,default:25},isChange:{type:Boolean,default:!1},isCheckable:{type:Boolean,default:!1},isEditable:{type:Boolean,default:!1},isPinnable:{type:Boolean,default:!1},isReplyable:{type:Boolean,default:!1},taskTypes:{type:Array,default:()=>[]},team:{type:Array,default:()=>[]},task:{type:Object,default:null},revision:{type:Number,default:1}},mounted(){this.comment.checklist&&(this.$options.silent=!0,this.checklist=[...this.comment.checklist],this.$nextTick().then(()=>{this.$options.silent=!1})),Array.from(document.getElementsByClassName(this.uniqueClassName)).forEach(e=>{e.addEventListener("click",this.timeCodeClicked)}),window.addEventListener("paste",this.onPaste,!1)},beforeUnmount(){Array.from(document.getElementsByClassName(this.uniqueClassName)).forEach(e=>{e.removeEventListener("click",this.timeCodeClicked)}),window.removeEventListener("paste",this.onPaste,!1)},computed:{..._e(["departmentMap","isCurrentUserAdmin","isCurrentUserArtist","isCurrentUserClient","isCurrentUserManager","personMap","productionDepartmentIds","taskTypeMap","user"]),isConcept(){return this.$route.path.includes("concept")},isEmpty(){return this.comment.text.length===0&&(!this.comment.checklist||this.comment.checklist.length===0)&&this.comment.attachment_files.length===0&&this.comment.previews.length===0},previewRoute(){let e={name:"task",params:{task_id:this.comment.object_id,production_id:this.task.project_id}};this.comment.previews.length>0&&(e={name:"task-preview",params:{task_id:this.comment.object_id,preview_id:this.comment.previews[0].id,production_id:this.task.project_id}}),this.task.episode_id?(e.name=`episode-${e.name}`,e.params.episode_id=this.task.episode_id):this.task.entity&&this.task.entity.episode_id&&(e.name=`episode-${e.name}`,e.params.episode_id=this.task.entity.episode_id);const t=this.taskTypeMap.get(this.task.task_type_id);return e.params.type=ht(t.for_entity),e},isLikedBy(){const e=this.comment.acknowledgements.map(t=>this.personMap.get(t));return mt(e).map(t=>t.name).join(", ")},commentAttachments(){return this.comment.attachment_files.filter(e=>!e.reply_id)},pictureAttachments(){return this.commentAttachments.filter(e=>Ce.IMG_EXTENSIONS.includes(e.extension)).sort((e,t)=>e.name.localeCompare(t.name,void 0,{numeric:!0}))},fileAttachments(){return this.commentAttachments.filter(e=>!Ce.IMG_EXTENSIONS.includes(e.extension))},replyAttachmentMap(){const e=new Map;return this.comment.attachment_files.forEach(t=>{t.reply_id&&(e.has(t.reply_id)||e.set(t.reply_id,{pictures:[],files:[]}),Ce.IMG_EXTENSIONS.includes(t.extension)?e.get(t.reply_id).pictures.push(t):e.get(t.reply_id).files.push(t))}),e},commentDate(){return Ee(this.comment.created_at)},fullDate(){return this.commentDate.tz(this.user.timezone).format("YYYY-MM-DD HH:mm:ss")},shortDate(){return this.renderDate(this.commentDate)},boxShadowStyle(){return`0 0 3px 2px ${this.comment.task_status.color}1F`},isAuthorClient(){return this.personMap.get(this.comment.person_id)?.role==="client"}},methods:{...Le(["deleteReply","replyToComment","updatePreviewFileValidationStatus"]),shortenText:Pe.shortenText,formatDate(e){return ct(e)},replyFullDate(e){return Fe(Ee(e)).tz(this.user.timezone).format("YYYY-MM-DD HH:mm:ss")},replyShortDate(e){return this.renderDate(Ee(e))},renderDate(e){return e=Fe(e),Fe().isSame(e,"d")?e.tz(this.user.timezone).format("HH:mm"):e.tz(this.user.timezone).format("MM/DD")},getPath(e){const t={name:e,params:{task_id:this.comment.object_id,comment_id:this.comment.id}};return this.$route.params.episode_id&&(t.name=`episode-${t.name}`,t.params.episode_id=this.$route.params.episode_id),t},getDownloadAttachmentPath:Ke,toggleCommentMenu(){this.menuVisible=!this.menuVisible},addChecklistEntry(){this.$options.silent=!0,this.checklist.push({text:"",checked:!1}),this.$nextTick().then(()=>{this.$options.silent=!1})},removeTask(e){this.checklist=ye(this.checklist,e)},onChecklistChanged(){const e=new Date().getTime();if(this.lastCall=this.lastCall||0,e-this.lastCall>1e3){this.lastCall=e;const t={id:this.comment.id,checklist:this.checklist.filter(s=>s.text?.length)};this.$emit("checklist-updated",t)}},acknowledgeComment(e){this.$emit("ack-comment",e)},timeCodeClicked(e){const t={...e.target.dataset};t.frame=t.frame-1,this.pauseEvent(e),this.$emit("time-code-clicked",t)},onChecklistTimecodeClicked(e){this.$emit("time-code-clicked",{versionRevision:e.revision,frame:e.frame-1})},setFrame(e){this.$emit("time-code-clicked",{versionRevision:e.revision,frame:e.frame-1})},changePreviewValidationStatus(e){if(!this.isCurrentUserManager)return;const s={validated:"rejected",rejected:"neutral",neutral:"validated"}[e[0].validation_status]||"validated";e.forEach(m=>{this.updatePreviewFileValidationStatus({previewFile:m,status:s})})},renderComment:Bt,showReplyWidget(){this.showReply=!0,this.$nextTick(()=>{this.$refs.reply?.focus()})},onDrop(e){e.preventDefault();const t=e.dataTransfer.files;if(t.length>0){const s=new FormData;s.append("file",t[0]),this.addAttachmentToReply([s])}},onDragover(e){e.preventDefault()},onDragleave(e){e.preventDefault()},onReplyClicked(){this.isReplyLoading=!0,this.replyToComment({comment:this.comment,text:this.replyText,attachments:this.replyAttachments}).then(()=>{this.isReplyLoading=!1,this.replyText="",this.showReply=!1,this.replyAttachments=[]}).catch(e=>{console.error(e),this.isReplyLoading=!1})},onDeleteReplyClicked(e){this.deleteReply({comment:this.comment,reply:e}).then(()=>{this.isReplyLoading=!1}).catch(console.error)},atOptionsFilter(e,t,s,m){const n=m?.isTaskType?"#":"@";return s!==n?!1:e?.toLowerCase().indexOf(t.toLowerCase())>-1},onAtTextChanged(e){e.includes("@frame")&&(this.replyText=Te(e,this.revision,this.frame+1,this.fps))},onSelectEmoji(e){const t=this.$refs.reply;this.replyText=Pe.insertInTextArea(t,e.i)},addAttachmentToReply(e){this.modals.addAttachment=!1,this.replyAttachments=this.replyAttachments.concat(e)},removeReplyAttachment(e){this.replyAttachments=this.replyAttachments.filter(t=>t!==e)},onPaste(e){if(this.modals.addAttachment||!this.showReply||this.$refs.reply!==document.activeElement)return;const t=e.clipboardData.files;if(t.length>0){const s=new FormData;s.append("file",t[0]),this.addAttachmentToReply([s])}}},watch:{"comment.checklist"(){this.$options.silent=!0,this.checklist=[...this.comment.checklist],this.$nextTick().then(()=>{this.$options.silent=!1})},checklist(){this.$options.silent||this.onChecklistChanged()},taskTypes:{deep:!0,immediate:!0,handler(e){const t=e.map(s=>({isTaskType:!0,full_name:s.name,color:s.color,id:s.id,url:s.url}));t.push({isTaskType:!0,color:"#000",full_name:"All"}),this.membersForAts["#"]=t}},team:{deep:!0,immediate:!0,handler(){let e;this.isCurrentUserClient?e=this.team.filter(t=>["admin","manager","client"].includes(t.role)):e=[...this.team],this.isCurrentUserClient||(e=e.concat(this.productionDepartmentIds.map(t=>{const s=this.departmentMap.get(t);return{isDepartment:!0,full_name:s.name,color:s.color,id:t}}))),e.push({isTime:!0,full_name:"frame"}),this.membersForAts["@"]=e}}}},as={class:"content-wrapper full"},ls={class:"flexrow"},ds={class:"flexrow-item"},cs=["title"],ms={key:1,class:"flexrow-item menu-wrapper"},hs={class:"flexrow-item comment-content"},us={class:"content"},fs={key:0,class:"client-comment"},ps=["innerHTML"],vs={key:3},gs=["href","title"],ws=["src"],ks=["href","title"],ys={class:"flexrow-item"},Cs={class:"replies"},_s={class:"flexrow"},bs={class:"flexrow-item"},xs=["title"],Ts=["title","onClick"],Ps=["innerHTML"],Ss=["href","title"],As=["src"],Ds=["href","title"],Fs={class:"flexrow-item"},Es={key:3,class:"flexrow"},Ms={class:"flexrow-item"},Vs={class:"reply-attachments"},Is=["onClick"],Rs={class:"flexrow ml05"},Bs=["title"],Ls={key:5,class:"pinned-text"},Os={key:6,class:"edited-text"},Ns={key:0,class:"flexrow content-wrapper preview-info"},zs=["href","title"],Us=["title","data-status"],js={key:1,class:"empty-comment"},Ws={class:"flexrow content-wrapper"},Hs=["title"],qs={key:0,class:"flexrow-item menu-wrapper"};function Ks(e,t,s,m,n,i){const w=v("validation-tag"),f=v("people-avatar"),C=v("people-name"),p=v("chevron-down-icon"),_=v("comment-menu"),A=v("copy-icon"),V=v("checklist"),I=v("paperclip-icon"),K=v("task-type-name"),S=v("at-ta"),P=v("emoji-button"),z=v("button-simple"),h=v("thumbs-up-icon"),G=v("router-link"),ie=v("link-icon"),se=v("add-attachment-modal");return r(),l("div",null,[i.isEmpty?(r(),l("div",js,[d("div",Ws,[b(w,{class:"flexrow-item",task:{task_status_id:s.comment.task_status.id},"is-static":!0,thin:!s.isChange},null,8,["task","thin"]),b(f,{class:"flexrow-item",person:s.comment.person,size:25,"font-size":12},null,8,["person"]),b(C,{class:"flexrow-item",person:s.comment.person},null,8,["person"]),t[23]||(t[23]=d("span",{class:"filler"},null,-1)),d("span",{class:"flexrow-item date",title:i.fullDate},g(i.shortDate),9,Hs),s.isPinnable||s.isEditable?(r(),l("div",qs,[b(p,{class:"menu-icon",onClick:i.toggleCommentMenu},null,8,["onClick"]),n.menuVisible?(r(),T(_,{key:0,"is-pinnable":s.isPinnable,"is-editable":s.isEditable,"is-empty":!0,onPinClicked:t[15]||(t[15]=()=>{e.$emit("pin-comment",s.comment),i.toggleCommentMenu()}),onEditClicked:t[16]||(t[16]=()=>{e.$emit("edit-comment",s.comment),i.toggleCommentMenu()}),onDeleteClicked:t[17]||(t[17]=()=>{e.$emit("delete-comment",s.comment),i.toggleCommentMenu()})},null,8,["is-pinnable","is-editable"])):c("",!0)])):c("",!0)])])):(r(),l("article",{key:0,class:Z(["comment",{pinned:s.comment.pinned}]),style:de({"box-shadow":i.boxShadowStyle})},[d("div",as,[d("div",ls,[b(w,{class:"flexrow-item",task:{task_status_id:s.comment.task_status.id},"is-static":!0,thin:!s.isChange},null,8,["task","thin"]),!e.isCurrentUserClient||i.isAuthorClient?(r(),T(f,{key:0,class:"flexrow-item",size:25,"font-size":12,person:s.comment.person},null,8,["person"])):c("",!0),d("strong",ds,[!e.isCurrentUserClient||i.isAuthorClient?(r(),T(C,{key:0,person:s.comment.person},null,8,["person"])):c("",!0)]),t[19]||(t[19]=d("div",{class:"filler"},null,-1)),d("span",{class:"flexrow-item date",title:i.fullDate},g(i.shortDate),9,cs),s.isPinnable||s.isEditable?(r(),l("div",ms,[b(p,{class:"menu-icon",onClick:i.toggleCommentMenu},null,8,["onClick"]),n.menuVisible?(r(),T(_,{key:0,"is-pinnable":s.isPinnable,"is-pinned":s.comment.pinned,"is-editable":s.isEditable,onPinClicked:t[0]||(t[0]=()=>{e.$emit("pin-comment",s.comment),i.toggleCommentMenu()}),onEditClicked:t[1]||(t[1]=()=>{e.$emit("edit-comment",s.comment),i.toggleCommentMenu()}),onDeleteClicked:t[2]||(t[2]=()=>{e.$emit("delete-comment",s.comment),i.toggleCommentMenu()})},null,8,["is-pinnable","is-pinned","is-editable"])):c("",!0)])):c("",!0)]),d("div",hs,[d("div",us,[i.isAuthorClient&&!e.isCurrentUserClient?(r(),l("p",fs,[X(g(e.$t("comments.comment_from_client"))+" ",1),b(A,{class:"copy-icon",size:12,onClick:t[3]||(t[3]=y=>e.$emit("duplicate-comment",s.comment))})])):c("",!0),s.comment.text?(r(),l("p",{key:1,innerHTML:i.renderComment(s.comment.text,s.comment.mentions,s.comment.department_mentions||[],e.personMap,e.departmentMap,s.taskTypes,n.uniqueClassName),class:"comment-text"},null,8,ps)):c("",!0),n.checklist.length>0?(r(),T(V,{key:2,class:"checklist",checklist:n.checklist,disabled:!0,"is-editable":s.isCheckable,onRemoveTask:i.removeTask,onEmitChange:i.onChecklistChanged,onTimeCodeClicked:i.onChecklistTimecodeClicked},null,8,["checklist","is-editable","onRemoveTask","onEmitChange","onTimeCodeClicked"])):c("",!0),s.comment.attachment_files.length>0?(r(),l("p",vs,[(r(!0),l(H,null,te(i.pictureAttachments,y=>(r(),l("a",{href:i.getDownloadAttachmentPath(y),key:y.id,title:y.name,target:"_blank"},[d("img",{class:"attachment",src:i.getDownloadAttachmentPath(y)},null,8,ws)],8,gs))),128)),(r(!0),l(H,null,te(i.fileAttachments,y=>(r(),l("a",{href:i.getDownloadAttachmentPath(y),key:y.id,title:y.name,class:"flexrow",target:"_blank"},[b(I,{class:"flexrow-item attachment-icon icon-1x"}),d("span",ys,g(y.name),1)],8,ks))),128))])):c("",!0),d("div",Cs,[(r(!0),l(H,null,te(s.comment.replies||[],y=>(r(),l("div",{key:y.id,class:"reply-comment"},[d("div",_s,[b(f,{class:"flexrow-item",size:18,"font-size":10,person:e.personMap.get(y.person_id)},null,8,["person"]),d("strong",bs,[b(C,{person:e.personMap.get(y.person_id)},null,8,["person"])]),d("span",{class:"flexrow-item reply-date",title:i.replyFullDate(y.date)},g(i.replyShortDate(y.date)),9,xs),t[20]||(t[20]=d("span",{class:"filler"},null,-1)),e.isCurrentUserAdmin||y.person_id===e.user.id?(r(),l("span",{key:0,class:"flexrow-item reply-delete",title:e.$t("main.delete"),onClick:x=>i.onDeleteReplyClicked(y)}," x ",8,Ts)):c("",!0)]),d("p",{innerHTML:i.renderComment(y.text,y.mentions||[],y.department_mentions||[],e.personMap,e.departmentMap,s.taskTypes,n.uniqueClassName),class:"comment-text"},null,8,Ps),d("p",null,[(r(!0),l(H,null,te(i.replyAttachmentMap.get(y.id)?.pictures,x=>(r(),l("a",{href:i.getDownloadAttachmentPath(x),key:x.id,title:x.name,target:"_blank"},[d("img",{class:"attachment",src:i.getDownloadAttachmentPath(x)},null,8,As)],8,Ss))),128)),(r(!0),l(H,null,te(i.replyAttachmentMap.get(y.id)?.files,x=>(r(),l("a",{href:i.getDownloadAttachmentPath(x),key:x.id,title:x.name,class:"flexrow",target:"_blank"},[b(I,{class:"flexrow-item attachment-icon icon-1x"}),d("span",Fs,g(x.name),1)],8,Ds))),128))])]))),128)),d("div",{onDrop:t[9]||(t[9]=(...y)=>i.onDrop&&i.onDrop(...y)),onDragover:t[10]||(t[10]=(...y)=>i.onDragover&&i.onDragover(...y)),onDragleave:t[11]||(t[11]=(...y)=>i.onDragleave&&i.onDragleave(...y))},[n.showReply?(r(),l(H,{key:0},[b(S,{ats:["#","@"],members:[...n.membersForAts["@"],...n.membersForAts["#"]],"filter-match":i.atOptionsFilter,"name-key":"full_name",limit:2,"onUpdate:value":i.onAtTextChanged},{item:le(({item:y})=>[y.isTime?(r(),l(H,{key:0},[X(" ⏱️ frame ")],64)):y.isDepartment?(r(),l(H,{key:1},[d("span",{class:"mr05",style:de({background:y.color,width:"10px",height:"10px","border-radius":"50%"})},"   ",4),X(" "+g(y.full_name),1)],64)):y.isTaskType?(r(),T(K,{key:2,"task-type":{color:y.color,name:y.full_name},"is-link":!1,thin:""},null,8,["task-type"])):(r(),l("div",Es,[b(f,{class:"flexrow-item",person:y,size:20,"font-size":11,"is-lazy":!1,"is-link":!1},null,8,["person"]),d("span",Ms,g(y.full_name),1)]))]),default:le(()=>[$(d("textarea",{ref:"reply",class:"reply",onKeyup:t[4]||(t[4]=fe(he((...y)=>i.onReplyClicked&&i.onReplyClicked(...y),["ctrl"]),["enter"])),onDragover:t[5]||(t[5]=(...y)=>i.onDragover&&i.onDragover(...y)),onDragleave:t[6]||(t[6]=(...y)=>i.onDragleave&&i.onDragleave(...y)),"onUpdate:modelValue":t[7]||(t[7]=y=>n.replyText=y)},null,544),[[ve,n.replyText]])]),_:1},8,["members","filter-match","onUpdate:value"]),d("div",Vs,[(r(!0),l(H,null,te(n.replyAttachments,(y,x)=>(r(),l("div",{key:"attachment-"+x,class:"attachment-file"},[X(g(i.shortenText(y.get("file").name,40))+" ",1),d("span",{onClick:ue=>i.removeReplyAttachment(y)},"x",8,Is)]))),128))]),d("div",Rs,[b(P,{class:"ml05 flexrow-item",onSelect:i.onSelectEmoji},null,8,["onSelect"]),b(z,{class:"flexrow-item attachment-button",icon:"attach",title:e.$t("comments.add_attachment"),onClick:t[8]||(t[8]=y=>n.modals.addAttachment=!0)},null,8,["title"]),t[21]||(t[21]=d("span",{class:"filler"},null,-1)),b(z,{class:"reply-button",text:e.$t("main.reply"),"is-loading":n.isReplyLoading,onClick:i.onReplyClicked},null,8,["text","is-loading","onClick"])])],64)):c("",!0)],32)]),s.comment.text.length>0||s.comment.previews.length>0||s.comment.attachment_files.length>0?(r(),l("div",{key:4,class:"flexrow",title:i.isLikedBy},[d("button",{class:Z(["like-button flexrow-item",{"like-button--empty":s.comment.like===void 0}]),type:"button",onClick:t[12]||(t[12]=y=>i.acknowledgeComment(s.comment))},[b(h,{class:"icon-1x"}),d("span",null,g(s.comment.acknowledgements.length),1)],2),t[22]||(t[22]=d("span",{class:"filler"},null,-1)),!n.showReply&&s.isReplyable?(r(),l("span",{key:0,class:"flexrow-item reply-button",onClick:t[13]||(t[13]=(...y)=>i.showReplyWidget&&i.showReplyWidget(...y))},g(e.$t("main.reply")),1)):c("",!0)],8,Bs)):c("",!0),s.comment.pinned?(r(),l("div",Ls,g(e.$t("comments.pinned")),1)):c("",!0),s.comment.editor_id&&s.comment.editor_id!==s.comment.person_id?(r(),l("div",Os,g(e.$t("comments.edited_by",{name:e.personMap.get(s.comment.editor_id)?.full_name})),1)):c("",!0)])])]),s.comment.previews.length>0&&!i.isConcept?(r(),l("div",Ns,[b(G,{class:"round-name revision",to:i.previewRoute},{default:le(()=>[X(g(s.comment.pinned?e.$t("comments.pinned_revision"):e.$t("comments.revision"))+" "+g(s.comment.previews[0].revision),1)]),_:1},8,["to"]),!e.isCurrentUserArtist&&s.comment.links?.[0]?.length?(r(),l("a",{key:0,class:"preview-link button",href:s.comment.links[0],title:e.$t("playlists.actions.open_link"),target:"_blank"},[b(ie,{class:"icon is-small"})],8,zs)):c("",!0),d("span",{class:Z(["flexrow-item preview-status",{pointer:e.isCurrentUserManager}]),title:s.comment.previews[0].validation_status,"data-status":s.comment.previews[0].validation_status,onClick:t[14]||(t[14]=y=>i.changePreviewValidationStatus(s.comment.previews))},null,10,Us)])):c("",!0)],6)),n.modals.addAttachment?(r(),T(se,{key:2,ref:"add-attachment-modal",active:n.modals.addAttachment,title:e.$t("comments.add_attachment_to_reply"),onCancel:t[18]||(t[18]=y=>n.modals.addAttachment=!1),onConfirm:i.addAttachmentToReply},null,8,["active","title","onConfirm"])):c("",!0)])}const zr=re(os,[["render",Ks],["__scopeId","data-v-81efa135"]]),Zs={name:"edit-comment-modal",mixins:[Be],components:{AtTa:Ue,Checklist:je,ComboboxStatus:Je,FileUpload:Qe,ModalFooter:qt,PeopleAvatar:Oe,TaskTypeName:Ne,TextField:Kt,XIcon:ut},props:{active:{type:Boolean,default:!1},frame:{type:Number,default:0},commentToEdit:{type:Object,default:()=>{}},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1},taskTypes:{type:Array,default:()=>[]},team:{type:Array,default:()=>[]},fps:{type:Number,default:25},revision:{type:Number,default:1}},emits:["cancel","confirm"],data(){return{membersForAts:{"@":[],"#":[]},attachmentFiles:[],extensions:Ce.ALL_EXTENSIONS_STRING,form:{text:"",task_status_id:null,checklist:[{checked:!1,text:""}],link:null}}},computed:{..._e(["departmentMap","getTaskStatusForCurrentUser","isCurrentUserClient","productionDepartmentIds","taskStatusForCurrentUser"]),taskStatuses(){return this.isConceptTask?this.getTaskStatusForCurrentUser(null,!0):this.taskStatusForCurrentUser.filter(e=>!e.for_concept)},isConceptTask(){return this.$route.path.includes("concept")},isPreviewsComment(){return this.commentToEdit?.previews?.length>0},isValidForm(){return!!(!this.isPreviewsComment||!this.form.link||this.$refs["input-link"]?.checkValidity())}},methods:{runConfirmation(e){if(!e||e.keyCode===13||!e.keyCode){const t={id:this.commentToEdit.id,text:this.form.text,task_status_id:this.form.task_status_id,checklist:this.form.checklist.filter(s=>s.text.length),newAttachmentFiles:this.attachmentFiles,attachmentFilesToDelete:this.attachmentFilesToDelete,links:this.form.link?[this.form.link]:null};this.$emit("confirm",t)}},removeTask(e){this.form.checklist=[...ye(this.form.checklist,e)]},removeAttachment(e){this.form.attachment_files=ye(this.form.attachment_files,e),this.attachmentFilesToDelete.push(e)},removeNewAttachment(e){this.attachmentFiles=ye(this.attachmentFiles,e)},onFileSelected(e){this.attachmentFiles=e},reset(){this.attachmentFiles=[],this.attachmentFilesToDelete=[],this.commentToEdit&&this.commentToEdit.id?(this.form={text:this.commentToEdit.text,task_status_id:this.commentToEdit.task_status_id,checklist:[...this.commentToEdit.checklist],attachment_files:[...this.commentToEdit.attachment_files],link:this.commentToEdit.links?.[0]},this.form.checklist.length===0&&(this.form.checklist=[{checked:!1,text:""}])):this.form={text:"",task_status_id:null,checklist:[{checked:!1,text:""}],attachment_files:[],link:null}},onAddChecklistItem(e){delete e.index,this.form.checklist.push(e)},onInsertChecklistItem(e){this.form.checklist.splice(e.index,0,e);for(let t=0;t<this.form.checklist.length;t++)this.form.checklist[t].index=t},atOptionsFilter(e,t,s,m){const n=m?.isTaskType?"#":"@";return s!==n?!1:e?.toLowerCase().indexOf(t.toLowerCase())>-1},onAtTextChanged(e){e.includes("@frame")&&(this.form.text=Te(e,this.revision,this.frame+1,this.fps))}},watch:{commentToEdit(){this.reset()},active(){this.active&&setTimeout(()=>{this.reset(),this.$refs.textField.focus()},100)},taskTypes:{deep:!0,immediate:!0,handler(e){const t=e.map(s=>({isTaskType:!0,full_name:s.name,color:s.color,id:s.id,url:s.url}));t.push({isTaskType:!0,color:"#000",full_name:"All"}),this.membersForAts["#"]=t}},team:{deep:!0,immediate:!0,handler(){let e;this.isCurrentUserClient?e=[this.team.filter(t=>["admin","manager","supervisor","client"].includes(t.role))]:e=[...this.team],e=e.concat(this.productionDepartmentIds.map(t=>{const s=this.departmentMap.get(t);return{isDepartment:!0,full_name:s.name,color:s.color,id:t}})),e.push({isTime:!0,full_name:"frame"}),this.membersForAts["@"]=e}}}},Xs={class:"modal-content"},Ys={class:"box"},Gs={key:0,class:"title"},Js={class:"field"},Qs={class:"label"},$s={key:3,class:"flexrow"},en={class:"flexrow-item"},tn={class:"label"},sn={class:"label"},nn={key:1,class:"attachments"},rn=["onClick"],on={key:2},an={class:"label mt2"},ln={class:"new-attachments"},dn=["onClick"];function cn(e,t,s,m,n,i){const w=v("combobox-status"),f=v("task-type-name"),C=v("people-avatar"),p=v("at-ta"),_=v("text-field"),A=v("checklist"),V=v("x-icon"),I=v("file-upload"),K=v("modal-footer"),S=xe("focus");return r(),l("div",{class:Z({modal:!0,"is-active":s.active})},[d("div",{class:"modal-background",onClick:t[0]||(t[0]=P=>e.$emit("cancel"))}),d("div",Xs,[d("div",Ys,[s.commentToEdit&&s.commentToEdit.id?(r(),l("h1",Gs,g(e.$t("comments.edit_title")),1)):c("",!0),d("form",{onSubmit:t[6]||(t[6]=he(()=>{},["prevent"]))},[b(w,{label:e.$t("task_status.title"),"task-status-list":i.taskStatuses,modelValue:n.form.task_status_id,"onUpdate:modelValue":t[1]||(t[1]=P=>n.form.task_status_id=P)},null,8,["label","task-status-list","modelValue"]),d("div",Js,[d("label",Qs,g(e.$t("comments.text")),1),b(p,{ats:["#","@"],members:[...n.membersForAts["@"],...n.membersForAts["#"]],"name-key":"full_name",limit:"2","filter-match":i.atOptionsFilter,"onUpdate:value":i.onAtTextChanged},{item:le(({item:P})=>[P.isTime?(r(),l(H,{key:0},[X(" ⏱️ frame ")],64)):P.isDepartment?(r(),l(H,{key:1},[d("span",{class:"mr05",style:de({background:P.color,width:"10px",height:"10px","border-radius":"50%"})},"   ",4),X(" "+g(P.full_name),1)],64)):P.isTaskType?(r(),T(f,{key:2,"task-type":{color:P.color,name:P.full_name},"is-link":!1,thin:""},null,8,["task-type"])):(r(),l("div",$s,[b(C,{class:"flexrow-item",person:P,size:20},null,8,["person"]),d("span",en,g(P.full_name),1)]))]),default:le(()=>[$((r(),l("textarea",{class:"input",ref:"textField","onUpdate:modelValue":t[2]||(t[2]=P=>n.form.text=P),onKeyup:[t[3]||(t[3]=he((...P)=>i.runConfirmation&&i.runConfirmation(...P),["ctrl"])),t[4]||(t[4]=he((...P)=>i.runConfirmation&&i.runConfirmation(...P),["meta"]))]},t[8]||(t[8]=[X("              ")]),32)),[[ve,n.form.text],[S]])]),_:1},8,["members","filter-match","onUpdate:value"])]),i.isPreviewsComment?(r(),T(_,{key:0,ref:"input-link",label:e.$t("main.link"),placeholder:"https://...",type:"url",onEnter:i.runConfirmation,modelValue:n.form.link,"onUpdate:modelValue":t[5]||(t[5]=P=>n.form.link=P),modelModifiers:{trim:!0}},null,8,["label","onEnter","modelValue"])):c("",!0),d("label",tn,g(e.$t("comments.checklist")),1),b(A,{class:"comment-checklist",checklist:n.form.checklist.length?n.form.checklist:[{checked:!1,text:""}],onAddItem:i.onAddChecklistItem,onInsertItem:i.onInsertChecklistItem,onRemoveTask:i.removeTask},null,8,["checklist","onAddItem","onInsertItem","onRemoveTask"]),d("label",sn,g(e.$t("comments.attachments")),1),s.commentToEdit&&(n.form.attachment_files||[]).length>0?(r(),l("div",nn,[(r(!0),l(H,null,te(n.form.attachment_files,(P,z)=>(r(),l("div",{key:"attachment-"+z,class:"attachment-file"},[X(g(P.name)+" ",1),d("span",{onClick:h=>i.removeAttachment(P)},[b(V,{size:12})],8,rn)]))),128))])):(r(),l("div",on,g(e.$t("comments.no_attachments")),1))],32),d("label",an,g(e.$t("comments.attachments_to_add")),1),d("div",ln,[(r(!0),l(H,null,te(n.attachmentFiles,(P,z)=>(r(),l("div",{key:"new-attachment-"+z,class:"attachment-file"},[X(g(P.get("file").name)+" ",1),d("span",{onClick:h=>i.removeNewAttachment(P)},"x",8,dn)]))),128))]),d("div",null,[b(I,{ref:"file-field",class:"flexrow-item",accept:n.extensions,"is-primary":!1,label:e.$t("main.select_file"),multiple:!0,onFileselected:i.onFileSelected,"hide-file-names":""},null,8,["accept","label","onFileselected"])]),b(K,{"error-text":e.$t("comments.edit_error"),"is-disabled":!i.isValidForm,"is-error":s.isError,"is-loading":s.isLoading,onConfirm:i.runConfirmation,onCancel:t[7]||(t[7]=P=>e.$emit("cancel"))},null,8,["error-text","is-disabled","is-error","is-loading","onConfirm"])])])],2)}const Ur=re(Zs,[["render",cn],["__scopeId","data-v-5fb69635"]]),mn={name:"browsing-bar",components:{ButtonSimple:Ae},props:{currentIndex:{type:Number,default:0},fullScreen:{type:Boolean,default:!1},isAssigned:{type:Boolean,default:!1},light:{type:Boolean,default:!1},previews:{type:Array,default:()=>[]},readOnly:{type:Boolean,default:!1}},emits:["add-preview-clicked","current-index-clicked","next-clicked","previous-clicked","remove-preview-clicked"],computed:{isBigDisplay(){return(!this.light||this.fullScreen)&&this.previews.length>1},isMovie(){return this.previews[this.currentIndex-1]?.extension==="mp4"}}},hn={class:"left flexrow"},un=["title"],fn={key:5,class:"separator"};function pn(e,t,s,m,n,i){const w=v("button-simple");return r(),l("div",hn,[i.isBigDisplay||!i.isMovie?(r(),T(w,{key:0,class:"flexrow-item",icon:"left",title:e.$t("playlists.actions.files_previous"),onClick:t[0]||(t[0]=f=>e.$emit("previous-clicked"))},null,8,["title"])):c("",!0),i.isBigDisplay||!i.isMovie?(r(),l("span",{key:1,class:"flexrow-item bar-element current-index",title:e.$t("playlists.actions.files_position"),onClick:t[1]||(t[1]=f=>e.$emit("current-index-clicked"))},[X(g(s.currentIndex)+" ",1),s.fullScreen||!i.isMovie?(r(),l(H,{key:0},[X("/ "+g(s.previews.length),1)],64)):c("",!0)],8,un)):c("",!0),i.isBigDisplay||!i.isMovie?(r(),T(w,{key:2,class:"flexrow-item",icon:"right",title:e.$t("playlists.actions.files_next"),onClick:t[2]||(t[2]=f=>e.$emit("next-clicked"))},null,8,["title"])):c("",!0),(s.isAssigned||!s.readOnly)&&!s.fullScreen?(r(),T(w,{key:3,class:"flexrow-item",icon:"plus",title:e.$t("playlists.actions.files_add"),onClick:t[3]||(t[3]=f=>e.$emit("add-preview-clicked"))},null,8,["title"])):c("",!0),!s.readOnly&&!s.fullScreen&&!s.light?(r(),T(w,{key:4,class:"flexrow-item",icon:"trash",title:e.$t("playlists.actions.files_delete"),onClick:t[4]||(t[4]=f=>e.$emit("remove-preview-clicked"))},null,8,["title"])):c("",!0),i.isBigDisplay?(r(),l("div",fn)):c("",!0)])}const vn=re(mn,[["render",pn],["__scopeId","data-v-49d27b5c"]]),gn={name:"preview-viewer",mixins:[ze],components:{DownloadIcon:Xe,ObjectViewer:Pt,PdfViewer:Tt,PictureViewer:xt,SoundViewer:bt,Spinner:ft,VideoViewer:Yt},props:{name:{type:String,default:""},defaultHeight:{type:Number,default:0},currentFrame:{type:Number,default:0},marginBottom:{type:Number,default:0},nbFrames:{type:Number,default:0},isBig:{type:Boolean,default:!1},isComparing:{type:Boolean,default:!1},isEnvironmentSkybox:{type:Boolean,default:!1},isFullScreen:{type:Boolean,default:!1},isHd:{type:Boolean,default:!1},isComparisonOverlay:{type:Boolean,default:!1},isLight:{type:Boolean,default:!1},isMuted:{type:Boolean,default:!1},isObjectBackground:{type:Boolean,default:!1},isRepeating:{type:Boolean,default:!1},isWireframe:{type:Boolean,default:!1},objectBackgroundUrl:{type:String,default:""},preview:{type:Object,default:()=>{}}},emits:["duration-changed","frame-update","model-loaded","play-ended","size-changed","video-end","video-loaded"],computed:{container(){return this.$refs.container},videoViewer(){return this.$refs["video-viewer"]},pictureViewer(){return this.$refs["picture-viewer"]},soundViewer(){return this.$refs["sound-viewer"]},objectViewer(){return this.$refs["object-viewer"]},backgroundUrl(){return this.isObjectBackground?this.objectBackgroundUrl:void 0},fileTitle(){return this.preview?this.preview.original_name+"."+this.preview.extension:""},extension(){return this.preview?this.preview.extension:""},status(){return this.preview&&this.preview.status?this.preview.status:"ready"},isBroken(){return this.status==="broken"},isProcessing(){return this.status==="processing"},isReady(){return this.status==="ready"},isMovie(){return this.isReady&&this.extension==="mp4"},isPdf(){return this.isReady&&this.extension==="pdf"},isPicture(){return this.isReady&&["gif","png","jpg","jpeg"].includes(this.extension)},is3DModel(){return this.isReady&&["glb","gltf"].includes(this.extension)},isSound(){return this.isReady&&["wav","mp3"].includes(this.extension)},isFile(){return this.isReady&&!this.isPicture&&!this.isMovie&&!this.is3DModel&&!this.isSound&&!this.isPdf},originalPath(){if(this.preview){const e=this.preview.id,t=this.extension?this.extension:"png";return`/api/${this.isMovie?"movies":"pictures"}/originals/preview-files/${e}.${t}`}else return""},originalDlPath(){return this.preview?`/api/${this.isMovie?"movies":"pictures"}/originals/preview-files/${this.preview.id}/download`:""}},methods:{formatFrame:Se,formatTime:$e,resetVideo(){this.videoViewer&&this.videoViewer.mountVideo()},updateTime(e){this.currentTimeRaw=e,this.currentTime=this.formatTime(this.currentTimeRaw)},changeMaxDuration(e){e?(this.maxDuration=this.formatTime(e),this.videoDuration=e):(this.maxDuration="00:00.000",this.videoDuration=0)},play(){this.isPlaying=!0,this.isDrawing=!1,this.videoViewer&&this.videoViewer.play(),this.isSound&&this.soundViewer.play()},pause(){this.isPlaying=!1,this.videoViewer&&this.videoViewer.pause(),this.isSound&&this.soundViewer.pause()},playModelAnimation(e){this.objectViewer.play(e)},pauseModelAnimation(){this.objectViewer.pause()},goPreviousFrame(){return this.videoViewer.goPreviousFrame()},goNextFrame(){return this.videoViewer.goNextFrame()},onPlayPauseClicked(){this.isPlaying?this.pause():this.play()},get3DAnimations(){return this.$refs["object-viewer"].getAnimations()},getNaturalDimensions(){return this.isMovie?this.videoViewer.getNaturalDimensions():this.pictureViewer.getNaturalDimensions()},getDimensions(){const e={width:0,height:0};return this.container&&(e.width=this.container.offsetWidth,e.height=this.container.offsetHeight),e},resize(){this.isPicture?this.pictureViewer?.resetPicture():this.isMovie?this.videoViewer?.mountVideo():this.isSound&&this.soundViewer?.redraw()},setCurrentFrame(e){this.videoViewer.setCurrentFrame(e)},onPictureSizeChanged(e){e.source="picture",this.$emit("size-changed",e)},onVideoSizeChanged(e){e.source="movie",this.$emit("size-changed",e)},setCurrentTimeRaw(e){this.videoViewer.setCurrentTimeRaw(e)},getCurrentTimeRaw(){return this.isMovie?this.videoViewer.currentTimeRaw:0},showLoupe(){this.pictureViewer.showLoupe()},hideLoupe(){this.pictureViewer.hideLoupe()},updateLoupePosition(e,t){this.pictureViewer.updateLoupePosition(e,t)},extractFrame(e,t){this.videoViewer.setCurrentFrame(t);const s=this.videoViewer.video,m=e.getContext("2d"),n=this.videoViewer.getNaturalDimensions();e.width=n.width,e.height=n.height,m.clearRect(0,0,e.width,e.height),m.drawImage(s,0,0,e.width,e.height)},resetZoom(){this.pictureViewer&&this.pictureViewer.resetPanZoom(),this.videoViewer&&this.videoViewer.resetPanZoom()},pauseZoom(){this.pictureViewer&&this.pictureViewer.pausePanZoom(),this.videoViewer&&this.videoViewer.pausePanZoom()},resumeZoom(){this.pictureViewer&&this.pictureViewer.resumePanZoom(),this.videoViewer&&this.videoViewer.resumePanZoom()},setSpeed(e){this.videoViewer&&this.videoViewer.setSpeed(e)},setVolume(e){this.videoViewer&&this.videoViewer.setVolume(e)}},watch:{preview(){this.isMovie?(this.pause(),this.maxDuration="00:00.000"):this.isPicture&&(this.pause(),setTimeout(()=>{this.pictureViewer&&this.pictureViewer.resetPicture()},10))}}},wn=["title"],kn=["href","title"],yn=["title"];function Cn(e,t,s,m,n,i){const w=v("spinner"),f=v("video-viewer"),C=v("picture-viewer"),p=v("object-viewer"),_=v("sound-viewer"),A=v("pdf-viewer"),V=v("download-icon");return r(),l("div",{ref:"container",class:"preview-viewer dark",style:de({maxHeight:s.isFullScreen?`calc(100vh - ${s.marginBottom}px)`:null})},[i.isBroken?(r(),l("div",{key:0,class:"center status-message",style:de({height:s.defaultHeight+"px"})},[d("p",null,g(e.$t("preview.broken")),1)],4)):c("",!0),i.isProcessing?(r(),l("div",{key:1,class:"center status-message",style:de({height:s.defaultHeight+"px"}),title:e.$t("preview.processing")},[b(w,{"is-processing":!0})],12,wn)):c("",!0),$(b(f,{ref:"video-viewer",class:"video-viewer",name:s.name,big:s.isBig,"default-height":s.defaultHeight,"full-screen":s.isFullScreen,"is-comparing":s.isComparing,"is-comparison-overlay":s.isComparisonOverlay,"is-hd":s.isHd,"is-muted":s.isMuted,"is-repeating":s.isRepeating,light:s.isLight,"current-frame":s.currentFrame,"nb-frames":s.nbFrames,panzoom:!0,preview:s.preview,onDurationChanged:t[0]||(t[0]=I=>e.$emit("duration-changed",I)),onFrameUpdate:t[1]||(t[1]=I=>e.$emit("frame-update",I)),onPlayEnded:t[2]||(t[2]=I=>e.$emit("play-ended")),onSizeChanged:i.onVideoSizeChanged,onVideoEnd:t[3]||(t[3]=I=>e.$emit("video-end")),onVideoLoaded:t[4]||(t[4]=I=>e.$emit("video-loaded"))},null,8,["name","big","default-height","full-screen","is-comparing","is-comparison-overlay","is-hd","is-muted","is-repeating","light","current-frame","nb-frames","preview","onSizeChanged"]),[[me,i.isMovie]]),$(b(C,{ref:"picture-viewer",big:s.isBig,"default-height":s.defaultHeight,"full-screen":s.isFullScreen,"is-comparing":s.isComparing,light:s.isLight,"margin-bottom":s.marginBottom,panzoom:!0,preview:s.preview,onSizeChanged:i.onPictureSizeChanged},null,8,["big","default-height","full-screen","is-comparing","light","margin-bottom","preview","onSizeChanged"]),[[me,i.isPicture]]),i.is3DModel?(r(),T(p,{key:2,ref:"object-viewer",class:"model-viewer","background-url":i.backgroundUrl,"default-height":s.defaultHeight,empty:!i.is3DModel,"full-screen":s.isFullScreen,"is-environment-skybox":s.isEnvironmentSkybox,"is-wireframe":s.isWireframe,light:s.isLight,"preview-url":i.originalPath,onModelLoaded:t[5]||(t[5]=I=>e.$emit("model-loaded"))},null,8,["background-url","default-height","empty","full-screen","is-environment-skybox","is-wireframe","light","preview-url"])):c("",!0),$(b(_,{ref:"sound-viewer",class:"sound-viewer","file-name":i.fileTitle,"preview-url":i.isSound?i.originalPath:"",onPlayEnded:t[6]||(t[6]=I=>e.$emit("play-ended"))},null,8,["file-name","preview-url"]),[[me,i.isSound]]),i.isPdf?(r(),T(A,{key:3,preview:s.preview,"default-height":s.defaultHeight},null,8,["preview","default-height"])):c("",!0),i.isFile?(r(),l("div",{key:4,class:"center",style:de({height:s.defaultHeight+"px"})},[d("a",{class:"button mt2",ref:"preview-file",href:i.originalDlPath,title:i.fileTitle},[b(V,{class:"icon"}),d("span",{class:"text",title:i.fileTitle},g(e.$t("tasks.download_pdf_file",{extension:i.extension})),9,yn)],8,kn)],4)):c("",!0)],4)}const _n=re(gn,[["render",Cn],["__scopeId","data-v-ab0f0ab6"]]),bn={name:"revision-preview",components:{LightEntityThumbnail:St},props:{index:{required:!0,type:Number},isSelected:{default:!1,type:Boolean},previewFile:{required:!0,type:Object}},emits:["preview-dropped","selected"],computed:{dropArea(){return this.$refs["drop-area"]},hasThumbnail(){return["mp4","png"].includes(this.previewFile.extension)},originalName(){return`${this.previewFile.original_name}.${this.previewFile.extension}`}},methods:{onSelected(){this.$emit("selected",this.index)},onPreviewDragStart(e,t){e.dataTransfer.setData("previewIndex",t)},onDragleave(){this.dropArea.style.background="transparent",this.dropArea.style.width="15px"},onDragover(e){e.preventDefault(),this.dropArea.style.width="60px"},onDropped(e){this.dropArea.style.background="transparent",this.dropArea.style.width="15px",this.$emit("preview-dropped",{previousIndex:e.dataTransfer.getData("previewIndex"),newIndex:this.index})}}},xn={class:"wrapper"},Tn=["title"];function Pn(e,t,s,m,n,i){const w=v("light-entity-thumbnail");return r(),l("div",xn,[d("div",{class:Z(["revision-preview",{selected:s.isSelected}]),draggable:"true",onClick:t[0]||(t[0]=he((...f)=>i.onSelected&&i.onSelected(...f),["prevent"])),onDragstart:t[1]||(t[1]=f=>i.onPreviewDragStart(f,s.index))},[i.hasThumbnail?(r(),T(w,{key:0,width:"150px",height:"103px","preview-file-id":s.previewFile.id},null,8,["preview-file-id"])):(r(),l("span",{key:1,title:i.originalName}," ."+g(s.previewFile.extension),9,Tn))],34),d("div",{ref:"drop-area",class:"drop-area",onDragover:t[2]||(t[2]=(...f)=>i.onDragover&&i.onDragover(...f)),onDragleave:t[3]||(t[3]=(...f)=>i.onDragleave&&i.onDragleave(...f)),onDrop:t[4]||(t[4]=(...f)=>i.onDropped&&i.onDropped(...f))},null,544)])}const Sn=re(bn,[["render",Pn],["__scopeId","data-v-5ec639b8"]]),An=()=>yt(()=>import("./TaskInfo-C2DOZkHo.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65]));let Ie=1;const Dn={name:"preview-player",mixins:[Vt,ze,It],components:{ArrowUpRightIcon:vt,BrowsingBar:vn,ButtonSimple:Ae,ButtonSound:Mt,ColorPicker:Et,Combobox:Zt,ComboboxStyled:Xt,DownloadIcon:Xe,GlobeIcon:pt,LinkIcon:Ze,PencilPicker:Ft,PreviewViewer:_n,RevisionPreview:Sn,SpeedButton:Dt,TaskInfo:kt(An),VideoProgress:At},props:{canvasId:{type:String,default:"annotation-canvas"},big:{type:Boolean,default:!1},entityPreviewFiles:{type:Object,default:()=>{}},isAssigned:{type:Boolean,default:!1},lastPreviewFiles:{type:Array,default:()=>[]},light:{type:Boolean,default:!1},link:{type:String},readOnly:{type:Boolean,default:!1},previews:{type:Array,default:()=>[]},task:{type:Object,default:()=>{}},taskTypeMap:{type:Map,default:()=>new Map},extraWide:{type:Boolean,default:!1},entityType:{type:String}},emits:["add-extra-preview","add-preview","change-current-preview","comment-added","frame-updated","previews-order-changed","remove-extra-preview"],data(){return{annotations:[],availableAnimations:[],comparisonPreviewIndex:0,current3DAnimation:null,currentFrame:0,currentIndex:1,fullScreen:!1,currentBackground:null,currentTime:"00:00:00:00",currentTimeRaw:0,is3DAnimation:!1,isObjectBackground:!1,isAnnotationsDisplayed:!0,isEnvironmentSkybox:!1,isCommentsHidden:!0,isComparing:!1,isDrawing:!1,isHd:!1,isLoading:!1,isMuted:!1,isPlaying:!1,isOrdering:!0,isRepeating:!1,isTyping:!1,isWireframe:!1,isZoomPan:!1,maxDuration:"00:00:00:00",movieDimensions:{width:1920,height:1080},objectBackgroundUrl:null,pencil:"big",pencilPalette:["big","medium","small"],previewToCompare:null,previewToCompareId:null,speed:3,taskTypeId:this.entityPreviewFIles?Object.keys(this.entityPreviewFiles)[0]:null,textColor:"#ff3860",videoDuration:0,volume:50,width:0,comparisonMode:"sidebyside",comparisonModeOptions:[{label:this.$t("playlists.actions.side_by_side"),value:"sidebyside"},{label:`${this.$t("playlists.actions.overlay")} 0%`,value:"overlay0"},{label:`${this.$t("playlists.actions.overlay")} 25%`,value:"overlay25"},{label:`${this.$t("playlists.actions.overlay")} 50%`,value:"overlay50"},{label:`${this.$t("playlists.actions.overlay")} 75%`,value:"overlay75"},{label:`${this.$t("playlists.actions.overlay")} 100%`,value:"overlay100"}]}},mounted(){this.configureEvents(),this.setupFabricCanvas(),this.reloadAnnotations(),this.isPicture&&this.loadAnnotation(),this.resetPreviewFileMap(),this.initPreferences(),(this.isSound||this.is3DModel||this.isFile)&&this.fixCanvasSize({width:0,height:0,left:0,top:0}),new ResizeObserver(this.comparisonViewer.resize).observe(this.container),this.is3DModel&&(this.currentBackground=this.productionBackgrounds.find(this.isDefaultBackground)||null,this.onObjectBackgroundSelected()),this.resetPencilConfiguration(),this.isMuted?this.previewViewer.setVolume(0):(this.volume=ae.getPreference("player:volume")||this.volume,this.previewViewer.setVolume(this.volume))},beforeUnmount(){this.endAnnotationSaving(),this.removeEvents()},computed:{..._e(["assetMap","getProductionBackgrounds","isCurrentUserArtist","isTVShow","organisation","productionMap","selectedConcepts","user"]),comparisonPreview(){return this.previewToCompare?.previews.length>0&&this.comparisonPreviewIndex>0?this.previewToCompare.previews[this.comparisonPreviewIndex-1]:this.previewToCompare},comparisonPreviewLength(){if(this.previewToCompare){const e=this.previewToCompare.previews;return e?e.length+1:0}else return 0},container(){return this.$refs.container},comparisonAnnotations(){return this.previewToCompare&&this.isComparing?this.previewToCompare.annotations:[]},comparisonViewer(){return this.$refs["comparison-preview-viewer"]},canvasWrapper(){return this.$refs["canvas-wrapper"]},canvasComparisonWrapper(){return this.$refs["canvas-comparison-wrapper"]},previewViewer(){return this.$refs["preview-viewer"]},previewContainer(){return this.$refs["preview-container"]},commentContainer(){return this.$refs["task-info-player"]},progress(){return this.$refs.progress},currentFrameLabel(){const e=Math.min(this.nbFrames,this.currentFrame);return Se(e+1)},currentPreview(){return this.previews&&this.previews.length>0&&this.currentIndex-1<this.previews.length?this.previews[this.currentIndex-1]:{}},currentProduction(){return this.productionMap.get(this.task.project_id)},marginBottom(){let e=32;return this.isMovie&&(e+=28),this.isOrdering&&(e+=140),e},defaultHeight(){if(this.fullScreen)return screen.height-this.marginBottom;{let e=screen.height>800?470:300;return this.isMovie&&(e=screen.height>800?442:272),screen.width>1300&&(!this.light||this.big)?e:200}},fps(){return parseFloat(this.currentProduction?.fps)||25},frameDuration(){return Math.round(1/this.fps*1e4)/1e4},extension(){return this.currentPreview?this.currentPreview.extension:""},isConcept(){return this.entityType==="Concept"},isPicture(){return["gif","png","jpg","jpeg"].includes(this.extension)},isMovie(){return this.extension==="mp4"},is3DModel(){return["glb","gltf"].includes(this.extension)},isSound(){return["mp3","wav"].includes(this.extension)},isPdf(){return this.extension==="pdf"},isFile(){return!this.isPicture&&!this.isMovie},isFullScreenEnabled(){return!!(document.fullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled||document.webkitSupportsFullscreen||document.webkitFullscreenEnabled||document.createElement("video").webkitRequestFullScreen)},originalPath(){if(this.currentPreview){const e=this.currentPreview.id,t=this.extension?this.extension:"png";return`/api/${this.isMovie?"movies":"pictures"}/originals/preview-files/${e}.${t}`}else return""},originalDlPath(){return this.currentPreview?`/api/${this.isMovie?"movies":"pictures"}/originals/preview-files/${this.currentPreview.id}/download`:""},taskTypeOptions(){return this.entityPreviewFiles?Object.keys(this.entityPreviewFiles).filter(t=>this.entityPreviewFiles[t].filter(m=>["mp4","png"].includes(m.extension)).length>0&&this.taskTypeMap.get(t)).map(t=>{const s=this.taskTypeMap.get(t);return{label:s.name,value:s.id}}):[]},lastPreviewFileOptions(){return this.lastPreviewFiles?[...this.lastPreviewFiles].sort((e,t)=>t.revision-e.revision).map(e=>({value:e.id,label:`v${e.revision}`,validation_status:e.validation_status})):[]},previewFileOptions(){if(!this.entityPreviewFiles)return[];const e=this.entityPreviewFiles[this.taskTypeId];return e&&e.length>0?e.map(t=>({label:`v${t.revision}`,value:t.id})):[]},isComparisonEnabled(){return this.fullScreen||this.extraWide},nbFrames(){const e=this.currentPreview&&this.currentPreview.duration?this.currentPreview.duration:this.videoDuration;return Math.round(e*this.fps)},isComparisonOverlay(){return this.comparisonMode!=="sidebyside"&&this.isComparing},overlayOpacity(){if(this.isComparing&&this.isComparisonOverlay)switch(this.comparisonMode){case"overlay0":return 0;case"overlay25":return .25;case"overlay50":return .5;case"overlay75":return .75;case"overlay100":return 1;default:return 1}else return 1},backgroundOptions(){const e=this.$t("playlists.actions.default");return[{label:this.$t("playlists.actions.select_background"),value:null,placeholder:!0},...this.productionBackgrounds.map(t=>({value:t,label:t.name,optionLabel:t.name+(this.isDefaultBackground(t)?` (${e})`:"")}))]},productionBackgrounds(){return this.getProductionBackgrounds(this.task?.project_id)},currentConcept(){return this.selectedConcepts.values().next().value},conceptLinkedEntities(){return this.getLinkedEntities(this.currentConcept)}},methods:{...Le(["editConcept","refreshPreview","updateRevisionPreviewPosition"]),formatFrame:Se,formatTime:$e,isCurrentRevision(e){return e.revision===this.currentPreview.revision},getRevisionTitle(e){return`${this.$t("playlists.actions.display_revision")} ${e.revision}`},setVideoFrameContext(e){if(e=Math.min(e,this.nbFrames-1),this.currentFrame!==e){const t=e*this.frameDuration;this.currentFrame=e,this.currentTimeRaw=t,this.currentTime=this.formatTime(t,this.fps),this.progress.updateProgressBar(e),this.$emit("frame-updated",e),this.isPlaying||this.syncComparisonViewer(),this.isPlaying||this.loadAnnotation()}},onSubPreviewsWheel(e){!e.deltaX&&(e.preventDefault(),this.$refs["revision-previews"].scrollLeft+=e.deltaY)},setCurrentFrame(e){this.currentFrame!==e&&(this.setVideoFrameContext(e),this.previewViewer.setCurrentFrame(e))},initPreferences(){this.isRepeating=ae.getBoolPreference("player:repeating"),this.isMuted=ae.getBoolPreference("player:muted"),this.isHd=!!this.organisation.hd_by_default,this.isOrdering=this.previews.length>1&&ae.getPreference("player:ordering")!=="false"},toggleIsOrdering(){this.isOrdering=!this.isOrdering,ae.setPreference("player:ordering",this.isOrdering)},focus(){this.$refs.container.focus()},timeCodeClicked({versionRevision:e,frame:t}){const s=this.lastPreviewFiles.find(m=>m.revision===parseInt(e));s&&(this.changeCurrentPreview(s),setTimeout(()=>{this.setCurrentFrame(t)},20))},configureVideo(){this.isPlaying=!1,this.isRepeating=!1},changeMaxDuration(e){e?(window.chrome&&(e+=.001),this.currentPreview.duration&&(e=this.currentPreview.duration),e=Ht(e,this.fps),this.videoDuration=e,this.maxDuration=this.formatTime(this.videoDuration-this.frameDuration,this.fps)):(this.maxDuration="00:00:00:00",this.videoDuration=0)},getCurrentTime(){if(!this.isMovie)return 0;const e=oe(this.currentTimeRaw,this.fps);return Number(e.toPrecision(4))},getCurrentFrame(){if(this.currentFrame)return this.currentFrame+1;{const e=oe(this.currentTimeRaw,this.fps)||0;return Math.round(e/this.frameDuration)+1}},play(){this.isPlaying=!0,this.isDrawing=!1,this.previewViewer&&(this.is3DModel?this.previewViewer.playModelAnimation(this.current3DAnimation):(this.clearCanvas(),this.currentFrame>=this.nbFrames-1&&(this.previewViewer.setCurrentFrame(0),this.comparisonViewer.setCurrentFrame(0)),this.previewViewer.play(),this.comparisonViewer&&this.isComparing&&this.comparisonViewer.play()))},pause(){this.isPlaying&&(this.isPlaying=!1,this.is3DModel?this.previewViewer.pauseModelAnimation():(this.previewViewer&&this.previewViewer.pause(),this.comparisonViewer&&this.comparisonViewer.pause(),this.$nextTick(()=>{this.syncComparisonViewer()})))},goPreviousFrame(){this.clearCanvas(),this.previewViewer.goPreviousFrame(),this.syncComparisonViewer()},goNextFrame(){this.clearCanvas(),this.previewViewer.goNextFrame(),this.syncComparisonViewer()},goPreviousDrawing(){const e=this.getPreviousAnnotationTime(this.currentTimeRaw);this.jumpToAnnotationFrame(e)},goNextDrawing(){const e=this.getNextAnnotationTime(this.currentTimeRaw);this.jumpToAnnotationFrame(e)},jumpToAnnotationFrame(e){if(e){const t=e.frame-1;this.clearCanvas(),this.setCurrentFrame(t),this.syncComparisonViewer()}},syncComparisonViewer(){this.comparisonViewer&&this.isComparing&&this.comparisonViewer.setCurrentFrame(this.currentFrame)},onProgressChanged(e){this.reloadAnnotations(),this.currentFrame!==e&&(this.clearCanvas(),this.setCurrentFrame(e))},onVideoEnd(){this.isPlaying=!1,this.isRepeating&&(this.setCurrentFrame(0),this.syncComparisonViewer(),this.$nextTick(()=>{this.play()}))},onPlayPauseClicked(){this.clearFocus(),this.isPlaying?this.pause():this.play()},onRepeatClicked(){this.clearFocus(),this.isRepeating=!this.isRepeating,ae.setPreference("player:repeating",this.isRepeating)},onToggleSoundClicked(){this.clearFocus(),this.isMuted=!this.isMuted,ae.setPreference("player:muted",this.isMuted)},getDimensions(){const e={width:0,height:0};return this.previewContainer&&(e.width=this.previewContainer.offsetWidth,e.height=this.previewContainer.offsetHeight),e},setupFabricCanvas(){const e=this.getDimensions(),t=e.width,s=e.height;this.fabricCanvas=wt(new Me.fabric.Canvas(this.canvasId,{fireRightClick:!0,width:t,height:s,enablePointerEvents:!0}));const m=new Rt(this.fabricCanvas);m.width=20,m.color="#000",m.disableTouch=!0,m.disableMouse=!0,m.pressureManager.fallback=.5,this.fabricCanvas.freeDrawingBrush=m,this.fabricCanvasComparison=new Me.fabric.StaticCanvas(this.canvasId+"-comparison"),this.configureCanvas()},fixCanvasSize(e){if(!this.fabricCanvas||this.isPicture&&e.source==="movie"||this.isMovie&&e.source==="picture")return;const{height:t,left:s,top:m,width:n}=e;this.canvasWrapper.style.top=m+"px",this.canvasWrapper.style.left=s+"px",this.canvasWrapper.style.width=n+"px",this.canvasWrapper.style.height=t+"px",(this.fabricCanvas.width!==n||this.fabricCanvas.height!==t)&&this.fabricCanvas.setDimensions({width:n,height:t}),this.refreshCanvas()},fixCanvasComparisonSize(e){if(!this.fabricCanvasComparison)return;const{height:t,left:s,top:m,width:n}=e;this.canvasComparisonWrapper.style.top=m+"px",this.canvasComparisonWrapper.style.left=this.getDimensions().width/2+s+"px",this.canvasComparisonWrapper.style.width=n+"px",this.canvasComparisonWrapper.style.height=t+"px",(this.fabricCanvasComparison.width!==n||this.fabricCanvasComparison.height!==t)&&this.fabricCanvasComparison.setDimensions({width:n,height:t}),this.refreshCanvas()},setFullScreen(){this.endAnnotationSaving();const e=this.documentSetFullScreen(this.container);Promise.resolve(e).finally(()=>{this.fullScreen=!0}),this.$nextTick(()=>{this.clearFocus()})},exitFullScreen(){this.endAnnotationSaving();const e=this.documentExitFullScreen();Promise.resolve(e).finally(()=>{this.fullScreen=!1,this.$nextTick(()=>{this.previewViewer?.resize(),this.comparisonViewer?.resize()})}),this.isComparing=!1,this.isCommentsHidden=!0,this.$nextTick(()=>{this.clearFocus(),this.previewViewer?.resize(),this.comparisonViewer?.resize(),this.triggerResize()})},onFullscreenClicked(){this.fullScreen?(this.removeTypeArea(),this.exitFullScreen()):(this.addTypeArea(),this.setFullScreen())},onFullScreenChange(){this.fullScreen&&!this.isFullScreen()&&(this.isComparing=!1,this.fullScreen=!1,this.isCommentsHidden=!0,this.endAnnotationSaving(),this.$nextTick(()=>{this.previewViewer?.resize(),this.comparisonViewer?.resize(),this.clearFocus(),this.$nextTick(()=>{this.loadAnnotation()})})),setTimeout(()=>{this.previewViewer?.resize(),this.comparisonViewer?.resize()},500)},onCompareClicked(){this.clearFocus(),this.isComparing?this.isComparing=!1:(this.isComparing=!0,this.taskTypeId=this.taskTypeOptions[0].value,this.previewToCompareId="",this.$nextTick(()=>{this.previewToCompareId=this.previewFileOptions[0].value}),this.isDrawing=!1)},setDefaultComparisonTaskType(){if(!this.entityPreviewFiles)return"";const e=Object.keys(this.entityPreviewFiles);if(e&&e.length>0){const t=this.taskTypeOptions.find(s=>this.entityPreviewFiles[s.value].findIndex(m=>m.id===this.currentPreview.id)>=0);t?this.taskTypeId=t.value:this.taskTypeOptions.length>0&&(this.taskTypeId=this.taskTypeOptions[0].value),this.taskTypeId&&this.setDefaultComparisonPreview()}else this.previewToCompareId=null},setDefaultComparisonPreview(){if(!this.entityPreviewFiles)return"";let e=this.entityPreviewFiles[this.taskTypeId];e?(e=e.filter(t=>t.id!==this.currentPreview.id),e.length>0?this.previewToCompareId=e[0].id:this.previewToCompareId=null):this.previewToCompareId=null},onPreviousComparisonClicked(){const e=this.comparisonPreviewIndex-1;this.comparisonPreviewIndex=e<0?this.comparisonPreviewLength-1:e},onNextComparisonClicked(){const e=this.comparisonPreviewIndex+1;this.comparisonPreviewIndex=e>this.comparisonPreviewLength-1?0:e},resetPreviewFileMap(){if(this.previewFileMap={},this.entityPreviewFiles){const e=this.entityPreviewFiles[this.taskTypeId];e&&e.forEach(t=>{this.previewFileMap[t.id]=t})}},onZoomPanClicked(){this.isZoomPan?(this.isZoomPan=!1,this.isAnnotationsDisplayed=!0):(this.isDrawing=!1,this.isAnnotationsDisplayed=!1,this.isZoomPan=!0)},onObjectBackgroundSelected(){this.objectBackgroundUrl=this.currentBackground?.url;const e=!!this.objectBackgroundUrl;this.isObjectBackground=e,this.isEnvironmentSkybox=e},isDefaultBackground(e){const t=this.currentProduction?.default_preview_background_file_id;return t?e.id===t:e.is_default},setPlayerSpeed(e){this.previewViewer.setSpeed(e),this.comparisonViewer.setSpeed(e)},triggerResize(){window.dispatchEvent(new Event("resize"))},onDeleteClicked(){this.clearFocus(),this.deleteSelection()},onPencilAnnotateClicked(){this.clearFocus(),this.isDrawing?this.isDrawing=!1:(this._resetColor(),this._resetPencil(),this.isTyping=!1,this.isDrawing=!0)},onTypeClicked(){this.clearFocus(),this.isTyping?this.isTyping=!1:(this.isDrawing=!1,this.isTyping=!0)},refreshCanvas(){this.clearCanvas(),this.annotations.length>0&&(this.isMovie?this.loadAnnotation():this.isPicture&&this.loadAnnotation())},getAnnotation(e){if(this.isMovie)return e=oe(e,this.fps),this.annotations.find(t=>oe(t.time,this.fps)<e+1e-4&&oe(t.time,this.fps)>e-1e-4);if(this.isPicture)return this.annotations.find(t=>t.time===0)},getSortedAnnotations(){const e=this.annotations;return e.sort((t,s)=>t.time-s.time),e},getNextAnnotationTime(e){const t=this.getSortedAnnotations();if(this.isMovie)return e=oe(e,this.fps),t.find(s=>oe(s.time,this.fps)>e+1e-4);if(this.isPicture)return t.find(s=>s.time===0)},getPreviousAnnotationTime(e){const t=this.getSortedAnnotations();if(this.isMovie)return e=oe(e,this.fps),t.findLast(s=>oe(s.time,this.fps)<e-1/this.fps+1e-4);if(this.isPicture)return t.find(s=>s.time===0)},onAnnotationDisplayedClicked(){this.clearFocus(),this.isAnnotationsDisplayed=!this.isAnnotationsDisplayed,this.isZoomPan=!1,this.previewViewer.resetZoom(),this.comparisonViewer.resetZoom()},saveAnnotations(){let e=0;this.isMovie&&(e=this.currentFrame*this.frameDuration,e=oe(e,this.fps),e=Number(e.toPrecision(4)));const t=this.getAnnotation(e),s=this.getNewAnnotations(e,this.currentFrame,t);if(!this.readOnly){const m=this.currentPreview;this.notSaved||this.startAnnotationSaving(m,s)}},loadAnnotation(e){let t=0;if(!e&&(this.isMovie&&(t=this.currentFrame*this.frameDuration),e=this.getAnnotation(t),!e)){this.isMovie||console.warn("Annotations are malformed or empty."),this.isComparing&&!this.isComparisonOverlay&&this.loadComparisonAnnotation(t);return}this.fabricCanvas||this.setupFabricCanvas(),this.isMovie&&this.previewViewer&&this.isPlaying&&this.previewViewer.pause(),this.clearCanvas(),this.loadSingleAnnotation(e),this.isComparing&&!this.isComparisonOverlay&&this.loadComparisonAnnotation(t)},loadComparisonAnnotation(e){this.fabricCanvasComparison.clear(),this.previewToCompare=this.previewFileMap[this.previewToCompareId];let t=[];this.previewToCompare&&this.previewToCompare.annotations&&(t=this.previewToCompare.annotations);let s=null;this.isMovie?s=t.find(m=>m.time===e):this.isPicture&&(s=t.find(m=>m.time===0)),s&&this.loadSingleAnnotationComparison(s)},reloadAnnotations(){if(this.annotations=[],this.currentPreview.annotations){const e=[];this.currentPreview.annotations.forEach&&this.currentPreview.annotations.forEach(t=>{t.time>=0&&e.push({...t})}),this.annotations=e.sort((t,s)=>t.time<s.time)||[]}else this.annotations=[];return this.annotations},getFileFromCanvas(e,t){return new Promise((s,m)=>{e.toBlob(n=>{const i=new File([n],t,{type:"image/png",lastModified:new Date().getTime()});return s(i)})})},extractVideoFrame(e,t){return new Promise(s=>{this.setCurrentFrame(t),this.$nextTick(()=>{setTimeout(()=>{this.previewViewer.extractFrame(e,t),s()},500)})})},copyAnnotationCanvas(e,t){return new Promise(s=>{this.clearCanvas(),this.loadSingleAnnotation(t),setTimeout(()=>{const m=e.getContext("2d"),n=e.width/this.fabricCanvas.width,i=document.getElementById("resize-annotation-canvas"),w=new Me.fabric.Canvas("resize-annotation-canvas",{width:e.width,height:e.height});this.fabricCanvas.getObjects().find(f=>{f._objects?f._objects.forEach(C=>{w.add(C),C.strokeWidth=C.strokeWidth/n}):(w.add(f),f.strokeWidth=f.strokeWidth/n)}),w.setZoom(n),setTimeout(()=>(m.drawImage(i,0,0,e.width,e.height),setTimeout(()=>{w.dispose()},100),s()),100)},100)})},async extractAnnotationSnapshots(){const e=[],t=this.annotations.sort((m,n)=>parseInt(n.frame)<parseInt(m.frame)?1:-1);let s=1;for(const m of t){const n=document.getElementById("annotation-snapshot"),i=`annotation ${s}.png`,w=oe(m.time,this.fps)/this.frameDuration;await this.extractVideoFrame(n,w),await this.copyAnnotationCanvas(n,m);const f=await this.getFileFromCanvas(n,i);e.push(f),s++}return this.previewViewer.setCurrentFrame(this.currentFrame-1),this.$nextTick(()=>{this.clearCanvas()}),e},entityPath(e,t){const s=this.isTVShow?e.episode_id||"main":null;return gt(e.id,this.currentProduction.id,t,s)},getLinkedEntities(e){return e.entity_concept_links.map(t=>this.assetMap.get(t)).filter(Boolean)},onRemoveLink(e){const t={id:this.currentConcept.id,entity_concept_links:this.currentConcept.entity_concept_links.filter(s=>s!==e.id)};this.editConcept(t)},onKeyDown(e){if(!["INPUT","TEXTAREA"].includes(e.target.tagName))if(e.keyCode===46||e.keyCode===8)this.deleteSelection();else if(e.keyCode===37)this.goPreviousFrame();else if(e.keyCode===39)this.goNextFrame();else if(e.keyCode===32){let n;const i=document.getElementById("temp-playlist-modal");return i&&(n=window.getComputedStyle(i)),(!n||n&&n.display==="none")&&(this.onPlayPauseClicked(),this.pauseEvent(e)),!1}else e.key==="."?this.goNextDrawing():e.key===","?this.goPreviousDrawing():e.keyCode===68?(this.container.focus(),this.pauseEvent(e),this.onPencilAnnotateClicked()):(e.ctrlKey||e.metaKey)&&e.keyCode===90?this.undoLastAction():e.altKey&&e.keyCode===82?this.redoLastAction():e.altKey&&e.keyCode===74?this.onPreviousClicked():e.altKey&&e.keyCode===75?this.onNextClicked():(e.ctrlKey||e.metaKey)&&e.keyCode===67?this.copyAnnotations():(e.ctrlKey||e.metaKey)&&e.keyCode===86?this.pasteAnnotations():e.altKey&&e.key==="o"?(e.preventDefault(),e.stopPropagation(),this.toggleFullOverlayComparison()):e.code==="Escape"&&this.fullScreen&&this.onFullScreenChange()},async toggleFullOverlayComparison(){this.isComparing||(this.isComparing=!0,await this.$nextTick(),await this.$nextTick()),this.$nextTick(()=>{this.comparisonMode==="overlay100"?this.comparisonMode="overlay0":this.comparisonMode="overlay100"})},onCommentClicked(){const e=this.previewContainer.offsetHeight;this.isCommentsHidden=!this.isCommentsHidden,this.isCommentsHidden||(this.commentContainer.$el.style.height=`${e}px`,this.commentContainer.focusCommentTextarea()),this.endAnnotationSaving(),this.$nextTick(()=>{this.previewViewer.resize(),this.comparisonViewer.resize(),this.loadAnnotation()})},onModelLoaded(){this.is3DAnimation=this.previewViewer.get3DAnimations().length>0,this.is3DAnimation&&(this.available3DAnimations=this.previewViewer.get3DAnimations().map(e=>({label:e,value:e})),this.current3DAnimation=this.available3DAnimations[0].value,this.isPlaying=!0,this.previewViewer.playModelAnimation(this.current3DAnimation))},onVideoLoaded(){this.isMovie&&(this.movieDimensions={width:this.currentPreview.width,height:this.currentPreview.height},this.setCurrentFrame(0),this.progress.updateProgressBar(0))},configureEvents(){window.addEventListener("keydown",this.onKeyDown,!1),window.addEventListener("beforeunload",this.onWindowsClosed),this.container.addEventListener("fullscreenchange",this.onFullScreenChange,!1),this.container.addEventListener("mozfullscreenchange",this.onFullScreenChange,!1),this.container.addEventListener("MSFullscreenChange",this.onFullScreenChange,!1),this.container.addEventListener("webkitfullscreenchange",this.onFullScreenChange,!1)},removeEvents(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("beforeunload",this.onWindowsClosed),this.container.removeEventListener("fullscreenchange",this.onFullScreenChange,!1),this.container.removeEventListener("mozfullscreenchange",this.onFullScreenChange,!1),this.container.removeEventListener("MSFullscreenChange",this.onFullScreenChange,!1),this.container.removeEventListener("webkitfullscreenchange",this.onFullScreenChange,!1)},changeCurrentPreviewFile(e){const t=this.lastPreviewFiles.find(s=>s.id===e);this.changeCurrentPreview(t)},changeCurrentPreview(e){this.$emit("change-current-preview",e)},onAddPreviewClicked(){this.$emit("add-preview")},onRemovePreviewClicked(){this.$emit("remove-extra-preview",this.currentPreview)},onPreviousClicked(){this.currentIndex>1?this.currentIndex--:this.currentIndex=this.previews.length},onNextClicked(){this.currentIndex<this.previews.length?this.currentIndex++:this.currentIndex=1},displayFirst(){this.currentIndex>1&&(this.currentIndex=1)},displayLast(){this.currentIndex=this.previews.length},onCanvasMouseMoved(e){if(this.isPicture&&this.$options.loupe){const t=this.canvasWrapper.style.width,s=this.canvasWrapper.style.height;this.previewViewer.updateLoupePosition(e,{width:t,height:s})}else if(this.isMovie&&this.$options.scrubbing){const t=this.getClientX(e.e);t-this.$options.scrubStartX<0?this.goPreviousFrame():this.goNextFrame(),this.$options.scrubStartX=t}},onCanvasClicked(e){if(e.button>1&&this.isPicture&&this.fullScreen){this.$options.loupe=!0,this.previewViewer.showLoupe();const t=this.canvasWrapper.style.width,s=this.canvasWrapper.style.height;this.previewViewer.updateLoupePosition(e,{width:t,height:s})}else e.button>1&&this.isMovie&&(this.$options.scrubbing=!0,this.$options.scrubStartX=this.getClientX(e),this.$options.scrubStartTime=Number(this.currentTimeRaw));return!1},onCanvasReleased(e){return this.isPicture&&this.$options.loupe?(this.previewViewer.hideLoupe(),this.$options.loupe=!1):this.isMovie&&this.$options.scrubbing&&(this.$options.scrubbing=!1),!1},onRevisionPreviewSelected(e){this.currentIndex=e},onRevisionPreviewDropped({previousIndex:e,newIndex:t}){const s=this.previews[e];this.updateRevisionPreviewPosition({previousIndex:e,newIndex:t,revision:this.currentPreview.revision,taskId:this.currentPreview.task_id,previewId:s.id}).catch(console.error),this.$emit("previews-order-changed"),this.$nextTick(()=>{this.currentIndex=t+1})},isValidPreviewModification(e,t){return!this.notSaved&&this.currentPreview&&e===this.currentPreview.id&&!this.isWriting(t)}},watch:{current3DAnimation(){this.is3DModel&&(this.isPlaying=!0,this.previewViewer.playModelAnimation(this.current3DAnimation))},currentPreview(){this.endAnnotationSaving(),this.reloadAnnotations(),this.isComparing=!1,this.isMovie?(this.configureVideo(),this.pause(),this.maxDuration="00:00:00:00",this.isDrawing=!1,setTimeout(()=>{this.previewViewer&&(this.movieDimensions=this.previewViewer.getNaturalDimensions(),this.previewViewer.resize(),this.comparisonViewer.resize())},500)):this.isPicture?(this.pause(),this.isDrawing=!1,this.refreshCanvas(),setTimeout(()=>{this.previewViewer?.resize(),this.comparisonViewer?.resize()},500)):this.is3DModel?(this.fixCanvasSize({width:0,height:0,left:0,top:0}),this.previewViewer?.resize()):(this.isSound||this.isFile)&&this.fixCanvasSize({width:0,height:0,left:0,top:0}),this.$nextTick(()=>{this.previewViewer&&this.previewViewer.isBroken&&this.clearCanvas()}),this.setDefaultComparisonTaskType(),this.isOrdering=this.previews.length>1&&ae.getPreference("player:ordering")!=="false"},"currentPreview.revision"(){this.endAnnotationSaving(),this.currentIndex=Ie<=this.previews.length&&Ie||1},currentIndex(){Ie=this.currentIndex},previewToCompare(){this.comparisonPreviewIndex=0,this.$nextTick(()=>{this.previewViewer.resize(),this.comparisonViewer.resize()})},previewToCompareId(){this.$nextTick(()=>{this.comparisonViewer&&this.comparisonViewer.pause(),this.previewToCompare=this.previewFileMap[this.previewToCompareId],this.isComparing&&(this.setCurrentFrame(this.currentFrame-1),setTimeout(()=>{this.syncComparisonViewer()},200),this.pause(),this.isMovie?this.loadComparisonAnnotation(this.currentTime):this.isPicture&&this.loadComparisonAnnotation(0))})},taskTypeId(){this.resetPreviewFileMap(),this.setDefaultComparisonPreview()},isComparing(){this.endAnnotationSaving(),this.isComparing||(this.comparisonViewer&&this.comparisonViewer.pause(),this.taskTypeId="",this.previewToCompareId=""),this.$nextTick(()=>{this.previewViewer.resize(),this.comparisonViewer.resize(),this.previewViewer.resetZoom(),this.comparisonViewer.resetZoom()})},light(){this.endAnnotationSaving(),this.previewViewer.resize(),this.comparisonViewer.resize()},extraWide(){this.endAnnotationSaving(),this.previewViewer.resize(),this.comparisonViewer.resize()},isDrawing(){this.fabricCanvas?this.fabricCanvas.isDrawingMode=this.isDrawing:this.endAnnotationSaving(),this.isDrawing&&(this.isAnnotationsDisplayed=!0,this.isZoomPan=!1)},isOrdering(){this.$nextTick(()=>{this.previewViewer.resize(),this.comparisonViewer.resize()})},isTyping(){this.isTyping&&(this.isAnnotationsDisplayed=!0);const e=this.canvasWrapper.getElementsByClassName("upper-canvas")[0];this.isTyping&&e?e.addEventListener("dblclick",this.addText):e.removeEventListener("dblclick",this.addText)},isAnnotationsDisplayed(){this.isAnnotationsDisplayed&&this.$nextTick(()=>{this.previewViewer.resetZoom(),this.comparisonViewer.resetZoom()}),this.isAnnotationsDisplayed||(this.isDrawing=!1)},isComparisonOverlay(){this.$nextTick(()=>{this.previewViewer.resize(),this.comparisonViewer.resize()})},isZoomPan(){this.isZoomPan?this.previewViewer.resumeZoom():this.previewViewer.pauseZoom()},speed(){const t=[.25,.5,1,1.5,2][this.speed-1];this.setPlayerSpeed(t)},volume(){this.previewViewer.setVolume(this.volume),ae.setPreference("player:volume",this.volume)}}},Fn={ref:"container",class:"preview-player dark",tabindex:"-1"},En={class:"preview filler"},Mn={class:"flexrow filler"},Vn={class:"preview-container filler",ref:"preview-container"},In=["id"],Rn=["id"],Bn={class:"viewers"},Ln={class:"button-bar",ref:"button-bar"},On={class:"buttons flexrow pull-bottom",ref:"buttons"},Nn={key:0,class:"left flexrow"},zn={key:1,class:"left flexrow"},Un=["title"],jn={key:3,class:"flexrow-item time-indicator"},Wn=["title"],Hn=["title"],qn={key:0},Kn={key:1},Zn={key:2,class:"flexrow flexrow-item"},Xn={key:4,class:"flexrow flexrow-item comparison-list"},Yn={class:"flexrow-item comparison-index"},Gn={key:3,class:"entity-name mr1"},Jn={key:4,class:"separator"},Qn={class:"flexrow"},$n={key:0,class:"flexrow"},er={class:"annotation-tools"},tr={class:"annotation-tools"},ir={key:1,class:"flexrow"},sr={key:2,class:"separator"},nr=["href","title"],rr={key:4,class:"separator"},or={key:6,class:"flexrow"},ar={key:7,class:"separator"},lr=["href","title"],dr=["href","title"],cr={key:0,class:"flexrow"},mr={class:"tags"},hr={id:"annotation-snapshot",ref:"annotation-snapshot"},ur={id:"resize-annotation-canvas",ref:"resize-annotation-canvas"};function fr(e,t,s,m,n,i){const w=v("preview-viewer"),f=v("task-info"),C=v("video-progress"),p=v("button-simple"),_=v("combobox-styled"),A=v("button-sound"),V=v("speed-button"),I=v("combobox"),K=v("color-picker"),S=v("pencil-picker"),P=v("globe-icon"),z=v("arrow-up-right-icon"),h=v("browsing-bar"),G=v("link-icon"),ie=v("download-icon"),se=v("router-link"),y=v("revision-preview");return r(),l("div",Fn,[d("div",En,[d("div",Mn,[d("div",Vn,[$(d("div",{class:"canvas-wrapper",ref:"canvas-wrapper",oncontextmenu:"return false",onClick:t[0]||(t[0]=(...x)=>i.onCanvasClicked&&i.onCanvasClicked(...x))},[d("canvas",{ref:"annotation-canvas",class:"canvas",id:s.canvasId},null,8,In)],512),[[me,!n.isZoomPan&&n.isAnnotationsDisplayed]]),$(d("div",{class:"canvas-comparison-wrapper",ref:"canvas-comparison-wrapper",oncontextmenu:"return false",onClick:t[1]||(t[1]=(...x)=>i.onCanvasClicked&&i.onCanvasClicked(...x))},[d("canvas",{ref:"annotation-canvas-comparison",class:"canvas",id:`${s.canvasId}-comparison`},null,8,Rn)],512),[[me,!n.isZoomPan&&n.isAnnotationsDisplayed&&n.isComparing&&n.previewToCompare&&!i.isComparisonOverlay]]),d("div",Bn,[b(w,{ref:"preview-viewer",class:"preview-viewer","current-frame":n.currentFrame,"default-height":i.defaultHeight,"is-big":s.big,"is-comparing":n.isComparing&&i.isComparisonEnabled,"is-comparison-overlay":i.isComparisonOverlay,"is-environment-skybox":n.isEnvironmentSkybox,"is-full-screen":n.fullScreen,"is-hd":n.isHd,"is-light":s.light,"is-muted":n.isMuted,"is-object-background":n.isObjectBackground,"is-repeating":n.isRepeating,"is-wireframe":n.isWireframe,"margin-bottom":i.marginBottom,name:"main","nb-frames":i.nbFrames,"object-background-url":n.objectBackgroundUrl,preview:i.currentPreview,style:de({position:i.isComparisonOverlay?"absolute":"static"}),onDurationChanged:i.changeMaxDuration,onFrameUpdate:i.setVideoFrameContext,onModelLoaded:i.onModelLoaded,onPlayEnded:i.pause,onSizeChanged:i.fixCanvasSize,onVideoEnd:i.onVideoEnd,onVideoLoaded:i.onVideoLoaded},null,8,["current-frame","default-height","is-big","is-comparing","is-comparison-overlay","is-environment-skybox","is-full-screen","is-hd","is-light","is-muted","is-object-background","is-repeating","is-wireframe","margin-bottom","nb-frames","object-background-url","preview","style","onDurationChanged","onFrameUpdate","onModelLoaded","onPlayEnded","onSizeChanged","onVideoEnd","onVideoLoaded"]),$(b(w,{ref:"comparison-preview-viewer",class:"comparison-preview-viewer",name:"comparison-preview-viewer","current-frame":n.currentFrame,"default-height":i.defaultHeight,"is-big":s.big,"is-comparing":n.isComparing&&i.isComparisonEnabled,"is-full-screen":n.fullScreen,"is-light":s.light,"is-hd":n.isHd,"is-muted":!0,"is-repeating":n.isRepeating,"margin-bottom":i.marginBottom,preview:i.comparisonPreview,style:de({opacity:i.overlayOpacity}),onSizeChanged:i.fixCanvasComparisonSize,onVideoLoaded:i.syncComparisonViewer},null,8,["current-frame","default-height","is-big","is-comparing","is-full-screen","is-light","is-hd","is-repeating","margin-bottom","preview","style","onSizeChanged","onVideoLoaded"]),[[me,n.isComparing&&n.previewToCompare]])])],512),s.readOnly?c("",!0):$((r(),T(f,{key:0,ref:"task-info-player",class:"flexrow-item task-info-column","current-frame":n.currentFrame,"current-parent-preview":i.currentPreview,"entity-type":s.entityType,extendable:!1,"is-preview":!1,player:this,root:!1,silent:n.isCommentsHidden,task:s.task,onCommentAdded:t[2]||(t[2]=x=>e.$emit("comment-added")),onTimeCodeClicked:i.timeCodeClicked},null,8,["current-frame","current-parent-preview","entity-type","silent","task","onTimeCodeClicked"])),[[me,!n.isCommentsHidden]])])]),d("div",Ln,[$(b(C,{ref:"progress",class:"video-progress pull-bottom",annotations:n.annotations,"comparison-annotations":i.comparisonAnnotations,"frame-duration":i.frameDuration,"is-full-screen":n.fullScreen,"movie-dimensions":n.movieDimensions,"nb-frames":i.nbFrames,width:n.width,"handle-in":-1,"handle-out":-1,"preview-id":i.isMovie&&i.currentPreview?i.currentPreview.id:"",onStartScrub:t[3]||(t[3]=x=>e.$refs["button-bar"].classList.add("unselectable")),onEndScrub:t[4]||(t[4]=x=>e.$refs["button-bar"].classList.remove("unselectable")),onProgressChanged:i.onProgressChanged},null,8,["annotations","comparison-annotations","frame-duration","is-full-screen","movie-dimensions","nb-frames","width","preview-id","onProgressChanged"]),[[me,i.isMovie]]),d("div",On,[i.isMovie||i.isSound||n.is3DAnimation?(r(),l("div",Nn,[n.isPlaying?(r(),T(p,{key:1,class:"flexrow-item",title:e.$t("playlists.actions.pause"),icon:"pause",onClick:i.onPlayPauseClicked},null,8,["title","onClick"])):(r(),T(p,{key:0,class:"flexrow-item",title:e.$t("playlists.actions.play"),icon:"play",onClick:i.onPlayPauseClicked},null,8,["title","onClick"])),n.is3DAnimation?(r(),T(_,{key:2,class:"flexrow-item",options:e.available3DAnimations,"is-dark":!0,thin:!0,modelValue:n.current3DAnimation,"onUpdate:modelValue":t[5]||(t[5]=x=>n.current3DAnimation=x)},null,8,["options","modelValue"])):c("",!0)])):c("",!0),i.isMovie?(r(),l("div",zn,[!s.light||n.fullScreen?(r(),T(p,{key:0,active:n.isRepeating,title:e.$t("playlists.actions.looping"),icon:"repeat",onClick:i.onRepeatClicked},null,8,["active","title","onClick"])):c("",!0),(!s.light||n.fullScreen)&&i.isMovie?(r(),T(p,{key:1,class:"flexrow-item",title:e.$t("playlists.actions."+(n.isHd?"switch_ld":"switch_hd")),text:n.isHd?"HD":"LD",onClick:t[6]||(t[6]=x=>n.isHd=!n.isHd)},null,8,["title","text"])):c("",!0),b(A,{class:"flexrow-item",onChangeSound:i.onToggleSoundClicked,muted:n.isMuted,"onUpdate:muted":t[7]||(t[7]=x=>n.isMuted=x),volume:n.volume,"onUpdate:volume":t[8]||(t[8]=x=>n.volume=x)},null,8,["onChangeSound","muted","volume"]),i.isMovie?(r(),T(V,{key:2,class:"flexrow-item",modelValue:n.speed,"onUpdate:modelValue":t[9]||(t[9]=x=>n.speed=x)},null,8,["modelValue"])):c("",!0),d("span",{class:"flexrow-item time-indicator",title:e.$t("playlists.actions.current_time")},g(n.currentTime),9,Un),n.fullScreen?(r(),l("span",jn," / ")):c("",!0),n.fullScreen?(r(),l("span",{key:4,class:"flexrow-item time-indicator",title:e.$t("playlists.actions.max_duration")},g(n.maxDuration),9,Wn)):c("",!0),d("div",{class:"flexrow-item time-indicator mr1",title:e.$t("playlists.actions.frame_number")},[d("span",null," ("+g(i.currentFrameLabel),1),!s.light||n.fullScreen?(r(),l("span",qn," / ")):c("",!0),!s.light||n.fullScreen?(r(),l("span",Kn,g((i.nbFrames+"").padStart(3,"0")),1)):c("",!0),t[19]||(t[19]=X(") "))],8,Hn)])):c("",!0),i.isConcept?c("",!0):(r(),l("div",Zn,[i.taskTypeOptions.length>0&&i.isComparisonEnabled?(r(),T(p,{key:0,class:Z({ml1:i.isMovie||i.isSound}),active:n.isComparing,icon:"compare",title:e.$t("playlists.actions.split_screen"),onClick:i.onCompareClicked},null,8,["class","active","title","onClick"])):c("",!0),n.isComparing&&(!s.light||i.isComparisonEnabled)?(r(),T(I,{key:1,class:"comparison-combobox dark",options:i.taskTypeOptions,"is-dark":!0,thin:!0,modelValue:n.taskTypeId,"onUpdate:modelValue":t[10]||(t[10]=x=>n.taskTypeId=x)},null,8,["options","modelValue"])):c("",!0),n.isComparing&&(!s.light||i.isComparisonEnabled)?(r(),T(I,{key:2,class:"comparison-combobox dark",options:i.previewFileOptions,"is-dark":!0,thin:!0,modelValue:n.previewToCompareId,"onUpdate:modelValue":t[11]||(t[11]=x=>n.previewToCompareId=x)},null,8,["options","modelValue"])):c("",!0),n.isComparing&&(!s.light||i.isComparisonEnabled)?(r(),T(I,{key:3,class:"comparison-combobox",options:n.comparisonModeOptions,"is-dark":!0,thin:!0,modelValue:n.comparisonMode,"onUpdate:modelValue":t[12]||(t[12]=x=>n.comparisonMode=x)},null,8,["options","modelValue"])):c("",!0),n.isComparing&&(!s.light||i.isComparisonEnabled)&&i.comparisonPreviewLength>0?(r(),l("div",Xn,[b(p,{class:"button playlist-button flexrow-item",icon:"left",onClick:i.onPreviousComparisonClicked},null,8,["onClick"]),d("span",Yn,g(n.comparisonPreviewIndex+1)+" / "+g(i.comparisonPreviewLength),1),b(p,{class:"button playlist-button flexrow-item",icon:"right",onClick:i.onNextComparisonClicked},null,8,["onClick"])])):c("",!0)])),t[20]||(t[20]=d("div",{class:"filler"},null,-1)),n.fullScreen&&s.task?(r(),l("div",Gn,g(s.task.entity_name),1)):c("",!0),n.fullScreen?(r(),l("div",Jn)):c("",!0),d("div",Qn,[i.isMovie||i.isPicture?(r(),l("div",$n,[!s.readOnly&&n.fullScreen&&!i.isConcept?(r(),T(p,{key:0,class:"flexrow-item",icon:"undo",title:e.$t("playlists.actions.annotation_undo"),onClick:e.undoLastAction},null,8,["title","onClick"])):c("",!0),!s.readOnly&&n.fullScreen&&!i.isConcept?(r(),T(p,{key:1,class:"flexrow-item flexrow-item",title:e.$t("playlists.actions.annotation_redo"),icon:"redo",onClick:e.redoLastAction},null,8,["title","onClick"])):c("",!0),!s.readOnly&&n.fullScreen&&!i.isConcept?(r(),T(p,{key:2,class:"flexrow-item",icon:"delete",title:e.$t("playlists.actions.annotation_delete"),onClick:i.onDeleteClicked},null,8,["title","onClick"])):c("",!0),b(He,{name:"slide"},{default:le(()=>[$(d("div",er,[b(K,{color:n.textColor,onTogglePalette:e.onPickTextColor,onChange:e.onChangeTextColor},null,8,["color","onTogglePalette","onChange"])],512),[[me,n.isTyping&&(!s.light||n.fullScreen)]])]),_:1}),!s.readOnly&&(!s.light||n.fullScreen)&&!i.isConcept?(r(),T(p,{key:3,class:"flexrow-item",icon:"type",active:n.isTyping,title:e.$t("playlists.actions.annotation_text"),onClick:i.onTypeClicked},null,8,["active","title","onClick"])):c("",!0),b(He,{name:"slide"},{default:le(()=>[$(d("div",tr,[b(S,{pencil:e.pencilWidth,sizes:n.pencilPalette,onTogglePalette:e.onPickPencilWidth,onChange:e.onChangePencilWidth},null,8,["pencil","sizes","onTogglePalette","onChange"]),b(K,{color:e.pencilColor,onTogglePalette:e.onPickPencilColor,onChange:e.onChangePencilColor},null,8,["color","onTogglePalette","onChange"])],512),[[me,n.isDrawing&&(!s.light||n.fullScreen)]])]),_:1}),!s.readOnly&&(!s.light||n.fullScreen)&&!i.isConcept?(r(),T(p,{key:4,class:"flexrow-item",icon:"pencil",active:n.isDrawing,title:e.$t("playlists.actions.annotation_draw"),onClick:i.onPencilAnnotateClicked},null,8,["active","title","onClick"])):c("",!0),(i.isPicture||i.isMovie)&&(!s.light||n.fullScreen)&&!i.isConcept?(r(),T(p,{key:5,icon:"pen",title:e.$t("playlists.actions.toggle_annotations"),active:n.isAnnotationsDisplayed,onClick:i.onAnnotationDisplayedClicked},null,8,["title","active","onClick"])):c("",!0),(!s.light||n.fullScreen)&&!i.isConcept?(r(),T(p,{key:6,class:"flexrow-item",icon:"loupe",active:n.isZoomPan,title:e.$t("playlists.actions.annotation_zoom_pan"),onClick:i.onZoomPanClicked},null,8,["active","title","onClick"])):c("",!0),!s.readOnly&&n.fullScreen?(r(),T(p,{key:7,class:"button playlist-button flexrow-item",icon:"comment",active:!n.isCommentsHidden,title:e.$t("playlists.actions.comments"),onClick:i.onCommentClicked},null,8,["active","title","onClick"])):c("",!0)])):c("",!0),i.is3DModel?(r(),l("div",ir,[i.backgroundOptions.length>0?(r(),T(_,{key:0,class:"background-combo mr05",active:!!n.currentBackground,disabled:!i.productionBackgrounds.length,"is-compact":s.light&&!n.fullScreen||!i.productionBackgrounds.length,"is-reversed":"","keep-order":"",thin:"",options:i.backgroundOptions,onChange:t[13]||(t[13]=x=>i.onObjectBackgroundSelected()),modelValue:n.currentBackground,"onUpdate:modelValue":t[14]||(t[14]=x=>n.currentBackground=x)},{icon:le(()=>[b(P,{class:"icon is-small mr05"})]),_:1},8,["active","disabled","is-compact","options","modelValue"])):c("",!0),!s.light||n.fullScreen&&i.backgroundOptions.length>0?(r(),T(p,{key:1,class:"flexrow-item",active:n.isObjectBackground&&n.isEnvironmentSkybox,disabled:!n.objectBackgroundUrl||!n.isObjectBackground,icon:"image",title:e.$t("playlists.actions.toggle_environment_skybox"),onClick:t[15]||(t[15]=x=>n.isEnvironmentSkybox=!n.isEnvironmentSkybox)},null,8,["active","disabled","title"])):c("",!0),b(p,{class:"flexrow-item",active:n.isWireframe,icon:"box",title:e.$t("playlists.actions.toggle_wireframe"),onClick:t[16]||(t[16]=x=>n.isWireframe=!n.isWireframe)},null,8,["active","title"])])):c("",!0),!s.readOnly&&n.fullScreen&&i.isPicture?(r(),l("div",sr)):c("",!0),!s.readOnly&&i.isPicture?(r(),l("a",{key:3,class:"button flexrow-item",href:i.originalPath,title:e.$t("playlists.actions.see_original_file"),target:"blank"},[b(z,{class:"icon is-small"})],8,nr)):c("",!0),!n.fullScreen||n.fullScreen&&(s.previews.length>1||s.lastPreviewFiles.length>1)?(r(),l("div",rr)):c("",!0),i.currentPreview&&!i.isConcept?(r(),T(h,{key:5,"current-index":n.currentIndex,previews:s.previews,"read-only":s.readOnly,light:s.light,"full-screen":n.fullScreen,"is-assigned":s.isAssigned,onAddPreviewClicked:t[17]||(t[17]=x=>e.$emit("add-extra-preview")),onNextClicked:i.onNextClicked,onPreviousClicked:i.onPreviousClicked,onRemovePreviewClicked:i.onRemovePreviewClicked,onCurrentIndexClicked:i.toggleIsOrdering},null,8,["current-index","previews","read-only","light","full-screen","is-assigned","onNextClicked","onPreviousClicked","onRemovePreviewClicked","onCurrentIndexClicked"])):c("",!0),n.fullScreen&&!i.isConcept&&i.lastPreviewFileOptions.length?(r(),l("div",or,[b(_,{class:"preview-combo flexrow-item",options:i.lastPreviewFileOptions,"is-reversed":"","is-preview":"",thin:"","model-value":i.currentPreview?.id,"onUpdate:modelValue":i.changeCurrentPreviewFile},null,8,["options","model-value","onUpdate:modelValue"])])):c("",!0),s.lastPreviewFiles.length>1&&n.fullScreen?(r(),l("div",ar)):c("",!0),!e.isCurrentUserArtist&&s.link?.length?(r(),l("a",{key:8,class:"button flexrow-item",href:s.link,title:e.$t("playlists.actions.open_link"),target:"_blank"},[b(G,{class:"icon is-small"})],8,lr)):c("",!0),!e.isCurrentUserArtist||i.currentProduction?.is_preview_download_allowed?(r(),l("a",{key:9,class:"button flexrow-item",href:i.originalDlPath,title:e.$t("playlists.actions.download_file")},[b(ie,{class:"icon is-small"})],8,dr)):c("",!0),i.isFullScreenEnabled?(r(),T(p,{key:10,class:"flexrow-item",title:e.$t("playlists.actions.fullscreen"),icon:"maximize",onClick:i.onFullscreenClicked},null,8,["title","onClick"])):c("",!0)])],512)],512),i.isConcept&&i.conceptLinkedEntities.length?(r(),l("div",cr,[d("ul",mr,[(r(!0),l(H,null,te(i.conceptLinkedEntities,x=>(r(),l("li",{class:"tag",key:x.id},[b(se,{to:i.entityPath(x,"asset")},{default:le(()=>[X(g(x.name),1)]),_:2},1032,["to"])]))),128))])])):c("",!0),n.isOrdering?(r(),l("div",{key:1,class:"flexrow revision-previews",ref:"revision-previews",onWheel:t[18]||(t[18]=(...x)=>i.onSubPreviewsWheel&&i.onSubPreviewsWheel(...x))},[(r(!0),l(H,null,te(s.previews,(x,ue)=>(r(),l("div",{class:"flexrow-item revision-preview",key:x.id},[b(y,{"preview-file":x,index:ue,"is-selected":i.currentPreview.id===x.id,onSelected:De=>i.onRevisionPreviewSelected(ue+1),onPreviewDropped:i.onRevisionPreviewDropped},null,8,["preview-file","index","is-selected","onSelected","onPreviewDropped"])]))),128))],544)):c("",!0),d("canvas",hr,null,512),d("canvas",ur,null,512)],512)}const jr=re(Dn,[["render",fr],["__scopeId","data-v-127bae50"]]);export{Nr as A,zr as C,Ur as E,jr as P,hi as T,Lr as V,Or as a,je as b,Re as d,Br as t};
//# sourceMappingURL=PreviewPlayer-Bpr7Jn1C.js.map
