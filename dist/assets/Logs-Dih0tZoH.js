import{_ as F,S as L,U as I,R as S,B as C,J as g,aj as b,a as D,b as x,r as p,o as i,c as l,d as s,f as m,t as d,h,F as y,e as M,I as A,g as w,H as V,ak as j,n as B}from"./index-Dw-uod2x.js";import{t as z}from"./time-DOQFDZTc.js";import{D as N}from"./DateField-BoSZf4Hb.js";import{P as R}from"./PeopleField-Dk8dxPgh.js";import{f as q}from"./format-fMWuo47O.js";import{T as G}from"./TableInfo-BOYXFWEz.js";import{P as K}from"./ProductionNameCell-kcGriYhJ.js";import{T as U}from"./TaskTypeCell-QjnVLvVl.js";import"./TaskTypeName-CzX-aVdj.js";const $=1e3,W={name:"events",mixins:[z],components:{ButtonSimple:C,DateField:N,PeopleAvatar:S,PeopleField:R,PeopleName:I,Spinner:L},data(){return{currentDate:new Date,events:[],hasMoreEvents:!1,selectedEvents:{},selectedPerson:null,loading:{events:!1,moreEvents:!1}}},mounted(){this.loadDayEvents()},computed:{...x(["people","personMap","user"]),today(){return g().toDate()},filteredEvents(){let e=this.events;return this.selectedPerson&&(e=e.filter(t=>t.user_id===this.selectedPerson.id)),e}},methods:{...D(["loadEvents"]),async loadDayEvents(){const e=g(this.currentDate).add(1,"days"),t=g(this.currentDate);this.selectedEvents={},this.events=[],this.loading.events=!0;try{const a=await this.loadEvents({after:b(t,this.timezone),before:b(e,this.timezone),limit:$});this.events=this.formatEvents(a),this.hasMoreEvents=a.length>=$}catch(a){console.error(a)}finally{this.loading.events=!1}},async loadMoreEvents(){if(!this.events.length)return;this.loading.moreEvents=!0;const e=this.events[this.events.length-1].id,t=g(this.currentDate).add(1,"days"),a=g(this.currentDate);try{const _=await this.loadEvents({after:b(a,this.timezone),before:b(t,this.timezone),lastEventId:e,limit:$});this.events=[...this.events,...this.formatEvents(_)],this.hasMoreEvents=_.length>=$}catch(_){console.error(_)}finally{this.loading.moreEvents=!1}},formatEvents(e){return e.map(t=>{const[a,_]=t.name.split(":");return{id:t.id,date:this.formatDate(t.created_at),data:t.data,name:a,shortType:_.substring(0,3),type:_,user_id:t.user_id}})},selectLine(e){this.selectedEvents[e.id]=!this.selectedEvents[e.id]},isLink(e){return["project_id","task_id"].includes(e)},getLink(e,t){const a=e.data.project_id,_=t.substring(0,t.length-3);if(_==="project")return`/productions/${a}/news-feed`;{const o=e.data[t];return`/productions/${a}/${_}s/${o}`}}},watch:{currentDate(){this.loadDayEvents()}},head(){return{title:`${this.$t("logs.title")} - Kitsu`}}},Z={class:"mt1"},H={class:"flexrow"},J={key:0,class:"mt2 empty"},O={key:1,class:"has-text-centered"},Q={key:2,class:"log-list"},X=["onClick"],Y={class:"date tag mr1"},ee=["title","data-status"],te={class:"name tag mr1"},se={class:"flexrow"},ie={class:"key"},oe=["href"],ne={key:0,class:"has-text-centered mt1"};function le(e,t,a,_,o,r){const u=p("date-field"),f=p("people-field"),v=p("button-simple"),T=p("spinner"),c=p("people-avatar"),P=p("people-name");return i(),l("div",Z,[s("div",H,[m(u,{class:"flexrow-item","can-delete":!1,"max-date":r.today,label:e.$t("logs.current_date_label"),modelValue:o.currentDate,"onUpdate:modelValue":t[0]||(t[0]=n=>o.currentDate=n)},null,8,["max-date","label","modelValue"]),m(f,{class:"flexrow-item field",label:e.$t("main.user"),people:e.people,modelValue:o.selectedPerson,"onUpdate:modelValue":t[1]||(t[1]=n=>o.selectedPerson=n)},null,8,["label","people","modelValue"]),m(v,{class:"flexrow-item small",icon:"refresh","is-loading":o.loading.events,title:e.$t("main.reload"),onClick:t[2]||(t[2]=n=>r.loadDayEvents())},null,8,["is-loading","title"])]),!o.loading.events&&!r.filteredEvents.length?(i(),l("div",J,d(e.$t("logs.empty_list")),1)):h("",!0),o.loading.events?(i(),l("div",O,[m(T)])):(i(),l("div",Q,[(i(!0),l(y,null,M(r.filteredEvents,n=>(i(),l("div",{class:"event-line",key:n.id,onClick:k=>r.selectLine(n)},[s("span",Y,d(n.date),1),s("span",{class:"type tag",title:n.type,"data-status":n.shortType},d(n.shortType),9,ee),s("span",te,d(n.name),1),o.selectedEvents[n.id]?(i(),l("ul",{key:0,onClick:t[3]||(t[3]=A(()=>{},["stop"]))},[s("li",se,[t[5]||(t[5]=s("span",{class:"key"},"user",-1)),n.user_id?(i(),w(c,{key:0,class:"flexrow-item",size:20,"font-size":10,person:e.personMap.get(n.user_id)},null,8,["person"])):h("",!0),n.user_id?(i(),w(P,{key:1,class:"flexrow-item",person:e.personMap.get(n.user_id),"with-link":""},null,8,["person"])):h("",!0)]),(i(!0),l(y,null,M(Object.keys(n.data).sort(),k=>(i(),l("li",{key:`${n.id}-${k}`},[s("span",ie,d(k),1),r.isLink(k)?(i(),l("a",{key:0,href:r.getLink(n,k)},d(n.data[k]),9,oe)):(i(),l(y,{key:1},[V(d(n.data[k]),1)],64))]))),128))])):h("",!0)],8,X))),128)),o.hasMoreEvents?(i(),l("div",ne,[m(v,{"is-loading":o.loading.moreEvents,text:e.$t("main.load_more"),onClick:t[4]||(t[4]=n=>r.loadMoreEvents())},null,8,["is-loading","text"])])):h("",!0)]))])}const ae=F(W,[["render",le],["__scopeId","data-v-e087e72b"]]),re={name:"preview-file-list",mixins:[q],components:{ButtonSimple:C,ProductionNameCell:K,TableInfo:G,TaskTypeCell:U},props:{previewFiles:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1}},emits:["mark-broken-clicked"],computed:{...x(["productionMap","taskTypeMap"])},methods:{...D(["loadTask"]),onBodyScroll(e){const t=e.target;this.$refs.headerWrapper.style.left=`-${t.scrollLeft}px`},async redirectToTask(e){const t=await this.loadTask({taskId:e.task_id});return this.$router.push(j(t,t.project,t.project.production_type==="tvshow",t.episode,this.taskTypeMap))}}},de={class:"data-list"},ce={style:{overflow:"hidden"}},pe={class:"datatable",ref:"headerWrapper"},_e={class:"datatable-head"},me={class:"datatable-row-header"},he={class:"date"},ue={class:"production"},ve={class:"entity-name"},fe={class:"task-type"},ke={class:"revision"},ge={class:"status"},ye={class:"datatable"},we={class:"datatable-body"},be=["onClick"],$e={class:"date"},Ee={class:"production"},Fe={class:"entity-name"},Te={class:"revision"},Pe=["data-status"],Me={class:"end-cell has-text-right"};function Ce(e,t,a,_,o,r){const u=p("table-info"),f=p("production-name-cell"),v=p("task-type-cell"),T=p("button-simple");return i(),l("div",de,[s("div",ce,[s("table",pe,[s("thead",_e,[s("tr",me,[s("th",he,d(e.$t("logs.preview_files.date")),1),s("th",ue,d(e.$t("logs.preview_files.production")),1),s("th",ve,d(e.$t("logs.preview_files.entity_name")),1),s("th",fe,d(e.$t("logs.preview_files.task_type_id")),1),s("th",ke,d(e.$t("logs.preview_files.revision")),1),s("th",ge,d(e.$t("logs.preview_files.status")),1),t[1]||(t[1]=s("th",{class:"end-cell"},null,-1))])])],512)]),m(u,{"is-loading":a.isLoading,"is-error":a.isError},null,8,["is-loading","is-error"]),a.previewFiles.length>0?(i(),l("div",{key:0,onScrollPassive:t[0]||(t[0]=(...c)=>r.onBodyScroll&&r.onBodyScroll(...c))},[s("table",ye,[s("tbody",we,[(i(!0),l(y,null,M(a.previewFiles,c=>(i(),l("tr",{key:c.id,class:"datatable-row",onClick:P=>r.redirectToTask(c)},[s("td",$e,d(e.formatDate(c.created_at)),1),s("td",Ee,[m(f,{entry:e.productionMap.get(c.project_id)},null,8,["entry"])]),s("td",Fe,d(c.full_entity_name),1),m(v,{class:"task-type","task-type":e.taskTypeMap.get(c.task_type_id)},null,8,["task-type"]),s("td",Te,d(c.revision),1),s("td",{class:"status","data-status":c.status},d(c.status),9,Pe),s("td",Me,[c.status==="processing"?(i(),w(T,{key:0,class:"mark-broken-button",text:e.$t("logs.preview_files.mark_broken"),onClick:A(P=>e.$emit("mark-broken-clicked",c.id),["stop"])},null,8,["text","onClick"])):h("",!0)])],8,be))),128))])])],32)):h("",!0)])}const De=F(re,[["render",Ce],["__scopeId","data-v-fa444a29"]]),E=100,Be={name:"preview-files",components:{ButtonSimple:C,PreviewFileList:De,Spinner:L},data(){return{hasMorePreviewFiles:!1,previewFiles:[],loading:{previewFiles:!1,morePreviewFiles:!1}}},mounted(){this.reload()},methods:{...D(["getRunningPreviewFiles","markPreviewFileAsBroken"]),async reload(){this.previewFiles=[],this.loading.previewFiles=!0;try{const e=await this.getRunningPreviewFiles({limit:E});this.previewFiles=e,this.hasMorePreviewFiles=e.length>=E}catch(e){console.error(e)}finally{this.loading.previewFiles=!1}},async loadMorePreviewFiles(){if(!this.previewFiles.length)return;this.loading.morePreviewFiles=!0;const e=this.previewFiles[this.previewFiles.length-1].id;try{const t=await this.getRunningPreviewFiles({limit:E,lastPreviewFileId:e});this.previewFiles=[...this.previewFiles,...t],this.hasMorePreviewFiles=t.length>=E}catch(t){console.error(t)}finally{this.loading.morePreviewFiles=!1}},async markBrokenClicked(e){const t=this.previewFiles.find(a=>a.id===e);t.status="broken",await this.markPreviewFileAsBroken(e)}}},Le={class:"mt1"},xe={class:"flexrow"},Ae={class:"flexrow-item"},Ie={key:0,class:"has-text-centered"},Se={key:1,class:"empty"},Ve={key:0,class:"has-text-centered mt1"};function je(e,t,a,_,o,r){const u=p("button-simple"),f=p("spinner"),v=p("preview-file-list");return i(),l("div",Le,[s("p",xe,[s("em",Ae,d(e.$t("logs.preview_files.explanation")),1),t[0]||(t[0]=s("span",{class:"filler"},null,-1)),m(u,{class:"flexrow-item",icon:"refresh","is-loading":o.loading.previewFiles,title:e.$t("main.reload"),onClick:r.reload},null,8,["is-loading","title","onClick"])]),o.loading.previewFiles?(i(),l("div",Ie,[m(f)])):o.previewFiles.length?(i(),l(y,{key:2},[m(v,{"preview-files":o.previewFiles,"is-loading":o.loading.previewFiles,onMarkBrokenClicked:r.markBrokenClicked},null,8,["preview-files","is-loading","onMarkBrokenClicked"]),o.hasMorePreviewFiles?(i(),l("div",Ve,[m(u,{"is-loading":o.loading.morePreviewFiles,text:e.$t("main.load_more"),onClick:r.loadMorePreviewFiles},null,8,["is-loading","text","onClick"])])):h("",!0)],64)):(i(),l("p",Se,d(e.$t("logs.preview_files.empty_list")),1))])}const ze=F(Be,[["render",je],["__scopeId","data-v-664a15b5"]]),Ne={name:"logs",components:{Events:ae,PreviewFiles:ze},data(){return{activeTab:"events"}},mounted(){this.$route.query.tab&&(this.activeTab=this.$route.query.tab)},methods:{isActiveTab(e){return this.activeTab===e}},watch:{activeTab(){this.$route.query.tab!==this.activeTab&&this.$router.push({query:{tab:this.activeTab}})}}},Re={class:"logs fixed-page"},qe={class:"tabs logs-tabs"};function Ge(e,t,a,_,o,r){const u=p("events"),f=p("preview-files");return i(),l("div",Re,[s("div",qe,[s("ul",null,[s("li",{class:B({"is-active":r.isActiveTab("events")})},[s("a",{onClick:t[0]||(t[0]=v=>o.activeTab="events")},d(e.$t("logs.title")),1)],2),s("li",{class:B({"is-active":r.isActiveTab("preview_files")})},[s("a",{onClick:t[1]||(t[1]=v=>o.activeTab="preview_files")},d(e.$t("logs.preview_files.title")),1)],2)])]),r.isActiveTab("events")?(i(),w(u,{key:0})):r.isActiveTab("preview_files")?(i(),w(f,{key:1})):h("",!0)])}const Ye=F(Ne,[["render",Ge],["__scopeId","data-v-dd26db57"]]);export{Ye as default};
//# sourceMappingURL=Logs-Dih0tZoH.js.map
