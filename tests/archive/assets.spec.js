import store from '@/store/modules/assets'
import taskTypesStore from '@/store/modules/tasktypes'
import taskStatusStore from '@/store/modules/taskstatus'
import tasksStore from '@/store/modules/tasks'
import productionsStore from '@/store/modules/productions'
import {
  ADD_ASSET,
  CANCEL_ASSET,
  COMPUTE_ASSET_TYPE_STATS,
  DISPLAY_MORE_ASSETS,
  EDIT_ASSET_END,
  IMPORT_ASSETS_END,
  IMPORT_ASSETS_START,
  LOAD_ASSETS_END,
  LOAD_ASSETS_START,
  LOCK_ASSET,
  REMOVE_ASSET,
  REMOVE_ASSET_SEARCH_END,
  SET_ASSET_TYPE_SEARCH,
  RESTORE_ASSET_END,
  SAVE_ASSET_SEARCH_END,
  SET_PRODUCTION_ASSET_TYPE_LIST_SCROLL_POSITION,
  UPDATE_ASSET
} from '@/store/mutation-types'

import assetsApi from '@/store/api/assets'
import peopleApi from '@/store/api/people'

describe('Assets store', () => {
describe('Getters', () => {
  test('assets', () => {
    store.cache.assets = '123'
    expect(store.getters.assets(null)).toEqual('123')
  })

  test('assetSearchText', () => {
    const state = {
      assetSearchText: '123'
    }
    expect(store.getters.assetSearchText(state)).toEqual('123')
  })

  test('assetSearchQueries', () => {
    const state = {
      assetSearchQueries: '123'
    }
    expect(store.getters.assetSearchQueries(state)).toEqual('123')
  })

  test('assetSelectionGrid', () => {
    const state = {
      assetSelectionGrid: '123'
    }
    expect(store.getters.assetSelectionGrid(state)).toEqual('123')
  })

  test('assetValidationColumns', () => {
    const state = {
      assetValidationColumns: '123'
    }
    expect(store.getters.assetValidationColumns(state)).toEqual('123')
  })

  test('isAssetsLoading', () => {
    const state = {
      isAssetsLoading: true
    }
    expect(store.getters.isAssetsLoading(state)).toBeTruthy()
  })

  test('isAssetsLoadingError', () => {
    const state = {
      isAssetsLoadingError: true
    }
    expect(store.getters.isAssetsLoadingError(state)).toBeTruthy()
  })

  test('displayedAssets', () => {
    const state = {
      displayedAssets: '123'
    }
    expect(store.getters.displayedAssets(state)).toEqual('123')
  })

  test('displayedAssetsLength', () => {
    const state = {
      displayedAssetsLength: 123
    }
    expect(store.getters.displayedAssetsLength(state)).toEqual(123)
  })

  test('displayedAssetsTimeSpent', () => {
    const state = {
      displayedAssetsTimeSpent: 123
    }
    expect(store.getters.displayedAssetsTimeSpent(state)).toEqual(123)
  })

  test('displayedAssetsEstimation', () => {
    const state = {
      displayedAssetsEstimation: 123
    }
    expect(store.getters.displayedAssetsEstimation(state)).toEqual(123)
  })

  test('assetFilledColumns', () => {
    const state = {
      assetFilledColumns: 123
    }
    expect(store.getters.assetFilledColumns(state)).toEqual(123)
  })

  test('displayedAssetTypes', () => {
    const state = {
      displayedAssetTypes: '123'
    }
    expect(store.getters.displayedAssetTypes(state)).toEqual('123')
  })

  test('displayedAssetTypesLength', () => {
    const state = {
      displayedAssetTypesLength: 123
    }
    expect(store.getters.displayedAssetTypesLength(state)).toEqual(123)
  })

  test('assetTypeSearchText', () => {
    const state = {
      assetTypeSearchText: '123'
    }
    expect(store.getters.assetTypeSearchText(state)).toEqual('123')
  })

  test('assetTypeStats', () => {
    const state = {
      assetTypeStats: '123'
    }
    expect(store.getters.assetTypeStats(state)).toEqual('123')
  })

  test('assetTypeListScrollPosition', () => {
    const state = {
      assetTypeListScrollPosition: 123
    }
    expect(store.getters.assetTypeListScrollPosition(state)).toEqual(123)
  })

  test('assetSorting', () => {
    const state = {
      assetSorting: 123
    }
    expect(store.getters.assetSorting(state)).toEqual(123)
  })

  test('assetListScrollPosition', () => {
    const state = {
      assetListScrollPosition: 123
    }
    expect(store.getters.assetListScrollPosition(state)).toEqual(123)
  })

  test('displayedAssetsByType', () => {
    const state = {
      displayedAssets: [
        { id: 123, asset_type_name: 'test' },
        { id: 345, asset_type_name: 'test' },
        { id: 234, asset_type_name: 'test2' },
        { id: 456, asset_type_name: 'test2' }
      ]
    }
    expect(store.getters.displayedAssetsByType(state)).toEqual([
      [
        { id: 123, asset_type_name: 'test' },
        { id: 345, asset_type_name: 'test' }
      ],
      [
        { id: 234, asset_type_name: 'test2' },
        { id: 456, asset_type_name: 'test2' }
      ]
    ])
  })

  test('assetsByType', () => {
    const state = {
      displayedAssets: [
        { id: 123, asset_type_name: 'test', canceled: true },
        { id: 234, asset_type_name: 'test2' },
        { id: 456, asset_type_name: 'test2' },
        { id: 345, asset_type_name: 'test' }
      ]
    }
    expect(store.getters.assetsByType(state)).toEqual([
      [
        { id: 234, asset_type_name: 'test2' },
        { id: 456, asset_type_name: 'test2' }
      ],
      [
        { id: 345, asset_type_name: 'test' }
      ]
    ])
  })

  test('assetCreated', () => {
    const state = {
      assetCreated: '123'
    }
    expect(store.getters.assetCreated(state)).toEqual('123')
  })

  test('assetsCsvFormData', () => {
    const state = {
      assetsCsvFormData: '123'
    }
    expect(store.getters.assetsCsvFormData(state)).toEqual('123')
  })

  test('isAssetEstimation', () => {
    const state = {
      isAssetEstimation: true
    }
    expect(store.getters.isAssetEstimation(state)).toBeTruthy()
  })

  test('isAssetTime', () => {
    const state = {
      isAssetTime: true
    }
    expect(store.getters.isAssetTime(state)).toBeTruthy()
  })

  test('isAssetDescription', () => {
    const state = {
      isAssetDescription: true
    }
    expect(store.getters.isAssetDescription(state)).toBeTruthy()
  })
})

describe('Actions', () => {
  beforeEach(() => {
    store.cache.assets = []
  })

  test('loadAssets', async () => {
    let mockCommit = vi.fn()
    const state = {
      episode: null,
      isAssetsLoading: true
    }
    const rootGetters = {
      currentProduction: 1,
      userFilters: 2,
      personMap: 3,
      currentEpisode: 4,
      isTVShow: true,
      taskTypeMap: 5,
      taskMap: 6,
      assetTypeMap: new Map(),
    }
    const res1 = await store.actions.loadAssets(
      { commit: mockCommit, state, rootGetters })
    expect(res1).toEqual([])
    state.episode = {
      id: 123
    }
    const res2 = await store.actions.loadAssets(
      { commit: mockCommit, state, rootGetters })
    expect(res2).toEqual([])
    state.isAssetsLoading = false
    const assets = [{
      id: 456,
      type: 'asset',
    }]
    assetsApi.getAssets = vi.fn(() => Promise.resolve(assets))
    assetsApi.getUsedSharedAssets = vi.fn(() => Promise.resolve([]))
    mockCommit = vi.fn()
    const res3 = await store.actions.loadAssets(
      { commit: mockCommit, state, rootGetters })
    expect(mockCommit).toBeCalledTimes(2)
    expect(mockCommit).toHaveBeenNthCalledWith(1, LOAD_ASSETS_START)
    expect(mockCommit).toHaveBeenNthCalledWith(2, LOAD_ASSETS_END, {
      production: 1,
      assets,
      userFilters: 2,
      personMap: 3,
      taskMap: 6,
      taskTypeMap: 5
    })
    expect(res3).toEqual(assets)
  })

  test('loadAsset', async () => {
    const rootGetters = {
      currentProduction: 1,
      personMap: 3,
      taskTypeMap: 5,
      taskMap: 6
    }
    let mockCommit = vi.fn()
    assetsApi.getAsset = vi.fn(() => Promise.resolve({
      id: 1,
      tasks: []
    }))
    await store.actions.loadAsset(
      { commit: mockCommit, state: {}, rootGetters }, 1)
    expect(mockCommit).toBeCalledTimes(1)
    expect(mockCommit).toHaveBeenNthCalledWith(1, ADD_ASSET, {
      asset: { id: 1, tasks: [] },
      taskTypeMap: 5,
      taskMap: 6,
      personMap: 3,
      production: 1
    })

    mockCommit = vi.fn()
    store.cache.assetMap.set(1, { id: 1, tasks: [] })
    await store.actions.loadAsset(
      { commit: mockCommit, state: {}, rootGetters }, 1)
    expect(mockCommit).toBeCalledTimes(1)
    expect(mockCommit).toHaveBeenNthCalledWith(
      1,
      UPDATE_ASSET,
      { id: 1, tasks: [] }
    )

    mockCommit = vi.fn()
    store.cache.assetMap.get(1).lock = true
    await store.actions.loadAsset(
      { commit: mockCommit, state: {}, rootGetters }, 1)
    expect(mockCommit).toBeCalledTimes(0)
  })

  test.skip('newAsset', async () => {
    const assetTypeMap = new Map()
    const rootGetters = {
      assetTypeMap: assetTypeMap,
      taskTypeMap: 5,
      productionAssetTaskTypeIds: [
        1, 2
      ]
    }
    const state = {}
    const mockCommit = vi.fn()
    const mockDispatch = vi.fn()
    const asset = { id: 1, name: 'assetTest', project_id: 3 }
    assetsApi.newAsset = vi.fn(() => Promise.resolve(asset))
    const res = await store.actions.newAsset(
      { commit: mockCommit, state, rootGetters, dispatch: mockDispatch },
      new Map()
    )
    expect(mockCommit).toBeCalledTimes(1)
    expect(mockCommit).toHaveBeenNthCalledWith(
      1, EDIT_ASSET_END, {
        assetTypeMap, newAsset: asset
      })
    expect(mockDispatch).toBeCalledTimes(3)
    expect(mockDispatch).toHaveBeenNthCalledWith(2, 'createTasks', {
      entityIds: [1],
      project_id: 3,
      task_type_id: 1,
      type: 'assets'
    })
    expect(mockDispatch).toHaveBeenNthCalledWith(3, 'createTasks', {
      entityIds: [1],
      project_id: 3,
      task_type_id: 2,
      type: 'assets'
    })
    expect(res).toEqual(asset)
  })

  test('editAsset', async () => {
    const rootState = {
      assetTypes: {
        assetTypeMap: 1
      }
    }
    const mockCommit = vi.fn()
    const asset = { id: 1, name: 'assetTest', project_id: 3 }
    assetsApi.updateAsset = vi.fn(() => Promise.resolve(asset))
    const res = await store.actions.editAsset(
      { commit: mockCommit, state: {}, rootState }, asset)
    expect(mockCommit).toBeCalledTimes(2)
    expect(mockCommit).toHaveBeenNthCalledWith(1, LOCK_ASSET, asset)
    expect(mockCommit).toHaveBeenNthCalledWith(
      2, EDIT_ASSET_END, { newAsset: asset, assetTypeMap: 1 })
    expect(res).toEqual(asset)
  })

  test('deleteAsset', async () => {
    let mockCommit = vi.fn()
    const asset = {
      id: 1,
      name: 'assetTest',
      project_id: 3,
      tasks: [{ id: 2 }],
      canceled: false
    }
    store.cache.assetMap.set(1, asset)
    assetsApi.deleteAsset = vi.fn(() => Promise.resolve(asset))
    const res1 = await store.actions.deleteAsset(
      { commit: mockCommit, state: {} }, asset
    )
    expect(mockCommit).toBeCalledTimes(1)
    expect(mockCommit).toHaveBeenNthCalledWith(1, CANCEL_ASSET, asset)
    expect(res1).toEqual(asset)

    asset.canceled = true
    mockCommit = vi.fn()
    assetsApi.deleteAsset = vi.fn(() => Promise.resolve(asset))
    const res2 = await store.actions.deleteAsset(
      { commit: mockCommit, state: {} }, asset)
    expect(mockCommit).toBeCalledTimes(1)
    expect(mockCommit).toHaveBeenNthCalledWith(1, REMOVE_ASSET, asset)
    expect(res2).toEqual(asset)
  })

  test('restoreAsset', async () => {
    const mockCommit = vi.fn()
    const asset = { id: 1, name: 'assetTest' }
    assetsApi.restoreAsset = vi.fn(() => Promise.resolve(asset))
    store.cache.assetMap = new Map([[asset.id, asset]])
    const res1 = await store.actions.restoreAsset(
      { commit: mockCommit, state: {} }, asset)
    expect(mockCommit).toBeCalledTimes(1)
    expect(mockCommit).toHaveBeenNthCalledWith(1, RESTORE_ASSET_END, asset)
      expect(res1).toEqual(asset)
    })

    test('uploadAssetFile', async () => {
      const mockCommit = vi.fn()
      const asset = { id: 1, name: 'assetTest' }
      assetsApi.postCsv = vi.fn(() => Promise.resolve())
      await store.actions.uploadAssetFile(
        { commit: mockCommit, state: {} }, asset)
      expect(mockCommit).toBeCalledTimes(2)
      expect(mockCommit).toHaveBeenNthCalledWith(1, IMPORT_ASSETS_START)
      expect(mockCommit).toHaveBeenNthCalledWith(2, IMPORT_ASSETS_END)
    })

    test('saveAssetSearch', async () => {
      const rootGetters = {
        currentProduction: 4
      }
      const state = {
        assetSearchQueries: [{
          name: 'test'
        }]
      }

      let mockCommit = vi.fn()
      peopleApi.createFilter = vi.fn(
        (listType, name, query, productionId, entityType) => {
          return Promise.resolve(query)
        }
      )
      await store.actions.saveAssetSearch(
        { commit: mockCommit, state, rootGetters }, 'name')
      expect(mockCommit).toBeCalledTimes(1)
      expect(mockCommit).toHaveBeenNthCalledWith(1, SAVE_ASSET_SEARCH_END, {
        production: 4,
        searchQuery: 'name'
      })
      expect(peopleApi.createFilter).toBeCalledTimes(1)

      mockCommit = vi.fn()
      peopleApi.createFilter = vi.fn()
      state.assetSearchQueries.push({
        name: 'name'
      })
      expect(peopleApi.createFilter).toBeCalledTimes(0)
      expect(mockCommit).toBeCalledTimes(0)
    })

    test('removeAssetSearch', async () => {
      const rootGetters = {
        currentProduction: 4
      }

      const mockCommit = vi.fn()
      peopleApi.removeFilter = vi.fn(
        (searchQuery) => {
          return Promise.resolve()
        }
      )
      await store.actions.removeAssetSearch(
        { commit: mockCommit, rootGetters }, 'name')
      expect(mockCommit).toBeCalledTimes(1)
      expect(mockCommit).toHaveBeenNthCalledWith(1, REMOVE_ASSET_SEARCH_END, {
        production: 4,
        searchQuery: 'name'
      })
      expect(peopleApi.removeFilter).toBeCalledTimes(1)
      expect(peopleApi.removeFilter).toHaveBeenNthCalledWith(1, 'name')
    })

    test('displayMoreAssets', () => {
      const mockCommit = vi.fn()
      const rootGetters = {
        taskTypeMap: 1,
        taskStatusMap: 2,
        taskMap: 3,
        currentProduction: 4
      }
      store.actions.displayMoreAssets({ commit: mockCommit, rootGetters })
      expect(mockCommit).toBeCalledTimes(1)
      expect(mockCommit).toHaveBeenNthCalledWith(1, DISPLAY_MORE_ASSETS, {
        taskTypeMap: 1,
        taskStatusMap: 2,
        taskMap: 3,
        production: 4
      })
    })

    test('initAssetTypes', async () => {
      const dispatch = vi.fn(() => Promise.resolve())
      await store.actions.initAssetTypes({ dispatch })
      expect(dispatch).toBeCalledTimes(3)
      expect(dispatch).toHaveBeenNthCalledWith(
        1, 'setLastProductionScreen', 'production-asset-types')
      expect(dispatch).toHaveBeenNthCalledWith(
        2, 'loadAssets')
      expect(dispatch).toHaveBeenNthCalledWith(
        3, 'computeAssetTypeStats')
    })

    test('setAssetTypeListScrollPosition', () => {
      const mockCommit = vi.fn()
      store.actions.setAssetTypeListScrollPosition({ commit: mockCommit })
      expect(mockCommit).toBeCalledTimes(1)
      expect(mockCommit).toHaveBeenNthCalledWith(
        1, SET_PRODUCTION_ASSET_TYPE_LIST_SCROLL_POSITION)
    })

    test('computeAssetTypeStats', () => {
      const mockCommit = vi.fn()
      const rootGetters = {
        taskStatusMap: 1,
        taskMap: 2
      }
      store.actions.computeAssetTypeStats({ commit: mockCommit, rootGetters })
      expect(mockCommit).toBeCalledTimes(1)
      expect(mockCommit).toHaveBeenNthCalledWith(1, COMPUTE_ASSET_TYPE_STATS, {
        taskStatusMap: 1,
        taskMap: 2
      })
    })

    test('setAssetTypeSearch', () => {
      const mockCommit = vi.fn()
      store.actions.setAssetTypeSearch({ commit: mockCommit }, 'searchQuery')
      expect(mockCommit).toBeCalledTimes(1)
      expect(mockCommit).toHaveBeenNthCalledWith(
        1, SET_ASSET_TYPE_SEARCH, 'searchQuery')
    })

    test('getAssetsCsvLines', () => {
      const state = {
        isAssetTime: true,
        isAssetEstimation: true,
        assetValidationColumns: ['existing-validation-id', 'unexisting-id']
      }
      const rootGetters = {
        currentProduction: {
          descriptors: [{
            name: 'descriptor2',
            field_name: 'descriptor2',
            entity_type: 'Asset'
          }, {
            name: 'descriptor1',
            field_name: 'descriptor1',
            entity_type: 'Asset'
          }, {
            name: 'descriptor3',
            field_name: 'descriptor3',
            entity_type: 'Shot'
          }]
        },
        episodeMap: new Map(Object.entries({
          'episode-id': { name: 'MP2' }
        })),
        organisation: {
          hours_by_day: 8
        },
        isTVShow: true,
        personMap: new Map(Object.entries({
          'person-1': { full_name: 'Jhon Doe' }
        })),
        taskMap: new Map(Object.entries({
          'task-id-1': {
            task_status_short_name: 'shortName1',
            assignees: ['person-1']
          }
        })),
        taskTypeMap: new Map(Object.entries({
          'task-type-1': {
            name: 'task-type-1-name'
          }
        }))
      }
      store.cache.assets = [{
        validations: new Map(Object.entries({
          'existing-validation-id': 'task-id-1'
        })),
        episode_id: 'episode-id',
        asset_type_name: 'asset_type_name',
        name: 'name',
        description: 'description',
        ready_for: 'task-type-1',
        data: {
          descriptor1: 'descriptor1',
          descriptor2: 'descriptor2'
        },
        timeSpent: 1000,
        estimation: 2000
      },
      {
        validations: new Map(Object.entries({
          'existing-validation-id': 'task-id-2'
        })),
        episode_id: 'episode-id',
        asset_type_name: 'asset_type_name2',
        name: 'name2',
        description: 'description2',
        ready_for: 'task-type-1',
        data: {
          descriptor1: 'descriptor4',
          descriptor2: 'descriptor5'
        },
        timeSpent: 2000,
        estimation: 4000
      }]
      const lines = store.actions.getAssetsCsvLines({ state, rootGetters })
      expect(lines).toHaveLength(2)
      expect(lines[0]).toEqual([
        'MP2',
        'asset_type_name',
        'name',
        'description',
        'task-type-1-name',
        'descriptor1',
        'descriptor2',
        '2.08',
        '4.17',
        'shortName1',
        'Jhon Doe',
        '',
        ''
      ])
      expect(lines[1]).toEqual([
        'MP2',
        'asset_type_name2',
        'name2',
        'description2',
        'task-type-1-name',
        'descriptor4',
        'descriptor5',
        '4.17',
        '8.33',
        '',
        '',
        '',
        ''
      ])
    })

    test('deleteAllAssetTasks', () => {
      const dispatch = vi.fn()
      const projectId = 1
      const taskTypeId = '2'
      const selectionOnly = true
      store.cache.result = [{
        validations: new Map(Object.entries({
          2: 5
        }))
      }]
      store.actions.deleteAllAssetTasks(
        { dispatch }, { projectId, taskTypeId, selectionOnly })
      expect(dispatch).toBeCalledTimes(1)
      expect(dispatch).toHaveBeenNthCalledWith(
        1, 'deleteAllTasks', { projectId, taskTypeId, taskIds: [5] })
    })

    test('deleteSelectedAssets', async () => {
      const dispatch = vi.fn()
      const asset = {
        id: 'asset-id',
        canceled: false
      }
      const state = {
        selectedAssets: new Map(Object.entries({
          'asset-id': asset
        })),
        assetMap: new Map(Object.entries({
          'asset-id': asset
        }))
      }
      store.cache.assetMap.set(asset.id, asset)
      await store.actions.deleteSelectedAssets({ state, dispatch })
      expect(dispatch).toBeCalledTimes(1)
      expect(dispatch).toHaveBeenNthCalledWith(1, 'deleteAsset', asset)
    })
  })

  describe('Mutations', () => {
    test('CLEAR_ASSETS', () => {
      store.cache.assets = 1
      store.cache.result = 1
      store.cache.assetIndex = 1
      const state = {
        assetMap: new Map(),
        assetValidationColumns: 1,
        displayedAssets: 1,
        assetFilledColumns: 1,
        assetSearchFilterGroups: 1,
        assetSearchQueries: 1,
        displayedAssetsCount: 100,
        displayedAssetsLength: 100,
        displayedAssetsTimeSpent: 1000,
        displayedAssetsEstimation: 1000
      }
      store.mutations.CLEAR_ASSETS(state)
      expect(store.cache.assets).toEqual([])
      expect(store.cache.result).toEqual([])
      expect(store.cache.assetIndex).toEqual({})
      expect(state).toEqual({
        assetMap: new Map(),
        assetValidationColumns: [],
        assetFilledColumns: {},
        assetSearchFilterGroups: [],
        assetSearchQueries: [],
        displayedAssets: [],
        displayedAssetsCount: 0,
        displayedAssetsLength: 0,
        displayedAssetsTimeSpent: 0,
        displayedAssetsEstimation: 0,
        selectedAssets: new Map()
      })
    })

    test('LOAD_ASSETS_START', () => {
      store.cache.assets = 1
      store.cache.result = 1
      store.cache.assetIndex = 1
      const state = {
        isAssetsLoading: false,
        isAssetsLoadingError: true,
        assetMap: new Map(),
        assetValidationColumns: 1,
        displayedAssets: 1,
        assetFilledColumns: 1,
        assetSearchFilterGroups: 1,
        assetSearchQueries: 1,
        displayedAssetsCount: 100,
        displayedAssetsLength: 100,
        displayedAssetsTimeSpent: 1000,
        displayedAssetsEstimation: 1000
      }
      store.mutations.LOAD_ASSETS_START(state)
      expect(store.cache.assets).toEqual([])
      expect(store.cache.result).toEqual([])
      expect(store.cache.assetIndex).toEqual({})
      expect(state).toEqual({
        isAssetsLoading: true,
        isAssetsLoadingError: false,
        assetMap: new Map(),
        assetValidationColumns: [],
        displayedAssets: [],
        assetFilledColumns: {},
        assetSearchFilterGroups: [],
        assetSearchQueries: [],
        displayedAssetsCount: 0,
        displayedAssetsLength: 0,
        displayedAssetsTimeSpent: 0,
        displayedAssetsEstimation: 0,
        selectedAssets: new Map()
      })
    })

    test('LOAD_ASSETS_ERROR', () => {
      const state = {
        isAssetsLoading: true,
        isAssetsLoadingError: false
      }
      store.mutations.LOAD_ASSETS_ERROR(state)
      expect(state).toEqual({
        isAssetsLoading: false,
        isAssetsLoadingError: true
      })
    })

    test('LOAD_ASSETS_END', () => {
      store.cache.assets = 1
      store.cache.result = 1
      store.cache.assetIndex = 1
      store.cache.assetTypeIndex = 1
      const state = {}
      const production = {
        id: '1',
        name: 'production'
      }
      const assets = [
        {
          id: '1',
          canceled: true,
          asset_type_name: 'assettypename2',
          name: 'name4',
          timeSpent: 1000,
          estimation: 2000,
          description: 'azerty',
          validations: new Map(Object.entries({ name: 'value' })),
          tasks: []
        },
        {
          id: '2',
          canceled: false,
          asset_type_name: 'assettypename2',
          name: 'name3',
          validations: new Map(),
          tasks: []
        },
        {
          id: '3',
          canceled: true,
          asset_type_name: 'assettypename1',
          name: 'name2',
          validations: new Map(),
          tasks: []
        },
        {
          id: '4',
          canceled: false,
          asset_type_name: 'assettypename2',
          name: 'name1',
          validations: new Map(),
          tasks: []
        }
      ]
      const userFilters = {
        asset: {
          1: 'assetSearchQueries'
        }
      }
      const userFilterGroups = {
        asset: {
          1: 'assetSearchFilterGroups'
        }
      }
      const personMap = new Map()
      const taskMap = new Map()
      const taskTypeMap = new Map()
      store.mutations.LOAD_ASSETS_END(state, {
        production,
        assets,
        userFilters,
        userFilterGroups,
        personMap,
        taskMap,
        taskTypeMap
      })
      expect(store.cache.assets).toEqual([
        {
          id: '4',
          canceled: false,
          asset_type_name: 'assettypename2',
          name: 'name1',
          validations: new Map(),
          tasks: [],
          estimation: 0,
          production_id: '1',
          production_name: 'production',
          project_name: 'production',
          timeSpent: 0
        },
        {
          id: '2',
          canceled: false,
          asset_type_name: 'assettypename2',
          name: 'name3',
          validations: new Map(),
          tasks: [],
          estimation: 0,
          production_id: '1',
          production_name: 'production',
          project_name: 'production',
          timeSpent: 0
        },
        {
          id: '3',
          canceled: true,
          asset_type_name: 'assettypename1',
          name: 'name2',
          validations: new Map(),
          tasks: [],
          estimation: 0,
          production_id: '1',
          production_name: 'production',
          project_name: 'production',
          timeSpent: 0
        },
        {
          id: '1',
          canceled: true,
          asset_type_name: 'assettypename2',
          name: 'name4',
          description: 'azerty',
          validations: new Map(),
          tasks: [],
          estimation: 0,
          production_id: '1',
          production_name: 'production',
          project_name: 'production',
          timeSpent: 0
        }
      ])
      expect(store.cache.result).toEqual(store.cache.assets)
      expect(Object.keys(store.cache.assetIndex)).toHaveLength(23)
      expect(Object.keys(store.cache.assetTypeIndex)).toHaveLength(14)
      expect(state).toEqual({
        isAssetsLoading: false,
        isAssetsLoadingError: false,
        isAssetTime: false,
        isAssetEstimation: false,
        isAssetDescription: true,
        isAssetResolution: false,
        assetValidationColumns: [],
        nbValidationColumns: 0,
        displayedAssets: store.cache.assets,
        assetFilledColumns: {},
        assetTypes: [
          {
            id: undefined,
            name: 'assettypename2'
          }
        ],
        displayedAssetTypes: [
          {
            id: undefined,
            name: 'assettypename2'
          }
        ],
        displayedAssetTypesLength: 1,
        assetSelectionGrid: {
          0: {},
          1: {},
          2: {},
          3: {}
        },
        displayedAssetsEstimation: 0,
        displayedAssetsCount: 4,
        displayedAssetsLength: 2,
        displayedAssetsTimeSpent: 0,
        assetSearchFilterGroups: 'assetSearchFilterGroups',
        assetSearchQueries: 'assetSearchQueries',
      })
      expect(store.cache.assetMap).toEqual(new Map(Object.entries({
        4: {
          id: '4',
          canceled: false,
          asset_type_name: 'assettypename2',
          name: 'name1',
          validations: new Map(),
          tasks: [],
          estimation: 0,
          production_id: '1',
          production_name: 'production',
          project_name: 'production',
          timeSpent: 0
        },
        2: {
          id: '2',
          canceled: false,
          asset_type_name: 'assettypename2',
          name: 'name3',
          validations: new Map(),
          tasks: [],
          estimation: 0,
          production_id: '1',
          production_name: 'production',
          project_name: 'production',
          timeSpent: 0
        },
        3: {
          id: '3',
          canceled: true,
          asset_type_name: 'assettypename1',
          name: 'name2',
          validations: new Map(),
          tasks: [],
          estimation: 0,
          production_id: '1',
          production_name: 'production',
          project_name: 'production',
          timeSpent: 0
        },
        1: {
          id: '1',
          canceled: true,
          asset_type_name: 'assettypename2',
          name: 'name4',
          description: 'azerty',
          validations: new Map(),
          tasks: [],
          estimation: 0,
          production_id: '1',
          production_name: 'production',
          project_name: 'production',
          timeSpent: 0
        }
      })))
    })

    test.skip('ADD_ASSET', () => {
      store.cache.assets = []
      store.cache.result = []
      store.cache.assetIndex = new Map()
      const personMap = new Map(Object.entries({
        'person-id': {
          id: 'person-id',
          name: 'Some person'
        }
      }))
      const taskMap = new Map()
      const taskTypeMap = new Map(Object.entries({
        'task-type-id': {
          id: 'task-type-id',
          name: 'some type',
          priority: 1
        }
      }))
      const state = {
        assetMap: new Map(),
        displayedAssets: []
      }
      const production = {
        id: '1',
        name: 'production'
      }
      const asset = {
        id: '1',
        canceled: false,
        asset_type_name: 'assettypename2',
        name: 'name4',
        timeSpent: 0,
        estimation: 0,
        description: 'azerty',
        validations: new Map(Object.entries({ name: 'value' })),
        tasks: [{
          id: 'task-id',
          assignees: ['person-id'],
          task_type_id: 'task-type-id',
          task_status_id: 'todo',
          duration: 100,
          estimation: 200
        }]
      }
      tasksStore.cache.taskStatusMap = new Map(Object.entries({
        todo: {
          short_name: 'TODO'
        }
      }))
      store.mutations.ADD_ASSET(state, {
        taskTypeMap,
        taskMap,
        personMap,
        production,
        asset
      })
      expect(asset).toEqual({
        id: '1',
        canceled: false,
        asset_type_name: 'assettypename2',
        name: 'name4',
        episode_id: undefined,
        full_name: 'assettypename2 / name4',
        production_id: '1',
        production_name: 'production',
        project_name: 'production',
        timeSpent: 100,
        estimation: 200,
        description: 'azerty',
        validations: new Map(Object.entries({ 'task-type-id': 'task-id' })),
        tasks: ['task-id']
      })
      expect(taskTypeMap).toEqual(new Map(Object.entries({
        'task-type-id': {
          id: 'task-type-id',
          name: 'some type',
          priority: 1
        }
      })))
      expect(taskMap).toEqual(new Map(Object.entries({
        'task-id': {
          assignees: [
            'person-id'
          ],
          duration: 100,
          entity: {
            id: '1',
            preview_file_id: undefined
          },
          entity_name: 'assettypename2 / name4',
          entity_type_name: 'assettypename2',
          episode_id: undefined,
          estimation: 200,
          id: 'task-id',
          name: '1',
          project_id: '1',
          task_status_id: 'todo',
          task_status_short_name: 'TODO',
          task_type_id: 'task-type-id'
        }
      })))
      expect(personMap).toEqual(new Map(Object.entries({
        'person-id': {
          id: 'person-id',
          name: 'Some person'
        }
      })))
      expect(state).toEqual({
        assetFilledColumns: {
          'task-type-id': true
        },
        assetMap: new Map(Object.entries({
          1: {
            asset_type_name: 'assettypename2',
            canceled: false,
            description: 'azerty',
            episode_id: undefined,
            estimation: 200,
            full_name: 'assettypename2 / name4',
            id: '1',
            name: 'name4',
            production_id: '1',
            production_name: 'production',
            project_name: 'production',
            tasks: [
              'task-id'
            ],
            timeSpent: 100,
            validations: new Map(Object.entries({
              'task-type-id': 'task-id'
            }))
          }
        })),
        assetSelectionGrid: {
          0: {}
        },
        displayedAssets: [
          {
            asset_type_name: 'assettypename2',
            canceled: false,
            description: 'azerty',
            episode_id: undefined,
            estimation: 200,
            full_name: 'assettypename2 / name4',
            id: '1',
            name: 'name4',
            production_id: '1',
            production_name: 'production',
            project_name: 'production',
            tasks: [
              'task-id'
            ],
            timeSpent: 100,
            validations: new Map(Object.entries({
              'task-type-id': 'task-id'
            }))
          }
        ],
        displayedAssetsEstimation: 200,
        displayedAssetsCount: 1,
        displayedAssetsLength: 1,
        displayedAssetsTimeSpent: 100
      })
      expect(store.cache.assets).toEqual([{
        asset_type_name: 'assettypename2',
        canceled: false,
        description: 'azerty',
        episode_id: undefined,
        estimation: 200,
        full_name: 'assettypename2 / name4',
        id: '1',
        name: 'name4',
        production_id: '1',
        production_name: 'production',
        project_name: 'production',
        tasks: [
          'task-id'
        ],
        timeSpent: 100,
        validations: new Map(Object.entries({
          'task-type-id': 'task-id'
        }))
      }])
      expect(Object.keys(store.cache.assetIndex)).toHaveLength(19)
    })

    test('UPDATE_ASSET', () => {
      const asset = {
        id: '123',
        name: 'new asset'
      }
      store.cache.assetMap = new Map(Object.entries({
        123: {
          id: '123',
          name: 'old asset'
        }
      }))
      store.mutations.UPDATE_ASSET({}, asset)
      expect(store.cache.assetMap.get('123').name).toEqual('new asset')
    })

    test('REMOVE_ASSET', () => {
      const assetToDelete = {
        id: 'asset-id',
        timeSpent: 100,
        estimation: 200
      }
      store.cache.assets = [assetToDelete]
      store.cache.assetMap = new Map([[assetToDelete.id, assetToDelete]])
      store.cache.assetIndex = null
      const state = {
        displayedAssets: [assetToDelete],
        displayedAssetsTimeSpent: 100,
        displayedAssetsEstimation: 200,
        assetFilledColumns: null,
        displayedAssetsCount: 1,
        displayedAssetsLength: 1
      }
      store.mutations.REMOVE_ASSET(state, assetToDelete)
      expect(state).toEqual({
        displayedAssets: [],
        displayedAssetsTimeSpent: 0,
        displayedAssetsEstimation: 0,
        assetFilledColumns: {},
        displayedAssetsCount: 0,
        displayedAssetsLength: 0
      })
      expect(store.cache.assets).toEqual([])
      expect(store.cache.assetMap).toEqual(new Map())
      expect(store.cache.assetIndex !== null).toBeTruthy()
      expect(store.cache.assets).toEqual([])
    })

    test('ASSET_CSV_FILE_SELECTED', () => {
      const state = {}
      store.mutations.ASSET_CSV_FILE_SELECTED(state, 'formData')
      expect(state.assetsCsvFormData).toEqual('formData')
    })

    test('IMPORT_ASSETS_END', () => {
      const state = {
        assetsCsvFormData: 'assetsCsvFormData'
      }
      store.mutations.IMPORT_ASSETS_END(state)
      expect(state.assetsCsvFormData).toBeNull()
    })

    test('EDIT_ASSET_END', () => {
      const newAsset = {
        entity_type_id: 'entity_type_id',
        id: '1',
        canceled: true,
        asset_type_name: 'assettypename2',
        name: 'name4',
        episode_id: undefined,
        full_name: 'assettypename2 / name4',
        production_id: '1',
        production_name: 'production',
        project_name: 'production',
        timeSpent: 100,
        estimation: 200,
        description: 'azerty',
        validations: new Map(Object.entries({ 'task-type-id': 'task-id' })),
        tasks: ['task-id']
      }
      const oldAsset = {
        entity_type_id: 'entity_type_id',
        id: '1',
        asset_type_name: 'assettypename2',
        name: 'name4',
        full_name: 'assettypename2 / name4',
        production_id: '1',
        production_name: 'production',
        project_name: 'production',
        description: 'azerty'
      }
      const assetTypeMap = new Map(Object.entries({
        entity_type_id: {
          name: 'entity name',
          id: 'entity id'
        }
      }))
      const state = {
        assetTypeMap,
        displayedAssets: [oldAsset]
      }
      store.cache.assets = [oldAsset]
      store.cache.assetMap = new Map([[oldAsset.id, oldAsset]])

      store.mutations.EDIT_ASSET_END(state, { newAsset, assetTypeMap })
      expect(newAsset).toEqual({
        id: '1',
        canceled: true,
        asset_type_name: 'entity name',
        asset_type_id: 'entity id',
        entity_type_id: 'entity_type_id',
        name: 'name4',
        episode_id: undefined,
        full_name: 'assettypename2 / name4',
        production_id: '1',
        production_name: 'production',
        project_name: 'production',
        timeSpent: 100,
        estimation: 200,
        description: 'azerty',
        validations: new Map(Object.entries({ 'task-type-id': 'task-id' }))
      })
      expect(state).toEqual({
        assetCreated: 'name4',
        assetTypeMap,
        displayedAssets: [
          {
            asset_type_name: 'entity name',
            asset_type_id: 'entity id',
            entity_type_id: 'entity_type_id',
            canceled: true,
            description: 'azerty',
            episode_id: undefined,
            estimation: 200,
            full_name: 'assettypename2 / name4',
            id: '1',
            name: 'name4',
            production_id: '1',
            production_name: 'production',
            project_name: 'production',
            timeSpent: 100,
            validations: new Map(Object.entries({
              'task-type-id': 'task-id'
            })),
            data: {}
          }
        ],
        isAssetDescription: true
      })
      expect(store.cache.assets).toEqual([{
        asset_type_name: 'entity name',
        asset_type_id: 'entity id',
        entity_type_id: 'entity_type_id',
        canceled: true,
        description: 'azerty',
        episode_id: undefined,
        estimation: 200,
        full_name: 'assettypename2 / name4',
        id: '1',
        name: 'name4',
        production_id: '1',
        production_name: 'production',
        project_name: 'production',
        timeSpent: 100,
        validations: new Map(Object.entries({
          'task-type-id': 'task-id'
        })),
        data: {}
      }])
      expect(Object.keys(store.cache.assetIndex)).toHaveLength(11)
    })

    test('CANCEL_ASSET', () => {
      const asset = {}
      store.mutations.CANCEL_ASSET({}, asset)
      expect(asset.canceled).toBeTruthy()
    })

    test('RESTORE_ASSET_END', () => {
      const asset = {
        id: 'asset-id',
        canceled: true
      }
      store.cache.assetMap = new Map(Object.entries({
        'asset-id': asset
      }))
      store.cache.assetIndex = null
      store.mutations.RESTORE_ASSET_END({}, asset)
      expect(asset.canceled).toBeFalsy()
      expect(store.cache.assetIndex !== null).toBeTruthy()
    })

    test('DELETE_TASK_END', () => {
      const state = {
        displayedAssets: [{
          id: 'asset-id',
          validations: new Map(Object.entries({})),
          tasks: ['task-id1', 'task-id', 'task-id2']
        }]
      }
      const task = {
        id: 'task-id',
        entity_id: 'asset-id'
      }
      store.mutations.DELETE_TASK_END(state, task)
      expect(state).toEqual({
        displayedAssets: [{
          id: 'asset-id',
          validations: new Map(Object.entries({})),
          tasks: ['task-id1', 'task-id2']
        }]
      })
    })

    test('SET_ASSET_SEARCH', () => {
      const state = {
        assetSorting: { 123: 123 },
        displayedAssets: []
      }
      const payload = {
        sorting: 123,
        assetSearch: 'search',
        production: {},
        taskStatusMap: new Map(),
        taskTypeMap: new Map(),
        persons: new Map(),
        taskMap: new Map()
      }
      store.mutations.SET_ASSET_SEARCH(state, payload)
      expect(state).toEqual({
        assetFilledColumns: {},
        assetSearchText: 'search',
        assetSelectionGrid: {},
        assetSorting: {
          123: 123
        },
        displayedAssets: [],
        displayedAssetsEstimation: 0,
        displayedAssetsCount: 0,
        displayedAssetsLength: 0,
        displayedAssetsTimeSpent: 0
      })
    })

    test('SAVE_ASSET_SEARCH_END', () => {
      const state = {
        assetSearchQueries: [{ name: 'test' }]
      }
      store.mutations.SAVE_ASSET_SEARCH_END(
        state, { searchQuery: { name: 'search' } })
      expect(state.assetSearchQueries).toEqual(
        [{ name: 'search' }, { name: 'test' }])
    })

    test('REMOVE_ASSET_SEARCH_END', () => {
      const state = {
        assetSearchQueries: [{ name: 'test' }]
      }
      store.mutations.REMOVE_ASSET_SEARCH_END(
        state,
        { searchQuery: { name: 'test' } }
      )
      expect(state.assetSearchQueries).toEqual([])
    })

    test('DISPLAY_MORE_ASSETS', () => {
      store.cache.result = [
        {
          id: 'asset-id',
          tasks: [{
            task_type_id: 'task-type-1'
          }]
        },
        {
          id: 'asset-id-2',
          tasks: [{
            task_type_id: 'task_type_id'
          }]
        }
      ]
      const state = {
        displayedAssets: [
          {
            id: 'asset-id'
          }
        ],
        assetSelectionGrid: {
          0: {}
        }
      }
      store.mutations.DISPLAY_MORE_ASSETS(state, {})
      expect(state).toEqual({
        displayedAssets: [
          {
            id: 'asset-id',
            tasks: [{
              task_type_id: 'task-type-1'
            }]
          },
          {
            id: 'asset-id-2',
            tasks: [{
              task_type_id: 'task_type_id'
            }]
          }
        ],
        assetFilledColumns: {
          task_type_id: true,
          'task-type-1': true
        },
        assetSelectionGrid: {
          0: {},
          1: {}
        }
      })
    })

    test('SET_CURRENT_PRODUCTION', () => {
      const state = {
        assetSearchText: 'test'
      }
      store.mutations.SET_CURRENT_PRODUCTION(state, null)
      expect(state.assetSearchText).toEqual('')
    })

    test('SET_PREVIEW', () => {
      store.cache.assetMap = new Map(Object.entries({
        'asset-id': {
          tasks: ['task-id']
        }
      }))
      tasksStore.state.taskMap.set('task-id', {
        entity: {}
      })
      store.mutations.SET_PREVIEW({}, {
        entityId: 'asset-id',
        taskId: 'task-id',
        previewId: 'preview-id',
        taskMap: tasksStore.state.taskMap,
      })
      expect(tasksStore.state.taskMap.get('task-id').entity.preview_file_id)
        .toEqual('preview-id')
      expect(store.cache.assetMap.get('asset-id').preview_file_id)
        .toEqual('preview-id')
    })

    test('SET_ASSET_LIST_SCROLL_POSITION', () => {
      const state = {}
      store.mutations.SET_ASSET_LIST_SCROLL_POSITION(state, 12)
      expect(state.assetListScrollPosition).toEqual(12)
    })

    test('SET_PRODUCTION_ASSET_TYPE_LIST_SCROLL_POSITION', () => {
      const state = {}
      store.mutations.SET_PRODUCTION_ASSET_TYPE_LIST_SCROLL_POSITION(state, 12)
      expect(state.assetTypeListScrollPosition).toEqual(12)
    })

    test('REMOVE_SELECTED_TASK', () => {
      const state = {
        assetSelectionGrid: {}
      }
      state.assetSelectionGrid[0] = {}
      state.assetSelectionGrid[1] = {}
      state.assetSelectionGrid[1][1] = true
      const validationInfo = {
        x: 1,
        y: 1
      }
      store.mutations.REMOVE_SELECTED_TASK(state, validationInfo)
      expect(state.assetSelectionGrid[1][1]).toBeFalsy()
    })

    test('ADD_SELECTED_TASK', () => {
      const state = {
        assetSelectionGrid: {}
      }
      state.assetSelectionGrid[0] = {}
      state.assetSelectionGrid[1] = {}
      state.assetSelectionGrid[1][1] = false
      const validationInfo = {
        x: 1,
        y: 1
      }
      store.mutations.ADD_SELECTED_TASK(state, validationInfo)
      expect(state.assetSelectionGrid[1][1]).toBeTruthy()
    })

    test('ADD_SELECTED_TASKS', () => {
      const state = {
        assetSelectionGrid: {}
      }
      state.assetSelectionGrid[1] = {}
      state.assetSelectionGrid[1][1] = false
      const validationInfo = {
        x: 1,
        y: 1
      }
      store.mutations.ADD_SELECTED_TASKS(state, [validationInfo])
      expect(state.assetSelectionGrid[1][1]).toBeTruthy()
    })

    test('CLEAR_SELECTED_TASKS', () => {
      const state = {
        assetSelectionGrid: {}
      }
      state.assetSelectionGrid[0] = {}
      state.assetSelectionGrid[0][0] = true
      tasksStore.state.nbSelectedTasks = 1
      store.mutations.CLEAR_SELECTED_TASKS(state)
      expect(state.assetSelectionGrid[0][0]).toBeFalsy()
      tasksStore.state.nbSelectedTasks = 0
    })

    test.skip('NEW_TASK_END', () => {
      const state = {
        assetMap: new Map(Object.entries({
          'asset-id': {
            tasks: ['old-task-id'],
            validations: new Map()
          }
        })),
        assetValidationColumns: [],
        assetFilledColumns: []
      }
      taskTypesStore.cache.taskTypeMap = new Map(Object.entries({
        task_type_id: {
          priority: 1
        }
      }))
      tasksStore.cache.taskStatusMap = new Map(Object.entries({
        todo: {
          short_name: 'TODO'
        }
      }))
      const task = {
        id: 'task-id',
        entity_id: 'asset-id',
        task_type_id: 'task_type_id',
        task_status_id: 'todo'
      }
      productionsStore.state.currentProduction = {
        task_types_priority: {
          'task-id': 1,
          'old-task-id': 2
        }
      }
      store.mutations.NEW_TASK_END(state, { task })
      expect(state.assetMap.get('asset-id')).toEqual({
        tasks: ['old-task-id', 'task-id'],
        validations: new Map(Object.entries({
          task_type_id: 'task-id'
        }))
      })
      expect(task).toEqual({
        entity: {
          id: undefined,
          preview_file_id: undefined
        },
        entity_id: 'asset-id',
        entity_name: 'undefined / undefined',
        entity_type_name: undefined,
        episode_id: undefined,
        id: 'task-id',
        name: '1',
        project_id: undefined,
        task_status_id: 'todo',
        task_status_short_name: 'TODO',
        task_type_id: 'task_type_id'
      })
      expect(state.assetValidationColumns[0]).toEqual('task_type_id')
    })

    test('CREATE_TASKS_END', () => {
      store.cache.assetMap = new Map(Object.entries({
        'asset-id': {
          validations: new Map(),
          tasks: []
        }
      }))
      const tasks = [{
        entity_id: 'asset-id',
        task_type_id: 'task_type_id',
        task_status_id: 'todo',
        id: 'task-id'
      }]
      taskStatusStore.cache.taskStatusMap = new Map(
        [['todo', { id: 'todo', short_name: 'TODO' }]]
      )
      store.mutations.CREATE_TASKS_END({}, { tasks })
      expect(store.cache.assetMap.get('asset-id').validations).toEqual(
        new Map(Object.entries({
          task_type_id: 'task-id'
        })))
    })

    test('SET_ASSET_TYPE_SEARCH', () => {
      const searchQuery = 'search'
      const state = {
        assetTypes: [123]
      }
      store.mutations.SET_ASSET_TYPE_SEARCH(state, searchQuery)
      expect(state).toEqual({
        assetTypes: [123],
        displayedAssetTypes: [],
        displayedAssetTypesLength: 0,
        assetTypeSearchText: 'search'
      })
    })

    test('COMPUTE_ASSET_TYPE_STATS', () => {
      store.cache.assets = [
        {
          asset_type_id: 'something',
          tasks: ['task-id'],
          nb_frames: 123
        }
      ]
      const state = {}
      const taskStatusMap = new Map(Object.entries({
        task_status_id: {
          id: 'task_status_id',
          short_name: 'todo',
          color: 'gray'
        }
      }))
      const taskMap = new Map(Object.entries({
        'task-id': {
          task_type_id: 'task_type_id',
          task_status_id: 'task_status_id'
        }
      }))
      store.mutations.COMPUTE_ASSET_TYPE_STATS(
        state, { taskStatusMap, taskMap })
      expect(state.assetTypeStats).toEqual({
        all: {
          all: {
            task_status_id: {
              color: 'gray',
              count: 1,
              frames: 123,
              name: 'todo'
            }
          },
          task_type_id: {
            task_status_id: {
              color: 'gray',
              count: 1,
              frames: 123,
              name: 'todo'
            }
          }
        },
        something: {
          all: {
            task_status_id: {
              color: 'gray',
              count: 1,
              frames: 123,
              name: 'todo'
            }
          },
          task_type_id: {
            task_status_id: {
              color: 'gray',
              count: 1,
              frames: 123,
              name: 'todo'
            }
          }
        }
      })
    })

    test('UPDATE_METADATA_DESCRIPTOR_END', () => {
      const state = {}
      const descriptor = {
        entity_type: 'Asset',
        field_name: 'new name'
      }
      const previousDescriptorFieldName = 'previous name'
      store.cache.assets = [
        {
          data: {
            'previous name': 123
          }
        }
      ]
      store.mutations.UPDATE_METADATA_DESCRIPTOR_END(
        state, { descriptor, previousDescriptorFieldName })
      expect(store.cache.assets[0]).toEqual({
        data: {
          'new name': 123
        }
      })
    })

    test('LOCK_ASSET', () => {
      const asset = {
        id: 'asset-id',
        lock: false
      }
      store.cache.assetMap.set('asset-id', asset)
      store.mutations.LOCK_ASSET({}, asset)
      expect(asset).toEqual({
        id: 'asset-id',
        lock: 1
      })
      store.mutations.LOCK_ASSET({}, asset)
      expect(asset).toEqual({
        id: 'asset-id',
        lock: 2
      })
    })

    test('UNLOCK_ASSET', () => {
      const asset = {
        id: 'asset-id',
        lock: 2
      }
      store.cache.assetMap.set('asset-id', asset)
      store.mutations.UNLOCK_ASSET({}, asset)
      expect(asset).toEqual({
        id: 'asset-id',
        lock: 1
      })
      store.mutations.UNLOCK_ASSET({}, asset)
      expect(asset).toEqual({
        id: 'asset-id',
        lock: 0
      })
    })

    test('RESET_ALL', () => {
      store.cache.assets = 123
      store.cache.assetIndex = 456
      store.cache.result = 789
      const state = {}
      store.mutations.RESET_ALL(state)
      expect(store.cache.assets).toEqual([])
      expect(store.cache.assetIndex).toEqual({})
      expect(store.cache.result).toEqual([])
      expect(state).toEqual({
        assetCreated: '',
        assetFilledColumns: {},
        assetListScrollPosition: 0,
        assetSearchFilterGroups: [],
        assetSearchQueries: [],
        assetSearchText: '',
        assetSelectionGrid: {},
        assetSorting: [],
        assetTypeSearchText: '',
        assetTypeStats: {},
        assetTypes: [],
        assetValidationColumns: [],
        assetsCsvFormData: null,
        displayedAssetTypes: [],
        displayedAssetTypesLength: 0,
        displayedAssets: [],
        displayedAssetsEstimation: 0,
        displayedAssetsCount: 0,
        displayedAssetsLength: 0,
        displayedAssetsTimeSpent: 0,
        displayedSharedAssets: [],
        filteredAssets: [],
        isAssetDescription: false,
        isAssetEstimation: false,
        isAssetTime: false,
        isAssetResolution: false,
        isAssetsLoading: false,
        isAssetsLoadingError: false,
        nbValidationColumns: 0,
        personTasks: [],
        sharedAssets: [],
        sharedAssetSearchText: '',
        selectedAssets: new Map(),
        unsharedAssets: [],
      })
    })

    test('SET_ASSET_SELECTION', () => {
      const state = {
        selectedAssets: new Map(Object.entries({
          'asset-id-1': true
        })),
        displayedAssets: [],
        nbValidationColumns: 0
      }
      const asset = {
        id: 'asset-id-1'
      }
      store.mutations.SET_ASSET_SELECTION(state, { asset, selected: false })
      expect(state.selectedAssets.has('asset-id-1')).toBeFalsy()
      store.mutations.SET_ASSET_SELECTION(state, { asset, selected: true })
      expect(state.selectedAssets.has('asset-id-1')).toBeTruthy()
    })

    test('CLEAR_SELECTED_ASSETS', () => {
      const state = {
        selectedAssets: 123
      }
      store.mutations.CLEAR_SELECTED_ASSETS(state)
      expect(state.selectedAssets).toEqual(new Map())
    })
  })
})
